{
  final Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  if (project == null)   return null;
  final Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  if (editor != null) {
    final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return null;
    final PsiElement targetElement=TargetElementUtil.findTargetElement(editor,TargetElementUtil.ELEMENT_NAME_ACCEPTED | TargetElementUtil.REFERENCED_ELEMENT_ACCEPTED | TargetElementUtil.LOOKUP_ITEM_ACCEPTED);
    if (targetElement instanceof PsiClass) {
      return targetElement;
    }
    final int offset=editor.getCaretModel().getOffset();
    PsiElement element=file.findElementAt(offset);
    while (element != null) {
      if (element instanceof PsiFile) {
        if (!(element instanceof PsiClassOwner))         return null;
        final PsiClass[] classes=((PsiClassOwner)element).getClasses();
        return classes.length == 1 ? classes[0] : null;
      }
      if (element instanceof PsiClass && !(element instanceof PsiAnonymousClass)) {
        return element;
      }
      element=element.getParent();
    }
    return null;
  }
 else {
    final PsiElement element=LangDataKeys.PSI_ELEMENT.getData(dataContext);
    return element instanceof PsiClass ? (PsiClass)element : null;
  }
}
