{
  PsiElement psiElement=(PsiElement)this;
  Icon baseIcon=LastComputedIcon.get(psiElement,flags);
  if (baseIcon == null) {
    if (myBaseIcon == null) {
      myBaseIcon=new HashMap<Integer,Icon>(3);
    }
    if (!myBaseIcon.containsKey(flags)) {
      myBaseIcon.put(flags,computeBaseIcon(flags));
    }
    baseIcon=myBaseIcon.get(flags);
  }
  return IconDeferrer.getInstance().defer(baseIcon,new ElementIconRequest(psiElement,flags),new Function<ElementIconRequest,Icon>(){
    public Icon fun(    ElementIconRequest request){
      if (!request.getElement().isValid())       return null;
      final Icon providersIcon=PsiIconUtil.getProvidersIcon(request.getElement(),request.getFlags());
      if (providersIcon != null) {
        return providersIcon instanceof RowIcon ? (RowIcon)providersIcon : createLayeredIcon(providersIcon,request.getFlags());
      }
      return getElementIcon(request.getFlags());
    }
  }
);
}
