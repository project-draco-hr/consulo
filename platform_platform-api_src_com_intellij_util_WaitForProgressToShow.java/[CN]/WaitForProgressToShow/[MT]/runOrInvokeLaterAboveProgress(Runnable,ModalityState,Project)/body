{
  final Application application=ApplicationManager.getApplication();
  if (application.isDispatchThread()) {
    command.run();
  }
 else {
    final ProgressIndicator pi=ProgressManager.getInstance().getProgressIndicator();
    if (pi != null) {
      execute(pi);
      application.invokeLater(command,pi.getModalityState(),new Condition(){
        @Override public boolean value(        Object o){
          return (!project.isOpen()) || project.isDisposed();
        }
      }
);
    }
 else {
      final ModalityState notNullModalityState=modalityState == null ? ModalityState.NON_MODAL : modalityState;
      application.invokeLater(command,notNullModalityState,project.getDisposed());
    }
  }
}
