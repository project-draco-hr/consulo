{
  PsiElement elementToCopy=aClass.getNavigationElement();
  final PsiClass classCopy=(PsiClass)elementToCopy.copy();
  classCopy.setName(copyClassName);
  final String fileName=copyClassName + "." + elementToCopy.getContainingFile().getOriginalFile().getViewProvider().getVirtualFile().getExtension();
  final PsiFile createdFile=targetDirectory.copyFileFrom(fileName,elementToCopy.getContainingFile());
  PsiElement newElement=createdFile;
  if (createdFile instanceof PsiClassOwner) {
    for (    final PsiClass psiClass : ((PsiClassOwner)createdFile).getClasses()) {
      if (!(psiClass instanceof SyntheticElement)) {
        createdFile.deleteChildRange(psiClass,psiClass);
      }
    }
    final PsiClass newClass=(PsiClass)createdFile.add(classCopy);
    for (    final PsiReference reference : ReferencesSearch.search(aClass,new LocalSearchScope(newClass)).findAll()) {
      reference.bindToElement(newClass);
    }
    new OptimizeImportsProcessor(aClass.getProject(),createdFile).run();
    newElement=newClass;
  }
  return newElement;
}
