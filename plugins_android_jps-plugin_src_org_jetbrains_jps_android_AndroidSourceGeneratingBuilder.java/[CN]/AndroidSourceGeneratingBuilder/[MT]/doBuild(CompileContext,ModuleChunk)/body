{
  final Map<File,Module> idlFilesToCompile=new HashMap<File,Module>();
  final Map<File,Module> rsFilesToCompile=new HashMap<File,Module>();
  context.processFilesToRecompile(chunk,new FileProcessor(){
    @Override public boolean apply(    Module module,    File file,    String sourceRoot) throws IOException {
      final AndroidFacet facet=AndroidJpsUtil.getFacet(module);
      if (facet == null) {
        return true;
      }
      final String ext=FileUtil.getExtension(file.getName());
      if (AIDL_EXTENSION.equals(ext)) {
        idlFilesToCompile.put(file,facet.getModule());
      }
 else       if (RENDERSCRIPT_EXTENSION.equals(ext)) {
        rsFilesToCompile.put(file,facet.getModule());
      }
      return true;
    }
  }
);
  final Map<Module,MyModuleData> moduleDataMap=computeModuleDatas(chunk.getModules(),context);
  if (moduleDataMap == null || moduleDataMap.size() == 0) {
    return ExitCode.ABORT;
  }
  boolean success=true;
  if (context.isProjectRebuild()) {
    for (    Module module : moduleDataMap.keySet()) {
      final File generatedSourcesStorage=AndroidJpsUtil.getGeneratedSourcesStorage(module);
      if (generatedSourcesStorage.exists() && !deleteAndMarkRecursively(generatedSourcesStorage,context)) {
        success=false;
      }
      final File generatedResourcesStorage=AndroidJpsUtil.getGeneratedResourcesStorage(module);
      if (generatedResourcesStorage.exists() && !deleteAndMarkRecursively(generatedResourcesStorage,context)) {
        success=false;
      }
    }
  }
  if (!success) {
    return ExitCode.ABORT;
  }
  if (!runAidlCompiler(context,idlFilesToCompile,moduleDataMap)) {
    success=false;
  }
  if (!runRenderscriptCompiler(context,rsFilesToCompile,moduleDataMap)) {
    success=false;
  }
  final AndroidAptStateStorage storage=new AndroidAptStateStorage(context.getDataManager().getDataStorageRoot());
  try {
    if (!runAaptCompiler(context,moduleDataMap,storage)) {
      success=false;
    }
  }
  finally {
    storage.close();
  }
  return success ? ExitCode.OK : ExitCode.ABORT;
}
