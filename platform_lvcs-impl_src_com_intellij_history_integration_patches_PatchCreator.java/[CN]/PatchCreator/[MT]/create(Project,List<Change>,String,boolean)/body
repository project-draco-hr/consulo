{
  Writer writer=new OutputStreamWriter(new FileOutputStream(filePath));
  try {
    List<FilePatch> patches=IdeaTextPatchBuilder.buildPatch(p,changes,p.getBaseDir().getPath(),isReverse);
    String lineSeparator=CodeStyleSettingsManager.getInstance(p).getCurrentSettings().getLineSeparator();
    UnifiedDiffWriter.write(patches,writer,lineSeparator);
  }
  finally {
    writer.close();
  }
}
