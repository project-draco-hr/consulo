{
synchronized (myStubLock) {
    FileElement treeElement=(FileElement)_getTreeElement();
    if (treeElement != null)     return treeElement;
    final FileViewProvider viewProvider=getViewProvider();
    if (viewProvider.isPhysical() && myManager.isAssertOnFileLoading(viewProvider.getVirtualFile())) {
      LOG.error("Access to tree elements not allowed in tests." + viewProvider.getVirtualFile().getPresentableUrl());
    }
    final Document document=viewProvider.isEventSystemEnabled() ? viewProvider.getDocument() : null;
    treeElement=createFileElement(viewProvider.getContents());
    if (document != null) {
      treeElement.putUserData(HARD_REFERENCE_TO_DOCUMENT,document);
    }
    setTreeElement(treeElement);
    treeElement.setPsi(this);
    StubTree stub=derefStub();
    if (stub != null) {
      final Iterator<StubElement<?>> stubs=stub.getPlainList().iterator();
      stubs.next();
      switchFromStubToAST(treeElement,stubs);
      myStub=null;
    }
    if (getViewProvider().isEventSystemEnabled()) {
      ((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(myManager.getProject())).contentsLoaded(this);
    }
    if (LOG.isDebugEnabled() && getViewProvider().isPhysical()) {
      LOG.debug("Loaded text for file " + getViewProvider().getVirtualFile().getPresentableUrl());
    }
    return treeElement;
  }
}
