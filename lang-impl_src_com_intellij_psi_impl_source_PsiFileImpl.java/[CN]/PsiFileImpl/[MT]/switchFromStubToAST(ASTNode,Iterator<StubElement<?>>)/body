{
  if (tree instanceof ChameleonElement) {
    tree=ChameleonTransforming.transform((ChameleonElement)tree);
  }
  final IElementType type=tree.getElementType();
  if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(tree)) {
    final StubElement stub=stubs.next();
    final PsiElement psi=stub.getPsi();
    ((CompositeElement)tree).setPsi(psi);
    final StubBasedPsiElementBase<?> base=(StubBasedPsiElementBase)psi;
    base.setNode(tree);
    base.setStub(null);
  }
  for (  ASTNode node : tree.getChildren(null)) {
    switchFromStubToAST(node,stubs);
  }
}
