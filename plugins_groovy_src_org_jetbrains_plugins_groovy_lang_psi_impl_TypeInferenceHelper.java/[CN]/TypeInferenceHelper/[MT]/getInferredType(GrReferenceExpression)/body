{
  if (isInferenceInProgress()) {
    return getTypeBinding(refExpr);
  }
  final GrParametersOwner context=PsiTreeUtil.getParentOfType(refExpr,GrMethod.class,GrClosableBlock.class);
  GrCodeBlock block=null;
  if (context instanceof GrMethod) {
    block=((GrMethod)context).getBlock();
  }
 else   if (context instanceof GrClosableBlock) {
    block=(GrCodeBlock)context;
  }
  if (block != null) {
    Map<GrReferenceExpression,PsiType> map=myCalculatedTypeInferences.get(block);
    if (map == null) {
      map=inferTypes(block);
      myCalculatedTypeInferences.put(block,map);
    }
    return map.get(refExpr);
  }
  return null;
}
