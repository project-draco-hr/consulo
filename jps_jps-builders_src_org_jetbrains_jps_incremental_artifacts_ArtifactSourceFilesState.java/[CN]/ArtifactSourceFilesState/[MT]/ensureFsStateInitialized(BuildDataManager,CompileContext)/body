{
  ArtifactInstructionsBuilder builder=myProjectDescriptor.getArtifactRootsIndex().getInstructionsBuilder(myTarget.getArtifact());
  BuildFSState fsState=myProjectDescriptor.fsState;
  if (context.isProjectRebuild() || context.getScope().isRecompilationForced(myTarget)) {
    markDirtyFiles(builder,dataManager,null,true);
  }
 else   if (fsState.markInitialScanPerformed(myTarget)) {
    final Set<String> currentPaths=new HashSet<String>();
    fsState.clearDeletedPaths(myTarget);
    markDirtyFiles(builder,dataManager,currentPaths,false);
    final SourceToOutputMapping mapping=dataManager.getSourceToOutputMap(myTarget);
    final Iterator<String> iterator=mapping.getKeysIterator();
    while (iterator.hasNext()) {
      String path=iterator.next();
      File file=new File(path);
      if (!currentPaths.contains(path)) {
        fsState.registerDeleted(myTarget,file,myProjectDescriptor.timestamps.getStorage());
      }
    }
  }
}
