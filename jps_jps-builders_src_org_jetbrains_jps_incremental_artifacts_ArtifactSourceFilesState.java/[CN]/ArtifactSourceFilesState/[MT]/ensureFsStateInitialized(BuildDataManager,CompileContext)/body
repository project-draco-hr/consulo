{
  ArtifactInstructionsBuilder builder=myProjectDescriptor.getArtifactRootsIndex().getInstructionsBuilder(myTarget.getArtifact());
  BuildFSState fsState=myProjectDescriptor.fsState;
  BuildTargetConfiguration configuration=myProjectDescriptor.getTargetsState().getTargetConfiguration(myTarget);
  if (context.isProjectRebuild() || configuration.isTargetDirty() || context.getScope().isRecompilationForced(myTarget)) {
    IncProjectBuilder.clearOutputFiles(context,myTarget);
    myProjectDescriptor.dataManager.getSourceToOutputMap(myTarget).clean();
    getOrCreateOutSrcMapping().clean();
    markDirtyFiles(builder,dataManager,null,true);
    configuration.save();
  }
 else   if (fsState.markInitialScanPerformed(myTarget)) {
    final Set<File> currentPaths=new THashSet<File>(FileUtil.FILE_HASHING_STRATEGY);
    fsState.clearDeletedPaths(myTarget);
    markDirtyFiles(builder,dataManager,currentPaths,false);
    final SourceToOutputMapping mapping=dataManager.getSourceToOutputMap(myTarget);
    final Iterator<String> iterator=mapping.getKeysIterator();
    while (iterator.hasNext()) {
      String path=iterator.next();
      File file=new File(FileUtil.toSystemDependentName(path));
      if (!currentPaths.contains(file)) {
        fsState.registerDeleted(myTarget,file,myProjectDescriptor.timestamps.getStorage());
      }
    }
  }
}
