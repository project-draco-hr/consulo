{
  ArtifactInstructionsBuilder builder=myProjectDescriptor.getArtifactRootsIndex().getInstructionsBuilder(myArtifact);
  BuildFSState fsState=myProjectDescriptor.fsState;
  String artifactName=myArtifact.getName();
  if (context.isProjectRebuild() || context.getScope().isRecompilationForced(myArtifact)) {
    markDirtyFiles(builder,dataManager,null,true);
  }
 else   if (fsState.markInitialScanPerformed(artifactName)) {
    final Set<String> currentPaths=new HashSet<String>();
    fsState.clearDeletedPaths(artifactName);
    markDirtyFiles(builder,dataManager,currentPaths,false);
    final ArtifactSourceToOutputMapping mapping=getOrCreateSrcOutMapping();
    final Iterator<String> iterator=mapping.getKeysIterator();
    while (iterator.hasNext()) {
      String path=iterator.next();
      if (!currentPaths.contains(path)) {
        fsState.registerDeleted(artifactName,myArtifactId,path,myTimestampStorage);
      }
    }
  }
}
