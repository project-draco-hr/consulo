{
  BuildFSState fsState=myProjectDescriptor.fsState;
  BuildTargetConfiguration configuration=myProjectDescriptor.getTargetsState().getTargetConfiguration(myTarget);
  String outputFilePath=myTarget.getArtifact().getOutputFilePath();
  boolean outputDirWasDeleted=!StringUtil.isEmpty(outputFilePath) && !new File(FileUtil.toSystemDependentName(outputFilePath)).exists();
  if (context.isProjectRebuild() || configuration.isTargetDirty() || context.getScope().isRecompilationForced(myTarget)|| outputDirWasDeleted) {
    IncProjectBuilder.clearOutputFiles(context,myTarget);
    ((SourceToOutputMappingImpl)myProjectDescriptor.dataManager.getSourceToOutputMap(myTarget)).clean();
    getOrCreateOutSrcMapping().clean();
    markDirtyFiles(null,true,context);
    configuration.save();
  }
 else   if (fsState.markInitialScanPerformed(myTarget)) {
    final Set<File> currentPaths=new THashSet<File>(FileUtil.FILE_HASHING_STRATEGY);
    fsState.clearDeletedPaths(myTarget);
    markDirtyFiles(currentPaths,false,context);
    final SourceToOutputMapping mapping=dataManager.getSourceToOutputMap(myTarget);
    final Iterator<String> iterator=mapping.getSourcesIterator();
    while (iterator.hasNext()) {
      String path=iterator.next();
      File file=new File(FileUtil.toSystemDependentName(path));
      if (!currentPaths.contains(file)) {
        fsState.registerDeleted(myTarget,file,myProjectDescriptor.timestamps.getStorage());
      }
    }
  }
}
