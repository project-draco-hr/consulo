{
  try {
    final TextResult value=templateState.getVariableValue(PRIMARY_VARIABLE_NAME);
    myInsertedName=value != null ? value.toString() : null;
    TextRange range=templateState.getCurrentVariableRange();
    final int currentOffset=myEditor.getCaretModel().getOffset();
    if (range == null && myRenameOffset != null) {
      range=new TextRange(myRenameOffset.getStartOffset(),myRenameOffset.getEndOffset());
    }
    myBeforeRevert=range != null && range.getEndOffset() >= currentOffset && range.getStartOffset() <= currentOffset ? myEditor.getDocument().createRangeMarker(range.getStartOffset(),currentOffset) : null;
    if (myBeforeRevert != null) {
      myBeforeRevert.setGreedyToRight(true);
    }
    finish(true);
  }
  finally {
    restoreDaemonUpdateState();
  }
}
