{
  boolean bind=false;
  try {
    super.templateFinished(template,brokenOff);
    if (!brokenOff) {
      bind=performRefactoring();
    }
    moveOffsetAfter(!brokenOff);
  }
  finally {
    if (!bind) {
      try {
        ((EditorImpl)InjectedLanguageUtil.getTopLevelEditor(myEditor)).stopDumb();
      }
  finally {
        FinishMarkAction.finish(myProject,myEditor,myMarkAction);
        if (myBeforeRevert != null) {
          myBeforeRevert.dispose();
        }
      }
    }
  }
}
