{
  if (myCalcedSubstitutor == null) {
    PsiSubstitutor incompleteSubstitutor=super.getSubstitutor();
    PsiMethod method=getElement();
    if (myTypeArguments == null) {
      final RecursionGuard.StackStamp stackStamp=PsiDiamondType.ourDiamondGuard.markStack();
      final PsiSubstitutor inferredSubstitutor=inferTypeArguments(DefaultParameterTypeInferencePolicy.INSTANCE);
      final Set<PsiParameterList> lists=LambdaUtil.ourParams.get();
      if (lists != null && !lists.isEmpty() || !stackStamp.mayCacheNow()) {
        return inferredSubstitutor;
      }
      myCalcedSubstitutor=inferredSubstitutor;
    }
 else {
      PsiTypeParameter[] typeParams=method.getTypeParameters();
      for (int i=0; i < myTypeArguments.length && i < typeParams.length; i++) {
        incompleteSubstitutor=incompleteSubstitutor.put(typeParams[i],myTypeArguments[i]);
      }
      myCalcedSubstitutor=incompleteSubstitutor;
    }
  }
  return myCalcedSubstitutor;
}
