{
  Set<Integer> detectorsToProcess;
synchronized (myLock) {
    detectorsToProcess=new HashSet<Integer>(myDetectorsToProcess);
    detectorsToProcess.addAll(myDetectorsToProcess);
    myDetectorsToProcess.clear();
  }
  if (detectorsToProcess.isEmpty())   return;
  if (LOG.isDebugEnabled()) {
    LOG.debug("Starting framework detectors: " + detectorsToProcess);
  }
  final FileBasedIndex index=FileBasedIndex.getInstance();
  Map<Integer,List<? extends DetectedFrameworkDescription>> newDescriptions=new HashMap<Integer,List<? extends DetectedFrameworkDescription>>();
  final DetectionExcludesConfiguration excludesConfiguration=DetectionExcludesConfiguration.getInstance(myProject);
  for (  Integer id : detectorsToProcess) {
    Collection<VirtualFile> files=index.getContainingFiles(FrameworkDetectionIndex.NAME,id,GlobalSearchScope.projectScope(myProject));
    final Collection<VirtualFile> newFiles=myDetectedFrameworksData.retainNewFiles(id,files);
    FrameworkDetector detector=FrameworkDetectorRegistry.getInstance().getDetectorById(id);
    if (detector != null) {
      excludesConfiguration.removeExcluded(newFiles,detector);
      if (LOG.isDebugEnabled()) {
        LOG.debug("Detector '" + detector.getDetectorId() + "': "+ files.size()+ " accepted files, "+ newFiles.size()+ " files to process");
      }
      final List<? extends DetectedFrameworkDescription> frameworks;
      if (!newFiles.isEmpty()) {
        frameworks=detector.detect(newFiles,new FrameworkDetectionContextImpl(myProject));
      }
 else {
        frameworks=Collections.emptyList();
      }
      final List<? extends DetectedFrameworkDescription> updated=myDetectedFrameworksData.updateFrameworksList(id,frameworks);
      if (LOG.isDebugEnabled()) {
        LOG.debug(frameworks.size() + " frameworks detected, " + updated.size()+ " changed");
      }
      if (!updated.isEmpty()) {
        newDescriptions.put(id,updated);
      }
    }
 else {
      LOG.info("Framework detector not found by id " + id);
    }
  }
  Set<String> frameworkNames=new HashSet<String>();
  for (  final Integer detectorId : newDescriptions.keySet()) {
    for (    final DetectedFrameworkDescription description : newDescriptions.get(detectorId)) {
      frameworkNames.add(description.getFrameworkType().getPresentableName());
    }
  }
  if (!frameworkNames.isEmpty()) {
    String names=StringUtil.join(frameworkNames,", ");
    final String text=ProjectBundle.message("framework.detected.info.text",names,frameworkNames.size());
    FRAMEWORK_DETECTION_NOTIFICATION.createNotification("Frameworks detected",text,NotificationType.INFORMATION,new NotificationListener(){
      @Override public void hyperlinkUpdate(      @NotNull Notification notification,      @NotNull HyperlinkEvent event){
        if (event.getEventType() == HyperlinkEvent.EventType.ACTIVATED) {
          showSetupFrameworksDialog(notification);
        }
      }
    }
).notify(myProject);
  }
}
