{
  MultiMap<Integer,VirtualFile> filesToProcess;
synchronized (myLock) {
    filesToProcess=new MultiMap<Integer,VirtualFile>();
    filesToProcess.putAllValues(myFilesToProcess);
    myFilesToProcess.clear();
  }
  final FileBasedIndex index=FileBasedIndex.getInstance();
  for (  Integer key : filesToProcess.keySet()) {
    Collection<VirtualFile> files=index.getContainingFiles(FrameworkDetectionIndex.NAME,key,GlobalSearchScope.allScope(myProject));
    final Collection<VirtualFile> changed=filesToProcess.get(key);
    changed.retainAll(files);
    myDetectedFrameworksData.retainNewFiles(key,changed);
    FrameworkDetector detector=FrameworkDetectorRegistry.getInstance().getDetectorById(key);
    if (detector != null) {
      detector.detect(files);
    }
  }
}
