{
  int parameterIndex=myMethod.getParameterList().getParameterIndex(myParameter);
  myLocalReplacements=new HashMap<PsiVariable,PsiElement>();
  final PsiExpression[] arguments=myMethodCall.getArgumentList().getExpressions();
  for (int i=0; i < arguments.length; i++) {
    if (i != parameterIndex && arguments[i] instanceof PsiReferenceExpression) {
      final PsiReferenceExpression referenceExpression=(PsiReferenceExpression)arguments[i];
      final PsiElement element=referenceExpression.resolve();
      if (element instanceof PsiLocalVariable || element instanceof PsiParameter) {
        final PsiParameter param=myMethod.getParameterList().getParameters()[i];
        final PsiExpression paramRef=JavaPsiFacade.getInstance(myMethod.getProject()).getElementFactory().createExpressionFromText(param.getName(),myMethod);
        myLocalReplacements.put((PsiVariable)element,paramRef);
      }
    }
  }
  processParameterInitializer();
  PsiExpression initializerInMethod=(PsiExpression)myInitializer.copy();
  final Map<PsiElement,PsiElement> elementsToReplace=new HashMap<PsiElement,PsiElement>();
  final boolean canEvaluate=replaceLocals(initializerInMethod,elementsToReplace);
  if (!canEvaluate) {
    CommonRefactoringUtil.showErrorHint(myMethod.getProject(),myEditor,"Parameter initializer depends on values which are not available inside the method and cannot be inlined",RefactoringBundle.message("inline.parameter.refactoring"),null);
    return;
  }
  final Collection<PsiReference> parameterRefs=ReferencesSearch.search(myParameter).findAll();
  initializerInMethod=(PsiExpression)RefactoringUtil.replaceElementsWithMap(initializerInMethod,elementsToReplace);
  String question=RefactoringBundle.message("inline.parameter.confirmation",myParameter.getName(),initializerInMethod.getText());
  boolean createLocal;
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    createLocal=myMethod.getProject().getUserData(CREATE_LOCAL_FOR_TESTS);
  }
 else {
    InlineParameterDialog dlg=new InlineParameterDialog(InlineParameterHandler.REFACTORING_NAME,question,HelpID.INLINE_VARIABLE,"OptionPane.questionIcon",true,myMethod.getProject());
    if (!dlg.showDialog()) {
      return;
    }
    createLocal=dlg.isCreateLocal();
  }
  performRefactoring(initializerInMethod,parameterRefs,createLocal);
}
