{
  File patchPath=getPatchPath(commitMessage);
  Writer writer;
  try {
    writer=new OutputStreamWriter(new FileOutputStream(patchPath));
  }
 catch (  IOException ex) {
    patchPath=getPatchPath("shelved_change");
    writer=new OutputStreamWriter(new FileOutputStream(patchPath));
  }
  try {
    List<FilePatch> patches=PatchBuilder.buildPatch(changes,myProject.getBaseDir().getPresentableUrl(),true);
    UnifiedDiffWriter.write(patches,writer);
  }
  finally {
    writer.close();
  }
  RollbackChangesDialog.doRollback(myProject,changes,true,false);
  myShelvedChangeListDatas.add(new ShelvedChangeList(patchPath.toString(),commitMessage.replace('\n',' ')));
  notifyStateChanged();
}
