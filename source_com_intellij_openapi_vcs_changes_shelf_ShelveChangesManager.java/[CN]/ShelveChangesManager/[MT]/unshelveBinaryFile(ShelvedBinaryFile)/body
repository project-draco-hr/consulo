{
  final String beforePath=file.BEFORE_PATH == null ? null : file.BEFORE_PATH.replace(File.separatorChar,'/');
  final String afterPath=file.AFTER_PATH == null ? null : file.AFTER_PATH.replace(File.separatorChar,'/');
  final boolean isNewFile=beforePath == null;
  ApplyPatchContext context=new ApplyPatchContext(myProject.getBaseDir(),0,true,true);
  final VirtualFile patchTarget=FilePatch.findPatchTarget(context,beforePath,afterPath,isNewFile);
  if (patchTarget != null) {
    final Ref<IOException> ex=new Ref<IOException>();
    final Ref<VirtualFile> patchedFileRef=new Ref<VirtualFile>();
    final File shelvedFile=new File(file.SHELVED_PATH);
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        VirtualFile fileToPatch=patchTarget;
        try {
          if (isNewFile) {
            fileToPatch=fileToPatch.createChildData(this,new File(afterPath).getName());
          }
          fileToPatch.setBinaryContent(FileUtil.loadFileBytes(shelvedFile));
          patchedFileRef.set(fileToPatch);
        }
 catch (        IOException e) {
          ex.set(e);
        }
      }
    }
);
    if (!ex.isNull()) {
      throw ex.get();
    }
    FileUtil.delete(shelvedFile);
    return new FilePathImpl(patchedFileRef.get());
  }
 else {
    Messages.showErrorDialog(myProject,"Failed to unshelve binary file " + (afterPath != null ? afterPath : beforePath),VcsBundle.message("unshelve.changes.dialog.title"));
    return null;
  }
}
