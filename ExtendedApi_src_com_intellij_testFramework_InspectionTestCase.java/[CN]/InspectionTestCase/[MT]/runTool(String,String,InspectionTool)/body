{
  final VirtualFile[] sourceDir=new VirtualFile[1];
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        setupRootModel(testDir,sourceDir,jdkName);
      }
 catch (      Exception e) {
        LOG.error(e);
      }
    }
  }
);
  PsiManager psiManager=PsiManager.getInstance(myProject);
  AnalysisScope scope=new AnalysisScope(psiManager.findDirectory(sourceDir[0]));
  InspectionManagerEx inspectionManager=(InspectionManagerEx)InspectionManager.getInstance(myProject);
  final GlobalInspectionContextImpl globalContext=inspectionManager.createNewGlobalContext(true);
  globalContext.setCurrentScope(scope);
  tool.initialize(globalContext);
  if (tool.isGraphNeeded()) {
    ((RefManagerImpl)tool.getRefManager()).findAllDeclarations();
  }
  tool.runInspection(scope,inspectionManager);
  tool.queryExternalUsagesRequests(inspectionManager);
  do {
    globalContext.processSearchRequests();
  }
 while (tool.queryExternalUsagesRequests(inspectionManager));
}
