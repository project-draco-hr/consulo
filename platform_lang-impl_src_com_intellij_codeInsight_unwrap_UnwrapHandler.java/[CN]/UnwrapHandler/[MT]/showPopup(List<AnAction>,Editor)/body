{
  final ScopeHighlighter highlighter=new ScopeHighlighter(editor);
  DefaultListModel m=new DefaultListModel();
  for (  AnAction a : options) {
    m.addElement(((MyUnwrapAction)a).getName());
  }
  final JList list=new JBList(m);
  list.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
  list.setVisibleRowCount(options.size());
  list.addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    ListSelectionEvent e){
      int index=list.getSelectedIndex();
      if (index < 0)       return;
      MyUnwrapAction a=(MyUnwrapAction)options.get(index);
      List<PsiElement> toExtract=new ArrayList<PsiElement>();
      PsiElement wholeRange=a.collectAffectedElements(toExtract);
      highlighter.highlight(wholeRange,toExtract);
    }
  }
);
  PopupChooserBuilder builder=JBPopupFactory.getInstance().createListPopupBuilder(list);
  builder.setTitle(CodeInsightBundle.message("unwrap.popup.title")).setMovable(false).setResizable(false).setRequestFocus(true).setItemChoosenCallback(new Runnable(){
    @Override public void run(){
      MyUnwrapAction a=(MyUnwrapAction)options.get(list.getSelectedIndex());
      a.actionPerformed(null);
    }
  }
).addListener(new JBPopupAdapter(){
    @Override public void onClosed(    LightweightWindowEvent event){
      highlighter.dropHighlight();
    }
  }
);
  JBPopup popup=builder.createPopup();
  popup.showInBestPositionFor(editor);
}
