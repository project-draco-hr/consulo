{
  ActionManagerEx actionManager=ActionManagerEx.getInstanceEx();
  final String[] oldIds=actionManager.getActionIds(AntConfiguration.getActionIdPrefix(getProject()));
  for (  String oldId : oldIds) {
    actionManager.unregisterAction(oldId);
  }
  final Set<String> registeredIds=StringSetSpinAllocator.alloc();
  try {
    for (    final AntBuildFile buildFile : getBuildFiles()) {
      final AntBuildModelBase model=(AntBuildModelBase)buildFile.getModel();
      String defaultTargetActionId=model.getDefaultTargetActionId();
      if (defaultTargetActionId != null && !registeredIds.contains(defaultTargetActionId)) {
        registeredIds.add(defaultTargetActionId);
        actionManager.registerAction(defaultTargetActionId,new TargetAction(buildFile,TargetAction.DEFAULT_TARGET_NAME,new String[]{TargetAction.DEFAULT_TARGET_NAME},null));
      }
      registerTargetActions(model.getFilteredTargets(),registeredIds,actionManager,buildFile);
      registerTargetActions(getMetaTargets(buildFile),registeredIds,actionManager,buildFile);
    }
  }
  finally {
    StringSetSpinAllocator.dispose(registeredIds);
  }
}
