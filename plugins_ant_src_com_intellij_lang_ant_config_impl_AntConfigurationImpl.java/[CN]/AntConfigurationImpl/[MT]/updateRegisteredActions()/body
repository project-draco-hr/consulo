{
synchronized (myLock) {
    ActionManagerEx actionManager=ActionManagerEx.getInstanceEx();
    final String[] oldIds=actionManager.getActionIds(TargetAction.ACTION_ID_PREFIX);
    for (    String oldId : oldIds) {
      actionManager.unregisterAction(oldId);
    }
    final Project[] openProjects=ProjectManager.getInstance().getOpenProjects();
    final Set<String> registeredIds=StringSetSpinAllocator.alloc();
    try {
      for (      Project project : openProjects) {
        final AntConfiguration antConfiguration=AntConfiguration.getInstance(project);
        for (        final AntBuildFile buildFile : antConfiguration.getBuildFiles()) {
          final AntBuildModelBase model=(AntBuildModelBase)buildFile.getModel();
          String defaultTargetActionId=model.getDefaultTargetActionId();
          if (defaultTargetActionId != null && !registeredIds.contains(defaultTargetActionId)) {
            registeredIds.add(defaultTargetActionId);
            actionManager.registerAction(defaultTargetActionId,new TargetAction(buildFile,TargetAction.DEFAULT_TARGET_NAME,new String[]{TargetAction.DEFAULT_TARGET_NAME},null));
          }
          registerTargetActions(model.getFilteredTargets(),registeredIds,actionManager,buildFile);
          registerTargetActions(antConfiguration.getMetaTargets(buildFile),registeredIds,actionManager,buildFile);
        }
      }
    }
  finally {
      StringSetSpinAllocator.dispose(registeredIds);
    }
  }
}
