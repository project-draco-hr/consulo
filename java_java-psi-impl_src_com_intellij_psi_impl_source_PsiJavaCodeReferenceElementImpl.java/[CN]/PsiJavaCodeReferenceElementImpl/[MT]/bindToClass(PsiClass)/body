{
  String qName=aClass.getQualifiedName();
  boolean preserveQualification=JavaCodeStyleSettingsFacade.getInstance(getProject()).useFQClassNames() && isFullyQualified();
  JavaPsiFacade facade=JavaPsiFacade.getInstance(getProject());
  if (qName == null) {
    qName=aClass.getName();
    PsiClass psiClass=facade.getResolveHelper().resolveReferencedClass(qName,this);
    if (!getManager().areElementsEquivalent(psiClass,aClass)) {
      throw cannotBindError(aClass);
    }
  }
 else   if (facade.findClass(qName,getResolveScope()) == null && !preserveQualification) {
    return this;
  }
  List<PsiAnnotation> annotations=getAnnotations();
  String text=qName;
  PsiReferenceParameterList parameterList=getParameterList();
  if (parameterList != null) {
    text+=parameterList.getText();
  }
  PsiJavaCodeReferenceElement ref=facade.getParserFacade().createReferenceFromText(text,getParent());
  getTreeParent().replaceChildInternal(this,(TreeElement)ref.getNode());
  ((PsiJavaCodeReferenceElementImpl)ref).setAnnotations(annotations);
  if (!preserveQualification) {
    JavaCodeStyleManager codeStyleManager=JavaCodeStyleManager.getInstance(aClass.getProject());
    ref=(PsiJavaCodeReferenceElement)codeStyleManager.shortenClassReferences(ref,JavaCodeStyleManager.UNCOMPLETE_CODE);
  }
  return ref;
}
