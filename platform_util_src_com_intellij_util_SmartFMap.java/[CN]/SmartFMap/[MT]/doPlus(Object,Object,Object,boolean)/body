{
  if (oldMap instanceof Map) {
    Map newMap=inPlace ? (Map)oldMap : new THashMap((Map)oldMap);
    newMap.put(key,value);
    return newMap;
  }
  Object[] array=(Object[])oldMap;
  for (int i=0; i < array.length; i+=2) {
    if (key.equals(array[i])) {
      Object[] newArray=inPlace ? array : new Object[array.length];
      if (!inPlace) {
        System.arraycopy(array,0,newArray,0,array.length);
      }
      newArray[i + 1]=value;
      return newArray;
    }
  }
  if (array.length == 2 * ARRAY_THRESHOLD) {
    THashMap map=new THashMap();
    for (int i=0; i < array.length; i+=2) {
      map.put(array[i],array[i + 1]);
    }
    map.put(key,value);
    return map;
  }
  Object[] newArray=new Object[array.length + 2];
  System.arraycopy(array,0,newArray,0,array.length);
  newArray[array.length]=key;
  newArray[array.length + 1]=value;
  return newArray;
}
