{
  return new ReadAction<ProcessingItem[]>(){
    protected void run(    final Result<ProcessingItem[]> result){
      Module[] affectedModules=context.getCompileScope().getAffectedModules();
      if (affectedModules.length == 0) {
        result.setResult(ProcessingItem.EMPTY_ARRAY);
        return;
      }
      Module[] allModules=ModuleManager.getInstance(myProject).getSortedModules();
      ProcessingItemsBuilderContext builderContext=new ProcessingItemsBuilderContext(context);
      final BuildParticipantProvider<?>[] providers=DeploymentUtilImpl.getBuildParticipantProviders();
      for (      BuildParticipantProvider<?> provider : providers) {
        addItemsForProvider(provider,allModules,builderContext);
      }
      context.putUserData(DESTINATION_OWNERS_KEY,builderContext.getDestinationOwners());
      context.putUserData(MANIFEST_FILES_KEY,builderContext.getManifestFiles());
      context.putUserData(ITEMS_BY_SOURCE_KEY,builderContext.getItemsBySourceMap());
      PackagingProcessingItem[] allProcessingItems=builderContext.getProcessingItems(affectedModules);
      boolean hasFilesToDelete=collectFilesToDelete(context,builderContext.getProcessingItems());
      if (hasFilesToDelete) {
        MockProcessingItem mockItem=new MockProcessingItem(new LightVirtualFile("239239293"));
        result.setResult(ArrayUtil.append(allProcessingItems,mockItem,ProcessingItem.class));
      }
 else {
        result.setResult(allProcessingItems);
      }
    }
  }
.execute().getResultObject();
}
