{
  if (!processed.add(module)) {
    return;
  }
  for (  JpsDependencyElement it : JpsJavaExtensionService.getInstance().getDependencies(module,kind,exportedOnly)) {
    if (!filter.accept(module,it) || it instanceof JpsSdkDependency && excludeSdk) {
      continue;
    }
    if (it instanceof JpsModuleSourceDependency) {
      if (!excludeMainModuleOutput && kind.isTestsIncluded()) {
        final File out=getModuleOutputDir(module,true);
        if (out != null) {
          classpath.add(out);
        }
      }
      if (!excludeMainModuleOutput || kind.isTestsIncluded()) {
        final File out=getModuleOutputDir(module,false);
        if (out != null) {
          classpath.add(out);
        }
      }
    }
 else     if (it instanceof JpsModuleDependency) {
      final JpsModule dep=((JpsModuleDependency)it).getModule();
      if (dep != null) {
        collectClasspath(dep,kind,classpath,processed,!kind.isRuntime(),false,true,filter);
      }
    }
 else     if (it instanceof JpsLibraryDependency) {
      addLibraryFiles(classpath,((JpsLibraryDependency)it).getLibrary());
    }
 else     if (it instanceof JpsSdkDependency) {
      addLibraryFiles(classpath,((JpsSdkDependency)it).resolveSdk());
    }
  }
}
