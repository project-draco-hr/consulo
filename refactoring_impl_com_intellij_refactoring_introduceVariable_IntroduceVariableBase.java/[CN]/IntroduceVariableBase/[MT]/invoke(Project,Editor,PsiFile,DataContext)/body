{
  if (!editor.getSelectionModel().hasSelection()) {
    final PsiElement elementAtCaret=file.findElementAt(editor.getCaretModel().getOffset());
    final List<PsiExpression> expressions=new ArrayList<PsiExpression>();
    PsiExpression expression=PsiTreeUtil.getParentOfType(elementAtCaret,PsiExpression.class);
    while (expression != null) {
      if (!(expression instanceof PsiReferenceExpression) && expression.getType() != PsiType.VOID) {
        expressions.add(expression);
      }
      expression=PsiTreeUtil.getParentOfType(expression,PsiExpression.class);
    }
    if (expressions.isEmpty()) {
      editor.getSelectionModel().selectLineAtCaret();
    }
 else     if (expressions.size() == 1) {
      final TextRange textRange=expressions.get(0).getTextRange();
      editor.getSelectionModel().setSelection(textRange.getStartOffset(),textRange.getEndOffset());
    }
 else {
      showChooser(editor,expressions,new Pass<PsiExpression>(){
        public void pass(        final PsiExpression selectedValue){
          invoke(project,editor,file,selectedValue.getTextRange().getStartOffset(),selectedValue.getTextRange().getEndOffset());
        }
      }
);
      return;
    }
  }
  if (invoke(project,editor,file,editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd())) {
    editor.getSelectionModel().removeSelection();
  }
}
