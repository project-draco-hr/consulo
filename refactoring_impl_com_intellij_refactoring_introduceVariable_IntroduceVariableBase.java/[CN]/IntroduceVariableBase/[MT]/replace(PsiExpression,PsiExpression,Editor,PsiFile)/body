{
  final PsiExpression expr2=RefactoringUtil.outermostParenthesizedExpression(expr1);
  if (expr2.isPhysical()) {
    return expr2.replace(ref);
  }
 else {
    int selectionStart=editor.getSelectionModel().getSelectionStart();
    final int selectionEnd=editor.getSelectionModel().getSelectionEnd();
    PsiElement last=null;
    final Set<PsiElement> toReplace=new HashSet<PsiElement>();
    while (selectionStart < selectionEnd) {
      final PsiElement at=file.findElementAt(selectionStart++);
      if (at != null) {
        last=at;
        toReplace.add(last);
      }
    }
    PsiElement replacement=null;
    if (last != null) {
      final PsiElement prefix=expr1.getUserData(ElementToWorkOn.PREFIX);
      final PsiElement suffix=expr1.getUserData(ElementToWorkOn.SUFFIX);
      final String text=(prefix != null ? prefix.getText() + " + " : "") + ref.getText() + (suffix != null ? " + " + suffix.getText() : "");
      final PsiExpression el=JavaPsiFacade.getInstance(file.getProject()).getElementFactory().createExpressionFromText(text,file);
      replacement=last.getParent().addAfter(el,replacement);
    }
    for (    PsiElement element : toReplace) {
      if (element.isValid())       element.delete();
    }
    return replacement;
  }
}
