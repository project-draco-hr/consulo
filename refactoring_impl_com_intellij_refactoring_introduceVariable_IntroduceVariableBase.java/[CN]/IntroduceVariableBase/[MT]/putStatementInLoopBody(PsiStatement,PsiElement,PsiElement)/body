{
  if (isLoopOrIf(container)) {
    PsiStatement loopBody=getLoopBody(container,finalAnchorStatement);
    PsiStatement loopBodyCopy=loopBody != null ? (PsiStatement)loopBody.copy() : null;
    PsiBlockStatement blockStatement=(PsiBlockStatement)container.getManager().getElementFactory().createStatementFromText("{}",null);
    blockStatement=(PsiBlockStatement)CodeStyleManager.getInstance(container.getProject()).reformat(blockStatement);
    final PsiElement prevSibling=loopBody.getPrevSibling();
    if (prevSibling instanceof PsiWhiteSpace) {
      final PsiElement pprev=prevSibling.getPrevSibling();
      if (!(pprev instanceof PsiComment) || !((PsiComment)pprev).getTokenType().equals(JavaTokenType.END_OF_LINE_COMMENT)) {
        prevSibling.delete();
      }
    }
    blockStatement=(PsiBlockStatement)loopBody.replace(blockStatement);
    final PsiCodeBlock codeBlock=blockStatement.getCodeBlock();
    declaration=(PsiStatement)codeBlock.add(declaration);
    JavaCodeStyleManager.getInstance(declaration.getProject()).shortenClassReferences(declaration);
    if (loopBodyCopy != null)     codeBlock.add(loopBodyCopy);
  }
  return declaration;
}
