{
  ArrayList childNodes=TreeUtil.childrenToArray(root);
  for (Iterator iterator=childNodes.iterator(); iterator.hasNext(); ) {
    DefaultMutableTreeNode childNode=(DefaultMutableTreeNode)iterator.next();
    TreePath path=new TreePath(childNode.getPath());
    if (tree.isPathSelected(path)) {
      selectionPaths.add(storeElementsOnly ? ((NodeDescriptor)childNode.getUserObject()).getElement() : path);
    }
    if (tree.isExpanded(path) || childNode.getChildCount() == 0) {
      pathsToExpand.add(storeElementsOnly && childNode.getUserObject() instanceof NodeDescriptor ? ((NodeDescriptor)childNode.getUserObject()).getElement() : path);
      _storePaths(tree,childNode,pathsToExpand,selectionPaths,storeElementsOnly);
    }
  }
}
