{
  final Document document=myEditor.getDocument();
  final VirtualFile file=FileDocumentManager.getInstance().getFile(document);
  if (file != null) {
    ReadonlyStatusHandler.getInstance(myFile.getProject()).ensureFilesWritable(file);
  }
  String selection=myEditor.getSelectionModel().getSelectedText();
  if (selection != null) {
    selection=selection.trim();
    final CustomTemplateCallback callback=new CustomTemplateCallback(myEditor,myFile);
    myTemplate.wrap(selection,callback,new TemplateInvokationListener(){
      public void finished(){
        callback.startAllExpandedTemplates();
      }
    }
);
  }
}
