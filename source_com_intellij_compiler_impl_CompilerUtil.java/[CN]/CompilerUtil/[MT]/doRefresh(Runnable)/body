{
  final Application applicationEx=ApplicationManager.getApplication();
  if (applicationEx.isDispatchThread()) {
    applicationEx.runWriteAction(refreshRunnable);
  }
 else {
    try {
      ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
      ModalityState modalityState;
      if (progress instanceof CompilerProgressIndicator) {
        Window window=((CompilerProgressIndicator)progress).getWindow();
        modalityState=window != null ? ModalityState.stateForComponent(window) : ModalityState.NON_MMODAL;
      }
 else {
        modalityState=ModalityState.NON_MMODAL;
      }
      ApplicationManager.getApplication().invokeAndWait(new Runnable(){
        public void run(){
          ApplicationManager.getApplication().runWriteAction(refreshRunnable);
        }
      }
,modalityState);
    }
 catch (    Exception e) {
      LOG.error(e);
    }
  }
}
