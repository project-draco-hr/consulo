{
  return new WriteCommandAction<Module>(getProject()){
    @Override protected void run(    Result<Module> result) throws Throwable {
      final VirtualFile depRoot=myFixture.getTempDirFixture().findOrCreateDir(name);
      final ModifiableModuleModel moduleModel=ModuleManager.getInstance(getProject()).getModifiableModel();
      String moduleName=moduleModel.newModule(depRoot.getPath() + "/" + name+ ".iml",StdModuleTypes.JAVA).getName();
      moduleModel.commit();
      final Module dep=ModuleManager.getInstance(getProject()).findModuleByName(moduleName);
      final ModifiableRootModel model=ModuleRootManager.getInstance(dep).getModifiableModel();
      final ContentEntry entry=model.addContentEntry(depRoot);
      entry.addSourceFolder(depRoot,false);
      model.setSdk(ModuleRootManager.getInstance(myModule).getSdk());
      model.commit();
      result.setResult(dep);
    }
  }
.execute().getResultObject();
}
