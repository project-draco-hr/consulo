{
  return new WriteCommandAction<Module>(getProject()){
    @Override protected void run(    Result<Module> result) throws Throwable {
      final VirtualFile depRoot=myFixture.getTempDirFixture().findOrCreateDir(name);
      final ModifiableModuleModel moduleModel=ModuleManager.getInstance(getProject()).getModifiableModel();
      String moduleName=moduleModel.newModule(depRoot.getPath() + "/" + name+ ".iml",StdModuleTypes.JAVA.getId()).getName();
      moduleModel.commit();
      final Module dep=ModuleManager.getInstance(getProject()).findModuleByName(moduleName);
      ModuleRootModificationUtil.setModuleSdk(dep,ModuleRootManager.getInstance(myModule).getSdk());
      if (withSource) {
        PsiTestUtil.addSourceRoot(dep,depRoot);
      }
 else {
        PsiTestUtil.addContentRoot(dep,depRoot);
      }
      IdeaTestUtil.setModuleLanguageLevel(dep,LanguageLevelModuleExtension.getInstance(myModule).getLanguageLevel());
      result.setResult(dep);
    }
  }
.execute().getResultObject();
}
