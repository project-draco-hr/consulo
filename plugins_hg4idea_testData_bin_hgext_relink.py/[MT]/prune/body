def prune(candidates, src, dst, ui):

    def linkfilter(src, dst, st):
        try:
            ts = os.stat(dst)
        except OSError:
            return False
        if util.samefile(src, dst):
            return False
        if (not util.samedevice(src, dst)):
            raise util.Abort(_('source and destination are on different devices'))
        if (st.st_size != ts.st_size):
            return False
        return st
    targets = []
    for (fn, st) in candidates:
        srcpath = os.path.join(src, fn)
        tgt = os.path.join(dst, fn)
        ts = linkfilter(srcpath, tgt, st)
        if (not ts):
            ui.debug((_('not linkable: %s\n') % fn))
            continue
        targets.append((fn, ts.st_size))
    ui.status((_('pruned down to %d probably relinkable files\n') % len(targets)))
    return targets
