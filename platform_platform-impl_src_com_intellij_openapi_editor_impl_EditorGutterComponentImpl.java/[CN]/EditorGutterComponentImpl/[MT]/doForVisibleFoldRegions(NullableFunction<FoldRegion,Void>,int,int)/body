{
  FoldRegion[] visibleFoldRegions=myEditor.getFoldingModel().fetchVisible();
  final Document document=myEditor.getDocument();
  for (  FoldRegion visibleFoldRegion : visibleFoldRegions) {
    if (!visibleFoldRegion.isValid())     continue;
    final int startOffset=visibleFoldRegion.getStartOffset();
    if (startOffset > lastVisibleOffset)     continue;
    final int endOffset=getEndOffset(visibleFoldRegion);
    if (endOffset < firstVisibleOffset)     continue;
    if (document.getLineNumber(startOffset) >= document.getLineNumber(endOffset)) {
      continue;
    }
    action.fun(visibleFoldRegion);
  }
}
