{
  final Project[] projects=ProjectManager.getInstance().getOpenProjects();
  if (projects.length == 0) {
    final PlatformProjectOpenProcessor processor=PlatformProjectOpenProcessor.getInstanceIfItExists();
    if (processor != null) {
      return PlatformProjectOpenProcessor.doOpenProject(virtualFile,null,false,line,null,false);
    }
    Messages.showErrorDialog("No project found to open file in","Cannot open file");
    return null;
  }
 else {
    Project project=projects[0];
    for (    Project aProject : projects) {
      if (ProjectRootManager.getInstance(aProject).getFileIndex().isInContent(virtualFile)) {
        project=aProject;
        break;
      }
    }
    if (line == -1) {
      new OpenFileDescriptor(project,virtualFile).navigate(true);
    }
 else {
      new OpenFileDescriptor(project,virtualFile,line - 1,0).navigate(true);
    }
    return project;
  }
}
