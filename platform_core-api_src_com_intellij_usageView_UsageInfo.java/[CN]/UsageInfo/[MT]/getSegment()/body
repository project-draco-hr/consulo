{
  PsiElement element=getElement();
  if (element == null)   return null;
  TextRange range=element.getTextRange();
  TextRange.assertProperRange(range,element);
  if (element instanceof PsiFile) {
    Document document=PsiDocumentManager.getInstance(getProject()).getDocument((PsiFile)element);
    if (document != null) {
      range=new ProperTextRange(0,document.getTextLength());
    }
  }
  ProperTextRange rangeInElement=getRangeInElement();
  if (rangeInElement == null)   return null;
  return new ProperTextRange(Math.min(range.getEndOffset(),range.getStartOffset() + rangeInElement.getStartOffset()),Math.min(range.getEndOffset(),range.getStartOffset() + rangeInElement.getEndOffset()));
}
