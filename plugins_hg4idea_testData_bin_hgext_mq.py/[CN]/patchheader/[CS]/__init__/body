def __init__(self, pf, plainmode=False):

    def eatdiff(lines):
        while lines:
            l = lines[(-1)]
            if (l.startswith('diff -') or l.startswith('Index:') or l.startswith('===========')):
                del lines[(-1)]
            else:
                break

    def eatempty(lines):
        while lines:
            l = lines[(-1)]
            if re.match('\\s*$', l):
                del lines[(-1)]
            else:
                break
    message = []
    comments = []
    user = None
    date = None
    parent = None
    format = None
    subject = None
    diffstart = 0
    for line in file(pf):
        line = line.rstrip()
        if (line.startswith('diff --git') or (diffstart and line.startswith('+++ '))):
            diffstart = 2
            break
        diffstart = 0
        if line.startswith('--- '):
            diffstart = 1
            continue
        elif (format == 'hgpatch'):
            if line.startswith('# User '):
                user = line[7:]
            elif line.startswith('# Date '):
                date = line[7:]
            elif line.startswith('# Parent '):
                parent = line[9:]
            elif ((not line.startswith('# ')) and line):
                message.append(line)
                format = None
        elif (line == '# HG changeset patch'):
            message = []
            format = 'hgpatch'
        elif ((format != 'tagdone') and (line.startswith('Subject: ') or line.startswith('subject: '))):
            subject = line[9:]
            format = 'tag'
        elif ((format != 'tagdone') and (line.startswith('From: ') or line.startswith('from: '))):
            user = line[6:]
            format = 'tag'
        elif ((format != 'tagdone') and (line.startswith('Date: ') or line.startswith('date: '))):
            date = line[6:]
            format = 'tag'
        elif ((format == 'tag') and (line == '')):
            format = 'tagdone'
        elif (message or line):
            message.append(line)
        comments.append(line)
    eatdiff(message)
    eatdiff(comments)
    eatempty(message)
    eatempty(comments)
    if (format and format.startswith('tag') and subject):
        message.insert(0, '')
        message.insert(0, subject)
    self.message = message
    self.comments = comments
    self.user = user
    self.date = date
    self.parent = parent
    self.haspatch = (diffstart > 1)
    self.plainmode = plainmode
