def printdiff(self, repo, diffopts, node1, node2=None, files=None, fp=None, changes=None, opts={}):
    stat = opts.get('stat')
    if stat:
        opts['unified'] = '0'
    m = cmdutil.match(repo, files, opts)
    chunks = patch.diff(repo, node1, node2, m, changes, diffopts)
    write = (((fp is None) and repo.ui.write) or fp.write)
    if stat:
        width = ((self.ui.interactive() and util.termwidth()) or 80)
        write(patch.diffstat(util.iterlines(chunks), width=width, git=diffopts.git))
    else:
        for chunk in chunks:
            write(chunk)
