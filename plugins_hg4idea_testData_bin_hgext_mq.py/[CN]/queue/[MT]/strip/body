def strip(self, repo, rev, update=True, backup='all', force=None):
    wlock = lock = None
    try:
        wlock = repo.wlock()
        lock = repo.lock()
        if update:
            self.check_localchanges(repo, force=force, refresh=False)
            urev = self.qparents(repo, rev)
            hg.clean(repo, urev)
            repo.dirstate.write()
        self.removeundo(repo)
        repair.strip(self.ui, repo, rev, backup)
        self.removeundo(repo)
    finally:
        release(lock, wlock)
