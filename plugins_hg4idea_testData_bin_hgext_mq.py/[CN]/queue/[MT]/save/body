def save(self, repo, msg=None):
    if (len(self.applied) == 0):
        self.ui.warn(_('save: no patches applied, exiting\n'))
        return 1
    if self.issaveline(self.applied[(-1)]):
        self.ui.warn(_('status is already saved\n'))
        return 1
    ar = [(':' + x) for x in self.full_series]
    if (not msg):
        msg = _('hg patches saved state')
    else:
        msg = ('hg patches: ' + msg.rstrip('\r\n'))
    r = self.qrepo()
    if r:
        pp = r.dirstate.parents()
        msg += ('\nDirstate: %s %s' % (hex(pp[0]), hex(pp[1])))
    msg += '\n\nPatch Data:\n'
    text = (((msg + '\n'.join([str(x) for x in self.applied])) + '\n') + ((ar and ('\n'.join(ar) + '\n')) or ''))
    n = repo.commit(text, force=True)
    if (not n):
        self.ui.warn(_('repo commit failed\n'))
        return 1
    self.applied.append(statusentry(hex(n), '.hg.patches.save.line'))
    self.applied_dirty = 1
    self.removeundo(repo)
