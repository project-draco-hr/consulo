def apply(self, repo, series, list=False, update_status=True, strict=False, patchdir=None, merge=None, all_files={}):
    wlock = lock = tr = None
    try:
        wlock = repo.wlock()
        lock = repo.lock()
        tr = repo.transaction()
        try:
            ret = self._apply(repo, series, list, update_status, strict, patchdir, merge, all_files=all_files)
            tr.close()
            self.save_dirty()
            return ret
        except:
            try:
                tr.abort()
            finally:
                repo.invalidate()
                repo.dirstate.invalidate()
            raise
    finally:
        del tr
        release(lock, wlock)
        self.removeundo(repo)
