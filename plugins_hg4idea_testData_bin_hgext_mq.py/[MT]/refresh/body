def refresh(ui, repo, *pats, **opts):
    'update the current patch\n\n    If any file patterns are provided, the refreshed patch will\n    contain only the modifications that match those patterns; the\n    remaining modifications will remain in the working directory.\n\n    If -s/--short is specified, files currently included in the patch\n    will be refreshed just like matched files and remain in the patch.\n\n    hg add/remove/copy/rename work as usual, though you might want to\n    use git-style patches (-g/--git or [diff] git=1) to track copies\n    and renames. See the diffs help topic for more information on the\n    git diff format.\n    '
    q = repo.mq
    message = cmdutil.logmessage(opts)
    if opts['edit']:
        if (not q.applied):
            ui.write(_('no patches applied\n'))
            return 1
        if message:
            raise util.Abort(_('option "-e" incompatible with "-m" or "-l"'))
        patch = q.applied[(-1)].name
        ph = patchheader(q.join(patch), q.plainmode)
        message = ui.edit('\n'.join(ph.message), (ph.user or ui.username()))
    setupheaderopts(ui, opts)
    ret = q.refresh(repo, pats, msg=message, **opts)
    q.save_dirty()
    return ret
