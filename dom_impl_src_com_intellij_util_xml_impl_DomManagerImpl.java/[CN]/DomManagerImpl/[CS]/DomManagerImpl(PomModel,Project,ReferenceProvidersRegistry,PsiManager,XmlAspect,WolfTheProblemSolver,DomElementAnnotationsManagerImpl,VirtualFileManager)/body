{
  myProject=project;
  myAnnotationsManager=annotationsManager;
  pomModel.addModelListener(new PomModelListener(){
    public void modelChanged(    PomModelEvent event){
      final XmlChangeSet changeSet=(XmlChangeSet)event.getChangeSet(xmlAspect);
      if (changeSet != null) {
        if (!myChanging) {
          new ExternalChangeProcessor(DomManagerImpl.this,changeSet).processChanges();
        }
        final XmlFile xmlFile=changeSet.getChangedFile();
        if (xmlFile == null)         return;
        final FileDescriptionCachedValueProvider provider=getCachedValueProvider(xmlFile);
        if (provider != null) {
          final DomFileDescription description=provider.getFileDescription();
          if (description != null) {
            final DomFileElementImpl<DomElement> fileElement=getFileElement(xmlFile);
            final Set<XmlFile> toUpdate=new THashSet<XmlFile>();
            for (            final DomFileDescription<?> domFileDescription : myFileDescriptionDependencies.get(description)) {
              toUpdate.addAll(domFileDescription.getDomModelDependentFiles(fileElement));
              toUpdate.addAll(ContainerUtil.map(myFileDescriptions.get(domFileDescription),new Function<DomFileElementImpl,XmlFile>(){
                public XmlFile fun(                final DomFileElementImpl s){
                  return s.getFile();
                }
              }
));
            }
            for (            final XmlFile file : toUpdate) {
              updateFileDomness(file,fileElement);
            }
          }
        }
      }
    }
    public boolean isAspectChangeInteresting(    PomModelAspect aspect){
      return xmlAspect.equals(aspect);
    }
  }
);
  myReferenceProvidersRegistry=registry;
  myElementFactory=psiManager.getElementFactory();
  solver.registerFileHighlightFilter(new Condition<VirtualFile>(){
    public boolean value(    final VirtualFile file){
      final PsiFile psiFile=ApplicationManager.getApplication().runReadAction(new Computable<PsiFile>(){
        public @Nullable PsiFile compute(){
          return psiManager.findFile(file);
        }
      }
);
      return isDomFile(psiFile);
    }
  }
,project);
  StdLanguages.XML.injectAnnotator(new Annotator(){
    public void annotate(    PsiElement psiElement,    AnnotationHolder holder){
      final DomFileDescription description=getDomFileDescription(psiElement);
      if (description != null && description.isAutomaticHighlightingEnabled()) {
        final DomElement domElement=getDomElement(psiElement);
        if (domElement != null) {
          final List<Annotation> list=(List<Annotation>)holder;
          for (          final DomElementProblemDescriptor descriptor : annotationsManager.getProblemHolder(domElement).getProblems(domElement)) {
            list.addAll(descriptor.getAnnotations());
          }
        }
      }
    }
  }
,project);
}
