{
  final Ref<CacheCorruptedException> exRef=new Ref<CacheCorruptedException>(null);
  final ModuleFileIndex fileIndex=ModuleRootManager.getInstance(module).getFileIndex();
  final GlobalSearchScope srcRootScope=GlobalSearchScope.moduleScope(module).intersectWith(GlobalSearchScopes.directoryScope(myProject,sourceRoot,true));
  final ContentIterator contentIterator=new ContentIterator(){
    public boolean processFile(    final VirtualFile child){
      try {
        if (child.isValid()) {
          if (!child.isDirectory() && myCompiler.getCompilableFileTypes().contains(child.getFileType())) {
            updateOutputItemsList(outputDir,child,sourceRoot,packagePrefix,filesToRefresh,results,srcRootScope);
          }
        }
        return true;
      }
 catch (      CacheCorruptedException e) {
        exRef.set(e);
        return false;
      }
    }
  }
;
  if (fileIndex.isInContent(from)) {
    fileIndex.iterateContentUnderDirectory(from,contentIterator);
  }
 else {
    new Object(){
      void iterateContent(      VirtualFile from){
        for (        VirtualFile child : from.getChildren()) {
          if (child.isDirectory()) {
            iterateContent(child);
          }
 else {
            contentIterator.processFile(child);
          }
        }
      }
    }
.iterateContent(from);
  }
  final CacheCorruptedException exc=exRef.get();
  if (exc != null) {
    throw exc;
  }
}
