{
  if (!myVirtualFileFilter.accept(file))   return;
  FacetInfo underlyingFacet=null;
  if (myUnderlyingFacetSelector != null) {
    List<U> list=(List<U>)myDetectedConfigurations.get(myFacetType.getUnderlyingFacetType());
    U underlying=myUnderlyingFacetSelector.selectUnderlyingFacet(file,list);
    if (underlying == null) {
      return;
    }
    underlyingFacet=myDetectedFacets.get(underlying);
  }
  List<C> configurations=(List<C>)myDetectedConfigurations.get(myFacetType.getId());
  C newConfiguration=myDetector.detectFacet(file,configurations);
  if (newConfiguration == null || configurations.contains(newConfiguration)) {
    return;
  }
  FacetInfo facetInfo=new FacetInfo(myFacetType,generateFacetName(),newConfiguration,underlyingFacet);
  configurations.add(newConfiguration);
  myDetectedFacets.put(newConfiguration,facetInfo);
}
