{
  PsiClass aClass=myPsiManager.findClass(className);
  assertNotNull("Class " + className + " not found",aClass);
  SystemBuilder b=new SystemBuilder(aClass.getManager(),new Settings(){
    public boolean dropObsoleteCasts(){
      return true;
    }
    public boolean preserveRawArrays(){
      return false;
    }
    public boolean leaveObjectParameterizedTypesRaw(){
      return false;
    }
  }
);
  Kitchen d=new Kitchen(aClass.getManager());
  d.buildGraph(new PsiElement[]{aClass});
  String itemRepr=d.resultString();
  String itemName=className + ".items";
  String patternName=PathManagerEx.getTestDataPath() + getTestRoot() + getTestName(true)+ "/after/"+ itemName;
  File patternFile=new File(patternName);
  if (!patternFile.exists()) {
    PrintWriter writer=new PrintWriter(new FileOutputStream(patternFile));
    writer.print(itemRepr);
    writer.close();
    System.out.println("Pattern not found, file " + patternName + " created.");
    LocalFileSystem.getInstance().refreshAndFindFileByIoFile(patternFile);
  }
  File graFile=new File(FileUtil.getTempDirectory() + File.separator + rootDir+ File.separator+ itemName);
  PrintWriter writer=new PrintWriter(new FileOutputStream(graFile));
  writer.print(itemRepr);
  writer.close();
  LocalFileSystem.getInstance().refreshAndFindFileByIoFile(graFile);
  d.analyze();
  d.relax();
  itemRepr=d.resultString();
  itemName=className + ".1.items";
  patternName=PathManagerEx.getTestDataPath() + getTestRoot() + getTestName(true)+ "/after/"+ itemName;
  patternFile=new File(patternName);
  if (!patternFile.exists()) {
    writer=new PrintWriter(new FileOutputStream(patternFile));
    writer.print(itemRepr);
    writer.close();
    System.out.println("Pattern not found, file " + patternName + " created.");
    LocalFileSystem.getInstance().refreshAndFindFileByIoFile(patternFile);
  }
  graFile=new File(FileUtil.getTempDirectory() + File.separator + rootDir+ File.separator+ itemName);
  writer=new PrintWriter(new FileOutputStream(graFile));
  writer.print(itemRepr);
  writer.close();
  LocalFileSystem.getInstance().refreshAndFindFileByIoFile(graFile);
  FileDocumentManager.getInstance().saveAllDocuments();
}
