{
  int lineStart=position.getLine();
  VirtualFile file=position.getFile();
  int linesEnd=lineStart;
  if (editor != null) {
    FoldRegion region=FoldingUtil.findFoldRegionStartingAtLine(editor,lineStart);
    if (region != null && !region.isExpanded()) {
      linesEnd=region.getDocument().getLineNumber(region.getEndOffset());
    }
  }
  final XBreakpointManager breakpointManager=XDebuggerManager.getInstance(project).getBreakpointManager();
  XLineBreakpointType<?>[] lineTypes=XDebuggerUtil.getInstance().getLineBreakpointTypes();
  XLineBreakpointType<?> typeWinner=null;
  int lineWinner=-1;
  for (int line=lineStart; line <= linesEnd; line++) {
    for (    XLineBreakpointType<?> type : lineTypes) {
      final XLineBreakpoint<? extends XBreakpointProperties> breakpoint=breakpointManager.findBreakpointAtLine(type,file,line);
      if (breakpoint != null && temporary && !breakpoint.isTemporary()) {
        breakpoint.setTemporary(true);
      }
 else       if (breakpoint != null) {
        typeWinner=type;
        lineWinner=line;
        break;
      }
    }
    XLineBreakpointType<?> breakpointType=XLineBreakpointResolverTypeExtension.INSTANCE.resolveBreakpointType(project,file,line);
    if (breakpointType != null) {
      typeWinner=breakpointType;
      lineWinner=line;
    }
    if (typeWinner != null) {
      break;
    }
  }
  if (typeWinner != null) {
    XSourcePosition winPosition=(lineStart == lineWinner) ? position : XSourcePositionImpl.create(file,lineWinner);
    if (winPosition != null) {
      AsyncResult<XLineBreakpoint> res=XDebuggerUtilImpl.toggleAndReturnLineBreakpoint(project,typeWinner,winPosition,temporary,editor);
      if (editor != null && lineStart != lineWinner) {
        int offset=editor.getDocument().getLineStartOffset(lineWinner);
        ExpandRegionAction.expandRegionAtOffset(project,editor,offset);
        if (moveCaret) {
          editor.getCaretModel().moveToOffset(offset);
        }
      }
      return res;
    }
  }
  return AsyncResult.rejected();
}
