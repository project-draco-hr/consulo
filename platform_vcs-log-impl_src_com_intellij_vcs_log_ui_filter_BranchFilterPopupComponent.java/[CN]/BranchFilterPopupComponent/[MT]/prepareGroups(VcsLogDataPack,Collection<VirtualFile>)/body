{
  Groups filteredGroups=new Groups();
  Collection<VcsRef> allRefs=dataPack.getRefs().getBranches();
  for (  Map.Entry<VirtualFile,Collection<VcsRef>> entry : VcsLogUtil.groupRefsByRoot(allRefs).entrySet()) {
    VirtualFile root=entry.getKey();
    if (visibleRoots != null && !visibleRoots.contains(root))     continue;
    Collection<VcsRef> refs=entry.getValue();
    VcsLogProvider provider=dataPack.getLogProviders().get(root);
    VcsLogRefManager refManager=provider.getReferenceManager();
    List<RefGroup> refGroups=refManager.group(refs);
    orderRefGroups(refGroups,filteredGroups);
  }
  return filteredGroups;
}
