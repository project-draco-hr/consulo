{
  if (virtualFile == null || virtualFile instanceof LightVirtualFile)   return;
  ApplicationManager.getApplication().assertIsDispatchThread();
  if (myProject.isDisposed() || myLineStatusTrackers == null)   return;
  final FileStatusManager statusManager=FileStatusManager.getInstance(myProject);
  if (statusManager == null)   return;
  final FileStatus status=statusManager.getStatus(virtualFile);
synchronized (TRACKERS_LOCK) {
    if (myLineStatusTrackers.containsKey(document))     return;
    if (status == FileStatus.NOT_CHANGED || status == FileStatus.ADDED || status == FileStatus.UNKNOWN || status == FileStatus.IGNORED) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("installTracker() for file " + virtualFile.getPath() + " failed: status="+ status);
      }
      return;
    }
    AbstractVcs activeVcs=myVcsManager.getVcsFor(virtualFile);
    if (activeVcs == null) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("installTracker() for file " + virtualFile.getPath() + " failed: no active VCS");
      }
      return;
    }
    if (!virtualFile.isInLocalFileSystem())     return;
    if (System.getProperty(IGNORE_CHANGEMARKERS_KEY) != null)     return;
    final Alarm alarm;
    if (myLineStatusUpdateAlarms.containsKey(document)) {
      alarm=myLineStatusUpdateAlarms.get(document);
      alarm.cancelAllRequests();
    }
 else {
      alarm=new Alarm(Alarm.ThreadToUse.SHARED_THREAD);
      myLineStatusUpdateAlarms.put(document,alarm);
    }
    final LineStatusTracker tracker=createTrackerForDocument(document,virtualFile);
    alarm.addRequest(new Runnable(){
      public void run(){
        try {
          alarm.cancelAllRequests();
          if (!virtualFile.isValid()) {
            if (LOG.isDebugEnabled()) {
              LOG.debug("installTracker() for file " + virtualFile.getPath() + " failed: virtual file not valid");
            }
            return;
          }
          final String lastUpToDateContent=myStatusProvider.getBaseVersionContent(virtualFile);
          if (lastUpToDateContent == null) {
            if (LOG.isDebugEnabled()) {
              LOG.debug("installTracker() for file " + virtualFile.getPath() + " failed: no up to date content");
            }
            return;
          }
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            public void run(){
              if (!myProject.isDisposed()) {
                ApplicationManager.getApplication().runWriteAction(new Runnable(){
                  public void run(){
                    if (LOG.isDebugEnabled()) {
                      LOG.debug("initializing tracker for file " + virtualFile.getPath());
                    }
synchronized (TRACKERS_LOCK) {
                      tracker.initialize(lastUpToDateContent);
                    }
                  }
                }
);
              }
            }
          }
);
        }
  finally {
          myLineStatusUpdateAlarms.remove(document);
        }
      }
    }
,10);
  }
}
