{
  if (useNativeMacChooser(descriptor)) {
    descriptor.putUserData(MacFileChooserDialog.NATIVE_MAC_FILE_CHOOSER_ENABLED,Boolean.TRUE);
  }
  final FileChooserFactory factory=FileChooserFactory.getInstance();
  final FileChooserDialog dialog=parent != null ? factory.createFileChooser(descriptor,parent) : factory.createFileChooser(descriptor,project);
  if (dialog instanceof MacFileChooserDialog) {
    ((MacFileChooserDialog)dialog).chooseWithSheet(toSelect,project,new MacFileChooserDialog.MacFileChooserCallback(){
      public void onChosen(      @NotNull final VirtualFile[] files){
        callback.consume(files);
      }
    }
);
  }
 else {
    final VirtualFile[] files=dialog.choose(toSelect,project);
    callback.consume(files);
  }
}
