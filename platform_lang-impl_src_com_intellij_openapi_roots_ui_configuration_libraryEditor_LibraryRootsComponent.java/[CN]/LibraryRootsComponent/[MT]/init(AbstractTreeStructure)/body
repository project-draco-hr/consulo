{
  myTree=new Tree(new DefaultTreeModel(new DefaultMutableTreeNode()));
  myTree.setRootVisible(false);
  myTree.setShowsRootHandles(true);
  new LibraryRootsTreeSpeedSearch(myTree);
  myTree.setCellRenderer(new LibraryTreeRenderer());
  myTreeBuilder=new LibraryTableTreeBuilder(myTree,(DefaultTreeModel)myTree.getModel(),treeStructure);
  myTreePanel.setLayout(new BorderLayout());
  ToolbarDecorator toolbarDecorator=ToolbarDecorator.createDecorator(myTree).disableUpDownActions().setRemoveActionName(ProjectBundle.message("library.remove.action")).disableRemoveAction();
  toolbarDecorator.setPanelBorder(new CustomLineBorder(1,0,0,0));
  final List<AttachRootButtonDescriptor> popupItems=new ArrayList<AttachRootButtonDescriptor>();
  for (  AttachRootButtonDescriptor descriptor : myDescriptor.createAttachButtons()) {
    Icon icon=descriptor.getToolbarIcon();
    if (icon != null) {
      AttachItemAction action=new AttachItemAction(descriptor,descriptor.getButtonText(),icon);
      toolbarDecorator.addExtraAction(AnActionButton.fromAction(action));
    }
 else {
      popupItems.add(descriptor);
    }
  }
  myAddExcludedRootActionButton=new AddExcludedRootActionButton();
  toolbarDecorator.addExtraAction(myAddExcludedRootActionButton);
  toolbarDecorator.addExtraAction(new AnActionButton("Remove",IconUtil.getRemoveIcon()){
    @Override public void actionPerformed(    AnActionEvent e){
      final Object[] selectedElements=getSelectedElements();
      if (selectedElements.length == 0) {
        return;
      }
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          for (          Object selectedElement : selectedElements) {
            if (selectedElement instanceof ItemElement) {
              final ItemElement itemElement=(ItemElement)selectedElement;
              getLibraryEditor().removeRoot(itemElement.getUrl(),itemElement.getRootType());
            }
 else             if (selectedElement instanceof OrderRootTypeElement) {
              final OrderRootType rootType=((OrderRootTypeElement)selectedElement).getOrderRootType();
              final String[] urls=getLibraryEditor().getUrls(rootType);
              for (              String url : urls) {
                getLibraryEditor().removeRoot(url,rootType);
              }
            }
 else             if (selectedElement instanceof ExcludedRootElement) {
              getLibraryEditor().removeExcludedRoot(((ExcludedRootElement)selectedElement).getUrl());
            }
          }
        }
      }
);
      libraryChanged(true);
    }
    @Override public void updateButton(    AnActionEvent e){
      super.updateButton(e);
      Object[] elements=getSelectedElements();
      Presentation presentation=e.getPresentation();
      if (ContainerUtil.and(elements,new FilteringIterator.InstanceOf<ExcludedRootElement>(ExcludedRootElement.class))) {
        presentation.setText("Cancel Exclusion");
      }
 else {
        presentation.setText(getTemplatePresentation().getText());
      }
    }
    @Override public ShortcutSet getShortcut(){
      return CommonShortcuts.DELETE;
    }
  }
);
  toolbarDecorator.setAddAction(new AnActionButtonRunnable(){
    @Override public void run(    AnActionButton button){
      if (popupItems.isEmpty()) {
        new AttachFilesAction(myDescriptor.getAttachFilesActionName()).actionPerformed(null);
        return;
      }
      List<AnAction> actions=new ArrayList<AnAction>();
      actions.add(new AttachFilesAction(myDescriptor.getAttachFilesActionName()));
      for (      AttachRootButtonDescriptor descriptor : popupItems) {
        actions.add(new AttachItemAction(descriptor,descriptor.getButtonText(),null));
      }
      final DefaultActionGroup group=new DefaultActionGroup(actions);
      JBPopupFactory.getInstance().createActionGroupPopup(null,group,DataManager.getInstance().getDataContext(button.getContextComponent()),JBPopupFactory.ActionSelectionAid.SPEEDSEARCH,true).show(button.getPreferredPopupPoint());
    }
  }
);
  myTreePanel.add(toolbarDecorator.createPanel(),BorderLayout.CENTER);
  Disposer.register(this,myTreeBuilder);
}
