{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  final Set<PsiElement> skipParentsSet=new THashSet<PsiElement>();
  final Set<HighlightInfo> gotHighlights=new THashSet<HighlightInfo>();
  final List<HighlightVisitor> visitors=new ArrayList<HighlightVisitor>();
  for (  HighlightVisitor visitor : myHighlightVisitors) {
    if (visitor.suitableForFile(myFile))     visitors.add(visitor);
  }
  final boolean isAntFile=CodeInsightUtil.isAntFile(myFile);
  final HighlightInfoHolder holder=createInfoHolder();
  holder.setWritable(true);
  ProgressManager progressManager=ProgressManager.getInstance();
  setProgressLimit((long)elements.size() * visitors.size());
  int chunkSize=Math.max(1,elements.size() / 100);
  int nextLimit=chunkSize;
  for (int i=0; i < elements.size(); i++) {
    PsiElement element=elements.get(i);
    progressManager.checkCanceled();
    if (element != myFile && skipParentsSet.size() > 0 && element.getFirstChild() != null && skipParentsSet.remove(element)) {
      skipParentsSet.add(element.getParent());
      continue;
    }
    if (element instanceof PsiErrorElement) {
      myHasErrorElement=true;
    }
    holder.clear();
    for (int j=0; j < visitors.size(); j++) {
      HighlightVisitor visitor=visitors.get(j);
      visitor.visit(element,holder);
    }
    if (i == nextLimit) {
      advanceProgress(chunkSize * visitors.size());
      nextLimit=i + chunkSize;
    }
    for (int j=0; j < holder.size(); j++) {
      HighlightInfo info=holder.get(j);
      if (!gotHighlights.add(info))       continue;
      if (!isAntFile && info.getSeverity() == HighlightSeverity.ERROR) {
        skipParentsSet.add(element.getParent());
      }
    }
  }
  return gotHighlights;
}
