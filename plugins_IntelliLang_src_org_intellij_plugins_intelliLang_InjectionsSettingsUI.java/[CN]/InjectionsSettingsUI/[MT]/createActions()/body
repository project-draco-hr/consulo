{
  final Consumer<BaseInjection> consumer=new Consumer<BaseInjection>(){
    public void consume(    final BaseInjection injection){
      addInjection(injection);
    }
  }
;
  final Factory<BaseInjection> producer=new NullableFactory<BaseInjection>(){
    public BaseInjection create(){
      final InjInfo info=getSelectedInjection();
      return info == null ? null : info.injection;
    }
  }
;
  for (  LanguageInjectionSupport support : InjectorUtils.getActiveInjectionSupports()) {
    ContainerUtil.addAll(myAddActions,support.createAddActions(myProject,consumer));
    final AnAction action=support.createEditAction(myProject,producer);
    myEditActions.put(support.getId(),action == null ? AbstractLanguageInjectionSupport.createDefaultEditAction(myProject,producer) : action);
    mySupports.put(support.getId(),support);
  }
  Collections.sort(myAddActions,new Comparator<AnAction>(){
    public int compare(    final AnAction o1,    final AnAction o2){
      return Comparing.compare(o1.getTemplatePresentation().getText(),o2.getTemplatePresentation().getText());
    }
  }
);
  final DefaultActionGroup group=new DefaultActionGroup();
  final AnAction addAction=new AnAction("Add","Add",IconUtil.getAddIcon()){
    @Override public void update(    final AnActionEvent e){
      e.getPresentation().setEnabled(!myAddActions.isEmpty());
    }
    @Override public void actionPerformed(    final AnActionEvent e){
      performAdd(e);
    }
  }
;
  final AnAction removeAction=new AnAction("Remove","Remove",PlatformIcons.DELETE_ICON){
    @Override public void update(    final AnActionEvent e){
      boolean enabled=false;
      for (      InjInfo info : getSelectedInjections()) {
        if (!info.bundled) {
          enabled=true;
          break;
        }
      }
      e.getPresentation().setEnabled(enabled);
    }
    @Override public void actionPerformed(    final AnActionEvent e){
      performRemove();
    }
  }
;
  final AnAction editAction=new AnAction("Edit","Edit",PlatformIcons.PROPERTIES_ICON){
    @Override public void update(    final AnActionEvent e){
      final AnAction action=getEditAction();
      e.getPresentation().setEnabled(action != null);
      if (action != null)       action.update(e);
    }
    @Override public void actionPerformed(    final AnActionEvent e){
      performEditAction(e);
    }
  }
;
  final AnAction copyAction=new AnAction("Duplicate","Duplicate",PlatformIcons.COPY_ICON){
    @Override public void update(    final AnActionEvent e){
      final AnAction action=getEditAction();
      e.getPresentation().setEnabled(action != null);
      if (action != null)       action.update(e);
    }
    @Override public void actionPerformed(    final AnActionEvent e){
      final InjInfo injection=getSelectedInjection();
      if (injection != null) {
        addInjection(injection.injection.copy());
      }
    }
  }
;
  group.add(addAction);
  group.add(removeAction);
  group.add(copyAction);
  group.add(editAction);
  addAction.registerCustomShortcutSet(CommonShortcuts.INSERT,myInjectionsTable);
  removeAction.registerCustomShortcutSet(CommonShortcuts.DELETE,myInjectionsTable);
  editAction.registerCustomShortcutSet(CommonShortcuts.ENTER,myInjectionsTable);
  group.addSeparator();
  group.add(new AnAction("Enable Selected Injections","Enable Selected Injections",PlatformIcons.SELECT_ALL_ICON){
    @Override public void actionPerformed(    final AnActionEvent e){
      performSelectedInjectionsEnabled(true);
    }
  }
);
  group.add(new AnAction("Disable Selected Injections","Disable Selected Injections",PlatformIcons.UNSELECT_ALL_ICON){
    @Override public void actionPerformed(    final AnActionEvent e){
      performSelectedInjectionsEnabled(false);
    }
  }
);
  new AnAction("Toggle"){
    @Override public void actionPerformed(    final AnActionEvent e){
      performToggleAction();
    }
  }
.registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke(KeyEvent.VK_SPACE,0)),myInjectionsTable);
  if (myInfos.length > 1) {
    group.addSeparator();
    final AnAction shareAction=new AnAction("Make Global",null,PlatformIcons.IMPORT_ICON){
      @Override public void actionPerformed(      final AnActionEvent e){
        final List<InjInfo> injections=getSelectedInjections();
        final CfgInfo cfg=getTargetCfgInfo(injections);
        if (cfg == null)         return;
        for (        InjInfo info : injections) {
          if (info.cfgInfo == cfg)           continue;
          if (info.bundled)           continue;
          info.cfgInfo.injectionInfos.remove(info);
          cfg.addInjection(info.injection);
        }
        final int[] selectedRows=myInjectionsTable.getSelectedRows();
        myInjectionsTable.getListTableModel().setItems(getInjInfoList(myInfos));
        TableUtil.selectRows(myInjectionsTable,selectedRows);
      }
      @Override public void update(      final AnActionEvent e){
        final CfgInfo cfg=getTargetCfgInfo(getSelectedInjections());
        e.getPresentation().setEnabled(cfg != null);
        e.getPresentation().setText(cfg == getDefaultCfgInfo() ? "Make Global" : "Move to Project");
        super.update(e);
      }
      @Nullable private CfgInfo getTargetCfgInfo(      final List<InjInfo> injections){
        CfgInfo cfg=null;
        for (        InjInfo info : injections) {
          if (info.bundled) {
            continue;
          }
          if (cfg == null)           cfg=info.cfgInfo;
 else           if (cfg != info.cfgInfo)           return info.cfgInfo;
        }
        if (cfg == null)         return cfg;
        for (        CfgInfo info : myInfos) {
          if (info != cfg)           return info;
        }
        throw new AssertionError();
      }
    }
;
    shareAction.registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke(KeyEvent.VK_SPACE,InputEvent.SHIFT_DOWN_MASK)),myInjectionsTable);
    group.add(shareAction);
  }
  group.addSeparator();
  group.add(new AnAction("Import","Import",AllIcons.Actions.Install){
    @Override public void actionPerformed(    final AnActionEvent e){
      doImportAction(e.getDataContext());
      updateCountLabel();
    }
  }
);
  group.add(new AnAction("Export","Export",AllIcons.Actions.Export){
    @Override public void actionPerformed(    final AnActionEvent e){
      final List<BaseInjection> injections=getInjectionList(getSelectedInjections());
      final VirtualFileWrapper wrapper=FileChooserFactory.getInstance().createSaveFileDialog(new FileSaverDescriptor("Export Selected Injections to File...","","xml"),myProject).save(null,null);
      if (wrapper == null)       return;
      final Configuration configuration=new Configuration();
      configuration.setInjections(injections);
      final Document document=new Document(configuration.getState());
      try {
        JDOMUtil.writeDocument(document,wrapper.getFile(),"\n");
      }
 catch (      IOException ex) {
        final String msg=ex.getLocalizedMessage();
        Messages.showErrorDialog(myProject,msg != null && msg.length() > 0 ? msg : ex.toString(),"Export failed");
      }
    }
    @Override public void update(    final AnActionEvent e){
      e.getPresentation().setEnabled(!getSelectedInjections().isEmpty());
    }
  }
);
  return group;
}
