{
  if (ApplicationManagerEx.getApplicationEx().isDoNotSave())   return;
  if (mySavingInProgress.compareAndSet(false,true)) {
    try {
      if (!isDefault()) {
        final IProjectStore stateStore=getStateStore();
        if (stateStore.getStorageScheme().equals(StorageScheme.DIRECTORY_BASED)) {
          final VirtualFile baseDir=stateStore.getProjectBaseDir();
          if (baseDir != null && baseDir.isValid()) {
            if (myOldName != null && !myOldName.equals(getName())) {
              final VirtualFile ideaDir=baseDir.findChild(DIRECTORY_STORE_FOLDER);
              if (ideaDir != null && ideaDir.isValid() && ideaDir.isDirectory()) {
                final File nameFile=new File(ideaDir.getPath(),".name");
                try {
                  FileUtil.writeToFile(nameFile,new String(getName()).getBytes(),false);
                  myOldName=null;
                }
 catch (                IOException e) {
                  LOG.info("Unable to store project name to: " + nameFile.getPath());
                }
              }
            }
          }
        }
      }
      doSave();
    }
 catch (    IComponentStore.SaveCancelledException e) {
      LOG.info(e);
    }
catch (    PluginException e) {
      PluginManager.disablePlugin(e.getPluginId().getIdString());
      Notifications.Bus.notify(new Notification(PLUGIN_SETTINGS_ERROR,"Unable to save plugin settings!","<p>The plugin <i>" + e.getPluginId() + "</i> failed to save settings and has been disabled. Please restart"+ ApplicationNamesInfo.getInstance().getFullProductName()+ "</p>"+ (ApplicationManagerEx.getApplicationEx().isInternal() ? "<p>" + StringUtil.getThrowableText(e) + "</p>" : ""),NotificationType.ERROR),NotificationDisplayType.BALLOON,this);
      LOG.info("Unable to save plugin settings",e);
    }
catch (    IOException e) {
      MessagesEx.error(this,ProjectBundle.message("project.save.error",ApplicationManagerEx.getApplicationEx().isInternal() ? StringUtil.getThrowableText(e) : e.getMessage())).showLater();
      LOG.info("Error saving project",e);
    }
 finally {
      mySavingInProgress.set(false);
      ApplicationManager.getApplication().getMessageBus().syncPublisher(ProjectSaved.TOPIC).saved(this);
    }
  }
}
