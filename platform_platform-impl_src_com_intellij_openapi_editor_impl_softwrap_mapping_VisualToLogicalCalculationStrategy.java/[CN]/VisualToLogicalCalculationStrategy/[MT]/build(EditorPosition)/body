{
  int linesDiff=myTargetVisual.line - position.visualLine;
  if (linesDiff <= 0) {
    int columnsDiff=myTargetVisual.column - position.visualColumn;
    position.logicalColumn+=columnsDiff;
    position.offset+=columnsDiff;
  }
 else {
    position.logicalLine+=linesDiff;
    position.visualLine+=linesDiff;
    Document document=myEditor.getDocument();
    if (document.getLineCount() <= position.logicalLine) {
      position.offset=Math.max(0,document.getTextLength() - 1);
    }
 else {
      int startLineOffset=document.getLineStartOffset(position.logicalLine);
      position.offset=startLineOffset + myTargetVisual.column;
    }
    position.logicalColumn=myTargetVisual.column;
  }
  position.visualColumn=myTargetVisual.column;
  return position.buildLogicalPosition();
}
