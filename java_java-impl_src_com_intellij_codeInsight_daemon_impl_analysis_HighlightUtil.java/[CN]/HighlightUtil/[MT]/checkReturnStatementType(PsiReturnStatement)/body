{
  if (suppressed(Kind.RETURN_STATEMENT,statement))   return null;
  PsiMethod method=null;
  PsiLambdaExpression lambda=null;
  PsiElement parent=statement.getParent();
  while (true) {
    if (parent instanceof PsiFile)     break;
    if (parent instanceof PsiClassInitializer)     break;
    if (parent instanceof PsiLambdaExpression) {
      lambda=(PsiLambdaExpression)parent;
      break;
    }
    if (parent instanceof PsiMethod) {
      method=(PsiMethod)parent;
      break;
    }
    parent=parent.getParent();
  }
  String description;
  int navigationShift=0;
  HighlightInfo errorResult=null;
  if (method == null && lambda != null) {
  }
 else   if (method == null && !(parent instanceof JspFile)) {
    description=JavaErrorMessages.message("return.outside.method");
    errorResult=HighlightInfo.createHighlightInfo(HighlightInfoType.ERROR,statement,description);
  }
 else {
    PsiType returnType=method != null ? method.getReturnType() : null;
    boolean isMethodVoid=returnType == null || PsiType.VOID.equals(returnType);
    final PsiExpression returnValue=statement.getReturnValue();
    if (returnValue != null) {
      PsiType valueType=returnValue.getType();
      if (isMethodVoid) {
        description=JavaErrorMessages.message("return.from.void.method");
        errorResult=HighlightInfo.createHighlightInfo(HighlightInfoType.ERROR,statement,description);
        if (valueType != null) {
          IntentionAction fix=QUICK_FIX_FACTORY.createMethodReturnFix(method,valueType,true);
          QuickFixAction.registerQuickFixAction(errorResult,fix);
        }
      }
 else {
        errorResult=checkAssignability(returnType,valueType,returnValue,statement);
        if (errorResult != null && valueType != null) {
          IntentionAction fix=QUICK_FIX_FACTORY.createMethodReturnFix(method,valueType,true);
          QuickFixAction.registerQuickFixAction(errorResult,fix);
          ChangeParameterClassFix.registerQuickFixAction(returnType,valueType,errorResult);
          if (returnType instanceof PsiArrayType && TypeConversionUtil.isAssignable(((PsiArrayType)returnType).getComponentType(),valueType)) {
            QuickFixAction.registerQuickFixAction(errorResult,new SurroundWithArrayFix(null){
              @Override protected PsiExpression getExpression(              final PsiElement element){
                return returnValue.isValid() ? returnValue : null;
              }
            }
);
          }
        }
      }
      navigationShift=returnValue.getStartOffsetInParent();
    }
 else {
      if (!isMethodVoid) {
        description=JavaErrorMessages.message("missing.return.value");
        errorResult=HighlightInfo.createHighlightInfo(HighlightInfoType.ERROR,statement,description);
        IntentionAction fix=QUICK_FIX_FACTORY.createMethodReturnFix(method,PsiType.VOID,true);
        QuickFixAction.registerQuickFixAction(errorResult,fix);
        navigationShift=PsiKeyword.RETURN.length();
      }
    }
  }
  if (errorResult != null) {
    errorResult.navigationShift=navigationShift;
  }
  return errorResult;
}
