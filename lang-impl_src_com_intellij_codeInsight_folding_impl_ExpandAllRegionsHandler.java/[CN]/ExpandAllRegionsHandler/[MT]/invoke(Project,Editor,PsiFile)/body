{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  CodeFoldingManager foldingManager=CodeFoldingManager.getInstance(project);
  foldingManager.updateFoldRegions(editor);
  final FoldRegion[] regions=editor.getFoldingModel().getAllFoldRegions();
  Runnable processor=new Runnable(){
    public void run(){
      boolean anythingDone=false;
      for (      FoldRegion region : regions) {
        PsiElement element=EditorFoldingInfo.get(editor).getPsiElement(region);
        if (!region.isExpanded() && (element == null || !FoldingPolicy.isCollapseByDefault(element))) {
          region.setExpanded(true);
          anythingDone=true;
        }
      }
      if (!anythingDone) {
        for (        FoldRegion region : regions) {
          region.setExpanded(true);
        }
      }
    }
  }
;
  editor.getFoldingModel().runBatchFoldingOperation(processor);
}
