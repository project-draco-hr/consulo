{
  final Module module=facet.getModule();
  try {
    final File manifestFile=AndroidJpsUtil.getManifestFileForCompilationPath(facet);
    if (manifestFile == null) {
      context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,AndroidJpsBundle.message("android.jps.errors.manifest.not.found",module.getName())));
      return false;
    }
    final File assetsDir=facet.getAssetsDir();
    final File outputDir=AndroidJpsUtil.getOutputDirectoryForPackagedFiles(context.getProjectPaths(),module);
    if (outputDir == null) {
      context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,AndroidJpsBundle.message("android.jps.errors.output.dir.not.specified",module.getName())));
      return false;
    }
    final Pair<AndroidSdk,IAndroidTarget> pair=AndroidJpsUtil.getAndroidPlatform(module,context,BUILDER_NAME);
    if (pair == null) {
      return false;
    }
    final IAndroidTarget target=pair.getSecond();
    final String outputFilePath=getOutputFile(module,outputDir).getPath();
    final String assetsDirPath=assetsDir != null ? assetsDir.getPath() : null;
    final String[] resourceDirPaths=AndroidJpsUtil.collectResourceDirs(facet);
    if (resourceDirPaths.length == 0) {
      return true;
    }
    final List<String> assetDirPaths=assetsDirPath != null ? Arrays.asList(assetsDirPath) : Collections.<String>emptyList();
    final AndroidResourcesPackagingState newState=new AndroidResourcesPackagingState(Arrays.asList(resourceDirPaths),assetDirPaths);
    final boolean releaseBuild=AndroidJpsUtil.isReleaseBuild(context);
    final AndroidResourcesPackagingStateStorage storage=releaseBuild ? releaseStorage : devStorage;
    final AndroidResourcesPackagingState oldState=storage.getState(module.getName());
    if (oldState == null || !oldState.equalsTo(newState)) {
      if (!doPackageResources(context,manifestFile,target,resourceDirPaths,assetsDirPath,outputFilePath,releaseBuild)) {
        storage.update(module.getName(),null);
        return false;
      }
      storage.update(module.getName(),newState);
    }
    return true;
  }
 catch (  IOException e) {
    AndroidJpsUtil.reportExceptionError(context,null,e,BUILDER_NAME);
    return false;
  }
}
