{
  boolean success=true;
  final File dataStorageRoot=context.getDataManager().getDataStorageRoot();
  AndroidResourcesPackagingStateStorage devStorage=null;
  AndroidResourcesPackagingStateStorage releaseStorage=null;
  try {
    devStorage=new AndroidResourcesPackagingStateStorage(dataStorageRoot,false);
    releaseStorage=new AndroidResourcesPackagingStateStorage(dataStorageRoot,true);
    for (    Module module : chunk.getModules()) {
      final AndroidFacet facet=AndroidJpsUtil.getFacet(module);
      if (facet == null || facet.isLibrary()) {
        continue;
      }
      context.processMessage(new ProgressMessage("Packaging module " + module.getName()));
      if (!packageResources(facet,context,devStorage,releaseStorage)) {
        success=false;
      }
    }
  }
  finally {
    if (devStorage != null) {
      devStorage.close();
    }
    if (releaseStorage != null) {
      releaseStorage.close();
    }
  }
  return success ? ExitCode.OK : ExitCode.ABORT;
}
