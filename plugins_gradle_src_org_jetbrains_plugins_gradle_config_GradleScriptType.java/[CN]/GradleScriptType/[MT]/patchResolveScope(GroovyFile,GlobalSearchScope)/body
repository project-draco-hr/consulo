{
  final Module module=ModuleUtilCore.findModuleForPsiElement(file);
  final GradleInstallationManager libraryManager=ServiceManager.getService(GradleInstallationManager.class);
  if (module != null) {
    if (libraryManager.getGradleHome(module) != null) {
      return baseScope;
    }
  }
  final Collection<VirtualFile> files=libraryManager.getClassRoots(file.getProject());
  if (files == null || files.isEmpty()) {
    return baseScope;
  }
  GlobalSearchScope result=baseScope;
  for (  final VirtualFile root : files) {
    result=result.uniteWith(new NonClasspathDirectoryScope(root));
  }
  return result;
}
