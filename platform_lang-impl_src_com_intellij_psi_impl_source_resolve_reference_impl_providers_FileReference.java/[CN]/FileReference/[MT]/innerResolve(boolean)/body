{
  final String referenceText=getText();
  final TextRange range=getRangeInElement();
  if (range.isEmpty()) {
    final PsiElement element=getElement();
    final String s=element.getText();
    if (s.length() > range.getEndOffset() && s.charAt(range.getEndOffset()) == '#') {
      return new ResolveResult[]{new PsiElementResolveResult(element.getContainingFile())};
    }
  }
  final Collection<PsiFileSystemItem> contexts=getContexts();
  final Collection<ResolveResult> result=new HashSet<ResolveResult>(contexts.size());
  for (  final PsiFileSystemItem context : contexts) {
    if (context != null) {
      innerResolveInContext(referenceText,context,result,caseSensitive);
    }
  }
  final int resultCount=result.size();
  return resultCount > 0 ? result.toArray(new ResolveResult[resultCount]) : ResolveResult.EMPTY_ARRAY;
}
