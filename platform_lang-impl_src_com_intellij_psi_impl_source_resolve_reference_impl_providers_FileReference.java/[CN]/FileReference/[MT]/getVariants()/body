{
  final String s=getText();
  if (s != null && s.equals("/")) {
    return ArrayUtil.EMPTY_OBJECT_ARRAY;
  }
  final CommonProcessors.CollectUniquesProcessor<PsiFileSystemItem> collector=new CommonProcessors.CollectUniquesProcessor<PsiFileSystemItem>();
  final PsiElementProcessor<PsiFileSystemItem> processor=new PsiElementProcessor<PsiFileSystemItem>(){
    public boolean execute(    @NotNull PsiFileSystemItem fileSystemItem){
      return new FilteringProcessor<PsiFileSystemItem>(myFileReferenceSet.getReferenceCompletionFilter(),collector).process(getOriginalFile(fileSystemItem));
    }
  }
;
  for (  PsiFileSystemItem context : getContexts()) {
    for (    final PsiElement child : context.getChildren()) {
      if (child instanceof PsiFileSystemItem) {
        processor.execute((PsiFileSystemItem)child);
      }
    }
  }
  final THashSet<PsiElement> set=new THashSet<PsiElement>(collector.getResults(),VARIANTS_HASHING_STRATEGY);
  final PsiElement[] candidates=PsiUtilBase.toPsiElementArray(set);
  final Object[] variants=new Object[candidates.length];
  for (int i=0; i < candidates.length; i++) {
    variants[i]=createLookupItem(candidates[i]);
  }
  if (!myFileReferenceSet.isUrlEncoded()) {
    return variants;
  }
  List<Object> encodedVariants=new ArrayList<Object>(variants.length);
  for (int i=0; i < candidates.length; i++) {
    final PsiElement element=candidates[i];
    if (element instanceof PsiNamedElement) {
      final PsiNamedElement psiElement=(PsiNamedElement)element;
      String name=psiElement.getName();
      final String encoded=encode(name,psiElement);
      if (encoded == null)       continue;
      if (!encoded.equals(name)) {
        final Icon icon=psiElement.getIcon(Iconable.ICON_FLAG_READ_STATUS | Iconable.ICON_FLAG_VISIBILITY);
        LookupElementBuilder item=FileInfoManager.getFileLookupItem(candidates[i],encoded,icon);
        encodedVariants.add(item.setTailText(" (" + name + ")"));
      }
 else {
        encodedVariants.add(variants[i]);
      }
    }
  }
  return ArrayUtil.toObjectArray(encodedVariants);
}
