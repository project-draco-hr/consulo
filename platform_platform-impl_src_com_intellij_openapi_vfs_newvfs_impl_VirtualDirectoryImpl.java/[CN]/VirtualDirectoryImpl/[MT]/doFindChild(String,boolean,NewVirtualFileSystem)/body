{
  if (name.isEmpty()) {
    return null;
  }
  final VirtualFileSystemEntry[] array;
  final Map<String,VirtualFileSystemEntry> map;
  final VirtualFileSystemEntry file;
synchronized (this) {
    array=asArray();
    if (array == null) {
      map=ensureAsMap();
      file=map.get(name);
    }
 else {
      file=null;
      map=null;
    }
  }
  if (array != null) {
    final boolean ignoreCase=!getFileSystem().isCaseSensitive();
    for (    VirtualFileSystemEntry vf : array) {
      if (vf.nameMatches(name,ignoreCase))       return vf;
    }
    return NULL_VIRTUAL_FILE;
  }
  if (file != null)   return file;
  if (ensureCanonicalName) {
    VirtualFile fake=new FakeVirtualFile(this,name);
    name=delegate.getCanonicallyCasedName(fake);
    if (name.isEmpty())     return null;
  }
synchronized (this) {
    int id=PersistentFS.getId(this,name,delegate);
    if (id > 0) {
      VirtualFileSystemEntry lastTry=map.get(name);
      if (lastTry != null)       return lastTry;
      final String shorty=new String(name);
      VirtualFileSystemEntry child=createChild(shorty,id);
      map.put(shorty,child);
      return child;
    }
  }
  return null;
}
