{
  LOG.assertTrue(context.occurrences.length > 0);
  PsiElement anchor=findAnchor(context,settings,context.occurrences,context.scope);
  if (!(anchor instanceof GrStatement)) {
    StringBuilder error=new StringBuilder("scope:");
    error.append(DebugUtil.psiToString(context.scope,true,false));
    error.append("occurrences: ");
    for (    PsiElement occurrence : context.occurrences) {
      error.append(DebugUtil.psiToString(occurrence,true,false));
    }
    LOG.error(error.toString());
  }
  GrStatement anchorElement=(GrStatement)anchor;
  LOG.assertTrue(anchorElement != null);
  PsiElement realContainer=anchorElement.getParent();
  LOG.assertTrue(GroovyRefactoringUtil.isAppropriateContainerForIntroduceVariable(realContainer));
  if (!(realContainer instanceof GrLoopStatement)) {
    if (realContainer instanceof GrStatementOwner) {
      GrStatementOwner block=(GrStatementOwner)realContainer;
      varDecl=(GrVariableDeclaration)block.addStatementBefore(varDecl,anchorElement);
    }
  }
 else {
    String refId=varDecl.getVariables()[0].getName();
    GrBlockStatement newBody;
    final GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(context.project);
    if (anchorElement.equals(context.expression)) {
      newBody=factory.createBlockStatement(varDecl);
    }
 else {
      replaceExpressionOccurrencesInStatement(anchorElement,context.expression,refId,settings.replaceAllOccurrences());
      newBody=factory.createBlockStatement(varDecl,anchorElement);
    }
    varDecl=(GrVariableDeclaration)newBody.getBlock().getStatements()[0];
    GrCodeBlock tempBlock=((GrLoopStatement)realContainer).replaceBody(newBody).getBlock();
    refreshPositionMarker(tempBlock.getStatements()[tempBlock.getStatements().length - 1]);
  }
  return varDecl.getVariables()[0];
}
