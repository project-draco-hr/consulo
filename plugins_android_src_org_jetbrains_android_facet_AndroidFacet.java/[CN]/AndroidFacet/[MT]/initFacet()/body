{
  if (getConfiguration().ADD_ANDROID_LIBRARY && !ApplicationManager.getApplication().isUnitTestMode()) {
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        AndroidPlatform platform=getConfiguration().getAndroidPlatform();
        if (platform != null) {
          final ModifiableRootModel model=ModuleRootManager.getInstance(getModule()).getModifiableModel();
          Library library=platform.getLibrary();
          if (!((LibraryEx)library).isDisposed() && model.findLibraryOrderEntry(library) == null) {
            LibraryOrderEntry entry=model.addLibraryEntry(library);
            entry.setScope(DependencyScope.PROVIDED);
          }
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            public void run(){
              model.commit();
            }
          }
);
        }
      }
    }
);
  }
  StartupManager.getInstance(getModule().getProject()).runWhenProjectIsInitialized(new Runnable(){
    public void run(){
      myListener=new AndroidResourceFilesListener(AndroidFacet.this);
      LocalFileSystem.getInstance().addVirtualFileListener(myListener);
      if (ApplicationManager.getApplication().isUnitTestMode()) {
        return;
      }
      ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
        public void run(){
          Module module=getModule();
          Project project=module.getProject();
          if (project.isDisposed()) {
            return;
          }
          if (getConfiguration().REGENERATE_R_JAVA && AndroidAptCompiler.isToCompileModule(module,getConfiguration())) {
            AndroidCompileUtil.generate(module,new AndroidAptCompiler());
          }
          if (getConfiguration().REGENERATE_JAVA_BY_AIDL) {
            AndroidCompileUtil.generate(module,new AndroidIdlCompiler(project));
          }
        }
      }
);
    }
  }
);
}
