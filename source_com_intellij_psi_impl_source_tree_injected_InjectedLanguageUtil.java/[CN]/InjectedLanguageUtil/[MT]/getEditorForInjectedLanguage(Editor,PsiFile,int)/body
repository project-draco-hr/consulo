{
  if (editor == null || file == null || editor instanceof EditorDelegate)   return editor;
  PsiFile injectedFile=findInjectedPsiAt(file,offset);
  if (injectedFile == null)   return editor;
  Document document=PsiDocumentManager.getInstance(editor.getProject()).getDocument(injectedFile);
  DocumentRange documentRange=(DocumentRange)document;
  SelectionModel selectionModel=editor.getSelectionModel();
  if (selectionModel.hasSelection()) {
    int start=selectionModel.getSelectionStart();
    int end=selectionModel.getSelectionEnd();
    RangeMarker hostRange=documentRange.getTextRange();
    if (end - start == hostRange.getEndOffset() - hostRange.getStartOffset() || !new TextRange(hostRange.getStartOffset(),hostRange.getEndOffset()).contains(new TextRange(start,end))) {
      return editor;
    }
  }
  return EditorDelegate.create(documentRange,(EditorImpl)editor,injectedFile);
}
