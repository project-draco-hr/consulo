{
  for (PsiElement current=element; current != null; current=ResolveUtil.getContext(current)) {
    ParameterizedCachedValue<Places> data=current.getUserData(INJECTED_PSI_KEY);
    if (data != null) {
      Places value=data.getValue(current);
      if (value != null) {
        return value;
      }
    }
    InjectedPsiProvider provider=new InjectedPsiProvider();
    CachedValueProvider.Result<Places> result=provider.compute(current);
    if (result != null) {
      ParameterizedCachedValue<Places> cachedValue=current.getManager().getCachedValuesManager().createParameterizedCachedValue(provider,false);
      ((ParameterizedCachedValueImpl<Places>)cachedValue).setValue(result);
      Places places=result.getValue();
      for (      Place place : places) {
        for (        Pair<PsiLanguageInjectionHost,TextRange> pair : place.getSecond()) {
          PsiLanguageInjectionHost host=pair.getFirst();
          host.putUserData(INJECTED_PSI_KEY,cachedValue);
        }
      }
      current.putUserData(INJECTED_PSI_KEY,cachedValue);
      return places;
    }
    if (!probeUp)     break;
  }
  return null;
}
