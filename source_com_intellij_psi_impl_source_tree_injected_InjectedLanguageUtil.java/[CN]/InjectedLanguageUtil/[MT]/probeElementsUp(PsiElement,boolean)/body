{
  PsiFile hostPsiFile=element.getContainingFile();
  if (hostPsiFile == null)   return null;
  FileViewProvider viewProvider=hostPsiFile.getViewProvider();
  final VirtualFile hostVirtualFile=viewProvider.getVirtualFile();
  final DocumentEx hostDocument=(DocumentEx)viewProvider.getDocument();
  if (hostDocument == null)   return null;
  PsiManager psiManager=viewProvider.getManager();
  final Project project=psiManager.getProject();
  InjectedLanguageManagerImpl injectedManager=InjectedLanguageManagerImpl.getInstanceImpl(project);
  if (injectedManager == null)   return null;
  for (PsiElement current=element; current != null; current=ResolveUtil.getContext(current)) {
    if ("EL".equals(current.getLanguage().getID()))     break;
    ParameterizedCachedValue<Places> data=current.getUserData(INJECTED_PSI_KEY);
    if (data != null) {
      Places value=data.getValue(current);
      if (value != null) {
        return value;
      }
    }
    Places places=InjectedPsiProvider.doCompute(current,hostVirtualFile,hostDocument,project,injectedManager,psiManager);
    if (places != null) {
      ParameterizedCachedValue<Places> cachedValue=psiManager.getCachedValuesManager().createParameterizedCachedValue(INJECTED_PSI_PROVIDER,false);
      CachedValueProvider.Result<Places> result=new CachedValueProvider.Result<Places>(places,PsiModificationTracker.MODIFICATION_COUNT,hostDocument);
      ((ParameterizedCachedValueImpl<Places>)cachedValue).setValue(result);
      for (      Place place : places) {
        for (        PsiLanguageInjectionHost.Shred pair : place.myShreds) {
          pair.host.putUserData(INJECTED_PSI_KEY,cachedValue);
        }
      }
      current.putUserData(INJECTED_PSI_KEY,cachedValue);
      return places;
    }
    if (!probeUp)     break;
  }
  return null;
}
