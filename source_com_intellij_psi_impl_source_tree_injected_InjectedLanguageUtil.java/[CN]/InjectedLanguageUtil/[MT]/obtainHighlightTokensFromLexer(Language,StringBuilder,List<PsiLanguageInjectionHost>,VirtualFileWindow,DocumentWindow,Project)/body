{
  List<Trinity<IElementType,PsiLanguageInjectionHost,TextRange>> tokens=new ArrayList<Trinity<IElementType,PsiLanguageInjectionHost,TextRange>>(10);
  SyntaxHighlighter syntaxHighlighter=language.getSyntaxHighlighter(project,virtualFile);
  Lexer lexer=syntaxHighlighter.getHighlightingLexer();
  lexer.start(outChars,0,outChars.length(),0);
  for (IElementType tokenType=lexer.getTokenType(); tokenType != null; lexer.advance(), tokenType=lexer.getTokenType()) {
    TextRange textRange=new TextRange(lexer.getTokenStart(),lexer.getTokenEnd());
    TextRange editable=documentWindow.intersectWithEditable(textRange);
    if (editable == null || editable.getLength() == 0)     continue;
    int i=documentWindow.getHostNumber(textRange.getStartOffset());
    if (i == -1)     continue;
    PsiLanguageInjectionHost host=injectionHosts.get(i);
    TextRange hostRange=documentWindow.injectedToHost(editable);
    TextRange rangeInHost=hostRange.shiftRight(-host.getTextRange().getStartOffset());
    tokens.add(Trinity.create(tokenType,host,rangeInHost));
  }
  return tokens;
}
