{
  final Map<LeafElement,String> newTexts=new THashMap<LeafElement,String>();
  ((TreeElement)parsedNode).acceptTree(new RecursiveTreeElementVisitor(){
    int currentSourceOffset;
    protected boolean visitNode(    TreeElement element){
      return true;
    }
    public void visitLeaf(    LeafElement leaf){
      TextRange range=leaf.getTextRange();
      int offsetInSource=currentSourceOffset + prefixLength;
      int endOffsetInSource=literalTextEscaper.getOffsetInSource(range.getEndOffset()) + prefixLength;
      String sourceSubText=physicalText.substring(offsetInSource,endOffsetInSource);
      String leafText=leaf.getText();
      if (!Comparing.strEqual(leafText,sourceSubText)) {
        newTexts.put(leaf,sourceSubText);
      }
      currentSourceOffset=endOffsetInSource;
    }
  }
);
  for (  LeafElement leaf : newTexts.keySet()) {
    String newText=newTexts.get(leaf);
    leaf.setText(newText);
  }
  ((TreeElement)parsedNode).acceptTree(new RecursiveTreeElementVisitor(){
    protected boolean visitNode(    TreeElement element){
      element.clearCaches();
      return true;
    }
  }
);
}
