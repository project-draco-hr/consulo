{
  PsiDocumentManager documentManager=PsiDocumentManager.getInstance(file.getProject());
  documentManager.commitAllDocuments();
  PsiLanguageInjectionHost injectionHost=findInjectionHost(file.findElementAt(offset));
  if (injectionHost == null && offset != 0) {
    injectionHost=findInjectionHost(file.findElementAt(offset - 1));
  }
  List<Pair<PsiElement,TextRange>> injectedPsi=injectionHost == null ? null : injectionHost.getInjectedPsi();
  if (injectedPsi == null) {
    return null;
  }
  TextRange hostRange=injectionHost.getTextRange();
  for (  Pair<PsiElement,TextRange> pair : injectedPsi) {
    TextRange range=pair.getSecond();
    if (hostRange.cutOut(range).grown(1).contains(offset)) {
      PsiFile injected=(PsiFile)pair.getFirst();
      DocumentRange document=(DocumentRange)documentManager.getCachedDocument(injected);
      int injectedOffset=document.hostToInjected(offset);
      PsiElement element=injected.findElementAt(injectedOffset);
      return element == null ? injected : element;
    }
  }
  return null;
}
