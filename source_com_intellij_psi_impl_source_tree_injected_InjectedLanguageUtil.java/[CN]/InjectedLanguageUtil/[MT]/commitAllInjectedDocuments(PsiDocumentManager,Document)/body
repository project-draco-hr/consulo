{
  Map<RangeMarker,PsiFile> injected=document.getUserData(INJECTED_DOCUMENTS_KEY);
  if (injected == null)   return;
  PsiFile psiFile=documentManager.getPsiFile(document);
  ArrayList<RangeMarker> oldInjected=new ArrayList<RangeMarker>(injected.keySet());
  for (  RangeMarker documentRange : oldInjected) {
    final PsiFileImpl oldFile=(PsiFileImpl)injected.get(documentRange);
    if (!documentRange.isValid() || oldFile == null) {
      injected.remove(documentRange);
    }
    PsiElement element=psiFile.findElementAt(documentRange.getStartOffset());
    PsiLanguageInjectionHost injectionHost=findInjectionHost(element);
    if (injectionHost == null)     continue;
    injectionHost.getInjectedPsi();
  }
}
