{
  PsiDocumentManager.getInstance(host.getProject()).commitAllDocuments();
  PsiLanguageInjectionHost injectionHost=findInjectionHost(host.findElementAt(offset));
  if (injectionHost == null && offset != 0) {
    injectionHost=findInjectionHost(host.findElementAt(offset - 1));
  }
  List<Pair<PsiElement,TextRange>> injectedPsi=injectionHost == null ? null : injectionHost.getInjectedPsi();
  if (injectedPsi == null) {
    return null;
  }
  TextRange hostRange=injectionHost.getTextRange();
  for (  Pair<PsiElement,TextRange> pair : injectedPsi) {
    TextRange range=pair.getSecond();
    if (hostRange.cutOut(range).grown(1).contains(offset)) {
      return pair.getFirst().getContainingFile();
    }
  }
  return null;
}
