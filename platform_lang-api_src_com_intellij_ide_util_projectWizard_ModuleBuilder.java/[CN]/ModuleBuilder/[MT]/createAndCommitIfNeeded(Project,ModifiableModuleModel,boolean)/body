{
  final ModifiableModuleModel moduleModel=model != null ? model : ModuleManager.getInstance(project).getModifiableModel();
  final Module module=createModule(moduleModel);
  if (model == null)   moduleModel.commit();
  if (runFromProjectWizard) {
    StartupManager.getInstance(module.getProject()).runWhenProjectIsInitialized(new DumbAwareRunnable(){
      @Override public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          @Override public void run(){
            onModuleInitialized(module);
          }
        }
);
      }
    }
);
  }
 else {
    onModuleInitialized(module);
  }
  return module;
}
