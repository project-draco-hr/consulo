{
  String base=JavaTestUtil.getJavaTestDataPath() + "/compiler/notNullVerification/";
  final String baseClassName=getTestName(false);
  String path=base + baseClassName;
  String javaPath=path + ".java";
  File classesDir=FileUtil.createTempDirectory(baseClassName,"output");
  try {
    com.sun.tools.javac.Main.compile(new String[]{"-classpath",base + "annotations.jar","-d",classesDir.getAbsolutePath(),javaPath});
    Class mainClass=null;
    final File[] files=classesDir.listFiles();
    boolean modified=false;
    MyClassLoader classLoader=new MyClassLoader(getClass().getClassLoader());
    for (    File file : files) {
      final String fileName=file.getName();
      byte[] content=FileUtil.loadFileBytes(file);
      ClassReader reader=new ClassReader(content,0,content.length);
      ClassWriter writer=new PsiClassWriter(myFixture.getProject(),false);
      final NotNullVerifyingInstrumenter instrumenter=new NotNullVerifyingInstrumenter(writer);
      reader.accept(instrumenter,0);
      modified|=instrumenter.isModification();
      byte[] instrumented=writer.toByteArray();
      final String className=FileUtil.getNameWithoutExtension(fileName);
      final Class aClass=classLoader.doDefineClass(className,instrumented);
      if (className.equals(baseClassName)) {
        mainClass=aClass;
      }
    }
    assertTrue(modified);
    assertNotNull("Class " + baseClassName + " not found!",mainClass);
    return mainClass;
  }
  finally {
    FileUtil.delete(classesDir);
  }
}
