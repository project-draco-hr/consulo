{
  if (elem != null && !(elem instanceof PsiPackage) && RefUtil.getInstance().belongsToScope(elem,this)) {
    if (!elem.isValid())     return null;
    RefElement ref=getFromRefTable(elem);
    if (ref == null) {
      if (!isValidPointForReference()) {
        return null;
      }
      return PsiDocumentManager.getInstance(myProject).commitAndRunReadAction(new Computable<RefElementImpl>(){
        @Nullable public RefElementImpl compute(){
          RefElementImpl refElement;
          if (elem instanceof PsiClass) {
            refElement=new RefClassImpl((PsiClass)elem,RefManagerImpl.this);
          }
 else           if (elem instanceof PsiMethod) {
            refElement=new RefMethodImpl((PsiMethod)elem,RefManagerImpl.this);
          }
 else           if (elem instanceof PsiField) {
            refElement=new RefFieldImpl((PsiField)elem,RefManagerImpl.this);
          }
 else           if (elem instanceof PsiFile) {
            refElement=new RefFileImpl((PsiFile)elem,RefManagerImpl.this);
          }
 else {
            return null;
          }
          putToRefTable(elem,refElement);
          refElement.initialize();
          return refElement;
        }
      }
);
    }
    return ref;
  }
  return null;
}
