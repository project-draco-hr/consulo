{
  if (!visited.add(candidate))   return null;
  if (base == candidate)   return candidateSubstitutor;
  if (manager.areElementsEquivalent(base,candidate)) {
    PsiTypeParameter[] baseParams=base.getTypeParameters();
    PsiTypeParameter[] candidateParams=candidate.getTypeParameters();
    PsiElementFactory factory=base.getManager().getElementFactory();
    if (baseParams.length > 0 && candidateParams.length == 0) {
      return factory.createRawSubstitutor(base);
    }
 else {
      Map<PsiTypeParameter,PsiType> m=new HashMap<PsiTypeParameter,PsiType>();
      for (int i=0; i < candidateParams.length && i < baseParams.length; i++) {
        m.put(baseParams[i],candidateSubstitutor.substitute(candidateParams[i]));
      }
      return factory.createSubstitutor(m);
    }
  }
  PsiSubstitutor substitutor=checkReferenceList(candidate.getExtendsListTypes(),candidateSubstitutor,base,visited,manager);
  if (substitutor == null) {
    substitutor=checkReferenceList(candidate.getImplementsListTypes(),candidateSubstitutor,base,visited,manager);
  }
  return substitutor;
}
