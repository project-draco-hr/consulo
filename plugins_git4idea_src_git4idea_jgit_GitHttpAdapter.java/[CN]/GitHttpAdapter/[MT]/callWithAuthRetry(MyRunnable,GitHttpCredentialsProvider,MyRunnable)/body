{
  ProxySelector defaultProxySelector=ProxySelector.getDefault();
  if (GitHttpProxySupport.shouldUseProxy()) {
    ProxySelector.setDefault(GitHttpProxySupport.newProxySelector());
    GitHttpProxySupport.init(provider.getUrl());
  }
  try {
    for (int i=0; i < 3; i++) {
      try {
        AuthData authData=getUsernameAndPassword(provider.getProject(),provider.getUrl());
        if (authData != null) {
          provider.fillAuthDataIfNotFilled(authData.getLogin(),authData.getPassword());
        }
        if (i == 0) {
          provider.setAlwaysShowDialog(false);
        }
 else {
          provider.setAlwaysShowDialog(true);
        }
        command.run();
        rememberPassword(provider);
        return GeneralResult.SUCCESS;
      }
 catch (      JGitInternalException e) {
        if (authError(e)) {
          if (provider.wasCancelled()) {
            return GeneralResult.CANCELLED;
          }
          if (cleanup != null) {
            cleanup.run();
          }
        }
 else {
          throw e;
        }
      }
    }
    return GeneralResult.NOT_AUTHORIZED;
  }
  finally {
    ProxySelector.setDefault(defaultProxySelector);
  }
}
