{
  int flags=Iconable.ICON_FLAG_VISIBILITY;
  if (isMarkReadOnly()) {
    flags|=Iconable.ICON_FLAG_READ_STATUS;
  }
  boolean changes=super.update();
  final PsiClass psiClass=getPsiClass();
  if (psiClass == null) {
    final String invalidPrefix=IdeBundle.message("node.hierarchy.invalid");
    if (!myHighlightedText.getText().startsWith(invalidPrefix)) {
      myHighlightedText.getBeginning().addText(invalidPrefix,HierarchyNodeDescriptor.getInvalidPrefixAttributes());
    }
    return true;
  }
  final Icon newRawIcon=IconDescriptorUpdaters.getIcon(psiClass,flags);
  final Icon newStateIcon=calculateState(psiClass);
  if (changes || newRawIcon != myRawIcon || newStateIcon != myStateIcon) {
    changes=true;
    myRawIcon=newRawIcon;
    myStateIcon=newStateIcon;
    Icon newIcon=myRawIcon;
    if (myIsBase) {
      final LayeredIcon icon=new LayeredIcon(2);
      icon.setIcon(newIcon,0);
      icon.setIcon(AllIcons.Hierarchy.Base,1,-AllIcons.Hierarchy.Base.getIconWidth() / 2,0);
      newIcon=icon;
    }
    if (myStateIcon != null) {
      final RowIcon icon=new RowIcon(2);
      icon.setIcon(myStateIcon,0);
      icon.setIcon(newIcon,1);
      newIcon=icon;
    }
    setIcon(newIcon);
  }
  final CompositeAppearance oldText=myHighlightedText;
  myHighlightedText=new CompositeAppearance();
  TextAttributes classNameAttributes=null;
  if (myColor != null) {
    classNameAttributes=new TextAttributes(myColor,null,null,null,Font.PLAIN);
  }
  myHighlightedText.getEnding().addText(ClassPresentationUtil.getNameForClass(psiClass,false),classNameAttributes);
  myHighlightedText.getEnding().addText("  (" + JavaHierarchyUtil.getPackageName(psiClass) + ")",HierarchyNodeDescriptor.getPackageNameAttributes());
  myName=myHighlightedText.getText();
  if (!Comparing.equal(myHighlightedText,oldText)) {
    changes=true;
  }
  return changes;
}
