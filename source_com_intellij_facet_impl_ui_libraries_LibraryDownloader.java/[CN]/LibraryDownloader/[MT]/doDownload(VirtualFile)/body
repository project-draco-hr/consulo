{
  HttpConfigurable.getInstance().setAuthenticator();
  final List<Pair<LibraryDownloadInfo,File>> downloadedFiles=new ArrayList<Pair<LibraryDownloadInfo,File>>();
  final List<VirtualFile> existingFiles=new ArrayList<VirtualFile>();
  final Exception[] exception=new Exception[]{null};
  final Ref<LibraryDownloadInfo> currentLibrary=new Ref<LibraryDownloadInfo>();
  ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    public void run(){
      final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
      try {
        for (int i=0; i < myLibraryInfos.length; i++) {
          LibraryDownloadInfo info=myLibraryInfos[i];
          currentLibrary.set(info);
          if (indicator != null) {
            indicator.checkCanceled();
            indicator.setText(IdeBundle.message("progress.0.of.1.file.downloaded.text",i,myLibraryInfos.length));
          }
          final VirtualFile existing=dir.findChild(getExpectedFileName(info));
          long size=existing != null ? existing.getLength() : -1;
          if (!download(info,size,downloadedFiles)) {
            existingFiles.add(existing);
          }
        }
      }
 catch (      ProcessCanceledException e) {
        exception[0]=e;
      }
catch (      IOException e) {
        exception[0]=e;
      }
    }
  }
,IdeBundle.message("progress.download.libraries.title"),true,myProject);
  if (exception[0] == null) {
    try {
      return moveToDir(existingFiles,downloadedFiles,dir);
    }
 catch (    IOException e) {
      final String title=IdeBundle.message("progress.download.libraries.title");
      if (myProject != null) {
        Messages.showErrorDialog(myProject,title,e.getMessage());
      }
 else {
        Messages.showErrorDialog(myParent,title,e.getMessage());
      }
      return VirtualFile.EMPTY_ARRAY;
    }
  }
  deleteFiles(downloadedFiles);
  if (exception[0] instanceof IOException) {
    String message=IdeBundle.message("error.library.download.failed");
    if (currentLibrary.get() != null) {
      message+=": " + currentLibrary.get().getDownloadUrl();
    }
    final boolean tryAgain=IOExceptionDialog.showErrorDialog((IOException)exception[0],IdeBundle.message("progress.download.libraries.title"),message);
    if (tryAgain) {
      return doDownload(dir);
    }
  }
  return VirtualFile.EMPTY_ARRAY;
}
