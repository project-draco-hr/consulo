{
  List<VirtualFile> files=new ArrayList<VirtualFile>();
  final File ioDir=VfsUtil.virtualToIoFile(dir);
  for (  Pair<LibraryInfo,File> pair : downloadedFiles) {
    final LibraryInfo info=pair.getFirst();
    final File toFile=generateName(info.getExpectedJarName(),info.getVersion(),ioDir);
    FileUtil.rename(pair.getSecond(),toFile);
    files.add(new WriteAction<VirtualFile>(){
      protected void run(      final Result<VirtualFile> result){
        final String url=VfsUtil.getUrlForLibraryRoot(toFile);
        LocalFileSystem.getInstance().refreshAndFindFileByIoFile(toFile);
        result.setResult(VirtualFileManager.getInstance().refreshAndFindFileByUrl(url));
      }
    }
.execute().getResultObject());
  }
  for (  final VirtualFile file : existingFiles) {
    files.add(new WriteAction<VirtualFile>(){
      protected void run(      final Result<VirtualFile> result){
        final String url=VfsUtil.getUrlForLibraryRoot(VfsUtil.virtualToIoFile(file));
        result.setResult(VirtualFileManager.getInstance().refreshAndFindFileByUrl(url));
      }
    }
.execute().getResultObject());
  }
  return files.toArray(new VirtualFile[files.size()]);
}
