{
  List<VirtualFile> files=new ArrayList<VirtualFile>();
  final File ioDir=VfsUtil.virtualToIoFile(dir);
  for (  Pair<LibraryDownloadInfo,File> pair : downloadedFiles) {
    final LibraryDownloadInfo info=pair.getFirst();
    final boolean dontTouch=info.getDownloadUrl().startsWith(LIB_SCHEMA);
    final File toFile=dontTouch ? pair.getSecond() : generateName(info,ioDir);
    if (!dontTouch) {
      FileUtil.rename(pair.getSecond(),toFile);
    }
    files.add(new WriteAction<VirtualFile>(){
      protected void run(      final Result<VirtualFile> result){
        final String url=VfsUtil.getUrlForLibraryRoot(toFile);
        LocalFileSystem.getInstance().refreshAndFindFileByIoFile(toFile);
        result.setResult(VirtualFileManager.getInstance().refreshAndFindFileByUrl(url));
      }
    }
.execute().getResultObject());
  }
  for (  final VirtualFile file : existingFiles) {
    files.add(new WriteAction<VirtualFile>(){
      protected void run(      final Result<VirtualFile> result){
        final String url=VfsUtil.getUrlForLibraryRoot(VfsUtil.virtualToIoFile(file));
        result.setResult(VirtualFileManager.getInstance().refreshAndFindFileByUrl(url));
      }
    }
.execute().getResultObject());
  }
  return files.toArray(new VirtualFile[files.size()]);
}
