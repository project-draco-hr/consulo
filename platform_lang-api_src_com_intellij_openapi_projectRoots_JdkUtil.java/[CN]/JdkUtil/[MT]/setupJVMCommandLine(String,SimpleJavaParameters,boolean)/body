{
  final GeneralCommandLine commandLine=new GeneralCommandLine();
  commandLine.setExePath(exePath);
  ParametersList parametersList=javaParameters.getVMParametersList();
  commandLine.setEnvParams(javaParameters.getEnv());
  commandLine.setPassParentEnvs(javaParameters.isPassParentEnvs());
  final Class commandLineWrapper;
  if (forceDynamicClasspath && (commandLineWrapper=getCommandLineWrapperClass()) != null) {
    File classpathFile=null;
    File vmParamsFile=null;
    if (!parametersList.hasParameter("-classpath") && !parametersList.hasParameter("-cp")) {
      try {
        classpathFile=FileUtil.createTempFile("classpath",null);
        final PrintWriter writer=new PrintWriter(classpathFile);
        try {
          for (          String path : javaParameters.getClassPath().getPathList()) {
            writer.println(path);
          }
        }
  finally {
          writer.close();
        }
        String classpath=PathUtil.getJarPathForClass(commandLineWrapper);
        final Class<UrlClassLoader> ourUrlClassLoader=UrlClassLoader.class;
        if (ourUrlClassLoader.getName().equals(parametersList.getPropertyValue("java.system.class.loader"))) {
          classpath+=File.pathSeparator + PathUtil.getJarPathForClass(ourUrlClassLoader);
          classpath+=File.pathSeparator + PathUtil.getJarPathForClass(THashMap.class);
        }
        commandLine.addParameter("-classpath");
        commandLine.addParameter(classpath);
      }
 catch (      IOException e) {
        LOG.error(e);
      }
      try {
        vmParamsFile=FileUtil.createTempFile("vm_params",null);
        final PrintWriter writer=new PrintWriter(vmParamsFile);
        try {
          for (          String param : parametersList.getList()) {
            if (param.startsWith("-D")) {
              writer.println(param);
            }
          }
        }
  finally {
          writer.close();
        }
      }
 catch (      IOException e) {
        LOG.error(e);
      }
    }
    final List<String> list=parametersList.getList();
    if (vmParamsFile == null) {
      commandLine.addParameters(list);
    }
 else {
      for (      String param : list) {
        if (!param.trim().startsWith("-D")) {
          commandLine.addParameter(param);
        }
      }
    }
    appendEncoding(javaParameters,commandLine,parametersList);
    if (classpathFile != null) {
      commandLine.addParameter(commandLineWrapper.getName());
      commandLine.addParameter(classpathFile.getAbsolutePath());
    }
    if (vmParamsFile != null) {
      commandLine.addParameter("@vm_params");
      commandLine.addParameter(vmParamsFile.getAbsolutePath());
    }
  }
 else   if (!parametersList.hasParameter("-classpath") && !parametersList.hasParameter("-cp")) {
    commandLine.addParameters(parametersList.getList());
    appendEncoding(javaParameters,commandLine,parametersList);
    commandLine.addParameter("-classpath");
    commandLine.addParameter(javaParameters.getClassPath().getPathsString());
  }
 else {
    commandLine.addParameters(parametersList.getList());
    appendEncoding(javaParameters,commandLine,parametersList);
  }
  final String mainClass=javaParameters.getMainClass();
  commandLine.addParameter(mainClass);
  commandLine.addParameters(javaParameters.getProgramParametersList().getList());
  commandLine.setWorkDirectory(javaParameters.getWorkingDirectory());
  return commandLine;
}
