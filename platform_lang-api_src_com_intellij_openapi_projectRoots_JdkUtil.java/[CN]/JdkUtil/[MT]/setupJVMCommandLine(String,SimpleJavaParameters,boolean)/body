{
  final GeneralCommandLine commandLine=new GeneralCommandLine();
  commandLine.setExePath(exePath);
  ParametersList parametersList=javaParameters.getVMParametersList();
  commandLine.addParameters(parametersList.getList());
  if (!parametersList.hasProperty("file.encoding")) {
    Charset charset=javaParameters.getCharset();
    if (charset == null)     charset=EncodingManager.getInstance().getDefaultCharset();
    if (charset == null)     charset=CharsetToolkit.getDefaultSystemCharset();
    commandLine.setCharset(charset);
  }
  final Class commandLineWrapper;
  if (forceDynamicClasspath && (commandLineWrapper=getCommandLineWrapperClass()) != null) {
    File classpathFile=null;
    if (!parametersList.hasParameter("-classpath") && !parametersList.hasParameter("-cp")) {
      try {
        classpathFile=FileUtil.createTempFile("classpath",null);
        final PrintWriter writer=new PrintWriter(classpathFile);
        try {
          for (          String path : javaParameters.getClassPath().getPathList()) {
            writer.println(path);
          }
        }
  finally {
          writer.close();
        }
        String classpath=PathUtil.getJarPathForClass(commandLineWrapper);
        final Class<UrlClassLoader> ourUrlClassLoader=UrlClassLoader.class;
        if (ourUrlClassLoader.getName().equals(parametersList.getPropertyValue("java.system.class.loader"))) {
          classpath+=File.pathSeparator + PathUtil.getJarPathForClass(ourUrlClassLoader);
        }
        commandLine.addParameter("-classpath");
        commandLine.addParameter(classpath);
      }
 catch (      IOException e) {
        LOG.error(e);
      }
    }
    if (classpathFile != null) {
      commandLine.addParameter(commandLineWrapper.getName());
      commandLine.addParameter(classpathFile.getAbsolutePath());
    }
  }
 else   if (!parametersList.hasParameter("-classpath") && !parametersList.hasParameter("-cp")) {
    commandLine.addParameter("-classpath");
    commandLine.addParameter(javaParameters.getClassPath().getPathsString());
  }
  final String mainClass=javaParameters.getMainClass();
  commandLine.addParameter(mainClass);
  commandLine.addParameters(javaParameters.getProgramParametersList().getList());
  commandLine.setWorkDirectory(javaParameters.getWorkingDirectory());
  final Map<String,String> env=javaParameters.getEnv();
  if (env != null) {
    commandLine.setEnvParams(env);
    commandLine.setPassParentEnvs(javaParameters.isPassParentEnvs());
  }
  return commandLine;
}
