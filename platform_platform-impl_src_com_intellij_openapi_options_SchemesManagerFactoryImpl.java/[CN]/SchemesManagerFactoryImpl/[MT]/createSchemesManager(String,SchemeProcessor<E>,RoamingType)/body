{
  final Application application=ApplicationManager.getApplication();
  if (!(application instanceof ApplicationEx2))   return null;
  String baseDirPath=((ApplicationEx2)application).getStateStore().getStateStorageManager().expandMacros(fileSpec);
  if (baseDirPath != null) {
    StreamProvider[] providers=((ApplicationEx2)ApplicationManager.getApplication()).getStateStore().getStateStorageManager().getStreamProviders(roamingType);
    SchemesManagerImpl<T,E> manager=new SchemesManagerImpl<T,E>(fileSpec,processor,roamingType,providers,new File(baseDirPath));
    myRegisteredManagers.add(manager);
    return manager;
  }
 else {
    return new AbstractSchemesManager<T,E>(){
      @Override @NotNull public Collection<E> loadSchemes(){
        return Collections.emptyList();
      }
      @Override @NotNull public Collection<SharedScheme<E>> loadSharedSchemes(      final Collection<T> currentSchemeList){
        return Collections.emptyList();
      }
      @Override public void exportScheme(      final E scheme,      final String name,      final String description){
      }
      @Override public boolean isImportAvailable(){
        return false;
      }
      @Override public boolean isShared(      final Scheme scheme){
        return false;
      }
      @Override public void save(){
      }
      @Override protected void onSchemeDeleted(      final Scheme toDelete){
      }
      @Override protected void onSchemeAdded(      final T scheme){
      }
      @Override public boolean isExportAvailable(){
        return false;
      }
      @Override public File getRootDirectory(){
        return null;
      }
    }
;
  }
}
