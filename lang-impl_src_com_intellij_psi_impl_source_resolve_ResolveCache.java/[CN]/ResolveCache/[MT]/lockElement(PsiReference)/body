{
  PsiElement elt=ref.getElement();
  final Thread currentThread=Thread.currentThread();
  while (true) {
    Thread[] lockingThreads=elt.getUserData(IS_BEING_RESOLVED_KEY);
    Thread[] newThreads;
    if (lockingThreads == null) {
      newThreads=new Thread[1];
      newThreads[0]=currentThread;
      if (((UserDataHolderEx)elt).putUserDataIfAbsent(IS_BEING_RESOLVED_KEY,newThreads) == newThreads) {
        break;
      }
    }
 else {
      if (ArrayUtil.find(lockingThreads,currentThread) != -1)       return false;
      newThreads=ArrayUtil.append(lockingThreads,currentThread);
      if (((UserDataHolderEx)elt).replace(IS_BEING_RESOLVED_KEY,lockingThreads,newThreads)) {
        break;
      }
    }
  }
  return true;
}
