{
  PsiElement elt=ref.getElement();
  final Thread currentThread=Thread.currentThread();
  while (true) {
    Thread[] lockingThreads=elt.getUserData(IS_BEING_RESOLVED_KEY);
    Thread[] newThreads;
    if (lockingThreads.length == 1) {
      newThreads=null;
    }
 else {
      newThreads=ArrayUtil.remove(lockingThreads,currentThread);
    }
    if (((UserDataHolderEx)elt).replace(IS_BEING_RESOLVED_KEY,lockingThreads,newThreads)) {
      break;
    }
  }
}
