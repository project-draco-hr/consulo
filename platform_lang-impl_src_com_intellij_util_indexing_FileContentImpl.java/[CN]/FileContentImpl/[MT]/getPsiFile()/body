{
  PsiFile psi=getUserData(FileBasedIndex.PSI_FILE);
  if (psi == null) {
    psi=getUserData(CACHED_PSI);
  }
  if (psi == null) {
    Project project=getProject();
    if (project == null) {
      project=ProjectManager.getInstance().getDefaultProject();
    }
    final Language language=((LanguageFileType)getFileTypeWithoutSubstitution()).getLanguage();
    final Language substitutedLanguage=LanguageSubstitutors.INSTANCE.substituteLanguage(language,getFile(),project);
    psi=PsiFileFactory.getInstance(project).createFileFromText(getFileName(),substitutedLanguage,getContentAsText(),false,false,true);
    psi.putUserData(IndexingDataKeys.VIRTUAL_FILE,getFile());
    putUserData(CACHED_PSI,psi);
  }
  return psi;
}
