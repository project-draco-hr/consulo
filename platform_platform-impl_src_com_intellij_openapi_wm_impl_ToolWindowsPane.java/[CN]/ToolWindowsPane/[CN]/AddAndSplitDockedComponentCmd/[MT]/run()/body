{
  try {
    float newWeight;
    final ToolWindowAnchor anchor=myInfo.getAnchor();
    final Disposable splitterDisposable=new Disposable(){
      @Override public void dispose(){
      }
    }
;
    Disposer.register(myDisposable,splitterDisposable);
    final Splitter splitter=new Splitter(anchor.isSplitVertically()){
      @Override public void removeNotify(){
        super.removeNotify();
        Disposer.dispose(splitterDisposable);
      }
    }
;
    if (!anchor.isHorizontal()) {
      UISettings.getInstance().addUISettingsListener(new UISettingsListener(){
        @Override public void uiSettingsChanged(        UISettings source){
          if (anchor == ToolWindowAnchor.LEFT) {
            splitter.setOrientation(!source.LEFT_HORIZONTAL_SPLIT);
          }
          if (anchor == ToolWindowAnchor.RIGHT) {
            splitter.setOrientation(!source.RIGHT_HORIZONTAL_SPLIT);
          }
        }
      }
,splitterDisposable);
      splitter.setAllowSwitchOrientationByMouseClick(true);
      splitter.addPropertyChangeListener(new PropertyChangeListener(){
        @Override public void propertyChange(        PropertyChangeEvent evt){
          if (!Splitter.PROP_ORIENTATION.equals(evt.getPropertyName()))           return;
          boolean isSplitterHorizontalNow=!splitter.isVertical();
          UISettings settings=UISettings.getInstance();
          if (anchor == ToolWindowAnchor.LEFT) {
            if (settings.LEFT_HORIZONTAL_SPLIT != isSplitterHorizontalNow) {
              settings.LEFT_HORIZONTAL_SPLIT=isSplitterHorizontalNow;
              settings.fireUISettingsChanged();
            }
          }
          if (anchor == ToolWindowAnchor.RIGHT) {
            if (settings.RIGHT_HORIZONTAL_SPLIT != isSplitterHorizontalNow) {
              settings.RIGHT_HORIZONTAL_SPLIT=isSplitterHorizontalNow;
              settings.fireUISettingsChanged();
            }
          }
        }
      }
);
    }
    JComponent c=getComponentAt(anchor);
    if (c instanceof InternalDecorator) {
      InternalDecorator oldComponent=(InternalDecorator)c;
      if (myInfo.isSplit()) {
        splitter.setFirstComponent(oldComponent);
        splitter.setSecondComponent(myNewComponent);
        float proportion=getPreferredSplitProportion(oldComponent.getWindowInfo().getId(),normalizeWeigh(oldComponent.getWindowInfo().getSideWeight() / (oldComponent.getWindowInfo().getSideWeight() + myInfo.getSideWeight())));
        splitter.setProportion(proportion);
        if (!anchor.isHorizontal() && !anchor.isSplitVertically()) {
          newWeight=normalizeWeigh(oldComponent.getWindowInfo().getWeight() + myInfo.getWeight());
        }
 else {
          newWeight=normalizeWeigh(oldComponent.getWindowInfo().getWeight());
        }
      }
 else {
        splitter.setFirstComponent(myNewComponent);
        splitter.setSecondComponent(oldComponent);
        splitter.setProportion(normalizeWeigh(myInfo.getSideWeight()));
        if (!anchor.isHorizontal() && !anchor.isSplitVertically()) {
          newWeight=normalizeWeigh(oldComponent.getWindowInfo().getWeight() + myInfo.getWeight());
        }
 else {
          newWeight=normalizeWeigh(myInfo.getWeight());
        }
      }
    }
 else {
      newWeight=normalizeWeigh(myInfo.getWeight());
    }
    setComponent(splitter,anchor,newWeight);
    if (!myDirtyMode) {
      myLayeredPane.validate();
      myLayeredPane.repaint();
    }
  }
  finally {
    finish();
  }
}
