{
  if (CreateFromUsageUtils.isValidReference(myReferenceExpression,true)) {
    return;
  }
  Project project=myReferenceExpression.getProject();
  PsiElementFactory factory=JavaPsiFacade.getInstance(project).getElementFactory();
  PsiFile targetFile=targetClass.getContainingFile();
  PsiType[] expectedTypes=CreateFromUsageUtils.guessType(myReferenceExpression,false);
  PsiType type=expectedTypes[0];
  String varName=myReferenceExpression.getReferenceName();
  PsiExpression initializer=null;
  boolean isInline=false;
  PsiExpression[] expressions=CreateFromUsageUtils.collectExpressions(myReferenceExpression,PsiMember.class,PsiFile.class);
  PsiStatement anchor=getAnchor(expressions);
  if (anchor instanceof PsiExpressionStatement && ((PsiExpressionStatement)anchor).getExpression() instanceof PsiAssignmentExpression) {
    PsiAssignmentExpression assignment=(PsiAssignmentExpression)((PsiExpressionStatement)anchor).getExpression();
    if (assignment.getLExpression().textMatches(myReferenceExpression)) {
      initializer=assignment.getRExpression();
      isInline=true;
    }
  }
  PsiDeclarationStatement decl=factory.createVariableDeclarationStatement(varName,type,initializer);
  TypeExpression expression=new TypeExpression(project,expectedTypes);
  if (isInline) {
    decl=(PsiDeclarationStatement)anchor.replace(decl);
  }
 else {
    decl=(PsiDeclarationStatement)anchor.getParent().addBefore(decl,anchor);
  }
  PsiVariable var=(PsiVariable)decl.getDeclaredElements()[0];
  boolean isFinal=CodeStyleSettingsManager.getSettings(project).GENERATE_FINAL_LOCALS && !CreateFromUsageUtils.isAccessedForWriting(expressions);
  PsiUtil.setModifierProperty(var,PsiModifier.FINAL,isFinal);
  var=CodeInsightUtilBase.forcePsiPostprocessAndRestoreElement(var);
  if (var == null)   return;
  TemplateBuilderImpl builder=new TemplateBuilderImpl(var);
  builder.replaceElement(var.getTypeElement(),expression);
  builder.setEndVariableAfter(var.getNameIdentifier());
  Template template=builder.buildTemplate();
  Editor newEditor=positionCursor(project,targetFile,var);
  TextRange range=var.getTextRange();
  newEditor.getDocument().deleteString(range.getStartOffset(),range.getEndOffset());
  TemplateManager manager=TemplateManager.getInstance(project);
  manager.startTemplate(newEditor,template);
}
