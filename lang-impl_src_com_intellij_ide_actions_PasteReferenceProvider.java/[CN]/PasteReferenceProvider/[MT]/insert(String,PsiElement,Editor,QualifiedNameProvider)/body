{
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(editor.getProject());
  documentManager.commitDocument(editor.getDocument());
  final PsiFile file=documentManager.getPsiFile(editor.getDocument());
  if (!CodeInsightUtilBase.prepareFileForWrite(file))   return;
  final Project project=editor.getProject();
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          Document document=editor.getDocument();
          documentManager.doPostponedOperationsAndUnblockDocument(document);
          documentManager.commitDocument(document);
          EditorModificationUtil.deleteSelectedText(editor);
          provider.insertQualifiedName(fqn,element,editor,project);
        }
      }
);
    }
  }
,IdeBundle.message("command.pasting.reference"),null);
}
