{
  Change change=request.getUserData(ChangeDiffRequestProducer.CHANGE_KEY);
  if (change != null) {
    ContentRevision revision=side.select(change.getBeforeRevision(),change.getAfterRevision());
    if (revision != null) {
      AbstractVcs vcs=ChangesUtil.getVcsForChange(change,project);
      if (revision instanceof CurrentContentRevision) {
        VirtualFile file=((CurrentContentRevision)revision).getVirtualFile();
        FileAnnotationLoader loader=doCreateAnnotationsLoader(vcs,file);
        if (loader != null)         return loader;
      }
 else {
        FileAnnotationLoader loader=doCreateAnnotationsLoader(vcs,revision.getFile(),revision.getRevisionNumber());
        if (loader != null)         return loader;
      }
    }
  }
  if (request instanceof ContentDiffRequest) {
    ContentDiffRequest requestEx=(ContentDiffRequest)request;
    if (requestEx.getContents().size() == 2) {
      DiffContent content=side.select(requestEx.getContents());
      if (content instanceof FileContent) {
        VirtualFile file=((FileContent)content).getFile();
        AbstractVcs vcs=VcsUtil.getVcsFor(project,file);
        FileAnnotationLoader loader=doCreateAnnotationsLoader(vcs,file);
        if (loader != null)         return loader;
      }
      VcsFileRevision[] fileRevisions=request.getUserData(VcsHistoryUtil.REVISIONS_KEY);
      if (fileRevisions != null && fileRevisions.length == 2) {
        VcsFileRevision fileRevision=side.select(fileRevisions);
        if (fileRevision instanceof VcsFileRevisionEx) {
          FilePath filePath=((VcsFileRevisionEx)fileRevision).getPath();
          AbstractVcs vcs=VcsUtil.getVcsFor(project,filePath);
          FileAnnotationLoader loader=doCreateAnnotationsLoader(vcs,filePath,fileRevision.getRevisionNumber());
          if (loader != null)           return loader;
        }
      }
    }
  }
  return null;
}
