{
  final DataContext dataContext=e.getDataContext();
  final Project project=CommonDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return;
  }
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    @Override public void run(){
      PsiDocumentManager.getInstance(project).commitAllDocuments();
    }
  }
,"",null);
  final Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  PsiElement[] elements;
  PsiDirectory defaultTargetDirectory;
  if (editor != null) {
    PsiElement aElement=getTargetElement(editor,project);
    PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return;
    elements=new PsiElement[]{aElement};
    if (aElement == null || !CopyHandler.canCopy(elements)) {
      elements=new PsiElement[]{file};
    }
    defaultTargetDirectory=file.getContainingDirectory();
  }
 else {
    PsiElement element=LangDataKeys.TARGET_PSI_ELEMENT.getData(dataContext);
    defaultTargetDirectory=element instanceof PsiDirectory ? (PsiDirectory)element : null;
    elements=LangDataKeys.PSI_ELEMENT_ARRAY.getData(dataContext);
  }
  doCopy(elements,defaultTargetDirectory);
}
