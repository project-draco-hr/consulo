{
  final XmlTag tag=PsiTreeUtil.getParentOfType(myElement,XmlTag.class);
  if (tag == null)   return PsiUtil.NULL_PSI_ELEMENT;
  String canonicalText=getCanonicalText();
  XmlNSDescriptorImpl nsDescriptor=getDescriptor(tag,canonicalText);
  if (myType != null && nsDescriptor != null) {
switch (myType) {
case GroupReference:
      return nsDescriptor.findGroup(canonicalText);
case AttributeGroupReference:
    return nsDescriptor.findAttributeGroup(canonicalText);
case ElementReference:
{
    XmlElementDescriptor descriptor=nsDescriptor.getElementDescriptor(XmlUtil.findLocalNameByQualifiedName(canonicalText),getNamespace(tag,canonicalText),new HashSet<XmlNSDescriptorImpl>(),true);
    return descriptor != null ? descriptor.getDeclaration() : PsiUtil.NULL_PSI_ELEMENT;
  }
case AttributeReference:
{
  final String prefixByQualifiedName=XmlUtil.findPrefixByQualifiedName(canonicalText);
  final String localNameByQualifiedName=XmlUtil.findLocalNameByQualifiedName(canonicalText);
  XmlAttributeDescriptor descriptor=nsDescriptor.getAttribute(localNameByQualifiedName,getNamespace(tag,canonicalText));
  if (descriptor != null)   return descriptor.getDeclaration();
  if (XML_NS_PREFIX.equals(prefixByQualifiedName) && (LANG_XML_NS_ATTR_NAME.equals(localNameByQualifiedName) || BASE_XML_NS_ATTR_NAME.equals(localNameByQualifiedName) || SPACE_XML_NS_ATTR_NAME.equals(localNameByQualifiedName))) {
    return myElement;
  }
  return PsiUtil.NULL_PSI_ELEMENT;
}
case TypeReference:
{
TypeDescriptor typeDescriptor=nsDescriptor.getTypeDescriptor(canonicalText,tag);
if (typeDescriptor instanceof ComplexTypeDescriptor) {
  return ((ComplexTypeDescriptor)typeDescriptor).getDeclaration();
}
 else if (typeDescriptor instanceof TypeDescriptor) {
  return myElement;
}
}
}
}
return PsiUtil.NULL_PSI_ELEMENT;
}
