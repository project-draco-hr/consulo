{
  if (myType != ReferenceType.ElementReference && myType != ReferenceType.AttributeReference) {
    final PsiElement parentElement=myElement.getParent();
    final PsiElement grandParentElement=parentElement != null ? parentElement.getParent() : null;
    boolean doRedefineCheck=false;
    if (parentElement instanceof XmlAttribute && grandParentElement instanceof XmlTag) {
      final String attrName=((XmlAttribute)parentElement).getName();
      final String tagLocalName=((XmlTag)grandParentElement).getLocalName();
      doRedefineCheck=(REF_ATTR_NAME.equals(attrName) && (GROUP_TAG_NAME.equals(tagLocalName) || ATTRIBUTE_GROUP_TAG_NAME.equals(tagLocalName))) || (BASE_XML_NS_ATTR_NAME.equals(attrName) || MEMBER_TYPES_ATTR_NAME.equals(attrName));
    }
    if (doRedefineCheck) {
      for (XmlTag parentTag=tag.getParentTag(); parentTag != null; parentTag=parentTag.getParentTag()) {
        if ("redefine".equals(parentTag.getLocalName())) {
          final String schemaL=parentTag.getAttributeValue(XmlUtil.SCHEMA_LOCATION_ATT);
          if (schemaL != null) {
            final PsiReference[] references=parentTag.getAttribute(XmlUtil.SCHEMA_LOCATION_ATT,null).getValueElement().getReferences();
            if (references.length > 0) {
              final PsiElement psiElement=references[references.length - 1].resolve();
              if (psiElement instanceof XmlFile) {
                final PsiMetaDataBase metaData=((XmlFile)psiElement).getDocument().getMetaData();
                if (metaData instanceof XmlNSDescriptorImpl)                 return (XmlNSDescriptorImpl)metaData;
              }
            }
          }
        }
      }
    }
  }
  XmlNSDescriptor nsDescriptor=nsDescriptor=tag.getNSDescriptor(getNamespace(tag,text),true);
  if (nsDescriptor == null) {
    nsDescriptor=(XmlNSDescriptor)((XmlFile)tag.getContainingFile()).getDocument().getMetaData();
  }
  return nsDescriptor instanceof XmlNSDescriptorImpl ? (XmlNSDescriptorImpl)nsDescriptor : null;
}
