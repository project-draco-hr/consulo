{
  final XmlTag tag=PsiTreeUtil.getParentOfType(myElement,XmlTag.class);
  if (tag == null)   return null;
  String canonicalText=getCanonicalText();
  XmlNSDescriptorImpl nsDescriptor=getDescriptor(tag,canonicalText);
  if (myType != null && nsDescriptor != null) {
switch (myType) {
case GroupReference:
      return nsDescriptor.findGroup(canonicalText);
case AttributeGroupReference:
    return nsDescriptor.findAttributeGroup(canonicalText);
case ElementReference:
{
    XmlElementDescriptor descriptor=nsDescriptor.getElementDescriptor(XmlUtil.findLocalNameByQualifiedName(canonicalText),tag.getNamespaceByPrefix(XmlUtil.findPrefixByQualifiedName(canonicalText)),new HashSet<XmlNSDescriptorImpl>(),true);
    return descriptor != null ? descriptor.getDeclaration() : null;
  }
case AttributeReference:
{
  final String prefixByQualifiedName=XmlUtil.findPrefixByQualifiedName(canonicalText);
  final String localNameByQualifiedName=XmlUtil.findLocalNameByQualifiedName(canonicalText);
  XmlAttributeDescriptor descriptor=nsDescriptor.getAttribute(localNameByQualifiedName,tag.getNamespaceByPrefix(prefixByQualifiedName));
  if (descriptor != null)   return descriptor.getDeclaration();
  if ("xml".equals(prefixByQualifiedName) && ("lang".equals(localNameByQualifiedName) || "base".equals(localNameByQualifiedName) || "space".equals(localNameByQualifiedName))) {
    return myElement;
  }
  return null;
}
case TypeReference:
{
TypeDescriptor typeDescriptor=nsDescriptor.getTypeDescriptor(canonicalText,tag);
if (typeDescriptor instanceof ComplexTypeDescriptor) {
  return ((ComplexTypeDescriptor)typeDescriptor).getDeclaration();
}
 else if (typeDescriptor instanceof TypeDescriptor) {
  return myElement;
}
}
}
}
return null;
}
