{
  final PsiElement parent=value.getParent();
  if (!(parent instanceof XmlAttribute))   return;
  XmlAttribute attribute=(XmlAttribute)parent;
  XmlTag tag=attribute.getParent();
  if (tag == null)   return;
  final String unquotedValue=getUnquotedValue(value,tag);
  if (XmlUtil.isSimpleXmlAttributeValue(unquotedValue,value)) {
    final XmlAttribute attributeById=refCountHolder.getAttributeById(unquotedValue);
    if (attributeById == null || !attributeById.isValid() || attributeById == attribute || soft || isSoftContext(attributeById)) {
      if (!soft || attributeById == null)       refCountHolder.registerAttributeWithId(unquotedValue,attribute);
    }
 else {
      final XmlAttributeValue valueElement=attributeById.getValueElement();
      if (valueElement != null && getUnquotedValue(valueElement,tag).equals(unquotedValue)) {
        if (tag.getParent().getUserData(DO_NOT_VALIDATE_KEY) == null) {
          highlights.add(HighlightInfo.createHighlightInfo(HighlightInfoType.WRONG_REF,value,XmlErrorMessages.message("duplicate.id.reference")));
          highlights.add(HighlightInfo.createHighlightInfo(HighlightInfoType.WRONG_REF,valueElement,XmlErrorMessages.message("duplicate.id.reference")));
        }
      }
 else {
        refCountHolder.registerAttributeWithId(unquotedValue,attribute);
      }
    }
  }
}
