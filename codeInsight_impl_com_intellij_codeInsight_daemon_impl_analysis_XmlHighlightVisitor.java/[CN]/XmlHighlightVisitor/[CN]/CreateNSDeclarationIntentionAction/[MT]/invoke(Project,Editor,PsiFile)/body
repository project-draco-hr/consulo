{
  final String[] namespaces=guessNamespace(file,project,myTaglibDeclaration || file instanceof JspFile,!(file instanceof JspFile) || file.getFileType() == StdFileTypes.JSPX);
  if (namespaces.length > 1) {
    final JList list=new JList(namespaces);
    list.setCellRenderer(new FQNameCellRenderer());
    Runnable runnable=new Runnable(){
      public void run(){
        final int index=list.getSelectedIndex();
        if (index < 0)         return;
        PsiDocumentManager.getInstance(project).commitAllDocuments();
        CommandProcessor.getInstance().executeCommand(project,new Runnable(){
          public void run(){
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                try {
                  insertNsDeclaration(file,namespaces[index],project);
                }
 catch (                IncorrectOperationException e) {
                }
              }
            }
);
          }
        }
,getText(),getFamilyName());
      }
    }
;
    new PopupChooserBuilder(list).setTitle(XmlErrorMessages.message(myTaglibDeclaration ? "select.taglib.title" : "select.namespace.title")).setItemChoosenCallback(runnable).createPopup().showInBestPositionFor(editor);
  }
 else {
    insertNsDeclaration(file,namespaces[0],project);
  }
}
