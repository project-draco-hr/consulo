{
  final XmlTag rootTag=((XmlFile)file).getDocument().getRootTag();
  final PsiElementFactory elementFactory=rootTag.getManager().getElementFactory();
  if (myTaglibDeclaration) {
    final XmlTag childTag=rootTag.createChildTag("directive.taglib",XmlUtil.JSP_URI,null,false);
    PsiElement element=childTag.add(elementFactory.createXmlAttribute("prefix",myNamespacePrefix));
    childTag.addAfter(elementFactory.createXmlAttribute(URI_ATTR_NAME,namespace),element);
    final XmlTag[] directives=((JspFile)file).getDirectiveTags(JspDirectiveKind.TAGLIB,false);
    if (directives == null || directives.length == 0) {
      element=rootTag.addBefore(childTag,rootTag.getFirstChild());
    }
 else {
      element=rootTag.addAfter(childTag,directives[directives.length - 1]);
    }
    CodeStyleManager.getInstance(project).reformat(element);
    return ((XmlTag)element).getAttribute(URI_ATTR_NAME,null);
  }
 else {
    @NonNls final String name="xmlns" + (myNamespacePrefix.length() > 0 ? ":" + myNamespacePrefix : "");
    rootTag.add(elementFactory.createXmlAttribute(name,namespace));
    return rootTag.getAttribute(name,null);
  }
}
