{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  if (LOG.isDebugEnabled()) {
    LOG.debug("refreshInternal recursive = " + recursive + " worker = "+ worker+ " "+ myName);
  }
  PhysicalFile physicalFile=getPhysicalFile();
  final boolean isDirectory=physicalFile.isDirectory();
  if (isDirectory != myDirectoryFlag) {
    final PhysicalFile _physicalFile=physicalFile;
    ourFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
      public void run(){
        if (!isValid())         return;
        VirtualFileImpl parent=(VirtualFileImpl)getParent();
        if (parent == null)         return;
        ourFileSystem.fireBeforeFileDeletion(null,VirtualFileImpl.this);
        parent.removeChild(VirtualFileImpl.this);
        ourFileSystem.fireFileDeleted(null,VirtualFileImpl.this,myName,myDirectoryFlag,parent);
        VirtualFileImpl newChild=new VirtualFileImpl(parent,_physicalFile,isDirectory);
        parent.addChild(newChild);
        ourFileSystem.fireFileCreated(null,newChild);
      }
    }
,worker != null,modalityState);
    return;
  }
  if (isDirectory) {
    if (myChildren == null)     return;
    PhysicalFile[] files=physicalFile.listFiles();
    final boolean[] found=new boolean[myChildren.length];
    final Map<String,Pair<VirtualFile,Integer>> childrenMap=new HashMap<String,Pair<VirtualFile,Integer>>((int)((double)myChildren.length * 1.5),(float)0.6);
{
      for (int i=0; i < myChildren.length; i++) {
        final VirtualFileImpl child=myChildren[i];
        childrenMap.put(child.getName(),new Pair<VirtualFile,Integer>(child,i));
      }
    }
    VirtualFileImpl[] children=myChildren;
    for (    final PhysicalFile file : files) {
      final String name=file.getName();
      final Pair<VirtualFile,Integer> pair=childrenMap.get(name);
      if (pair == null) {
        ourFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
          public void run(){
            if (VirtualFileImpl.this.isValid()) {
              if (findChild(file.getName()) != null)               return;
              VirtualFileImpl newChild=new VirtualFileImpl(VirtualFileImpl.this,file,file.isDirectory());
              addChild(newChild);
              ourFileSystem.fireFileCreated(null,newChild);
            }
          }
        }
,worker != null,modalityState);
      }
 else {
        found[pair.getSecond()]=true;
      }
    }
    for (int i=0; i < children.length; i++) {
      final VirtualFileImpl child=children[i];
      if (found[i]) {
        if (recursive) {
          if (worker != null) {
            worker.addTask(new Runnable(){
              public void run(){
                Runnable action=new Runnable(){
                  public void run(){
                    child.refreshInternal(recursive,worker,modalityState,false);
                  }
                }
;
                ApplicationManager.getApplication().runReadAction(action);
              }
            }
);
          }
 else {
            child.refreshInternal(recursive,null,modalityState,false);
          }
        }
      }
 else {
        ourFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
          public void run(){
            if (child.isValid()) {
              ourFileSystem.fireBeforeFileDeletion(null,child);
              removeChild(child);
              ourFileSystem.fireFileDeleted(null,child,child.myName,child.myDirectoryFlag,VirtualFileImpl.this);
            }
          }
        }
,worker != null,modalityState);
      }
    }
  }
 else {
    if (myTimeStamp > 0) {
      final long timeStamp=physicalFile.lastModified();
      if (timeStamp != myTimeStamp || forceRefresh) {
        ourFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
          public void run(){
            if (!isValid())             return;
            ourFileSystem.fireBeforeContentsChange(null,VirtualFileImpl.this);
            long oldModificationStamp=getModificationStamp();
            myTimeStamp=timeStamp;
            myModificationStamp=LocalTimeCounter.currentTime();
            ourFileSystem.fireContentsChanged(null,VirtualFileImpl.this,oldModificationStamp);
          }
        }
,worker != null,modalityState);
      }
    }
  }
  if (myWritableFlag != null) {
    final boolean isWritable=isWritable(physicalFile,isDirectory());
    if (isWritable != myWritableFlag.booleanValue()) {
      ourFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
        public void run(){
          if (!isValid())           return;
          ourFileSystem.fireBeforePropertyChange(null,VirtualFileImpl.this,PROP_WRITABLE,myWritableFlag,isWritable ? Boolean.TRUE : Boolean.FALSE);
          myWritableFlag=isWritable ? Boolean.TRUE : Boolean.FALSE;
          ourFileSystem.firePropertyChanged(null,VirtualFileImpl.this,PROP_WRITABLE,isWritable ? Boolean.FALSE : Boolean.TRUE,myWritableFlag);
        }
      }
,worker != null,modalityState);
    }
  }
}
