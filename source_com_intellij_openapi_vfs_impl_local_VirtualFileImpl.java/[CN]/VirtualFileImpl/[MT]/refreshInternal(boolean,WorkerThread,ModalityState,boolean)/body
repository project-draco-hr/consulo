{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  if (LOG.isDebugEnabled()) {
    LOG.debug("refreshInternal recursive = " + recursive + " worker = "+ worker+ " "+ myName);
  }
  PhysicalFile physicalFile=getPhysicalFile();
  final boolean isDirectory=physicalFile.isDirectory();
  if (isDirectory != myDirectoryFlag) {
    final PhysicalFile _physicalFile=physicalFile;
    myFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
      public void run(){
        if (!isValid())         return;
        VirtualFileImpl parent=(VirtualFileImpl)getParent();
        if (parent == null)         return;
        myFileSystem.fireBeforeFileDeletion(null,VirtualFileImpl.this);
        parent.removeChild(VirtualFileImpl.this);
        myFileSystem.fireFileDeleted(null,VirtualFileImpl.this,myName,myDirectoryFlag,parent);
        VirtualFileImpl newChild=new VirtualFileImpl(myFileSystem,parent,_physicalFile,isDirectory);
        parent.addChild(newChild);
        myFileSystem.fireFileCreated(null,newChild);
      }
    }
,worker != null,modalityState);
    return;
  }
  if (isDirectory) {
    if (myChildren == null)     return;
    PhysicalFile[] files=physicalFile.listFiles();
    if (files == null) {
      files=new PhysicalFile[0];
    }
    boolean[] found=new boolean[myChildren.length];
    VirtualFileImpl[] children=myChildren;
    for (int i=0; i < files.length; i++) {
      final PhysicalFile file=files[i];
      final String name=file.getName();
      int index=-1;
      if (i < children.length && children[i].myName.equals(name)) {
        index=i;
      }
 else {
        for (int j=0; j < children.length; j++) {
          if (children[j].myName.equals(name)) {
            index=j;
            break;
          }
        }
      }
      if (index < 0) {
        myFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
          public void run(){
            if (VirtualFileImpl.this.isValid()) {
              if (findChild(file.getName()) != null)               return;
              VirtualFileImpl newChild=new VirtualFileImpl(myFileSystem,VirtualFileImpl.this,file,file.isDirectory());
              addChild(newChild);
              myFileSystem.fireFileCreated(null,newChild);
            }
          }
        }
,worker != null,modalityState);
      }
 else {
        found[index]=true;
      }
    }
    for (int i=0; i < children.length; i++) {
      final VirtualFileImpl child=children[i];
      if (found[i]) {
        if (recursive) {
          if (worker != null) {
            worker.addTask(new Runnable(){
              public void run(){
                Runnable action=new Runnable(){
                  public void run(){
                    child.refreshInternal(recursive,worker,modalityState,false);
                  }
                }
;
                ApplicationManager.getApplication().runReadAction(action);
              }
            }
);
          }
 else {
            child.refreshInternal(recursive,null,modalityState,false);
          }
        }
      }
 else {
        myFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
          public void run(){
            if (child.isValid()) {
              myFileSystem.fireBeforeFileDeletion(null,child);
              removeChild(child);
              myFileSystem.fireFileDeleted(null,child,child.myName,child.myDirectoryFlag,VirtualFileImpl.this);
            }
          }
        }
,worker != null,modalityState);
      }
    }
  }
 else {
    if (myTimeStamp > 0) {
      final long timeStamp=physicalFile.lastModified();
      if (timeStamp != myTimeStamp || forceRefresh) {
        myFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
          public void run(){
            if (!isValid())             return;
            myFileSystem.fireBeforeContentsChange(null,VirtualFileImpl.this);
            long oldModificationStamp=getModificationStamp();
            myTimeStamp=timeStamp;
            myModificationStamp=LocalTimeCounter.currentTime();
            myFileSystem.fireContentsChanged(null,VirtualFileImpl.this,oldModificationStamp);
          }
        }
,worker != null,modalityState);
      }
    }
  }
  if (myWritableFlag != null) {
    final boolean isWritable=isWritable(physicalFile,isDirectory());
    if (isWritable != myWritableFlag.booleanValue()) {
      myFileSystem.getManager().addEventToFireByRefresh(new Runnable(){
        public void run(){
          if (!isValid())           return;
          myFileSystem.fireBeforePropertyChange(null,VirtualFileImpl.this,PROP_WRITABLE,myWritableFlag,isWritable ? Boolean.TRUE : Boolean.FALSE);
          myWritableFlag=isWritable ? Boolean.TRUE : Boolean.FALSE;
          myFileSystem.firePropertyChanged(null,VirtualFileImpl.this,PROP_WRITABLE,isWritable ? Boolean.FALSE : Boolean.TRUE,myWritableFlag);
        }
      }
,worker != null,modalityState);
    }
  }
}
