{
  ApplicationManager.getApplication().assertWriteAccessAllowed();
  PhysicalFile physicalFile=getPhysicalFile();
  if (isDirectory()) {
    throw new IOException("Cannot write to file " + physicalFile.getPath() + ".");
  }
  myFileSystem.fireBeforeContentsChange(requestor,this);
  final OutputStream out=new BufferedOutputStream(physicalFile.createOutputStream());
  if (myBOM != null) {
    out.write(myBOM);
  }
  return new OutputStream(){
    public void write(    int b) throws IOException {
      out.write(b);
    }
    public void write(    byte[] b) throws IOException {
      out.write(b);
    }
    public void write(    byte[] b,    int off,    int len) throws IOException {
      out.write(b,off,len);
    }
    public void flush() throws IOException {
      out.flush();
    }
    public void close() throws IOException {
      out.close();
      long oldModificationStamp=getModificationStamp();
      myModificationStamp=newModificationStamp >= 0 ? newModificationStamp : LocalTimeCounter.currentTime();
      if (newTimeStamp >= 0) {
        getPhysicalFile().setLastModified(newTimeStamp);
      }
      myTimeStamp=getPhysicalFile().lastModified();
      myFileSystem.fireContentsChanged(requestor,VirtualFileImpl.this,oldModificationStamp);
    }
  }
;
}
