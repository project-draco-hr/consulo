{
  if (!(newParent instanceof VirtualFileImpl)) {
    throw new IOException(VfsBundle.message("file.move.error",newParent.getPresentableUrl()));
  }
  String name=getName();
  VirtualFileImpl oldParent=myParent;
  final boolean auxCommand=ourFileSystem.auxMove(this,newParent);
  ourFileSystem.fireBeforeFileMovement(requestor,this,newParent);
  newParent.getChildren();
  PhysicalFile physicalFile=getPhysicalFile();
  boolean isDirectory=isDirectory();
  if (!auxCommand) {
    PhysicalFile newPhysicalParent=((VirtualFileImpl)newParent).getPhysicalFile();
    PhysicalFile newPhysicalFile=newPhysicalParent.createChild(name);
    if (!physicalFile.renameTo(newPhysicalFile)) {
      throw new IOException(VfsBundle.message("file.move.to.error",physicalFile.getPath(),newPhysicalParent.getPath()));
    }
  }
  oldParent.removeChild(this);
  myParent=(VirtualFileImpl)newParent;
  ((VirtualFileImpl)newParent).addChild(this);
  ourFileSystem.fireFileMoved(requestor,this,oldParent);
  if (auxCommand && isDirectory && physicalFile.exists()) {
    VirtualFileImpl newMe=new VirtualFileImpl(oldParent,physicalFile,true);
    oldParent.addChild(newMe);
    ourFileSystem.fireFileCreated(requestor,newMe);
  }
}
