{
  if (!(newParent instanceof VirtualFileImpl)) {
    throw new IOException("Can not move file to " + newParent.getPresentableUrl());
  }
  String name=getName();
  VirtualFileImpl oldParent=myParent;
  final boolean auxCommand=myFileSystem.auxMove(this,newParent);
  myFileSystem.fireBeforeFileMovement(requestor,this,newParent);
  newParent.getChildren();
  PhysicalFile physicalFile=getPhysicalFile();
  boolean isDirectory=isDirectory();
  if (!auxCommand) {
    PhysicalFile newPhysicalParent=((VirtualFileImpl)newParent).getPhysicalFile();
    PhysicalFile newPhysicalFile=newPhysicalParent.createChild(name);
    if (!physicalFile.renameTo(newPhysicalFile)) {
      throw new IOException("Cannot move file " + physicalFile.getPath() + " to "+ newPhysicalParent.getPath()+ ".");
    }
  }
  oldParent.removeChild(this);
  myParent=(VirtualFileImpl)newParent;
  ((VirtualFileImpl)newParent).addChild(this);
  myFileSystem.fireFileMoved(requestor,this,oldParent);
  if (auxCommand && isDirectory && physicalFile.exists()) {
    VirtualFileImpl newMe=new VirtualFileImpl(myFileSystem,oldParent,physicalFile,true);
    oldParent.addChild(newMe);
    myFileSystem.fireFileCreated(requestor,newMe);
  }
}
