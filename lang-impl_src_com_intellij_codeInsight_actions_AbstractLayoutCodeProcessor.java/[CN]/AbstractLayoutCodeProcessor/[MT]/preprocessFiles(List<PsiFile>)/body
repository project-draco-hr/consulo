{
  ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  String oldText=null;
  double oldFraction=0;
  if (progress != null) {
    oldText=progress.getText();
    oldFraction=progress.getFraction();
    progress.setText(myProgressText);
  }
  final Runnable[] runnables=new Runnable[files.size()];
  for (int i=0; i < files.size(); i++) {
    PsiFile file=files.get(i);
    if (progress != null) {
      if (progress.isCanceled())       return null;
      progress.setFraction((double)i / files.size());
    }
    if (file.isWritable()) {
      try {
        runnables[i]=preprocessFile(file);
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
    files.set(i,null);
  }
  if (progress != null) {
    progress.setText(oldText);
    progress.setFraction(oldFraction);
  }
  return new Runnable(){
    public void run(){
      for (      Runnable runnable : runnables) {
        if (runnable != null) {
          runnable.run();
        }
      }
    }
  }
;
}
