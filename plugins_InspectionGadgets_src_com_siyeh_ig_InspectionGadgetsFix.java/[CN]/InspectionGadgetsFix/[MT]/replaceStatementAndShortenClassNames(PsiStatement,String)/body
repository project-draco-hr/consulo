{
  final PsiManager psiManager=statement.getManager();
  PsiStatement newStatement;
  final CodeStyleManager styleManager=psiManager.getCodeStyleManager();
  if (PsiUtil.isInJspFile(statement)) {
    PsiDocumentManager documentManager=PsiDocumentManager.getInstance(psiManager.getProject());
    JspFile file=PsiUtil.getJspFile(statement);
    Document document=documentManager.getDocument(file);
    TextRange textRange=statement.getTextRange();
    document.replaceString(textRange.getStartOffset(),textRange.getEndOffset(),newStatementText);
    documentManager.commitDocument(document);
    JspxFileViewProvider viewProvider=file.getViewProvider();
    PsiElement elementAt=viewProvider.findElementAt(textRange.getStartOffset(),StdLanguages.JAVA);
    int endOffset=textRange.getStartOffset() + newStatementText.length();
    while (elementAt.getTextRange().getEndOffset() < endOffset || !(elementAt instanceof PsiStatement)) {
      elementAt=elementAt.getParent();
      if (elementAt == null) {
        LOG.error("Cannot decode statement");
        return;
      }
    }
    newStatement=(PsiStatement)elementAt;
    styleManager.shortenClassReferences(newStatement);
    styleManager.reformatRange(viewProvider.getPsi(viewProvider.getBaseLanguage()),newStatement.getTextRange().getStartOffset(),newStatement.getTextRange().getEndOffset());
  }
 else {
    final PsiElementFactory factory=psiManager.getElementFactory();
    newStatement=factory.createStatementFromText(newStatementText,statement);
    newStatement=(PsiStatement)statement.replace(newStatement);
    styleManager.shortenClassReferences(newStatement);
    styleManager.reformat(newStatement);
  }
}
