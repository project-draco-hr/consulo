{
  myProject=e.getData(PlatformDataKeys.PROJECT);
  if (myProject == null) {
    myProject=ProjectManager.getInstance().getDefaultProject();
  }
  final HgInitDialog hgInitDialog=new HgInitDialog(myProject);
  hgInitDialog.show();
  if (!hgInitDialog.isOK()) {
    return;
  }
  final VirtualFile selectedRoot=hgInitDialog.getSelectedFolder();
  if (selectedRoot == null) {
    return;
  }
  final VirtualFile vcsRoot=HgUtil.getNearestHgRoot(selectedRoot);
  VirtualFile mapRoot=selectedRoot;
  boolean needToCreateRepo=false;
  if (vcsRoot != null) {
    final HgInitAlreadyUnderHgDialog dialog=new HgInitAlreadyUnderHgDialog(myProject,selectedRoot.getPresentableUrl(),vcsRoot.getPresentableUrl());
    dialog.show();
    if (!dialog.isOK()) {
      return;
    }
    if (dialog.getAnswer() == HgInitAlreadyUnderHgDialog.Answer.USE_PARENT_REPO) {
      mapRoot=vcsRoot;
    }
 else     if (dialog.getAnswer() == HgInitAlreadyUnderHgDialog.Answer.CREATE_REPO_HERE) {
      needToCreateRepo=true;
    }
  }
 else {
    needToCreateRepo=true;
  }
  if (needToCreateRepo) {
    createRepository(selectedRoot,mapRoot);
  }
 else {
    updateDirectoryMappings(mapRoot);
  }
}
