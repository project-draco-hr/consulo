{
  final HashSet<PsiFile> psiFiles=new HashSet<PsiFile>();
  final List<Module> modules=new ArrayList<Module>(files.keySet());
  Collections.sort(modules,new Comparator<Module>(){
    public int compare(    final Module o1,    final Module o2){
      return o1.getName().compareTo(o2.getName());
    }
  }
);
  for (  Module module : modules) {
    DefaultMutableTreeNode moduleNode=createFileNode(module);
    root.add(moduleNode);
    if (files.containsKey(module)) {
      List<PsiFile> moduleFiles=new ArrayList<PsiFile>(files.get(module));
      MultiMap<FileType,PsiFile> filesByType=new MultiMap<FileType,PsiFile>();
      for (      PsiFile file : moduleFiles) {
        filesByType.putValue(file.getFileType(),file);
      }
      if (hasNonEmptyGroups(filesByType)) {
        for (        Map.Entry<FileType,Collection<PsiFile>> entry : filesByType.entrySet()) {
          DefaultMutableTreeNode fileTypeNode=createFileNode(entry.getKey());
          moduleNode.add(fileTypeNode);
          addChildrenFiles(psiFiles,fileTypeNode,new ArrayList<PsiFile>(entry.getValue()));
        }
      }
 else {
        addChildrenFiles(psiFiles,moduleNode,moduleFiles);
      }
    }
  }
  for (  VirtualFile file : jars.keySet()) {
    final List<PsiFile> list=new ArrayList<PsiFile>(jars.get(file));
    final PsiFile jar=list.get(0).getManager().findFile(file);
    if (jar != null) {
      final DefaultMutableTreeNode jarNode=createFileNode(jar);
      root.add(jarNode);
      Collections.sort(list,FILE_COMPARATOR);
      for (      PsiFile psiFile : list) {
        jarNode.add(createFileNode(psiFile));
        psiFiles.add(psiFile);
      }
    }
  }
  return psiFiles;
}
