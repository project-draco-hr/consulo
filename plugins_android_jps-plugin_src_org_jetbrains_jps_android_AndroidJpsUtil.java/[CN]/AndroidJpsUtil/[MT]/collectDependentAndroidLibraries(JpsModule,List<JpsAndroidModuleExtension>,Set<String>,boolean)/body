{
  final List<JpsDependencyElement> dependencies=new ArrayList<JpsDependencyElement>(JpsJavaExtensionService.getInstance().getDependencies(module,JpsJavaClasspathKind.PRODUCTION_RUNTIME,false));
  for (int i=dependencies.size() - 1; i >= 0; i--) {
    final JpsDependencyElement item=dependencies.get(i);
    if (item instanceof JpsModuleDependency) {
      final JpsModule depModule=((JpsModuleDependency)item).getModule();
      if (depModule != null) {
        final JpsAndroidModuleExtension depExtension=getExtension(depModule);
        if (depExtension != null && (!librariesOnly || depExtension.isLibrary()) && visitedSet.add(depModule.getName())) {
          collectDependentAndroidLibraries(depModule,result,visitedSet,librariesOnly);
          result.add(0,depExtension);
        }
      }
    }
  }
}
