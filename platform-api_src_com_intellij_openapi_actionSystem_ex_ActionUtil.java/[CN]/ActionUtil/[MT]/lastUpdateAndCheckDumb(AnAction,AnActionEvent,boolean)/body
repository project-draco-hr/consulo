{
  performDumbAwareUpdate(action,e,true);
  if (DumbService.getInstance().isDumb() && !(action instanceof DumbAware)) {
    if (Boolean.FALSE.equals(e.getPresentation().getClientProperty(WOULD_BE_ENABLED_IF_NOT_DUMB_MODE))) {
      return false;
    }
    if (visibilityMatters && Boolean.FALSE.equals(e.getPresentation().getClientProperty(WOULD_BE_VISIBLE_IF_NOT_DUMB_MODE))) {
      return false;
    }
    showDumbModeWarning(e);
    return false;
  }
  if (!e.getPresentation().isEnabled()) {
    return false;
  }
  if (visibilityMatters && !e.getPresentation().isVisible()) {
    return false;
  }
  return true;
}
