{
  if (file instanceof VirtualFileWindow) {
    final VirtualFileWindow window=(VirtualFileWindow)file;
    file=window.getDelegate();
  }
  VirtualFile originalFile=file instanceof LightVirtualFile ? ((LightVirtualFile)file).getOriginalFile() : null;
  if (Comparing.equal(originalFile,file))   originalFile=null;
  if (file != null) {
    final T pushedValue=pusherKey == null ? null : file.getUserData(pusherKey);
    if (pushedValue != null)     return pushedValue;
  }
  if (originalFile != null) {
    final T pushedValue=pusherKey == null ? null : originalFile.getUserData(pusherKey);
    if (pushedValue != null)     return pushedValue;
  }
  if (mappings == null)   return null;
synchronized (mappings) {
    for (VirtualFile cur=file; ; cur=cur.getParent()) {
      T t=mappings.get(cur);
      if (t != null)       return t;
      if (originalFile != null) {
        t=mappings.get(originalFile);
        if (t != null)         return t;
        originalFile=originalFile.getParent();
      }
      if (cur == null)       break;
    }
  }
  return null;
}
