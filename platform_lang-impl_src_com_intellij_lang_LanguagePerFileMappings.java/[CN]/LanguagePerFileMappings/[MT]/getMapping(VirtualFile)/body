{
  if (file instanceof VirtualFileWindow) {
    final VirtualFileWindow window=(VirtualFileWindow)file;
    file=window.getDelegate();
  }
  VirtualFile originalFile=file instanceof LightVirtualFile ? ((LightVirtualFile)file).getOriginalFile() : null;
  if (Comparing.equal(originalFile,file))   originalFile=null;
  if (file != null) {
    final FilePropertyPusher<T> pusher=getFilePropertyPusher();
    final T pushedValue=pusher == null ? null : file.getUserData(pusher.getFileDataKey());
    if (pushedValue != null)     return pushedValue;
  }
  if (originalFile != null) {
    final FilePropertyPusher<T> pusher=getFilePropertyPusher();
    final T pushedValue=pusher == null ? null : originalFile.getUserData(pusher.getFileDataKey());
    if (pushedValue != null)     return pushedValue;
  }
synchronized (myMappings) {
    for (VirtualFile cur=file; ; cur=cur.getParent()) {
      T dialect=myMappings.get(cur);
      if (dialect != null)       return dialect;
      if (originalFile != null) {
        dialect=myMappings.get(originalFile);
        if (dialect != null)         return dialect;
        originalFile=originalFile.getParent();
      }
      if (cur == null)       break;
    }
  }
  return getDefaultMapping(file);
}
