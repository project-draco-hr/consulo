{
  SmartPsiElementPointer<PsiClass> pointer=SmartPointerManager.getInstance(file.getProject()).createSmartPsiElementPointer(aClass);
  LOG.assertTrue(CommandProcessor.getInstance().getCurrentCommand() != null);
  LOG.assertTrue(ApplicationManager.getApplication().isUnitTestMode() || ApplicationManager.getApplication().getCurrentWriteAction(null) != null);
  final PsiManager manager=file.getManager();
  final Document document=FileDocumentManager.getInstance().getDocument(file.getViewProvider().getVirtualFile());
  int newStartOffset=startOffset;
  final PsiReference reference=file.findReferenceAt(startOffset);
  if (reference != null) {
    final PsiElement resolved=reference.resolve();
    if (resolved instanceof PsiClass) {
      if (((PsiClass)resolved).getQualifiedName() == null || manager.areElementsEquivalent(aClass,resolved))       return newStartOffset;
    }
  }
  String name=aClass.getName();
  document.replaceString(startOffset,endOffset,name);
  final RangeMarker toDelete=insertSpace(endOffset,document);
  PsiDocumentManager.getInstance(manager.getProject()).commitAllDocuments();
  PsiElement element=file.findElementAt(startOffset);
  if (element instanceof PsiIdentifier) {
    PsiElement parent=element.getParent();
    if (parent instanceof PsiJavaCodeReferenceElement && !((PsiJavaCodeReferenceElement)parent).isQualified()) {
      PsiJavaCodeReferenceElement ref=(PsiJavaCodeReferenceElement)parent;
      if (!aClass.getManager().areElementsEquivalent(aClass,resolveReference(ref))) {
        final PsiElement pointerElement=pointer.getElement();
        if (pointerElement instanceof PsiClass) {
          PsiElement newElement;
          if (!(ref instanceof PsiImportStaticReferenceElement)) {
            newElement=ref.bindToElement(pointerElement);
          }
 else {
            newElement=((PsiImportStaticReferenceElement)ref).bindToTargetClass((PsiClass)pointerElement);
          }
          RangeMarker marker=document.createRangeMarker(newElement.getTextRange());
          CodeInsightUtilBase.forcePsiPostprocessAndRestoreElement(newElement);
          newStartOffset=marker.getStartOffset();
        }
      }
    }
  }
  if (toDelete.isValid()) {
    document.deleteString(toDelete.getStartOffset(),toDelete.getEndOffset());
  }
  return newStartOffset;
}
