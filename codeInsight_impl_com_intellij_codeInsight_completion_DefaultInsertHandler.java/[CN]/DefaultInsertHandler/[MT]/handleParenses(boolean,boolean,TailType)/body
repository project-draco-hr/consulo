{
  final CodeInsightSettings settings=CodeInsightSettings.getInstance();
  final boolean generateAnonymousBody=myLookupItem.getAttribute(LookupItem.GENERATE_ANONYMOUS_BODY_ATTR) != null;
  boolean insertRightParenth=(!settings.INSERT_SINGLE_PARENTH || settings.INSERT_DOUBLE_PARENTH_WHEN_NO_ARGS && !hasParams || generateAnonymousBody || tailType != TailType.NONE) && tailType != TailTypes.SMART_COMPLETION;
  if (needParenth) {
    if (myContext.getOffsetMap().getOffset(JavaCompletionUtil.LPAREN_OFFSET) >= 0) {
      myState.tailOffset=myContext.getOffsetMap().getOffset(JavaCompletionUtil.ARG_LIST_END_OFFSET);
      if (myContext.getOffsetMap().getOffset(JavaCompletionUtil.RPAREN_OFFSET) < 0 && insertRightParenth) {
        myDocument.insertString(myState.tailOffset,")");
        myState.tailOffset+=1;
      }
      if (hasParams) {
        myState.caretOffset=myContext.getOffsetMap().getOffset(JavaCompletionUtil.LPAREN_OFFSET) + 1;
      }
 else {
        myState.caretOffset=myContext.getOffsetMap().getOffset(JavaCompletionUtil.ARG_LIST_END_OFFSET);
      }
    }
 else {
      final CodeStyleSettings styleSettings=CodeStyleSettingsManager.getSettings(myProject);
      myState.tailOffset=myContext.getSelectionEndOffset();
      myState.caretOffset=myContext.getSelectionEndOffset();
      if (styleSettings.SPACE_BEFORE_METHOD_CALL_PARENTHESES) {
        myDocument.insertString(myState.tailOffset++," ");
        myState.caretOffset++;
      }
      if (insertRightParenth) {
        final CharSequence charsSequence=myDocument.getCharsSequence();
        if (charsSequence.length() <= myState.tailOffset || charsSequence.charAt(myState.tailOffset) != '(') {
          myDocument.insertString(myState.tailOffset,"(");
        }
        myDocument.insertString(myState.tailOffset + 1,")");
        if (hasParams) {
          myState.tailOffset+=2;
          myState.caretOffset++;
        }
 else {
          if (tailType != TailTypes.CALL_RPARENTH || generateAnonymousBody) {
            myState.tailOffset+=2;
            myState.caretOffset+=2;
          }
 else {
            myState.tailOffset++;
            myState.caretOffset++;
          }
        }
      }
 else {
        myDocument.insertString(myState.tailOffset++,"(");
        myState.caretOffset++;
      }
      if (hasParams && styleSettings.SPACE_WITHIN_METHOD_CALL_PARENTHESES) {
        myDocument.insertString(myState.caretOffset++," ");
        myState.tailOffset++;
      }
    }
  }
}
