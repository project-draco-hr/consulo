{
  Template template=(Template)myLookupItem.getObject();
  final RangeMarker offsetRangeMarker=myContext.editor.getDocument().createRangeMarker(templateStartOffset,templateStartOffset);
  TemplateManager.getInstance(myProject).startTemplate(myContext.editor,template,new TemplateEditingAdapter(){
    public void templateFinished(    Template template){
      myLookupItem.setAttribute(EXPANDED_TEMPLATE_ATTR,Boolean.TRUE);
      if (!offsetRangeMarker.isValid())       return;
      final Editor editor=myContext.editor;
      final int startOffset=offsetRangeMarker.getStartOffset();
      final int endOffset=editor.getCaretModel().getOffset();
      String lookupString=editor.getDocument().getCharsSequence().subSequence(startOffset,endOffset).toString();
      myLookupItem.setLookupString(lookupString);
      CompletionContext newContext=new CompletionContextImpl(myContext.project,editor,myContext.file,startOffset,endOffset);
      handleInsert(newContext,myStartOffset,myLookupData,myLookupItem,signatureSelected,completionChar);
    }
  }
);
}
