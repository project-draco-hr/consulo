{
  Template template=(Template)myLookupItem.getObject();
  final RangeMarker offsetRangeMarker=myContext.editor.getDocument().createRangeMarker(templateStartOffset,templateStartOffset);
  TemplateManager.getInstance(myProject).startTemplate(myContext.editor,template,new TemplateEditingAdapter(){
    public void templateFinished(    Template template){
      myLookupItem.setAttribute(EXPANDED_TEMPLATE_ATTR,Boolean.TRUE);
      if (!offsetRangeMarker.isValid())       return;
      final int offset=offsetRangeMarker.getStartOffset();
      String lookupString=myContext.editor.getDocument().getCharsSequence().subSequence(offset,myContext.editor.getCaretModel().getOffset()).toString();
      myLookupItem.setLookupString(lookupString);
      CompletionContext newContext=new CompletionContext(myContext.project,myContext.editor,myContext.file,offset,offset);
      handleInsert(newContext,myStartOffset,myLookupData,myLookupItem,signatureSelected,completionChar);
    }
  }
);
}
