{
  Template template=(Template)myLookupItem.getObject();
  myDocument.replaceString(templateStartOffset,templateStartOffset + myLookupItem.getLookupString().length(),"");
  final RangeMarker offsetRangeMarker=myContext.editor.getDocument().createRangeMarker(templateStartOffset,templateStartOffset);
  TemplateManager.getInstance(myProject).startTemplate(myContext.editor,template,new TemplateEditingAdapter(){
    public void templateFinished(    Template template){
      myLookupItem.setAttribute(EXPANDED_TEMPLATE_ATTR,Boolean.TRUE);
      if (!offsetRangeMarker.isValid())       return;
      final Editor editor=myContext.editor;
      final int startOffset=offsetRangeMarker.getStartOffset();
      final int endOffset=editor.getCaretModel().getOffset();
      String lookupString=editor.getDocument().getCharsSequence().subSequence(startOffset,endOffset).toString();
      myLookupItem.setLookupString(lookupString);
      final OffsetMap offsetMap=myContext.getOffsetMap();
      offsetMap.addOffset(CompletionInitializationContext.SELECTION_END_OFFSET,endOffset);
      offsetMap.addOffset(CompletionInitializationContext.IDENTIFIER_END_OFFSET,endOffset);
      CompletionContext newContext=new CompletionContext(myContext.project,editor,myContext.file,offsetMap);
      JavaCompletionUtil.initOffsets(myFile,myProject,offsetMap);
      handleInsert(newContext,myContext.getStartOffset(),myLookupData,myLookupItem,signatureSelected,completionChar);
    }
  }
);
}
