{
  final SelectionModel selectionModel=editor.getSelectionModel();
  if (selectionModel.hasSelection()) {
    VisualPosition startPosition=selectionModel.getSelectionStartPosition();
    if (editor.isColumnMode() && editor.getCaretModel().supportsMultipleCarets() && startPosition != null) {
      editor.getCaretModel().moveToVisualPosition(startPosition);
    }
 else {
      editor.getCaretModel().moveToOffset(selectionModel.getSelectionStart(),true);
    }
  }
  editor.getSoftWrapModel().beforeDocumentChangeAtCaret();
  int oldOffset=editor.getCaretModel().getOffset();
  String filler=calcStringToFillVirtualSpace(editor);
  if (filler.length() > 0) {
    s=filler + s;
  }
  Document document=editor.getDocument();
  if (editor.isInsertMode() || !toProcessOverwriteMode) {
    if (selectionModel.hasSelection()) {
      oldOffset=selectionModel.getSelectionStart();
      document.replaceString(selectionModel.getSelectionStart(),selectionModel.getSelectionEnd(),s);
    }
 else {
      document.insertString(oldOffset,s);
    }
  }
 else {
    deleteSelectedText(editor);
    int lineNumber=editor.getCaretModel().getLogicalPosition().line;
    if (lineNumber >= document.getLineCount()) {
      return insertStringAtCaretNoScrolling(editor,s,false,toMoveCaret,s.length());
    }
    int endOffset=document.getLineEndOffset(lineNumber);
    document.replaceString(oldOffset,Math.min(endOffset,oldOffset + s.length()),s);
  }
  int offset=oldOffset + filler.length() + caretShift;
  if (toMoveCaret) {
    editor.getCaretModel().moveToOffset(offset,true);
    selectionModel.removeSelection();
  }
 else   if (editor.getCaretModel().getOffset() != oldOffset) {
    editor.getCaretModel().moveToOffset(oldOffset);
  }
  return offset;
}
