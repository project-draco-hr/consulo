{
  final Document document=doc instanceof DocumentWindow ? ((DocumentWindow)doc).getDelegate() : doc;
  if (isUncommited(document)) {
synchronized (myListeners) {
      List<Runnable> list=document.getUserData(ACTION_AFTER_COMMIT);
      if (list == null) {
        document.putUserData(ACTION_AFTER_COMMIT,list=new SmartList<Runnable>());
      }
      list.add(action);
    }
  }
 else {
    action.run();
  }
}
