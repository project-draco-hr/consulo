{
  document.putUserData(TEMP_TREE_IN_DOCUMENT_KEY,null);
  TextBlock textBlock=getTextBlock(document,file);
  if (textBlock.isEmpty())   return false;
  myIsCommitInProgress=true;
  try {
    if (true) {
      if (mySmartPointerManager != null) {
        SmartPointerManagerImpl.synchronizePointers(file);
      }
      ASTNode treeElement=((PsiFileImpl)file).calcTreeElement();
      if (textBlock.isEmpty())       return false;
      textBlock.lock();
      final CharSequence chars=document.getCharsSequence();
      final Boolean data=document.getUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY);
      if (data != null) {
        document.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,null);
        file.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,data);
      }
      if (file.getViewProvider().supportsIncrementalReparse(file.getLanguage())) {
        int startOffset=textBlock.getStartOffset();
        int endOffset=textBlock.getTextEndOffset();
        int psiEndOffset=textBlock.getPsiEndOffset();
        myBlockSupport.reparseRange(file,startOffset,psiEndOffset,endOffset - psiEndOffset,chars);
      }
 else {
        myBlockSupport.reparseRange(file,0,document.getTextLength(),document.getTextLength() - file.getTextLength(),chars);
      }
    }
    textBlock.unlock();
    textBlock.clear();
  }
  finally {
    myIsCommitInProgress=false;
  }
  return true;
}
