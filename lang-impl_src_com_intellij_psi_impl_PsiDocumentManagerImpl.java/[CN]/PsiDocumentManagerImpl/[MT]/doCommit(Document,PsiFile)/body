{
  ApplicationManager.getApplication().runWriteAction(new CommitToPsiFileAction(){
    public void run(){
      if (isCommittingDocument(document))       return;
      document.putUserData(KEY_COMMITING,Boolean.TRUE);
      try {
        boolean hasCommits=false;
        final FileViewProvider viewProvider=getCachedViewProvider(document);
        if (viewProvider != null) {
          final List<PsiFile> psiFiles=viewProvider.getAllFiles();
          for (          PsiFile file : psiFiles) {
            if (file.isValid() && file != excludeFile) {
              hasCommits|=commit(document,file);
            }
          }
        }
        myUncommittedDocuments.remove(document);
        if (hasCommits) {
          InjectedLanguageUtil.commitAllInjectedDocuments(document,myProject);
          viewProvider.contentsSynchronized();
        }
      }
  finally {
        document.putUserData(KEY_COMMITING,null);
      }
    }
  }
);
}
