{
  final WrapImpl wrap=((WrapImpl)rootBlock.getWrap());
  if (wrap != null) {
    wrap.registerParent(currentWrapParent);
    currentWrapParent=wrap;
  }
  final int blockStartOffset=textRange.getStartOffset();
  if (parent != null) {
    if (textRange.getStartOffset() < parent.getTextRange().getStartOffset()) {
      LOG.assertTrue(false,FormatterImpl.getText(myModel));
    }
    if (textRange.getEndOffset() > parent.getTextRange().getEndOffset()) {
      LOG.assertTrue(false,FormatterImpl.getText(myModel));
    }
  }
  myCurrentWhiteSpace.append(blockStartOffset,myModel,myOptions);
  boolean isReadOnly=isReadOnly(textRange);
  if (isReadOnly) {
    return processSimpleBlock(rootBlock,parent,isReadOnly,textRange,index);
  }
 else {
    final List<Block> subBlocks=rootBlock.getSubBlocks();
    if (subBlocks.isEmpty()) {
      return processSimpleBlock(rootBlock,parent,isReadOnly,textRange,index);
    }
 else {
      return processCompositeBlock(rootBlock,parent,textRange,index,subBlocks,currentWrapParent);
    }
  }
}
