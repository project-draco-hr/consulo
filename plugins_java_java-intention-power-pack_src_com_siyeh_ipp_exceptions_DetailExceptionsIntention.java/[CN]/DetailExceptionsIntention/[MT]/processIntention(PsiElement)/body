{
  final PsiJavaToken token=(PsiJavaToken)element;
  PsiElement parent=token.getParent();
  if (parent instanceof PsiCatchSection) {
    parent=parent.getParent();
  }
  if (!(parent instanceof PsiTryStatement)) {
    return;
  }
  final PsiTryStatement tryStatement=(PsiTryStatement)parent;
  @NonNls final StringBuilder newTryStatement=new StringBuilder("try");
  final Set<PsiType> exceptionsThrown=new HashSet<PsiType>();
  final PsiResourceList resourceList=tryStatement.getResourceList();
  if (resourceList != null) {
    newTryStatement.append(resourceList.getText());
    ExceptionUtils.calculateExceptionsThrownForResourceList(resourceList,exceptionsThrown);
  }
  final PsiCodeBlock tryBlock=tryStatement.getTryBlock();
  if (tryBlock == null) {
    return;
  }
  final String tryBlockText=tryBlock.getText();
  newTryStatement.append(tryBlockText);
  ExceptionUtils.calculateExceptionsThrownForCodeBlock(tryBlock,exceptionsThrown);
  final Comparator<PsiType> comparator=new HierarchicalTypeComparator();
  final List<PsiType> exceptionsAlreadyEmitted=new ArrayList<PsiType>();
  final PsiCatchSection[] catchSections=tryStatement.getCatchSections();
  for (  PsiCatchSection catchSection : catchSections) {
    final PsiParameter parameter=catchSection.getParameter();
    final PsiCodeBlock block=catchSection.getCatchBlock();
    if (parameter != null && block != null) {
      final PsiType caughtType=parameter.getType();
      final List<PsiType> exceptionsToExpand=new ArrayList<PsiType>(10);
      for (      Object aExceptionsThrown : exceptionsThrown) {
        final PsiType thrownType=(PsiType)aExceptionsThrown;
        if (caughtType.isAssignableFrom(thrownType)) {
          exceptionsToExpand.add(thrownType);
        }
      }
      exceptionsToExpand.removeAll(exceptionsAlreadyEmitted);
      Collections.sort(exceptionsToExpand,comparator);
      for (      PsiType thrownType : exceptionsToExpand) {
        newTryStatement.append("catch(").append(thrownType.getCanonicalText()).append(' ').append(parameter.getName()).append(')');
        newTryStatement.append(block.getText());
        exceptionsAlreadyEmitted.add(thrownType);
      }
    }
  }
  final PsiCodeBlock finallyBlock=tryStatement.getFinallyBlock();
  if (finallyBlock != null) {
    newTryStatement.append("finally").append(finallyBlock.getText());
  }
  final String newStatement=newTryStatement.toString();
  replaceStatementAndShorten(newStatement,tryStatement);
}
