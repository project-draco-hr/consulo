{
  final TestNGConsoleView console=new TestNGConsoleView(config,runnerSettings,myConfigurationPerRunnerSettings);
  console.initUI();
  ProcessHandler processHandler=startProcess();
  processHandler.addProcessListener(new ProcessAdapter(){
    @Override public void processTerminated(    final ProcessEvent event){
      client.stopTest();
      if (myCurrentCoverageSuite != null) {
        CoverageDataManager coverageDataManager=CoverageDataManager.getInstance(config.getProject());
        coverageDataManager.coverageGathered(myCurrentCoverageSuite);
      }
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          final TestFrameworkRunningModel model=console.getModel();
          final int failed=model != null ? Filter.DEFECTIVE_LEAF.and(JavaAwareFilter.METHOD(config.getProject())).select(model.getRoot().getAllTests()).size() : -1;
          ToolWindowManager.getInstance(config.getProject()).notifyByBalloon(console.getProperties().isDebug() ? ToolWindowId.DEBUG : ToolWindowId.RUN,failed == -1 ? MessageType.WARNING : (failed > 0 ? MessageType.ERROR : MessageType.INFO),failed == -1 ? "Tests were not started" : (failed > 0 ? failed + " Tests failed" : "Tests passed"),null,null);
        }
      }
);
    }
    @Override public void startNotified(    final ProcessEvent event){
      TestNGRemoteListener listener=new TestNGRemoteListener(console);
      client.startListening(listener,listener,port);
    }
    @Override public void processWillTerminate(    ProcessEvent event,    boolean willBeDestroyed){
      console.getResultsView().finish();
    }
    @Override public void onTextAvailable(    final ProcessEvent event,    final Key outputType){
      console.print(event.getText(),ConsoleViewContentType.getConsoleViewType(outputType));
    }
  }
);
  console.attachToProcess(processHandler);
  RerunFailedTestsAction rerunFailedTestsAction=new RerunFailedTestsAction(console.getComponent());
  rerunFailedTestsAction.init(console.getProperties(),runnerSettings,myConfigurationPerRunnerSettings);
  rerunFailedTestsAction.setModelProvider(new Getter<TestFrameworkRunningModel>(){
    public TestFrameworkRunningModel get(){
      return console.getModel();
    }
  }
);
  final DefaultExecutionResult result=new DefaultExecutionResult(console,processHandler);
  result.setRestartActions(rerunFailedTestsAction);
  return result;
}
