{
  final Project project=config.getProject();
  final JavaParameters javaParameters=new JavaParameters();
  javaParameters.setupEnvs(config.getPersistantData().getEnvs(),config.getPersistantData().PASS_PARENT_ENVS);
  javaParameters.getVMParametersList().add("-ea");
  javaParameters.setMainClass("org.testng.RemoteTestNGStarter");
  javaParameters.setWorkingDirectory(config.getProperty(RunJavaConfiguration.WORKING_DIRECTORY_PROPERTY));
  javaParameters.getClassPath().add(PathUtil.getJarPathForClass(RemoteTestNGStarter.class));
  Module module=config.getConfigurationModule().getModule();
  LanguageLevel effectiveLanguageLevel=module == null ? LanguageLevelProjectExtension.getInstance(project).getLanguageLevel() : LanguageLevelUtil.getEffectiveLanguageLevel(module);
  final boolean is15=effectiveLanguageLevel != LanguageLevel.JDK_1_4 && effectiveLanguageLevel != LanguageLevel.JDK_1_3;
  LOG.info("Language level is " + effectiveLanguageLevel.toString());
  LOG.info("is15 is " + is15);
  javaParameters.getClassPath().add(is15 ? PathUtil.getJarPathForClass(AfterClass.class) : new File(PathManager.getPreinstalledPluginsPath(),"testng/lib-jdk14/testng-jdk14.jar").getPath());
  JavaParametersUtil.configureConfiguration(javaParameters,config);
  Sdk jdk=module == null ? ProjectRootManager.getInstance(project).getProjectJdk() : ModuleRootManager.getInstance(module).getSdk();
  javaParameters.setJdk(jdk);
  final Object[] patchers=Extensions.getExtensions(ExtensionPoints.JUNIT_PATCHER);
  for (  Object patcher : patchers) {
    ((JUnitPatcher)patcher).patchJavaParameters(module,javaParameters);
  }
  JavaSdkUtil.addRtJar(javaParameters.getClassPath());
  for (  RunConfigurationExtension ext : Extensions.getExtensions(RunConfigurationExtension.EP_NAME)) {
    ext.updateJavaParameters(config,javaParameters,getRunnerSettings());
  }
  LOG.info("Test scope is: " + config.getPersistantData().getScope());
  if (config.getPersistantData().getScope() == TestSearchScope.WHOLE_PROJECT) {
    LOG.info("Configuring for whole project");
    JavaParametersUtil.configureProject(config.getProject(),javaParameters,JavaParameters.JDK_AND_CLASSES_AND_TESTS,config.ALTERNATIVE_JRE_PATH_ENABLED ? config.ALTERNATIVE_JRE_PATH : null);
  }
 else {
    LOG.info("Configuring for module:" + config.getConfigurationModule().getModuleName());
    JavaParametersUtil.configureModule(config.getConfigurationModule(),javaParameters,JavaParameters.JDK_AND_CLASSES_AND_TESTS,config.ALTERNATIVE_JRE_PATH_ENABLED ? config.ALTERNATIVE_JRE_PATH : null);
  }
  calculateServerPort();
  final TestData data=config.getPersistantData();
  javaParameters.getProgramParametersList().add(TestNGCommandLineArgs.PORT_COMMAND_OPT,String.valueOf(port));
  if (!is15) {
    javaParameters.getProgramParametersList().add(TestNGCommandLineArgs.ANNOTATIONS_COMMAND_OPT,"javadoc");
  }
  if (data.getOutputDirectory() != null && !"".equals(data.getOutputDirectory())) {
    javaParameters.getProgramParametersList().add(TestNGCommandLineArgs.OUTDIR_COMMAND_OPT,data.getOutputDirectory());
  }
  javaParameters.getProgramParametersList().add(TestNGCommandLineArgs.USE_DEFAULT_LISTENERS,String.valueOf(data.USE_DEFAULT_REPORTERS));
  @NonNls final StringBuilder buf=new StringBuilder();
  if (data.TEST_LISTENERS != null && !data.TEST_LISTENERS.isEmpty()) {
    buf.append(StringUtil.join(data.TEST_LISTENERS,";"));
  }
  for (  Object o : Extensions.getExtensions(IDEATestNGListener.EP_NAME)) {
    boolean enabled=true;
    for (    RunConfigurationExtension extension : Extensions.getExtensions(RunConfigurationExtension.EP_NAME)) {
      if (extension.isListenerDisabled(config,o)) {
        enabled=false;
        break;
      }
    }
    if (enabled) {
      if (buf.length() > 0)       buf.append(";");
      buf.append(o.getClass().getName());
      javaParameters.getClassPath().add(PathUtil.getJarPathForClass(o.getClass()));
    }
  }
  if (buf.length() > 0)   javaParameters.getProgramParametersList().add(TestNGCommandLineArgs.LISTENER_COMMAND_OPT,buf.toString());
  VirtualFile[] sources;
  if ((data.getScope() == TestSearchScope.WHOLE_PROJECT && TestType.PACKAGE.getType().equals(data.TEST_OBJECT)) || module == null) {
    sources=ProjectRootManager.getInstance(project).getContentSourceRoots();
  }
 else {
    sources=ModuleRootManager.getInstance(module).getSourceRoots();
  }
  if (sources.length > 0) {
    StringBuffer sb=new StringBuffer();
    for (int i=0; i < sources.length; i++) {
      VirtualFile source=sources[i];
      sb.append(source.getPath());
      if (i < sources.length - 1) {
        sb.append(';');
      }
    }
    javaParameters.getProgramParametersList().add(TestNGCommandLineArgs.SRC_COMMAND_OPT,sb.toString());
  }
  final Runnable runnable=new Runnable(){
    public void run(){
      Map<PsiClass,Collection<PsiMethod>> classes=new HashMap<PsiClass,Collection<PsiMethod>>();
      try {
        fillTestObjects(classes,project,is15);
        if (classes.size() > 0) {
          Map<String,Collection<String>> map=new HashMap<String,Collection<String>>();
          for (          final Map.Entry<PsiClass,Collection<PsiMethod>> entry : classes.entrySet()) {
            Collection<String> methods=new HashSet<String>(entry.getValue().size());
            for (            PsiMethod method : entry.getValue()) {
              methods.add(method.getName());
            }
            map.put(ApplicationManager.getApplication().runReadAction(new Computable<String>(){
              @Nullable public String compute(){
                return entry.getKey().getQualifiedName();
              }
            }
),methods);
          }
          Collection<String> groupNames=null;
          if (TestType.GROUP.getType().equals(data.TEST_OBJECT)) {
            String groupName=data.getGroupName();
            if (groupName != null && groupName.length() > 0) {
              groupNames=new HashSet<String>(1);
              groupNames.add(groupName);
            }
          }
          Map<String,String> testParams=buildTestParameters(data);
          String annotationType=data.ANNOTATION_TYPE;
          if (annotationType == null || "".equals(annotationType)) {
            annotationType=is15 ? TestNG.JDK_ANNOTATION_TYPE : TestNG.JAVADOC_ANNOTATION_TYPE;
          }
          LOG.info("Using annotationType of " + annotationType);
          int logLevel=1;
          try {
            final Properties properties=new Properties();
            properties.load(new ByteArrayInputStream(config.getPersistantData().VM_PARAMETERS.getBytes()));
            final String verbose=properties.getProperty("-Dtestng.verbose");
            if (verbose != null) {
              logLevel=Integer.parseInt(verbose);
            }
          }
 catch (          Exception e) {
            logLevel=1;
          }
          LaunchSuite suite=SuiteGenerator.createSuite(project.getName(),null,map,groupNames,testParams,annotationType,logLevel);
          File xmlFile=suite.save(new File(PathManager.getSystemPath()));
          String path=xmlFile.getAbsolutePath() + "\n";
          try {
            FileUtil.writeToFile(myTempFile,path.getBytes(),true);
          }
 catch (          IOException e) {
            LOG.error(e);
          }
        }
 else         if (TestType.SUITE.getType().equals(data.TEST_OBJECT)) {
          try {
            Collection<XmlSuite> suites;
            FileInputStream in=new FileInputStream(data.getSuiteName());
            try {
              suites=new Parser(in).parse();
            }
  finally {
              in.close();
            }
            for (            XmlSuite suite : suites) {
              Map<String,String> params=suite.getParameters();
              params.putAll(buildTestParameters(data));
              String annotationType=data.ANNOTATION_TYPE;
              if (annotationType != null && !"".equals(annotationType)) {
                suite.setAnnotations(annotationType);
              }
              LOG.info("Using annotationType of " + annotationType);
              final String fileId=(project.getName() + '_' + suite.getName()+ '_'+ Integer.toHexString(suite.getName().hashCode())+ ".xml").replace(' ','_');
              final File suiteFile=new File(PathManager.getSystemPath(),fileId);
              FileWriter fileWriter=new FileWriter(suiteFile);
              try {
                fileWriter.write(suite.toXml());
              }
  finally {
                fileWriter.close();
              }
              String path=suiteFile.getAbsolutePath() + "\n";
              FileUtil.writeToFile(myTempFile,path.getBytes(),true);
            }
          }
 catch (          Exception e) {
            throw new CantRunException("Unable to parse suite: " + e.getMessage());
          }
        }
        try {
          FileUtil.writeToFile(myTempFile,"end".getBytes(),true);
        }
 catch (        IOException e) {
          LOG.error(e);
        }
      }
 catch (      CantRunException e) {
        try {
          final String message="CantRunException" + e.getMessage();
          FileUtil.writeToFile(myTempFile,message.getBytes());
        }
 catch (        IOException e1) {
          LOG.error(e1);
        }
      }
    }
  }
;
  try {
    myTempFile=File.createTempFile("idea_testng",".tmp");
    myTempFile.deleteOnExit();
    javaParameters.getProgramParametersList().add("-temp",myTempFile.getAbsolutePath());
    ProgressManager.getInstance().run(new Task.Backgroundable(project,"Searching For Tests ...",true){
      public void run(      @NotNull ProgressIndicator indicator){
        runnable.run();
      }
    }
);
  }
 catch (  IOException e) {
    LOG.error(e);
  }
  if (runnerSettings.getData() instanceof DebuggingRunnerData) {
    ParametersList params=javaParameters.getVMParametersList();
    String hostname="localhost";
    try {
      hostname=InetAddress.getLocalHost().getHostName();
    }
 catch (    UnknownHostException e) {
    }
    params.add("-Xdebug");
    params.add("-Xrunjdwp:transport=dt_socket,address=" + hostname + ':'+ debugPort+ ",suspend=y,server=n");
  }
  return javaParameters;
}
