{
  final Dimension d=getPopupSize(popup);
  Rectangle popupRect=null;
  Rectangle r=positionRight(d);
  if (myScreenRect.contains(r)) {
    popupRect=r;
  }
  if (popupRect == null) {
    r=positionLeft(d);
    if (myScreenRect.contains(r)) {
      popupRect=r;
    }
  }
  if (popupRect == null) {
    r=positionAbove(d);
    if (myScreenRect.contains(r)) {
      popupRect=r;
    }
  }
  if (popupRect == null) {
    r=positionUnder(d);
    if (myScreenRect.contains(r)) {
      popupRect=r;
    }
  }
  if (popupRect != null) {
    if (popup.isVisible()) {
      popup.setLocation(new Point(r.x,r.y));
    }
 else {
      final Point p=new Point(r.x - myRelativeOnScreen.x,r.y - myRelativeOnScreen.y);
      popup.show(new RelativePoint(myRelativeTo,p));
    }
  }
 else {
    final List<Rectangle> boxes=new ArrayList<Rectangle>();
    boxes.add(crop(myScreenRect,new Rectangle(myRelativeOnScreen.x + myRelativeTo.getWidth() + GAP,myRelativeOnScreen.y,myScreenRect.width,myScreenRect.height)));
    boxes.add(crop(myScreenRect,new Rectangle(myScreenRect.x,myRelativeOnScreen.y,myRelativeOnScreen.x - myScreenRect.x - GAP,myScreenRect.height)));
    boxes.add(crop(myScreenRect,new Rectangle(myRelativeOnScreen.x,myScreenRect.y,myScreenRect.width,getYForTopPositioning() - myScreenRect.y - GAP)));
    boxes.add(crop(myScreenRect,new Rectangle(myRelativeOnScreen.x,myRelativeOnScreen.y + myRelativeTo.getHeight() + GAP,myScreenRect.width,myScreenRect.height)));
    Collections.sort(boxes,new Comparator<Rectangle>(){
      @Override public int compare(      final Rectangle o1,      final Rectangle o2){
        final int i=new Integer(o1.width).compareTo(o2.width);
        return i == 0 ? new Integer(o1.height).compareTo(o2.height) : i;
      }
    }
);
    final Rectangle suitableBox=boxes.get(boxes.size() - 1);
    final Rectangle crop=crop(suitableBox,new Rectangle(suitableBox.x < myRelativeOnScreen.x ? suitableBox.x + suitableBox.width - d.width : suitableBox.x,suitableBox.y < myRelativeOnScreen.y ? suitableBox.y + suitableBox.height - d.height : suitableBox.y,d.width,d.height));
    popup.setSize(crop.getSize());
    if (popup.isVisible()) {
      popup.setLocation(crop.getLocation());
    }
 else {
      popup.show(new RelativePoint(myRelativeTo,new Point(crop.getLocation().x - myRelativeOnScreen.x,crop.getLocation().y - myRelativeOnScreen.y)));
    }
  }
}
