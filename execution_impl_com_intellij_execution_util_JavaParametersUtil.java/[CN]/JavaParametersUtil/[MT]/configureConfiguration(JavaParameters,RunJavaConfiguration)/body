{
  final Project project=configuration.getProject();
  parameters.getProgramParametersList().addParametersString(configuration.getProperty(RunJavaConfiguration.PROGRAM_PARAMETERS_PROPERTY));
  final PathMacroManager macroManager=PathMacroManager.getInstance(project);
  String vmParameters=configuration.getProperty(RunJavaConfiguration.VM_PARAMETERS_PROPERTY);
  if (vmParameters != null) {
    vmParameters=macroManager.expandPath(vmParameters);
  }
  if (parameters.getEnv() != null) {
    final Map<String,String> envs=new HashMap<String,String>();
    for (    String env : parameters.getEnv().keySet()) {
      final String value=macroManager.expandPath(parameters.getEnv().get(env));
      envs.put(env,value);
      if (vmParameters != null) {
        vmParameters=StringUtil.replace(vmParameters,"$" + env + "$",value,false);
      }
    }
    parameters.setEnv(envs);
  }
  parameters.getVMParametersList().addParametersString(vmParameters);
  String workingDirectory=configuration.getProperty(RunJavaConfiguration.WORKING_DIRECTORY_PROPERTY);
  if (workingDirectory == null || workingDirectory.trim().length() == 0) {
    workingDirectory=PathUtil.getLocalPath(project.getBaseDir());
  }
  parameters.setWorkingDirectory(workingDirectory);
}
