{
  LOG.assertTrue(!myPsiDocumentManager.getProject().isDisposed());
  Pair<DocumentChangeTransaction,Integer> pair=myTransactionsMap.get(doc);
  if (pair == null) {
    final PsiFile psiFile=scope != null ? scope.getContainingFile() : null;
    pair=new Pair<DocumentChangeTransaction,Integer>(new DocumentChangeTransaction(doc,scope != null ? psiFile : null),0);
    myBus.syncPublisher(PsiDocumentTransactionListener.TOPIC).transactionStarted(doc,psiFile);
  }
 else {
    pair=new Pair<DocumentChangeTransaction,Integer>(pair.getFirst(),pair.getSecond().intValue() + 1);
  }
  myTransactionsMap.put(doc,pair);
}
