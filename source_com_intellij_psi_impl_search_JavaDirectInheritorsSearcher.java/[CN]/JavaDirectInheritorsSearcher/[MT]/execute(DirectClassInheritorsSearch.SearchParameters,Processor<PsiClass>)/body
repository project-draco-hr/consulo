{
  final PsiClass aClass=p.getClassToProcess();
  PsiManagerImpl psiManager=(PsiManagerImpl)PsiManager.getInstance(aClass.getProject());
  final SearchScope useScope=ApplicationManager.getApplication().runReadAction(new Computable<SearchScope>(){
    public SearchScope compute(){
      return aClass.getUseScope();
    }
  }
);
  String qualifiedName=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
    public String compute(){
      return aClass.getQualifiedName();
    }
  }
);
  if ("java.lang.Object".equals(qualifiedName)) {
    final SearchScope scope=useScope.intersectWith(GlobalSearchScope.notScope(GlobalSearchScope.getScopeRestrictedByFileTypes(GlobalSearchScope.allScope(psiManager.getProject()),StdFileTypes.JSP,StdFileTypes.JSPX)));
    return AllClassesSearch.search(scope,aClass.getProject()).forEach(new Processor<PsiClass>(){
      public boolean process(      final PsiClass psiClass){
        return consumer.process(psiClass);
      }
    }
);
  }
 else {
    final RepositoryManager repositoryManager=psiManager.getRepositoryManager();
    final RepositoryElementsManager repositoryElementsManager=psiManager.getRepositoryElementsManager();
    long[] candidateIds=ApplicationManager.getApplication().runReadAction(new Computable<long[]>(){
      public long[] compute(){
        RepositoryIndex repositoryIndex=repositoryManager.getIndex();
        final VirtualFileFilter rootFilter;
        if (useScope instanceof GlobalSearchScope) {
          rootFilter=repositoryIndex.rootFilterBySearchScope((GlobalSearchScope)useScope);
        }
 else {
          rootFilter=null;
        }
        final String qName=aClass.getQualifiedName();
        return repositoryIndex.getNameOccurrencesInExtendsLists(qName != null ? qName : aClass.getName(),rootFilter);
      }
    }
);
    final boolean includeAnonymous=p.includeAnonymous();
    final ClassView classView=repositoryManager.getClassView();
    for (    final long candidateId : candidateIds) {
      PsiClass candidate=ApplicationManager.getApplication().runReadAction(new Computable<PsiClass>(){
        public PsiClass compute(){
          if (!includeAnonymous && classView.isAnonymous(candidateId))           return null;
          final RepositoryPsiElement candidate=repositoryElementsManager.findOrCreatePsiElementById(candidateId);
          LOG.assertTrue(candidate == null || candidate.isValid());
          return (PsiClass)candidate;
        }
      }
);
      if (candidate != null && !consumer.process(candidate)) {
        return false;
      }
    }
  }
  return true;
}
