{
  final PsiClass aClass=p.getClassToProcess();
  PsiManagerImpl psiManager=(PsiManagerImpl)PsiManager.getInstance(aClass.getProject());
  RepositoryManager repositoryManager=psiManager.getRepositoryManager();
  RepositoryElementsManager repositoryElementsManager=psiManager.getRepositoryElementsManager();
  RepositoryIndex repositoryIndex=repositoryManager.getIndex();
  final SearchScope useScope=aClass.getUseScope();
  final VirtualFileFilter rootFilter;
  if (useScope instanceof GlobalSearchScope) {
    rootFilter=repositoryIndex.rootFilterBySearchScope((GlobalSearchScope)useScope);
  }
 else {
    rootFilter=null;
  }
  if ("java.lang.Object".equals(aClass.getQualifiedName())) {
    return psiManager.getSearchHelper().processAllClasses(new PsiElementProcessor<PsiClass>(){
      public boolean execute(      final PsiClass psiClass){
        PsiReferenceList extendsList=psiClass.getExtendsList();
        return consumer.process(psiClass);
      }
    }
,useScope);
  }
 else {
    long[] candidateIds=repositoryIndex.getNameOccurrencesInExtendsLists(aClass.getName(),rootFilter);
    for (    long candidateId : candidateIds) {
      PsiClass candidate=(PsiClass)repositoryElementsManager.findOrCreatePsiElementById(candidateId);
      LOG.assertTrue(candidate.isValid());
      if (!consumer.process(candidate)) {
        return false;
      }
    }
  }
  return true;
}
