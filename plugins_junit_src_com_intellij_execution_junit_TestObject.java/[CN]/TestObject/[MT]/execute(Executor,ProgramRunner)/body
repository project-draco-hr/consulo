{
  final JUnitProcessHandler handler=JUnitProcessHandler.runJava(getJavaParameters(),myProject);
  for (  final RunConfigurationExtension ext : Extensions.getExtensions(RunConfigurationExtension.EP_NAME)) {
    ext.handleStartProcess(myConfiguration,handler);
  }
  final TestProxy unboundOutputRoot=new TestProxy(new RootTestInfo());
  final JUnitConsoleProperties consoleProperties=new JUnitConsoleProperties(myConfiguration,executor);
  final JUnitTreeConsoleView consoleView=new JUnitTreeConsoleView(consoleProperties,getRunnerSettings(),getConfigurationSettings(),unboundOutputRoot);
  consoleView.initUI();
  consoleView.attachToProcess(handler);
  unboundOutputRoot.setPrinter(consoleView.getPrinter());
  Disposer.register(consoleView,unboundOutputRoot);
  final TestsPacketsReceiver packetsReceiver=new TestsPacketsReceiver(consoleView){
    @Override public void notifyStart(    TestProxy root){
      super.notifyStart(root);
      unboundOutputRoot.addChild(root);
      final JUnitRunningModel model=getModel();
      if (model != null) {
        handler.getOut().setDispatchListener(model.getNotifier());
        Disposer.register(model,new Disposable(){
          public void dispose(){
            handler.getOut().setDispatchListener(DispatchListener.DEAF);
          }
        }
);
        consoleView.attachToModel(model);
      }
    }
  }
;
  final DeferredActionsQueue queue=new DeferredActionsQueueImpl();
  handler.getOut().setPacketDispatcher(packetsReceiver,queue);
  handler.getErr().setPacketDispatcher(packetsReceiver,queue);
  handler.addProcessListener(new ProcessAdapter(){
    @Override public void processTerminated(    ProcessEvent event){
      handler.removeProcessListener(this);
      if (myTempFile != null) {
        FileUtil.delete(myTempFile);
      }
      if (myListenersFile != null) {
        FileUtil.delete(myListenersFile);
      }
      unboundOutputRoot.flush();
      IJSwingUtilities.invoke(new Runnable(){
        public void run(){
          packetsReceiver.checkTerminated();
          final JUnitRunningModel model=packetsReceiver.getModel();
          TestsUIUtil.notifyByBalloon(myProject,model != null ? model.getRoot() : null,consoleProperties);
        }
      }
);
    }
    @Override public void onTextAvailable(    final ProcessEvent event,    final Key outputType){
      final String text=event.getText();
      final ConsoleViewContentType consoleViewType=ConsoleViewContentType.getConsoleViewType(outputType);
      final Set<TestProxy> currentTests=packetsReceiver.getCurrentTests();
      final Printable printable=new Printable(){
        public void printOn(        final Printer printer){
          printer.print(text,consoleViewType);
        }
      }
;
      if (!currentTests.isEmpty()) {
        for (        TestProxy currentTest : currentTests) {
          currentTest.addLast(printable);
        }
      }
 else {
        unboundOutputRoot.addLast(printable);
      }
    }
  }
);
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    return new DefaultExecutionResult(null,handler);
  }
  final RerunFailedTestsAction rerunFailedTestsAction=new RerunFailedTestsAction(consoleView.getComponent());
  rerunFailedTestsAction.init(consoleProperties,myRunnerSettings,myConfigurationSettings);
  rerunFailedTestsAction.setModelProvider(new Getter<TestFrameworkRunningModel>(){
    public TestFrameworkRunningModel get(){
      return packetsReceiver.getModel();
    }
  }
);
  final DefaultExecutionResult result=new DefaultExecutionResult(consoleView,handler);
  result.setRestartActions(rerunFailedTestsAction);
  return result;
}
