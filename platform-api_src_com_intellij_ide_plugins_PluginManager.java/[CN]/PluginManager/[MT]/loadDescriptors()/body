{
  if (ClassloaderUtil.isLoadingOfExternalPluginsDisabled()) {
    return IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  final List<IdeaPluginDescriptorImpl> result=new ArrayList<IdeaPluginDescriptorImpl>();
  loadDescriptors(PathManager.getPluginsPath(),result);
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    loadDescriptors(PathManager.getPreinstalledPluginsPath(),result);
  }
  loadDescriptorsFromProperty(result);
  loadDescriptorsFromClassPath(result);
  IdeaPluginDescriptorImpl[] pluginDescriptors=result.toArray(new IdeaPluginDescriptorImpl[result.size()]);
  try {
    Arrays.sort(pluginDescriptors,new PluginDescriptorComparator(pluginDescriptors));
  }
 catch (  Exception e) {
    prepareLoadingPluginsErrorMessage(IdeBundle.message("error.plugins.were.not.loaded",e.getMessage()));
    getLogger().info(e);
    pluginDescriptors=IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  return pluginDescriptors;
}
