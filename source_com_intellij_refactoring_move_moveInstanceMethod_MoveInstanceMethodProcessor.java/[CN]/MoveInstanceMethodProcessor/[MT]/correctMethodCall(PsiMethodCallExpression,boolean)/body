{
  try {
    final PsiManager manager=myMethod.getManager();
    final PsiExpression oldQualifier=expression.getMethodExpression().getQualifierExpression();
    PsiExpression newQualifier=null;
    if (myTargetVariable instanceof PsiParameter) {
      final int index=myMethod.getParameterList().getParameterIndex((PsiParameter)myTargetVariable);
      final PsiExpression[] arguments=expression.getArgumentList().getExpressions();
      if (index < arguments.length) {
        if (isInternalCall && (oldQualifier == null || isTrivialThisQualifier(oldQualifier))) {
          LOG.assertTrue(myOldThisNeeded);
          newQualifier=manager.getElementFactory().createExpressionFromText(myOldClassParameterName,null);
        }
 else {
          newQualifier=(PsiExpression)arguments[index].copy();
        }
        arguments[index].delete();
      }
    }
 else {
      VisibilityUtil.escalateVisibility((PsiField)myTargetVariable,expression);
      newQualifier=manager.getElementFactory().createExpressionFromText(myTargetVariable.getName(),null);
    }
    if (myOldThisNeeded) {
      PsiExpression qualifier=expression.getMethodExpression().getQualifierExpression();
      if (qualifier == null)       qualifier=manager.getElementFactory().createExpressionFromText("this",null);
      expression.getArgumentList().add(qualifier);
    }
    if (newQualifier != null) {
      if (isTrivialThisQualifier(newQualifier)) {
        if (oldQualifier != null)         oldQualifier.delete();
      }
 else {
        final PsiReferenceExpression refExpr=(PsiReferenceExpression)manager.getElementFactory().createExpressionFromText("q." + myMethod.getName(),null);
        refExpr.getQualifierExpression().replace(newQualifier);
        expression.getMethodExpression().replace(refExpr);
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
