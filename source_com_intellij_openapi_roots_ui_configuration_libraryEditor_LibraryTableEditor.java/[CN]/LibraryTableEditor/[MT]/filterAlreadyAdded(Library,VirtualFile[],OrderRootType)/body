{
  if (files == null || files.length == 0) {
    return VirtualFile.EMPTY_ARRAY;
  }
  final Set<VirtualFile> chosenFilesSet=new HashSet<VirtualFile>(Arrays.asList(files));
  final Set<VirtualFile> alreadyAdded=new HashSet<VirtualFile>();
  if (lib == null) {
    final Library[] libraries=myTableModifiableModel.getLibraries();
    for (int idx=0; idx < libraries.length; idx++) {
      final VirtualFile[] libraryFiles=getLibraryEditor(libraries[idx]).getFiles(rootType);
      for (int i=0; i < libraryFiles.length; i++) {
        alreadyAdded.add(libraryFiles[i]);
      }
    }
  }
 else {
    final VirtualFile[] libraryFiles=getLibraryEditor(lib).getFiles(rootType);
    for (int i=0; i < libraryFiles.length; i++) {
      alreadyAdded.add(libraryFiles[i]);
    }
  }
  chosenFilesSet.removeAll(alreadyAdded);
  return chosenFilesSet.toArray(new VirtualFile[chosenFilesSet.size()]);
}
