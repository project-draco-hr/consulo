{
  final Set<VirtualFile> result=new HashSet<VirtualFile>();
  for (  final VirtualFile candidate : rootCandidates) {
    final Ref<List<VirtualFile>> roots=Ref.create(null);
    ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
      public void run(){
        List<VirtualFile> detectedRoots=JavaUtilForVfs.suggestRoots(candidate);
        if (!detectedRoots.isEmpty() && (detectedRoots.size() > 1 || detectedRoots.get(0) != candidate)) {
          roots.set(detectedRoots);
        }
      }
    }
,"Scanning for source roots",true,myProject);
    if (roots.get() == null) {
      result.add(candidate);
    }
 else {
      DetectedSourceRootsDialog dlg=new DetectedSourceRootsDialog(myProject,roots.get(),candidate);
      dlg.show();
      if (dlg.isOK()) {
        result.addAll(dlg.getChosenRoots());
      }
 else {
        result.add(candidate);
      }
    }
  }
  return result.toArray(new VirtualFile[result.size()]);
}
