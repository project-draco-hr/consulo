{
  PsiClass newClass;
  if (!moveAllClassesInFile) {
    for (    MoveClassHandler handler : MoveClassHandler.EP_NAME.getExtensions()) {
      newClass=handler.doMoveClass(aClass,moveDestination);
      if (newClass != null)       return newClass;
    }
  }
  PsiFile file=aClass.getContainingFile();
  final PsiPackage newPackage=JavaDirectoryService.getInstance().getPackage(moveDestination);
  newClass=aClass;
  if (!moveDestination.equals(file.getContainingDirectory())) {
    LOG.assertTrue(file.getVirtualFile() != null,aClass);
    MoveFilesOrDirectoriesUtil.doMoveFile(file,moveDestination);
    if (file instanceof PsiClassOwner && newPackage != null && !JspPsiUtil.isInJspFile(file)) {
      String aClassName=aClass.getName();
      ((PsiClassOwner)file).setPackageName(newPackage.getQualifiedName());
      newClass=findClassByName((PsiClassOwner)file,aClassName);
      LOG.assertTrue(newClass != null);
    }
  }
  return newClass;
}
