{
  final PsiManager psiManager=PsiManager.getInstance(project);
  final PackageWrapper packageWrapper=new PackageWrapper(psiManager,packageName);
  final PsiPackage aPackage=JavaPsiFacade.getInstance(project).findPackage(packageName);
  PsiDirectory directory;
  PsiDirectory[] directories=aPackage != null ? aPackage.getDirectories() : null;
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final boolean filterOutSources=baseDir != null && fileIndex.isInTestSourceContent(baseDir.getVirtualFile());
  if (directories != null && directories.length == 1 && !(filterOutSources && !fileIndex.isInTestSourceContent(directories[0].getVirtualFile()))) {
    directory=directories[0];
  }
 else {
    VirtualFile[] contentSourceRoots=ProjectRootManager.getInstance(project).getContentSourceRoots();
    if (contentSourceRoots.length == 1 && !(filterOutSources && !fileIndex.isInTestSourceContent(contentSourceRoots[0]))) {
      directory=RefactoringUtil.createPackageDirectoryInSourceRoot(packageWrapper,contentSourceRoots[0]);
    }
 else {
      final VirtualFile sourceRootForFile=chooseSourceRoot(packageWrapper,contentSourceRoots,baseDir);
      if (sourceRootForFile == null)       return null;
      directory=psiManager.findDirectory(sourceRootForFile);
    }
  }
  return directory;
}
