{
  final Ref<String> charsetNameRef=new Ref<String>();
  try {
    new HtmlBuilderDriver(content).build(new XmlBuilder(){
      @NonNls final Set<String> inTag=new THashSet<String>();
      boolean metHttpEquiv=false;
      public void doctype(      @Nullable final CharSequence publicId,      @Nullable final CharSequence systemId,      final int startOffset,      final int endOffset){
      }
      public ProcessingOrder startTag(      final CharSequence localName,      final String namespace,      final int startoffset,      final int endoffset,      final int headerEndOffset){
        @NonNls String name=localName.toString().toLowerCase();
        inTag.add(name);
        if (!inTag.contains("head") && !"html".equals(name))         terminate();
        return ProcessingOrder.TAGS_AND_ATTRIBUTES;
      }
      private void terminate(){
        throw TerminateException.INSTANCE;
      }
      public void endTag(      final CharSequence localName,      final String namespace,      final int startoffset,      final int endoffset){
        @NonNls final String name=localName.toString().toLowerCase();
        if ("meta".equals(name) && metHttpEquiv && contentAttributeValue != null) {
          int start=contentAttributeValue.indexOf(CHARSET_PREFIX);
          if (start == -1)           return;
          start+=CHARSET_PREFIX.length();
          int end=contentAttributeValue.indexOf(';',start);
          if (end == -1)           end=contentAttributeValue.length();
          String charsetName=contentAttributeValue.substring(start,end);
          charsetNameRef.set(charsetName);
          terminate();
        }
        if ("head".equals(name)) {
          terminate();
        }
        inTag.remove(name);
        metHttpEquiv=false;
        contentAttributeValue=null;
      }
      private String contentAttributeValue;
      public void attribute(      final CharSequence localName,      final CharSequence v,      final int startoffset,      final int endoffset){
        @NonNls final String name=localName.toString().toLowerCase();
        if (inTag.contains("meta")) {
          @NonNls String value=v.toString().toLowerCase();
          if (name.equals("http-equiv")) {
            metHttpEquiv|=value.equals("content-type");
          }
          if (name.equals("content")) {
            contentAttributeValue=value;
          }
        }
      }
      public void textElement(      final CharSequence display,      final CharSequence physical,      final int startoffset,      final int endoffset){
      }
      public void entityRef(      final CharSequence ref,      final int startOffset,      final int endOffset){
      }
      public void error(      String message,      int startOffset,      int endOffset){
      }
    }
);
  }
 catch (  TerminateException e) {
  }
catch (  Exception e) {
  }
  String name=charsetNameRef.get();
  return CharsetToolkit.forName(name);
}
