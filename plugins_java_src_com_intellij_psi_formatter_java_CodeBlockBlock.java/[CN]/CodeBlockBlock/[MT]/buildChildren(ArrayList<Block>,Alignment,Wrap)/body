{
  ASTNode child=myNode.getFirstChildNode();
  int state=BEFORE_FIRST;
  if (myNode.getPsi() instanceof JspClass) {
    state=INSIDE_BODY;
  }
  while (child != null) {
    if (!FormatterUtil.containsWhiteSpacesOnly(child) && child.getTextLength() > 0) {
      final Indent indent=calcCurrentIndent(child,state);
      state=calcNewState(child,state);
      if (child.getElementType() == JavaElementType.SWITCH_LABEL_STATEMENT) {
        child=processCaseAndStatementAfter(result,child,childAlignment,childWrap,indent);
      }
 else       if (myNode.getElementType() == JavaElementType.CLASS && child.getElementType() == JavaTokenType.LBRACE) {
        child=composeCodeBlock(result,child,getCodeBlockExternalIndent(),myChildrenIndent,null);
      }
 else       if (myNode.getElementType() == JavaElementType.CODE_BLOCK && child.getElementType() == JavaTokenType.LBRACE && myNode.getTreeParent().getElementType() == JavaElementType.METHOD) {
        child=composeCodeBlock(result,child,indent,myChildrenIndent,childWrap);
      }
 else {
        child=processChild(result,child,chooseAlignment(child,childAlignment),childWrap,indent);
      }
    }
    if (child != null) {
      child=child.getTreeNext();
    }
  }
}
