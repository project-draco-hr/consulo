{
  if (myType != ReferenceType.ElementReference && myType != ReferenceType.AttributeReference) {
    final PsiElement parentElement=myElement.getParent();
    final PsiElement grandParentElement=parentElement != null ? parentElement.getParent() : null;
    boolean doRedefineCheck=false;
    if (parentElement instanceof XmlAttribute && grandParentElement instanceof XmlTag) {
      final String attrName=((XmlAttribute)parentElement).getName();
      final String tagLocalName=((XmlTag)grandParentElement).getLocalName();
      doRedefineCheck=(REF_ATTR_NAME.equals(attrName) && (GROUP_TAG_NAME.equals(tagLocalName) || ATTRIBUTE_GROUP_TAG_NAME.equals(tagLocalName))) || (BASE_ATTR_NAME.equals(attrName) || MEMBER_TYPES_ATTR_NAME.equals(attrName));
    }
    if (doRedefineCheck) {
      for (XmlTag parentTag=tag.getParentTag(); parentTag != null; parentTag=parentTag.getParentTag()) {
        if (text.equals(parentTag.getAttributeValue("name"))) {
          final XmlTag grandParent=parentTag.getParentTag();
          if (grandParent != null && "redefine".equals(grandParent.getLocalName())) {
            return XmlNSDescriptorImpl.getRedefinedElementDescriptor(grandParent);
          }
        }
      }
    }
  }
  final String namespace=getNamespace(tag,text);
  XmlNSDescriptor nsDescriptor=tag.getNSDescriptor(namespace,true);
  final XmlDocument document=((XmlFile)tag.getContainingFile()).getDocument();
  if (nsDescriptor == null) {
    nsDescriptor=(XmlNSDescriptor)document.getMetaData();
  }
  if (nsDescriptor == null) {
    final XmlNSDescriptor[] descrs=new XmlNSDescriptor[1];
    URLReference.processWsdlSchemas(document.getRootTag(),new Processor<XmlTag>(){
      public boolean process(      final XmlTag xmlTag){
        if (namespace.equals(xmlTag.getAttributeValue(TARGET_NAMESPACE))) {
          descrs[0]=(XmlNSDescriptor)xmlTag.getMetaData();
          return false;
        }
        return true;
      }
    }
);
    if (descrs[0] instanceof XmlNSDescriptorImpl)     return (XmlNSDescriptorImpl)descrs[0];
  }
  return nsDescriptor instanceof XmlNSDescriptorImpl ? (XmlNSDescriptorImpl)nsDescriptor : null;
}
