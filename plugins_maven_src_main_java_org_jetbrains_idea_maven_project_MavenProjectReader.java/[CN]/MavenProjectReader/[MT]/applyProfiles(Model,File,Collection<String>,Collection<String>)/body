{
  List<Profile> activated=new ArrayList<Profile>();
  List<Profile> activeByDefault=new ArrayList<Profile>();
  List<Profile> rawProfiles=model.getProfiles();
  List<Profile> expandedProfiles=null;
  for (int i=0; i < rawProfiles.size(); i++) {
    Profile eachRawProfile=rawProfiles.get(i);
    if (explicitProfiles.contains(eachRawProfile.getId()) || alwaysOnProfiles.contains(eachRawProfile.getId())) {
      activated.add(eachRawProfile);
      continue;
    }
    Activation activation=eachRawProfile.getActivation();
    if (activation == null)     continue;
    if (activation.isActiveByDefault()) {
      activeByDefault.add(eachRawProfile);
    }
    if (expandedProfiles == null)     expandedProfiles=expandProperties(model,basedir).getProfiles();
    Profile eachExpandedProfile=expandedProfiles.get(i);
    for (    ProfileActivator eachActivator : getProfileActivators()) {
      try {
        if (eachActivator.canDetermineActivation(eachExpandedProfile) && eachActivator.isActive(eachExpandedProfile)) {
          activated.add(eachRawProfile);
          break;
        }
      }
 catch (      ProfileActivationException e) {
        MavenLog.LOG.warn(e);
      }
    }
  }
  List<Profile> activatedProfiles=activated.isEmpty() ? activeByDefault : activated;
  for (  Profile each : activatedProfiles) {
    new DefaultProfileInjector().inject(each,model);
  }
  return activatedProfiles;
}
