{
  List<Profile> activatedPom=new ArrayList<Profile>();
  List<Profile> activatedExternal=new ArrayList<Profile>();
  List<Profile> activeByDefault=new ArrayList<Profile>();
  List<Profile> rawProfiles=model.getProfiles();
  List<Profile> expandedProfilesCache=null;
  for (int i=0; i < rawProfiles.size(); i++) {
    Profile eachRawProfile=rawProfiles.get(i);
    boolean shouldAdd=explicitProfiles.contains(eachRawProfile.getId()) || alwaysOnProfiles.contains(eachRawProfile.getId());
    Activation activation=eachRawProfile.getActivation();
    if (activation != null) {
      if (activation.isActiveByDefault()) {
        activeByDefault.add(eachRawProfile);
      }
      if (expandedProfilesCache == null)       expandedProfilesCache=expandProperties(model,basedir).getProfiles();
      Profile eachExpandedProfile=expandedProfilesCache.get(i);
      for (      ProfileActivator eachActivator : getProfileActivators()) {
        try {
          if (eachActivator.canDetermineActivation(eachExpandedProfile) && eachActivator.isActive(eachExpandedProfile)) {
            shouldAdd=true;
            break;
          }
        }
 catch (        ProfileActivationException e) {
          MavenLog.LOG.warn(e);
        }
      }
    }
    if (shouldAdd) {
      if (PROFILE_FROM_POM.equals(eachRawProfile.getSource())) {
        activatedPom.add(eachRawProfile);
      }
 else {
        activatedExternal.add(eachRawProfile);
      }
    }
  }
  List<Profile> activatedProfiles=new ArrayList<Profile>(activatedPom.isEmpty() ? activeByDefault : activatedPom);
  activatedProfiles.addAll(activatedExternal);
  for (  Profile each : activatedProfiles) {
    new DefaultProfileInjector().inject(each,model);
  }
  return activatedProfiles;
}
