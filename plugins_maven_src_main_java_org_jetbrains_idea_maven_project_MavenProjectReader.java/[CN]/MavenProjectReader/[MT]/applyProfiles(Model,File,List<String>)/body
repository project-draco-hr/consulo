{
  List<Profile> activated=new ArrayList<Profile>();
  List<Profile> activeByDefault=new ArrayList<Profile>();
  List<Profile> rawProfiles=model.getProfiles();
  List<Profile> expandedProfiles=null;
  for (int i=0; i < rawProfiles.size(); i++) {
    Profile eachRawProfile=rawProfiles.get(i);
    if (profiles.contains(eachRawProfile.getId())) {
      activated.add(eachRawProfile);
    }
    Activation activation=eachRawProfile.getActivation();
    if (activation == null)     continue;
    if (activation.isActiveByDefault()) {
      activeByDefault.add(eachRawProfile);
    }
    if (expandedProfiles == null)     expandedProfiles=expandProperties(model,basedir).getProfiles();
    Profile eachExpandedProfile=expandedProfiles.get(i);
    MavenLog.LOG.assertTrue(eachExpandedProfile != null,"expanded profile not found");
    MavenLog.LOG.assertTrue(Comparing.equal(eachExpandedProfile.getId(),eachRawProfile.getId()),"expected id: " + eachRawProfile.getId() + " was : "+ eachExpandedProfile.getId());
    for (    ProfileActivator eachActivator : getProfileActivators()) {
      try {
        if (eachActivator.canDetermineActivation(eachExpandedProfile) && eachActivator.isActive(eachExpandedProfile)) {
          activated.add(eachRawProfile);
          break;
        }
      }
 catch (      ProfileActivationException e) {
        MavenLog.LOG.warn(e);
      }
    }
  }
  List<Profile> result=activated.isEmpty() ? activeByDefault : activated;
  for (  Profile each : result) {
    new DefaultProfileInjector().inject(each,model);
  }
  return result;
}
