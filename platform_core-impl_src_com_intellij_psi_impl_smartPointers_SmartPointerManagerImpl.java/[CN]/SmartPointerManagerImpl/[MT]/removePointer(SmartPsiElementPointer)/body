{
  if (!(pointer instanceof SmartPsiElementPointerImpl)) {
    return false;
  }
  PsiFile containingFile=pointer.getContainingFile();
synchronized (lock) {
    int refCount=((SmartPsiElementPointerImpl)pointer).incrementAndGetReferenceCount(-1);
    if (refCount == 0) {
      PsiElement element=((SmartPointerEx)pointer).getCachedElement();
      if (element != null) {
        element.putUserData(CACHED_SMART_POINTER_KEY,null);
      }
      SmartPointerElementInfo info=((SmartPsiElementPointerImpl)pointer).getElementInfo();
      info.cleanup();
      if (containingFile == null)       return false;
      VirtualFile vFile=containingFile.getViewProvider().getVirtualFile();
      FilePointersList pointers=getPointers(vFile);
      if (pointers == null)       return false;
      boolean result=pointers.remove(pointer);
      if (pointers.isEmpty()) {
        vFile.putUserData(POINTERS_KEY,null);
      }
      return result;
    }
  }
  return false;
}
