{
  if (containingFile != null && !containingFile.isValid() || containingFile == null && !element.isValid()) {
    PsiUtilCore.ensureValid(element);
    LOG.error("Invalid element:" + element);
  }
  SmartPointerEx<E> pointer=getCachedPointer(element);
  if (pointer != null) {
    containingFile=containingFile == null ? element.getContainingFile() : containingFile;
    if (containingFile != null && areBeltsFastened(containingFile.getViewProvider().getVirtualFile())) {
      pointer.fastenBelt(0,null);
    }
  }
 else {
    pointer=new SmartPsiElementPointerImpl<E>(myProject,element,containingFile);
    if (containingFile != null) {
      initPointer(pointer,containingFile.getViewProvider().getVirtualFile());
    }
    element.putUserData(CACHED_SMART_POINTER_KEY,new SoftReference<SmartPointerEx>(pointer));
  }
  if (pointer instanceof SmartPsiElementPointerImpl) {
synchronized (lock) {
      ((SmartPsiElementPointerImpl)pointer).incrementAndGetReferenceCount(1);
    }
  }
  return pointer;
}
