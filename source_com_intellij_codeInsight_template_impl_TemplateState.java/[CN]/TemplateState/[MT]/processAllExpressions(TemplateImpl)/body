{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      toProcessChangedUpdate=false;
      if (!template.isInline())       myDocument.insertString(myTemplateRange.getStartOffset(),template.getTemplateText());
      for (int i=0; i < template.getSegmentsCount(); i++) {
        int segmentOffset=myTemplateRange.getStartOffset() + template.getSegmentOffset(i);
        mySegments.addSegment(segmentOffset,segmentOffset);
      }
      PsiDocumentManager documentManager=PsiDocumentManager.getInstance(myProject);
      LOG.assertTrue(!documentManager.isUncommited(myDocument));
      toProcessChangedUpdate=true;
      calcResults(false);
      calcResults(false);
      doReformat();
      int nextVariableNumber=getNextVariableNumber(-1);
      if (nextVariableNumber == -1) {
        finishTemplateEditing();
      }
 else {
        setCurrentVariableNumber(nextVariableNumber);
        initTabStopHighlighters();
        initListeners();
        focusCurrentExpression();
      }
    }
  }
);
}
