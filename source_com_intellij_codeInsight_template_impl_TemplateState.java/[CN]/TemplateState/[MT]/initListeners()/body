{
  myEditorDocumentListener=new DocumentAdapter(){
    public void beforeDocumentChange(    DocumentEvent e){
      if (!isFinished()) {
        if (toProcessChangedUpdate) {
          UndoManager undoManager=UndoManager.getInstance(myProject);
          if (!undoManager.isUndoInProgress() && !undoManager.isRedoInProgress()) {
            if (myCurrentSegmentNumber >= 0) {
              myChangesFlag=e.getOffset() < mySegments.getSegmentStart(myCurrentSegmentNumber) || e.getOffset() + e.getOldLength() > mySegments.getSegmentEnd(myCurrentSegmentNumber);
            }
          }
        }
      }
    }
  }
;
  myCommandListener=new CommandAdapter(){
    public void beforeCommandFinished(    CommandEvent event){
      if (!"Up".equals(event.getCommandName()) && !"Down".equals(event.getCommandName())) {
        afterChangedUpdate();
      }
    }
  }
;
  myDocument.addDocumentListener(myEditorDocumentListener);
  CommandProcessor.getInstance().addCommandListener(myCommandListener);
}
