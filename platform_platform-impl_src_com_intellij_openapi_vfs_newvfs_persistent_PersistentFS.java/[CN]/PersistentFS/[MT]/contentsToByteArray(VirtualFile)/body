{
  InputStream contentStream=null;
  boolean reloadFromDelegate;
synchronized (INPUT_LOCK) {
    reloadFromDelegate=mustReloadContent(file) || (contentStream=FILE_CONTENT.readAttribute(file)) == null;
  }
  if (reloadFromDelegate) {
    final NewVirtualFileSystem delegate=getDelegate(file);
    final byte[] content=delegate.contentsToByteArray(file);
    if (content.length <= FILE_LENGTH_TO_CACHE_THRESHOLD) {
synchronized (INPUT_LOCK) {
        DataOutputStream sink=FILE_CONTENT.writeAttribute(file);
        try {
          FileUtil.copy(new ByteArrayInputStream(content),sink);
        }
  finally {
          sink.close();
        }
        myRecords.setLength(getFileId(file),content.length);
        setFlag(file,MUST_RELOAD_CONTENT,false);
      }
    }
    return content;
  }
 else {
    return FileUtil.loadBytes(contentStream,(int)file.getLength());
  }
}
