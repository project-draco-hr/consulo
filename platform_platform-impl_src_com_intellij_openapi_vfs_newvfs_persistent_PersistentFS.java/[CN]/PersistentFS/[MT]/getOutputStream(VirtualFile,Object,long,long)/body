{
  final VFileContentChangeEvent event=new VFileContentChangeEvent(requestor,file,file.getModificationStamp(),modStamp,false);
  final List<VFileContentChangeEvent> events=Collections.singletonList(event);
  final BulkFileListener publisher=myEventsBus.syncPublisher(VirtualFileManager.VFS_CHANGES);
  publisher.before(events);
  final ByteArrayOutputStream stream=new ByteArrayOutputStream(){
    public void close() throws IOException {
      super.close();
      final OutputStream delegate=getDelegate(file).getOutputStream(file,requestor,modStamp,timeStamp);
      final DupOutputStream sink=new DupOutputStream(new BufferedOutputStream(writeContent(file)),delegate){
        public void close() throws IOException {
          try {
            super.close();
          }
  finally {
            executeTouch(file,false,event.getModificationStamp());
            publisher.after(events);
          }
        }
      }
;
      try {
        sink.write(buf,0,count);
      }
  finally {
        sink.close();
      }
    }
  }
;
  final byte[] bom=file.getBOM();
  if (bom != null) {
    stream.write(bom);
  }
  return stream;
}
