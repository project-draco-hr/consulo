{
  final VFileContentChangeEvent event=new VFileContentChangeEvent(requestor,file,file.getModificationStamp(),modStamp,false);
  final List<VFileContentChangeEvent> events=Collections.singletonList(event);
  final BulkFileListener publisher=myEventsBus.syncPublisher(VirtualFileManager.VFS_CHANGES);
  publisher.before(events);
  return new ByteArrayOutputStream(){
    public void close() throws IOException {
      super.close();
      NewVirtualFileSystem delegate=getDelegate(file);
      final OutputStream outputStream=delegate.getOutputStream(file,requestor,modStamp,timeStamp);
      final DupOutputStream sink=new DupOutputStream(new BufferedOutputStream(writeContent(file,delegate.isReadOnly())),outputStream){
        public void close() throws IOException {
          try {
            super.close();
          }
  finally {
            executeTouch(file,false,event.getModificationStamp());
            publisher.after(events);
          }
        }
      }
;
      try {
        sink.write(buf,0,count);
      }
  finally {
        sink.close();
      }
    }
  }
;
}
