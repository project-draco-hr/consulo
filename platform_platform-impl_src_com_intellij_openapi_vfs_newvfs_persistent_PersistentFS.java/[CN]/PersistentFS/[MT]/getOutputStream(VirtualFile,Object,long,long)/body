{
  final VirtualFile canonicalFile=getCanonicalFile(file);
  final VFileContentChangeEvent event=new VFileContentChangeEvent(requestor,canonicalFile,canonicalFile.getModificationStamp(),modStamp,false);
  final List<VFileContentChangeEvent> events=Collections.singletonList(event);
  final BulkFileListener publisher=myEventsBus.syncPublisher(VirtualFileManager.VFS_CHANGES);
  publisher.before(events);
  return new ByteArrayOutputStream(){
    private boolean closed;
    @Override public void close() throws IOException {
      if (closed)       return;
      super.close();
      NewVirtualFileSystem delegate=getDelegate(canonicalFile);
      OutputStream ioFileStream=delegate.getOutputStream(canonicalFile,requestor,modStamp,timeStamp);
      OutputStream persistenceStream=writeContent(canonicalFile,delegate.isReadOnly());
      try {
        persistenceStream.write(buf,0,count);
      }
  finally {
        try {
          ioFileStream.write(buf,0,count);
        }
  finally {
          closed=true;
          persistenceStream.close();
          ioFileStream.close();
          executeTouch(canonicalFile,false,event.getModificationStamp());
          publisher.after(events);
        }
      }
    }
  }
;
}
