{
  int id=getFileId(file);
  String[] currentNames=listPersisted(file);
  int[] currentIds=myRecords.list(id);
  final NewVirtualFileSystem delegate=getDelegate(file);
  String[] delegateNames=VfsUtil.filterNames(delegate.list(file));
  if (delegateNames.length == 0 && currentNames.length > 0)   return currentNames;
  final String[] names;
  if (currentNames.length == 0) {
    names=delegateNames;
  }
 else {
    Set<String> allNamesSet=new LinkedHashSet<String>((currentNames.length + delegateNames.length) * 2);
    allNamesSet.addAll(Arrays.asList(currentNames));
    allNamesSet.addAll(Arrays.asList(delegateNames));
    names=allNamesSet.toArray(new String[allNamesSet.size()]);
  }
  final int[] childrenIds=ArrayUtil.newIntArray(names.length);
  for (int i=0; i < names.length; i++) {
    final String name=names[i];
    int idx=ArrayUtil.indexOf(currentNames,name);
    if (idx >= 0) {
      childrenIds[i]=currentIds[idx];
    }
 else {
      int childId=FSRecords.createRecord();
      copyRecordFromDelegateFS(childId,id,new FakeVirtualFile(file,name),delegate);
      childrenIds[i]=childId;
    }
  }
  myRecords.updateList(id,childrenIds);
  int flags=FSRecords.getFlags(id);
  myRecords.setFlags(id,flags | CHILDREN_CACHED_FLAG,true);
  return names;
}
