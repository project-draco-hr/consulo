{
  final BufferExposingByteArrayOutputStream cache=new BufferExposingByteArrayOutputStream((int)len);
  return new ReplicatorInputStream(nativeStream,cache){
    public void close() throws IOException {
      super.close();
synchronized (INPUT_LOCK) {
        if (getBytesRead() == len) {
          writeContent(file,new ByteSequence(cache.getInternalBuffer(),0,cache.size()),readOnly);
          myRecords.setLength(getFileId(file),len);
          setFlag(file,MUST_RELOAD_CONTENT,false);
        }
 else {
          setFlag(file,MUST_RELOAD_CONTENT,true);
        }
      }
    }
  }
;
}
