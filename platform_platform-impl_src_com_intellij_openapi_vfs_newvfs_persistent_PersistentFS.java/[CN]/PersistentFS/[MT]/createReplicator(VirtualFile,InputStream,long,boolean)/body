{
  if (nativeStream instanceof BufferExposingByteArrayInputStream) {
    BufferExposingByteArrayInputStream byteStream=(BufferExposingByteArrayInputStream)nativeStream;
    byte[] bytes=byteStream.getInternalBuffer();
    storeContentToStorage(fileLength,file,readOnly,bytes,bytes.length);
    return nativeStream;
  }
  final BufferExposingByteArrayOutputStream cache=new BufferExposingByteArrayOutputStream((int)fileLength);
  return new ReplicatorInputStream(nativeStream,cache){
    @Override public void close() throws IOException {
      super.close();
      storeContentToStorage(fileLength,file,readOnly,cache.getInternalBuffer(),cache.size());
    }
  }
;
}
