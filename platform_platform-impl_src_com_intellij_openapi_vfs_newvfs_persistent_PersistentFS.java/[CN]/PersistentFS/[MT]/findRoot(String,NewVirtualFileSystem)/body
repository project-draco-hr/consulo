{
synchronized (LOCK) {
    final String rootUrl=fs.getProtocol() + "://" + basePath;
    NewVirtualFile root=myRoots.get(rootUrl);
    if (root == null) {
      try {
        final int rootId=myRecords.findRootRecord(rootUrl);
        if (basePath.length() > 0) {
          root=new VirtualDirectoryImpl(basePath,null,fs,rootId);
        }
 else {
          root=new VirtualDirectoryImpl(basePath,null,fs,rootId){
            @NotNull public VirtualFile[] getChildren(){
              return getRoots(fs);
            }
          }
;
        }
        if (!fs.exists(root))         return null;
        String name=root.getName();
        if (name.length() == 0 || !namesEqual(fs,name,FSRecords.getName(rootId))) {
          copyRecordFromDelegateFS(rootId,0,root,fs);
        }
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
      if (basePath.length() > 0) {
        myRoots.put(rootUrl,root);
      }
    }
    return root;
  }
}
