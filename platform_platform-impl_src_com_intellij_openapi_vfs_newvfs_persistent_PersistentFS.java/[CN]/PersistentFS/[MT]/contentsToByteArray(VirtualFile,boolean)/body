{
  InputStream contentStream=null;
  boolean reloadFromDelegate;
synchronized (INPUT_LOCK) {
    reloadFromDelegate=mustReloadContent(file) || (contentStream=readContent(file)) == null;
  }
  if (reloadFromDelegate) {
    final NewVirtualFileSystem delegate=getDelegate(file);
    FSRecords.setLength(getFileId(file),delegate.getLength(file));
    final byte[] content=delegate.contentsToByteArray(file);
    ApplicationEx application=(ApplicationEx)ApplicationManager.getApplication();
    if ((!delegate.isReadOnly() || !application.isInternal() && !application.isUnitTestMode()) && content.length <= PersistentFSConstants.FILE_LENGTH_TO_CACHE_THRESHOLD) {
synchronized (INPUT_LOCK) {
        writeContent(file,new ByteSequence(content),delegate.isReadOnly());
        setFlag(file,MUST_RELOAD_CONTENT,false);
      }
    }
    return content;
  }
 else {
    try {
      return FileUtil.loadBytes(contentStream,(int)file.getLength());
    }
 catch (    IOException e) {
      throw FSRecords.handleError(e);
    }
  }
}
