{
  if (!project.isDefault()) {
    task.run();
    return;
  }
  AbstractExternalSystemSettings systemSettings=ExternalSystemApiUtil.getSettings(project,myExternalSystemId);
  Object systemStateToRestore=null;
  if (systemSettings instanceof PersistentStateComponent) {
    systemStateToRestore=((PersistentStateComponent)systemSettings).getState();
  }
  systemSettings.copyFrom(myControl.getSystemSettings());
  Collection projectSettingsToRestore=systemSettings.getLinkedProjectsSettings();
  systemSettings.setLinkedProjectsSettings(Collections.singleton(getCurrentExternalProjectSettings()));
  try {
    task.run();
  }
  finally {
    if (systemStateToRestore != null) {
      ((PersistentStateComponent)systemSettings).loadState(systemStateToRestore);
    }
 else {
      systemSettings.setLinkedProjectsSettings(projectSettingsToRestore);
    }
  }
}
