{
  final Map<GroupDescriptor,Set<UsageDescriptor>> allUsages=createDescriptors("g:a1:-1","g2:a2:-2","g2:a3:-3","g:a2:-2","g2:a1:-1","g3:a1:13");
  final SentUsagesPersistence usagesPersistence=new BasicSentUsagesPersistenceComponent();
  Map<GroupDescriptor,Set<PatchedUsage>> patchedUsages=StatisticsUploadAssistant.getPatchedUsages(allUsages,usagesPersistence);
  String result=StatisticsUploadAssistant.getStringPatch(patchedUsages,500);
  StatisticsUploadAssistant.persistSentPatch(result,usagesPersistence);
  assertMapEquals(ConvertUsagesUtil.convertString(result),ConvertUsagesUtil.convertString("g:a2=-2,a1=-1;g2:a3=-3,a2=-2,a1=-1;g3:a1=13;"));
  patchedUsages=StatisticsUploadAssistant.getPatchedUsages(allUsages,usagesPersistence);
  result=StatisticsUploadAssistant.getStringPatch(patchedUsages,500);
  StatisticsUploadAssistant.persistSentPatch(result,usagesPersistence);
  assertEquals("sent usages must be persisted",result.length(),0);
  assertEquals(allUsages.size(),usagesPersistence.getSentUsages().size());
}
