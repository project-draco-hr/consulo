{
  final boolean childOnNewLine=child.getWhiteSpace().containsLineFeeds();
  IndentData childIndent=childOnNewLine ? getIndent(options,child,tokenBlockStartOffset) : new IndentData(0);
  if (childOnNewLine && child.getIndent().isAbsolute()) {
    myCanUseFirstChildIndentAsBlockIndent=false;
    AbstractBlockWrapper current=this;
    while (current != null && current.getStartOffset() == getStartOffset()) {
      current.myCanUseFirstChildIndentAsBlockIndent=false;
      current=current.myParent;
    }
    return childIndent;
  }
  if (child.getStartOffset() == getStartOffset()) {
    myCanUseFirstChildIndentAsBlockIndent=myCanUseFirstChildIndentAsBlockIndent && child.myCanUseFirstChildIndentAsBlockIndent && childIndent.isEmpty();
  }
  if (getStartOffset() == tokenBlockStartOffset) {
    if (myParent == null) {
      return childIndent;
    }
 else {
      return childIndent.add(myParent.getChildOffset(this,options,tokenBlockStartOffset));
    }
  }
 else   if (!getWhiteSpace().containsLineFeeds()) {
    return childIndent.add(myParent.getChildOffset(this,options,tokenBlockStartOffset));
  }
 else {
    if (myParent == null)     return childIndent.add(getWhiteSpace());
    if (getIndent().isAbsolute())     return childIndent.add(myParent.myParent.getChildOffset(myParent,options,tokenBlockStartOffset));
    if (myCanUseFirstChildIndentAsBlockIndent) {
      return childIndent.add(getWhiteSpace());
    }
 else {
      return childIndent.add(myParent.getChildOffset(this,options,tokenBlockStartOffset));
    }
  }
}
