{
  final InspectionManagerEx managerEx=(InspectionManagerEx)InspectionManager.getInstance(file.getProject());
  final GlobalInspectionContextImpl context=managerEx.createNewGlobalContext(false);
  final LocalInspectionToolWrapper tool=new LocalInspectionToolWrapper(inspectionTool);
  tool.initialize(context);
  ((RefManagerImpl)context.getRefManager()).inspectionReadActionStarted();
  try {
    Runnable process=new Runnable(){
      public void run(){
        tool.processFile(file,true,managerEx,true);
      }
    }
;
    if (progress != null) {
      ((ProgressManagerImpl)ProgressManager.getInstance()).executeProcessUnderProgress(process,progress);
    }
 else {
      process.run();
    }
    return new ArrayList<CommonProblemDescriptor>(tool.getProblemDescriptors());
  }
  finally {
    ((RefManagerImpl)context.getRefManager()).inspectionReadActionFinished();
    context.cleanup(managerEx);
  }
}
