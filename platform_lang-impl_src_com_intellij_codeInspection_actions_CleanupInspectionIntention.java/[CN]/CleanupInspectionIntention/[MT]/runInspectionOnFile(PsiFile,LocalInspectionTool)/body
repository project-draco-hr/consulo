{
  final InspectionManagerEx managerEx=(InspectionManagerEx)InspectionManager.getInstance(file.getProject());
  final GlobalInspectionContextImpl context=managerEx.createNewGlobalContext(false);
  final LocalInspectionToolWrapper tool=new LocalInspectionToolWrapper(inspectionTool);
  tool.initialize(context);
  ((RefManagerImpl)context.getRefManager()).inspectionReadActionStarted();
  try {
    ((ProgressManagerImpl)ProgressManager.getInstance()).executeProcessUnderProgress(new Runnable(){
      public void run(){
        tool.processFile(file,true,managerEx,true);
      }
    }
,new EmptyProgressIndicator());
    return new ArrayList<CommonProblemDescriptor>(tool.getProblemDescriptors());
  }
  finally {
    ((RefManagerImpl)context.getRefManager()).inspectionReadActionFinished();
    context.cleanup(managerEx);
  }
}
