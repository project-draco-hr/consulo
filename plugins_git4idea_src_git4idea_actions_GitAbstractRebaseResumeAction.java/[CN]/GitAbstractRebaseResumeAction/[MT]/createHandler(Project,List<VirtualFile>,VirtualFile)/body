{
  for (Iterator<VirtualFile> i=gitRoots.iterator(); i.hasNext(); ) {
    if (!GitRebaseUtils.isRebaseInTheProgress(i.next())) {
      i.remove();
    }
  }
  if (gitRoots.size() == 0) {
    Messages.showErrorDialog(project,GitBundle.getString("rebase.action.no.root"),GitBundle.getString("rebase.action.error"));
    return null;
  }
  final VirtualFile root;
  if (gitRoots.size() == 1) {
    root=gitRoots.get(0);
  }
 else {
    if (!gitRoots.contains(defaultRoot)) {
      defaultRoot=gitRoots.get(0);
    }
    GitRebaseActionDialog d=new GitRebaseActionDialog(project,getActionTitle(),gitRoots,defaultRoot);
    root=d.selectRoot();
    if (root == null) {
      return null;
    }
  }
  GitLineHandler h=new GitLineHandler(project,root,GitHandler.REBASE);
  h.addParameters(getOptionName());
  return h;
}
