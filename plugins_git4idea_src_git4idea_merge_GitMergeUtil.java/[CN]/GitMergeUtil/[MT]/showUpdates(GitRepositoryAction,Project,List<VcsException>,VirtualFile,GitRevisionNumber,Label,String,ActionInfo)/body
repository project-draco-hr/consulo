{
  final UpdatedFiles files=UpdatedFiles.create();
  MergeChangeCollector collector=new MergeChangeCollector(project,root,currentRev,files);
  collector.collect(exceptions);
  if (exceptions.size() != 0) {
    return;
  }
  action.delayTask(new TransactionRunnable(){
    public void run(    List<VcsException> exceptionList){
      ProjectLevelVcsManagerEx manager=(ProjectLevelVcsManagerEx)ProjectLevelVcsManager.getInstance(project);
      UpdateInfoTree tree=manager.showUpdateProjectInfo(files,actionName,actionInfo);
      tree.setBefore(beforeLabel);
      tree.setAfter(LocalHistory.putSystemLabel(project,"After update"));
    }
  }
);
  final Collection<String> unmergedNames=files.getGroupById(FileGroup.MERGED_WITH_CONFLICT_ID).getFiles();
  if (!unmergedNames.isEmpty()) {
    action.delayTask(new TransactionRunnable(){
      public void run(      List<VcsException> exceptionList){
        LocalFileSystem lfs=LocalFileSystem.getInstance();
        final ArrayList<VirtualFile> unmerged=new ArrayList<VirtualFile>();
        for (        String fileName : unmergedNames) {
          VirtualFile f=lfs.findFileByPath(fileName);
          if (f != null) {
            unmerged.add(f);
          }
        }
        AbstractVcsHelper.getInstance(project).showMergeDialog(unmerged,GitVcs.getInstance(project).getMergeProvider());
      }
    }
);
  }
}
