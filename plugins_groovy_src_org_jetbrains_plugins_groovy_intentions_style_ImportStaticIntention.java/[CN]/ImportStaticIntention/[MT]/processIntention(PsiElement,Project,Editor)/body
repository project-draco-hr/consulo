{
  final PsiElement resolved;
  final String name;
  final GroovyFile file;
  final GrImportStatement importStatement;
  boolean isAnythingShortened;
  if (!(element instanceof GrReferenceExpression))   return;
  final GrReferenceExpression ref=(GrReferenceExpression)element;
  resolved=ref.resolve();
  if (!(resolved instanceof PsiMember))   return;
  final PsiClass containingClass=((PsiMember)resolved).getContainingClass();
  if (containingClass == null)   return;
  final String qname=containingClass.getQualifiedName();
  name=((PsiMember)resolved).getName();
  if (name == null)   return;
  final PsiFile containingFile=element.getContainingFile();
  if (!(containingFile instanceof GroovyFile))   return;
  file=(GroovyFile)containingFile;
  file.accept(new GroovyRecursiveElementVisitor(){
    @Override public void visitReferenceExpression(    GrReferenceExpression expression){
      super.visitReferenceExpression(expression);
      if (name.equals(expression.getReferenceName())) {
        PsiElement resolved=expression.resolve();
        if (resolved != null) {
          expression.putUserData(TEMP_REFERENT_USER_DATA,resolved);
        }
      }
    }
  }
);
  final GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(project);
  final GrImportStatement tempImport=factory.createImportStatementFromText(qname + "." + name,true,false,null);
  importStatement=file.addImport(tempImport);
  isAnythingShortened=false;
  for (  PsiReference reference : ReferencesSearch.search(resolved,new LocalSearchScope(containingFile))) {
    final PsiElement refElement=reference.getElement();
    if (refElement instanceof GrQualifiedReference<?>) {
      isAnythingShortened|=GrReferenceAdjuster.shortenReference((GrQualifiedReference<?>)refElement);
    }
  }
  if (!isAnythingShortened) {
    importStatement.delete();
    return;
  }
  file.accept(new GroovyRecursiveElementVisitor(){
    @Override public void visitReferenceExpression(    GrReferenceExpression expression){
      super.visitReferenceExpression(expression);
      GrTypeArgumentList typeArgumentList=expression.getTypeArgumentList();
      if (typeArgumentList != null && typeArgumentList.getFirstChild() != null) {
        expression.putUserData(TEMP_REFERENT_USER_DATA,null);
        return;
      }
      if (name.equals(expression.getReferenceName())) {
        if (expression.isQualified()) {
          GrExpression qualifier=expression.getQualifierExpression();
          if (qualifier instanceof GrReferenceExpression) {
            PsiElement aClass=((GrReferenceExpression)qualifier).resolve();
            if (aClass == ((PsiMember)resolved).getContainingClass()) {
              GrReferenceAdjuster.shortenReference(expression);
            }
          }
        }
 else {
          PsiElement referent=expression.getUserData(TEMP_REFERENT_USER_DATA);
          if (referent instanceof PsiMember && ((PsiMember)referent).hasModifierProperty(PsiModifier.STATIC) && referent != expression.resolve()) {
            expression.bindToElement(referent);
          }
        }
      }
      expression.putUserData(TEMP_REFERENT_USER_DATA,null);
    }
  }
);
}
