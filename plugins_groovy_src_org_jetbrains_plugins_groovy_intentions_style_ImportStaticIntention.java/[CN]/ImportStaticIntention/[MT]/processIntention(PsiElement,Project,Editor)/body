{
  LOG.assertTrue(element instanceof GrReferenceExpression);
  final GrReferenceExpression ref=(GrReferenceExpression)element;
  final PsiElement resolved=ref.resolve();
  LOG.assertTrue(resolved instanceof PsiMember);
  final PsiClass containingClass=((PsiMember)resolved).getContainingClass();
  LOG.assertTrue(containingClass != null);
  final String qname=containingClass.getQualifiedName();
  final String name=((PsiMember)resolved).getName();
  final PsiFile containingFile=element.getContainingFile();
  LOG.assertTrue(containingFile instanceof GroovyFile);
  ((GroovyFile)containingFile).accept(new GroovyRecursiveElementVisitor(){
    @Override public void visitReferenceExpression(    GrReferenceExpression expression){
      super.visitReferenceExpression(expression);
      if (name.equals(expression.getReferenceName())) {
        PsiElement resolved=expression.resolve();
        if (resolved != null) {
          expression.putUserData(TEMP_REFERENT_USER_DATA,resolved);
        }
      }
    }
  }
);
  final GrImportStatement importStatement=GroovyPsiElementFactory.getInstance(project).createImportStatementFromText(qname + "." + name,true,false,null);
  ((GroovyFile)containingFile).addImport(importStatement);
  for (  PsiReference reference : ReferencesSearch.search(resolved,new LocalSearchScope(containingFile))) {
    final PsiElement refElement=reference.getElement();
    if (refElement instanceof GrQualifiedReference) {
      PsiUtil.shortenReference((GrQualifiedReference<PsiElement>)refElement);
    }
  }
  ((GroovyFile)containingFile).accept(new GroovyRecursiveElementVisitor(){
    @Override public void visitReferenceExpression(    GrReferenceExpression expression){
      super.visitReferenceExpression(expression);
      if (expression.getTypeArgumentList() != null && expression.getTypeArgumentList().getFirstChild() != null) {
        expression.putUserData(TEMP_REFERENT_USER_DATA,null);
        return;
      }
      if (name.equals(expression.getReferenceName())) {
        if (expression.isQualified()) {
          if (expression.getQualifierExpression() instanceof GrReferenceExpression) {
            PsiElement aClass=((GrReferenceExpression)expression.getQualifierExpression()).resolve();
            if (aClass == ((PsiMember)resolved).getContainingClass()) {
              PsiUtil.shortenReference(expression);
            }
          }
        }
 else {
          PsiElement referent=expression.getUserData(TEMP_REFERENT_USER_DATA);
          if (referent instanceof PsiMember && ((PsiMember)referent).hasModifierProperty(PsiModifier.STATIC) && referent != expression.resolve()) {
            expression.bindToElement(referent);
          }
        }
      }
      expression.putUserData(TEMP_REFERENT_USER_DATA,null);
    }
  }
);
}
