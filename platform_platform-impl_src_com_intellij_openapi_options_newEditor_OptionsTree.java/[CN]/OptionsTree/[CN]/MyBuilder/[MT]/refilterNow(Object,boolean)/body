{
  final List<Object> toRestore=new ArrayList<Object>();
  if (myContext.isHoldingFilter() && !myWasHoldingFilter && myToExpandOnResetFilter == null) {
    myToExpandOnResetFilter=myBuilder.getUi().getExpandedElements();
  }
 else   if (!myContext.isHoldingFilter() && myWasHoldingFilter && myToExpandOnResetFilter != null) {
    toRestore.addAll(myToExpandOnResetFilter);
    myToExpandOnResetFilter=null;
  }
  myWasHoldingFilter=myContext.isHoldingFilter();
  ActionCallback result=super.refilterNow(preferredSelection,adjustSelection);
  myRefilteringNow=true;
  return result.doWhenDone(new Runnable(){
    public void run(){
      myRefilteringNow=false;
      if (!myContext.isHoldingFilter() && getSelectedElements().isEmpty()) {
        restoreExpandedState(toRestore);
      }
    }
  }
);
}
