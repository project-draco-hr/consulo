{
  if (LOG.isDebugEnabled()) {
    LOG.debug("enter: resolveEntity(baseSystemId='" + baseSystemId + "' systemId='"+ systemId+ "')");
  }
  if (systemId == null)   return null;
  if (myStopOnUnDeclaredResource && ExternalResourceManagerEx.getInstanceEx().isIgnoredResource(systemId)) {
    throw new ProcessCanceledException();
  }
  final PsiFile[] result=new PsiFile[]{null};
  final Runnable action=new Runnable(){
    public void run(){
      PsiFile baseFile=null;
      VirtualFile vFile=null;
      if (baseSystemId != null) {
        baseFile=(XmlFile)resolve(null,baseSystemId);
        if (baseFile == null) {
          if (myFile != null) {
            File workingFile=new File("");
            String workingDir=workingFile.getAbsoluteFile().getAbsolutePath().replace(File.separatorChar,'/');
            String id=StringUtil.replace(baseSystemId,workingDir,myFile.getVirtualFile().getParent().getPath());
            vFile=VfsUtil.findRelativeFile(id,null);
          }
          if (vFile == null) {
            vFile=VfsUtil.findRelativeFile(baseSystemId,null);
            if (vFile == null) {
              try {
                vFile=VfsUtil.findFileByURL(new URL(baseSystemId));
              }
 catch (              MalformedURLException ex) {
              }
            }
          }
        }
        if (vFile != null) {
          baseFile=PsiManager.getInstance(myProject).findFile(vFile);
        }
      }
      if (baseFile == null) {
        baseFile=myFile;
      }
      PsiFile psiFile=XmlUtil.findXmlFile(baseFile,systemId);
      if (psiFile == null && baseSystemId != null && baseFile != null) {
        String fullUrl=baseSystemId.substring(0,baseSystemId.lastIndexOf('/') + 1) + systemId;
        psiFile=XmlUtil.findXmlFile(baseFile,fullUrl);
      }
      if (psiFile == null && systemId != null && baseSystemId == null) {
        File workingFile=new File("");
        String workingDir=workingFile.getAbsoluteFile().getAbsolutePath().replace(File.separatorChar,'/');
        for (        String path : myExternalResourcesMap.values()) {
          String id=StringUtil.replace(systemId,workingDir,path.substring(path.startsWith("file://") ? "file://".length() : 0,path.lastIndexOf('/')));
          final VirtualFile relativeFile=VfsUtil.findRelativeFile(id,null);
          if (relativeFile != null) {
            psiFile=PsiManager.getInstance(myProject).findFile(relativeFile);
            if (psiFile != null)             break;
          }
        }
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("resolveEntity: psiFile='" + (psiFile != null ? psiFile.getVirtualFile() : null) + "'");
      }
      result[0]=psiFile;
    }
  }
;
  ApplicationManager.getApplication().runReadAction(action);
  final PsiFile psiFile=result[0];
  if (psiFile != null)   myExternalResourcesMap.put(systemId,psiFile.getVirtualFile().getUrl());
  return psiFile;
}
