{
  boolean wasGrails=false;
  if ("GRAILS_MODULE".equals(moduleSettings.getModuleType())) {
    moduleSettings.setModuleType(StdModuleTypes.JAVA.getId());
    wasGrails=true;
  }
  final Element facetManagerElement=moduleSettings.getComponentElement(FacetManagerImpl.COMPONENT_NAME);
  if (facetManagerElement == null)   return;
  boolean hasGroovyFacet=false;
  final Element[] facetElements=getChildren(facetManagerElement,FacetManagerImpl.FACET_ELEMENT);
  for (  Element facetElement : facetElements) {
    final String facetType=facetElement.getAttributeValue(FacetManagerImpl.TYPE_ATTRIBUTE);
    if ("Groovy".equals(facetType)) {
      hasGroovyFacet=true;
    }
 else     if ("Grails".equals(facetType)) {
      facetElement.detach();
    }
    for (    Element innerFacet : getChildren(facetElement,FacetManagerImpl.FACET_ELEMENT)) {
      final String innerFacetType=innerFacet.getAttributeValue(FacetManagerImpl.TYPE_ATTRIBUTE);
      if ("Gant_Groovy".equals(innerFacetType) || "Gant_Grails".equals(innerFacetType)) {
        innerFacet.detach();
      }
    }
  }
  if (wasGrails && !hasGroovyFacet) {
    final Element newFacet=new Element("facet");
    newFacet.setAttribute(FacetManagerImpl.TYPE_ATTRIBUTE,"Groovy");
    newFacet.setAttribute(FacetManagerImpl.NAME_ATTRIBUTE,"Groovy");
    facetManagerElement.addContent(newFacet);
  }
}
