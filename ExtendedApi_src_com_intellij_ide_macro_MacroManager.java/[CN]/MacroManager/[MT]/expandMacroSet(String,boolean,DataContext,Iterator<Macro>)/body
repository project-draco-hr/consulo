{
  if (str == null)   return null;
  while (macros.hasNext()) {
    Macro macro=macros.next();
    if (macro instanceof SecondQueueExpandMacro && firstQueueExpand)     continue;
    String name="$" + macro.getName() + "$";
    if (str.indexOf(name) >= 0) {
      String expanded=macro.expand(dataContext);
      if (dataContext instanceof DataManagerImpl.MyDataContext) {
        ((DataManagerImpl.MyDataContext)dataContext).setEventCount(IdeEventQueue.getInstance().getEventCount());
      }
      if (expanded == null) {
        expanded="";
      }
      str=StringUtil.replace(str,name,expanded);
    }
  }
  return str;
}
