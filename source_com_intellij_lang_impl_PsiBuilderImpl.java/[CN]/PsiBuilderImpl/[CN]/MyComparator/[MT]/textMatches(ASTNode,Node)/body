{
  if (oldNode instanceof ChameleonElement || newNode.getTokenType() instanceof IChameleonElementType) {
    return ((TreeElement)oldNode).textMatches(newNode.getText()) ? ThreeState.YES : ThreeState.NO;
  }
  if (oldNode.getElementType() instanceof IChameleonElementType && newNode.getTokenType() instanceof IChameleonElementType) {
    return ((TreeElement)oldNode).textMatches(newNode.getText()) ? ThreeState.YES : ThreeState.NO;
  }
  if (oldNode instanceof LeafElement) {
    if (newNode instanceof Token) {
      return ((LeafElement)oldNode).textMatches(myText,((Token)newNode).myTokenStart,((Token)newNode).myTokenEnd) ? ThreeState.YES : ThreeState.NO;
    }
    return ((LeafElement)oldNode).textMatches(newNode.getText()) ? ThreeState.YES : ThreeState.NO;
  }
  if (oldNode instanceof PsiErrorElement && newNode.getTokenType() == ElementType.ERROR_ELEMENT) {
    final String m1=((PsiErrorElement)oldNode).getErrorDescription();
    final String m2=getErrorMessage(newNode);
    if (!Comparing.equal(m1,m2))     return ThreeState.NO;
  }
  return ThreeState.UNSURE;
}
