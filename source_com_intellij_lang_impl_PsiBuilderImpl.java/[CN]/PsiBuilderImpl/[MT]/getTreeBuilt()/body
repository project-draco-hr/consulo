{
  StartMarker rootMarker=(StartMarker)myProduction.get(0);
  final ASTNode rootNode;
  if (myFileLevelParsing) {
    rootNode=new FileElement(rootMarker.myType);
    myCharTable=((FileElement)rootNode).getCharTable();
  }
 else {
    rootNode=new CompositeElement(rootMarker.myType);
    rootNode.putUserData(CharTable.CHAR_TABLE_KEY,myCharTable);
  }
  for (int i=1; i < myProduction.size() - 1; i++) {
    ProductionMarker item=myProduction.get(i);
    if (item instanceof StartMarker) {
      while (item.myLexemIndex < myLexems.size() && myWhitespaces.contains(myLexems.get(item.myLexemIndex).getTokenType()))       item.myLexemIndex++;
    }
 else     if (item instanceof DoneMarker || item instanceof ErrorItem) {
      int prevProductionLexIndex=myProduction.get(i - 1).myLexemIndex;
      while (item.myLexemIndex > prevProductionLexIndex && item.myLexemIndex < myLexems.size() && myWhitespaces.contains(myLexems.get(item.myLexemIndex - 1).getTokenType())) {
        item.myLexemIndex--;
      }
    }
  }
  ASTNode curNode=rootNode;
  int curToken=0;
  int lastErrorIndex=-1;
  for (int i=1; i < myProduction.size(); i++) {
    ProductionMarker item=myProduction.get(i);
    LOG.assertTrue(curNode != null,"Unexpected end of the production");
    int lexIndex=item.myLexemIndex;
    if (item instanceof StartMarker) {
      StartMarker marker=(StartMarker)item;
      curToken=insertLeafs(curToken,lexIndex,curNode);
      ASTNode childNode;
      if (marker.myType != ElementType.ERROR_ELEMENT) {
        childNode=new CompositeElement(marker.myType);
      }
 else {
        childNode=new PsiErrorElementImpl();
        if (marker.myDoneMarker instanceof DoneWithErrorMarker) {
          ((PsiErrorElementImpl)childNode).setErrorDescription(((DoneWithErrorMarker)marker.myDoneMarker).myMessage);
        }
      }
      TreeUtil.addChildren((CompositeElement)curNode,(TreeElement)childNode);
      curNode=childNode;
    }
 else     if (item instanceof DoneMarker) {
      DoneMarker doneMarker=(DoneMarker)item;
      curToken=insertLeafs(curToken,lexIndex,curNode);
      LOG.assertTrue(doneMarker.myStart.myType == curNode.getElementType());
      curNode=curNode.getTreeParent();
    }
 else     if (item instanceof ErrorItem) {
      curToken=insertLeafs(curToken,lexIndex,curNode);
      if (curToken == lastErrorIndex)       continue;
      lastErrorIndex=curToken;
      final PsiErrorElementImpl errorElement=new PsiErrorElementImpl();
      errorElement.setErrorDescription(((ErrorItem)item).myMessage);
      TreeUtil.addChildren((CompositeElement)curNode,errorElement);
    }
  }
  final boolean allTokensInserted=curToken == myLexems.size();
  if (!allTokensInserted) {
    LOG.assertTrue(false,"Not all of the tokens inserted to the tree, parsed text:\n" + myText);
  }
  LOG.assertTrue(curNode == null,"Unbalanced tree");
  return rootNode;
}
