{
  final PsiFileImpl file=(PsiFileImpl)oldNode.getPsi().getContainingFile();
  final PomModel model=file.getProject().getModel();
  try {
    model.runTransaction(new PomTransactionBase(file,model.getModelAspect(TreeAspect.class)){
      public PomModelEvent runInner() throws IncorrectOperationException {
        final MyBuilder builder=new MyBuilder(file,newNode);
        DiffTree.diff(new ASTStructure(oldNode),new MyTreeStructure(newNode),new MyComparator(),builder);
        file.subtreeChanged();
        return new TreeAspectEvent(model,builder.getEvent());
      }
    }
);
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
catch (  Throwable e) {
    throw new RuntimeException(UNBALANCED_MESSAGE,e);
  }
}
