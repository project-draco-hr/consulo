{
  if (thisElement == null)   return null;
  PsiElement element=thisElement.findElementAt(offset);
  if (element == null)   return null;
  offset=thisElement.getTextRange().getStartOffset() + offset - element.getTextRange().getStartOffset();
  List<PsiReference> referencesList=new ArrayList<PsiReference>();
  while (element != null) {
    addReferences(offset,element,referencesList);
    offset=element.getStartOffsetInParent() + offset;
    if (element instanceof PsiFile)     break;
    element=element.getParent();
  }
  if (referencesList.size() > 1) {
    for (Iterator<PsiReference> i=referencesList.iterator(); i.hasNext(); ) {
      final PsiReference reference=i.next();
      if (reference instanceof JavaClassReference) {
        if (((JavaClassReference)reference).getProvider() instanceof JavaClassListReferenceProvider) {
          i.remove();
        }
      }
    }
  }
  if (referencesList.isEmpty())   return null;
  if (referencesList.size() == 1)   return referencesList.get(0);
  return new PsiMultiReference(referencesList.toArray(new PsiReference[referencesList.size()]),referencesList.get(referencesList.size() - 1).getElement());
}
