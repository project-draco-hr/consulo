{
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  if (mySmartPointersOrRangeMarkers.size() == 0) {
    throw new WriteExternalException();
  }
  String date=null;
  for (int i=0; i < mySmartPointersOrRangeMarkers.size(); i++) {
    Object o=mySmartPointersOrRangeMarkers.get(i);
    Boolean state=myExpandedStates.get(i);
    if (o instanceof SmartPsiElementPointer) {
      SmartPsiElementPointer pointer=(SmartPsiElementPointer)o;
      PsiElement psiElement=pointer.getElement();
      if (psiElement == null)       continue;
      String signature=FoldingPolicy.getSignature(psiElement);
      if (signature == null)       continue;
      PsiElement restoredElement=FoldingPolicy.restoreBySignature(psiElement.getContainingFile(),signature);
      if (!psiElement.equals(restoredElement)) {
        restoredElement=FoldingPolicy.restoreBySignature(psiElement.getContainingFile(),signature);
        LOG.assertTrue(false,"element:" + psiElement + ", signature:"+ signature+ ", file:"+ psiElement.getContainingFile());
      }
      Element e=new Element(ELEMENT_TAG);
      e.setAttribute(SIGNATURE_ATT,signature);
      e.setAttribute(EXPANDED_ATT,state.toString());
      element.addContent(e);
    }
 else {
      RangeMarker marker=(RangeMarker)o;
      Element e=new Element(MARKER_TAG);
      if (date == null) {
        date=getTimeStamp();
      }
      if ("".equals(date))       continue;
      e.setAttribute(DATE_ATT,date);
      e.setAttribute(EXPANDED_ATT,state.toString());
      String signature=new Integer(marker.getStartOffset()) + ":" + new Integer(marker.getEndOffset());
      e.setAttribute(SIGNATURE_ATT,signature);
      String placeHolderText=myPlaceholderTexts.get(marker);
      e.setAttribute(PLACEHOLDER_ATT,placeHolderText);
      element.addContent(e);
    }
  }
}
