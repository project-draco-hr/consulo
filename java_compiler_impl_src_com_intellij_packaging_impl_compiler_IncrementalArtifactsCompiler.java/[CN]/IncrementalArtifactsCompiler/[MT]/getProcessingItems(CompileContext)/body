{
  return new ReadAction<ProcessingItem[]>(){
    protected void run(    final Result<ProcessingItem[]> result){
      ArtifactsProcessingItemsBuilderContext builderContext=new ArtifactsProcessingItemsBuilderContext(context);
      context.putUserData(BUILDER_CONTEXT_KEY,builderContext);
      ArtifactPackagingProcessingItem[] allProcessingItems=collectItems(builderContext,context.getProject());
      if (LOG.isDebugEnabled()) {
        int num=Math.min(100,allProcessingItems.length);
        LOG.debug("All files (" + num + " of "+ allProcessingItems.length+ "):");
        for (int i=0; i < num; i++) {
          LOG.debug(allProcessingItems[i].getFile().getPath());
        }
      }
      try {
        final FileProcessingCompilerStateCache cache=CompilerCacheManager.getInstance(context.getProject()).getFileProcessingCompilerCache(IncrementalArtifactsCompiler.this);
        for (        ArtifactPackagingProcessingItem item : allProcessingItems) {
          item.init(cache);
        }
      }
 catch (      IOException e) {
        context.requestRebuildNextTime(e.getMessage());
        context.addMessage(CompilerMessageCategory.ERROR,e.getMessage(),null,-1,-1);
        result.setResult(ProcessingItem.EMPTY_ARRAY);
        LOG.info(e);
        return;
      }
      boolean hasFilesToDelete=collectFilesToDelete(context,builderContext.getProcessingItems());
      if (hasFilesToDelete) {
        MockProcessingItem mockItem=new MockProcessingItem(new LightVirtualFile("239239293"));
        result.setResult(ArrayUtil.append(allProcessingItems,mockItem,ProcessingItem.class));
      }
 else {
        result.setResult(allProcessingItems);
      }
    }
  }
.execute().getResultObject();
}
