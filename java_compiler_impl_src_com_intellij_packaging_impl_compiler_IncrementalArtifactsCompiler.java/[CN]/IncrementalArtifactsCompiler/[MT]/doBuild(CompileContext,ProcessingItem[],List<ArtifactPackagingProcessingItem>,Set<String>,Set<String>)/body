{
  final boolean testMode=ApplicationManager.getApplication().isUnitTestMode();
  if (LOG.isDebugEnabled()) {
    int num=Math.min(100,items.length);
    LOG.debug("Files to process (" + num + " of "+ items.length+ "):");
    for (int i=0; i < num; i++) {
      LOG.debug(items[i].getFile().getPath());
    }
  }
  final DeploymentUtil deploymentUtil=DeploymentUtil.getInstance();
  final FileFilter fileFilter=new IgnoredFileFilter();
  final ArtifactsProcessingItemsBuilderContext builderContext=context.getUserData(BUILDER_CONTEXT_KEY);
  final Set<JarInfo> changedJars=new THashSet<JarInfo>();
  for (  String deletedJar : deletedJars) {
    ContainerUtil.addIfNotNull(builderContext.getJarInfo(deletedJar),changedJars);
  }
  try {
    onBuildStartedOrFinished(builderContext,false);
    if (context.getMessageCount(CompilerMessageCategory.ERROR) > 0) {
      return false;
    }
    int i=0;
    for (    final ProcessingItem item0 : items) {
      if (item0 instanceof MockProcessingItem)       continue;
      final ArtifactPackagingProcessingItem item=(ArtifactPackagingProcessingItem)item0;
      context.getProgressIndicator().checkCanceled();
      final Ref<IOException> exception=Ref.create(null);
      new ReadAction(){
        protected void run(        final Result result){
          final File fromFile=VfsUtil.virtualToIoFile(item.getFile());
          for (          DestinationInfo destination : item.getEnabledDestinations()) {
            if (destination instanceof ExplodedDestinationInfo) {
              final ExplodedDestinationInfo explodedDestination=(ExplodedDestinationInfo)destination;
              File toFile=new File(FileUtil.toSystemDependentName(explodedDestination.getOutputPath()));
              if (fromFile.exists()) {
                try {
                  deploymentUtil.copyFile(fromFile,toFile,context,writtenPaths,fileFilter);
                }
 catch (                IOException e) {
                  exception.set(e);
                  return;
                }
              }
            }
 else {
              changedJars.add(((JarDestinationInfo)destination).getJarInfo());
            }
          }
        }
      }
.execute();
      if (exception.get() != null) {
        throw exception.get();
      }
      context.getProgressIndicator().setFraction(++i * 1.0 / items.length);
      processedItems.add(item);
      if (testMode) {
        CompilerManagerImpl.addRecompiledPath(FileUtil.toSystemDependentName(item.getFile().getPath()));
      }
    }
    JarsBuilder builder=new JarsBuilder(changedJars,fileFilter,context);
    final boolean processed=builder.buildJars(writtenPaths);
    if (!processed) {
      return false;
    }
    Set<VirtualFile> recompiledSources=new HashSet<VirtualFile>();
    for (    JarInfo info : builder.getJarsToBuild()) {
      for (      Pair<String,VirtualFile> pair : info.getPackedFiles()) {
        recompiledSources.add(pair.getSecond());
      }
    }
    for (    ArtifactPackagingProcessingItem processedItem : processedItems) {
      recompiledSources.remove(processedItem.getFile());
    }
    for (    VirtualFile source : recompiledSources) {
      ArtifactPackagingProcessingItem item=builderContext.getItemBySource(source);
      LOG.assertTrue(item != null,source);
      processedItems.add(item);
      if (testMode) {
        CompilerManagerImpl.addRecompiledPath(FileUtil.toSystemDependentName(item.getFile().getPath()));
      }
    }
    onBuildStartedOrFinished(builderContext,true);
  }
 catch (  ProcessCanceledException e) {
    throw e;
  }
catch (  Exception e) {
    LOG.info(e);
    context.addMessage(CompilerMessageCategory.ERROR,e.getLocalizedMessage(),null,-1,-1);
    return false;
  }
  return true;
}
