{
  final Set<String> deletedJars=deleteOutdatedFiles(context);
  final List<ArtifactPackagingProcessingItem> processedItems=new ArrayList<ArtifactPackagingProcessingItem>();
  final Set<String> writtenPaths=createPathsHashSet();
  final Ref<Boolean> built=Ref.create(false);
  CompilerUtil.runInContext(context,"Copying files",new ThrowableRunnable<RuntimeException>(){
    public void run() throws RuntimeException {
      built.set(doBuild(context,items,processedItems,writtenPaths,deletedJars));
    }
  }
);
  if (!built.get()) {
    return ProcessingItem.EMPTY_ARRAY;
  }
  context.getProgressIndicator().setText(CompilerBundle.message("packaging.compiler.message.updating.caches"));
  context.getProgressIndicator().setText2("");
  refreshOutputFiles(writtenPaths);
  new ReadAction(){
    protected void run(    final Result result){
      processDestinations(processedItems);
    }
  }
.execute();
  removeInvalidItems(processedItems);
  updateOutputCache(context.getProject(),processedItems);
  context.putUserData(WRITTEN_PATHS_KEY,writtenPaths);
  return processedItems.toArray(new ProcessingItem[processedItems.size()]);
}
