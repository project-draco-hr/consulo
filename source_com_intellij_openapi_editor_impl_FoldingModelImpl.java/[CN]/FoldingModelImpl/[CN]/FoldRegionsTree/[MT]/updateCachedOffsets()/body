{
  if (FoldingModelImpl.this.isFoldingEnabled()) {
    if (myCachedVisible == null) {
      rebuild();
      return;
    }
    for (    FoldRegion foldRegion : myCachedVisible) {
      if (!foldRegion.isValid()) {
        rebuild();
        return;
      }
    }
    int sum=0;
    if (myCachedEndOffsets == null || myCachedEndOffsets.length != myCachedTopLevelRegions.length) {
      myCachedEndOffsets=new int[myCachedTopLevelRegions.length];
      myCachedStartOffsets=new int[myCachedTopLevelRegions.length];
      myCachedFoldedLines=new int[myCachedTopLevelRegions.length];
    }
    for (int i=0; i < myCachedTopLevelRegions.length; i++) {
      FoldRegion region=myCachedTopLevelRegions[i];
      myCachedStartOffsets[i]=region.getStartOffset();
      myCachedEndOffsets[i]=region.getEndOffset() - 1;
      sum+=region.getDocument().getLineNumber(region.getEndOffset()) - region.getDocument().getLineNumber(region.getStartOffset());
      myCachedFoldedLines[i]=sum;
    }
  }
}
