{
  final JavaSourceTransformingCompiler[] transformers=CompilerManager.getInstance(myProject).getCompilers(JavaSourceTransformingCompiler.class);
  if (transformers.length == 0) {
    return;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Running transforming compilers...");
  }
  final Module[] modules=chunk.getModules();
  for (  final JavaSourceTransformingCompiler transformer : transformers) {
    final Map<VirtualFile,VirtualFile> originalToCopyFileMap=new HashMap<VirtualFile,VirtualFile>();
    final Application application=ApplicationManager.getApplication();
    application.invokeAndWait(new Runnable(){
      public void run(){
        for (        final Module module : modules) {
          for (          final VirtualFile file : chunk.getFilesToCompile(module)) {
            final VirtualFile untransformed=chunk.getOriginalFile(file);
            if (transformer.isTransformable(untransformed)) {
              application.runWriteAction(new Runnable(){
                public void run(){
                  try {
                    final VirtualFile fileCopy=untransformed.equals(file) ? createFileCopy(getTempDir(module),file) : file;
                    originalToCopyFileMap.put(file,fileCopy);
                  }
 catch (                  IOException e) {
                  }
                }
              }
);
            }
          }
        }
      }
    }
,myCompileContext.getProgressIndicator().getModalityState());
    for (    final Module module : modules) {
      final List<VirtualFile> filesToCompile=chunk.getFilesToCompile(module);
      for (int j=0; j < filesToCompile.size(); j++) {
        final VirtualFile file=filesToCompile.get(j);
        final VirtualFile fileCopy=originalToCopyFileMap.get(file);
        if (fileCopy != null) {
          final boolean ok=transformer.transform(myCompileContext,fileCopy,chunk.getOriginalFile(file));
          if (ok) {
            chunk.substituteWithTransformedVersion(module,j,fileCopy);
          }
        }
      }
    }
  }
}
