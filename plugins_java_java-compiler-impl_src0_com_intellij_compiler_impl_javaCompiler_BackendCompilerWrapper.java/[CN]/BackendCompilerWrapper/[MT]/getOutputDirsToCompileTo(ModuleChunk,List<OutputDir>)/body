{
  File fileToDelete=null;
  if (chunk.getModuleCount() == 1) {
    final Module module=chunk.getModules()[0];
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        final String sourcesOutputDir=getOutputDir(module);
        if (shouldCompileTestsSeparately(module)) {
          if (sourcesOutputDir != null) {
            dirs.add(new OutputDir(sourcesOutputDir,ModuleChunk.SOURCES));
          }
          final String testsOutputDir=getTestsOutputDir(module);
          if (testsOutputDir == null) {
            LOG.error("Tests output dir is null for module \"" + module.getName() + "\"");
          }
 else {
            dirs.add(new OutputDir(testsOutputDir,ModuleChunk.TEST_SOURCES));
          }
        }
 else {
          if (sourcesOutputDir == null) {
            LOG.error("Sources output dir is null for module \"" + module.getName() + "\"");
          }
 else {
            dirs.add(new OutputDir(sourcesOutputDir,ModuleChunk.ALL_SOURCES));
          }
        }
      }
    }
);
  }
 else {
    final File outputDir=FileUtil.createTempDirectory("compile","output");
    fileToDelete=outputDir;
    dirs.add(new OutputDir(outputDir.getPath(),ModuleChunk.ALL_SOURCES));
  }
  return fileToDelete;
}
