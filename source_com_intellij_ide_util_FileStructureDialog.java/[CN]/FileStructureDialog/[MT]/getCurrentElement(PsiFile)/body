{
  if (psiFile == null)   return null;
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  PsiElement element=psiFile.findElementAt(myEditor.getCaretModel().getOffset());
  for (; element != null; element=element.getParent()) {
    if (element instanceof PsiMethod) {
      PsiMethod method=(PsiMethod)element;
      PsiElement parent=method.getParent();
      if (parent instanceof PsiClass) {
        PsiClass psiClass=(PsiClass)parent;
        String name=psiClass.getQualifiedName();
        if (name == null)         continue;
        return method;
      }
    }
 else     if (element instanceof PsiField) {
      PsiField field=(PsiField)element;
      PsiElement parent=field.getParent();
      if (parent instanceof PsiClass) {
        PsiClass psiClass=(PsiClass)parent;
        String name=psiClass.getQualifiedName();
        if (name == null)         continue;
        return field;
      }
    }
 else     if (element instanceof PsiClass) {
      PsiClass psiClass=(PsiClass)element;
      String name=psiClass.getQualifiedName();
      if (name == null)       continue;
      return psiClass;
    }
  }
  Object elementAtCursor=myTreeModel.getCurrentEditorElement();
  if (elementAtCursor instanceof PsiElement) {
    return (PsiElement)elementAtCursor;
  }
  return null;
}
