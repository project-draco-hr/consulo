{
  return ApplicationManager.getApplication().runReadAction(new Computable<List<T>>(){
    @Override public List<T> compute(){
      final Collection<VirtualFile> files;
      try {
        files=FileBasedIndex.getInstance().getContainingFiles(KEY,className,GlobalSearchScope.projectScope(project).intersectWith(scope));
      }
 catch (      IndexNotReadyException e) {
        return Collections.emptyList();
      }
      if (files.isEmpty())       return Collections.emptyList();
      List<T> result=new ArrayList<T>();
      for (      VirtualFile file : files) {
        if (!file.isValid())         continue;
        final T fFile=f.fun(file);
        if (fFile != null) {
          result.add(fFile);
        }
      }
      return result;
    }
  }
);
}
