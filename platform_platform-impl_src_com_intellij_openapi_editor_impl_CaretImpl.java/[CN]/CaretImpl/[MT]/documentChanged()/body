{
  MyRangeMarker marker=mySelectionMarker;
  if (marker != null) {
    int endAfter;
    int startAfter;
    if (marker.isValid()) {
      startAfter=marker.getStartOffset();
      endAfter=marker.getEndOffset();
      if (myEndVirtualOffset > 0 && (!isVirtualSelectionEnabled() || !EditorUtil.isAtLineEnd(myEditor,endAfter) || myEditor.getDocument().getLineNumber(startAfter) != myEditor.getDocument().getLineNumber(endAfter))) {
        myStartVirtualOffset=0;
        myEndVirtualOffset=0;
      }
    }
 else {
      startAfter=endAfter=getOffset();
      marker.release();
      myStartVirtualOffset=0;
      myEndVirtualOffset=0;
      mySelectionMarker=null;
    }
    if (startBefore != startAfter || endBefore != endAfter) {
      myEditor.getSelectionModel().fireSelectionChanged(startBefore,endBefore,startAfter,endAfter);
    }
  }
}
