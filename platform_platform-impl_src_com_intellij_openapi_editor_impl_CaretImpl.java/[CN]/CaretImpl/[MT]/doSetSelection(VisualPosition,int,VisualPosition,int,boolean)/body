{
  myEditor.getCaretModel().doWithCaretMerging(new Runnable(){
    public void run(){
      VisualPosition startPosition=_startPosition;
      int startOffset=_startOffset;
      VisualPosition endPosition=_endPosition;
      int endOffset=_endOffset;
      myUnknownDirection=false;
      final Document doc=myEditor.getDocument();
      final Pair<String,String> markers=myEditor.getUserData(EditorImpl.EDITABLE_AREA_MARKER);
      if (markers != null) {
        final String text=doc.getText();
        final int start=text.indexOf(markers.first) + markers.first.length();
        final int end=text.indexOf(markers.second);
        if (startOffset < endOffset) {
          if (startOffset < start) {
            startOffset=start;
            startPosition=myEditor.offsetToVisualPosition(startOffset);
          }
          if (endOffset > end) {
            endOffset=end;
            endPosition=myEditor.offsetToVisualPosition(endOffset);
          }
        }
 else {
          if (endOffset < start) {
            endOffset=start;
            endPosition=myEditor.offsetToVisualPosition(startOffset);
          }
          if (startOffset > end) {
            startOffset=end;
            startPosition=myEditor.offsetToVisualPosition(endOffset);
          }
        }
      }
      validateContext(true);
      myEditor.getSelectionModel().removeBlockSelection();
      int textLength=doc.getTextLength();
      if (startOffset < 0 || startOffset > textLength) {
        LOG.error("Wrong startOffset: " + startOffset + ", textLength="+ textLength);
      }
      if (endOffset < 0 || endOffset > textLength) {
        LOG.error("Wrong endOffset: " + endOffset + ", textLength="+ textLength);
      }
      if (!visualPositionAware && startOffset == endOffset) {
        removeSelection();
        return;
      }
      boolean switchedOffsets=false;
      if (startOffset > endOffset) {
        int tmp=startOffset;
        startOffset=endOffset;
        endOffset=tmp;
        switchedOffsets=true;
      }
      FoldingModelEx foldingModel=myEditor.getFoldingModel();
      FoldRegion startFold=foldingModel.getCollapsedRegionAtOffset(startOffset);
      if (startFold != null && startFold.getStartOffset() < startOffset) {
        startOffset=startFold.getStartOffset();
      }
      FoldRegion endFold=foldingModel.getCollapsedRegionAtOffset(endOffset);
      if (endFold != null && endFold.getStartOffset() < endOffset) {
        endOffset=endFold.getEndOffset();
      }
      int oldSelectionStart;
      int oldSelectionEnd;
      if (hasSelection()) {
        oldSelectionStart=getSelectionStart();
        oldSelectionEnd=getSelectionEnd();
        if (oldSelectionStart == startOffset && oldSelectionEnd == endOffset && !visualPositionAware)         return;
      }
 else {
        oldSelectionStart=oldSelectionEnd=getOffset();
      }
      MyRangeMarker marker=mySelectionMarker;
      if (marker != null) {
        marker.release();
      }
      marker=new MyRangeMarker((DocumentEx)doc,startOffset,endOffset);
      myStartVirtualOffset=0;
      myEndVirtualOffset=0;
      if (visualPositionAware) {
        if (endPosition.after(startPosition)) {
          marker.setStartPosition(startPosition);
          marker.setEndPosition(endPosition);
          marker.setEndPositionIsLead(false);
        }
 else {
          marker.setStartPosition(endPosition);
          marker.setEndPosition(startPosition);
          marker.setEndPositionIsLead(true);
        }
        if (isVirtualSelectionEnabled() && myEditor.getDocument().getLineNumber(startOffset) == myEditor.getDocument().getLineNumber(endOffset)) {
          int endLineColumn=myEditor.offsetToVisualPosition(endOffset).column;
          int startDiff=EditorUtil.isAtLineEnd(myEditor,switchedOffsets ? endOffset : startOffset) ? startPosition.column - endLineColumn : 0;
          int endDiff=EditorUtil.isAtLineEnd(myEditor,switchedOffsets ? startOffset : endOffset) ? endPosition.column - endLineColumn : 0;
          myStartVirtualOffset=Math.max(0,Math.min(startDiff,endDiff));
          myEndVirtualOffset=Math.max(0,Math.max(startDiff,endDiff));
        }
      }
      mySelectionMarker=marker;
      myEditor.getSelectionModel().fireSelectionChanged(oldSelectionStart,oldSelectionEnd,startOffset,endOffset);
      updateSystemSelection();
    }
  }
);
}
