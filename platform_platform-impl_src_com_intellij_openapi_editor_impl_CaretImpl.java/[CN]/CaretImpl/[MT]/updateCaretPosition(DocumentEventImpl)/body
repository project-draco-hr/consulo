{
  final DocumentEx document=myEditor.getDocument();
  if (document.isInBulkUpdate())   return;
  boolean performSoftWrapAdjustment=event.getNewLength() > 0 || myEditor.getSoftWrapModel().getSoftWrap(event.getOffset()) != null;
  if (event.isWholeTextReplaced()) {
    int newLength=document.getTextLength();
    if (myOffset == newLength - event.getNewLength() + event.getOldLength() || newLength == 0) {
      moveToOffset(newLength,performSoftWrapAdjustment);
    }
 else {
      try {
        final int line=event.translateLineViaDiff(myLogicalCaret.line);
        moveToLogicalPosition(new LogicalPosition(line,myLogicalCaret.column),performSoftWrapAdjustment,null,true);
      }
 catch (      FilesTooBigForDiffException e1) {
        LOG.info(e1);
        moveToOffset(0);
      }
    }
  }
 else {
    int startOffset=event.getOffset();
    int oldEndOffset=startOffset + event.getOldLength();
    int newOffset=myOffset;
    if (myOffset > oldEndOffset || myOffset == oldEndOffset && needToShiftWhiteSpaces(event)) {
      newOffset+=event.getNewLength() - event.getOldLength();
    }
 else     if (myOffset >= startOffset && myOffset <= oldEndOffset) {
      newOffset=Math.min(newOffset,startOffset + event.getNewLength());
    }
    newOffset=Math.min(newOffset,document.getTextLength());
    if (myOffset != startOffset) {
      LogicalPosition pos=myEditor.offsetToLogicalPosition(newOffset);
      moveToLogicalPosition(new LogicalPosition(pos.line,pos.column + myVirtualSpaceOffset),performSoftWrapAdjustment,null,true);
    }
 else {
      moveToOffset(newOffset,performSoftWrapAdjustment);
    }
  }
  updateVisualLineInfo();
}
