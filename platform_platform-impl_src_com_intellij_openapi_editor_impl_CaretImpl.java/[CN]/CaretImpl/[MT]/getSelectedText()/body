{
  if (!hasSelection()) {
    return null;
  }
  CharSequence text=myEditor.getDocument().getCharsSequence();
  int selectionStart=getSelectionStart();
  int selectionEnd=getSelectionEnd();
  String selectedText=text.subSequence(selectionStart,selectionEnd).toString();
  if (isVirtualSelectionEnabled() && myEndVirtualOffset > myStartVirtualOffset) {
    int padding=myEndVirtualOffset - myStartVirtualOffset;
    StringBuilder builder=new StringBuilder(selectedText.length() + padding);
    builder.append(selectedText);
    for (int i=0; i < padding; i++) {
      builder.append(' ');
    }
    return builder.toString();
  }
 else {
    return selectedText;
  }
}
