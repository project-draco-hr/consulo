{
  RangeMarker marker=mySelectionMarker;
  VisualPosition caretPosition=getVisualPosition();
  if (isVirtualSelectionEnabled() && !hasSelection()) {
    return caretPosition;
  }
  if (marker == null) {
    return caretPosition;
  }
  if (isRangeMarkerEndPositionIsLead()) {
    VisualPosition result=getRangeMarkerEndPosition();
    if (result == null) {
      return getSelectionEndPosition();
    }
 else {
      if (hasVirtualSelection()) {
        result=new VisualPosition(result.line,result.column + myEndVirtualOffset);
      }
      return result;
    }
  }
 else {
    VisualPosition result=getRangeMarkerStartPosition();
    if (result == null) {
      return getSelectionStartPosition();
    }
 else {
      if (hasVirtualSelection()) {
        result=new VisualPosition(result.line,result.column + myStartVirtualOffset);
      }
      return result;
    }
  }
}
