{
  MyRangeMarker marker=mySelectionMarker;
  VisualPosition caretPosition=getVisualPosition();
  if (marker == null) {
    return caretPosition;
  }
  if (marker.isEndPositionIsLead()) {
    VisualPosition result=marker.getEndPosition();
    return result == null ? getSelectionEndPosition() : result;
  }
 else {
    VisualPosition result=marker.getStartPosition();
    return result == null ? getSelectionStartPosition() : result;
  }
}
