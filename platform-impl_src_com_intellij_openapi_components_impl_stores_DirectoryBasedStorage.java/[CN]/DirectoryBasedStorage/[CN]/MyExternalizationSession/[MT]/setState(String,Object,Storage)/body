{
  try {
    final Element element=DefaultStateSerializer.serializeState(state,storageSpec);
    if (myPathMacroSubstitutor != null) {
      myPathMacroSubstitutor.collapsePaths(element);
    }
    final List<Pair<Element,String>> states=mySplitter.splitState(element);
    for (    Pair<Element,String> pair : states) {
      Element e=pair.first;
      String name=pair.second;
      Element statePart=new Element(COMPONENT);
      statePart.setAttribute(NAME,componentName);
      e.detach();
      statePart.addContent(e);
      myStorageData.put(componentName,myDir.getChild(name),statePart);
    }
  }
 catch (  WriteExternalException e) {
    throw new StateStorageException(e);
  }
}
