{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        PsiFile psiFile=PsiFileFactory.getInstance(project).createFileFromText("a." + getFileType().getDefaultExtension(),getFileType(),myTextToReformat,LocalTimeCounter.currentTime(),false,false);
        psiFile.putUserData(PsiUtil.FILE_LANGUAGE_LEVEL_KEY,LanguageLevel.HIGHEST);
        apply(mySettings);
        CodeStyleSettings clone=(CodeStyleSettings)mySettings.clone();
        if (getRightMargin() > 0) {
          clone.RIGHT_MARGIN=getRightMargin();
        }
        CodeStyleSettingsManager.getInstance(project).setTemporarySettings(clone);
        CodeStyleManager.getInstance(project).reformat(psiFile);
        CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
        myEditor.getSettings().setTabSize(clone.getTabSize(getFileType()));
        Document document=myEditor.getDocument();
        document.replaceString(0,document.getTextLength(),psiFile.getText());
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
);
}
