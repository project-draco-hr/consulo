{
  final Project project=ProjectManager.getInstance().getDefaultProject();
  final PsiManager manager=PsiManager.getInstance(project);
  final LanguageLevel effectiveLanguageLevel=manager.getEffectiveLanguageLevel();
  manager.setEffectiveLanguageLevel(LanguageLevel.HIGHEST);
  try {
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        PsiElementFactory factory=manager.getElementFactory();
        try {
          PsiFile psiFile=factory.createFileFromText("a." + getFileType().getDefaultExtension(),myTextToReformat);
          apply(mySettings);
          CodeStyleSettings clone=(CodeStyleSettings)mySettings.clone();
          if (getRightMargin() > 0) {
            clone.RIGHT_MARGIN=getRightMargin();
          }
          CodeStyleSettingsManager.getInstance(project).setTemporarySettings(clone);
          CodeStyleManager.getInstance(project).reformat(psiFile);
          CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
          myEditor.getSettings().setTabSize(clone.getTabSize(getFileType()));
          Document document=myEditor.getDocument();
          document.replaceString(0,document.getTextLength(),psiFile.getText());
        }
 catch (        IncorrectOperationException e) {
          LOG.error(e);
        }
      }
    }
);
  }
  finally {
    manager.setEffectiveLanguageLevel(effectiveLanguageLevel);
  }
}
