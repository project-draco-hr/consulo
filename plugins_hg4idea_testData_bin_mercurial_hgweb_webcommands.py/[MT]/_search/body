def _search(web, req, tmpl):
    query = req.form['rev'][0]
    revcount = web.maxchanges
    if ('revcount' in req.form):
        revcount = int(req.form.get('revcount', [revcount])[0])
        tmpl.defaults['sessionvars']['revcount'] = revcount
    lessvars = copy.copy(tmpl.defaults['sessionvars'])
    lessvars['revcount'] = (revcount / 2)
    lessvars['rev'] = query
    morevars = copy.copy(tmpl.defaults['sessionvars'])
    morevars['revcount'] = (revcount * 2)
    morevars['rev'] = query

    def changelist(**map):
        cl = web.repo.changelog
        count = 0
        qw = query.lower().split()

        def revgen():
            for i in xrange((len(cl) - 1), 0, (-100)):
                l = []
                for j in xrange(max(0, (i - 100)), (i + 1)):
                    ctx = web.repo[j]
                    l.append(ctx)
                l.reverse()
                for e in l:
                    yield e
        for ctx in revgen():
            miss = 0
            for q in qw:
                if (not ((q in ctx.user().lower()) or (q in ctx.description().lower()) or (q in ' '.join(ctx.files()).lower()))):
                    miss = 1
                    break
            if miss:
                continue
            count += 1
            n = ctx.node()
            showtags = webutil.showtag(web.repo, tmpl, 'changelogtag', n)
            files = webutil.listfilediffs(tmpl, ctx.files(), n, web.maxfiles)
            yield tmpl('searchentry', parity=parity.next(), author=ctx.user(), parent=webutil.parents(ctx), child=webutil.children(ctx), changelogtag=showtags, desc=ctx.description(), date=ctx.date(), files=files, rev=ctx.rev(), node=hex(n), tags=webutil.nodetagsdict(web.repo, n), inbranch=webutil.nodeinbranch(web.repo, ctx), branches=webutil.nodebranchdict(web.repo, ctx))
            if (count >= revcount):
                break
    cl = web.repo.changelog
    parity = paritygen(web.stripecount)
    return tmpl('search', query=query, node=hex(cl.tip()), entries=changelist, archives=web.archivelist('tip'), morevars=morevars, lessvars=lessvars)
