def archive(web, req, tmpl):
    type_ = req.form.get('type', [None])[0]
    allowed = web.configlist('web', 'allow_archive')
    key = req.form['node'][0]
    if (type_ not in web.archives):
        msg = ('Unsupported archive type: %s' % type_)
        raise ErrorResponse(HTTP_NOT_FOUND, msg)
    if (not ((type_ in allowed) or web.configbool('web', ('allow' + type_), False))):
        msg = ('Archive type not allowed: %s' % type_)
        raise ErrorResponse(HTTP_FORBIDDEN, msg)
    reponame = re.sub('\\W+', '-', os.path.basename(web.reponame))
    cnode = web.repo.lookup(key)
    arch_version = key
    if ((cnode == key) or (key == 'tip')):
        arch_version = short(cnode)
    name = ('%s-%s' % (reponame, arch_version))
    (mimetype, artype, extension, encoding) = web.archive_specs[type_]
    headers = [('Content-Type', mimetype), ('Content-Disposition', ('attachment; filename=%s%s' % (name, extension)))]
    if encoding:
        headers.append(('Content-Encoding', encoding))
    req.header(headers)
    req.respond(HTTP_OK)
    archival.archive(web.repo, req, cnode, artype, prefix=name)
    return []
