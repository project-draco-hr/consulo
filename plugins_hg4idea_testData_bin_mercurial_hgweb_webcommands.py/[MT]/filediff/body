def filediff(web, req, tmpl):
    (fctx, ctx) = (None, None)
    try:
        fctx = webutil.filectx(web.repo, req)
    except LookupError:
        ctx = webutil.changectx(web.repo, req)
        path = webutil.cleanpath(web.repo, req.form['file'][0])
        if (path not in ctx.files()):
            raise
    if (fctx is not None):
        n = fctx.node()
        path = fctx.path()
    else:
        n = ctx.node()
    parity = paritygen(web.stripecount)
    style = web.config('web', 'style', 'paper')
    if ('style' in req.form):
        style = req.form['style'][0]
    diffs = webutil.diffs(web.repo, tmpl, (fctx or ctx), [path], parity, style)
    rename = ((fctx and webutil.renamelink(fctx)) or [])
    ctx = ((fctx and fctx) or ctx)
    return tmpl('filediff', file=path, node=hex(n), rev=ctx.rev(), date=ctx.date(), desc=ctx.description(), author=ctx.user(), rename=rename, branch=webutil.nodebranchnodefault(ctx), parent=webutil.parents(ctx), child=webutil.children(ctx), diff=diffs)
