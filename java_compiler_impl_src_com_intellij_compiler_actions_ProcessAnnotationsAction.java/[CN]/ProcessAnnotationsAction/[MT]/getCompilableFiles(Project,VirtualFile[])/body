{
  if (files == null || files.length == 0) {
    return null;
  }
  final PsiManager psiManager=PsiManager.getInstance(project);
  final FileTypeManager typeManager=FileTypeManager.getInstance();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final CompilerManager compilerManager=CompilerManager.getInstance(project);
  final List<VirtualFile> filesToCompile=new ArrayList<VirtualFile>();
  final List<Module> affectedModules=new ArrayList<Module>();
  for (  final VirtualFile file : files) {
    if (!fileIndex.isInSourceContent(file)) {
      continue;
    }
    if (!file.isInLocalFileSystem()) {
      continue;
    }
    if (file.isDirectory()) {
      final PsiDirectory directory=psiManager.findDirectory(file);
      if (directory == null || JavaDirectoryService.getInstance().getPackage(directory) == null) {
        continue;
      }
    }
 else {
      FileType fileType=typeManager.getFileTypeByFile(file);
      if (!(compilerManager.isCompilableFileType(fileType))) {
        continue;
      }
    }
    filesToCompile.add(file);
    ContainerUtil.addIfNotNull(fileIndex.getModuleForFile(file),affectedModules);
  }
  if (filesToCompile.isEmpty())   return null;
  return new FileSetCompileScope(filesToCompile,affectedModules.toArray(new Module[affectedModules.size()]));
}
