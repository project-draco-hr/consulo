{
  LogicalPosition pos=editor.getCaretModel().getLogicalPosition();
  Project project=editor.getProject();
  Lookup lookup=project == null ? null : LookupManager.getInstance(project).getActiveLookup();
  LOG.assertTrue(SwingUtilities.isEventDispatchThread());
  if (lookup == null) {
    for (    HintInfo info : myHintsStack) {
      if (!info.hint.isSelectingHint())       continue;
      final Rectangle rectangle=info.hint.getBounds();
      if (rectangle != null) {
        return getHintPositionRelativeTo(hint,editor,constraint,rectangle,rectangle,pos);
      }
    }
    return getHintPosition(hint,editor,pos,constraint);
  }
 else {
    Rectangle cellBounds=lookup.getCurrentItemBounds();
    if (cellBounds == null) {
      return getHintPosition(hint,editor,pos,constraint);
    }
    Rectangle lookupBounds=lookup.getBounds();
    return getHintPositionRelativeTo(hint,editor,constraint,cellBounds,lookupBounds,pos);
  }
}
