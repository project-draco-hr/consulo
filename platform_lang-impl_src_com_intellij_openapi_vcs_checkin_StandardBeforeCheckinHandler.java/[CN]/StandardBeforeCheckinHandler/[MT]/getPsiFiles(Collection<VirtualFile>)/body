{
  ArrayList<PsiFile> result=new ArrayList<PsiFile>();
  PsiManager psiManager=PsiManager.getInstance(myProject);
  VirtualFile projectFileDir=null;
  final StorageScheme storageScheme=((ProjectEx)myProject).getStateStore().getStorageScheme();
  if (StorageScheme.DIRECTORY_BASED.equals(storageScheme)) {
    VirtualFile baseDir=myProject.getBaseDir();
    if (baseDir != null) {
      projectFileDir=baseDir.findChild(Project.DIRECTORY_STORE_FOLDER);
    }
  }
  for (  VirtualFile file : selectedFiles) {
    if (file.isValid()) {
      if (projectFileDir != null && VfsUtil.isAncestor(projectFileDir,file,false)) {
        continue;
      }
      PsiFile psiFile=psiManager.findFile(file);
      if (psiFile != null)       result.add(psiFile);
    }
  }
  return result.toArray(new PsiFile[result.size()]);
}
