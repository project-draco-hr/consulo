{
  if (getTreeParent() != null) {
    CompositeElement parentCopy=(CompositeElement)getTreeParent().copyElement();
synchronized (PsiLock.LOCK) {
      int index=0;
      for (ASTNode child=getTreeParent().firstChild; child != this; child=child.getTreeNext()) {
        index++;
      }
      ASTNode child;
      for (child=parentCopy.firstChild; index > 0; child=child.getTreeNext(), index--) {
      }
      return child;
    }
  }
 else {
    final ASTNode clone=(ASTNode)clone();
    clone.putUserData(MANAGER_KEY,getManager());
    return clone;
  }
}
