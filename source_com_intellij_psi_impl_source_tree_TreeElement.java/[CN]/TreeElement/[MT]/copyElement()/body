{
  if (getTreeParent() != null) {
    CompositeElement parentCopy=(CompositeElement)getTreeParent().copyElement();
synchronized (PsiLock.LOCK) {
      int index=0;
      for (TreeElement child=getTreeParent().firstChild; child != this; child=child.getTreeNext()) {
        index++;
      }
      TreeElement child;
      for (child=parentCopy.firstChild; index > 0; child=child.getTreeNext(), index--) {
      }
      return child;
    }
  }
 else {
    final TreeElement clone=(TreeElement)clone();
    clone.putUserData(MANAGER_KEY,getManager());
    return clone;
  }
}
