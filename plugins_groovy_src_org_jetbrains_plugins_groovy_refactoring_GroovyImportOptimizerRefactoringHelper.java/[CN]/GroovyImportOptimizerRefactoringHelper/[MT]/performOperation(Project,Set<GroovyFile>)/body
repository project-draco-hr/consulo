{
  final GroovyImportOptimizer optimizer=new GroovyImportOptimizer();
  final ProgressManager progressManager=ProgressManager.getInstance();
  final Map<GroovyFile,Pair<List<GrImportStatement>,Set<GrImportStatement>>> redundants=new HashMap<GroovyFile,Pair<List<GrImportStatement>,Set<GrImportStatement>>>();
  final Runnable findUnusedImports=new Runnable(){
    public void run(){
      final ProgressIndicator progressIndicator=progressManager.getProgressIndicator();
      final int total=files.size();
      int i=0;
      for (      final GroovyFile file : files) {
        if (!file.isValid())         continue;
        final VirtualFile virtualFile=file.getVirtualFile();
        if (!ProjectRootManager.getInstance(project).getFileIndex().isInSource(virtualFile)) {
          continue;
        }
        if (progressIndicator != null) {
          progressIndicator.setText2(virtualFile.getPresentableUrl());
          progressIndicator.setFraction((double)i++ / total);
        }
        final Set<GrImportStatement> usedImports=new HashSet<GrImportStatement>();
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            optimizer.findUnusedImports(file,usedImports);
            final List<GrImportStatement> perFile=GroovyImportOptimizer.getValidImportStatements(file);
            redundants.put(file,Pair.create(perFile,usedImports));
          }
        }
);
      }
    }
  }
;
  if (!progressManager.runProcessWithProgressSynchronously(findUnusedImports,"Optimizing imports (Groovy) ... ",false,project)) {
    return;
  }
  AccessToken accessToken=WriteAction.start();
  try {
    for (    GroovyFile groovyFile : redundants.keySet()) {
      if (!groovyFile.isValid())       continue;
      final Pair<List<GrImportStatement>,Set<GrImportStatement>> pair=redundants.get(groovyFile);
      final List<GrImportStatement> redundantPerFile=pair.getFirst();
      final Set<GrImportStatement> usedInFile=pair.getSecond();
      for (      GrImportStatement importStatement : redundantPerFile) {
        if (!usedInFile.contains(importStatement)) {
          groovyFile.removeImport(importStatement);
        }
      }
    }
  }
  finally {
    accessToken.finish();
  }
}
