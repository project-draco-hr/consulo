{
  EditorImpl editor=myView.getEditor();
  int result=EditorUtil.getNotFoldedLineStartOffset(editor,offset);
  SoftWrapModelImpl softWrapModel=editor.getSoftWrapModel();
  List<? extends SoftWrap> softWraps=softWrapModel.getRegisteredSoftWraps();
  int currentOrPrevWrapIndex=softWrapModel.getSoftWrapIndex(offset);
  SoftWrap currentOrPrevWrap;
  if (currentOrPrevWrapIndex < 0) {
    currentOrPrevWrapIndex=-currentOrPrevWrapIndex - 2;
    currentOrPrevWrap=currentOrPrevWrapIndex < 0 || currentOrPrevWrapIndex >= softWraps.size() ? null : softWraps.get(currentOrPrevWrapIndex);
  }
 else {
    currentOrPrevWrap=leanForward ? softWraps.get(currentOrPrevWrapIndex) : null;
  }
  if (currentOrPrevWrap != null && currentOrPrevWrap.getStart() > result) {
    result=currentOrPrevWrap.getStart();
  }
  return result;
}
