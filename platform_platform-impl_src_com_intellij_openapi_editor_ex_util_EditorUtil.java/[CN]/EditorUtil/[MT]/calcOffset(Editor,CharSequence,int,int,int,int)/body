{
  final int maxScanIndex=Math.min(start + columnNumber + 1,end);
  if (editor == null) {
    return calcSoftWrapUnawareOffset(text,start,maxScanIndex,columnNumber,tabSize);
  }
  int column=0;
  int tabAnchor=0;
  SoftWrapModel softWrapModel=editor.getSoftWrapModel();
  for (int i=start; i < maxScanIndex; i++) {
    TextChange softWrap=softWrapModel.getSoftWrap(i);
    if (softWrap != null) {
      tabAnchor=softWrapModel.getSoftWrapIndentWidthInColumns(softWrap);
    }
    if (column >= columnNumber) {
      return i;
    }
    int diff=textWidthInColumns(editor,text,i,i + 1,tabAnchor);
    if (column + diff > columnNumber) {
      return i;
    }
    column+=diff;
    tabAnchor+=diff;
  }
  return end;
}
