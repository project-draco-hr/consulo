{
  boolean useOptimization=true;
  if (editor != null) {
    SoftWrap softWrap=editor.getSoftWrapModel().getSoftWrap(start);
    useOptimization=softWrap == null;
  }
  if (useOptimization) {
    boolean hasNonTabs=false;
    for (int i=start; i < offset; i++) {
      if (text.charAt(i) == '\t') {
        if (hasNonTabs) {
          useOptimization=false;
          break;
        }
      }
 else {
        hasNonTabs=true;
      }
    }
  }
  if (editor == null || useOptimization) {
    int shift=0;
    for (int i=start; i < offset; i++) {
      char c=text.charAt(i);
      if (c == '\n' || c == '\r') {
        String editorInfo=editor instanceof EditorImpl ? ". Editor info: " + ((EditorImpl)editor).dumpState() : "";
        String documentInfo;
        if (text instanceof Dumpable) {
          documentInfo=((Dumpable)text).dumpState();
        }
 else {
          documentInfo="Text holder class: " + text.getClass();
        }
        LogMessageEx.error(LOG,"detected incorrect offset -> column number calculation",String.format("Symbol: '%c', its index: %d, given start: %d, given offset: %d, given tab size: %d. %s%s",c,i,start,offset,tabSize,documentInfo,editorInfo));
      }
      if (c == '\t') {
        shift+=getTabLength(i + shift - start,tabSize) - 1;
      }
    }
    return offset - start + shift;
  }
  EditorEx editorImpl=(EditorEx)editor;
  return editorImpl.calcColumnNumber(text,start,offset,tabSize);
}
