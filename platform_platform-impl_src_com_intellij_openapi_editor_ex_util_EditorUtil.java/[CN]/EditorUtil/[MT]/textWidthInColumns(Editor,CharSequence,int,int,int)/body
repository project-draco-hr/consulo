{
  int startToUse=start;
  int lastTabSymbolIndex=-1;
  loop:   for (int i=end - 1; i >= start; i--) {
switch (text.charAt(i)) {
case '\n':
      startToUse=i + 1;
    break loop;
case '\t':
  lastTabSymbolIndex=i;
}
}
if (lastTabSymbolIndex < 0) {
return end - startToUse;
}
int result=0;
int prevX;
int spaceSize=getSpaceWidth(Font.PLAIN,editor);
for (int i=startToUse; i <= lastTabSymbolIndex; i++) {
char c=text.charAt(i);
prevX=x;
switch (c) {
case '\t':
x=nextTabStop(x,editor);
result+=columnsNumber(x - prevX,spaceSize);
break;
case '\n':
x=result=0;
break;
default :
x+=charWidth(c,Font.PLAIN,editor);
result++;
}
}
result+=end - lastTabSymbolIndex - 1;
return result;
}
