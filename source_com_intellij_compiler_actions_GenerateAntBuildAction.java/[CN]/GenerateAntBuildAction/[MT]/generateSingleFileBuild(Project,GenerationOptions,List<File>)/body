{
  final File projectBuildFileDestDir=VfsUtil.virtualToIoFile(project.getProjectFile().getParent());
  projectBuildFileDestDir.mkdirs();
  final File destFile=new File(projectBuildFileDestDir,BuildProperties.getProjectBuildFileName(project) + ".xml");
  final File propertiesFile=new File(projectBuildFileDestDir,BuildProperties.getPropertyFileName(project));
  ensureFilesWritable(project,new File[]{destFile,propertiesFile});
  if (!backup(destFile,project,genOptions,filesToRefresh)) {
    return null;
  }
  if (!backup(propertiesFile,project,genOptions,filesToRefresh)) {
    return null;
  }
  destFile.createNewFile();
  propertiesFile.createNewFile();
  final DataOutputStream dataOutput=new DataOutputStream(new BufferedOutputStream(new FileOutputStream(destFile)));
  try {
    new SingleFileProjectBuild(project,genOptions).generate(dataOutput);
  }
  finally {
    dataOutput.close();
  }
  final DataOutputStream propertiesOut=new DataOutputStream(new BufferedOutputStream(new FileOutputStream(propertiesFile)));
  try {
    new PropertyFileGenerator(project,genOptions).generate(propertiesOut);
  }
  finally {
    propertiesOut.close();
  }
  filesToRefresh.add(destFile);
  filesToRefresh.add(propertiesFile);
  return new File[]{destFile,propertiesFile};
}
