{
  if (scope1 == null)   return scope2;
  if (scope2 == null)   return scope1;
  if (!scope1.isValid() || !scope2.isValid())   return PsiDocumentManager.getInstance(project).getPsiFile(document);
  final PsiElement commonParent=PsiTreeUtil.findCommonParent(scope1,scope2);
  return commonParent == null || commonParent instanceof PsiDirectory ? PsiDocumentManager.getInstance(project).getPsiFile(document) : commonParent;
}
