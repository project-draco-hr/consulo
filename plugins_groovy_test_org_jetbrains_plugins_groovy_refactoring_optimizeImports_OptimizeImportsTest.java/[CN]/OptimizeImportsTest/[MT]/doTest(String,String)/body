{
  CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(myProject);
  int oldCount=settings.CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND;
  try {
    settings.CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND=3;
    String basePath=TestUtils.getTestDataPath() + "/optimizeImports/";
    String resultText=getResultFromFile(basePath + folder);
    VirtualFile virtualFile=VirtualFileManager.getInstance().findFileByUrl("file://" + basePath + folder+ "/"+ filePath);
    assertNotNull("Virtual file points to null",virtualFile);
    PsiManager manager=PsiManager.getInstance(myProject);
    PsiFile file=manager.findFile(virtualFile);
    assertNotNull("PsiFile points to null",file);
    GroovyImportOptimizer optimizer=new GroovyImportOptimizer();
    final Runnable runnable=optimizer.processFile(file);
    CommandProcessor.getInstance().executeCommand(myProject,new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(runnable);
      }
    }
,"Optimize imports",null);
    String text=file.getText();
    assertEquals("Results are not equal",resultText,text);
  }
  finally {
    settings.CLASS_COUNT_TO_USE_IMPORT_ON_DEMAND=oldCount;
  }
}
