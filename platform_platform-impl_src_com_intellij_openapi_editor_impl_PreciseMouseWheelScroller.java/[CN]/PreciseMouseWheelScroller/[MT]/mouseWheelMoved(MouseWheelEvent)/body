{
  e.consume();
  if (e.getWheelRotation() != 0) {
    int orientation=SwingConstants.VERTICAL;
    JScrollBar toScroll=myScrollPane.getVerticalScrollBar();
    if (toScroll == null || !toScroll.isVisible() || e.isShiftDown()) {
      orientation=SwingConstants.HORIZONTAL;
      toScroll=myScrollPane.getHorizontalScrollBar();
      if (toScroll == null || !toScroll.isVisible()) {
        return;
      }
    }
    int direction=e.getWheelRotation() < 0 ? -1 : 1;
    if (e.getScrollType() == MouseWheelEvent.WHEEL_UNIT_SCROLL) {
      JViewport vp=myScrollPane.getViewport();
      Component comp=vp.getView();
      boolean limitScroll=Math.abs(e.getWheelRotation()) == 1;
      Scrollable scrollComp=(Scrollable)comp;
      Rectangle viewRect=vp.getViewRect();
      int scrollMin=toScroll.getMinimum();
      int scrollMax=toScroll.getMaximum() - toScroll.getModel().getExtent();
      if (limitScroll) {
        int blockIncr=scrollComp.getScrollableBlockIncrement(viewRect,orientation,direction);
        if (direction < 0) {
          scrollMin=Math.max(scrollMin,toScroll.getValue() - blockIncr);
        }
 else {
          scrollMax=Math.min(scrollMax,toScroll.getValue() + blockIncr);
        }
      }
      double units=getUnitsToScroll(e);
      double shift=scrollComp.getScrollableUnitIncrement(viewRect,orientation,direction) * units;
      if (orientation == SwingConstants.VERTICAL) {
        viewRect.y+=shift;
        if (direction < 0) {
          if (viewRect.y <= scrollMin) {
            viewRect.y=scrollMin;
          }
        }
 else {
          if (viewRect.y >= scrollMax) {
            viewRect.y=scrollMax;
          }
        }
        toScroll.setValue(viewRect.y);
      }
 else {
        viewRect.x+=shift;
        if (direction < 0) {
          if (viewRect.x < scrollMin) {
            viewRect.x=scrollMin;
          }
        }
 else {
          if (viewRect.x > scrollMax) {
            viewRect.x=scrollMax;
          }
        }
        toScroll.setValue(viewRect.x);
      }
    }
 else     if (e.getScrollType() == MouseWheelEvent.WHEEL_BLOCK_SCROLL) {
      int oldValue=toScroll.getValue();
      int blockIncrement=toScroll.getBlockIncrement(direction);
      int delta=blockIncrement * direction;
      int newValue=oldValue + delta;
      if (delta > 0 && newValue < oldValue) {
        newValue=toScroll.getMaximum();
      }
 else       if (delta < 0 && newValue > oldValue) {
        newValue=toScroll.getMinimum();
      }
      toScroll.setValue(newValue);
    }
  }
}
