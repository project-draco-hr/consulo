{
  String result="";
  String fileText=file.getText();
  int startOffset=fileText.indexOf(TestUtils.BEGIN_MARKER);
  fileText=TestUtils.removeBeginMarker(fileText,myOffset);
  int endOffset=fileText.indexOf(TestUtils.END_MARKER);
  fileText=TestUtils.removeEndMarker(fileText,myOffset);
  myFile=TestUtils.createPseudoPhysicalFile(myProject,fileText);
  fileEditorManager=FileEditorManager.getInstance(myProject);
  myEditor=fileEditorManager.openTextEditor(new OpenFileDescriptor(myProject,myFile.getVirtualFile(),0),false);
  Assert.assertTrue(myFile instanceof GroovyFile);
  try {
    myEditor.getSelectionModel().setSelection(startOffset,endOffset);
    result=myEditor.getDocument().getText();
    int caretOffset=myEditor.getCaretModel().getOffset();
    result=result.substring(0,caretOffset) + TestUtils.CARET_MARKER + result.substring(caretOffset);
  }
  finally {
    fileEditorManager.closeFile(myFile.getVirtualFile());
    myEditor=null;
  }
  return result;
}
