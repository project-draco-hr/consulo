{
  String result="";
  String fileText=file.getText();
  int startOffset=fileText.indexOf(TestUtils.BEGIN_MARKER);
  fileText=TestUtils.removeBeginMarker(fileText);
  int endOffset=fileText.indexOf(TestUtils.END_MARKER);
  fileText=TestUtils.removeEndMarker(fileText);
  myFile=TestUtils.createPseudoPhysicalGroovyFile(myProject,fileText);
  fileEditorManager=FileEditorManager.getInstance(myProject);
  myEditor=fileEditorManager.openTextEditor(new OpenFileDescriptor(myProject,myFile.getVirtualFile(),0),false);
  Assert.assertTrue(myFile instanceof GroovyFile);
  try {
    myEditor.getSelectionModel().setSelection(startOffset,endOffset);
    GroovyExtractMethodHandler handler=new GroovyExtractMethodHandler();
    boolean invoked=handler.invokeOnEditor(myProject,myEditor,myFile);
    result=invoked ? myEditor.getDocument().getText() : "FAILED: " + handler.getInvokeResult();
    int caretOffset=myEditor.getCaretModel().getOffset();
    result=invoked ? result.substring(0,caretOffset) + TestUtils.CARET_MARKER + result.substring(caretOffset) : result;
  }
  finally {
    fileEditorManager.closeFile(myFile.getVirtualFile());
    myEditor=null;
  }
  return result;
}
