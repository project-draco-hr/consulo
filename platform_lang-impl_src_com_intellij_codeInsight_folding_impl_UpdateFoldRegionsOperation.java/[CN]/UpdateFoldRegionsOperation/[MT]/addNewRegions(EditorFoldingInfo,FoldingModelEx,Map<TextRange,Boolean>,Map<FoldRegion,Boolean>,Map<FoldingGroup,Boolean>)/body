{
  List<FoldRegion> newRegions=arrayList();
  SmartPointerManager smartPointerManager=SmartPointerManager.getInstance(myProject);
  for (  final Map.Entry<PsiElement,FoldingDescriptor> entry : myElementsToFoldMap.entrySet()) {
    ProgressManager.checkCanceled();
    PsiElement element=entry.getKey();
    final FoldingDescriptor descriptor=entry.getValue();
    FoldingGroup group=descriptor.getGroup();
    TextRange range=descriptor.getRange();
    String placeholder=descriptor.getPlaceholderText();
    FoldRegion region=foldingModel.createFoldRegion(range.getStartOffset(),range.getEndOffset(),placeholder == null ? "..." : placeholder,group,descriptor.isNonExpandable());
    if (region == null)     continue;
    PsiElement psi=descriptor.getElement().getPsi();
    if (psi == null || !psi.isValid() || !foldingModel.addFoldRegion(region)) {
      region.dispose();
      continue;
    }
    info.addRegion(region,smartPointerManager.createSmartPsiElementPointer(psi));
    newRegions.add(region);
    boolean expandStatus=!descriptor.isNonExpandable() && shouldExpandNewRegion(element,range,rangeToExpandStatusMap);
    if (group == null) {
      shouldExpand.put(region,expandStatus);
    }
 else {
      final Boolean alreadyExpanded=groupExpand.get(group);
      groupExpand.put(group,alreadyExpanded == null ? expandStatus : alreadyExpanded.booleanValue() || expandStatus);
    }
  }
  return newRegions;
}
