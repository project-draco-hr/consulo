{
  boolean caretInside;
  if (myEditor.getUserData(ALLOW_FOLDING_ON_CARET_LINE_KEY) == Boolean.TRUE) {
    caretInside=FoldingUtil.caretInsideRange(myEditor,range);
  }
 else {
    final Document document=myEditor.getDocument();
    final int firstLine=document.getLineNumber(range.getStartOffset());
    final int lastLine=document.getLineNumber(range.getEndOffset());
    final int currentLine=document.getLineNumber(myEditor.getCaretModel().getOffset());
    caretInside=firstLine <= currentLine && currentLine <= lastLine;
  }
  if (myApplyDefaultState) {
    return caretInside || !FoldingPolicy.isCollapseByDefault(element);
  }
  final Boolean oldStatus=rangeToExpandStatusMap.get(range);
  return oldStatus == null || caretInside || oldStatus.booleanValue();
}
