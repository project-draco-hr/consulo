{
  EditorFoldingInfo info=EditorFoldingInfo.get(myEditor);
  FoldingModelEx foldingModel=(FoldingModelEx)myEditor.getFoldingModel();
  Map<TextRange,Boolean> rangeToExpandStatusMap=newTroveMap();
  removeInvalidRegions(info,foldingModel,rangeToExpandStatusMap);
  Map<FoldRegion,Boolean> shouldExpand=newTroveMap();
  Map<FoldingGroup,Boolean> groupExpand=newTroveMap();
  List<FoldRegion> newRegions=addNewRegions(info,foldingModel,rangeToExpandStatusMap,shouldExpand,groupExpand);
  applyExpandStatus(newRegions,shouldExpand,groupExpand);
  myEditor.putUserData(ALLOW_FOLDING_ON_CARET_LINE_KEY,false);
}
