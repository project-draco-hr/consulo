{
  EditorFoldingInfo info=EditorFoldingInfo.get(myEditor);
  FoldingModelEx foldingModel=(FoldingModelEx)myEditor.getFoldingModel();
  Map<TextRange,Boolean> rangeToExpandStatusMap=newTroveMap();
  FoldingUpdate.FoldingMap elementsToFold=new FoldingUpdate.FoldingMap(myElementsToFoldMap);
  removeInvalidRegions(info,foldingModel,elementsToFold,rangeToExpandStatusMap);
  Map<FoldRegion,Boolean> shouldExpand=newTroveMap();
  Map<FoldingGroup,Boolean> groupExpand=newTroveMap();
  List<FoldRegion> newRegions=addNewRegions(info,foldingModel,elementsToFold,rangeToExpandStatusMap,shouldExpand,groupExpand);
  applyExpandStatus(newRegions,shouldExpand,groupExpand);
  foldingModel.clearDocumentRangesModificationStatus();
}
