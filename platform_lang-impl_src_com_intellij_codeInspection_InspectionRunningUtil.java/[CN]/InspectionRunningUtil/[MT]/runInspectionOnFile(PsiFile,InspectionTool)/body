{
  final InspectionManagerEx managerEx=(InspectionManagerEx)InspectionManager.getInstance(file.getProject());
  final GlobalInspectionContextImpl context=managerEx.createNewGlobalContext(false);
  tool.initialize(context);
  ((RefManagerImpl)context.getRefManager()).inspectionReadActionStarted();
  try {
    if (tool instanceof LocalInspectionToolWrapper) {
      ((LocalInspectionToolWrapper)tool).processFile(file,true,managerEx,true);
      return new ArrayList<CommonProblemDescriptor>(((LocalInspectionToolWrapper)tool).getProblemDescriptors());
    }
 else     if (tool instanceof GlobalInspectionToolWrapper) {
      final GlobalInspectionTool globalInspectionTool=((GlobalInspectionToolWrapper)tool).getTool();
      if (globalInspectionTool instanceof GlobalSimpleInspectionTool) {
        ProblemsHolder problemsHolder=new ProblemsHolder(managerEx,file,false);
        ((GlobalSimpleInspectionTool)globalInspectionTool).checkFile(file,managerEx,problemsHolder,context,(GlobalInspectionToolWrapper)tool);
        return new ArrayList<CommonProblemDescriptor>(((GlobalInspectionToolWrapper)tool).getProblemDescriptors());
      }
    }
    return Collections.emptyList();
  }
  finally {
    ((RefManagerImpl)context.getRefManager()).inspectionReadActionFinished();
    tool.cleanup();
    context.cleanup(managerEx);
  }
}
