{
  if (project.isDisposed() || !GradleUtil.isGradleAvailable(project)) {
    return GradleApiFacade.NULL_OBJECT;
  }
  Pair<GradleApiFacade,RemoteGradleProcessSettings> pair=myRemoteFacades.get(project.getName());
  if (pair != null) {
    if (isValid(pair,project)) {
      return pair.first;
    }
    mySupport.stopAll(true);
    myFacadeWrappers.clear();
    myRemoteFacades.clear();
    final Pair<GradleApiFacade,RemoteGradleProcessSettings> p=myRemoteFacades.putIfAbsent(project.getName(),NULL_VALUE);
    if (p != null && p != NULL_VALUE) {
      return p.first;
    }
  }
  final GradleApiFacade facade=mySupport.acquire(this,project.getName());
  if (facade == null) {
    throw new IllegalStateException("Can't obtain facade to working with gradle api at the remote process. Project: " + project);
  }
  Disposer.register(project,new Disposable(){
    @Override public void dispose(){
      mySupport.stopAll(true);
      myFacadeWrappers.clear();
      myRemoteFacades.clear();
    }
  }
);
  final GradleApiFacade result=new GradleApiFacadeWrapper(facade,myProgressManager);
  Pair<GradleApiFacade,RemoteGradleProcessSettings> newPair=new Pair<GradleApiFacade,RemoteGradleProcessSettings>(result,getRemoteSettings(project));
  if (myRemoteFacades.putIfAbsent(project.getName(),newPair) != null && !myRemoteFacades.replace(project.getName(),NULL_VALUE,newPair)) {
    GradleLog.LOG.warn("Detected unexpected duplicate tooling api facade instance creation. Project: " + project);
    return myRemoteFacades.get(project.getName()).first;
  }
  if (!StringUtil.isEmpty(newPair.second.getJavaHome())) {
    GradleLog.LOG.info("Instructing gradle to use java from " + newPair.second.getJavaHome());
  }
  result.applySettings(newPair.second);
  RemoteGradleProgressNotificationManager exported=myRemoteNotificationManagers.get(project.getName());
  if (exported == null) {
    try {
      exported=(RemoteGradleProgressNotificationManager)UnicastRemoteObject.exportObject(myProgressManager,0);
      myRemoteNotificationManagers.putIfAbsent(project.getName(),exported);
    }
 catch (    RemoteException e) {
      exported=myRemoteNotificationManagers.get(project.getName());
    }
  }
  if (exported == null) {
    GradleLog.LOG.warn("Can't export progress manager");
  }
 else {
    result.applyProgressManager(exported);
  }
  return result;
}
