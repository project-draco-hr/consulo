{
  return new CommandLineState(null){
    private SimpleJavaParameters createJavaParameters() throws ExecutionException {
      Collection<File> gradleLibraries=myGradleInstallationManager.getAllLibraries(project);
      GradleLog.LOG.assertTrue(gradleLibraries != null,GradleBundle.message("gradle.generic.text.error.sdk.undefined"));
      if (gradleLibraries == null) {
        throw new ExecutionException("Can't find gradle libraries");
      }
      final SimpleJavaParameters params=new SimpleJavaParameters();
      params.setJdk(new SimpleJavaSdkType().createJdk("tmp",SystemProperties.getJavaHome()));
      params.setWorkingDirectory(PathManager.getBinPath());
      final List<String> classPath=new ArrayList<String>();
      classPath.addAll(PathManager.getUtilClassPath());
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(LanguageLevel.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(PsiBundle.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(Alarm.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(DependencyScope.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(JavaSdkVersion.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(ExtensionPointName.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(OpenProjectFileChooserDescriptor.class),classPath);
      ContainerUtil.addIfNotNull(PathUtil.getJarPathForClass(getClass()),classPath);
      for (      File library : gradleLibraries) {
        classPath.add(library.getAbsolutePath());
      }
      params.getClassPath().addAll(classPath);
      addBundle(params.getClassPath(),"messages.CommonBundle");
      addBundle(params.getClassPath(),GradleBundle.PATH_TO_BUNDLE);
      params.setMainClass(MAIN_CLASS_NAME);
      params.getVMParametersList().addParametersString("-Djava.awt.headless=true -Xmx512m");
      params.getVMParametersList().addParametersString("-Dsun.rmi.transport.connectionTimeout=" + String.valueOf(TimeUnit.HOURS.toMillis(1)));
      return params;
    }
    private void addBundle(    @NotNull PathsList classPath,    @NotNull String bundlePath){
      String pathToUse=bundlePath.replace('.','/');
      if (!pathToUse.endsWith(".properties")) {
        pathToUse+=".properties";
      }
      if (!pathToUse.startsWith("/")) {
        pathToUse='/' + pathToUse;
      }
      classPath.add(PathManager.getResourceRoot(getClass(),pathToUse));
    }
    @NotNull @Override public ExecutionResult execute(    @NotNull Executor executor,    @NotNull ProgramRunner runner) throws ExecutionException {
      ProcessHandler processHandler=startProcess();
      return new DefaultExecutionResult(null,processHandler,AnAction.EMPTY_ARRAY);
    }
    @NotNull protected OSProcessHandler startProcess() throws ExecutionException {
      SimpleJavaParameters params=createJavaParameters();
      Sdk sdk=params.getJdk();
      if (sdk == null) {
        throw new ExecutionException("No sdk is defined. Params: " + params);
      }
      final GeneralCommandLine commandLine=JdkUtil.setupJVMCommandLine(((JavaSdkType)sdk.getSdkType()).getVMExecutablePath(sdk),params,false);
      final OSProcessHandler processHandler=new OSProcessHandler(commandLine.createProcess(),commandLine.getCommandLineString()){
        @Override public Charset getCharset(){
          return commandLine.getCharset();
        }
      }
;
      ProcessTerminatedListener.attach(processHandler);
      return processHandler;
    }
  }
;
}
