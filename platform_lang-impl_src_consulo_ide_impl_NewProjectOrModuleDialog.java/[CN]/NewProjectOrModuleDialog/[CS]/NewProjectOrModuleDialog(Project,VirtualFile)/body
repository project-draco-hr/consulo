{
  super(project,true);
  myModuleCreation=virtualFile != null;
  setTitle(myModuleCreation ? IdeBundle.message("title.add.module") : IdeBundle.message("title.new.project"));
  NewModuleContext context=new NewModuleContext();
  for (  NewModuleBuilder newModuleBuilder : NewModuleBuilder.EP_NAME.getExtensions()) {
    newModuleBuilder.setupContext(context);
  }
  DListItem.Builder root=DListItem.builder();
  Map<String,DListItem.Builder> map=new HashMap<String,DListItem.Builder>();
  for (  Pair<String[],NewModuleBuilderProcessor> pair : context.getSetup()) {
    String[] path=pair.getFirst();
    NewModuleBuilderProcessor processor=pair.getSecond();
    DListItem.Builder prev=root;
    for (int i=0; i < path.length; i++) {
      String item=path[i];
      DListItem.Builder builder=map.get(item);
      if (builder == null) {
        Pair<String,Icon> itemInfo=context.getItem(item);
        map.put(item,builder=DListItem.builder().withName(itemInfo.getFirst()).withIcon(itemInfo.getSecond()).withAttach(processor));
        prev.withItems(builder);
      }
      prev=builder;
    }
  }
  myListWithChildren=new DListWithChildren();
  myListWithChildren.select(root.create());
  final JPanel panel=new JPanel(new VerticalFlowLayout());
  myNameField=new JTextField();
  myLocationField=new TextFieldWithBrowseButton();
  panel.add(LabeledComponent.create(myNameField,"Name").setLabelLocation(BorderLayout.WEST));
  if (virtualFile != null) {
    myNameField.setText(virtualFile.getName());
  }
 else {
    panel.add(LabeledComponent.create(myLocationField,"Path").setLabelLocation(BorderLayout.WEST));
    new LocationNameFieldsBinding(project,myLocationField,myNameField,ProjectUtil.getBaseDir(),"Select Directory");
  }
  panel.add(new SeparatorComponent());
  final JPanel etcPanel=new JPanel(new BorderLayout());
  panel.add(etcPanel);
  final JPanel nullPanel=new JPanel(new BorderLayout());
  JBLabel nodeLabel=new JBLabel("Please select project type, groups are bold (double click for open)",UIUtil.ComponentStyle.SMALL,UIUtil.FontColor.BRIGHTER);
  nodeLabel.setHorizontalAlignment(SwingConstants.CENTER);
  nullPanel.add(nodeLabel,BorderLayout.CENTER);
  myRightPanel=new JPanel(new BorderLayout());
  myRightPanel.add(nullPanel,BorderLayout.CENTER);
  myListWithChildren.setConsumer(new Consumer<DListItem>(){
    @Override public void consume(    final DListItem dListItem){
      myProcessor=dListItem == null ? null : (NewModuleBuilderProcessor)dListItem.getAttach();
      myConfigurationPanel=nullPanel;
      etcPanel.removeAll();
      myRightPanel.removeAll();
      if (dListItem != null) {
        if (myProcessor != null) {
          myConfigurationPanel=myProcessor.createConfigurationPanel();
          etcPanel.add(myConfigurationPanel,BorderLayout.NORTH);
        }
        myRightPanel.add(panel,BorderLayout.CENTER);
      }
      if (myRightPanel.getComponentCount() == 0) {
        myRightPanel.add(nullPanel,BorderLayout.CENTER);
      }
      myRightPanel.validate();
      myRightPanel.repaint();
      setOKActionEnabled(myProcessor != null);
    }
  }
);
  setOKActionEnabled(false);
  init();
}
