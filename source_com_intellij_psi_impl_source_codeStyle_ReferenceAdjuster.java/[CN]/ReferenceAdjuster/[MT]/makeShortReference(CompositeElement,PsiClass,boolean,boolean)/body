{
  if (refClass.getContainingClass() != null) {
    PsiClass parentClass=refClass.getContainingClass();
    PsiJavaCodeReferenceElement psiReference=(PsiJavaCodeReferenceElement)SourceTreeToPsiMap.treeElementToPsi(reference);
    PsiManager manager=parentClass.getManager();
    final PsiResolveHelper resolveHelper=manager.getResolveHelper();
    final ASTNode qualifier=reference.findChildByRole(ChildRole.QUALIFIER);
    if (!resolveHelper.isAccessible(refClass,psiReference,null)) {
      if (qualifier != null)       makeShortReference((CompositeElement)qualifier,parentClass,addImports,uncompleteCode);
      return reference;
    }
    final PsiClass aClass=resolveHelper.resolveReferencedClass(psiReference.getReferenceName(),psiReference);
    if (!manager.areElementsEquivalent(aClass,refClass)) {
      if (qualifier != null)       makeShortReference((CompositeElement)qualifier,parentClass,addImports,uncompleteCode);
      return reference;
    }
    if (!mySettings.INSERT_INNER_CLASS_IMPORTS) {
      if (qualifier != null)       makeShortReference((CompositeElement)qualifier,parentClass,addImports,uncompleteCode);
      return reference;
    }
  }
  PsiFile file=SourceTreeToPsiMap.treeElementToPsi(reference).getContainingFile();
  PsiManager manager=file.getManager();
  PsiResolveHelper helper=manager.getResolveHelper();
  if (addImports) {
    if (!myImportHelper.addImport(file,refClass)) {
      return reference;
    }
    if (isSafeToShortenReference(reference,refClass,helper)) {
      reference=replaceReferenceWithShort(reference);
    }
  }
 else {
    PsiClass curRefClass=helper.resolveReferencedClass(refClass.getName(),SourceTreeToPsiMap.treeElementToPsi(reference));
    if (manager.areElementsEquivalent(refClass,curRefClass)) {
      reference=replaceReferenceWithShort(reference);
    }
  }
  return reference;
}
