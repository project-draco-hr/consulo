{
  if (parent.getElementType() == ElementType.JAVA_CODE_REFERENCE || parent.getElementType() == ElementType.REFERENCE_EXPRESSION) {
    array.add(parent);
    return;
  }
  if (parent.getPsi() instanceof PsiFile && PsiUtil.isInJspFile(parent.getPsi())) {
    final JspFile jspFile=(PsiUtil.getJspFile(parent.getPsi()));
    addReferencesInRange(array,(TreeElement)jspFile.getJavaClass().getNode(),startOffset,endOffset);
  }
  if (parent instanceof CompositeElement) {
    ChameleonTransforming.transformChildren(parent);
    int offset=0;
    for (TreeElement child=parent.getFirstChildNode(); child != null; child=child.getTreeNext()) {
      int length=child.getTextLength();
      if (startOffset <= offset + length && offset <= endOffset) {
        if (startOffset <= offset && offset + length <= endOffset) {
          array.add(child);
        }
        addReferencesInRange(array,child,startOffset - offset,endOffset - offset);
      }
      offset+=length;
    }
  }
}
