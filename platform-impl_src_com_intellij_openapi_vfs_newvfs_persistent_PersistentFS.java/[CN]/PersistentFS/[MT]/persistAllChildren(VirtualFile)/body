{
  int id=getFileId(file);
  String[] currentNames=listPersisted(file);
  int[] currentIds=myRecords.list(id);
  final NewVirtualFileSystem delegate=getDelegate(file);
  String[] names=VfsUtil.filterNames(delegate.list(file));
  final int[] childrenIds=new int[names.length];
  for (int i=0; i < names.length; i++) {
    final String name=names[i];
    int idx=ArrayUtil.indexOf(currentNames,name);
    if (idx >= 0) {
      childrenIds[i]=currentIds[idx];
    }
 else {
      int childId=myRecords.createRecord();
      copyRecordFromDelegateFS(childId,id,new FakeVirtualFile(name,file),delegate);
      childrenIds[i]=childId;
    }
  }
  myRecords.updateList(id,childrenIds);
  int flags=myRecords.getFlags(id);
  myRecords.setFlags(id,flags | CHILDREN_CACHED_FLAG,true);
  return names;
}
