{
  if (!AndroidPackagingCompiler.shouldGenerateApk(item.myModule,context,releasePackage)) {
    return;
  }
  final VirtualFile preprocessedManifestFile;
  try {
    preprocessedManifestFile=releasePackage ? item.myManifestFile : copyManifestAndSetDebuggableToTrue(item.myModule,item.myManifestFile);
  }
 catch (  IOException e) {
    LOG.info(e);
    context.addMessage(CompilerMessageCategory.ERROR,'[' + item.myModule.getName() + "] Cannot preprocess AndroidManifest.xml for debug build",item.myManifestFile.getUrl(),-1,-1);
    return;
  }
  final Map<VirtualFile,VirtualFile> presentableFilesMap=Collections.singletonMap(item.myManifestFile,preprocessedManifestFile);
  try {
    final String outputPath=releasePackage ? item.myOutputPath + RELEASE_SUFFIX : item.myOutputPath;
    Map<CompilerMessageCategory,List<String>> messages=AndroidCompileUtil.toCompilerMessageCategoryKeys(AndroidApt.packageResources(item.myAndroidTarget,item.myPlatformToolsRevision,preprocessedManifestFile.getPath(),item.myResourceDirPaths,item.myAssetsDirPaths,outputPath,null,!releasePackage,0,new FileFilter(){
      @Override public boolean accept(      File file){
        final VirtualFile vFile=LocalFileSystem.getInstance().findFileByIoFile(file);
        return vFile != null && !ProjectRootManager.getInstance(context.getProject()).getFileIndex().isIgnored(vFile);
      }
    }
));
    AndroidCompileUtil.addMessages(context,messages,presentableFilesMap,item.myModule);
  }
 catch (  final IOException e) {
    LOG.info(e);
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        if (context.getProject().isDisposed())         return;
        context.addMessage(CompilerMessageCategory.ERROR,e.getMessage(),null,-1,-1);
      }
    }
);
  }
}
