{
  myProject=project;
  boolean isProjectDefault=project.isDefault();
  myFileManager=isProjectDefault ? new EmptyFileManager(this) : new FileManagerImpl(this,fileTypeManager,virtualFileManager,fileDocumentManager,projectRootManagerEx);
  mySearchHelper=new PsiSearchHelperImpl(this);
  final CompositeCacheManager cacheManager=new CompositeCacheManager();
  if (!isProjectDefault) {
    cacheManager.addCacheManager(new IndexCacheManagerImpl(this));
  }
 else {
    cacheManager.addCacheManager(new EmptyCacheManager());
  }
  final CacheManager[] managers=myProject.getComponents(CacheManager.class);
  for (  CacheManager manager : managers) {
    cacheManager.addCacheManager(manager);
  }
  myCacheManager=cacheManager;
  myModificationTracker=new PsiModificationTrackerImpl();
  myTreeChangePreprocessors.add(myModificationTracker);
  myResolveCache=new ResolveCache(this);
  myCachedValuesManager=new CachedValuesManagerImpl(this);
  myRepositoryManager=psiManagerConfiguration.createRepositoryManager(this);
  myRepositoryElementsManager=psiManagerConfiguration.createRepositoryElementsManager(this,myRepositoryManager);
  if (startupManager != null) {
    ((StartupManagerEx)startupManager).registerPreStartupActivity(new Runnable(){
      public void run(){
        runPreStartupActivity();
      }
    }
);
  }
  myProgressManager=ProgressManager.getInstance();
}
