{
  checkCreateFile(newName);
  final Document document=PsiDocumentManager.getInstance(getProject()).getDocument(originalFile);
  FileDocumentManager.getInstance().saveDocument(document);
  final VirtualFile parent=getVirtualFile();
  try {
    final VirtualFile vFile=originalFile.getVirtualFile();
    if (vFile == null)     throw new IncorrectOperationException("Cannot copy nonphysical file");
    final VirtualFile copyVFile=vFile.copy(this,parent,newName);
    final PsiFile copyPsi=myManager.findFile(copyVFile);
    LOG.assertTrue(copyPsi != null);
    if (copyPsi instanceof PsiFileImpl) {
      ChangeUtil.encodeInformation((TreeElement)SourceTreeToPsiMap.psiElementToTree(copyPsi));
      PsiUtil.updatePackageStatement(copyPsi);
      ChangeUtil.decodeInformation((TreeElement)SourceTreeToPsiMap.psiElementToTree(copyPsi));
    }
    return copyPsi;
  }
 catch (  IOException e) {
    throw new IncorrectOperationException(e.toString(),e);
  }
}
