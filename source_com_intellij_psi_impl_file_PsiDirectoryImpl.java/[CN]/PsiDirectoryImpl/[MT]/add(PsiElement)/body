{
  checkAdd(element);
  if (element instanceof PsiDirectory) {
    LOG.error("not implemented");
    return null;
  }
 else   if (element instanceof PsiFile) {
    PsiFile originalFile=(PsiFile)element;
    try {
      VirtualFile newVFile;
      if (originalFile instanceof PsiFileImpl) {
        newVFile=myFile.createChildData(myManager,originalFile.getName());
        String lineSeparator=FileDocumentManager.getInstance().getLineSeparator(newVFile,getProject());
        String text=originalFile.getText();
        if (!lineSeparator.equals("\n")) {
          text=StringUtil.convertLineSeparators(text,lineSeparator);
        }
        final Writer writer=LoadTextUtil.getWriter(newVFile,myManager,text,-1);
        try {
          writer.write(text);
        }
  finally {
          writer.close();
        }
      }
 else {
        byte[] storedContents=((PsiBinaryFileImpl)originalFile).getStoredContents();
        if (storedContents != null) {
          newVFile=myFile.createChildData(myManager,originalFile.getName());
          newVFile.setBinaryContent(storedContents);
        }
 else {
          newVFile=VfsUtil.copyFile(null,originalFile.getVirtualFile(),myFile);
        }
      }
      PsiDocumentManager.getInstance(myManager.getProject()).commitAllDocuments();
      PsiFile newFile=myManager.findFile(newVFile);
      if (newFile instanceof PsiFileImpl) {
        ChangeUtil.encodeInformation((TreeElement)SourceTreeToPsiMap.psiElementToTree(newFile));
        PsiUtil.updatePackageStatement(newFile);
        ChangeUtil.decodeInformation((TreeElement)SourceTreeToPsiMap.psiElementToTree(newFile));
      }
      return newFile;
    }
 catch (    IOException e) {
      throw new IncorrectOperationException(e.toString(),e);
    }
  }
 else   if (element instanceof PsiClass) {
    final String name=((PsiClass)element).getName();
    if (name != null) {
      final PsiClass newClass=createClass(name);
      return newClass.replace(element);
    }
 else {
      LOG.error("not implemented");
      return null;
    }
  }
 else {
    LOG.assertTrue(false);
    return null;
  }
}
