{
  myState.assertDisposed();
  if (myState.isModifiersReleased()) {
    return;
  }
  final String documentText=myEditor.getDocument().getText();
  final int caret=myEditor.getCaretModel().getOffset();
  final int selStart=myEditor.getSelectionModel().getSelectionStart();
  final int selEnd=myEditor.getSelectionModel().getSelectionEnd();
  myState.setRestorePrefix(new Runnable(){
    @Override public void run(){
      DocumentEx document=(DocumentEx)myEditor.getDocument();
      document.setInBulkUpdate(true);
      try {
        document.setText(documentText);
        myEditor.getSelectionModel().setSelection(selStart,selEnd);
        myEditor.getCaretModel().moveToOffset(caret);
      }
  finally {
        document.setInBulkUpdate(false);
      }
    }
  }
);
}
