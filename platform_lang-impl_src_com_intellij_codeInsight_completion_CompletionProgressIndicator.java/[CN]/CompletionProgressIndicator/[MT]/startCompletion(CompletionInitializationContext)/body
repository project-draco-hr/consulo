{
  boolean sync=ApplicationManager.getApplication().isUnitTestMode() && !CompletionAutoPopupHandler.ourTestingAutopopup;
  final CompletionThreading strategy=sync ? new SyncCompletion() : new AsyncCompletion();
  strategy.startThread(ProgressWrapper.wrap(this),new Runnable(){
    @Override public void run(){
      scheduleAdvertising();
    }
  }
);
  final WeighingDelegate weigher=strategy.delegateWeighing(this);
  final AtomicReference<LookupElement[]> data=new AtomicReference<LookupElement[]>(null);
class CalculateItems implements Runnable {
    @Override public void run(){
      duringCompletion(initContext);
      ProgressManager.checkCanceled();
      LookupElement[] result=CompletionService.getCompletionService().performCompletion(myParameters,weigher);
      ProgressManager.checkCanceled();
      weigher.waitFor();
      ProgressManager.checkCanceled();
      data.set(result);
    }
  }
  strategy.startThread(this,new CalculateItems());
  return data;
}
