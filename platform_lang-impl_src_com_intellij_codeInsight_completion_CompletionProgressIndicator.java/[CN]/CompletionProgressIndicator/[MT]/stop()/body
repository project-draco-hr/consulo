{
  super.stop();
  myQueue.cancelAllUpdates();
  myFreezeSemaphore.up();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      final CompletionPhase phase=CompletionServiceImpl.getCompletionPhase();
      if (!(phase instanceof CompletionPhase.BgCalculation) || phase.indicator != CompletionProgressIndicator.this)       return;
      myLookup.setCalculating(false);
      if (hideAutopopupIfMeaningless()) {
        return;
      }
      if (myState.hasNoVariants()) {
        if (!isAutopopupCompletion()) {
          LookupManager.getInstance(getProject()).hideActiveLookup();
          final CompletionProgressIndicator current=CompletionServiceImpl.getCompletionService().getCurrentCompletion();
          LOG.assertTrue(current == null,current + "!=" + CompletionProgressIndicator.this);
          handleEmptyLookup();
        }
      }
 else {
        if (myState.isFocusLookupWhenDone()) {
          myLookup.setFocused(true);
        }
        updateLookup();
        CompletionServiceImpl.setCompletionPhase(new CompletionPhase.ItemsCalculated(CompletionProgressIndicator.this));
      }
    }
  }
,myQueue.getModalityState());
}
