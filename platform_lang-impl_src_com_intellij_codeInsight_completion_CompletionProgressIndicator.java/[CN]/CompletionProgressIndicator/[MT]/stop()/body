{
  super.stop();
  myQueue.cancelAllUpdates();
  myFreezeSemaphore.up();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      if (CompletionAutoPopupHandler.ourTestingAutopopup) {
        System.out.println("CompletionProgressIndicator.stop.later");
      }
      if (isOutdated())       return;
      if (!isBackgrounded())       return;
      if (isCanceled() && !myRestartScheduled)       return;
      myLookup.setCalculating(false);
      if (hideAutopopupIfMeaningless()) {
        return;
      }
      if (myCount == 0) {
        LookupManager.getInstance(getProject()).hideActiveLookup();
        final CompletionProgressIndicator current=CompletionServiceImpl.getCompletionService().getCurrentCompletion();
        LOG.assertTrue(current == null,current + "!=" + CompletionProgressIndicator.this);
        if (!isAutopopupCompletion()) {
          myHandler.handleEmptyLookup(getProject(),myEditor,myParameters,CompletionProgressIndicator.this);
        }
      }
 else {
        if (myFocusLookupWhenDone) {
          myLookup.setFocused(true);
        }
        updateLookup();
      }
    }
  }
,myQueue.getModalityState());
}
