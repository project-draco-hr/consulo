{
  if (!isRunning())   return;
  ProgressManager.checkCanceled();
  final boolean unitTestMode=ApplicationManager.getApplication().isUnitTestMode();
  if (!unitTestMode) {
    LOG.assertTrue(!ApplicationManager.getApplication().isDispatchThread());
  }
  LOG.assertTrue(myParameters.getPosition().isValid());
  LookupElement lookupElement=item.getLookupElement();
  if (!myHasPsiElements && lookupElement.getPsiElement() != null) {
    myHasPsiElements=true;
  }
  myItemSorters.put(lookupElement,(CompletionSorterImpl)item.getSorter());
  if (!myLookup.addItem(lookupElement,item.getPrefixMatcher())) {
    return;
  }
  myCount++;
  if (myCount == 1) {
    new Alarm(Alarm.ThreadToUse.SHARED_THREAD,this).addRequest(new Runnable(){
      @Override public void run(){
        myFreezeSemaphore.up();
      }
    }
,300);
  }
  myQueue.queue(myUpdate);
}
