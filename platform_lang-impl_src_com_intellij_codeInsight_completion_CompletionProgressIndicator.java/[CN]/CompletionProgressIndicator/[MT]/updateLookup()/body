{
  ApplicationManager.getApplication().assertIsDispatchThread();
  if (isOutdated() || !shouldShowLookup())   return false;
  while (true) {
    Runnable action=myAdvertiserChanges.poll();
    if (action == null)     break;
    action.run();
  }
  if (!myLookupUpdated) {
    if (myLookup.getAdvertisements().isEmpty() && !isAutopopupCompletion() && !DumbService.isDumb(getProject())) {
      DefaultCompletionContributor.addDefaultAdvertisements(myParameters,myLookup);
    }
    myLookup.getAdvertiser().showRandomText();
  }
  boolean justShown=false;
  if (!myLookup.isShown()) {
    if (hideAutopopupIfMeaningless()) {
      return false;
    }
    if (Registry.is("dump.threads.on.empty.lookup") && myLookup.isCalculating() && myLookup.getItems().isEmpty()) {
      PerformanceWatcher.getInstance().dumpThreads(true);
    }
    if (!myLookup.showLookup()) {
      return false;
    }
    justShown=true;
  }
  myLookupUpdated=true;
  myLookup.refreshUi(true,justShown);
  hideAutopopupIfMeaningless();
  if (justShown) {
    myLookup.ensureSelectionVisible(true);
  }
  return true;
}
