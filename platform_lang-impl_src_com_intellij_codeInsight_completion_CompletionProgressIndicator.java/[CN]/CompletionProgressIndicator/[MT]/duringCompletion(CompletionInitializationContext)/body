{
  try {
    ProgressManager.checkCanceled();
    if (!initContext.getOffsetMap().wasModified(CompletionInitializationContext.IDENTIFIER_END_OFFSET)) {
      try {
        final int selectionEndOffset=initContext.getSelectionEndOffset();
        final PsiReference reference=initContext.getFile().findReferenceAt(selectionEndOffset);
        if (reference != null) {
          initContext.setReplacementOffset(findReplacementOffset(selectionEndOffset,reference));
        }
      }
 catch (      IndexNotReadyException ignored) {
      }
    }
    for (    CompletionContributor contributor : CompletionContributor.forLanguage(initContext.getPositionLanguage())) {
      if (DumbService.getInstance(initContext.getProject()).isDumb() && !DumbService.isDumbAware(contributor)) {
        continue;
      }
      contributor.duringCompletion(initContext);
    }
  }
 catch (  ProcessCanceledException ignored) {
  }
 finally {
    myDuringCompletionSemaphore.up();
  }
}
