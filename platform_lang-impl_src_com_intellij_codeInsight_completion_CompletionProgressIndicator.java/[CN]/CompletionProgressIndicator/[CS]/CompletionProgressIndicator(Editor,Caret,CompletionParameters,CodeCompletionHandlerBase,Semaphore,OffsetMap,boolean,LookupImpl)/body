{
  myEditor=editor;
  myCaret=caret;
  myParameters=parameters;
  myHandler=handler;
  myFreezeSemaphore=freezeSemaphore;
  myOffsetMap=offsetMap;
  myLookup=lookup;
  myStartCaret=myEditor.getCaretModel().getOffset();
  myAdvertiserChanges.offer(new Runnable(){
    @Override public void run(){
      myLookup.getAdvertiser().clearAdvertisements();
    }
  }
);
  myLookup.setArranger(new CompletionLookupArranger(parameters,this));
  myLookup.addLookupListener(myLookupListener);
  myLookup.setCalculating(true);
  myLookupManagerListener=new PropertyChangeListener(){
    @Override public void propertyChange(    PropertyChangeEvent evt){
      if (evt.getNewValue() != null) {
        LOG.error("An attempt to change the lookup during completion, phase = " + CompletionServiceImpl.getCompletionPhase());
      }
    }
  }
;
  LookupManager.getInstance(getProject()).addPropertyChangeListener(myLookupManagerListener);
  myQueue=new MergingUpdateQueue("completion lookup progress",100,true,myEditor.getContentComponent());
  myQueue.setPassThrough(false);
  ApplicationManager.getApplication().assertIsDispatchThread();
  Disposer.register(this,offsetMap);
  if (hasModifiers && !ApplicationManager.getApplication().isUnitTestMode()) {
    trackModifiers();
  }
}
