{
  ensureAllInvalidateTasksCompleted();
  myForceUpdateSemaphore.down();
  try {
    for (    VirtualFile file : queryNeededFiles()) {
      processFileImpl(new com.intellij.ide.startup.FileContent(file));
    }
  }
  finally {
    myForceUpdateSemaphore.up();
    ((ApplicationEx)ApplicationManager.getApplication()).writeLockSafeWait(new Runnable(){
      public void run(){
        myForceUpdateSemaphore.waitFor();
      }
    }
);
  }
}
