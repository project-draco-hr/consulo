{
  PsiFile target=null;
  long modStamp=-1L;
  for (  Project project : ProjectManager.getInstance().getOpenProjects()) {
    if (isDumb(project)) {
      continue;
    }
    final PsiDocumentManager pdm=PsiDocumentManager.getInstance(project);
    final PsiFile file=pdm.getCachedPsiFile(doc);
    if (file != null && file.getModificationStamp() > modStamp) {
      final ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
      final VirtualFile vFile=file.getVirtualFile();
      if (vFile != null && (index.isInContent(vFile) || index.isInLibrarySource(vFile))) {
        target=file;
        modStamp=file.getModificationStamp();
      }
    }
 else     if (file != null && file.getModificationStamp() == modStamp) {
      if (target instanceof PsiPlainTextFile && !(file instanceof PsiPlainTextFile)) {
        target=file;
      }
    }
  }
  return target;
}
