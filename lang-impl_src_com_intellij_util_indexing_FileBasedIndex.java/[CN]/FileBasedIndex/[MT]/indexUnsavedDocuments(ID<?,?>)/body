{
  myChangedFilesUpdater.forceUpdate();
  if (myUpToDateIndices.contains(indexId)) {
    return;
  }
  final Set<Document> documents=getUnsavedOrTransactedDocuments();
  if (!documents.isEmpty()) {
    final Lock storageLock=setDataBufferingEnabled(true);
    try {
      final Semaphore semaphore=myUnsavedDataIndexingSemaphores.get(indexId);
      semaphore.down();
      try {
        for (        Document document : documents) {
          indexUnsavedDocument(document,indexId);
        }
      }
 catch (      StorageException e) {
        setDataBufferingEnabled(false).unlock();
        throw e;
      }
catch (      ProcessCanceledException e) {
        setDataBufferingEnabled(false).unlock();
        throw e;
      }
 finally {
        semaphore.up();
        while (!semaphore.waitFor(500)) {
          if (Thread.holdsLock(PsiLock.LOCK)) {
            break;
          }
        }
        myUpToDateIndices.add(indexId);
      }
    }
  finally {
      storageLock.unlock();
    }
  }
}
