{
  myChangedFilesUpdater.forceUpdate();
  final Set<Document> documents=getUnsavedOrTransactedDocuments();
  if (!documents.isEmpty()) {
    setDataBufferingEnabled(true);
    myUnsavedDataIndexingSemaphore.down();
    try {
      for (      Document document : documents) {
        indexUnsavedDocument(document,indexId);
      }
    }
 catch (    StorageException e) {
      setDataBufferingEnabled(false);
      throw e;
    }
catch (    ProcessCanceledException e) {
      setDataBufferingEnabled(false);
      throw e;
    }
 finally {
      myUnsavedDataIndexingSemaphore.up();
      while (!myUnsavedDataIndexingSemaphore.waitFor(500)) {
        if (Thread.holdsLock(PsiLock.LOCK)) {
          break;
        }
      }
    }
  }
}
