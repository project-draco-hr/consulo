{
  if (myRebuildStatus.get(indexId).compareAndSet(REQUIRES_REBUILD,REBUILD_IN_PROGRESS)) {
    cleanupProcessedFlag();
    final Runnable rebuildRunnable=new Runnable(){
      public void run(){
        final FileSystemSynchronizer synchronizer=new FileSystemSynchronizer();
        synchronizer.setCancelable(false);
        for (        Project project : ProjectManager.getInstance().getOpenProjects()) {
          synchronizer.registerCacheUpdater(new UnindexedFilesUpdater(project,ProjectRootManager.getInstance(project),FileBasedIndex.this));
        }
        try {
          clearIndex(indexId);
          synchronizer.execute();
        }
 catch (        StorageException e) {
          requestRebuild(indexId);
          LOG.info(e);
        }
 finally {
          myRebuildStatus.get(indexId).compareAndSet(REBUILD_IN_PROGRESS,OK);
        }
      }
    }
;
    final Application application=ApplicationManager.getApplication();
    if (application.isUnitTestMode()) {
      rebuildRunnable.run();
    }
 else {
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          new Task.Modal(null,"Updating index",false){
            public void run(            @NotNull final ProgressIndicator indicator){
              indicator.setIndeterminate(true);
              rebuildRunnable.run();
            }
          }
.queue();
        }
      }
);
    }
  }
  if (myRebuildStatus.get(indexId).get() == REBUILD_IN_PROGRESS) {
    throw new ProcessCanceledException();
  }
}
