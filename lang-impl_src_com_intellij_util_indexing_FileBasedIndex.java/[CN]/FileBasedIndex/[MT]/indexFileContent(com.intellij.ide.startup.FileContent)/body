{
  myChangedFilesUpdater.ensureAllInvalidateTasksCompleted();
  final VirtualFile file=content.getVirtualFile();
  FileContent fc=null;
  FileContent oldContent=null;
  final byte[] oldBytes=myFileContentAttic.remove(file);
  final boolean forceIndexing=oldBytes != null;
  PsiFile psiFile=null;
  for (  ID<?,?> indexId : myIndices.keySet()) {
    if (forceIndexing ? getInputFilter(indexId).acceptInput(file) : shouldIndexFile(file,indexId)) {
      if (fc == null) {
        byte[] currentBytes;
        try {
          currentBytes=content.getBytes();
        }
 catch (        IOException e) {
          currentBytes=ArrayUtil.EMPTY_BYTE_ARRAY;
        }
        fc=new FileContent(file,currentBytes);
        psiFile=content.getUserData(PSI_FILE);
        if (psiFile != null) {
          psiFile.putUserData(PsiFileImpl.BUILDING_STUB,true);
          fc.putUserData(PSI_FILE,psiFile);
        }
        oldContent=oldBytes != null ? new FileContent(file,oldBytes) : null;
      }
      try {
        updateSingleIndex(indexId,file,fc,oldContent);
      }
 catch (      StorageException e) {
        requestRebuild(indexId);
        LOG.info(e);
      }
    }
  }
  if (psiFile != null) {
    psiFile.putUserData(PsiFileImpl.BUILDING_STUB,null);
  }
  IndexingStamp.flushCache();
}
