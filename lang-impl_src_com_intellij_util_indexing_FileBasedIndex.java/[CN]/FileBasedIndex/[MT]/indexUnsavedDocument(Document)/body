{
  final VirtualFile vFile=FileDocumentManager.getInstance().getFile(document);
  if (!(vFile instanceof VirtualFileWithId) || !vFile.isValid()) {
    return;
  }
  PsiFile dominantContentFile=findDominantPsiForDocument(document);
  DocumentContent content;
  if (dominantContentFile != null && dominantContentFile.getModificationStamp() != document.getModificationStamp()) {
    content=new PsiContent(document,dominantContentFile);
  }
 else {
    content=new AuthenticContent(document);
  }
  final long currentDocStamp=content.getModificationStamp();
  if (currentDocStamp != getLastIndexedStamp(document).getAndSet(currentDocStamp)) {
    CharSequence lastIndexed=myLastIndexedUnsavedContent.get(document);
    if (lastIndexed == null) {
      lastIndexed=loadContent(vFile);
    }
    final FileContent oldFc=new FileContent(vFile,lastIndexed,vFile.getCharset());
    final FileContent newFc=new FileContent(vFile,content.getText(),vFile.getCharset());
    if (dominantContentFile != null) {
      dominantContentFile.putUserData(PsiFileImpl.BUILDING_STUB,true);
      newFc.putUserData(PSI_FILE,dominantContentFile);
    }
    if (content instanceof AuthenticContent) {
      newFc.putUserData(EDITOR_HIGHLIGHTER,document instanceof DocumentImpl ? ((DocumentImpl)document).getEditorHighlighterForCachesBuilding() : null);
    }
    for (    ID<?,?> indexId : myIndices.keySet()) {
      if (getInputFilter(indexId).acceptInput(vFile)) {
        final int inputId=Math.abs(getFileId(vFile));
        getIndex(indexId).update(inputId,newFc,oldFc);
      }
    }
    if (dominantContentFile != null) {
      dominantContentFile.putUserData(PsiFileImpl.BUILDING_STUB,null);
    }
    myLastIndexedUnsavedContent.put(document,newFc.getContentAsText());
  }
}
