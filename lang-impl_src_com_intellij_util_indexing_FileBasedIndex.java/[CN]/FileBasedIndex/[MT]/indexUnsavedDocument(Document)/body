{
  final VirtualFile vFile=FileDocumentManager.getInstance().getFile(document);
  if (!vFile.isValid() || !(vFile instanceof VirtualFileWithId)) {
    return;
  }
  PsiFile dominantContentFile=findDominantPsiForDocument(document);
  DocumentContent content;
  if (dominantContentFile != null) {
    content=new PsiContent(document,dominantContentFile);
  }
 else {
    content=new AuthenticContent(document);
  }
  final long currentDocStamp=content.getModificationStamp();
  if (currentDocStamp != getLastIndexedStamp(document).getAndSet(currentDocStamp)) {
    CharSequence lastIndexed=myLastIndexedUnsavedContent.get(document);
    if (lastIndexed == null) {
      lastIndexed=loadContent(vFile);
    }
    final FileContent oldFc=new FileContent(vFile,lastIndexed);
    final FileContent newFc=new FileContent(vFile,content.getText());
    for (    ID<?,?> indexId : myIndices.keySet()) {
      if (getInputFilter(indexId).acceptInput(vFile)) {
        final int inputId=Math.abs(getFileId(vFile));
        getIndex(indexId).update(inputId,newFc,oldFc);
      }
    }
    myLastIndexedUnsavedContent.put(document,newFc.getContentAsText());
  }
}
