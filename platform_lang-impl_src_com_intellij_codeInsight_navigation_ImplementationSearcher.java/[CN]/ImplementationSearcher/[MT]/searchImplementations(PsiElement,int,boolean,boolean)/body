{
  if (element == null)   return PsiElement.EMPTY_ARRAY;
  final PsiElement[] elements=searchDefinitions(element);
  if (elements == null)   return PsiElement.EMPTY_ARRAY;
  if (elements.length > 0) {
    if (!includeSelfAlways)     return filterElements(element,elements,offset);
    final PsiElement[] all;
    if (element.getTextRange() != null) {
      all=new PsiElement[elements.length + 1];
      all[0]=element;
      System.arraycopy(elements,0,all,1,elements.length);
    }
 else {
      all=elements;
    }
    return filterElements(element,all,offset);
  }
  return (includeSelfAlways || includeSelfIfNoOthers) && element.getTextRange() != null ? new PsiElement[]{element} : PsiElement.EMPTY_ARRAY;
}
