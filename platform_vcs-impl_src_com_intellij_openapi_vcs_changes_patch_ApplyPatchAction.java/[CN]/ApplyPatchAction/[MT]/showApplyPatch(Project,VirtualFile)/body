{
  FileDocumentManager.getInstance().saveAllDocuments();
  if (file != null) {
    final ApplyPatchDifferentiatedDialog dialog=new ApplyPatchDifferentiatedDialog(project,new ApplyPatchDefaultExecutor(project),Collections.<ApplyPatchExecutor>singletonList(new ImportToShelfExecutor(project)),ApplyPatchMode.APPLY,file);
    dialog.show();
  }
 else {
    FileChooser.chooseFilesWithSlideEffect(ApplyPatchDifferentiatedDialog.createSelectPatchDescriptor(),project,null,new Consumer<VirtualFile[]>(){
      @Override public void consume(      VirtualFile[] virtualFiles){
        if (virtualFiles.length != 1)         return;
        final ApplyPatchDifferentiatedDialog dialog=new ApplyPatchDifferentiatedDialog(project,new ApplyPatchDefaultExecutor(project),Collections.<ApplyPatchExecutor>singletonList(new ImportToShelfExecutor(project)),ApplyPatchMode.APPLY,virtualFiles[0]);
        dialog.show();
      }
    }
);
  }
}
