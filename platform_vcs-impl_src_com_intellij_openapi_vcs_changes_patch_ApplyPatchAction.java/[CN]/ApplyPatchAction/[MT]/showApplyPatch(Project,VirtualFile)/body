{
  FileDocumentManager.getInstance().saveAllDocuments();
  final VirtualFile toUse;
  if (file != null) {
    toUse=file;
  }
 else {
    final FileChooserDialog fileChooserDialog=FileChooserFactory.getInstance().createFileChooser(ApplyPatchDifferentiatedDialog.createSelectPatchDescriptor(),project);
    final VirtualFile[] files=fileChooserDialog.choose(null,project);
    if (files.length != 1) {
      return;
    }
    toUse=files[0];
  }
  final ApplyPatchDifferentiatedDialog dialog=new ApplyPatchDifferentiatedDialog(project,new ApplyPatchDefaultExecutor(project),Collections.<ApplyPatchExecutor>singletonList(new ImportToShelfExecutor(project)),ApplyPatchMode.APPLY,toUse);
  dialog.show();
}
