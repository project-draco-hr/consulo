{
  FileDocumentManager.getInstance().saveAllDocuments();
  if (file != null) {
    final ApplyPatchDifferentiatedDialog dialog=new ApplyPatchDifferentiatedDialog(project,new ApplyPatchDefaultExecutor(project),Collections.<ApplyPatchExecutor>singletonList(new ImportToShelfExecutor(project)),ApplyPatchMode.APPLY,file);
    dialog.show();
  }
 else {
    final FileChooserDescriptor descriptor=ApplyPatchDifferentiatedDialog.createSelectPatchDescriptor();
    FileChooser.chooseFiles(descriptor,project,null,new Consumer<List<VirtualFile>>(){
      @Override public void consume(      List<VirtualFile> files){
        if (files.size() != 1)         return;
        new ApplyPatchDifferentiatedDialog(project,new ApplyPatchDefaultExecutor(project),Collections.<ApplyPatchExecutor>singletonList(new ImportToShelfExecutor(project)),ApplyPatchMode.APPLY,files.get(0)).show();
      }
    }
);
  }
}
