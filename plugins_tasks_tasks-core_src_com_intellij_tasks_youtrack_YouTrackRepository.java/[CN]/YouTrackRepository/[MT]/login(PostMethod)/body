{
  if (method.getHostConfiguration().getProtocol() == null) {
    throw new Exception("Protocol not specified");
  }
  HttpClient client=getHttpClient();
  client.getState().setCredentials(AuthScope.ANY,new UsernamePasswordCredentials(getUsername(),getPassword()));
  configureHttpMethod(method);
  method.addParameter("login",getUsername());
  method.addParameter("password",getPassword());
  client.getParams().setContentCharset("UTF-8");
  client.executeMethod(method);
  if (method.getStatusCode() != 200) {
    throw new Exception("Cannot login: HTTP status code " + method.getStatusCode());
  }
  String response=method.getResponseBodyAsString(1000);
  if (response == null) {
    throw new NullPointerException();
  }
  if (!response.contains("<login>ok</login>")) {
    int pos=response.indexOf("</error>");
    int length="<error>".length();
    if (pos > length) {
      response=response.substring(length,pos);
    }
    throw new Exception("Cannot login: " + response);
  }
  return client;
}
