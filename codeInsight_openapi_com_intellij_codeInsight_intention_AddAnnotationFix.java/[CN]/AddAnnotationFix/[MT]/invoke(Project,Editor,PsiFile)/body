{
  final ExternalAnnotationsManager annotationsManager=ExternalAnnotationsManager.getInstance(project);
  if (myModifierListOwner != null) {
    final PsiModifierList modifierList=myModifierListOwner.getModifierList();
    LOG.assertTrue(modifierList != null);
    if (modifierList.findAnnotation(myAnnotation) != null)     return;
    if (annotationsManager.useExternalAnnotations(myModifierListOwner)) {
      for (      String fqn : myAnnotationsToRemove) {
        annotationsManager.deannotate(myModifierListOwner,fqn);
      }
      annotationsManager.annotateExternally(myModifierListOwner,myAnnotation);
    }
 else {
      if (!file.isWritable() && ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(file.getVirtualFile()).hasReadonlyFiles())       return;
      for (      String fqn : myAnnotationsToRemove) {
        PsiAnnotation annotation=AnnotationUtil.findAnnotation(myModifierListOwner,fqn);
        if (annotation != null) {
          annotation.delete();
        }
      }
      PsiManager manager=file.getManager();
      PsiElementFactory factory=manager.getElementFactory();
      PsiAnnotation annotation=factory.createAnnotationFromText("@" + myAnnotation,myModifierListOwner);
      PsiElement inserted=modifierList.addAfter(annotation,null);
      CodeStyleManager.getInstance(project).shortenClassReferences(inserted);
    }
  }
 else {
    final PsiElement element=file.findElementAt(editor.getCaretModel().getOffset());
    annotationsManager.annotateExternally(PsiTreeUtil.getParentOfType(element,PsiModifierListOwner.class),myAnnotation);
  }
}
