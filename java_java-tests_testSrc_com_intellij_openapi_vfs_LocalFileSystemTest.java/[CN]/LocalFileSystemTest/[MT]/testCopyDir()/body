{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      try {
        File fromDir=createTempDirectory();
        File toDir=createTempDirectory();
        VirtualFile fromVDir=LocalFileSystem.getInstance().findFileByPath(fromDir.getPath().replace(File.separatorChar,'/'));
        VirtualFile toVDir=LocalFileSystem.getInstance().findFileByPath(toDir.getPath().replace(File.separatorChar,'/'));
        assertNotNull(fromVDir);
        assertNotNull(toVDir);
        final VirtualFile dirToCopy=fromVDir.createChildDirectory(null,"dir");
        final VirtualFile file=dirToCopy.createChildData(null,"temp_file");
        file.setBinaryContent(new byte[]{0,1,2,3});
        final String newName="dir";
        final VirtualFile dirCopy=dirToCopy.copy(null,toVDir,newName);
        assertEquals(newName,dirCopy.getName());
        PlatformTestUtil.assertDirectoriesEqual(toVDir,fromVDir,null);
      }
 catch (      Exception e) {
        LOG.error(e);
      }
    }
  }
);
}
