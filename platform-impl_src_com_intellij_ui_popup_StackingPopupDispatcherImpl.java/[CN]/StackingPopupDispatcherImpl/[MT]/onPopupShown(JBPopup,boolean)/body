{
  if (inStack) {
    myStack.push((JBPopupImpl)popup);
    if (ApplicationManager.getApplication() != null) {
      IdeEventQueue.getInstance().getPopupManager().setActivePopup(getInstance());
    }
  }
 else   if (popup.isPersistent()) {
    myPersistentPopups.add(popup);
  }
  myAllPopups.add(popup);
}
