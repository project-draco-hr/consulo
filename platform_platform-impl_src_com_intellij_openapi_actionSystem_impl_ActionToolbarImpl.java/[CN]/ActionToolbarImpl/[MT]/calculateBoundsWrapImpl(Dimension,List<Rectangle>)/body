{
  if (getWidth() == 0 || getHeight() == 0) {
    try {
      setLayoutPolicy(NOWRAP_LAYOUT_POLICY);
      calculateBoundsNowrapImpl(bounds);
    }
  finally {
      setLayoutPolicy(WRAP_LAYOUT_POLICY);
    }
    return;
  }
  final int componentCount=getComponentCount();
  LOG.assertTrue(componentCount <= bounds.size());
  final Insets insets=getInsets();
  if (myAdjustTheSameSize) {
    if (myOrientation == SwingConstants.HORIZONTAL) {
      final int maxWidth=getMaxButtonWidth();
      final int maxHeight=getMaxButtonHeight();
      int xOffset=insets.left;
      int yOffset=insets.top;
      final int maxRowWidth=Math.max(sizeToFit.width,componentCount * maxWidth / 3);
      for (int i=0; i < componentCount; i++) {
        if (xOffset + maxWidth > maxRowWidth) {
          xOffset=insets.left;
          yOffset+=maxHeight;
        }
        final Rectangle each=bounds.get(i);
        each.setBounds(xOffset,maxWidth,yOffset,maxHeight);
        xOffset+=maxWidth;
      }
    }
 else {
      final int maxWidth=getMaxButtonWidth();
      final int maxHeight=getMaxButtonHeight();
      int xOffset=insets.left;
      int yOffset=insets.top;
      final int maxRowHeight=Math.max(sizeToFit.height,componentCount * myMinimumButtonSize.height / 3);
      for (int i=0; i < componentCount; i++) {
        if (yOffset + maxHeight > maxRowHeight) {
          yOffset=insets.top;
          xOffset+=maxWidth;
        }
        final Rectangle each=bounds.get(i);
        each.setBounds(xOffset,maxWidth,yOffset,maxHeight);
        yOffset+=maxHeight;
      }
    }
  }
 else {
    if (myOrientation == SwingConstants.HORIZONTAL) {
      int rowHeight=0;
      final Dimension[] dims=new Dimension[componentCount];
      for (int i=0; i < componentCount; i++) {
        dims[i]=getChildPreferredSize(i);
        final int height=dims[i].height;
        rowHeight=Math.max(rowHeight,height);
      }
      int xOffset=insets.left;
      int yOffset=insets.top;
      final int maxRowWidth=Math.max(getWidth(),componentCount * myMinimumButtonSize.width / 3);
      for (int i=0; i < componentCount; i++) {
        final Dimension d=dims[i];
        if (xOffset + d.width > maxRowWidth) {
          xOffset=insets.left;
          yOffset+=rowHeight;
        }
        final Rectangle each=bounds.get(i);
        each.setBounds(xOffset,yOffset + (rowHeight - d.height) / 2,d.width,d.height);
        xOffset+=d.width;
      }
    }
 else {
      int rowWidth=0;
      final Dimension[] dims=new Dimension[componentCount];
      for (int i=0; i < componentCount; i++) {
        dims[i]=getChildPreferredSize(i);
        final int width=dims[i].width;
        rowWidth=Math.max(rowWidth,width);
      }
      int xOffset=insets.left;
      int yOffset=insets.top;
      final int maxRowHeight=Math.max(getHeight(),componentCount * myMinimumButtonSize.height / 3);
      for (int i=0; i < componentCount; i++) {
        final Dimension d=dims[i];
        if (yOffset + d.height > maxRowHeight) {
          yOffset=insets.top;
          xOffset+=rowWidth;
        }
        final Rectangle each=bounds.get(i);
        each.setBounds(xOffset + (rowWidth - d.width) / 2,yOffset,d.width,d.height);
        yOffset+=d.height;
      }
    }
  }
}
