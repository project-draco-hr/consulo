{
  final int componentCount=getComponentCount();
  LOG.assertTrue(componentCount <= bounds.size());
  final boolean actualLayout=bounds == myComponentBounds;
  if (actualLayout) {
    myAutoPopupRec=null;
  }
  int autoButtonSize=myAutoPopupIcon.getIconWidth();
  boolean full=false;
  final Insets insets=getInsets();
  if (myOrientation == SwingConstants.HORIZONTAL) {
    int eachX=insets.left;
    int eachY=insets.top;
    int maxHeight=0;
    for (int i=0; i < componentCount; i++) {
      final Component eachComp=getComponent(i);
      final boolean isLast=i == componentCount - 1;
      final Rectangle eachBound=new Rectangle(eachComp.getPreferredSize());
      maxHeight=Math.max(eachBound.height,maxHeight);
      if (!full) {
        boolean inside;
        if (isLast) {
          inside=eachX + eachBound.width <= sizeToFit.width;
        }
 else {
          inside=eachX + eachBound.width + autoButtonSize <= sizeToFit.width;
        }
        if (inside) {
          if (eachComp == mySecondaryActionsButton) {
            assert isLast;
            if (sizeToFit.width != Integer.MAX_VALUE) {
              eachBound.x=sizeToFit.width - eachBound.width;
              eachX=(int)eachBound.getMaxX();
            }
 else {
              eachBound.x=eachX;
            }
          }
 else {
            eachBound.x=eachX;
            eachX+=eachBound.width;
          }
          eachBound.y=eachY;
        }
 else {
          full=true;
        }
      }
      if (full) {
        if (myAutoPopupRec == null) {
          myAutoPopupRec=new Rectangle(eachX,eachY,sizeToFit.width - eachX - 1,sizeToFit.height - 1);
          myFirstOusideIndex=i;
        }
        eachBound.x=Integer.MAX_VALUE;
        eachBound.y=Integer.MAX_VALUE;
      }
      bounds.get(i).setBounds(eachBound);
    }
    for (    final Rectangle r : bounds) {
      if (r.height < maxHeight) {
        r.y=r.y + (maxHeight - r.height) / 2;
      }
    }
  }
 else {
    int eachX=insets.left;
    int eachY=insets.top;
    for (int i=0; i < componentCount; i++) {
      final Rectangle eachBound=new Rectangle(getComponent(i).getPreferredSize());
      if (!full) {
        boolean outside;
        if (i < componentCount - 1) {
          outside=eachY + eachBound.height + autoButtonSize < sizeToFit.height;
        }
 else {
          outside=eachY + eachBound.height < sizeToFit.height;
        }
        if (outside) {
          eachBound.x=eachX;
          eachBound.y=eachY;
          eachY+=eachBound.height;
        }
 else {
          full=true;
        }
      }
      if (full) {
        if (myAutoPopupRec == null) {
          myAutoPopupRec=new Rectangle(eachX,eachY,sizeToFit.width - 1,sizeToFit.height - eachY - 1);
          myFirstOusideIndex=i;
        }
        eachBound.x=Integer.MAX_VALUE;
        eachBound.y=Integer.MAX_VALUE;
      }
      bounds.get(i).setBounds(eachBound);
    }
  }
}
