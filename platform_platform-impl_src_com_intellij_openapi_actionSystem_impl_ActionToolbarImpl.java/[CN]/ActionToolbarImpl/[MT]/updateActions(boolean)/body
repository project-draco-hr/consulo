{
  final Runnable updateRunnable=new Runnable(){
    public void run(){
      myNewVisibleActions.clear();
      final DataContext dataContext=getDataContext();
      Utils.expandActionGroup(myActionGroup,myNewVisibleActions,myPresentationFactory,dataContext,myPlace,myActionManager);
      if (!myNewVisibleActions.equals(myVisibleActions)) {
        final boolean changeBarVisibility=myNewVisibleActions.isEmpty() || myVisibleActions.isEmpty();
        final ArrayList<AnAction> temp=myVisibleActions;
        myVisibleActions=myNewVisibleActions;
        myNewVisibleActions=temp;
        removeAll();
        mySecondaryActions.removeAll();
        mySecondaryActionsButton=null;
        fillToolBar(myVisibleActions,getLayoutPolicy() == AUTO_LAYOUT_POLICY && myOrientation == SwingConstants.HORIZONTAL);
        if (changeBarVisibility) {
          revalidate();
        }
 else {
          final Container parent=getParent();
          if (parent != null) {
            parent.invalidate();
            parent.validate();
          }
        }
        repaint();
      }
    }
  }
;
  if (now) {
    updateRunnable.run();
  }
 else {
    final Application app=ApplicationManager.getApplication();
    final IdeFocusManager fm=IdeFocusManager.getInstance(null);
    if (!app.isUnitTestMode() && !app.isHeadlessEnvironment()) {
      if (app.isDispatchThread()) {
        fm.doWhenFocusSettlesDown(updateRunnable);
      }
 else {
        UiNotifyConnector.doWhenFirstShown(this,new Runnable(){
          public void run(){
            fm.doWhenFocusSettlesDown(updateRunnable);
          }
        }
);
      }
    }
  }
}
