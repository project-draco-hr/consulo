{
  FindManager findManager=FindManager.getInstance(project);
  Document document=editor.getDocument();
  final FindResult result=findManager.findString(document.getCharsSequence(),offset,model,getVirtualFile(editor));
  boolean isFound=result.isStringFound();
  final SelectionModel selection=editor.getSelectionModel();
  if (isFound && !model.isGlobal()) {
    if (!selectionMayContainRange(selection,result)) {
      isFound=false;
    }
 else     if (!selectionStrictlyContainsRange(selection,result)) {
      final int[] starts=selection.getBlockSelectionStarts();
      for (      int newOffset : starts) {
        if (newOffset > result.getStartOffset()) {
          return doSearch(project,editor,newOffset,toWarn,model,adjustEditor);
        }
      }
    }
  }
  if (!isFound) {
    if (toWarn) {
      processNotFound(editor,model.getStringToFind(),model,project);
    }
    return null;
  }
  if (adjustEditor) {
    final CaretModel caretModel=editor.getCaretModel();
    final ScrollingModel scrollingModel=editor.getScrollingModel();
    int oldCaretOffset=caretModel.getOffset();
    boolean forward=oldCaretOffset < result.getStartOffset();
    final ScrollType scrollType=forward ? ScrollType.CENTER_DOWN : ScrollType.CENTER_UP;
    if (model.isGlobal()) {
      int targetCaretPosition=result.getEndOffset();
      if (selection.getSelectionEnd() - selection.getSelectionStart() == result.getLength()) {
        targetCaretPosition=caretModel.getOffset() - selection.getSelectionStart() + result.getStartOffset();
      }
      if (caretModel.getCaretAt(editor.offsetToVisualPosition(targetCaretPosition)) != null) {
        return result;
      }
      caretModel.moveToOffset(targetCaretPosition);
      selection.removeSelection();
      scrollingModel.scrollToCaret(scrollType);
      scrollingModel.runActionOnScrollingFinished(new Runnable(){
        @Override public void run(){
          scrollingModel.scrollTo(editor.offsetToLogicalPosition(result.getStartOffset()),scrollType);
          scrollingModel.scrollTo(editor.offsetToLogicalPosition(result.getEndOffset()),scrollType);
        }
      }
);
    }
 else {
      moveCaretAndDontChangeSelection(editor,result.getStartOffset(),scrollType);
      moveCaretAndDontChangeSelection(editor,result.getEndOffset(),scrollType);
    }
    IdeDocumentHistory.getInstance(project).includeCurrentCommandAsNavigation();
    EditorColorsManager manager=EditorColorsManager.getInstance();
    TextAttributes selectionAttributes=manager.getGlobalScheme().getAttributes(EditorColors.SEARCH_RESULT_ATTRIBUTES);
    if (!model.isGlobal()) {
      final RangeHighlighterEx segmentHighlighter=(RangeHighlighterEx)editor.getMarkupModel().addRangeHighlighter(result.getStartOffset(),result.getEndOffset(),HighlighterLayer.SELECTION + 1,selectionAttributes,HighlighterTargetArea.EXACT_RANGE);
      MyListener listener=new MyListener(editor,segmentHighlighter);
      caretModel.addCaretListener(listener);
    }
 else {
      selection.setSelection(result.getStartOffset(),result.getEndOffset());
    }
  }
  return result;
}
