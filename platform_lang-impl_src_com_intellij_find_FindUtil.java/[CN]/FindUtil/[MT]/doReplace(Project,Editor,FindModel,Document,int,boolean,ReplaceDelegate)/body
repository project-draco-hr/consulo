{
  FindManager findManager=FindManager.getInstance(project);
  final FindModel model=(FindModel)aModel.clone();
  int occurrences=0;
  List<Pair<TextRange,String>> rangesToChange=new ArrayList<Pair<TextRange,String>>();
  boolean replaced=false;
  boolean reallyReplaced=false;
  int offset=caretOffset;
  while (offset >= 0 && offset < editor.getDocument().getTextLength()) {
    caretOffset=offset;
    FindResult result=doSearch(project,editor,offset,!replaced,model,toPrompt);
    if (result == null) {
      break;
    }
    int startResultOffset=result.getStartOffset();
    model.setFromCursor(true);
    int startOffset=result.getStartOffset();
    int endOffset=result.getEndOffset();
    String foundString=document.getCharsSequence().subSequence(startOffset,endOffset).toString();
    String toReplace;
    try {
      CharSequence textToMatch=document.getCharsSequence().subSequence(offset,endOffset < document.getTextLength() ? endOffset + 1 : endOffset);
      toReplace=findManager.getStringToReplace(foundString,model,startOffset - offset,textToMatch);
    }
 catch (    FindManager.MalformedReplacementStringException e) {
      if (!ApplicationManager.getApplication().isUnitTestMode()) {
        Messages.showErrorDialog(project,e.getMessage(),FindBundle.message("find.replace.invalid.replacement.string.title"));
      }
      break;
    }
    if (toPrompt) {
      int promptResult=findManager.showPromptDialog(model,FindBundle.message("find.replace.dialog.title"));
      if (promptResult == FindManager.PromptResult.SKIP) {
        offset=model.isForward() ? result.getEndOffset() : startResultOffset;
        continue;
      }
      if (promptResult == FindManager.PromptResult.CANCEL) {
        break;
      }
      if (promptResult == FindManager.PromptResult.ALL) {
        toPrompt=false;
        ((DocumentEx)document).setInBulkUpdate(true);
      }
    }
    int newOffset;
    if (delegate == null || delegate.shouldReplace(result,toReplace)) {
      boolean reallyReplace=toPrompt;
      if (reallyReplace) {
        if (!reallyReplaced) {
          editor.getCaretModel().moveToOffset(0);
          reallyReplaced=true;
        }
      }
      TextRange textRange=doReplace(project,document,model,result,toReplace,reallyReplace,rangesToChange);
      replaced=true;
      newOffset=model.isForward() ? textRange.getEndOffset() : textRange.getStartOffset();
      occurrences++;
    }
 else {
      newOffset=model.isForward() ? result.getEndOffset() : result.getStartOffset();
    }
    if (newOffset == offset) {
      newOffset+=model.isForward() ? 1 : -1;
    }
    offset=newOffset;
  }
  if (replaced) {
    if (!toPrompt) {
      CharSequence text=document.getCharsSequence();
      final StringBuilder newText=new StringBuilder(document.getTextLength());
      Collections.sort(rangesToChange,new Comparator<Pair<TextRange,String>>(){
        @Override public int compare(        Pair<TextRange,String> o1,        Pair<TextRange,String> o2){
          return o1.getFirst().getStartOffset() - o2.getFirst().getStartOffset();
        }
      }
);
      int offsetBefore=0;
      for (      Pair<TextRange,String> pair : rangesToChange) {
        TextRange range=pair.getFirst();
        String replace=pair.getSecond();
        newText.append(text,offsetBefore,range.getStartOffset());
        if (delegate == null || delegate.shouldReplace(range,replace)) {
          newText.append(replace);
        }
 else {
          newText.append(text.subSequence(range.getStartOffset(),range.getEndOffset()));
        }
        offsetBefore=range.getEndOffset();
        if (offsetBefore < caretOffset) {
          caretOffset+=replace.length() - range.getLength();
        }
      }
      newText.append(text,offsetBefore,text.length());
      if (caretOffset > newText.length()) {
        caretOffset=newText.length();
      }
      final int finalCaretOffset=caretOffset;
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        @Override public void run(){
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            @Override public void run(){
              document.setText(newText);
              editor.getCaretModel().moveToOffset(finalCaretOffset);
              if (model.isGlobal()) {
                editor.getSelectionModel().removeSelection();
              }
            }
          }
);
        }
      }
,null,document);
    }
 else {
      if (reallyReplaced) {
        if (caretOffset > document.getTextLength()) {
          caretOffset=document.getTextLength();
        }
        editor.getCaretModel().moveToOffset(caretOffset);
      }
    }
  }
  ReplaceInProjectManager.reportNumberReplacedOccurrences(project,occurrences);
  return replaced;
}
