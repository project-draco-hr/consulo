{
  Document document=editor.getDocument();
  if (!FileDocumentManager.getInstance().requestWriting(document,project)) {
    return false;
  }
  document.startGuardedBlockChecking();
  boolean toPrompt=model.isPromptOnReplace();
  if (!toPrompt) {
    ((DocumentEx)document).setInBulkUpdate(true);
  }
  try {
    toPrompt=doReplace(project,editor,model,document,offset,toPrompt);
  }
 catch (  ReadOnlyFragmentModificationException e) {
    EditorActionManager.getInstance().getReadonlyFragmentModificationHandler(document).handle(e);
  }
 finally {
    if (!toPrompt) {
      ((DocumentEx)document).setInBulkUpdate(false);
    }
    document.stopGuardedBlockChecking();
  }
  return true;
}
