{
  boolean isGlobal=true;
  String stringToFind=null;
  final SelectionModel selectionModel=editor != null ? editor.getSelectionModel() : null;
  String selectedText=selectionModel != null ? selectionModel.getSelectedText() : null;
  if (!StringUtil.isEmpty(selectedText)) {
    if (isMultilineSelection(editor)) {
      if (replace) {
        isGlobal=false;
        stringToFind=model.getStringToFind();
      }
 else {
        model.setMultiline(true);
      }
    }
    if (stringToFind == null) {
      stringToFind=selectedText;
    }
  }
 else {
    if (firstSearch) {
      stringToFind="";
    }
 else {
      stringToFind=model.getStringToFind();
    }
  }
  model.setReplaceState(replace);
  model.setStringToFind(stringToFind);
  model.setGlobal(isGlobal);
  model.setPromptOnReplace(false);
}
