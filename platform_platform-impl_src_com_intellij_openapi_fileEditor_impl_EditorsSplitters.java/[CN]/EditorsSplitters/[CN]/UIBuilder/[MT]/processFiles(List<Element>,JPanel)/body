{
  final Ref<EditorWindow> windowRef=new Ref<EditorWindow>();
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      windowRef.set(context == null ? new EditorWindow(EditorsSplitters.this) : findWindowWith(context));
    }
  }
);
  final EditorWindow window=windowRef.get();
  LOG.assertTrue(window != null);
  VirtualFile focusedFile=null;
  for (int i=0; i < fileElements.size(); i++) {
    final Element file=fileElements.get(i);
    try {
      final FileEditorManagerImpl fileEditorManager=getManager();
      Element historyElement=file.getChild(HistoryEntry.TAG);
      VirtualFile virtualFile=HistoryEntry.getVirtualFile(historyElement);
      Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
      final HistoryEntry entry=new HistoryEntry(fileEditorManager.getProject(),historyElement);
      final boolean isCurrentInTab=Boolean.valueOf(file.getAttributeValue(CURRENT_IN_TAB)).booleanValue();
      Boolean pin=Boolean.valueOf(file.getAttributeValue(PINNED));
      fileEditorManager.openFileImpl4(window,entry.myFile,entry,isCurrentInTab,isCurrentInTab,pin,i);
      if (isCurrentInTab) {
        focusedFile=entry.myFile;
      }
      if (document != null) {
        document.putUserData(DUMMY_KEY,null);
      }
      updateProgress();
    }
 catch (    InvalidDataException e) {
      if (ApplicationManager.getApplication().isUnitTestMode()) {
        LOG.error(e);
      }
    }
  }
  if (focusedFile != null) {
    getManager().addSelectionRecord(focusedFile,window);
  }
  return window.myPanel;
}
