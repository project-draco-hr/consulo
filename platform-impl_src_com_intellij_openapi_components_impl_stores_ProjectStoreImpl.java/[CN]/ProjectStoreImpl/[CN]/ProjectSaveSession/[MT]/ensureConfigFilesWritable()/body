{
  return ApplicationManager.getApplication().runReadAction(new Computable<ReadonlyStatusHandler.OperationStatus>(){
    public ReadonlyStatusHandler.OperationStatus compute(){
      final List<IFile> filesToSave;
      try {
        filesToSave=getAllStorageFilesToSave(true);
      }
 catch (      IOException e) {
        LOG.error(e);
        return null;
      }
      List<VirtualFile> readonlyFiles=new ArrayList<VirtualFile>();
      for (      IFile file : filesToSave) {
        final VirtualFile virtualFile=LocalFileSystem.getInstance().findFileByIoFile(file);
        if (virtualFile != null) {
          virtualFile.refresh(false,false);
          if (!virtualFile.isWritable())           readonlyFiles.add(virtualFile);
        }
      }
      if (readonlyFiles.isEmpty())       return new ReadonlyStatusHandler.OperationStatus(VirtualFile.EMPTY_ARRAY,VirtualFile.EMPTY_ARRAY);
      return ReadonlyStatusHandler.getInstance(myProject).ensureFilesWritable(readonlyFiles.toArray(new VirtualFile[readonlyFiles.size()]));
    }
  }
);
}
