{
  CompositeElement parent=tag;
  int lastPosition=-1;
  while (true) {
    if (lexer.getTokenType() == XML_ENTITY_REF_TOKEN) {
      tag.rawAddChildren(parseEntityRef(lexer));
      continue;
    }
    if (lexer.getTokenType() != XML_NAME) {
      return;
    }
    if (lastPosition != -1) {
      if (lastPosition == lexer.getTokenStart()) {
        tag.rawAddChildren(Factory.createErrorElement(XmlErrorMessages.message("expected.whitespace")));
        lastPosition=-1;
      }
    }
    if (tag instanceof XmlTag) {
      CompositeElement attribute=ASTFactory.composite(XML_ATTRIBUTE);
      tag.rawAddChildren(attribute);
      parent=attribute;
    }
    addToken(parent,lexer);
    if (lexer.getTokenType() != XML_EQ) {
      parent.rawAddChildren(Factory.createErrorElement(XmlErrorMessages.message("expected.attribute.eq.sign")));
      continue;
    }
    addToken(parent,lexer);
    if (tag instanceof XmlTag) {
      CompositeElement attributeValue=ASTFactory.composite(XML_ATTRIBUTE_VALUE);
      parent.rawAddChildren(attributeValue);
      parent=attributeValue;
    }
    if (lexer.getTokenType() != XML_ATTRIBUTE_VALUE_START_DELIMITER) {
      return;
    }
    addToken(parent,lexer);
    if (lexer.getTokenType() == XML_ATTRIBUTE_VALUE_TOKEN) {
      addToken(parent,lexer);
      if (lexer.getTokenType() == XML_ATTRIBUTE_VALUE_END_DELIMITER) {
        lastPosition=lexer.getTokenEnd();
        addToken(parent,lexer);
      }
 else {
        lastPosition=-1;
      }
    }
 else     if (lexer.getTokenType() == XML_ATTRIBUTE_VALUE_END_DELIMITER) {
      lastPosition=lexer.getTokenEnd();
      addToken(parent,lexer);
    }
 else {
      lastPosition=-1;
    }
    if (tag instanceof XmlTag) {
      parent=tag;
    }
  }
}
