{
  Window _window=null;
  IdeFocusManager ideFocusManager=IdeFocusManager.getGlobalInstance();
  Component focusOwner=IdeFocusManager.findInstance().getFocusOwner();
  if (focusOwner != null) {
    _window=SwingUtilities.getWindowAncestor(focusOwner);
  }
  if (_window == null) {
    focusOwner=ideFocusManager.getLastFocusedFor(ideFocusManager.getLastFocusedFrame());
    if (focusOwner != null) {
      _window=SwingUtilities.getWindowAncestor(focusOwner);
    }
  }
  if (_window == null) {
    _window=WindowManager.getInstance().findVisibleFrame();
  }
  if (_window == null && window != null) {
    focusOwner=window.getMostRecentFocusOwner();
    if (focusOwner != null) {
      _window=SwingUtilities.getWindowAncestor(focusOwner);
    }
  }
  if (_window != null) {
    if (ModalityHelper.isModalBlocked(_window)) {
      _window=ModalityHelper.getModalBlockerFor(_window);
    }
  }
  LOG.assertTrue(getWindowTitle(_window) != null,"A window without a title should not be used for showing MacMessages");
  while (_window != null && getWindowTitle(_window) == null) {
    _window=_window.getOwner();
  }
  while (Registry.is("skip.untitled.windows.for.mac.messages") && _window != null && _window instanceof JDialog && !((JDialog)_window).isModal()) {
    _window=_window.getOwner();
  }
  return _window;
}
