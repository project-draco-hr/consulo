def getchanges(self, rev):
    self.modecache = {}
    self._update(rev)
    changes = []
    copies = {}
    for f in self.changes[rev].add_files:
        changes.append((f, rev))
    for f in self.changes[rev].mod_files:
        changes.append((f, rev))
    for f in self.changes[rev].del_files:
        changes.append((f, rev))
    for src in self.changes[rev].ren_files:
        to = self.changes[rev].ren_files[src]
        changes.append((src, rev))
        changes.append((to, rev))
        copies[to] = src
    for src in self.changes[rev].ren_dirs:
        to = self.changes[rev].ren_dirs[src]
        (chgs, cps) = self._rendirchanges(src, to)
        changes += [(f, rev) for f in chgs]
        copies.update(cps)
    self.lastrev = rev
    return (sorted(set(changes)), copies)
