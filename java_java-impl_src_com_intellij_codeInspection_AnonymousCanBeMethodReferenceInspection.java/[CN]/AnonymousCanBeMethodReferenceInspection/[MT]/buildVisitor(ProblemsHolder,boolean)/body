{
  return new JavaElementVisitor(){
    @Override public void visitAnonymousClass(    PsiAnonymousClass aClass){
      super.visitAnonymousClass(aClass);
      if (PsiUtil.getLanguageLevel(aClass).isAtLeast(LanguageLevel.JDK_1_8)) {
        final PsiClassType baseClassType=aClass.getBaseClassType();
        final String functionalInterfaceErrorMessage=LambdaUtil.checkInterfaceFunctional(baseClassType);
        if (functionalInterfaceErrorMessage == null) {
          final PsiMethod[] methods=aClass.getMethods();
          if (methods.length == 1 && aClass.getFields().length == 0) {
            final PsiCodeBlock body=methods[0].getBody();
            final PsiCallExpression callExpression=LambdaCanBeMethReferenceInspection.canBeMethodReferenceProblem(body,methods[0].getParameterList().getParameters());
            if (callExpression != null && callExpression.resolveMethod() != methods[0]) {
              final PsiElement parent=aClass.getParent();
              if (parent instanceof PsiNewExpression) {
                final PsiJavaCodeReferenceElement classReference=((PsiNewExpression)parent).getClassOrAnonymousClassReference();
                if (classReference != null) {
                  holder.registerProblem(classReference,"Anonymous type can be replaced with method reference",new ReplaceWithMethodRefFix());
                }
              }
            }
          }
        }
      }
    }
  }
;
}
