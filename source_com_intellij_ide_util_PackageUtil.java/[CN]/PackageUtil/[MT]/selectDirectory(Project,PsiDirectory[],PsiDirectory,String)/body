{
  ProjectFileIndex projectFileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  ArrayList<PsiDirectory> possibleDirs=new ArrayList<PsiDirectory>();
  for (int i=0; i < packageDirectories.length; i++) {
    PsiDirectory dir=packageDirectories[i];
    if (!dir.isValid())     continue;
    if (!dir.isWritable())     continue;
    if (possibleDirs.contains(dir))     continue;
    if (!projectFileIndex.isInContent(dir.getVirtualFile()))     continue;
    possibleDirs.add(dir);
  }
  if (possibleDirs.size() == 0)   return null;
  if (possibleDirs.size() == 1)   return possibleDirs.get(0);
  if (ApplicationManager.getApplication().isUnitTestMode())   return possibleDirs.get(0);
  DirectoryChooser chooser=new DirectoryChooser(project);
  chooser.setTitle(IdeBundle.message("title.choose.destination.directory"));
  chooser.fillList(possibleDirs.toArray(new PsiDirectory[possibleDirs.size()]),defaultDirectory,project,postfixToShow);
  chooser.show();
  return chooser.isOK() ? chooser.getSelectedDirectory() : null;
}
