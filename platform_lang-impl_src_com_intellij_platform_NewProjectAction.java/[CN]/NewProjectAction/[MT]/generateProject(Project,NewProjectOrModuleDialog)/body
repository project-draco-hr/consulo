{
  final File location=new File(dialog.getLocationText());
  final int childCount=location.exists() ? location.list().length : 0;
  if (!location.exists() && !location.mkdirs()) {
    Messages.showErrorDialog(project,"Cannot create directory '" + location + "'","Create Project");
    return null;
  }
  final VirtualFile baseDir=ApplicationManager.getApplication().runWriteAction(new Computable<VirtualFile>(){
    @Override public VirtualFile compute(){
      return LocalFileSystem.getInstance().refreshAndFindFileByIoFile(location);
    }
  }
);
  baseDir.refresh(false,true);
  if (childCount > 0) {
    int rc=Messages.showYesNoDialog(project,"The directory '" + location + "' is not empty. Continue?","Create New Project",Messages.getQuestionIcon());
    if (rc == Messages.NO) {
      return null;
    }
  }
  GeneralSettings.getInstance().setLastProjectCreationLocation(location.getParent());
  return PlatformProjectOpenProcessor.doOpenProject(baseDir,null,false,-1,new Consumer<Project>(){
    @Override @RequiredDispatchThread public void consume(    final Project project){
      dialog.doCreate(project,baseDir);
    }
  }
);
}
