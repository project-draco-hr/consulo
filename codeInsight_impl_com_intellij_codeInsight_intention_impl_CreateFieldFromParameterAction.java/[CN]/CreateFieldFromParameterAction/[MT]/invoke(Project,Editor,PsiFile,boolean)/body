{
  final PsiParameter myParameter=findParameterAtCursor(file,editor);
  if (!CodeInsightUtil.prepareFileForWrite(myParameter.getContainingFile()))   return;
  IdeDocumentHistory.getInstance(project).includeCurrentPlaceAsChangePlace();
  final PsiType type=getType(myParameter);
  final CodeStyleManager styleManager=CodeStyleManager.getInstance(project);
  final String parameterName=myParameter.getName();
  String propertyName=styleManager.variableNameToPropertyName(parameterName,VariableKind.PARAMETER);
  String fieldNameToCalc;
  boolean isFinalToCalc;
  final PsiClass targetClass=PsiTreeUtil.getParentOfType(myParameter,PsiClass.class);
  final PsiMethod method=(PsiMethod)myParameter.getDeclarationScope();
  final boolean isMethodStatic=method.hasModifierProperty(PsiModifier.STATIC);
  VariableKind kind=isMethodStatic ? VariableKind.STATIC_FIELD : VariableKind.FIELD;
  SuggestedNameInfo suggestedNameInfo=styleManager.suggestVariableName(kind,propertyName,null,type);
  String[] names=suggestedNameInfo.names;
  if (isInteractive) {
    List<String> namesList=new ArrayList<String>();
    namesList.addAll(Arrays.asList(names));
    String defaultName=styleManager.propertyNameToVariableName(propertyName,kind);
    if (namesList.contains(defaultName)) {
      Collections.swap(namesList,0,namesList.indexOf(defaultName));
    }
 else {
      namesList.add(0,defaultName);
    }
    names=namesList.toArray(new String[namesList.size()]);
    boolean myBeFinal=method.isConstructor();
    CreateFieldFromParameterDialog dialog=new CreateFieldFromParameterDialog(project,names,type.getCanonicalText(),targetClass,myBeFinal);
    dialog.show();
    if (!dialog.isOK())     return;
    fieldNameToCalc=dialog.getEnteredName();
    isFinalToCalc=dialog.isDeclareFinal();
    suggestedNameInfo.nameChoosen(fieldNameToCalc);
  }
 else {
    isFinalToCalc=!isMethodStatic;
    fieldNameToCalc=names[0];
  }
  final boolean isFinal=isFinalToCalc;
  final String fieldName=fieldNameToCalc;
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        PsiManager psiManager=PsiManager.getInstance(project);
        PsiElementFactory factory=psiManager.getElementFactory();
        PsiField field=factory.createField(fieldName,type);
        PsiModifierList modifierList=field.getModifierList();
        modifierList.setModifierProperty(PsiModifier.STATIC,isMethodStatic);
        modifierList.setModifierProperty(PsiModifier.FINAL,isFinal);
        if (AnnotationUtil.isAnnotated(myParameter,AnnotationUtil.NULLABLE,false)) {
          modifierList.addAfter(factory.createAnnotationFromText("@" + AnnotationUtil.NULLABLE,field),null);
        }
        PsiCodeBlock methodBody=method.getBody();
        if (methodBody == null)         return;
        PsiStatement[] statements=methodBody.getStatements();
        int i=0;
        Pair<PsiField,Boolean> fieldAnchor=null;
        for (; i < statements.length; i++) {
          PsiStatement psiStatement=statements[i];
          if (psiStatement instanceof PsiExpressionStatement) {
            PsiExpressionStatement expressionStatement=(PsiExpressionStatement)psiStatement;
            PsiExpression expression=expressionStatement.getExpression();
            if (expression instanceof PsiMethodCallExpression) {
              PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)expression;
              @NonNls String text=methodCallExpression.getMethodExpression().getText();
              if (text.equals("super") || text.equals("this")) {
                continue;
              }
            }
 else             if (expression instanceof PsiAssignmentExpression) {
              PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)expression;
              PsiExpression lExpression=assignmentExpression.getLExpression();
              PsiExpression rExpression=assignmentExpression.getRExpression();
              if (!(lExpression instanceof PsiReferenceExpression))               break;
              if (!(rExpression instanceof PsiReferenceExpression))               break;
              PsiReferenceExpression lReference=(PsiReferenceExpression)lExpression;
              PsiReferenceExpression rReference=(PsiReferenceExpression)rExpression;
              PsiElement lElement=lReference.resolve();
              PsiElement rElement=rReference.resolve();
              if (!(lElement instanceof PsiField) || ((PsiField)lElement).getContainingClass() != targetClass)               break;
              if (!(rElement instanceof PsiParameter))               break;
              if (myParameter.getTextRange().getStartOffset() < rElement.getTextRange().getStartOffset()) {
                fieldAnchor=Pair.create((PsiField)lElement,Boolean.TRUE);
                break;
              }
              fieldAnchor=Pair.create((PsiField)lElement,Boolean.FALSE);
              continue;
            }
          }
          break;
        }
        String stmtText=fieldName + " = " + parameterName+ ";";
        if (fieldName.equals(parameterName)) {
          @NonNls String prefix=isMethodStatic ? targetClass.getName() == null ? "" : targetClass.getName() + "." : "this.";
          stmtText=prefix + stmtText;
        }
        PsiStatement assignmentStmt=factory.createStatementFromText(stmtText,methodBody);
        assignmentStmt=(PsiStatement)styleManager.reformat(assignmentStmt);
        if (i == statements.length) {
          methodBody.add(assignmentStmt);
        }
 else {
          methodBody.addAfter(assignmentStmt,i > 0 ? statements[i - 1] : null);
        }
        if (fieldAnchor != null) {
          PsiVariable psiVariable=fieldAnchor.getFirst();
          psiVariable.normalizeDeclaration();
        }
        boolean found=false;
        final PsiField[] fields=targetClass.getFields();
        for (        PsiField f : fields) {
          if (f.getName().equals(field.getName())) {
            found=true;
            break;
          }
        }
        if (!found) {
          if (fieldAnchor != null) {
            Boolean insertBefore=fieldAnchor.getSecond();
            PsiField inField=fieldAnchor.getFirst();
            if (insertBefore.booleanValue()) {
              targetClass.addBefore(field,inField);
            }
 else {
              targetClass.addAfter(field,inField);
            }
          }
 else {
            targetClass.add(field);
          }
        }
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
);
}
