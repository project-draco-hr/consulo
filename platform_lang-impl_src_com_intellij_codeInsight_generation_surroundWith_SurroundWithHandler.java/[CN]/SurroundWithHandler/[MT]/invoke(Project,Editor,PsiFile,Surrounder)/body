{
  if (!editor.getSelectionModel().hasSelection()) {
    editor.getSelectionModel().selectLineAtCaret();
  }
  int startOffset=editor.getSelectionModel().getSelectionStart();
  int endOffset=editor.getSelectionModel().getSelectionEnd();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiElement element1=file.findElementAt(startOffset);
  PsiElement element2=file.findElementAt(endOffset - 1);
  if (element1 == null || element2 == null)   return;
  TextRange textRange=new TextRange(startOffset,endOffset);
  for (  SurroundWithRangeAdjuster adjuster : Extensions.getExtensions(SurroundWithRangeAdjuster.EP_NAME)) {
    textRange=adjuster.adjustSurroundWithRange(file,textRange);
    if (textRange == null)     return;
  }
  startOffset=textRange.getStartOffset();
  endOffset=textRange.getEndOffset();
  element1=file.findElementAt(startOffset);
  final Language baseLanguage=file.getViewProvider().getBaseLanguage();
  final Language l=element1.getParent().getLanguage();
  List<SurroundDescriptor> surroundDescriptors=new ArrayList<SurroundDescriptor>();
  surroundDescriptors.addAll(LanguageSurrounders.INSTANCE.allForLanguage(l));
  if (l != baseLanguage)   surroundDescriptors.addAll(LanguageSurrounders.INSTANCE.allForLanguage(baseLanguage));
  for (  SurroundDescriptor descriptor : surroundDescriptors) {
    final PsiElement[] elements=descriptor.getElementsToSurround(file,startOffset,endOffset);
    if (elements.length > 0) {
      if (surrounder == null) {
        PopupActionChooser popupActionChooser=new PopupActionChooser(CHOOSER_TITLE);
        popupActionChooser.invoke(project,editor,file,descriptor.getSurrounders(),elements);
        if (popupActionChooser.isHasEnabledSurrounders())         return;
      }
 else {
        doSurround(project,editor,surrounder,elements);
        return;
      }
    }
  }
  if (surrounder == null) {
    PopupActionChooser popupActionChooser=new PopupActionChooser(CHOOSER_TITLE);
    popupActionChooser.invoke(project,editor,file,new Surrounder[0],new PsiElement[0]);
  }
}
