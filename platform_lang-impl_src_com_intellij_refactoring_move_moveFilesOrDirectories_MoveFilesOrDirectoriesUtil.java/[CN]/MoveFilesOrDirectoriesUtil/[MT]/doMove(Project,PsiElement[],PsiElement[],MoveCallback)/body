{
  for (  PsiElement element : elements) {
    if (!(element instanceof PsiFile) && !(element instanceof PsiDirectory)) {
      throw new IllegalArgumentException("unexpected element type: " + element);
    }
  }
  final PsiDirectory targetDirectory=resolveToDirectory(project,targetElement[0]);
  if (targetElement[0] != null && targetDirectory == null)   return;
  final PsiDirectory initialTargetDirectory=getInitialTargetDirectory(targetDirectory,elements);
  final MoveFilesOrDirectoriesDialog.Callback doRun=new MoveFilesOrDirectoriesDialog.Callback(){
    public void run(    final MoveFilesOrDirectoriesDialog moveDialog){
      final PsiDirectory targetDirectory=moveDialog.getTargetDirectory();
      LOG.assertTrue(targetDirectory != null);
      targetElement[0]=targetDirectory;
      PsiManager manager=PsiManager.getInstance(project);
      try {
        for (        PsiElement psiElement : elements) {
          manager.checkMove(psiElement,targetDirectory);
        }
        new MoveFilesOrDirectoriesProcessor(project,elements,targetDirectory,false,false,moveCallback,new Runnable(){
          public void run(){
            moveDialog.close(DialogWrapper.CANCEL_EXIT_CODE);
          }
        }
).run();
      }
 catch (      IncorrectOperationException e) {
        CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("error.title"),e.getMessage(),"refactoring.moveFile",project);
      }
    }
  }
;
  final MoveFilesOrDirectoriesDialog moveDialog=new MoveFilesOrDirectoriesDialog(project,doRun);
  moveDialog.setData(elements,initialTargetDirectory,"refactoring.moveFile");
  moveDialog.show();
}
