{
  if (adjustElements == null) {
    for (    PsiElement element : elements) {
      if (!(element instanceof PsiFile) && !(element instanceof PsiDirectory)) {
        throw new IllegalArgumentException("unexpected element type: " + element);
      }
    }
  }
  final PsiDirectory targetDirectory=resolveToDirectory(project,targetElement[0]);
  if (targetElement[0] != null && targetDirectory == null)   return;
  final PsiDirectory initialTargetDirectory=getInitialTargetDirectory(targetDirectory,elements);
  final MoveFilesOrDirectoriesDialog.Callback doRun=new MoveFilesOrDirectoriesDialog.Callback(){
    public void run(    final MoveFilesOrDirectoriesDialog moveDialog){
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        @Override public void run(){
          final PsiDirectory targetDirectory=moveDialog != null ? moveDialog.getTargetDirectory() : initialTargetDirectory;
          LOG.assertTrue(targetDirectory != null);
          PsiElement[] newElements=adjustElements != null ? adjustElements.fun(elements) : elements;
          targetElement[0]=targetDirectory;
          PsiManager manager=PsiManager.getInstance(project);
          try {
            for (            PsiElement psiElement : newElements) {
              manager.checkMove(psiElement,targetDirectory);
            }
            new MoveFilesOrDirectoriesProcessor(project,newElements,targetDirectory,false,false,moveCallback,new Runnable(){
              public void run(){
                if (moveDialog != null)                 moveDialog.close(DialogWrapper.CANCEL_EXIT_CODE);
              }
            }
).run();
          }
 catch (          IncorrectOperationException e) {
            CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("error.title"),e.getMessage(),"refactoring.moveFile",project);
          }
        }
      }
,MoveHandler.REFACTORING_NAME,null);
    }
  }
;
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    doRun.run(null);
  }
 else {
    final MoveFilesOrDirectoriesDialog moveDialog=new MoveFilesOrDirectoriesDialog(project,doRun);
    moveDialog.setData(elements,initialTargetDirectory,"refactoring.moveFile");
    moveDialog.show();
  }
}
