{
  if (document instanceof DocumentWindow) {
    document=((DocumentWindow)document).getDelegate();
  }
  if (!(document instanceof DocumentImpl)) {
    return;
  }
  Component focusOwner=IdeFocusManager.getGlobalInstance().getFocusOwner();
  DataContext dataContext=DataManager.getInstance().getDataContext(focusOwner);
  boolean isDisposeInProgress=ApplicationManager.getApplication().isDisposeInProgress();
  Editor activeEditor=isDisposeInProgress ? null : PlatformDataKeys.EDITOR.getData(dataContext);
  boolean isVirtualSpaceEnabled=activeEditor == null || activeEditor.getSettings().isVirtualSpace();
  int caretLine=activeEditor == null ? -1 : activeEditor.getCaretModel().getLogicalPosition().line;
  final EditorSettingsExternalizable settings=EditorSettingsExternalizable.getInstance();
  if (settings == null)   return;
  String stripTrailingSpaces=settings.getStripTrailingSpaces();
  final boolean doStrip=!stripTrailingSpaces.equals(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_NONE);
  final boolean inChangedLinesOnly=!stripTrailingSpaces.equals(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_WHOLE);
  if (!inChangedLinesOnly || !doStrip || isVirtualSpaceEnabled)   caretLine=-1;
  ((DocumentImpl)document).clearLineModificationFlagsExcept(caretLine);
}
