{
  if (!document.isWritable())   return;
  final EditorSettingsExternalizable settings=EditorSettingsExternalizable.getInstance();
  if (settings == null)   return;
  final boolean doStrip=!settings.getStripTrailingSpaces().equals(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_NONE);
  final boolean ensureEOL=settings.isEnsureNewLineAtEOF();
  if (!doStrip && !ensureEOL)   return;
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
        public void run(){
          if (doStrip) {
            final boolean inChangedLinesOnly=!settings.getStripTrailingSpaces().equals(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_WHOLE);
            DocumentEx ex=(DocumentEx)document;
            boolean success=ex.stripTrailingSpaces(inChangedLinesOnly);
            if (!success) {
              myDocumentsToStripLater.add(ex);
            }
          }
          if (ensureEOL) {
            final int lines=document.getLineCount();
            if (lines > 0) {
              int start=document.getLineStartOffset(lines - 1);
              int end=document.getLineEndOffset(lines - 1);
              if (start != end) {
                CharSequence content=document.getCharsSequence();
                if (CharArrayUtil.containsOnlyWhiteSpaces(content.subSequence(start,end))) {
                  document.deleteString(start,end);
                }
 else {
                  document.insertString(end,"\n");
                }
              }
            }
          }
        }
      }
);
    }
  }
);
}
