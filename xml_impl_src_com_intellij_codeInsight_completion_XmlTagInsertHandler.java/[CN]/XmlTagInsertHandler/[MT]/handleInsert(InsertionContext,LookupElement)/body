{
  Project project=context.getProject();
  Editor editor=context.getEditor();
  final int offset=editor.getCaretModel().getOffset();
  editor.getDocument().insertString(offset," ");
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  PsiElement current=context.getFile().findElementAt(context.getStartOffset());
  editor.getDocument().deleteString(offset,offset + 1);
  final XmlTag tag=PsiTreeUtil.getContextOfType(current,XmlTag.class,true);
  if (tag == null)   return;
  context.setAddCompletionChar(false);
  final XmlElementDescriptor descriptor=tag.getDescriptor();
  if (XmlUtil.getTokenOfType(tag,XmlTokenType.XML_TAG_END) == null && XmlUtil.getTokenOfType(tag,XmlTokenType.XML_EMPTY_ELEMENT_END) == null) {
    Template t=TemplateManager.getInstance(project).getActiveTemplate(editor);
    if (t == null && descriptor != null) {
      insertIncompleteTag(context.getCompletionChar(),editor,project,descriptor,tag);
    }
  }
 else   if (context.getCompletionChar() == Lookup.REPLACE_SELECT_CHAR) {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    int caretOffset=editor.getCaretModel().getOffset();
    PsiElement otherTag=PsiTreeUtil.getParentOfType(context.getFile().findElementAt(caretOffset),XmlTag.class);
    PsiElement endTagStart=XmlUtil.getTokenOfType(otherTag,XmlTokenType.XML_END_TAG_START);
    if (endTagStart != null) {
      PsiElement sibling=endTagStart.getNextSibling();
      if (sibling.getNode().getElementType() == XmlTokenType.XML_NAME) {
        int sOffset=sibling.getTextRange().getStartOffset();
        int eOffset=sibling.getTextRange().getEndOffset();
        editor.getDocument().deleteString(sOffset,eOffset);
        editor.getDocument().insertString(sOffset,((XmlTag)otherTag).getName());
      }
    }
    editor.getCaretModel().moveToOffset(caretOffset + 1);
    editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    editor.getSelectionModel().removeSelection();
  }
  if (context.getCompletionChar() == ' ' && TemplateManager.getInstance(project).getActiveTemplate(editor) != null) {
    return;
  }
  final TailType tailType=LookupItem.handleCompletionChar(editor,item,context.getCompletionChar());
  tailType.processTail(editor,editor.getCaretModel().getOffset());
}
