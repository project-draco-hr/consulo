{
  final XmlAttribute xmlns=getXmlnsDeclaration(element);
  if (xmlns == null)   return;
  SchemaPrefixReference prefixRef=null;
  for (  PsiReference ref : xmlns.getReferences()) {
    if (ref instanceof SchemaPrefixReference) {
      prefixRef=(SchemaPrefixReference)ref;
      break;
    }
  }
  if (prefixRef == null)   return;
  final SchemaPrefix prefix=prefixRef.resolve();
  final String ns=prefixRef.getNamespacePrefix();
  final ArrayList<XmlTag> tags=new ArrayList<XmlTag>();
  final ArrayList<XmlAttribute> attrs=new ArrayList<XmlAttribute>();
  xmlns.getParent().accept(new XmlRecursiveElementVisitor(){
    @Override public void visitXmlTag(    XmlTag tag){
      if (ns.equals(tag.getNamespacePrefix())) {
        tags.add(tag);
      }
      super.visitXmlTag(tag);
    }
    @Override public void visitXmlAttributeValue(    XmlAttributeValue value){
      if (value.getValue().startsWith(ns + ":")) {
        for (        PsiReference ref : value.getReferences()) {
          if (ref instanceof SchemaPrefixReference && ref.isReferenceTo(prefix)) {
            attrs.add((XmlAttribute)value.getParent());
          }
        }
      }
    }
  }
);
  new WriteCommandAction(project,"Convert namespace prefix to default",xmlns.getContainingFile()){
    @Override protected void run(    Result result) throws Throwable {
      final int index=ns.length() + 1;
      for (      XmlTag tag : tags) {
        final String s=tag.getName().substring(index);
        if (s.length() > 0) {
          tag.setName(s);
        }
      }
      for (      XmlAttribute attr : attrs) {
        attr.setValue(attr.getValue().substring(index));
      }
      xmlns.setName("xmlns");
    }
  }
.execute();
}
