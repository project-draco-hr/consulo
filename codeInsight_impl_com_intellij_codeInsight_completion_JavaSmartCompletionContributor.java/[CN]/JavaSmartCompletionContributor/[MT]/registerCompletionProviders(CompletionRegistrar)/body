{
  registrar.extend(CompletionType.SMART,psiElement()).withId(JavaCompletionContributor.JAVA_LEGACY).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      final Set<LookupItem> set=new LinkedHashSet<LookupItem>();
      final PsiElement identifierCopy=parameters.getPosition();
      final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
      final CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      PsiFile file=parameters.getOriginalFile();
      final PsiReference ref=identifierCopy.getContainingFile().findReferenceAt(identifierCopy.getTextRange().getStartOffset());
      if (ref != null) {
        SMART_DATA.completeReference(ref,set,identifierCopy,result.getPrefixMatcher(),file,context.getStartOffset());
      }
      SMART_DATA.addKeywordVariants(keywordVariants,identifierCopy,file);
      SMART_DATA.completeKeywordsBySet(set,keywordVariants,identifierCopy,result.getPrefixMatcher(),file);
      JavaCompletionUtil.highlightMembersOfContainer(set);
      final PsiExpression expr=PsiTreeUtil.getContextOfType(parameters.getPosition(),PsiExpression.class,true);
      final ExpectedTypeInfo[] expectedInfos=expr != null ? ExpectedTypesProvider.getInstance(context.project).getExpectedTypes(expr,true) : null;
      final Set<PsiClass> classes=expectedInfos != null && expectedInfos.length > 0 ? getFirstClasses(expectedInfos) : Collections.<PsiClass>emptySet();
      final DefaultInsertHandler defaultHandler=new DefaultInsertHandler();
      for (      final LookupItem item : set) {
        final Object o=item.getObject();
        if (classes.contains(o) && !shouldPrefer((PsiClass)o)) {
          item.setAttribute(LookupItem.DONT_PREFER,"");
        }
        InsertHandler oldHandler=item.getInsertHandler();
        if (oldHandler == null) {
          oldHandler=defaultHandler;
        }
        item.setAttribute(LookupItem.INSERT_HANDLER_ATTR,new AnalyzingInsertHandler(o,expectedInfos,oldHandler));
      }
      result.addAllElements(set);
    }
  }
);
}
