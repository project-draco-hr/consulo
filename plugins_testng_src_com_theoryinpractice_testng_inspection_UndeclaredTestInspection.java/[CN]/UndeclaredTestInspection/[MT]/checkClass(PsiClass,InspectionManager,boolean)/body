{
  if (TestNGUtil.hasTest(aClass) && PsiClassUtil.isRunnableClass(aClass,true)) {
    final Project project=aClass.getProject();
    final String qName=aClass.getQualifiedName();
    if (qName == null)     return null;
    final String packageQName=((PsiJavaFile)aClass.getContainingFile()).getPackageName();
    final String packageName=StringUtil.getShortName(packageQName);
    final String[] names;
    if (packageQName.length() > 0) {
      final String pName=packageName.length() > 0 ? packageName : packageQName;
      names=new String[]{qName,pName};
    }
 else {
      names=new String[]{qName};
    }
    for (    final String name : names) {
      final boolean[] found=new boolean[]{false};
      PsiManager.getInstance(project).getSearchHelper().processUsagesInNonJavaFiles(name,new PsiNonJavaFileReferenceProcessor(){
        public boolean process(        final PsiFile file,        final int startOffset,        final int endOffset){
          if (file.findReferenceAt(startOffset) != null) {
            if (packageQName.endsWith(name)) {
              final XmlTag tag=PsiTreeUtil.getParentOfType(file.findElementAt(startOffset),XmlTag.class);
              if (tag == null || !tag.getName().equals("package")) {
                return true;
              }
              final XmlAttribute attribute=tag.getAttribute("name");
              if (attribute == null)               return true;
              final String value=attribute.getValue();
              if (!value.equals(StringUtil.getQualifiedName(packageQName,"*")))               return true;
            }
            found[0]=true;
            return false;
          }
          return true;
        }
      }
,new TestNGSearchScope());
      if (found[0])       return null;
    }
    final PsiIdentifier nameIdentifier=aClass.getNameIdentifier();
    LOG.assertTrue(nameIdentifier != null);
    return new ProblemDescriptor[]{manager.createProblemDescriptor(nameIdentifier,"Undeclared test \'" + aClass.getName() + "\'",isOnTheFly,new LocalQuickFix[]{new RegisterClassFix(aClass),new CreateTestngFix()},ProblemHighlightType.GENERIC_ERROR_OR_WARNING)};
  }
  return null;
}
