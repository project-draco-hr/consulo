{
  if (!GitUtil.isGitRoot(new File(root.getPath())))   throw new VcsException("Path " + root.getPath() + " is not git repository root");
  final GitLineHandler h=new GitLineHandler(project,root,GitCommand.LOG);
  h.setSilent(true);
  h.addParameters("HEAD","--branches","--remotes","--tags","--pretty=format:%H%x20%ct%x0A","--date-order","--reverse","--encoding=UTF-8","--full-history","--sparse");
  h.endOptions();
  final OutputStream[] stream=new OutputStream[1];
  try {
    stream[0]=new BufferedOutputStream(new FileOutputStream(outFilePath,false));
    final Semaphore semaphore=new Semaphore();
    final VcsException[] ioExceptions=new VcsException[1];
    h.addLineListener(new GitLineHandlerListener(){
      @Override public void onLineAvailable(      String line,      Key outputType){
        if (line.length() == 0)         return;
        try {
          GitCommitsSequentialIndex.parseRecord(line);
          stream[0].write((line + '\n').getBytes("UTF-8"));
        }
 catch (        IOException e) {
          ioExceptions[0]=new VcsException(e);
          h.cancel();
          semaphore.up();
        }
catch (        ProcessCanceledException e) {
          h.cancel();
          semaphore.up();
        }
catch (        VcsException e) {
          ioExceptions[0]=e;
          h.cancel();
          semaphore.up();
        }
      }
      @Override public void processTerminated(      int exitCode){
        semaphore.up();
      }
      @Override public void startFailed(      Throwable exception){
        semaphore.up();
      }
    }
);
    semaphore.down();
    h.start();
    semaphore.waitFor();
    if (ioExceptions[0] != null) {
      throw ioExceptions[0];
    }
  }
 catch (  FileNotFoundException e) {
    throw new VcsException(e);
  }
 finally {
    try {
      if (stream[0] != null) {
        stream[0].close();
      }
    }
 catch (    IOException e) {
      throw new VcsException(e);
    }
  }
  File file=new File(outFilePath);
  if (!file.exists() || file.length() == 0)   throw new VcsException("Short repository history not loaded");
}
