{
  final int length=whileStatement.getText().length();
  final StringBuffer out=new StringBuffer(length);
  final PsiStatement body=whileStatement.getBody();
  final PsiStatement firstStatement=getFirstStatement(body);
  final String contentVariableName;
  final String finalString;
  final PsiStatement statementToSkip;
  final PsiStatement initialization=getPreviousStatement(whileStatement);
  final PsiDeclarationStatement declaration=(PsiDeclarationStatement)initialization;
  final PsiLocalVariable iterator=(PsiLocalVariable)declaration.getDeclaredElements()[0];
  final PsiMethodCallExpression initializer=(PsiMethodCallExpression)iterator.getInitializer();
  final PsiExpression collection=initializer.getMethodExpression().getQualifierExpression();
  final PsiClassType type=(PsiClassType)collection.getType();
  final PsiType[] parameters=type.getParameters();
  final String contentTypeString;
  if (parameters.length == 1) {
    final PsiType parameterType=parameters[0];
    if (parameterType instanceof PsiWildcardType) {
      final PsiWildcardType wildcardType=(PsiWildcardType)parameterType;
      final PsiType bound=wildcardType.getBound();
      if (bound == null) {
        contentTypeString="Object";
      }
 else {
        contentTypeString=bound.getPresentableText();
      }
    }
 else {
      contentTypeString=parameterType.getPresentableText();
    }
  }
 else {
    contentTypeString="Object";
  }
  final PsiManager psiManager=PsiManager.getInstance(project);
  final PsiElementFactory elementFactory=psiManager.getElementFactory();
  PsiType contentType;
  try {
    contentType=elementFactory.createTypeFromText(contentTypeString,whileStatement);
  }
 catch (  IncorrectOperationException e) {
    contentType=null;
  }
  final String iteratorName=iterator.getName();
  final boolean isDeclaration=isIteratorNextDeclaration(firstStatement,iteratorName,contentTypeString);
  if (isDeclaration) {
    final PsiDeclarationStatement decl=(PsiDeclarationStatement)firstStatement;
    final PsiElement[] declaredElements=decl.getDeclaredElements();
    final PsiLocalVariable localVar=(PsiLocalVariable)declaredElements[0];
    contentVariableName=localVar.getName();
    statementToSkip=decl;
    if (localVar.hasModifierProperty(PsiModifier.FINAL)) {
      finalString="final ";
    }
 else {
      finalString="";
    }
  }
 else {
    if (collection instanceof PsiReferenceExpression) {
      final String collectionName=((PsiReferenceExpression)collection).getReferenceName();
      contentVariableName=createNewVarName(project,whileStatement,contentType,collectionName);
    }
 else {
      contentVariableName=createNewVarName(project,whileStatement,contentType,null);
    }
    if (CodeStyleSettingsManager.getSettings(project).GENERATE_FINAL_LOCALS) {
      finalString="final ";
    }
 else {
      finalString="";
    }
    statementToSkip=null;
  }
  out.append("for(" + finalString + contentTypeString+ ' '+ contentVariableName+ ": "+ collection.getText()+ ')');
  replaceIteratorNext(body,contentVariableName,iteratorName,statementToSkip,out,contentTypeString);
  return out.toString();
}
