{
  if (scope instanceof PsiExpression) {
    final PsiExpression expression=(PsiExpression)scope;
    if (!(scope instanceof PsiReferenceExpression) || !((PsiReferenceExpression)scope).isReferenceTo(refMember)) {
      final Pair<PsiMember,PsiClass> pair=getMemberAndClassReferencedByThis(expression);
      if (pair != null) {
        PsiClass refClass=pair.getSecond();
        PsiMember member=pair.getFirst();
        if (refClass != null && !PsiTreeUtil.isAncestor(refMember,member,false)) {
          addReferencedMember(map,refClass,member);
        }
      }
      if (expression instanceof PsiThisExpression) {
        final PsiJavaCodeReferenceElement thisQualifier=((PsiThisExpression)expression).getQualifier();
        PsiClass thisClass=thisQualifier == null ? PsiTreeUtil.getParentOfType(expression,PsiClass.class,true) : ((PsiClass)thisQualifier.resolve());
        if (thisClass != null && !PsiTreeUtil.isAncestor(refMember,thisClass,false)) {
          addReferencedMember(map,thisClass,null);
        }
      }
    }
  }
  final PsiElement[] children=scope.getChildren();
  for (  PsiElement child : children) {
    getThisClassesToMembers(child,map,refMember);
  }
}
