{
  final MockVirtualFile file=new MockVirtualFile("test.txt","test\rtest"){
    @Override public void refresh(    boolean asynchronous,    boolean recursive,    Runnable postRunnable){
      long oldStamp=getModificationStamp();
      setModificationStamp(LocalTimeCounter.currentTime());
      myDocumentManager.contentsChanged(new VirtualFileEvent(null,this,null,oldStamp,getModificationStamp()));
    }
  }
;
  Document document=myDocumentManager.getDocument(file);
  assertNotNull(file.toString(),document);
  document.insertString(0,"zzz");
  file.setContent(null,"xxx",false);
  myDocumentManager.myReloadFromDisk=Boolean.TRUE;
  try {
    file.setActualTimeStamp(file.getTimeStamp() + 1);
    myDocumentManager.saveAllDocuments();
    long fileStamp=file.getModificationStamp();
    assertEquals("xxx",document.getText());
    assertEquals(file.getModificationStamp(),document.getModificationStamp());
    assertEquals(file.getModificationStamp(),fileStamp);
    assertEquals(0,myDocumentManager.getUnsavedDocuments().length);
  }
  finally {
    myDocumentManager.myReloadFromDisk=null;
  }
}
