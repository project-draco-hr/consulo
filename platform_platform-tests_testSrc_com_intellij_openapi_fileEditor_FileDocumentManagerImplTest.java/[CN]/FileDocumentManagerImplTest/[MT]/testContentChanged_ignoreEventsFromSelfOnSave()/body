{
  final VirtualFile file=new MockVirtualFile("test.txt","test\rtest"){
    @NotNull @Override public OutputStream getOutputStream(    final Object requestor,    final long newModificationStamp,    long newTimeStamp) throws IOException {
      final VirtualFile self=this;
      return new ByteArrayOutputStream(){
        @Override public void close() throws IOException {
          super.close();
          long oldStamp=getModificationStamp();
          setModificationStamp(newModificationStamp);
          setText(toString());
          myDocumentManager.contentsChanged(new VirtualFileEvent(requestor,self,null,oldStamp,getModificationStamp()));
        }
      }
;
    }
  }
;
  final Document document=myDocumentManager.getDocument(file);
  assertNotNull(file.toString(),document);
  WriteCommandAction.runWriteCommandAction(myProject,new Runnable(){
    @Override public void run(){
      document.insertString(0,"xxx");
    }
  }
);
  final long stamp=document.getModificationStamp();
  myDocumentManager.saveAllDocuments();
  assertEquals(stamp,document.getModificationStamp());
}
