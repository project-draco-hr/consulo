{
  final VirtualFile file=new MockVirtualFile("test.txt","test\rtest"){
    public Writer getWriter(    final Object requestor,    final long newModificationStamp){
      final VirtualFile self=this;
      return new CharArrayWriter(){
        @Override public void close(){
          super.close();
          long oldStamp=getModificationStamp();
          setModificationStamp(newModificationStamp);
          setText(toString());
          myDocumentManager.contentsChanged(new VirtualFileEvent(requestor,self,null,oldStamp,getModificationStamp()));
        }
      }
;
    }
  }
;
  Document document=myDocumentManager.getDocument(file);
  document.insertString(0,"xxx");
  final long stamp=document.getModificationStamp();
  myDocumentManager.saveAllDocuments();
  assertEquals(stamp,document.getModificationStamp());
}
