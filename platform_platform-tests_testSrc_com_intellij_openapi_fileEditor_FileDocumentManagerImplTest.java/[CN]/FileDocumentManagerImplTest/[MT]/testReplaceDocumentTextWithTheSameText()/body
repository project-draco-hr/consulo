{
  final VirtualFile file=createFile();
  final DocumentEx document=(DocumentEx)myDocumentManager.getDocument(file);
  final String newText="test text";
  assertNotNull(file.toString(),document);
  WriteCommandAction.runWriteCommandAction(myProject,new Runnable(){
    @Override public void run(){
      document.replaceString(0,document.getTextLength(),newText);
      assertTrue(myDocumentManager.isDocumentUnsaved(document));
      myDocumentManager.saveDocument(document);
      getProject().getMessageBus().connect(getTestRootDisposable()).subscribe(AppTopics.FILE_DOCUMENT_SYNC,new FileDocumentManagerAdapter(){
        @Override public void beforeDocumentSaving(        @NotNull Document documentToSave){
          assertNotSame(document,documentToSave);
        }
      }
);
      final long modificationStamp=document.getModificationStamp();
      document.replaceString(0,document.getTextLength(),newText);
      if (myDocumentManager.isDocumentUnsaved(document)) {
        assertTrue(document.getModificationStamp() > modificationStamp);
      }
 else {
        assertEquals(modificationStamp,document.getModificationStamp());
      }
    }
  }
);
}
