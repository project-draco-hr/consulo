{
  final MockVirtualFile file=new MockVirtualFile("test.txt","test"){
    @Override public void refresh(    boolean asynchronous,    boolean recursive,    Runnable postRunnable){
      long oldStamp=getModificationStamp();
      setModificationStamp(LocalTimeCounter.currentTime());
      myDocumentManager.contentsChanged(new VirtualFileEvent(null,this,null,oldStamp,getModificationStamp()));
    }
  }
;
  myDocumentManager.myReloadFromDisk=Boolean.FALSE;
  try {
    Document document=myDocumentManager.getDocument(file);
    assertNotNull(file.toString(),document);
    document.insertString(0,"zzz");
    long documentStamp=document.getModificationStamp();
    file.setContent(null,"xxx",false);
    file.setActualTimeStamp(file.getTimeStamp() + 1);
    myDocumentManager.saveAllDocuments();
    assertEquals("zzztest",document.getText());
    assertEquals(file.getModificationStamp(),document.getModificationStamp());
    assertTrue(Arrays.equals("zzztest".getBytes(),file.contentsToByteArray()));
    assertEquals(documentStamp,document.getModificationStamp());
  }
  finally {
    myDocumentManager.myReloadFromDisk=null;
  }
}
