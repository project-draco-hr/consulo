{
  if (!isStripTrailingSpacesEnabled) {
    return true;
  }
  Editor editor=ContainerUtil.find(EditorFactory.getInstance().getEditors(this),new Condition<Editor>(){
    @Override public boolean value(    Editor editor){
      return ((EditorEx)editor).isCaretActive();
    }
  }
);
  boolean isVirtualSpaceEnabled=editor == null || editor.getSettings().isVirtualSpace();
  VisualPosition visualCaret=editor == null ? null : editor.getCaretModel().getVisualPosition();
  int caretLine=editor == null ? -1 : editor.getCaretModel().getLogicalPosition().line;
  int caretOffset=editor == null ? -1 : editor.getCaretModel().getOffset();
  boolean markAsNeedsStrippingLater=false;
  CharSequence text=myText.getCharArray();
  for (int line=0; line < myLineSet.getLineCount(); line++) {
    if (inChangedLinesOnly && !myLineSet.isModified(line))     continue;
    int whiteSpaceStart=-1;
    final int lineEnd=myLineSet.getLineEnd(line) - myLineSet.getSeparatorLength(line);
    int lineStart=myLineSet.getLineStart(line);
    for (int offset=lineEnd - 1; offset >= lineStart; offset--) {
      char c=text.charAt(offset);
      if (c != ' ' && c != '\t') {
        break;
      }
      whiteSpaceStart=offset;
    }
    if (whiteSpaceStart == -1)     continue;
    if (!isVirtualSpaceEnabled && caretLine == line && whiteSpaceStart < caretOffset) {
      markAsNeedsStrippingLater=true;
    }
 else {
      final int finalStart=whiteSpaceStart;
      ApplicationManager.getApplication().runWriteAction(new DocumentRunnable(this,editor == null ? null : editor.getProject()){
        public void run(){
          CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
            public void run(){
              deleteString(finalStart,lineEnd);
            }
          }
);
        }
      }
);
      text=myText.getCharArray();
    }
  }
  if (!ShutDownTracker.isShutdownHookRunning() && editor != null) {
    editor.getCaretModel().moveToVisualPosition(visualCaret);
  }
  return !markAsNeedsStrippingLater;
}
