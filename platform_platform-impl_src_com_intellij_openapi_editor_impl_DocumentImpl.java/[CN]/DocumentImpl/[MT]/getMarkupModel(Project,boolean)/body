{
  if (project == null) {
    MarkupModelEx markupModel=myMarkupModel;
    if (create && markupModel == null) {
synchronized (lock) {
        markupModel=myMarkupModel;
        if (markupModel == null) {
          myMarkupModel=markupModel=new MarkupModelImpl(this);
        }
      }
    }
    return markupModel;
  }
  final DocumentMarkupModelManager documentMarkupModelManager=project.isDisposed() ? null : DocumentMarkupModelManager.getInstance(project);
  if (documentMarkupModelManager == null || documentMarkupModelManager.isDisposed() || project.isDisposed()) {
    return new EmptyMarkupModel(this);
  }
  MarkupModelImpl model=myProjectToMarkupModelMap.get(project);
  if (create && model == null) {
synchronized (lock) {
      model=myProjectToMarkupModelMap.get(project);
      if (model == null) {
        model=new MarkupModelImpl(this);
        myProjectToMarkupModelMap.put(project,model);
        documentMarkupModelManager.registerDocument(this);
      }
    }
  }
  return model;
}
