{
  if (project == null) {
    MarkupModelEx markupModel=myMarkupModel;
    if (create && markupModel == null) {
synchronized (lock) {
        markupModel=myMarkupModel;
        if (markupModel == null) {
          myMarkupModel=markupModel=new MarkupModelImpl(this);
        }
      }
    }
    return markupModel;
  }
  if (project.isDisposed()) {
    return new EmptyMarkupModel(this);
  }
  MarkupModelImpl model=myProjectToMarkupModelMap.get(project);
  if (create && model == null) {
synchronized (lock) {
      model=myProjectToMarkupModelMap.get(project);
      if (model == null) {
        model=new MarkupModelImpl(this);
        myProjectToMarkupModelMap.put(project,model);
        Disposer.register(project,new Disposable(){
          @Override public void dispose(){
            MarkupModelImpl removed=myProjectToMarkupModelMap.remove(project);
            if (removed != null) {
              removed.dispose();
            }
          }
        }
);
      }
    }
  }
  return model;
}
