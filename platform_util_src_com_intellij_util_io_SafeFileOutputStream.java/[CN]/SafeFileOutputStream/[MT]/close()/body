{
  try {
    myBackDoorStream.close();
  }
 catch (  IOException e) {
    LOG.warn(e);
    FileUtil.delete(backdoorFile());
    throw e;
  }
  if (failed) {
    throw new IOException("Failed to save to backup file (" + backdoorFile() + "). Original file ("+ myTargetFile+ ") left unchanged.");
  }
  final int permissions=myPreserveAttributes ? FileSystemUtil.getPermissions(myTargetFile) : -1;
  if (!FileUtil.delete(myTargetFile) && myTargetFile.exists()) {
    throw new IOException("Failed to save to " + myTargetFile + ". The file left unchanged. Attempt result stored to "+ backdoorFile());
  }
  FileUtil.rename(backdoorFile(),myTargetFile);
  if (permissions != -1) {
    FileSystemUtil.setPermissions(myTargetFile,permissions);
  }
}
