{
  try {
    myBackDoorStream.close();
  }
 catch (  IOException e) {
    LOG.warn(e);
    FileUtil.delete(myBackDoorFile);
    throw e;
  }
  if (failed) {
    throw new IOException(CommonBundle.message("safe.write.failed",myTargetFile,myBackDoorFile.getName()));
  }
  final File oldFile=new File(myTargetFile.getParent(),myTargetFile.getName() + EXTENSION_OLD);
  try {
    FileUtil.rename(myTargetFile,oldFile);
  }
 catch (  IOException e) {
    LOG.warn(e);
    throw new IOException(CommonBundle.message("safe.write.rename.original",myTargetFile,myBackDoorFile.getName()));
  }
  try {
    FileUtil.rename(myBackDoorFile,myTargetFile);
  }
 catch (  IOException e) {
    LOG.warn(e);
    throw new IOException(CommonBundle.message("safe.write.rename.backup",myTargetFile,oldFile.getName(),myBackDoorFile.getName()));
  }
  if (myPreserveAttributes) {
    FileSystemUtil.clonePermissions(oldFile.getPath(),myTargetFile.getPath());
  }
  if (!FileUtil.delete(oldFile)) {
    throw new IOException(CommonBundle.message("safe.write.drop.temp",oldFile));
  }
}
