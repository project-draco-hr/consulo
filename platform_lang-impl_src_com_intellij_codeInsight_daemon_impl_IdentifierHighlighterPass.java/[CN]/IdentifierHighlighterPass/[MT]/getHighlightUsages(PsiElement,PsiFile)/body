{
  Collection<TextRange> readRanges=new ArrayList<TextRange>();
  Collection<TextRange> writeRanges=new ArrayList<TextRange>();
  final ReadWriteAccessDetector detector=ReadWriteAccessDetector.findDetector(target);
  final FindUsagesManager findUsagesManager=((FindManagerImpl)FindManager.getInstance(target.getProject())).getFindUsagesManager();
  final FindUsagesHandler findUsagesHandler=findUsagesManager.getFindUsagesHandler(target,true);
  final LocalSearchScope scope=new LocalSearchScope(psiFile);
  Collection<PsiReference> refs=findUsagesHandler != null ? findUsagesHandler.findReferencesToHighlight(target,scope) : ReferencesSearch.search(target,scope).findAll();
  for (  PsiReference psiReference : refs) {
    final List<TextRange> textRanges=HighlightUsagesHandler.getRangesToHighlight(psiReference);
    if (detector == null || detector.getReferenceAccess(target,psiReference) == ReadWriteAccessDetector.Access.Read) {
      readRanges.addAll(textRanges);
    }
 else {
      writeRanges.addAll(textRanges);
    }
  }
  final TextRange declRange=HighlightUsagesHandler.getNameIdentifierRange(psiFile,target);
  if (declRange != null) {
    if (detector != null && detector.isDeclarationWriteAccess(target)) {
      writeRanges.add(declRange);
    }
 else {
      readRanges.add(declRange);
    }
  }
  return Couple.of(readRanges,writeRanges);
}
