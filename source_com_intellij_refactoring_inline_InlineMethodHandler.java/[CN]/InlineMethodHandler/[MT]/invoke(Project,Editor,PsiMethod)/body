{
  if (method.getBody() == null) {
    String message;
    if (method.hasModifierProperty(PsiModifier.ABSTRACT)) {
      message=REFACTORING_NAME + " refactoring cannot be applied to abstract methods";
    }
 else {
      message=REFACTORING_NAME + " refactoring cannot be applied: no sources attached";
    }
    RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.INLINE_METHOD,project);
    return;
  }
  if (InlineMethodProcessor.checkBadReturns(method)) {
    String message=REFACTORING_NAME + " refactoring is not supported when return statement interrupts the execution flow";
    RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.INLINE_METHOD,project);
    return;
  }
  if (checkRecursive(method)) {
    String message=REFACTORING_NAME + " refactoring is not supported for recursive methods";
    RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.INLINE_METHOD,project);
    return;
  }
  PsiReference reference=editor != null ? TargetElementUtil.findReference(editor,editor.getCaretModel().getOffset()) : null;
  if (method.isConstructor()) {
    if (method.isVarArgs()) {
      String message=REFACTORING_NAME + " refactoring cannot be applied to vararg constructors";
      RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.INLINE_METHOD,project);
      return;
    }
    if (!checkChainingConstructor(method)) {
      String message=REFACTORING_NAME + " refactoring cannot be applied to inline non-chaining constructors";
      RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.INLINE_METHOD,project);
      return;
    }
    if (reference != null) {
      PsiCall constructorCall=RefactoringUtil.getEnclosingConstructorCall((PsiJavaCodeReferenceElement)reference.getElement());
      if (constructorCall == null || !method.equals(constructorCall.resolveMethod()))       reference=null;
    }
  }
 else {
    if (reference != null && !method.getManager().areElementsEquivalent(method,reference.resolve())) {
      reference=null;
    }
  }
  final boolean invokedOnReference=reference != null;
  if (!invokedOnReference) {
    final VirtualFile vFile=method.getContainingFile().getVirtualFile();
    ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(new VirtualFile[]{vFile});
  }
  PsiJavaCodeReferenceElement refElement=reference != null ? (PsiJavaCodeReferenceElement)reference.getElement() : null;
  InlineMethodDialog dialog=new InlineMethodDialog(project,method,refElement,editor);
  dialog.show();
}
