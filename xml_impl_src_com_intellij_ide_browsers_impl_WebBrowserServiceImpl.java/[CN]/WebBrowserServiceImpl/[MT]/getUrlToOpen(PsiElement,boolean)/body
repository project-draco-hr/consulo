{
  final PsiFile psiFile=psiElement instanceof PsiFile ? (PsiFile)psiElement : psiElement.getContainingFile();
  if (psiFile == null) {
    return null;
  }
  final VirtualFile virtualFile=psiFile.getVirtualFile();
  if (virtualFile == null) {
    return null;
  }
  final String localUrl=virtualFile.getUrl();
  if (virtualFile instanceof HttpVirtualFile) {
    return localUrl;
  }
  if (preferLocalUrl && HtmlUtil.isHtmlFile(psiFile)) {
    return localUrl;
  }
  final WebBrowserUrlProvider provider=getProvider(psiElement);
  if (provider == null) {
    return localUrl;
  }
  try {
    return provider.getUrl(psiElement);
  }
 catch (  WebBrowserUrlProvider.BrowserException e) {
    if (HtmlUtil.isHtmlFile(psiFile)) {
      return localUrl;
    }
    throw e;
  }
}
