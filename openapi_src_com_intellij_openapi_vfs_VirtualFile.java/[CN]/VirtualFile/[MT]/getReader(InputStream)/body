{
  final Reader reader;
  FileType fileType=FileTypeManager.getInstance().getFileTypeByFile(this);
  if (fileType != null) {
    String charsetName=fileType.getCharset(this);
    if (charsetName != null) {
      myCharset=Charset.forName(charsetName);
      reader=new BufferedReader(new InputStreamReader(stream,myCharset));
      skipUTF8BOM(reader);
      return reader;
    }
  }
  CharsetSettings settings=CharsetSettings.getInstance();
  if (settings != null && settings.isUseUTFGuessing()) {
    SmartEncodingInputStream seis=new SmartEncodingInputStream(stream,SmartEncodingInputStream.BUFFER_LENGTH_4KB,CharsetToolkit.getIDEOptionsCharset(),true);
    myCharset=seis.getEncoding();
    reader=seis.getReader();
    if (Patches.SUN_BUG_ID_4508058) {
      myBOM=seis.detectUTF8_BOM();
    }
  }
 else {
    myCharset=CharsetToolkit.getIDEOptionsCharset();
    if (myCharset != null) {
      reader=new BufferedReader(new InputStreamReader(stream,myCharset));
      skipUTF8BOM(reader);
    }
 else {
      reader=new BufferedReader(new InputStreamReader(stream));
    }
  }
  return reader;
}
