{
  final Reader reader;
  FileType fileType=FileTypeManager.getInstance().getFileTypeByFile(this);
  if (fileType != null) {
    String charsetName=fileType.getCharset(this);
    if (charsetName != null) {
      myCharset=Charset.forName(charsetName);
      return new InputStreamReader(stream,myCharset);
    }
  }
  CharsetSettings settings=CharsetSettings.getInstance();
  if (settings != null && settings.isUseUTFGuessing()) {
    SmartEncodingInputStream seis=new SmartEncodingInputStream(stream,SmartEncodingInputStream.BUFFER_LENGTH_4KB,CharsetToolkit.getIDEOptionsCharset(),true);
    myCharset=seis.getEncoding();
    reader=seis.getReader();
    if (Patches.SUN_BUG_ID_4508058) {
      myBOM=seis.detectUTF8_BOM();
    }
  }
 else {
    myCharset=CharsetToolkit.getIDEOptionsCharset();
    if (myCharset != null) {
      reader=new BufferedReader(new InputStreamReader(stream,myCharset));
      if (Patches.SUN_BUG_ID_4508058) {
        if (myCharset.name().equals("UTF-8")) {
          reader.mark(1);
          char c=(char)reader.read();
          if (c == '\uFEFF') {
            myBOM=CharsetToolkit.UTF8_BOM;
          }
 else {
            reader.reset();
          }
        }
      }
    }
 else {
      reader=new BufferedReader(new InputStreamReader(stream));
    }
  }
  return reader;
}
