{
  super.visitVariable(variable);
  if (!(variable instanceof PsiLocalVariable)) {
    return;
  }
  final PsiExpression initializer=variable.getInitializer();
  if (!isMoveable(initializer)) {
    return;
  }
  final PsiElement variableScope=PsiTreeUtil.getParentOfType(variable,PsiCodeBlock.class,PsiForStatement.class);
  if (variableScope == null) {
    return;
  }
  final Query<PsiReference> query=ReferencesSearch.search(variable,variable.getUseScope());
  final Collection<PsiReference> referencesCollection=query.findAll();
  final int size=referencesCollection.size();
  if (size == 0) {
    return;
  }
  final PsiReference[] references=referencesCollection.toArray(new PsiReference[size]);
  PsiElement commonParent=ScopeUtils.getCommonParent(references);
  if (commonParent == null) {
    return;
  }
  if (initializer != null) {
    commonParent=ScopeUtils.moveOutOfLoops(commonParent,variableScope);
    if (commonParent == null) {
      return;
    }
  }
  if (PsiTreeUtil.isAncestor(variableScope,commonParent,true)) {
    registerVariableError(variable);
    return;
  }
  if (m_onlyLookAtBlocks) {
    return;
  }
  if (commonParent instanceof PsiForStatement) {
    return;
  }
  final PsiReference firstReference=references[0];
  final PsiElement referenceElement=firstReference.getElement();
  if (referenceElement == null) {
    return;
  }
  final PsiElement blockChild=ScopeUtils.getChildWhichContainsElement(variableScope,referenceElement);
  if (blockChild == null) {
    return;
  }
  final PsiElement insertionPoint=ScopeUtils.findTighterDeclarationLocation(blockChild,variable);
  if (insertionPoint == null) {
    if (initializer != null) {
      return;
    }
    if (!(blockChild instanceof PsiExpressionStatement)) {
      return;
    }
    final PsiExpressionStatement expressionStatement=(PsiExpressionStatement)blockChild;
    final PsiExpression expression=expressionStatement.getExpression();
    if (!(expression instanceof PsiAssignmentExpression)) {
      return;
    }
    final PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)expression;
    final PsiExpression lExpression=assignmentExpression.getLExpression();
    if (!lExpression.equals(firstReference)) {
      return;
    }
  }
  final String blockChildText=blockChild.getText();
  if (blockChildText.startsWith("<%=") && blockChildText.endsWith("%>")) {
    final PsiElement element=PsiTreeUtil.skipSiblingsBackward(insertionPoint,PsiWhiteSpace.class,PsiComment.class);
    if (variable.equals(element)) {
      return;
    }
    return;
  }
  registerVariableError(variable);
}
