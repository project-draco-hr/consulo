{
  final VirtualFile vFile=event.getFile();
  final PsiDirectory oldParentDir=findDirectory(event.getOldParent());
  final PsiDirectory newParentDir=findDirectory(event.getNewParent());
  if (oldParentDir == null && newParentDir == null)   return;
  final PsiElement oldElement=vFile.isDirectory() ? myVFileToPsiDirMap.get(vFile) : getCachedPsiFileInner(vFile);
  removeInvalidFilesAndDirs(true);
  final FileViewProvider viewProvider=findViewProvider(vFile);
  final PsiElement newElement;
  final FileViewProvider newViewProvider;
  if (!vFile.isDirectory()) {
    newViewProvider=createFileViewProvider(vFile,true);
    newElement=newViewProvider.getPsi(viewProvider.getBaseLanguage());
  }
 else {
    newElement=findDirectory(vFile);
    newViewProvider=null;
  }
  if (oldElement == null && newElement == null)   return;
  ApplicationManager.getApplication().runWriteAction(new ExternalChangeAction(){
    public void run(){
      PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
      if (oldElement != null) {
        if (newElement != null) {
          if (!oldElement.getClass().equals(oldElement.getClass())) {
            myVFileToViewProviderMap.put(vFile,newViewProvider);
            PsiTreeChangeEventImpl treeRemoveEvent=new PsiTreeChangeEventImpl(myManager);
            treeRemoveEvent.setParent(oldParentDir);
            treeRemoveEvent.setChild(oldElement);
            myManager.childRemoved(treeRemoveEvent);
            PsiTreeChangeEventImpl treeAddEvent=new PsiTreeChangeEventImpl(myManager);
            treeAddEvent.setParent(newParentDir);
            treeAddEvent.setChild(newElement);
            myManager.childAdded(treeAddEvent);
          }
 else {
            treeEvent.setOldParent(oldParentDir);
            treeEvent.setNewParent(newParentDir);
            treeEvent.setChild(newElement);
            myManager.childMoved(treeEvent);
          }
        }
 else {
          myVFileToViewProviderMap.remove(vFile);
          treeEvent.setParent(oldParentDir);
          treeEvent.setChild(oldElement);
          myManager.childRemoved(treeEvent);
        }
      }
 else {
        myVFileToViewProviderMap.put(vFile,newViewProvider);
        LOG.assertTrue(newElement != null);
        treeEvent.setParent(newParentDir);
        treeEvent.setChild(newElement);
        myManager.childAdded(treeEvent);
      }
    }
  }
);
}
