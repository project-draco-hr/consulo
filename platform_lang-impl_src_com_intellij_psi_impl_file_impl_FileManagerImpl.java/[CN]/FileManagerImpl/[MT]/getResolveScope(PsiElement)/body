{
  ProgressManager.checkCanceled();
  VirtualFile vFile;
  final Project project=myManager.getProject();
  if (element instanceof PsiDirectory) {
    vFile=((PsiDirectory)element).getVirtualFile();
  }
 else {
    final PsiFile containingFile=element.getContainingFile();
    if (containingFile instanceof PsiCodeFragment) {
      final GlobalSearchScope forcedScope=((PsiCodeFragment)containingFile).getForcedResolveScope();
      if (forcedScope != null) {
        return forcedScope;
      }
      final PsiElement context=containingFile.getContext();
      if (context == null) {
        return GlobalSearchScope.allScope(project);
      }
      return getResolveScope(context);
    }
    final PsiFile contextFile=containingFile != null ? FileContextUtil.getContextFile(containingFile) : null;
    if (contextFile == null) {
      return GlobalSearchScope.allScope(project);
    }
 else     if (contextFile instanceof FileResolveScopeProvider) {
      return ((FileResolveScopeProvider)contextFile).getFileResolveScope();
    }
    vFile=contextFile.getOriginalFile().getVirtualFile();
  }
  if (vFile == null) {
    return GlobalSearchScope.allScope(project);
  }
  return getDefaultResolveScope(vFile);
}
