{
  VirtualFile vFile;
  final GlobalSearchScope allScope=GlobalSearchScope.allScope(myManager.getProject());
  if (element instanceof PsiDirectory) {
    vFile=((PsiDirectory)element).getVirtualFile();
  }
 else {
    final PsiFile containingFile=element.getContainingFile();
    if (containingFile == null)     return allScope;
    final VirtualFile virtualFile=containingFile.getVirtualFile();
    if (virtualFile == null)     return allScope;
    vFile=virtualFile.getParent();
  }
  if (vFile == null)   return allScope;
  ProjectFileIndex projectFileIndex=myProjectRootManager.getFileIndex();
  Module module=projectFileIndex.getModuleForFile(vFile);
  if (module != null) {
    boolean isTest=projectFileIndex.isInTestSourceContent(vFile);
    return isTest ? GlobalSearchScope.moduleTestsWithDependentsScope(module) : GlobalSearchScope.moduleWithDependentsScope(module);
  }
 else {
    final PsiFile f=element.getContainingFile();
    final VirtualFile vf=f == null ? null : f.getVirtualFile();
    return f == null || vf == null || vf.isDirectory() || allScope.contains(vf) ? allScope : GlobalSearchScopes.fileScope(f).uniteWith(allScope);
  }
}
