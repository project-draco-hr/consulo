{
  final PsiExpression[] copy=new PsiExpression[]{(PsiExpression)expression.copy()};
  final ExpressionVisitor expressionVisitor=new ExpressionVisitor(expression.getManager(),true);
  copy[0].accept(new PsiRecursiveElementVisitor(){
    public void visitExpression(    PsiExpression expression){
      super.visitExpression(expression);
      expressionVisitor.clear();
      expression.accept(expressionVisitor);
      if (expressionVisitor.resultExpression != null) {
        LOG.assertTrue(expressionVisitor.resultExpression.isValid());
        try {
          if (expression != copy[0]) {
            expression.replace(expressionVisitor.resultExpression);
          }
 else {
            copy[0]=expressionVisitor.resultExpression;
          }
        }
 catch (        IncorrectOperationException e) {
          LOG.error(e);
        }
      }
    }
  }
);
  return copy[0];
}
