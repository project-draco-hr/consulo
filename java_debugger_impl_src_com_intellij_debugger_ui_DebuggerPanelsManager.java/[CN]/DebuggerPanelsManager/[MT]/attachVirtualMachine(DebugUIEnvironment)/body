{
  final DebugEnvironment modelEnvironment=environment.getEnvironment();
  final DebuggerSession debuggerSession=DebuggerManagerEx.getInstanceEx(myProject).attachVirtualMachine(modelEnvironment);
  if (debuggerSession == null) {
    return null;
  }
  final DebugProcessImpl debugProcess=debuggerSession.getProcess();
  if (debugProcess.isDetached() || debugProcess.isDetaching()) {
    debuggerSession.dispose();
    return null;
  }
  if (modelEnvironment.isRemote()) {
    debugProcess.putUserData(BatchEvaluator.REMOTE_SESSION_KEY,Boolean.TRUE);
  }
  final DebuggerSessionTab sessionTab=new DebuggerSessionTab(myProject,modelEnvironment.getSessionName(),environment.getIcon());
  Disposer.register(myProject,sessionTab);
  RunContentDescriptor runContentDescriptor=sessionTab.attachToSession(debuggerSession,environment);
  RunContentDescriptor reuseContent=environment.getReuseContent();
  if (reuseContent != null) {
    final ProcessHandler prevHandler=reuseContent.getProcessHandler();
    if (prevHandler != null) {
      final DebuggerSessionTab prevSession=mySessionTabs.get(prevHandler);
      if (prevSession != null) {
        sessionTab.reuse(prevSession);
      }
    }
  }
  mySessionTabs.put(runContentDescriptor.getProcessHandler(),sessionTab);
  return runContentDescriptor;
}
