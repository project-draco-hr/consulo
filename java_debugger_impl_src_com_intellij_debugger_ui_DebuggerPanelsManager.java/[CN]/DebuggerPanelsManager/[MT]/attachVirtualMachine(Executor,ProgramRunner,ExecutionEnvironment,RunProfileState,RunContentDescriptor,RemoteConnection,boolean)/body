{
  final DebuggerSession debuggerSession=DebuggerManagerEx.getInstanceEx(myProject).attachVirtualMachine(executor,runner,(ModuleRunProfile)environment.getRunProfile(),state,remoteConnection,pollConnection);
  if (debuggerSession == null) {
    return null;
  }
  final DebugProcessImpl debugProcess=debuggerSession.getProcess();
  if (debugProcess.isDetached() || debugProcess.isDetaching()) {
    debuggerSession.dispose();
    return null;
  }
  if (state instanceof RemoteState) {
    debugProcess.putUserData(BatchEvaluator.REMOTE_SESSION_KEY,Boolean.TRUE);
  }
  final DebuggerSessionTab sessionTab=new DebuggerSessionTab(myProject,debuggerSession.getSessionName(),environment.getRunProfile().getIcon());
  Disposer.register(myProject,sessionTab);
  RunContentDescriptor runContentDescriptor=sessionTab.attachToSession(debuggerSession,runner,environment);
  if (reuseContent != null) {
    final ProcessHandler prevHandler=reuseContent.getProcessHandler();
    if (prevHandler != null) {
      final DebuggerSessionTab prevSession=mySessionTabs.get(prevHandler);
      if (prevSession != null) {
        sessionTab.reuse(prevSession);
      }
    }
  }
  mySessionTabs.put(runContentDescriptor.getProcessHandler(),sessionTab);
  return runContentDescriptor;
}
