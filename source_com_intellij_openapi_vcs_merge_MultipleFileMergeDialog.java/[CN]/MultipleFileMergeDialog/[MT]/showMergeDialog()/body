{
  final Collection<VirtualFile> files=myTable.getSelection();
  for (  final VirtualFile file : files) {
    final Ref<MergeData> mergeDataRef=new Ref<MergeData>();
    final Ref<VcsException> exRef=new Ref<VcsException>();
    Task task=new Task.Modal(myProject,VcsBundle.message("multiple.file.merge.loading.progress.title"),false){
      public void run(      ProgressIndicator indicator){
        try {
          mergeDataRef.set(myProvider.loadRevisions(file));
        }
 catch (        VcsException e) {
          exRef.set(e);
        }
      }
    }
;
    ProgressManager.getInstance().run(task);
    if (!exRef.isNull()) {
      Messages.showErrorDialog(myRootPanel,"Error loading revisions to merge: " + exRef.get().getMessage());
      break;
    }
    final MergeData mergeData=mergeDataRef.get();
    if (mergeData.CURRENT == null || mergeData.LAST == null || mergeData.ORIGINAL == null) {
      Messages.showErrorDialog(myRootPanel,"Error loading revisions to merge");
      break;
    }
    final Document document=FileDocumentManager.getInstance().getDocument(file);
    final String contentWithMergeMarkers=document == null ? null : document.getText();
    String leftText=decodeContent(file,mergeData.CURRENT);
    String rightText=decodeContent(file,mergeData.LAST);
    String originalText=decodeContent(file,mergeData.ORIGINAL);
    DiffRequestFactory diffRequestFactory=PeerFactory.getInstance().getDiffRequestFactory();
    MergeRequest request=diffRequestFactory.createMergeRequest(leftText,rightText,originalText,file,myProject,ActionButtonPresentation.createApplyButton());
    String lastVersionTitle;
    if (mergeData.LAST_REVISION_NUMBER != null) {
      lastVersionTitle=VcsBundle.message("merge.version.title.last.version.number",mergeData.LAST_REVISION_NUMBER.asString());
    }
 else {
      lastVersionTitle=VcsBundle.message("merge.version.title.last.version");
    }
    request.setVersionTitles(new String[]{VcsBundle.message("merge.version.title.local.changes"),VcsBundle.message("merge.version.title.merge.result"),lastVersionTitle});
    request.setWindowTitle(VcsBundle.message("multiple.file.merge.request.title"));
    DiffManager.getInstance().getDiffTool().show(request);
    if (request.getResult() == DialogWrapper.OK_EXIT_CODE) {
      myFiles.remove(file);
      myProvider.conflictResolvedForFile(file);
      checkMarkModifiedProject(file);
    }
 else {
      restoreOriginalContent(file,contentWithMergeMarkers);
    }
  }
  updateModelFromFiles();
}
