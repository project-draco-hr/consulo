{
  return ApplicationManager.getApplication().runReadAction(new Computable<GenerationItem[]>(){
    @Override public GenerationItem[] compute(){
      List<MyItem> result=new ArrayList<MyItem>();
      for (      Module module : context.getProjectCompileScope().getAffectedModules()) {
        AndroidFacet facet=AndroidFacet.getInstance(module);
        if (facet != null && facet.getConfiguration().LIBRARY_PROJECT) {
          continue;
        }
        Map<String,MyItem> qName2Item=new HashMap<String,MyItem>();
        for (        AndroidFacet depFacet : AndroidUtils.getAllAndroidDependencies(module,true)) {
          final AndroidPlatform platform=depFacet.getConfiguration().getAndroidPlatform();
          final int platformToolsRevision=platform != null ? platform.getSdk().getPlatformToolsRevision() : -1;
          if (platformToolsRevision < 0 || platformToolsRevision > 7) {
            continue;
          }
          final String aptGenSrcRootPath=depFacet.getAptGenSourceRootPath();
          final VirtualFile aptGenSrcRoot=aptGenSrcRootPath != null ? LocalFileSystem.getInstance().findFileByPath(aptGenSrcRootPath) : null;
          final String aidlGenSrcRootPath=depFacet.getAidlGenSourceRootPath();
          final VirtualFile aidlGenSrcRoot=aidlGenSrcRootPath != null ? LocalFileSystem.getInstance().findFileByPath(aidlGenSrcRootPath) : null;
          VirtualFile[] srcRoots=ModuleRootManager.getInstance(depFacet.getModule()).getSourceRoots();
          for (          VirtualFile depSourceRoot : srcRoots) {
            if (depSourceRoot != aptGenSrcRoot && depSourceRoot != aidlGenSrcRoot) {
              collectCompilableFiles(module,depFacet.getModule(),context,depSourceRoot,qName2Item);
            }
          }
        }
        result.addAll(qName2Item.values());
      }
      return result.toArray(new MyItem[result.size()]);
    }
  }
);
}
