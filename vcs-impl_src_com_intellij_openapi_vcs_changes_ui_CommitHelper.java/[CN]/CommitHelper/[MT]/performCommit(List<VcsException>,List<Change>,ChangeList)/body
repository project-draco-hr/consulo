{
  final Ref<Boolean> refKeepChangeList=new Ref<Boolean>();
  try {
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        markCommittingDocuments();
      }
    }
);
    final List<FilePath> pathsToRefresh=new ArrayList<FilePath>();
    ChangesUtil.processChangesByVcs(myProject,myIncludedChanges,new ChangesUtil.PerVcsProcessor<Change>(){
      public void process(      AbstractVcs vcs,      List<Change> changes){
        final CheckinEnvironment environment=vcs.getCheckinEnvironment();
        if (environment != null) {
          Collection<FilePath> paths=ChangesUtil.getPaths(changes);
          pathsToRefresh.addAll(paths);
          if (environment.keepChangeListAfterCommit(changeList)) {
            refKeepChangeList.set(Boolean.TRUE);
          }
          final List<VcsException> exceptions=environment.commit(changes,myCommitMessage);
          if (exceptions != null && exceptions.size() > 0) {
            vcsExceptions.addAll(exceptions);
            changesFailedToCommit.addAll(changes);
          }
        }
      }
    }
);
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        unmarkCommittingDocuments();
      }
    }
);
    final LocalHistoryAction action=ApplicationManager.getApplication().runReadAction(new Computable<LocalHistoryAction>(){
      public LocalHistoryAction compute(){
        return LocalHistory.startAction(myProject,myActionName);
      }
    }
);
    VirtualFileManager.getInstance().refresh(true,new Runnable(){
      public void run(){
        action.finish();
        if (!myProject.isDisposed()) {
          for (          FilePath path : pathsToRefresh) {
            myDirtyScopeManager.fileDirty(path);
          }
          LocalHistory.putSystemLabel(myProject,myActionName + ": " + myCommitMessage);
        }
      }
    }
);
    AbstractVcsHelper.getInstance(myProject).showErrors(vcsExceptions,myActionName);
  }
  finally {
    commitCompleted(vcsExceptions,changeList,changesFailedToCommit,myHandlers,myCommitMessage,!refKeepChangeList.isNull());
  }
}
