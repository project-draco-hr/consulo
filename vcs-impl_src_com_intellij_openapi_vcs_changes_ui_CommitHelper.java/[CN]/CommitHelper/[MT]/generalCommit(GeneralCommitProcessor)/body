{
  try {
    final Application appManager=ApplicationManager.getApplication();
    appManager.runReadAction(new Runnable(){
      public void run(){
        markCommittingDocuments();
      }
    }
);
    processor.callSelf();
    appManager.runReadAction(new Runnable(){
      public void run(){
        unmarkCommittingDocuments();
      }
    }
);
    processor.doBeforeRefresh();
    if (appManager.isDispatchThread()) {
      VirtualFileManager.getInstance().refresh(false,processor.postRefresh());
    }
 else {
      appManager.invokeLater(new Runnable(){
        public void run(){
          VirtualFileManager.getInstance().refresh(false,processor.postRefresh());
        }
      }
);
    }
    AbstractVcsHelper.getInstanceChecked(myProject).showErrors(processor.getVcsExceptions(),myActionName);
  }
  finally {
    commitCompleted(processor.getVcsExceptions(),processor);
  }
}
