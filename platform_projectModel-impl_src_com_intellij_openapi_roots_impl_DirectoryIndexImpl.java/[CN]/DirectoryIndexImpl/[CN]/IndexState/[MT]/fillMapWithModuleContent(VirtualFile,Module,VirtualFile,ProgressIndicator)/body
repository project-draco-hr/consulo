{
  final int contentRootId=contentRoot == null ? 0 : getId(contentRoot);
  VfsUtilCore.visitChildrenRecursively(root,new DirectoryVisitor(){
    @Override protected DirectoryInfo updateInfo(    @NotNull VirtualFile file){
      if (progress != null) {
        progress.checkCanceled();
      }
      if (isExcluded(contentRootId,file))       return null;
      if (isIgnored(file))       return null;
      DirectoryInfo info=getOrCreateDirInfo(getId(file));
      if (info.getModule() != null) {
        VirtualFile dir=file.getParent();
        DirectoryInfo parentInfo=dir == null ? null : myDirToInfoMap.get(getId(dir));
        if (parentInfo == null || !info.getModule().equals(parentInfo.getModule()))         return null;
      }
      return info;
    }
    @Override protected void afterChildrenVisited(    @NotNull VirtualFile file,    @NotNull DirectoryInfo info){
      info=info.withModule(module).withContentRoot(contentRoot);
      storeInfo(info,getId(file));
    }
  }
);
}
