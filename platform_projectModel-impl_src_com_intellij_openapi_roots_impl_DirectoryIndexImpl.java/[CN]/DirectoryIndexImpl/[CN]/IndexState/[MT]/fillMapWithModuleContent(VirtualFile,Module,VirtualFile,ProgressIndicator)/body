{
  VfsUtilCore.visitChildrenRecursively(root,new DirectoryVisitor(){
    @Override protected DirectoryInfo updateInfo(    VirtualFile file){
      if (progress != null) {
        progress.checkCanceled();
      }
      if (isExcluded(getId(contentRoot),file))       return null;
      if (isIgnored(file))       return null;
      DirectoryInfo info=getOrCreateDirInfo(getId(file));
      if (info.getModule() != null) {
        VirtualFile dir=file.getParent();
        DirectoryInfo parentInfo=dir == null ? null : myDirToInfoMap.get(getId(dir));
        if (parentInfo == null || !info.getModule().equals(parentInfo.getModule()))         return null;
      }
      return info;
    }
    @Override protected void afterChildrenVisited(    DirectoryInfo info){
      info.setModule(module);
      info.setContentRoot(contentRoot);
    }
  }
);
}
