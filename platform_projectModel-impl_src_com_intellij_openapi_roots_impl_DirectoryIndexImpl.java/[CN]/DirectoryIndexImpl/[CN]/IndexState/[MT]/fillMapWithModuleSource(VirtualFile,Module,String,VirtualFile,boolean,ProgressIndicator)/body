{
  VfsUtilCore.visitChildrenRecursively(dir,new DirectoryVisitor(){
    private final Stack<String> myPackages=new Stack<String>();
    @Override protected DirectoryInfo updateInfo(    VirtualFile file){
      if (progress != null) {
        progress.checkCanceled();
      }
      int id=getId(file);
      DirectoryInfo info=myDirToInfoMap.get(id);
      if (info == null)       return null;
      if (!module.equals(info.getModule()))       return null;
      if (info.isInModuleSource()) {
        String definedPackage=myDirToPackageName.get(id);
        if (definedPackage != null && definedPackage.isEmpty())         return null;
      }
      info.setInModuleSource(true);
      info.setTestSource(isTestSource);
      info.setSourceRoot(sourceRoot);
      String currentPackage;
      if (myPackages.isEmpty()) {
        currentPackage=packageName;
      }
 else {
        currentPackage=getPackageNameForSubdir(myPackages.peek(),file.getName());
      }
      myPackages.push(currentPackage);
      setPackageName(id,currentPackage);
      return info;
    }
    @Override protected void afterChildrenVisited(    DirectoryInfo info){
      super.afterChildrenVisited(info);
      myPackages.pop();
    }
  }
);
}
