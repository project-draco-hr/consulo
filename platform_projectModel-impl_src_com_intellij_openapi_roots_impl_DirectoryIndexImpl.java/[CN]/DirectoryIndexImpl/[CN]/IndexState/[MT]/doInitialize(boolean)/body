{
  ProgressIndicator progress=ProgressIndicatorProvider.getGlobalProgressIndicator();
  if (progress == null)   progress=new EmptyProgressIndicator();
  progress.pushState();
  progress.checkCanceled();
  progress.setText(ProjectBundle.message("project.index.scanning.files.progress"));
  Module[] modules=ModuleManager.getInstance(myProject).getModules();
  if (reverseAllSets)   modules=ArrayUtil.reverseArray(modules);
  initExcludedDirMap(modules,progress);
  for (  Module module : modules) {
    initModuleContents(module,reverseAllSets,progress);
  }
  for (  Module module : modules) {
    initModuleSources(module,reverseAllSets,progress);
    initLibrarySources(module,progress);
    initLibraryClasses(module,progress);
  }
  progress.checkCanceled();
  progress.setText2("");
  MultiMap<VirtualFile,OrderEntry> depEntries=new MultiMap<VirtualFile,OrderEntry>();
  MultiMap<VirtualFile,OrderEntry> libClassRootEntries=new MultiMap<VirtualFile,OrderEntry>();
  MultiMap<VirtualFile,OrderEntry> libSourceRootEntries=new MultiMap<VirtualFile,OrderEntry>();
  for (  Module module : modules) {
    initOrderEntries(module,depEntries,libClassRootEntries,libSourceRootEntries,progress);
  }
  fillMapWithOrderEntries(depEntries,libClassRootEntries,libSourceRootEntries,progress);
  killOrderEntryArrayDuplicates();
}
