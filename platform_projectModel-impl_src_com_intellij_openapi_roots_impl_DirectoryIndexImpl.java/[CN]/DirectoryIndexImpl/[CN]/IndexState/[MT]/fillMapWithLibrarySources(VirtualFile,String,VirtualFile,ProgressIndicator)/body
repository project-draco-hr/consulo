{
  VfsUtilCore.visitChildrenRecursively(dir,new VirtualFileVisitor(){
{
      set(PACKAGE_NAME,packageName);
    }
    @Override public boolean visitFile(    @NotNull VirtualFile file){
      if (progress != null)       progress.checkCanceled();
      if (!file.isDirectory() && file != dir || isIgnored(file))       return false;
      DirectoryInfo info=getOrCreateDirInfo(file);
      if (info.isInLibrarySource) {
        String definedPackage=myDirToPackageName.get(file);
        if (definedPackage != null && definedPackage.isEmpty())         return false;
      }
      info.isInLibrarySource=true;
      info.sourceRoot=sourceRoot;
      final String packageName=get(PACKAGE_NAME);
      final String newPackageName=file == dir ? packageName : getPackageNameForSubdir(packageName,file.getName());
      setPackageName(file,newPackageName);
      set(PACKAGE_NAME,newPackageName);
      return true;
    }
  }
);
}
