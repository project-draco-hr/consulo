{
  progress.checkCanceled();
  progress.setText2(ProjectBundle.message("project.index.building.exclude.roots.progress"));
  for (  Module module : modules) {
    for (    ContentEntry contentEntry : getContentEntries(module)) {
      VirtualFile contentRoot=contentEntry.getFile();
      if (contentRoot == null)       continue;
      ExcludeFolder[] excludeRoots=contentEntry.getExcludeFolders();
      for (      ExcludeFolder excludeRoot : excludeRoots) {
        if (excludeRoot.getFile() != null) {
          if (!FileUtil.startsWith(contentRoot.getUrl(),excludeRoot.getUrl())) {
            if (isExcludeRootForModule(module,excludeRoot.getFile())) {
              putForFileAndAllAncestors(excludeRoot.getFile(),excludeRoot.getUrl());
            }
          }
        }
        putForFileAndAllAncestors(contentRoot,excludeRoot.getUrl());
      }
    }
  }
  for (  DirectoryIndexExcludePolicy policy : myExcludePolicies) {
    for (    VirtualFile file : policy.getExcludeRootsForProject()) {
      putForFileAndAllAncestors(file,file.getUrl());
      myProjectExcludeRoots.add(getId(file));
    }
  }
}
