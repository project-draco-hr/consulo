{
  checkAvailability();
  dispatchPendingEvents();
  IndexState state=myState;
  int[] allDirs=state.getDirsForPackage(packageName);
  if (allDirs == null)   allDirs=ArrayUtil.EMPTY_INT_ARRAY;
  List<VirtualFile> files=new ArrayList<VirtualFile>(allDirs.length);
  for (  int dir : allDirs) {
    VirtualFile file=findFileById(dir);
    if (file != null) {
      files.add(file);
    }
  }
  Query<VirtualFile> query=includeLibrarySources ? new CollectionQuery<VirtualFile>(files) : createQuery(Pair.create(state,files));
  return new FilteredQuery<VirtualFile>(query,IS_VALID);
}
