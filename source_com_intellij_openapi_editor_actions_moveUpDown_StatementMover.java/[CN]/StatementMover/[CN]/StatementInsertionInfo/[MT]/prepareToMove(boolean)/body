{
  super.prepareToMove(isDown);
  if (statementToSurroundWithCodeBlock != null) {
    try {
      final Document document=PsiDocumentManager.getInstance(statementToSurroundWithCodeBlock.getProject()).getDocument(statementToSurroundWithCodeBlock.getContainingFile());
      final int startOffset=document.getLineStartOffset(whatToMove.startLine);
      final int endOffset=document.getLineEndOffset(whatToMove.endLine);
      final RangeMarker lineRangeMarker=document.createRangeMarker(startOffset,endOffset);
      final PsiElementFactory factory=statementToSurroundWithCodeBlock.getManager().getElementFactory();
      PsiCodeBlock codeBlock=factory.createCodeBlock();
      codeBlock.add(statementToSurroundWithCodeBlock);
      final PsiBlockStatement blockStatement=(PsiBlockStatement)factory.createStatementFromText("{}",statementToSurroundWithCodeBlock);
      blockStatement.getCodeBlock().replace(codeBlock);
      final PsiBlockStatement newStatement=(PsiBlockStatement)statementToSurroundWithCodeBlock.replace(blockStatement);
      whatToMove=new LineRange(document.getLineNumber(lineRangeMarker.getStartOffset()),document.getLineNumber(lineRangeMarker.getEndOffset()));
      insertOffset=isDown ? newStatement.getCodeBlock().getLBrace().getNextSibling().getTextRange().getEndOffset() : newStatement.getCodeBlock().getRBrace().getTextRange().getStartOffset();
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
  }
}
