{
  super.beforeMove(editor);
  if (statementToSurroundWithCodeBlock != null) {
    try {
      final Document document=PsiDocumentManager.getInstance(statementToSurroundWithCodeBlock.getProject()).getDocument(statementToSurroundWithCodeBlock.getContainingFile());
      final int startOffset=document.getLineStartOffset(whatToMove.startLine);
      final int endOffset=document.getLineEndOffset(whatToMove.endLine);
      final RangeMarker lineRangeMarker=document.createRangeMarker(startOffset,endOffset);
      final PsiElementFactory factory=statementToSurroundWithCodeBlock.getManager().getElementFactory();
      PsiCodeBlock codeBlock=factory.createCodeBlock();
      codeBlock.add(statementToSurroundWithCodeBlock);
      final PsiBlockStatement blockStatement=(PsiBlockStatement)factory.createStatementFromText("{}",statementToSurroundWithCodeBlock);
      blockStatement.getCodeBlock().replace(codeBlock);
      PsiBlockStatement newStatement=(PsiBlockStatement)statementToSurroundWithCodeBlock.replace(blockStatement);
      newStatement=CodeInsightUtil.forcePsiPostprocessAndRestoreElement(newStatement);
      whatToMove=new LineRange(document.getLineNumber(lineRangeMarker.getStartOffset()),document.getLineNumber(lineRangeMarker.getEndOffset()));
      PsiCodeBlock newCodeBlock=newStatement.getCodeBlock();
      insertOffset=myIsDown ? newCodeBlock.getFirstBodyElement().getTextRange().getEndOffset() : newCodeBlock.getRBrace().getTextRange().getStartOffset();
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
  }
}
