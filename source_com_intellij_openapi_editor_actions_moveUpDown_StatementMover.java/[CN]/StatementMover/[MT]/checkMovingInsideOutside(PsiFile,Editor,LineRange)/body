{
  final int offset=editor.getCaretModel().getOffset();
  PsiElement guard=file.getViewProvider().findElementAt(offset,StdLanguages.JAVA);
  if (guard == null)   return false;
  do {
    guard=PsiTreeUtil.getParentOfType(guard,PsiMethod.class,PsiClassInitializer.class,PsiClass.class,PsiComment.class);
  }
 while (guard instanceof PsiAnonymousClass);
  if (!calcInsertOffset(file,editor,result))   return false;
  int insertOffset=isDown ? getLineStartSafeOffset(editor.getDocument(),toMove2.endLine) : editor.getDocument().getLineStartOffset(toMove2.startLine);
  PsiElement newGuard=file.getViewProvider().findElementAt(insertOffset,StdLanguages.JAVA);
  do {
    newGuard=PsiTreeUtil.getParentOfType(newGuard,PsiMethod.class,PsiClassInitializer.class,PsiClass.class,PsiComment.class);
  }
 while (newGuard instanceof PsiAnonymousClass);
  if (newGuard == guard && isInside(insertOffset,newGuard) == isInside(offset,guard))   return true;
  if (guard instanceof PsiClass && guard.getParent() instanceof PsiClass)   return true;
  if (newGuard instanceof PsiClass && newGuard.getParent() instanceof PsiClass)   return true;
  return false;
}
