{
  PsiManager psiManager=getNewExpression().getManager();
  final Project project=psiManager.getProject();
  final PsiElementFactory elementFactory=psiManager.getElementFactory();
  final PsiClass psiClass=CreateFromUsageUtils.createClass(getReferenceElement(getNewExpression()),CreateClassKind.CLASS,null);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        PsiClass aClass=psiClass;
        if (aClass == null)         return;
        setupInheritance(getNewExpression(),aClass);
        setupGenericParameters(getNewExpression(),aClass);
        PsiExpressionList argList=getNewExpression().getArgumentList();
        if (argList != null && argList.getExpressions().length > 0) {
          PsiMethod constructor=elementFactory.createConstructor();
          constructor=(PsiMethod)aClass.add(constructor);
          TemplateBuilder templateBuilder=new TemplateBuilder(aClass);
          CreateFromUsageUtils.setupMethodParameters(constructor,templateBuilder,argList,getTargetSubstitutor(getNewExpression()));
          setupSuperCall(aClass,constructor,templateBuilder);
          getReferenceElement(getNewExpression()).bindToElement(aClass);
          aClass=CodeInsightUtil.forcePsiPostprocessAndRestoreElement(aClass);
          Template template=templateBuilder.buildTemplate();
          Editor editor=positionCursor(project,aClass.getContainingFile(),aClass);
          TextRange textRange=aClass.getTextRange();
          editor.getDocument().deleteString(textRange.getStartOffset(),textRange.getEndOffset());
          startTemplate(editor,template,project);
        }
 else {
          positionCursor(project,aClass.getContainingFile(),aClass);
        }
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
);
}
