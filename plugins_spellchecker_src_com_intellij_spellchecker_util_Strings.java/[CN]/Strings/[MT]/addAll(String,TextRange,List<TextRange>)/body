{
  CharacterIterator it=new StringCharacterIterator(text,range.getStartOffset(),range.getEndOffset(),range.getStartOffset());
  StringBuffer b=new StringBuffer();
  WordState state=WordState.NO_WORD;
  char curPrevUC='\0';
  int pos=range.getStartOffset();
  for (char c=it.first(); c != CharacterIterator.DONE; c=it.next()) {
switch (state) {
case NO_WORD:
      if (!Character.isUpperCase(c)) {
        b.append(c);
        state=WordState.WORD;
      }
 else {
        state=WordState.PREV_UC;
        curPrevUC=c;
      }
    break;
case PREV_UC:
  if (!Character.isUpperCase(c)) {
    if (b.length() > 0) {
      result.add(new TextRange(pos,pos + b.length()));
      pos+=b.length();
    }
    b=new StringBuffer();
    b.append(curPrevUC);
    b.append(c);
    state=WordState.WORD;
  }
 else {
    b.append(curPrevUC);
    state=WordState.PREV_UC;
    curPrevUC=c;
  }
break;
case WORD:
if (Character.isUpperCase(c)) {
if (b.length() > 0) {
  result.add(new TextRange(pos,pos + b.length()));
  pos+=b.length();
}
b.setLength(0);
state=WordState.PREV_UC;
curPrevUC=c;
}
 else {
b.append(c);
}
break;
}
}
if (state == WordState.PREV_UC) {
b.append(curPrevUC);
}
result.add(new TextRange(pos,pos + b.length()));
}
