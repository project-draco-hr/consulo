{
  try {
    Map<PsiElement,PsiElement> oldToNewElementsMapping=new HashMap<PsiElement,PsiElement>();
    final List<PsiElement> elements=getElements();
    for (    PsiElement element : elements) {
      GroovyFile file=(GroovyFile)element;
      final RefactoringElementListener elementListener=getTransaction().getElementListener(file);
      final GrPackageDefinition packageDefinition=file.getPackageDefinition();
      final String packageName=packageDefinition == null ? null : packageDefinition.getPackageName();
      final PsiModifierList modifierList=packageDefinition == null ? null : (PsiModifierList)packageDefinition.getModifierList().copy();
      final PsiClass[] oldClasses=file.getClasses();
      GroovyChangeContextUtil.encodeContextInfo(file);
      PsiManager.getInstance(myProject).moveFile(file,myMoveDestination.getTargetDirectory(file));
      final String newPackageName=getTargetPackage().getQualifiedName();
      final String modifierText=modifierList != null && packageName != null && packageName.equals(newPackageName) ? modifierList.getText() + " " : "";
      final GrPackageDefinition newPackage="".equals(newPackageName) ? null : (GrPackageDefinition)GroovyPsiElementFactory.getInstance(myProject).createTopElementFromText(modifierText + "package " + newPackageName);
      file.setPackage(newPackage);
      PsiClass[] newClasses=file.getClasses();
      for (int i=0; i < oldClasses.length; i++) {
        oldToNewElementsMapping.put(oldClasses[i],newClasses[i]);
      }
      elementListener.elementMoved(file);
    }
    for (    PsiElement element : elements) {
      GroovyChangeContextUtil.decodeContextInfo(element,null,null);
    }
    myNonCodeUsages=CommonMoveUtil.retargetUsages(usages,oldToNewElementsMapping);
  }
 catch (  IncorrectOperationException e) {
    myNonCodeUsages=new NonCodeUsageInfo[0];
    RefactoringUIUtil.processIncorrectOperation(myProject,e);
  }
}
