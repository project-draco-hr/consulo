{
  LookupElement item=getDelegate();
  Project project=context.getProject();
  Editor editor=context.getEditor();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  TextRange range=myState.getCurrentVariableRange();
  final TemplateLookupSelectionHandler handler=item instanceof LookupItem ? ((LookupItem<?>)item).getAttribute(TemplateLookupSelectionHandler.KEY_IN_LOOKUP_ITEM) : null;
  if (handler != null && range != null) {
    handler.itemSelected(item,context.getFile(),context.getDocument(),range.getStartOffset(),range.getEndOffset());
  }
 else {
    super.handleInsert(context);
  }
  if (context.getCompletionChar() == '.') {
    EditorModificationUtil.insertStringAtCaret(editor,".");
    AutoPopupController.getInstance(project).autoPopupMemberLookup(editor,null);
    return;
  }
  if (!myState.isFinished()) {
    myState.calcResults(true);
  }
  myState.nextTab();
}
