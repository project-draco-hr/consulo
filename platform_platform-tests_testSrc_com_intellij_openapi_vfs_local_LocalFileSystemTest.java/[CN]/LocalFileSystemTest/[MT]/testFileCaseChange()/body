{
  if (SystemInfo.isFileSystemCaseSensitive) {
    System.err.println("Ignored: case-insensitive FS required");
    return;
  }
  File top=createTempDirectory(false);
  File file=IoTestUtil.createTestFile(top,"file.txt","test");
  File intermediate=new File(top,"_intermediate_");
  VirtualFile topDir=myFS.refreshAndFindFileByIoFile(top);
  assertNotNull(topDir);
  VirtualFile sourceFile=myFS.refreshAndFindFileByIoFile(file);
  assertNotNull(sourceFile);
  String newName=StringUtil.capitalize(file.getName());
  FileUtil.rename(file,intermediate);
  FileUtil.rename(intermediate,new File(top,newName));
  topDir.refresh(false,true);
  assertFalse(((VirtualDirectoryImpl)topDir).allChildrenLoaded());
  assertTrue(sourceFile.isValid());
  assertEquals(newName,sourceFile.getName());
  topDir.getChildren();
  newName=newName.toLowerCase(Locale.ENGLISH);
  FileUtil.rename(file,intermediate);
  FileUtil.rename(intermediate,new File(top,newName));
  topDir.refresh(false,true);
  assertTrue(((VirtualDirectoryImpl)topDir).allChildrenLoaded());
  assertTrue(sourceFile.isValid());
  assertEquals(newName,sourceFile.getName());
}
