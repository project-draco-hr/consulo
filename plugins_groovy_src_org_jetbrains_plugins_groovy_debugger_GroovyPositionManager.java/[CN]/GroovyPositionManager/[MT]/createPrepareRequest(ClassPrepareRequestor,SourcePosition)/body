{
  GroovyPsiElement sourceImage=findReferenceTypeSourceImage(position);
  String qName=null;
  if (sourceImage instanceof GrTypeDefinition) {
    qName=((GrTypeDefinition)sourceImage).getQualifiedName();
  }
 else   if (sourceImage == null) {
    qName=getScriptQualifiedName(position);
  }
  String waitPrepareFor;
  ClassPrepareRequestor waitRequestor;
  if (qName == null) {
    GrTypeDefinition typeDefinition=findEnclosingTypeDefinition(position);
    if (typeDefinition != null) {
      qName=typeDefinition.getQualifiedName();
    }
 else {
      qName=getScriptQualifiedName(position);
    }
    if (qName == null)     throw new NoDataException();
    waitPrepareFor=qName + "$*";
    waitRequestor=new ClassPrepareRequestor(){
      public void processClassPrepare(      DebugProcess debuggerProcess,      ReferenceType referenceType){
        final CompoundPositionManager positionManager=((DebugProcessImpl)debuggerProcess).getPositionManager();
        if (positionManager.locationsOfLine(referenceType,position).size() > 0) {
          requestor.processClassPrepare(debuggerProcess,referenceType);
        }
 else {
          final List<ReferenceType> positionClasses=positionManager.getAllClasses(position);
          if (positionClasses.contains(referenceType)) {
            requestor.processClassPrepare(debuggerProcess,referenceType);
          }
        }
      }
    }
;
  }
 else {
    waitPrepareFor=qName;
    waitRequestor=requestor;
  }
  return myDebugProcess.getRequestsManager().createClassPrepareRequest(waitRequestor,waitPrepareFor);
}
