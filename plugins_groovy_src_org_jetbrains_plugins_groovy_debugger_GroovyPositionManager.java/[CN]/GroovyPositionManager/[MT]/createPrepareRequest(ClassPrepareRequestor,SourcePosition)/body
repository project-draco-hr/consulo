{
  GrTypeDefinition typeDefinition=findEnclosingTypeDefinition(position);
  String qName=null;
  if (typeDefinition != null) {
    qName=typeDefinition.getQualifiedName();
  }
  String waitPrepareFor;
  ClassPrepareRequestor waitRequestor;
  if (qName == null) {
    GrTypeDefinition toplevel=getToplevelTypeDefinition(typeDefinition);
    if (toplevel == null) {
      PsiFile file=position.getFile();
      if (file instanceof GroovyFile) {
        qName=getScriptFQName((GroovyFile)file);
      }
      if (qName == null)       throw new NoDataException();
    }
 else {
      qName=toplevel.getQualifiedName();
    }
    if (qName == null)     throw new NoDataException();
    waitPrepareFor=qName + "$*";
    waitRequestor=new ClassPrepareRequestor(){
      public void processClassPrepare(      DebugProcess debuggerProcess,      ReferenceType referenceType){
        final CompoundPositionManager positionManager=((DebugProcessImpl)debuggerProcess).getPositionManager();
        if (positionManager.locationsOfLine(referenceType,position).size() > 0) {
          requestor.processClassPrepare(debuggerProcess,referenceType);
        }
 else {
          final List<ReferenceType> positionClasses=positionManager.getAllClasses(position);
          if (positionClasses.contains(referenceType)) {
            requestor.processClassPrepare(debuggerProcess,referenceType);
          }
        }
      }
    }
;
  }
 else {
    waitPrepareFor=qName;
    waitRequestor=requestor;
  }
  return myDebugProcess.getRequestsManager().createClassPrepareRequest(waitRequestor,waitPrepareFor);
}
