{
  cleanup();
  myCurrentScope=scope;
  final Element root=new Element(InspectionsBundle.message("inspection.problems"));
  final Document doc=new Document(root);
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      performInspectionsWithProgress(scope);
      InspectionTool[] tools=getCurrentProfile().getInspectionTools();
      for (int i=0; i < tools.length; i++) {
        InspectionTool tool=tools[i];
        if (getCurrentProfile().isToolEnabled(HighlightDisplayKey.find(tool.getShortName()))) {
          tool.exportResults(root);
        }
      }
    }
  }
);
  try {
    ((ProjectEx)getProject()).getMacroReplacements().substitute(doc.getRootElement(),SystemInfo.isFileSystemCaseSensitive);
    JDOMUtil.writeDocument(doc,outStream,"\n");
  }
 catch (  IOException e) {
    LOG.error(e);
  }
}
