{
  runBulkRollback(new Runnable(){
    @Override public void run(){
      Range first=null;
      Range last=null;
      int shift=0;
      for (      Range range : myRanges) {
        if (!range.isValid()) {
          LOG.warn("Rollback of invalid range");
          break;
        }
        boolean check;
        if (range.getLine1() == range.getLine2()) {
          check=lines.get(range.getLine1());
        }
 else {
          int next=lines.nextSetBit(range.getLine1());
          check=next != -1 && next < range.getLine2();
        }
        if (check) {
          if (first == null) {
            first=range;
          }
          last=range;
          Range shiftedRange=new Range(range);
          shiftedRange.shift(shift);
          doRollbackRange(shiftedRange);
          shift+=(range.getVcsLine2() - range.getVcsLine1()) - (range.getLine2() - range.getLine1());
        }
      }
      if (first != null) {
        int beforeChangedLine1=first.getLine1();
        int beforeChangedLine2=last.getLine2();
        int beforeTotalLines=getLineCount(myDocument) - shift;
        doUpdateRanges(beforeChangedLine1,beforeChangedLine2,shift,beforeTotalLines);
      }
    }
  }
);
}
