{
synchronized (LOCK) {
    if (!tryValidate())     return approximate ? line : ABSENT_LINE_NUMBER;
    int result=line;
    for (    Range range : myRanges) {
      int startLine1=fromVcs ? range.getVcsLine1() : range.getLine1();
      int endLine1=fromVcs ? range.getVcsLine2() : range.getLine2();
      int startLine2=fromVcs ? range.getLine1() : range.getVcsLine1();
      int endLine2=fromVcs ? range.getLine2() : range.getVcsLine2();
      if (startLine1 <= line && endLine1 > line) {
        return approximate ? startLine2 : ABSENT_LINE_NUMBER;
      }
      if (endLine1 > line)       return result;
      int length1=endLine1 - startLine1;
      int length2=endLine2 - startLine2;
      result+=length2 - length1;
    }
    return result;
  }
}
