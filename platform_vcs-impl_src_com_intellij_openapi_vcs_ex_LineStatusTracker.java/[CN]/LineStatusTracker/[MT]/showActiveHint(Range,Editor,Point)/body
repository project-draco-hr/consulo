{
  DefaultActionGroup group=new DefaultActionGroup();
  final AnAction globalShowNextAction=ActionManager.getInstance().getAction("VcsShowNextChangeMarker");
  final AnAction globalShowPrevAction=ActionManager.getInstance().getAction("VcsShowPrevChangeMarker");
  final ShowPrevChangeMarkerAction localShowPrevAction=new ShowPrevChangeMarkerAction(getPrevRange(range),this,editor);
  final ShowNextChangeMarkerAction localShowNextAction=new ShowNextChangeMarkerAction(getNextRange(range),this,editor);
  JComponent editorComponent=editor.getComponent();
  localShowNextAction.registerCustomShortcutSet(localShowNextAction.getShortcutSet(),editorComponent);
  localShowPrevAction.registerCustomShortcutSet(localShowPrevAction.getShortcutSet(),editorComponent);
  group.add(localShowPrevAction);
  group.add(localShowNextAction);
  localShowNextAction.copyFrom(globalShowNextAction);
  localShowPrevAction.copyFrom(globalShowPrevAction);
  group.add(new RollbackAction(this,range,editor));
  group.add(new ShowDiffAction(this,range,editor));
  group.add(new CopyAction(this,range));
  final List<AnAction> actionList=(List<AnAction>)editorComponent.getClientProperty(AnAction.ourClientProperty);
  actionList.remove(globalShowPrevAction);
  actionList.remove(globalShowNextAction);
  JComponent toolbar=ActionManager.getInstance().createActionToolbar(ActionPlaces.FILEHISTORY_VIEW_TOOLBAR,group,true).getComponent();
  final Color background=((EditorEx)editor).getBackgroundColor();
  final Color foreground=editor.getColorsScheme().getColor(EditorColors.CARET_COLOR);
  toolbar.setBackground(background);
  toolbar.setBorder(new ColoredSideBorder(foreground,foreground,range.getType() != Range.INSERTED ? null : foreground,foreground,1));
  JPanel component=new JPanel(new BorderLayout());
  component.setOpaque(false);
  JPanel toolbarPanel=new JPanel(new BorderLayout());
  toolbarPanel.setOpaque(false);
  toolbarPanel.add(toolbar,BorderLayout.WEST);
  component.add(toolbarPanel,BorderLayout.NORTH);
  if (range.getType() != Range.INSERTED) {
    DocumentEx doc=(DocumentEx)myUpToDateDocument;
    EditorEx uEditor=(EditorEx)EditorFactory.getInstance().createViewer(doc,myProject);
    EditorHighlighter highlighter=EditorHighlighterFactory.getInstance().createEditorHighlighter(myProject,getFileName());
    uEditor.setHighlighter(highlighter);
    EditorFragmentComponent editorFragmentComponent=EditorFragmentComponent.createEditorFragmentComponent(uEditor,range.getUOffset1(),range.getUOffset2(),false,false);
    component.add(editorFragmentComponent,BorderLayout.CENTER);
    EditorFactory.getInstance().releaseEditor(uEditor);
  }
  LightweightHint lightweightHint=new LightweightHint(component);
  lightweightHint.addHintListener(new HintListener(){
    public void hintHidden(    EventObject event){
      actionList.remove(localShowPrevAction);
      actionList.remove(localShowNextAction);
      actionList.add(globalShowPrevAction);
      actionList.add(globalShowNextAction);
    }
  }
);
  HintManagerImpl.getInstanceImpl().showEditorHint(lightweightHint,editor,point,HintManagerImpl.HIDE_BY_ANY_KEY | HintManagerImpl.HIDE_BY_TEXT_CHANGE | HintManagerImpl.HIDE_BY_OTHER_HINT| HintManagerImpl.HIDE_BY_SCROLLING,-1,false);
}
