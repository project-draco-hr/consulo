def send_headers(self):
    if (not self.saved_status):
        raise AssertionError('Sending headers before start_response() called')
    saved_status = self.saved_status.split(None, 1)
    saved_status[0] = int(saved_status[0])
    self.send_response(*saved_status)
    should_close = True
    for h in self.saved_headers:
        self.send_header(*h)
        if (h[0].lower() == 'content-length'):
            should_close = False
            self.length = int(h[1])
    if ('close' in [token.strip().lower() for token in self.headers.get('connection', '').split(',')]):
        should_close = True
    if should_close:
        self.send_header('Connection', 'close')
    self.close_connection = should_close
    self.end_headers()
    self.sent_headers = True
