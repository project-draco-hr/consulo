{
  if (myDisposed)   return;
  final ArrayList<LiveOccurrence> occurrences=new ArrayList<LiveOccurrence>();
  final Editor editor=getEditor();
  final ArrayList<FindResult> results=new ArrayList<FindResult>();
  if (findModel != null) {
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      @Override public void run(){
        TextRange selection=new TextRange(editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd());
        TextRange r=findModel.isGlobal() ? new TextRange(0,Integer.MAX_VALUE) : selection;
        if (r.getLength() == 0) {
          r=new TextRange(0,Integer.MAX_VALUE);
        }
        int offset=r.getStartOffset();
        VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(editor.getDocument());
        while (true) {
          FindManager findManager=FindManager.getInstance(editor.getProject());
          FindResult result;
          try {
            result=findManager.findString(editor.getDocument().getCharsSequence(),offset,findModel,virtualFile);
          }
 catch (          PatternSyntaxException e) {
            result=null;
          }
          if (result == null || !result.isStringFound())           break;
          int newOffset=result.getEndOffset();
          if (offset == newOffset || result.getEndOffset() > r.getEndOffset())           break;
          offset=newOffset;
          results.add(result);
          if (results.size() > myMatchesLimit)           break;
        }
        if (results.size() < myMatchesLimit) {
          findResultsToOccurrences(results,occurrences);
        }
        final Runnable searchCompletedRunnable=new Runnable(){
          @Override public void run(){
            searchCompleted(occurrences,results.size(),editor,findModel,toChangeSelection,next,stamp);
          }
        }
;
        if (!ApplicationManager.getApplication().isUnitTestMode()) {
          ApplicationManager.getApplication().invokeLater(searchCompletedRunnable);
        }
 else {
          searchCompletedRunnable.run();
        }
      }
    }
);
  }
}
