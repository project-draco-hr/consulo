{
  final ArrayList<LiveOccurrence> occurrences=new ArrayList<LiveOccurrence>();
  final Editor editor=getEditor();
  final ArrayList<FindResult> results=new ArrayList<FindResult>();
  if (findModel != null) {
    final Ref<TextRange> selectionRef=new Ref<TextRange>();
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      @Override public void run(){
        selectionRef.set(new TextRange(editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd()));
      }
    }
);
    TextRange r=findModel.isGlobal() ? new TextRange(0,Integer.MAX_VALUE) : selectionRef.get();
    if (r.getLength() == 0) {
      r=new TextRange(0,Integer.MAX_VALUE);
    }
    int offset=r.getStartOffset();
    VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(editor.getDocument());
    while (true) {
      FindManager findManager=FindManager.getInstance(editor.getProject());
      FindResult result=findManager.findString(editor.getDocument().getCharsSequence(),offset,findModel,virtualFile);
      if (!result.isStringFound())       break;
      int newOffset=result.getEndOffset();
      if (offset == newOffset || result.getEndOffset() > r.getEndOffset())       break;
      offset=newOffset;
      results.add(result);
      if (results.size() > myMatchesLimit)       break;
    }
    if (results.size() < myMatchesLimit) {
      findResultsToOccurrences(results,occurrences);
    }
  }
  final Runnable r=new Runnable(){
    @Override public void run(){
      searchCompleted(occurrences,results.size(),editor,findModel);
    }
  }
;
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    ApplicationManager.getApplication().invokeLater(r);
  }
 else {
    r.run();
  }
}
