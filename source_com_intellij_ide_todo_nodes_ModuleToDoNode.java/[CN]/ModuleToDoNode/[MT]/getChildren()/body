{
  ArrayList<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  if (myToDoSettings.getIsPackagesShown()) {
    for (Iterator i=myBuilder.getAllFiles(); i.hasNext(); ) {
      final PsiFile psiFile=(PsiFile)i.next();
      if (psiFile == null) {
        continue;
      }
      final VirtualFile virtualFile=psiFile.getVirtualFile();
      final boolean isInContent=ModuleRootManager.getInstance(getValue()).getFileIndex().isInContent(virtualFile);
      if (!isInContent)       continue;
      final VirtualFile contentRoot=ProjectRootManager.getInstance(getProject()).getFileIndex().getContentRootForFile(virtualFile);
      if (contentRoot != null) {
        final PsiDirectory projectRoot=PsiManager.getInstance(getProject()).findDirectory(contentRoot);
        TodoDirNode projectRootNode=new TodoDirNode(getProject(),projectRoot,myBuilder);
        if (projectRoot != null && !children.contains(projectRootNode)) {
          children.add(projectRootNode);
        }
      }
    }
  }
 else {
    for (Iterator i=myBuilder.getAllFiles(); i.hasNext(); ) {
      final PsiFile psiFile=(PsiFile)i.next();
      if (psiFile == null) {
        continue;
      }
      final VirtualFile virtualFile=psiFile.getVirtualFile();
      final boolean isInContent=ModuleRootManager.getInstance(getValue()).getFileIndex().isInContent(virtualFile);
      if (!isInContent)       continue;
      TodoFileNode fileNode=new TodoFileNode(getProject(),psiFile,myBuilder,false);
      if (getTreeStructure().accept(psiFile) && !children.contains(fileNode)) {
        children.add(fileNode);
      }
    }
  }
  Collections.sort(children,TodoFileDirComparator.ourInstance);
  return children;
}
