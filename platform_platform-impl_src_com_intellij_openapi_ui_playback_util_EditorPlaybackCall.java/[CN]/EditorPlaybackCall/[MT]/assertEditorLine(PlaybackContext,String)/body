{
  final AsyncResult<String> result=new AsyncResult<String>();
  WindowSystemPlaybackCall.getUiReady(context).doWhenDone(new Runnable(){
    @Override public void run(){
      final Editor editor=PlatformDataKeys.EDITOR.getData(DataManager.getInstance().getDataContextFromFocus().getResult());
      if (editor == null) {
        result.setRejected("Cannot find editor");
        return;
      }
      final int line=editor.getCaretModel().getLogicalPosition().line;
      final int caret=editor.getCaretModel().getOffset();
      final int start=editor.getDocument().getLineStartOffset(line);
      final int end=editor.getDocument().getLineEndOffset(line);
      final StringBuffer actualText=new StringBuffer(editor.getDocument().getText(new TextRange(start,caret)));
      actualText.append("<caret>").append(editor.getDocument().getText(new TextRange(caret,end)));
      if (expected.equals(actualText.toString())) {
        result.setDone();
      }
 else {
        result.setRejected("Expected:" + expected + " but was:"+ actualText);
      }
    }
  }
);
  return result;
}
