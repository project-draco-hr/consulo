{
  RowIcon baseIcon;
  final boolean isLocked=(flags & ICON_FLAG_READ_STATUS) != 0 && !elementWritable;
  int elementFlags=isLocked ? FLAGS_LOCKED : 0;
  if (element instanceof PsiDirectory) {
    Icon symbolIcon;
    final PsiDirectory psiDirectory=(PsiDirectory)element;
    if (psiDirectory.getPackage() != null) {
      symbolIcon=Icons.PACKAGE_ICON;
    }
 else {
      symbolIcon=Icons.DIRECTORY_CLOSED_ICON;
    }
    final VirtualFile vFile=psiDirectory.getVirtualFile();
    final Project project=psiDirectory.getProject();
    boolean isExcluded=isExcluded(vFile,project);
    baseIcon=createLayeredIcon(symbolIcon,elementFlags | (isExcluded ? FLAGS_EXCLUDED : 0));
  }
 else   if (element instanceof PsiPackage) {
    baseIcon=createLayeredIcon(Icons.PACKAGE_ICON,elementFlags);
  }
 else   if (element instanceof PsiFile) {
    PsiFile file=(PsiFile)element;
    Icon symbolIcon=IconUtilEx.getIcon(file.getVirtualFile(),flags & ~ICON_FLAG_READ_STATUS,file.getProject());
    baseIcon=createLayeredIcon(symbolIcon,elementFlags);
  }
 else   if (element instanceof PsiClass) {
    final PsiClass aClass=(PsiClass)element;
    Icon symbolIcon=getClassBaseIcon(aClass);
    baseIcon=createLayeredIcon(symbolIcon,getFlags(aClass,isLocked));
  }
 else   if (element instanceof PsiMethod) {
    final PsiMethod method=(PsiMethod)element;
    final EjbMethodRole role=J2EERolesUtil.getEjbRole(method);
    Icon methodIcon=role == null ? Icons.METHOD_ICON : role.getIcon();
    baseIcon=createLayeredIcon(methodIcon,getFlags(method,false));
  }
 else   if (element instanceof PsiField) {
    baseIcon=createLayeredIcon(Icons.FIELD_ICON,getFlags((PsiField)element,false));
  }
 else   if (element instanceof PsiParameter) {
    baseIcon=createLayeredIcon(Icons.PARAMETER_ICON,0);
  }
 else   if (element instanceof PsiVariable) {
    baseIcon=createLayeredIcon(Icons.VARIABLE_ICON,getFlags((PsiVariable)element,false));
  }
 else   if (element instanceof PsiPointcutDef) {
    baseIcon=createLayeredIcon(Icons.POINTCUT_ICON,0);
  }
 else   if (element instanceof PsiParentsIntroduction) {
    baseIcon=createLayeredIcon(Icons.PARENTS_INTRODUCTION_ICON,0);
  }
 else   if (element instanceof PsiErrorIntroduction) {
    baseIcon=createLayeredIcon(Icons.ERROR_INTRODUCTION_ICON,0);
  }
 else   if (element instanceof PsiWarningIntroduction) {
    baseIcon=createLayeredIcon(Icons.WARNING_INTRODUCTION_ICON,0);
  }
 else   if (element instanceof PsiSofteningIntroduction) {
    baseIcon=createLayeredIcon(Icons.SOFTENING_INTRODUCTION_ICON,0);
  }
 else   if (element instanceof PsiAdvice) {
    baseIcon=createLayeredIcon(Icons.ADVICE_ICON,0);
  }
 else   if (element instanceof XmlTag) {
    return Icons.XML_TAG_ICON;
  }
 else   if (element instanceof PsiAntElement) {
    return ((PsiAntElement)element).getRole().getIcon();
  }
 else {
    return null;
  }
  if ((flags & ICON_FLAG_VISIBILITY) != 0) {
    PsiModifierList modifierList=element instanceof PsiModifierListOwner ? ((PsiModifierListOwner)element).getModifierList() : null;
    IconUtilEx.setVisibilityIcon(modifierList,baseIcon);
  }
  return baseIcon;
}
