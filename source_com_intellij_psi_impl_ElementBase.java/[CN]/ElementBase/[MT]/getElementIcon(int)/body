{
  final PsiElement element=(PsiElement)this;
  boolean visibilityAdded=false;
  RowIcon baseIcon;
  final boolean isLocked=(flags & ICON_FLAG_READ_STATUS) != 0 && !element.isWritable();
  int elementFlags=isLocked ? FLAGS_LOCKED : 0;
  if (element instanceof ItemPresentation && ((ItemPresentation)element).getIcon(false) != null) {
    baseIcon=createLayeredIcon(((ItemPresentation)element).getIcon(false),elementFlags);
  }
 else   if (element instanceof PsiPackage) {
    baseIcon=createLayeredIcon(Icons.PACKAGE_ICON,elementFlags);
  }
 else   if (element instanceof PsiFile) {
    PsiFile file=(PsiFile)element;
    VirtualFile virtualFile=file.getVirtualFile();
    final Icon fileTypeIcon;
    if (virtualFile == null) {
      fileTypeIcon=file.getFileType().getIcon();
    }
 else {
      fileTypeIcon=IconUtil.getIcon(virtualFile,flags & ~ICON_FLAG_READ_STATUS,file.getProject());
      if (fileTypeIcon instanceof RowIcon) {
        visibilityAdded=true;
      }
    }
    baseIcon=createLayeredIcon(fileTypeIcon,elementFlags);
  }
 else {
    return null;
  }
  return visibilityAdded ? baseIcon : addVisibilityIcon(element,flags,baseIcon);
}
