{
  final CompositeElement compositeElement=(CompositeElement)element.getNode();
  PsiElement elementToReplace=element.getFirstChild().getNextSibling();
  CheckUtil.checkWritable(element);
  String text;
  try {
    text=element.getText();
    int offset=StringUtil.startsWithChar(text,'"') || StringUtil.startsWithChar(text,'\'') ? 1 : 0;
    if (offset == 0) {
      elementToReplace=element.getFirstChild();
    }
    String textBeforeRange=text.substring(offset,range.getStartOffset());
    String textAfterRange=text.substring(range.getEndOffset(),text.length() - offset);
    text=textBeforeRange + newContent + textAfterRange;
  }
 catch (  StringIndexOutOfBoundsException e) {
    LOG.error("Range: " + range + " in text: '"+ element.getText()+ "'",e);
    throw e;
  }
  final CharTable charTableByTree=SharedImplUtil.findCharTableByTree(compositeElement);
  final LeafElement newValueElement=Factory.createSingleLeafElement(XmlTokenType.XML_ATTRIBUTE_VALUE_TOKEN,text.toCharArray(),0,text.length(),charTableByTree,element.getManager());
  compositeElement.replaceChildInternal(SourceTreeToPsiMap.psiElementToTree(elementToReplace),newValueElement);
  return element;
}
