{
  if (event instanceof KeyEvent) {
    final KeyEvent keyEvent=(KeyEvent)event;
    final int keyCode=keyEvent.getKeyCode();
    if (keyCode == myModifierKeyCode) {
      if (hasOtherModifiers(keyEvent)) {
        resetState();
        return false;
      }
      if (myActionKeyCode == -1 && ourOtherKeyWasPressed.get() && Clock.getTime() - ourLastTimePressed.get() < 500) {
        resetState();
        return false;
      }
      ourOtherKeyWasPressed.set(false);
      if (ourPressed.first.get() && Clock.getTime() - ourLastTimePressed.get() > 500) {
        resetState();
      }
      handleModifier((KeyEvent)event);
      return false;
    }
 else     if (ourPressed.first.get() && ourReleased.first.get() && ourPressed.second.get()&& myActionKeyCode != -1) {
      if (keyCode == myActionKeyCode) {
        if (event.getID() == KeyEvent.KEY_PRESSED) {
          run(keyEvent);
        }
        return true;
      }
      return false;
    }
 else {
      ourLastTimePressed.set(Clock.getTime());
      ourOtherKeyWasPressed.set(true);
      if (keyCode == KeyEvent.VK_ESCAPE || keyCode == KeyEvent.VK_TAB) {
        ourLastTimePressed.set(0);
      }
    }
    resetState();
  }
  return false;
}
