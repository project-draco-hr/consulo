{
  if (visited.contains(tag))   return;
  visited.add(tag);
  if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"element")) {
    return;
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"attribute")) {
    String use=tag.getAttributeValue("use");
    String name=tag.getAttributeValue("name");
    if (name != null) {
      if (PROHIBITED_ATTR_VALUE.equals(use)) {
        removeAttributeDescriptor(result,name);
      }
 else {
        addAttributeDescriptor(result,tag);
      }
    }
 else {
      String ref=tag.getAttributeValue("ref");
      if (ref != null) {
        if (PROHIBITED_ATTR_VALUE.equals(use)) {
          removeAttributeDescriptor(result,ref);
        }
 else {
          final String local=XmlUtil.findLocalNameByQualifiedName(ref);
          final String namespacePrefix=XmlUtil.findPrefixByQualifiedName(ref);
          final String namespace="".equals(namespacePrefix) ? myDocumentDescriptor.getDefaultNamespace() : tag.getNamespaceByPrefix(namespacePrefix);
          final XmlAttributeDescriptorImpl attributeDescriptor=myDocumentDescriptor.getAttribute(local,namespace);
          if (attributeDescriptor != null) {
            if (use != null) {
              attributeDescriptor.myUse=use;
            }
            addAttributeDescriptor(result,attributeDescriptor);
          }
        }
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"attributeGroup")) {
    String ref=tag.getAttributeValue("ref");
    if (ref != null) {
      XmlTag groupTag=myDocumentDescriptor.findAttributeGroup(ref);
      if (groupTag != null) {
        XmlTag[] tags=groupTag.getSubTags();
        for (int i=0; i < tags.length; i++) {
          XmlTag subTag=tags[i];
          collectAttributes(result,subTag,visited);
        }
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"restriction") || XmlNSDescriptorImpl.equalsToSchemaName(tag,"extension")) {
    String base=tag.getAttributeValue("base");
    if (base != null) {
      TypeDescriptor descriptor=myDocumentDescriptor.findTypeDescriptor(myDocumentDescriptor.myFile.getDocument().getRootTag(),base);
      if (descriptor instanceof ComplexTypeDescriptor) {
        ComplexTypeDescriptor complexTypeDescriptor=(ComplexTypeDescriptor)descriptor;
        complexTypeDescriptor.collectAttributes(result,complexTypeDescriptor.myTag,visited);
      }
      XmlTag[] tags=tag.getSubTags();
      for (int i=0; i < tags.length; i++) {
        XmlTag subTag=tags[i];
        collectAttributes(result,subTag,visited);
      }
    }
  }
 else {
    XmlTag[] tags=tag.getSubTags();
    for (int i=0; i < tags.length; i++) {
      XmlTag subTag=tags[i];
      collectAttributes(result,subTag,visited);
    }
  }
}
