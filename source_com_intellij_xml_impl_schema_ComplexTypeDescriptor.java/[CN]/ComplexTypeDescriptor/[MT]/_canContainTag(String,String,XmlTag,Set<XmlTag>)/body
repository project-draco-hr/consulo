{
  if (visited.contains(tag))   return false;
  visited.add(tag);
  if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"any")) {
    if (OTHER_NAMESPACE_ATTR_VALUE.equals(tag.getAttributeValue("namespace"))) {
      return namespace == null || !namespace.equals(myDocumentDescriptor.getDefaultNamespace());
    }
    return true;
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"group")) {
    String ref=tag.getAttributeValue("ref");
    if (ref != null) {
      XmlTag groupTag=myDocumentDescriptor.findGroup(ref);
      if (groupTag != null && _canContainTag(localName,namespace,groupTag,visited))       return true;
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"restriction") || XmlNSDescriptorImpl.equalsToSchemaName(tag,"extension")) {
    String base=tag.getAttributeValue("base");
    if (base != null) {
      TypeDescriptor descriptor=myDocumentDescriptor.findTypeDescriptor(myDocumentDescriptor.getTag(),base);
      if (descriptor instanceof ComplexTypeDescriptor) {
        ComplexTypeDescriptor complexTypeDescriptor=(ComplexTypeDescriptor)descriptor;
        if (complexTypeDescriptor.canContainTag(localName,namespace))         return true;
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"element")) {
    final String ref=tag.getAttributeValue("ref");
    XmlTag descriptorTag=tag;
    if (ref != null) {
      final PsiElement psiElement=tag.getAttribute("ref",null).getValueElement().getReferences()[0].resolve();
      if (psiElement instanceof XmlTag)       descriptorTag=(XmlTag)psiElement;
    }
    if ("true".equals(descriptorTag.getAttributeValue("abstract"))) {
      final XmlNSDescriptorImpl nsDescriptor=(XmlNSDescriptorImpl)tag.getNSDescriptor(namespace,true);
      final XmlElementDescriptor descriptor=nsDescriptor != null ? nsDescriptor.getElementDescriptor(localName,namespace) : null;
      final String name=descriptorTag.getAttributeValue("name");
      if (descriptor != null && name != null) {
        final String substitutionValue=((XmlTag)descriptor.getDeclaration()).getAttributeValue("substitutionGroup");
        if (substitutionValue != null && name.equals(XmlUtil.findLocalNameByQualifiedName(substitutionValue))) {
          return true;
        }
      }
    }
  }
  for (  XmlTag subTag : tag.getSubTags()) {
    if (_canContainTag(localName,namespace,subTag,visited))     return true;
  }
  return false;
}
