{
  ApplicationManager.getApplication().assertIsDispatchThread();
  PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(document);
  cleanFileLevelHighlights(project,group,psiFile);
  List<TextRange> ranges=new ArrayList<TextRange>(infos.keySet());
  Collections.sort(ranges,BY_START_OFFSET);
  for (int i=1; i < ranges.size(); i++) {
    TextRange range=ranges.get(i);
    TextRange prev=ranges.get(i - 1);
    if (prev.intersects(range)) {
      ranges.remove(i);
      TextRange union=prev.union(range);
      Collection<HighlightInfo> collection=infos.get(prev);
      collection.addAll(infos.get(range));
      infos.remove(prev);
      infos.remove(range);
      infos.put(union,collection);
      ranges.set(i - 1,union);
      i--;
    }
  }
  List<HighlightInfo> oldHighlights=DaemonCodeAnalyzerImpl.getHighlights(document,project);
  List<HighlightInfo> result=new ArrayList<HighlightInfo>();
  Map<HighlightInfo,HighlightInfo> infosToRemove=new THashMap<HighlightInfo,HighlightInfo>(BY_RANGE_MARKER_OFFSET_FIRST);
  boolean changed=false;
  if (oldHighlights != null) {
    for (    HighlightInfo info : oldHighlights) {
      RangeHighlighter highlighter=info.highlighter;
      boolean toRemove=!highlighter.isValid() || info.group == group && Collections.binarySearch(ranges,new TextRange(highlighter.getStartOffset(),highlighter.getEndOffset()),BY_START_OFFSET_OR_CONTAINS) >= 0;
      if (toRemove) {
        infosToRemove.put(info,info);
        changed=true;
      }
 else {
        result.add(info);
      }
    }
  }
  MarkupModel markup=document.getMarkupModel(project);
  for (  HighlightInfo info : getHighlightsToRemove(markup)) {
    infosToRemove.put(info,info);
  }
  result.removeAll(infosToRemove.keySet());
  List<HighlightInfo> reallyRemoved=new ArrayList<HighlightInfo>();
  Map<TextRange,RangeMarker> ranges2markersCache=new THashMap<TextRange,RangeMarker>(oldHighlights == null ? 10 : oldHighlights.size());
  for (  TextRange range : ranges) {
    int rangeStartOffset=range.getStartOffset();
    int rangeEndOffset=range.getEndOffset();
    List<HighlightInfo> highlights=new ArrayList<HighlightInfo>(infos.get(range));
    Collections.sort(highlights,new Comparator<HighlightInfo>(){
      public int compare(      HighlightInfo o1,      HighlightInfo o2){
        return o1.startOffset - o2.startOffset;
      }
    }
);
    for (    HighlightInfo info : highlights) {
      if (info.isFileLevelAnnotation && psiFile != null && psiFile.getViewProvider().isPhysical()) {
        addFileLevelHighlight(project,group,info,psiFile);
        continue;
      }
      int infoStartOffset=info.startOffset;
      int infoEndOffset=info.endOffset;
      if (infoStartOffset < rangeStartOffset || infoEndOffset > rangeEndOffset)       continue;
      if (infoEndOffset == infoStartOffset) {
        infoEndOffset++;
      }
      final int docLength=document.getTextLength();
      if (infoEndOffset > docLength) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Invalid HighlightInfo created: (" + infoStartOffset + ":"+ infoEndOffset+ ")"+ info.description);
        }
        infoEndOffset=docLength;
      }
      info.text=document.getCharsSequence().subSequence(infoStartOffset,infoEndOffset).toString();
      info.group=group;
      HighlightInfo toRemove=infosToRemove.remove(info);
      if (toRemove != null && toRemove.highlighter.isValid()) {
        info.highlighter=toRemove.highlighter;
        reallyRemoved.add(toRemove);
      }
 else {
        createRangeHighlighter(project,document,ranges2markersCache,psiFile,info,infoStartOffset,infoEndOffset,markup);
        changed=true;
      }
      ranges2markersCache.put(new TextRange(infoStartOffset,infoEndOffset),info.highlighter);
      if (info.quickFixActionRanges != null) {
        info.quickFixActionMarkers=new ArrayList<Pair<HighlightInfo.IntentionActionDescriptor,RangeMarker>>(info.quickFixActionRanges.size());
        for (        Pair<HighlightInfo.IntentionActionDescriptor,TextRange> pair : info.quickFixActionRanges) {
          TextRange textRange=pair.second;
          RangeMarker marker=getOrCreate(document,ranges2markersCache,textRange);
          info.quickFixActionMarkers.add(Pair.create(pair.first,marker));
        }
      }
      info.fixMarker=getOrCreate(document,ranges2markersCache,new TextRange(info.fixStartOffset,info.fixEndOffset));
      result.add(info);
    }
    for (    HighlightInfo info : infosToRemove.values()) {
      int infoStartOffset=info.getActualStartOffset();
      int infoEndOffset=info.getActualEndOffset();
      if (info.highlighter.isValid()) {
        if (infoStartOffset < rangeStartOffset || infoEndOffset > rangeEndOffset)         continue;
        if (info.group != group)         continue;
      }
      markup.removeHighlighter(info.highlighter);
      changed=true;
      reallyRemoved.add(info);
    }
  }
  if (changed) {
    List<HighlightInfo> toRemove=getHighlightsToRemove(markup);
    toRemove.removeAll(reallyRemoved);
    DaemonCodeAnalyzerImpl.setHighlights(document,result,project);
    clearWhiteSpaceOptimizationFlag(document);
  }
}
