{
  final DocumentChangeTransaction documentChangeTransaction=removeTransaction(document);
  if (documentChangeTransaction == null)   return;
synchronized (mySyncLock) {
    try {
      mySyncDocument=document;
      final PsiElement changeScope=documentChangeTransaction.getChangeScope();
      final PsiTreeChangeEventImpl fakeEvent=new PsiTreeChangeEventImpl(changeScope.getManager());
      fakeEvent.setParent(changeScope);
      fakeEvent.setFile(changeScope.getContainingFile());
      doSync(fakeEvent,new DocSyncAction(){
        public void syncDocument(        Document document,        PsiTreeChangeEventImpl event){
          doCommitTransaction(document,documentChangeTransaction);
        }
      }
);
      myBus.syncPublisher(PsiDocumentTransactionListener.TOPIC).transactionCompleted(document,(PsiFile)changeScope);
    }
  finally {
      mySyncDocument=null;
    }
  }
}
