{
  DocumentEx ex=(DocumentEx)document;
  ex.suppressGuardedExceptions();
  try {
    boolean isReadOnly=!document.isWritable();
    ex.setReadOnly(false);
    final List<Pair<TextRange,StringBuffer>> affectedFragments=documentChangeTransaction.getAffectedFragments();
    final Iterator<Pair<TextRange,StringBuffer>> iterator=affectedFragments.iterator();
    while (iterator.hasNext()) {
      final Pair<TextRange,StringBuffer> pair=iterator.next();
      final StringBuffer replaceBuffer=pair.getSecond();
      final TextRange range=pair.getFirst();
      if (replaceBuffer.length() == 0) {
        ex.deleteString(range.getStartOffset(),range.getEndOffset());
      }
 else       if (range.getLength() == 0) {
        ex.insertString(range.getStartOffset(),replaceBuffer);
      }
 else {
        ex.replaceString(range.getStartOffset(),range.getEndOffset(),replaceBuffer);
      }
    }
    ex.setReadOnly(isReadOnly);
  }
  finally {
    ex.unSuppressGuardedExceptions();
  }
}
