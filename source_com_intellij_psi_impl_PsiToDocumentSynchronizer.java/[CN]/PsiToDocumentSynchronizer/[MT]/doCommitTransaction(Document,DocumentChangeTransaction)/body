{
  DocumentEx ex=(DocumentEx)document;
  ex.suppressGuardedExceptions();
  try {
    boolean isReadOnly=!document.isWritable();
    ex.setReadOnly(false);
    final Set<Pair<MutableTextRange,StringBuffer>> affectedFragments=documentChangeTransaction.getAffectedFragments();
    for (    final Pair<MutableTextRange,StringBuffer> pair : affectedFragments) {
      final StringBuffer replaceBuffer=pair.getSecond();
      final MutableTextRange range=pair.getFirst();
      if (replaceBuffer.length() == 0) {
        ex.deleteString(range.getStartOffset(),range.getEndOffset());
      }
 else       if (range.getLength() == 0) {
        ex.insertString(range.getStartOffset(),replaceBuffer);
      }
 else {
        ex.replaceString(range.getStartOffset(),range.getEndOffset(),replaceBuffer);
      }
    }
    ex.setReadOnly(isReadOnly);
    if (documentChangeTransaction.getChangeScope() != null) {
      LOG.assertTrue(document.getText().equals(documentChangeTransaction.getChangeScope().getText()),"Psi to document synchronization failed (send to IK)");
    }
  }
  finally {
    ex.unSuppressGuardedExceptions();
  }
}
