{
  VirtualFile virtualFile=e.getData(PlatformDataKeys.VIRTUAL_FILE);
  VirtualFile[] files=e.getData(PlatformDataKeys.VIRTUAL_FILE_ARRAY);
  if (files != null && files.length > 1) {
    virtualFile=null;
  }
  Project project=e.getData(PlatformDataKeys.PROJECT);
  if (virtualFile != null) {
    Navigatable navigatable=e.getData(PlatformDataKeys.NAVIGATABLE);
    if (navigatable instanceof OpenFileDescriptor) {
      virtualFile=((OpenFileDescriptor)navigatable).getFile();
    }
  }
  boolean enabled=virtualFile != null && ChooseFileEncodingAction.isEnabled(project,virtualFile);
  if (enabled) {
    String pattern;
    Charset charset=ChooseFileEncodingAction.encodingFromContent(project,virtualFile);
    if (charset != null) {
      pattern="Encoding: {0}";
      enabled=false;
    }
 else     if (FileDocumentManager.getInstance().isFileModified(virtualFile)) {
      pattern="Save ''{0}''-encoded file in";
    }
 else {
      pattern="Change encoding from ''{0}'' to";
    }
    if (charset == null)     charset=virtualFile.getCharset();
    e.getPresentation().setText(MessageFormat.format(pattern,charset.toString()));
  }
 else {
    e.getPresentation().setText("Encoding");
  }
  e.getPresentation().setEnabled(enabled);
}
