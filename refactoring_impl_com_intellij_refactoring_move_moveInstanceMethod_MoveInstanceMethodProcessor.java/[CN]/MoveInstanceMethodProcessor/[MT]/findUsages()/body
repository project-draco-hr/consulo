{
  final PsiManager manager=myMethod.getManager();
  final GlobalSearchScope searchScope=GlobalSearchScope.allScope(manager.getProject());
  final PsiSearchHelper searchHelper=manager.getSearchHelper();
  final PsiReference[] refs=ReferencesSearch.search(myMethod,searchScope,false).toArray(new PsiReference[0]);
  final List<UsageInfo> usages=new ArrayList<UsageInfo>();
  for (  PsiReference ref : refs) {
    final PsiElement element=ref.getElement();
    if (element instanceof PsiReferenceExpression) {
      boolean isInternal=PsiTreeUtil.isAncestor(myMethod,element,true);
      usages.add(new MethodCallUsageInfo((PsiReferenceExpression)element,isInternal));
    }
 else     if (element instanceof PsiDocTagValue) {
      usages.add(new JavadocUsageInfo(((PsiDocTagValue)element)));
    }
 else {
      LOG.assertTrue(false,"Unknown reference found");
    }
  }
  if (myTargetClass.isInterface()) {
    addInheritorUsages(myTargetClass,searchScope,usages);
  }
  final PsiCodeBlock body=myMethod.getBody();
  if (body != null) {
    body.accept(new PsiRecursiveElementVisitor(){
      @Override public void visitNewExpression(      PsiNewExpression expression){
        if (MoveInstanceMembersUtil.getClassReferencedByThis(expression) != null) {
          usages.add(new InternalUsageInfo(expression));
        }
        super.visitNewExpression(expression);
      }
      @Override public void visitReferenceExpression(      PsiReferenceExpression expression){
        if (MoveInstanceMembersUtil.getClassReferencedByThis(expression) != null) {
          usages.add(new InternalUsageInfo(expression));
        }
 else         if (!expression.isQualified()) {
          final PsiElement resolved=expression.resolve();
          if (myTargetVariable.equals(resolved)) {
            usages.add(new InternalUsageInfo(expression));
          }
        }
        super.visitReferenceExpression(expression);
      }
    }
);
  }
  return usages.toArray(new UsageInfo[usages.size()]);
}
