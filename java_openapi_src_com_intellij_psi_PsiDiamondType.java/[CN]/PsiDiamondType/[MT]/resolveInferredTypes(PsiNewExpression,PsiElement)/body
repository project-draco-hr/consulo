{
  final PsiAnonymousClass anonymousClass=newExpression.getAnonymousClass();
  if (anonymousClass != null) {
    final PsiElement resolve=anonymousClass.getBaseClassReference().resolve();
    if (resolve instanceof PsiClass) {
      return PsiDiamondType.DiamondInferenceResult.ANONYMOUS_INNER_RESULT;
    }
  }
  final PsiReferenceParameterList referenceParameterList=PsiTreeUtil.getChildOfType(newExpression,PsiReferenceParameterList.class);
  if (referenceParameterList != null && referenceParameterList.getTypeParameterElements().length > 0) {
    return DiamondInferenceResult.EXPLICIT_CONSTRUCTOR_TYPE_ARGS;
  }
  final PsiClass psiClass=findClass(newExpression);
  if (psiClass == null)   return DiamondInferenceResult.NULL_RESULT;
  final PsiExpressionList argumentList=newExpression.getArgumentList();
  if (argumentList == null)   return DiamondInferenceResult.NULL_RESULT;
  final PsiMethod constructor=findConstructor(psiClass,newExpression);
  PsiTypeParameter[] params=getAllTypeParams(constructor,psiClass);
  PsiMethod staticFactory=generateStaticFactory(constructor,psiClass,params);
  if (staticFactory == null) {
    return DiamondInferenceResult.NULL_RESULT;
  }
  final PsiSubstitutor inferredSubstitutor=inferTypeParametersForStaticFactory(staticFactory,newExpression,context);
  final PsiTypeParameter[] parameters=staticFactory.getTypeParameters();
  final PsiTypeParameter[] classParameters=psiClass.getTypeParameters();
  final PsiJavaCodeReferenceElement classOrAnonymousClassReference=newExpression.getClassOrAnonymousClassReference();
  LOG.assertTrue(classOrAnonymousClassReference != null);
  final DiamondInferenceResult result=new DiamondInferenceResult(classOrAnonymousClassReference.getReferenceName() + "<>",newExpression.getProject());
  for (  PsiTypeParameter parameter : parameters) {
    for (    PsiTypeParameter classParameter : classParameters) {
      if (Comparing.strEqual(classParameter.getName(),parameter.getName())) {
        result.addInferredType(inferredSubstitutor.substitute(parameter));
        break;
      }
    }
  }
  return result;
}
