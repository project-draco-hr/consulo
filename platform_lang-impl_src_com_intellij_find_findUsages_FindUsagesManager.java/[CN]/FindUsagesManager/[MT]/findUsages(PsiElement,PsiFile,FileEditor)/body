{
  final FindUsagesHandler handler=getFindUsagesHandler(psiElement,false);
  if (handler == null)   return;
  boolean singleFile=scopeFile != null;
  final AbstractFindUsagesDialog dialog=handler.getFindUsagesDialog(singleFile,shouldOpenInNewTab(),mustOpenInNewTab());
  if (!singleFile) {
    dialog.show();
    if (!dialog.isOK())     return;
  }
  setOpenInNewTab(dialog.isShowInSeparateWindow());
  FindUsagesOptions findUsagesOptions=dialog.calcFindUsagesOptions();
  clearFindingNextUsageInFile();
  LOG.assertTrue(handler.getPsiElement().isValid());
  final UsageInfoToUsageConverter.TargetElementsDescriptor descriptor=new UsageInfoToUsageConverter.TargetElementsDescriptor(handler.getPrimaryElements(),handler.getSecondaryElements());
  if (singleFile) {
    findUsagesOptions=(FindUsagesOptions)findUsagesOptions.clone();
    findUsagesOptions.isDerivedClasses=false;
    findUsagesOptions.isDerivedInterfaces=false;
    findUsagesOptions.isImplementingClasses=false;
    editor.putUserData(KEY_START_USAGE_AGAIN,null);
    findUsagesInEditor(descriptor,handler,scopeFile,FileSearchScope.FROM_START,findUsagesOptions,editor);
  }
 else {
    findUsages(descriptor,handler,dialog.isSkipResultsWhenOneUsage(),dialog.isShowInSeparateWindow(),findUsagesOptions);
  }
}
