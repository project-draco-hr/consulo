{
  @Nullable Project project=PlatformDataKeys.PROJECT.getData(e.getDataContext());
  if (project == null && PlatformProjectOpenProcessor.getInstanceIfItExists() == null) {
    return;
  }
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  ArrayList<FileType> list=new ArrayList<FileType>();
  for (  FileType ft : fileTypeManager.getRegisteredFileTypes()) {
    if (fileTypeManager.getAssociatedExtensions(ft).length > 0 && (ft instanceof ProjectFileType || !ft.isReadOnly())) {
      list.add(ft);
    }
  }
  Collections.sort(list,new Comparator<FileType>(){
    public int compare(    final FileType o1,    final FileType o2){
      return o1.getName().compareTo(o2.getName());
    }
  }
);
  final FileChooserDescriptor descriptor=new FileChooserDescriptor(true,false,false,false,false,true);
  descriptor.setTitle(IdeBundle.message("title.open.file"));
  final FileChooserDialog chooser=FileChooserFactory.getInstance().createFileChooser(descriptor,project);
  final String lastFilePath=project != null ? getLastFilePath(project) : null;
  final VirtualFile toSelect=lastFilePath == null ? null : LocalFileSystem.getInstance().findFileByPath(lastFilePath);
  final VirtualFile[] result=chooser.choose(toSelect,project);
  if (result.length == 0)   return;
  for (  final VirtualFile file : result) {
    if (project != null)     setLastFilePath(project,file.getParent().getPath());
    if (isProjectFile(file.getName())) {
      int answer=Messages.showYesNoDialog(project,IdeBundle.message("message.open.file.is.project",file.getName(),ApplicationNamesInfo.getInstance().getProductName()),IdeBundle.message("title.open.project"),Messages.getQuestionIcon());
      if (answer == 0) {
        ProjectUtil.openProject(file.getPath(),project,false);
        return;
      }
    }
    FileType type=FileTypeChooser.getKnownFileTypeOrAssociate(file.getName());
    if (type == null)     return;
    if (project != null) {
      openFile(file,project);
    }
 else {
      PlatformProjectOpenProcessor.getInstance().doOpenProject(file,null,false);
    }
  }
}
