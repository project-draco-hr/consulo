{
  if (checkValidity) {
    checkTargetJPDAInstalled(parameters);
  }
  final boolean useSockets=transport == DebuggerSettings.SOCKET_TRANSPORT;
  String address="";
  if (debugPort == null || "".equals(debugPort)) {
    try {
      address=DebuggerUtils.getInstance().findAvailableDebugAddress(useSockets);
    }
 catch (    ExecutionException e) {
      if (checkValidity) {
        throw e;
      }
    }
  }
 else {
    address=debugPort;
  }
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @SuppressWarnings({"HardCodedStringLiteral"}) public void run(){
      PathUtilEx.addRtJar(parameters.getClassPath());
      boolean classicVM=shouldForceClassicVM(parameters.getJdk());
      parameters.getVMParametersList().replaceOrPrepend("-classic",classicVM ? "-classic" : "");
      final String debugKey=System.getProperty(DEBUG_KEY_NAME,"-Xdebug");
      parameters.getVMParametersList().replaceOrAppend(debugKey,debugKey);
      if (shouldForceNoJIT(parameters.getJdk())) {
        parameters.getVMParametersList().replaceOrAppend("-Xnoagent","-Xnoagent");
        parameters.getVMParametersList().replaceOrAppend("-Djava.compiler=","-Djava.compiler=NONE");
      }
    }
  }
);
  final TransportServiceWrapper transportService=TransportServiceWrapper.getTransportService(useSockets);
  final String debugAddress=(debuggerInServerMode && useSockets) ? ("127.0.0.1:" + address) : address;
  String debuggeeRunProperties="transport=" + transportService.transportId() + ",address="+ debugAddress;
  if (debuggerInServerMode) {
    debuggeeRunProperties+=",suspend=y,server=n";
  }
 else {
    debuggeeRunProperties+=",suspend=n,server=y";
  }
  if (hasWhitespace(debuggeeRunProperties)) {
    debuggeeRunProperties="\"" + debuggeeRunProperties + "\"";
  }
  parameters.getVMParametersList().replaceOrAppend("-Xrunjdwp:","-Xrunjdwp:" + debuggeeRunProperties);
  return new RemoteConnection(useSockets,"127.0.0.1",address,debuggerInServerMode);
}
