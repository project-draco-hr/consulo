{
  myLookup=lookup;
  final EditorImpl editor=(EditorImpl)myLookup.getEditor();
  myLookup.performGuardedChange(new Runnable(){
    @Override public void run(){
      CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
        public void run(){
          AccessToken token=WriteAction.start();
          try {
            String preview=text.substring(prefixLength);
            int caret=editor.getCaretModel().getOffset();
            int previewEnd=caret + preview.length();
            editor.getDocument().insertString(caret,preview);
            final RangeHighlighter highlighter=editor.getMarkupModel().addRangeHighlighter(caret,previewEnd,HighlighterLayer.LAST,new TextAttributes(JBColor.GRAY,null,null,null,Font.PLAIN),HighlighterTargetArea.EXACT_RANGE);
            editor.startDumb();
            editor.getMarkupModel().removeHighlighter(highlighter);
            editor.getDocument().deleteString(caret,previewEnd);
          }
  finally {
            token.finish();
          }
        }
      }
);
    }
  }
,"preview");
  myUninstaller=new Disposable(){
    @Override public void dispose(){
      myLookup.setPreview(null);
      myUninstaller=null;
      editor.stopDumb();
      editor.getContentComponent().repaintEditorComponent();
    }
  }
;
  myLookup.setPreview(this);
  Disposer.register(myLookup,myUninstaller);
}
