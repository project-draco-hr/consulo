{
  Point caretTop=getCaretPoint();
  EditorImpl editor=getEditorImpl();
  TextAttributes attributes=getPreviewTextAttributes();
  Font font=EditorUtil.fontForChar('W',attributes.getFontType(),editor).getFont();
  int previewWidth=editor.getComponent().getFontMetrics(font).stringWidth(previewText);
  int restLineWidth=editor.getContentComponent().getWidth() - caretTop.x;
  int lineHeight=editor.getLineHeight();
  BufferedImage textImage=UIUtil.createImage(previewWidth + restLineWidth,lineHeight,BufferedImage.TYPE_INT_RGB);
  Graphics g=textImage.getGraphics();
  UISettings.setupAntialiasing(g);
  g.setColor(attributes.getBackgroundColor());
  g.setFont(font);
  g.fillRect(0,0,previewWidth,lineHeight);
  g.setColor(JBColor.gray);
  g.drawString(previewText,0,editor.getAscent());
  g.translate(-caretTop.x + previewWidth,-caretTop.y);
  g.setClip(caretTop.x,caretTop.y,restLineWidth,lineHeight);
  editor.setRendererMode(true);
  editor.getContentComponent().paint(g);
  editor.setRendererMode(false);
  return textImage;
}
