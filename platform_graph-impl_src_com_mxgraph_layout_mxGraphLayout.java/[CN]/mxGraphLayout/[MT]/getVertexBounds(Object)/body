{
  mxRectangle geo=graph.getModel().getGeometry(vertex);
  if (useBoundingBox) {
    mxCellState state=graph.getView().getState(vertex);
    if (state != null) {
      double scale=graph.getView().getScale();
      mxRectangle tmp=state.getBoundingBox();
      double dx0=(tmp.getX() - state.getX()) / scale;
      double dy0=(tmp.getY() - state.getY()) / scale;
      double dx1=(tmp.getX() + tmp.getWidth() - state.getX() - state.getWidth()) / scale;
      double dy1=(tmp.getY() + tmp.getHeight() - state.getY() - state.getHeight()) / scale;
      geo=new mxRectangle(geo.getX() + dx0,geo.getY() + dy0,geo.getWidth() - dx0 + dx1,geo.getHeight() + -dy0 + dy1);
    }
  }
  if (this.parent != null) {
    Object parent=graph.getModel().getParent(vertex);
    geo=(mxRectangle)geo.clone();
    if (parent != null && parent != this.parent) {
      mxPoint parentOffset=getParentOffset(parent);
      geo.setX(geo.getX() + parentOffset.getX());
      geo.setY(geo.getY() + parentOffset.getY());
    }
  }
  return new mxRectangle(geo);
}
