{
  final PsiElement context=file.getContext();
  if (context != null)   file=context.getContainingFile();
  if (useIncludingFileAsContext()) {
    final FileContextProvider contextProvider=FileContextProvider.getProvider(file);
    if (contextProvider != null) {
      final Collection<PsiFileSystemItem> folders=contextProvider.getContextFolders(file);
      if (!folders.isEmpty()) {
        return folders;
      }
      final PsiFile contextFile=contextProvider.getContextFile(file);
      if (contextFile != null) {
        return Collections.<PsiFileSystemItem>singleton(contextFile.getParent());
      }
    }
  }
  VirtualFile virtualFile=file.getOriginalFile().getVirtualFile();
  if (virtualFile != null) {
    final FileReferenceHelper[] helpers=FileReferenceHelperRegistrar.getHelpers();
    final ArrayList<PsiFileSystemItem> list=new ArrayList<PsiFileSystemItem>();
    final Project project=file.getProject();
    for (    FileReferenceHelper helper : helpers) {
      if (helper.isMine(project,virtualFile)) {
        list.addAll(helper.getContexts(project,virtualFile));
      }
    }
    if (list.size() > 0) {
      return list;
    }
    final VirtualFile parent=virtualFile.getParent();
    if (parent != null) {
      final PsiDirectory directory=file.getManager().findDirectory(parent);
      if (directory != null) {
        return Collections.<PsiFileSystemItem>singleton(directory);
      }
    }
  }
  return Collections.emptyList();
}
