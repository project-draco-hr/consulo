{
  PsiElement element=editor != null ? TargetElementUtilBase.findTargetElement(editor,ourFlagsForTargetElements) : null;
  assertSameProject(element);
  if (element != null || contextElement != null) {
    final PsiElement adjusted=TargetElementUtilBase.getInstance().adjustElement(editor,ourFlagsForTargetElements,element,contextElement);
    if (adjusted != null) {
      element=adjusted;
      assertSameProject(element);
    }
  }
  if (element == null && editor != null) {
    element=getElementFromLookup(editor,file);
    assertSameProject(element);
    if (element == null) {
      final PsiReference ref=TargetElementUtilBase.findReference(editor,editor.getCaretModel().getOffset());
      if (ref != null) {
        element=TargetElementUtilBase.getInstance().adjustReference(ref);
        assertSameProject(element);
        if (element == null && ref instanceof PsiPolyVariantReference) {
          element=ref.getElement();
          assertSameProject(element);
        }
      }
    }
  }
  storeOriginalElement(myProject,contextElement,element);
  return element;
}
