{
  Set<String> allAccepted=TargetElementUtil.getAllAccepted();
  PsiElement element=assertSameProject(getElementFromLookup(editor,file));
  if (element == null && file != null) {
    final DocumentationProvider documentationProvider=getProviderFromElement(file);
    if (documentationProvider instanceof DocumentationProviderEx) {
      element=assertSameProject(((DocumentationProviderEx)documentationProvider).getCustomDocumentationElement(editor,file,contextElement));
    }
  }
  if (element == null) {
    element=assertSameProject(TargetElementUtil.findTargetElement(editor,allAccepted,offset));
    if (element != null || contextElement != null) {
      final PsiElement adjusted=assertSameProject(TargetElementUtil.adjustElement(editor,allAccepted,element,contextElement));
      if (adjusted != null) {
        element=adjusted;
      }
    }
  }
  if (element == null) {
    final PsiReference ref=TargetElementUtil.findReference(editor,offset);
    if (ref != null) {
      element=assertSameProject(TargetElementUtil.adjustReference(ref));
      if (ref instanceof PsiPolyVariantReference) {
        element=assertSameProject(ref.getElement());
      }
    }
  }
  storeOriginalElement(myProject,contextElement,element);
  return element;
}
