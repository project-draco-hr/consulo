{
  if (scopes == null)   return;
  for (  final PsiElement scope : scopes) {
    if (scope instanceof PsiPackage || scope instanceof PsiDirectory)     return;
  }
  final Module targetModule=ModuleUtil.findModuleForFile(vFile,project);
  if (targetModule == null)   return;
  final GlobalSearchScope resolveScope=GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(targetModule);
  final HashSet<PsiElement> reported=new HashSet<PsiElement>();
  for (  final PsiElement scope : scopes) {
    scope.accept(new JavaRecursiveElementVisitor(){
      @Override public void visitReferenceElement(      PsiJavaCodeReferenceElement reference){
        super.visitReferenceElement(reference);
        final PsiElement resolved=reference.resolve();
        if (resolved != null && !reported.contains(resolved) && !CommonRefactoringUtil.isAncestor(resolved,scopes) && !PsiSearchScopeUtil.isInScope(resolveScope,resolved)) {
          final String scopeDescription=RefactoringUIUtil.getDescription(ConflictsUtil.getContainer(reference),true);
          final String message=RefactoringBundle.message("0.referenced.in.1.will.not.be.accessible.in.module.2",CommonRefactoringUtil.capitalize(RefactoringUIUtil.getDescription(resolved,true)),scopeDescription,CommonRefactoringUtil.htmlEmphasize(targetModule.getName()));
          conflicts.putValue(resolved,message);
          reported.add(resolved);
        }
      }
    }
);
  }
  boolean isInTestSources=ModuleRootManager.getInstance(targetModule).getFileIndex().isInTestSourceContent(vFile);
  NextUsage:   for (  UsageInfo usage : usages) {
    if (usage instanceof MoveRenameUsageInfo) {
      final MoveRenameUsageInfo moveRenameUsageInfo=(MoveRenameUsageInfo)usage;
      final PsiElement element=usage.getElement();
      if (element != null && PsiTreeUtil.getParentOfType(element,PsiImportStatement.class,false) == null) {
        for (        PsiElement scope : scopes) {
          if (PsiTreeUtil.isAncestor(scope,element,false))           continue NextUsage;
        }
        final GlobalSearchScope resolveScope1=element.getResolveScope();
        if (!resolveScope1.isSearchInModuleContent(targetModule,isInTestSources)) {
          final PsiFile usageFile=element.getContainingFile();
          PsiElement container;
          if (usageFile instanceof PsiJavaFile) {
            container=ConflictsUtil.getContainer(element);
          }
 else {
            container=usageFile;
          }
          final String scopeDescription=RefactoringUIUtil.getDescription(container,true);
          final VirtualFile usageVFile=usageFile.getVirtualFile();
          if (usageVFile != null) {
            Module module=ProjectRootManager.getInstance(project).getFileIndex().getModuleForFile(usageVFile);
            if (module != null) {
              final String message;
              final PsiElement referencedElement=moveRenameUsageInfo.getReferencedElement();
              if (module == targetModule && isInTestSources) {
                message=RefactoringBundle.message("0.referenced.in.1.will.not.be.accessible.from.production.of.module.2",CommonRefactoringUtil.capitalize(RefactoringUIUtil.getDescription(referencedElement,true)),scopeDescription,CommonRefactoringUtil.htmlEmphasize(module.getName()));
              }
 else {
                message=RefactoringBundle.message("0.referenced.in.1.will.not.be.accessible.from.module.2",CommonRefactoringUtil.capitalize(RefactoringUIUtil.getDescription(referencedElement,true)),scopeDescription,CommonRefactoringUtil.htmlEmphasize(module.getName()));
              }
              conflicts.putValue(referencedElement,message);
            }
          }
        }
      }
    }
  }
}
