{
  final Project project=PlatformDataKeys.PROJECT.getData(DataManager.getInstance().getDataContext(editor.getComponent()));
  if (project == null) {
    if (myOriginalAction != null) {
      myOriginalAction.execute(editor,dataContext);
    }
    return;
  }
  final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  final CodeInsightSettings settings=CodeInsightSettings.getInstance();
  if (file == null || settings.ADD_IMPORTS_ON_PASTE == CodeInsightSettings.NO) {
    if (myOriginalAction != null) {
      myOriginalAction.execute(editor,dataContext);
    }
    return;
  }
  final SelectionModel selectionModel=editor.getSelectionModel();
  if (!selectionModel.hasSelection() && !selectionModel.hasBlockSelection()) {
    if (Registry.is(CopyAction.SKIP_COPY_FOR_EMPTY_SELECTION_KEY)) {
      return;
    }
    selectionModel.selectLineAtCaret();
    if (!selectionModel.hasSelection())     return;
  }
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final int[] startOffsets=selectionModel.getBlockSelectionStarts();
  final int[] endOffsets=selectionModel.getBlockSelectionEnds();
  List<TextBlockTransferableData> transferableDatas=new ArrayList<TextBlockTransferableData>();
  for (  CopyPastePostProcessor processor : Extensions.getExtensions(CopyPastePostProcessor.EP_NAME)) {
    final TextBlockTransferableData e=processor.collectTransferableData(file,editor,startOffsets,endOffsets);
    if (e != null) {
      transferableDatas.add(e);
    }
  }
  String rawText=TextBlockTransferable.convertLineSeparators(selectionModel.getSelectedText(),"\n",transferableDatas);
  String escapedText=null;
  for (  CopyPastePreProcessor processor : Extensions.getExtensions(CopyPastePreProcessor.EP_NAME)) {
    escapedText=processor.preprocessOnCopy(file,startOffsets,endOffsets,rawText);
    if (escapedText != null) {
      break;
    }
  }
  final Transferable transferable=new TextBlockTransferable(escapedText != null ? escapedText : rawText,transferableDatas,escapedText != null ? new RawText(rawText) : null);
  CopyPasteManager.getInstance().setContents(transferable);
  if (editor instanceof EditorEx) {
    EditorEx ex=(EditorEx)editor;
    if (ex.isStickySelection()) {
      ex.setStickySelection(false);
    }
  }
}
