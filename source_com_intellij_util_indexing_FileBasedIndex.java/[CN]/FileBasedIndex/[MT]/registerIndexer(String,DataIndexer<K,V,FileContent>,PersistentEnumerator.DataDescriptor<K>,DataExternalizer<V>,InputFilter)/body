{
  final File storageFile=getStorageFile(name);
  MapIndexStorage<K,V> _storage=null;
  boolean requiresRebuild=false;
  int initAttempt=0;
  final int maxAttempts=2;
  while (initAttempt < maxAttempts) {
    initAttempt++;
    requiresRebuild=!storageFile.exists();
    try {
      _storage=new MapIndexStorage<K,V>(storageFile,keyDescriptor,valueExternalizer);
      break;
    }
 catch (    IOException e) {
      if (initAttempt < maxAttempts) {
        FileUtil.delete(storageFile);
      }
 else {
        throw e;
      }
    }
  }
  final MapIndexStorage<K,V> storage=_storage;
  myDisposables.add(new Disposable(){
    public void dispose(){
      try {
        storage.close();
      }
 catch (      StorageException e) {
        LOG.error(e);
      }
    }
  }
);
  final MemoryIndexStorage<K,V> wbStorage=new MemoryIndexStorage<K,V>(storage);
  myStartDataBuffering.addTask(new Runnable(){
    public void run(){
      wbStorage.setBufferingEnabled(true);
    }
  }
);
  myStopDataBuffering.addTask(new Runnable(){
    public void run(){
      wbStorage.setBufferingEnabled(false);
    }
  }
);
  final MapReduceIndex<?,?,FileContent> index=new MapReduceIndex<K,V,FileContent>(indexer,wbStorage);
  myIndices.put(name,new Pair<UpdatableIndex<?,?,FileContent>,InputFilter>(index,filter));
  myCompositeFilter.addFilter(filter);
  myFlushStorages.addTask(new Runnable(){
    public void run(){
      storage.flush();
    }
  }
);
  return requiresRebuild;
}
