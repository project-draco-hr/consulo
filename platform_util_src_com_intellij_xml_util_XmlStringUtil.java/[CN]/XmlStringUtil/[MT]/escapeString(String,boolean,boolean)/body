{
  if (str == null)   return null;
  StringBuilder buffer=null;
  for (int i=0; i < str.length(); i++) {
    @NonNls String entity;
    char ch=str.charAt(i);
switch (ch) {
case '\n':
      entity=escapeWhiteSpace ? "&#10;" : null;
    break;
case '\r':
  entity=escapeWhiteSpace ? "&#13;" : null;
break;
case '\t':
entity=escapeWhiteSpace ? "&#9;" : null;
break;
case '\"':
entity=QUOT;
break;
case '<':
entity=LT;
break;
case '>':
entity=GT;
break;
case '&':
entity=AMP;
break;
case 160:
entity=convertNoBreakSpace ? NBSP : null;
break;
default :
entity=null;
break;
}
if (buffer == null) {
if (entity != null) {
buffer=new StringBuilder(str.length() + 20);
buffer.append(str.substring(0,i));
buffer.append(entity);
}
}
 else {
if (entity == null) {
buffer.append(ch);
}
 else {
buffer.append(entity);
}
}
}
return buffer == null ? str : buffer.toString();
}
