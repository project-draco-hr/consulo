{
  Presentation presentation=e.getPresentation();
  final Project project=e.getData(PlatformDataKeys.PROJECT);
  DiffRequest diffRequest=e.getData(DIFF_REQUEST);
  if (diffRequest == null) {
    final VirtualFile[] virtualFiles=e.getData(PlatformDataKeys.VIRTUAL_FILE_ARRAY);
    if (virtualFiles == null || virtualFiles.length != 2) {
      presentation.setVisible(false);
      return;
    }
    diffRequest=getDiffRequest(project,virtualFiles);
  }
  if (diffRequest == null) {
    presentation.setVisible(false);
    return;
  }
  final boolean canShow=!diffRequest.isSafeToCallFromUpdate() || DiffManager.getInstance().getDiffTool().canShow(diffRequest);
  if (ActionPlaces.isPopupPlace(e.getPlace())) {
    presentation.setVisible(canShow);
  }
 else {
    presentation.setVisible(true);
    presentation.setEnabled(canShow);
  }
}
