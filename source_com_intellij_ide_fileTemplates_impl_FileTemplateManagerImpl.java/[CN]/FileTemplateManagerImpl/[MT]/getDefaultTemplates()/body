{
  if (myDefaultTemplatesDir == null || myDefaultTemplatesDir.length() == 0) {
    return VirtualFile.EMPTY_ARRAY;
  }
  VirtualFile[] topDirs=getTopTemplatesDir();
  if (LOG.isDebugEnabled()) {
    String message="Top dirs found: ";
    for (int i=0; i < topDirs.length; i++) {
      VirtualFile topDir=topDirs[i];
      message+=(i > 0 ? ", " : "") + topDir.getPresentableUrl();
    }
    LOG.debug(message);
  }
  Set<VirtualFile> templatesList=new HashSet<VirtualFile>();
  for (int i=0; i < topDirs.length; i++) {
    VirtualFile topDir=topDirs[i];
    VirtualFile parentDir=myDefaultTemplatesDir.equals(".") ? topDir : topDir.findChild(myDefaultTemplatesDir);
    if (parentDir != null) {
      templatesList.addAll(listDir(parentDir));
    }
  }
  removeDeletedTemplates(templatesList);
  return (VirtualFile[])templatesList.toArray(new VirtualFile[templatesList.size()]);
}
