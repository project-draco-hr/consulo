{
  int i=0;
  while (expression.getParent() instanceof PsiExpression) {
    i++;
    final PsiExpression parent=(PsiExpression)expression.getParent();
    if (parent instanceof PsiConditionalExpression && ((PsiConditionalExpression)parent).getCondition() == expression)     break;
    expression=parent;
    if (expression instanceof PsiAssignmentExpression)     break;
    if (i > 10 && expression instanceof PsiBinaryExpression) {
      ParameterizedCachedValue<PsiExpression,Pair<Project,PsiExpression>> value=expression.getUserData(TOP_LEVEL_EXPRESSION);
      if (value != null && value.hasUpToDateValue()) {
        return getToplevelExpression(project,expression);
      }
    }
  }
  return expression;
}
