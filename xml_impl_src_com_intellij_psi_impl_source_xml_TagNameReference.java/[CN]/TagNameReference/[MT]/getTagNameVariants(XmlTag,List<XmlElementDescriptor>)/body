{
  final Map<String,XmlElementDescriptor> descriptorsMap=new HashMap<String,XmlElementDescriptor>();
  XmlElementDescriptor elementDescriptor=null;
  String elementNamespace=null;
{
    PsiElement curElement=element.getParent();
    while (curElement instanceof XmlTag) {
      final XmlTag declarationTag=(XmlTag)curElement;
      final String namespace=declarationTag.getNamespace();
      if (!descriptorsMap.containsKey(namespace)) {
        final XmlElementDescriptor descriptor=declarationTag.getDescriptor();
        if (descriptor != null) {
          descriptorsMap.put(namespace,descriptor);
          if (elementDescriptor == null) {
            elementDescriptor=descriptor;
            elementNamespace=namespace;
          }
        }
      }
      curElement=curElement.getContext();
    }
  }
  final List<String> namespaces=new ArrayList<String>(Arrays.asList(element.knownNamespaces()));
  namespaces.add(XmlUtil.EMPTY_URI);
  final Iterator<String> nsIterator=namespaces.iterator();
  final Set<XmlNSDescriptor> visited=new HashSet<XmlNSDescriptor>();
  while (nsIterator.hasNext()) {
    final String namespace=nsIterator.next();
    if (descriptorsMap.containsKey(namespace)) {
      final XmlElementDescriptor descriptor=descriptorsMap.get(namespace);
      if (isAcceptableNs(element,elementDescriptor,elementNamespace,namespace)) {
        for (        XmlElementDescriptor containedDescriptor : descriptor.getElementsDescriptors(element)) {
          if (containedDescriptor != null)           variants.add(containedDescriptor);
        }
      }
      if (element instanceof HtmlTag) {
        HtmlUtil.addHtmlSpecificCompletions(descriptor,element,variants);
      }
      visited.add(descriptor.getNSDescriptor());
    }
 else {
      if (namespace == null)       continue;
      if (namespace.length() == 0 && !visited.isEmpty())       continue;
      XmlNSDescriptor nsDescriptor=getDescriptor(element,namespace,true);
      if (nsDescriptor == null) {
        if (!descriptorsMap.isEmpty())         continue;
        nsDescriptor=getDescriptor(element,namespace,false);
      }
      if (nsDescriptor != null && !visited.contains(nsDescriptor) && isAcceptableNs(element,elementDescriptor,elementNamespace,namespace)) {
        visited.add(nsDescriptor);
        final XmlElementDescriptor[] rootElementsDescriptors=nsDescriptor.getRootElementsDescriptors(PsiTreeUtil.getParentOfType(element,XmlDocument.class));
        XmlTag parentTag=element.getParentTag();
        XmlElementDescriptor parentDescriptor=elementDescriptor;
        if (XmlUtil.JSP_URI.equals(namespace)) {
          JspFile file=PsiUtil.getJspFile(element);
          if (file.getFileType() == StdFileTypes.JSP) {
            final XmlTag jspRootTag=file.getDocument().getRootTag();
            if (jspRootTag != null) {
              parentDescriptor=(parentTag=jspRootTag).getDescriptor();
            }
          }
        }
        for (        XmlElementDescriptor containedDescriptor : rootElementsDescriptors) {
          if (containedDescriptor != null && couldContainDescriptor(parentTag,parentDescriptor,containedDescriptor,namespace)) {
            variants.add(containedDescriptor);
          }
        }
      }
    }
  }
  final Iterator<XmlElementDescriptor> iterator=variants.iterator();
  String[] ret=new String[variants.size()];
  int index=0;
  while (iterator.hasNext()) {
    final XmlElementDescriptor descriptor=iterator.next();
    ret[index++]=descriptor.getName(element);
  }
  return ret;
}
