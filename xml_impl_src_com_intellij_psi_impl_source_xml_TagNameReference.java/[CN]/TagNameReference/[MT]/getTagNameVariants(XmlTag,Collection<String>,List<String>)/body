{
  XmlElementDescriptor elementDescriptor=null;
  String elementNamespace=null;
  final Map<String,XmlElementDescriptor> descriptorsMap=new HashMap<String,XmlElementDescriptor>();
  PsiElement context=element.getParent();
  PsiElement curElement=element.getParent();
{
    while (curElement instanceof XmlTag) {
      final XmlTag declarationTag=(XmlTag)curElement;
      final String namespace=declarationTag.getNamespace();
      if (!descriptorsMap.containsKey(namespace)) {
        final XmlElementDescriptor descriptor=declarationTag.getDescriptor();
        if (descriptor != null) {
          descriptorsMap.put(namespace,descriptor);
          if (elementDescriptor == null) {
            elementDescriptor=descriptor;
            elementNamespace=namespace;
          }
        }
      }
      curElement=curElement.getContext();
    }
  }
  final Iterator<String> nsIterator=namespaces.iterator();
  final Set<XmlNSDescriptor> visited=new HashSet<XmlNSDescriptor>();
  final ArrayList<XmlElementDescriptor> variants=new ArrayList<XmlElementDescriptor>();
  while (nsIterator.hasNext()) {
    final String namespace=nsIterator.next();
    final int initialSize=variants.size();
    processVariantsInNamespace(namespace,element,variants,elementDescriptor,elementNamespace,descriptorsMap,visited,context instanceof XmlTag ? (XmlTag)context : element);
    if (nsInfo != null) {
      for (int i=initialSize; i < variants.size(); i++) {
        nsInfo.add(namespace);
      }
    }
  }
  final Iterator<XmlElementDescriptor> iterator=variants.iterator();
  String[] ret=new String[variants.size()];
  int index=0;
  while (iterator.hasNext()) {
    final XmlElementDescriptor descriptor=iterator.next();
    ret[index++]=descriptor.getName(element);
  }
  return ret;
}
