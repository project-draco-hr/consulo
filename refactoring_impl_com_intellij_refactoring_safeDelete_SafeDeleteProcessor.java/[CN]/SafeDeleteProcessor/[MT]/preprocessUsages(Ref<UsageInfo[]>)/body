{
  UsageInfo[] usages=refUsages.get();
  ArrayList<String> conflicts=new ArrayList<String>();
  for (  PsiElement element : myElements) {
    if (element instanceof PsiMethod) {
      final PsiClass containingClass=((PsiMethod)element).getContainingClass();
      if (!containingClass.hasModifierProperty(PsiModifier.ABSTRACT)) {
        final PsiMethod[] superMethods=((PsiMethod)element).findSuperMethods();
        for (        PsiMethod superMethod : superMethods) {
          if (isInside(superMethod,myElements))           continue;
          if (superMethod.hasModifierProperty(PsiModifier.ABSTRACT)) {
            String message=RefactoringBundle.message("0.implements.1",ConflictsUtil.getDescription(element,true),ConflictsUtil.getDescription(superMethod,true));
            conflicts.add(message);
            break;
          }
        }
      }
    }
  }
  final HashMap<PsiElement,UsageHolder> elementsToUsageHolders=sortUsages(usages);
  final Collection<UsageHolder> usageHolders=elementsToUsageHolders.values();
  for (  UsageHolder usageHolder : usageHolders) {
    if (usageHolder.getNonCodeUsagesNumber() != usageHolder.getUnsafeUsagesNumber()) {
      final String description=usageHolder.getDescription();
      if (description != null) {
        conflicts.add(description);
      }
    }
  }
  if (conflicts.size() > 0) {
    if (!ApplicationManager.getApplication().isUnitTestMode()) {
      UnsafeUsagesDialog dialog=new UnsafeUsagesDialog(conflicts.toArray(new String[conflicts.size()]),myProject);
      dialog.show();
      if (!dialog.isOK()) {
        final int exitCode=dialog.getExitCode();
        prepareSuccessful();
        if (exitCode == UnsafeUsagesDialog.VIEW_USAGES_EXIT_CODE) {
          showUsages(usages);
        }
        return false;
      }
 else {
        myPreviewNonCodeUsages=false;
      }
    }
  }
  final UsageInfo[] filteredUsages=filterAndQueryOverriding(usages);
  prepareSuccessful();
  if (filteredUsages == null) {
    return false;
  }
  refUsages.set(filteredUsages);
  return true;
}
