{
  final String text=document == null ? null : document.getText();
  return new ChooseFileEncodingAction(myFile){
    @Override public void update(    final AnActionEvent e){
    }
    @NotNull @Override protected DefaultActionGroup createPopupActionGroup(    JComponent button){
      return createCharsetsActionGroup(clearItemText,null,new Function<Charset,String>(){
        @Override public String fun(        Charset charset){
          EncodingUtil.Magic8 safeToReload=myFile.isDirectory() ? EncodingUtil.Magic8.ABSOLUTELY : EncodingUtil.isSafeToReloadIn(myFile,text,bytes,charset);
          EncodingUtil.Magic8 safeToConvert=myFile.isDirectory() ? EncodingUtil.Magic8.ABSOLUTELY : EncodingUtil.isSafeToConvertTo(myFile,text,bytes,charset);
          boolean enabled=safeToReload != EncodingUtil.Magic8.NO_WAY || safeToConvert != EncodingUtil.Magic8.NO_WAY;
          return enabled ? "Change encoding to '" + charset.displayName() + "'" : null;
        }
      }
);
    }
    @Override protected void chosen(    @Nullable VirtualFile virtualFile,    @NotNull Charset charset){
      if (virtualFile != null) {
        ChangeFileEncodingAction.this.chosen(document,editor,virtualFile,bytes,charset);
      }
    }
  }
.createPopupActionGroup(null);
}
