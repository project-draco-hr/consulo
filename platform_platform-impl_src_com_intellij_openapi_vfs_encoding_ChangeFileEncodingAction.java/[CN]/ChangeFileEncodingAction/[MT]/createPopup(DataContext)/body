{
  final VirtualFile virtualFile=PlatformDataKeys.VIRTUAL_FILE.getData(dataContext);
  if (virtualFile == null)   return null;
  boolean enabled=checkEnabled(virtualFile);
  if (!enabled)   return null;
  Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  FileDocumentManager documentManager=FileDocumentManager.getInstance();
  final Document document=documentManager.getDocument(virtualFile);
  if (!allowDirectories && virtualFile.isDirectory() || document == null && !virtualFile.isDirectory())   return null;
  final byte[] bytes;
  try {
    bytes=virtualFile.isDirectory() ? null : virtualFile.contentsToByteArray();
  }
 catch (  IOException e) {
    return null;
  }
  DefaultActionGroup group=createActionGroup(virtualFile,editor,document,bytes,null);
  return JBPopupFactory.getInstance().createActionGroupPopup(getTemplatePresentation().getText(),group,dataContext,JBPopupFactory.ActionSelectionAid.SPEEDSEARCH,false);
}
