{
  UsageInfo[] usagesIn=refUsages.get();
  MultiMap<PsiElement,String> conflicts=new MultiMap<PsiElement,String>();
  RenameUtil.addConflictDescriptions(usagesIn,conflicts);
  RenamePsiElementProcessor.forElement(myPrimaryElement).findExistingNameConflicts(myPrimaryElement,myNewName,conflicts);
  if (!conflicts.isEmpty()) {
    ConflictsDialog conflictsDialog=new ConflictsDialog(myProject,conflicts);
    conflictsDialog.show();
    if (!conflictsDialog.isOK()) {
      if (conflictsDialog.isShowConflicts())       prepareSuccessful();
      return false;
    }
  }
  Set<UsageInfo> usagesSet=new HashSet<UsageInfo>(Arrays.asList(usagesIn));
  RenameUtil.removeConflictUsages(usagesSet);
  final List<UsageInfo> variableUsages=new ArrayList<UsageInfo>();
  if (!myRenamers.isEmpty()) {
    if (!findRenamedVariables(variableUsages))     return false;
    for (    final AutomaticRenamer renamer : myRenamers) {
      final List<? extends PsiNamedElement> variables=renamer.getElements();
      for (      final PsiNamedElement variable : variables) {
        final String newName=renamer.getNewName(variable);
        if (newName != null) {
          addElement(variable,newName);
        }
      }
    }
  }
  if (!variableUsages.isEmpty()) {
    usagesSet.addAll(variableUsages);
    refUsages.set(usagesSet.toArray(new UsageInfo[usagesSet.size()]));
  }
  prepareSuccessful();
  return true;
}
