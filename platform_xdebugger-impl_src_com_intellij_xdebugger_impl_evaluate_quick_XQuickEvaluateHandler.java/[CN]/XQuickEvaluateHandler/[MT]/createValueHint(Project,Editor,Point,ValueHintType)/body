{
  final XDebugSession session=XDebuggerManager.getInstance(project).getCurrentSession();
  if (session == null)   return null;
  XStackFrame stackFrame=session.getCurrentStackFrame();
  if (stackFrame == null)   return null;
  final XDebuggerEvaluator evaluator=stackFrame.getEvaluator();
  if (evaluator == null)   return null;
  return PsiDocumentManager.getInstance(project).commitAndRunReadAction(new Computable<XValueHint>(){
    public XValueHint compute(){
      int offset=AbstractValueHint.calculateOffset(editor,point);
      TextRange range=getExpressionRange(evaluator,project,type,editor,offset);
      if (range == null)       return null;
      int textLength=editor.getDocument().getTextLength();
      if (range.getStartOffset() > range.getEndOffset() || range.getStartOffset() < 0 || range.getEndOffset() > textLength) {
        LOG.error("invalid range: " + range + ", text length = "+ textLength+ ", evaluator: "+ evaluator);
        return null;
      }
      return new XValueHint(project,editor,point,type,range,evaluator,session);
    }
  }
);
}
