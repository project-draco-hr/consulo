{
  File directory=getKeymapDirectory(true);
  if (directory == null) {
    LOG.error("Keymap directory does not exist and cannot be created");
    return;
  }
  File[] files=getKeymapFiles();
  ArrayList<String> filePaths=new ArrayList<String>();
  ArrayList<Document> documents=new ArrayList<Document>();
  UniqueFileNamesProvider namesProvider=new UniqueFileNamesProvider();
  for (  final Keymap keymap : myKeymaps) {
    if (!keymap.canModify()) {
      continue;
    }
    Document document=new Document(((KeymapImpl)keymap).writeExternal());
    String filePath=directory.getAbsolutePath() + File.separator + namesProvider.suggestName(keymap.getName())+ '.'+ XML_FILE_EXT;
    filePaths.add(filePath);
    documents.add(document);
  }
  JDOMUtil.updateFileSet(files,filePaths.toArray(new String[filePaths.size()]),documents.toArray(new Document[documents.size()]),CodeStyleSettingsManager.getSettings(null).getLineSeparator());
}
