{
  try {
    return ApplicationManager.getApplication().runReadAction(new Computable<GeneralCommandLine>(){
      public GeneralCommandLine compute(){
        try {
          final GeneralCommandLine commandLine=new GeneralCommandLine();
          final ProjectJdk jdk=javaParameters.getJdk();
          if (jdk == null) {
            throw new CantRunException(ExecutionBundle.message("run.configuration.error.no.jdk.specified"));
          }
          final String exePath=jdk.getVMExecutablePath();
          if (exePath == null) {
            throw new CantRunException(ExecutionBundle.message("run.configuration.cannot.find.vm.executable"));
          }
          commandLine.setExePath(exePath);
          ParametersList parametersList=javaParameters.getVMParametersList();
          commandLine.addParameters(parametersList.getList());
          if (!parametersList.hasProperty("file.encoding")) {
            Charset charset=javaParameters.getCharset();
            if (charset == null)             charset=CharsetToolkit.getIDEOptionsCharset();
            if (charset == null)             charset=CharsetToolkit.getDefaultSystemCharset();
            commandLine.setCharset(charset);
          }
          if (!parametersList.hasParameter("-classpath") && !parametersList.hasParameter("-cp")) {
            commandLine.addParameter("-classpath");
            commandLine.addParameter(javaParameters.getClassPath().getPathsString());
          }
          String mainClass=javaParameters.getMainClass();
          if (mainClass == null)           throw new CantRunException(ExecutionBundle.message("main.class.is.not.specified.error.message"));
          commandLine.addParameter(mainClass);
          commandLine.addParameters(javaParameters.getProgramParametersList().getList());
          commandLine.setWorkDirectory(javaParameters.getWorkingDirectory());
          final Map<String,String> env=javaParameters.getEnv();
          if (env != null) {
            commandLine.setEnvParams(env);
          }
          return commandLine;
        }
 catch (        CantRunException e) {
          throw new RuntimeException(e);
        }
      }
    }
);
  }
 catch (  RuntimeException e) {
    if (e.getCause() instanceof CantRunException)     throw ((CantRunException)e.getCause());
 else     throw e;
  }
}
