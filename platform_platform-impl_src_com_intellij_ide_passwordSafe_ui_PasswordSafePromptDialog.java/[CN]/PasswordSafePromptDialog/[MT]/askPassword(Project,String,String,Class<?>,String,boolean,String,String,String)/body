{
  final PasswordSafeImpl ps=(PasswordSafeImpl)PasswordSafe.getInstance();
  try {
    if (resetPassword) {
      ps.removePassword(project,requester,key);
    }
 else {
      String pw=ps.getPassword(project,requester,key);
      if (pw != null) {
        return pw;
      }
    }
  }
 catch (  PasswordSafeException ex) {
    if (LOG.isDebugEnabled()) {
      LOG.debug("Failed to retrieve or reset password",ex);
    }
  }
  final AtomicReference<String> pw=new AtomicReference<String>(null);
  ApplicationManager.getApplication().invokeAndWait(new Runnable(){
    public void run(){
      final PasswordSafePromptDialog d=new PasswordSafePromptDialog(project,ps,title,message);
      if (promptLabel != null) {
        d.myPromptLabel.setText(promptLabel);
      }
      if (checkboxLabel != null) {
        d.myRememberThePasswordCheckBox.setText(checkboxLabel);
      }
      d.init();
      d.setErrorText(error);
      d.show();
      if (d.isOK()) {
        String p=new String(d.myPasswordPasswordField.getPassword());
        pw.set(p);
        if (d.myRememberThePasswordCheckBox.isSelected()) {
          try {
            ps.storePassword(project,requester,key,p);
          }
 catch (          PasswordSafeException e) {
            Messages.showErrorDialog(project,e.getMessage(),"Failed to store password");
            if (LOG.isDebugEnabled()) {
              LOG.debug("Failed to store password",e);
            }
          }
        }
      }
    }
  }
,ModalityState.NON_MODAL);
  return pw.get();
}
