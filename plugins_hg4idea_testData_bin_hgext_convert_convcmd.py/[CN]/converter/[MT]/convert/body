def convert(self, sortmode):
    try:
        self.source.before()
        self.dest.before()
        self.source.setrevmap(self.map)
        self.ui.status(_('scanning source...\n'))
        heads = self.source.getheads()
        parents = self.walktree(heads)
        self.ui.status(_('sorting...\n'))
        t = self.toposort(parents, sortmode)
        num = len(t)
        c = None
        self.ui.status(_('converting...\n'))
        for c in t:
            num -= 1
            desc = self.commitcache[c].desc
            if ('\n' in desc):
                desc = desc.splitlines()[0]
            self.ui.status(('%d %s\n' % (num, recode(desc))))
            self.ui.note((_('source: %s\n') % recode(c)))
            self.copy(c)
        tags = self.source.gettags()
        ctags = {}
        for k in tags:
            v = tags[k]
            if (self.map.get(v, SKIPREV) != SKIPREV):
                ctags[k] = self.map[v]
        if (c and ctags):
            (nrev, tagsparent) = self.dest.puttags(ctags)
            if (nrev and tagsparent):
                tagsparents = [e for e in self.map.iteritems() if (e[1] == tagsparent)]
                if tagsparents:
                    self.map[tagsparents[0][0]] = nrev
        self.writeauthormap()
    finally:
        self.cleanup()
