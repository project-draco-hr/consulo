def convert(ui, src, dest=None, revmapfile=None, **opts):
    global orig_encoding
    orig_encoding = encoding.encoding
    encoding.encoding = 'UTF-8'
    if (not dest):
        dest = (hg.defaultdest(src) + '-hg')
        ui.status((_('assuming destination %s\n') % dest))
    destc = convertsink(ui, dest, opts.get('dest_type'))
    try:
        (srcc, defaultsort) = convertsource(ui, src, opts.get('source_type'), opts.get('rev'))
    except Exception:
        for path in destc.created:
            shutil.rmtree(path, True)
        raise
    sortmodes = ('branchsort', 'datesort', 'sourcesort')
    sortmode = [m for m in sortmodes if opts.get(m)]
    if (len(sortmode) > 1):
        raise util.Abort(_('more than one sort mode specified'))
    sortmode = ((sortmode and sortmode[0]) or defaultsort)
    if ((sortmode == 'sourcesort') and (not srcc.hasnativeorder())):
        raise util.Abort(_('--sourcesort is not supported by this data source'))
    fmap = opts.get('filemap')
    if fmap:
        srcc = filemap.filemap_source(ui, srcc, fmap)
        destc.setfilemapmode(True)
    if (not revmapfile):
        try:
            revmapfile = destc.revmapfile()
        except:
            revmapfile = os.path.join(destc, 'map')
    c = converter(ui, srcc, destc, revmapfile, opts)
    c.convert(sortmode)
