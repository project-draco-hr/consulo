{
  final PsiFile psiFile=atCaret.getContainingFile();
  final RangeMarker rangeMarker=createRangeMarker(atCaret);
  if (myFirstErrorOffset != Integer.MAX_VALUE) {
    myEditor.getCaretModel().moveToOffset(myFirstErrorOffset);
    reformat(atCaret);
    return;
  }
  reformat(atCaret);
  PsiDocumentManager.getInstance(myProject).commitDocument(myEditor.getDocument());
  atCaret=CodeInsightUtil.findElementInRange(psiFile,rangeMarker.getStartOffset(),rangeMarker.getEndOffset(),atCaret.getClass());
  for (  EnterProcessor processor : ourEnterProcessors) {
    if (atCaret == null) {
      LOG.error("Can't restore element at caret after enter processor execution!");
      break;
    }
    if (processor.doEnter(myEditor,atCaret,isModified()))     return;
  }
  if (!isModified()) {
    plainEnter();
  }
 else {
    if (myFirstErrorOffset == Integer.MAX_VALUE) {
      myEditor.getCaretModel().moveToOffset(rangeMarker.getEndOffset());
    }
 else {
      myEditor.getCaretModel().moveToOffset(myFirstErrorOffset);
    }
  }
}
