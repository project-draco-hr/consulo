{
  int caretOffset=myEditor.getCaretModel().getOffset();
  final CharSequence chars=myEditor.getDocument().getCharsSequence();
  if (CharArrayUtil.regionMatches(chars,caretOffset,"{}")) {
    caretOffset+=2;
  }
 else   if (CharArrayUtil.regionMatches(chars,caretOffset,"{\n}")) {
    caretOffset+=3;
  }
  caretOffset=CharArrayUtil.shiftBackward(chars,caretOffset - 1," \t") + 1;
  if (CharArrayUtil.regionMatches(chars,caretOffset - "{}".length(),"{}") || CharArrayUtil.regionMatches(chars,caretOffset - "{\n}".length(),"{\n}")) {
    commit();
    final CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(myProject);
    final boolean old=settings.KEEP_SIMPLE_BLOCKS_IN_ONE_LINE;
    settings.KEEP_SIMPLE_BLOCKS_IN_ONE_LINE=false;
    PsiElement elt=PsiTreeUtil.getParentOfType(myPsiFile.findElementAt(caretOffset - 1),PsiCodeBlock.class);
    reformat(elt);
    settings.KEEP_SIMPLE_BLOCKS_IN_ONE_LINE=old;
    myEditor.getCaretModel().moveToOffset(caretOffset - 1);
  }
}
