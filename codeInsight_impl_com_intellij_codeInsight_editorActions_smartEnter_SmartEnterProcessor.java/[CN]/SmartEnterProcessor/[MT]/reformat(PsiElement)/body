{
  PsiElement parent=atCaret.getParent();
  if (parent instanceof PsiCodeBlock) {
    final PsiCodeBlock block=(PsiCodeBlock)parent;
    if (block.getStatements().length > 0 && block.getStatements()[0] == atCaret) {
      atCaret=block;
    }
  }
 else   if (parent instanceof PsiForStatement) {
    atCaret=parent;
  }
  final TextRange range=atCaret.getTextRange();
  final PsiFile file=atCaret.getContainingFile();
  final PsiFile baseFile=file.getViewProvider().getPsi(file.getViewProvider().getBaseLanguage());
  CodeStyleManager.getInstance(myProject).reformatText(baseFile,range.getStartOffset(),range.getEndOffset());
}
