{
  if (LOG.isDebugEnabled()) {
    LOG.debug("refreshFileStatusFromDocument: file.getModificationStamp()=" + virtualFile.getModificationStamp() + ", document.getModificationStamp()="+ doc.getModificationStamp());
  }
  FileStatus cachedStatus=myFileStatusManager.getCachedStatus(virtualFile);
  if (cachedStatus == null || cachedStatus == FileStatus.NOT_CHANGED || !isDocumentModified(virtualFile)) {
    final AbstractVcs vcs=myVcsManager.getVcsFor(virtualFile);
    if (vcs == null)     return;
    if (cachedStatus == FileStatus.MODIFIED && !isDocumentModified(virtualFile)) {
      if (!((ReadonlyStatusHandlerImpl)ReadonlyStatusHandlerImpl.getInstance(myProject)).getState().SHOW_DIALOG) {
        RollbackEnvironment rollbackEnvironment=vcs.getRollbackEnvironment();
        if (rollbackEnvironment != null) {
          rollbackEnvironment.rollbackIfUnchanged(virtualFile);
        }
      }
    }
    myFileStatusManager.fileStatusChanged(virtualFile);
    ChangeProvider cp=vcs.getChangeProvider();
    if (cp != null && cp.isModifiedDocumentTrackingRequired()) {
      myDirtyScopeManager.fileDirty(virtualFile);
    }
  }
}
