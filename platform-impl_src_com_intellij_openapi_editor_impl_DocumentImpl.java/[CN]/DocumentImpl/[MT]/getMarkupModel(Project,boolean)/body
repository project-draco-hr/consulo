{
  if (project == null) {
    MarkupModelEx markupModel=myMarkupModel;
    if (create && markupModel == null) {
synchronized (lock) {
        markupModel=myMarkupModel;
        if (markupModel == null) {
          myMarkupModel=markupModel=new MarkupModelImpl(this);
        }
      }
    }
    return markupModel;
  }
  final DocumentMarkupModelManager documentMarkupModelManager=project.isDisposed() ? null : DocumentMarkupModelManager.getInstance(project);
  if (documentMarkupModelManager == null || documentMarkupModelManager.isDisposed()) {
    return new EmptyMarkupModel(this);
  }
  MarkupModel model=myProjectToMarkupModelMap.get(project);
  if (create && model == null) {
    model=ConcurrencyUtil.cacheOrGet(myProjectToMarkupModelMap,project,new MarkupModelImpl(this));
    documentMarkupModelManager.registerDocument(this);
  }
  return model;
}
