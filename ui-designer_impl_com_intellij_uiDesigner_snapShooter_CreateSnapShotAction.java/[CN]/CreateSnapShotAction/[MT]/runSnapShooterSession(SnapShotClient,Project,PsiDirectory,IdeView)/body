{
  try {
    client.suspendSwing();
  }
 catch (  IOException e1) {
    Messages.showMessageDialog(project,UIDesignerBundle.message("snapshot.connection.error"),UIDesignerBundle.message("snapshot.title"),Messages.getInformationIcon());
    return;
  }
  final MyDialog dlg=new MyDialog(project,client,dir);
  dlg.show();
  if (dlg.getExitCode() == DialogWrapper.OK_EXIT_CODE) {
    final int id=dlg.getSelectedComponentId();
    final Ref<Object> result=new Ref<Object>();
    ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
      public void run(){
        try {
          result.set(client.createSnapshot(id));
        }
 catch (        Exception ex) {
          result.set(ex);
        }
      }
    }
,UIDesignerBundle.message("progress.creating.snapshot"),false,project);
    String snapshot=null;
    if (result.get() instanceof String) {
      snapshot=(String)result.get();
    }
 else {
      Exception ex=(Exception)result.get();
      Messages.showMessageDialog(project,UIDesignerBundle.message("snapshot.create.error",ex.getMessage()),UIDesignerBundle.message("snapshot.title"),Messages.getErrorIcon());
    }
    if (snapshot != null) {
      final String snapshot1=snapshot;
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          CommandProcessor.getInstance().executeCommand(project,new Runnable(){
            public void run(){
              try {
                PsiFile formFile=PsiFileFactory.getInstance(dir.getProject()).createFileFromText(dlg.getFormName() + GuiFormFileType.DOT_DEFAULT_EXTENSION,snapshot1);
                formFile=(PsiFile)dir.add(formFile);
                formFile.getVirtualFile().setCharset(CharsetToolkit.UTF8_CHARSET);
                formFile.getViewProvider().getDocument().setText(snapshot1);
                view.selectElement(formFile);
              }
 catch (              IncorrectOperationException ex) {
                Messages.showMessageDialog(project,UIDesignerBundle.message("snapshot.save.error",ex.getMessage()),UIDesignerBundle.message("snapshot.title"),Messages.getErrorIcon());
              }
            }
          }
,"",null);
        }
      }
);
    }
  }
  try {
    client.resumeSwing();
  }
 catch (  IOException ex) {
    Messages.showErrorDialog(project,UIDesignerBundle.message("snapshot.connection.broken"),UIDesignerBundle.message("snapshot.title"));
  }
  client.dispose();
}
