{
  try {
    client.suspendSwing();
  }
 catch (  IOException e1) {
    Messages.showMessageDialog(project,UIDesignerBundle.message("snapshot.connection.error"),UIDesignerBundle.message("snapshot.title"),Messages.getInformationIcon());
    return;
  }
  final MyDialog dlg=new MyDialog(project,client,dir);
  dlg.show();
  if (dlg.getExitCode() == DialogWrapper.OK_EXIT_CODE) {
    int id=dlg.getSelectedComponentId();
    String snapshot=null;
    try {
      snapshot=client.createSnapshot(id);
    }
 catch (    Exception ex) {
      Messages.showMessageDialog(project,UIDesignerBundle.message("snapshot.create.error",ex.getMessage()),UIDesignerBundle.message("snapshot.title"),Messages.getErrorIcon());
    }
    if (snapshot != null) {
      final String snapshot1=snapshot;
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          CommandProcessor.getInstance().executeCommand(project,new Runnable(){
            public void run(){
              try {
                PsiFile formFile=dir.getManager().getElementFactory().createFileFromText(dlg.getFormName() + FORM_EXTENSION,snapshot1);
                formFile=(PsiFile)dir.add(formFile);
                view.selectElement(formFile);
              }
 catch (              IncorrectOperationException ex) {
                Messages.showMessageDialog(project,UIDesignerBundle.message("snapshot.save.error",ex.getMessage()),UIDesignerBundle.message("snapshot.title"),Messages.getErrorIcon());
              }
            }
          }
,"",null);
        }
      }
);
    }
  }
  try {
    client.resumeSwing();
  }
 catch (  IOException e1) {
    Messages.showMessageDialog(project,"Swing resume failed",UIDesignerBundle.message("snapshot.title"),Messages.getInformationIcon());
  }
  client.dispose();
}
