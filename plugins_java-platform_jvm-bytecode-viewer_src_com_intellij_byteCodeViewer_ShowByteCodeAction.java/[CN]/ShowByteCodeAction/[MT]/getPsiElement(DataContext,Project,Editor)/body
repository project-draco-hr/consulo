{
  PsiElement psiElement=null;
  if (editor == null) {
    psiElement=LangDataKeys.PSI_ELEMENT.getData(dataContext);
  }
 else {
    final PsiFile file=PsiUtilBase.getPsiFileInEditor(editor,project);
    final Editor injectedEditor=InjectedLanguageUtil.getEditorForInjectedLanguageNoCommit(editor,file);
    if (injectedEditor != null) {
      PsiFile psiFile=PsiUtilBase.getPsiFileInEditor(injectedEditor,project);
      psiElement=psiFile != null ? psiFile.findElementAt(injectedEditor.getCaretModel().getOffset()) : null;
    }
    if (file != null && psiElement == null) {
      psiElement=file.findElementAt(editor.getCaretModel().getOffset());
    }
  }
  return psiElement;
}
