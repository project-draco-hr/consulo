{
  final PsiMethod containingMethod=PsiTreeUtil.getParentOfType(expr,PsiMethod.class);
  final PsiModifierListOwner staticParentElement=PsiUtil.getEnclosingStaticElement(expr,parentClass);
  boolean declareStatic=staticParentElement != null;
  boolean isInSuperOrThis=false;
  if (!declareStatic) {
    for (int i=0; !declareStatic && i < occurences.length; i++) {
      PsiExpression occurence=occurences[i];
      isInSuperOrThis=isInSuperOrThis(occurence);
      declareStatic=isInSuperOrThis;
    }
  }
  PsiLocalVariable localVariable=null;
  if (expr instanceof PsiReferenceExpression) {
    PsiElement ref=((PsiReferenceExpression)expr).resolve();
    if (ref instanceof PsiLocalVariable) {
      localVariable=(PsiLocalVariable)ref;
    }
  }
  int occurencesNumber=occurences.length;
  final boolean currentMethodConstructor=containingMethod != null && containingMethod.isConstructor();
  final boolean allowInitInMethod=(!currentMethodConstructor || !isInSuperOrThis) && anchorElement instanceof PsiStatement;
  final boolean allowInitInMethodIfAll=(!currentMethodConstructor || !isInSuperOrThis) && anchorElementIfAll instanceof PsiStatement;
  IntroduceFieldDialog dialog=new IntroduceFieldDialog(project,parentClass,expr,localVariable,currentMethodConstructor,false,declareStatic,occurencesNumber,allowInitInMethod,allowInitInMethodIfAll,new TypeSelectorManagerImpl(project,type,expr,occurences));
  dialog.show();
  if (!dialog.isOK()) {
    if (occurencesNumber > 1) {
      WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
    }
    return null;
  }
  if (!dialog.isDeleteVariable()) {
    localVariable=null;
  }
  return new Settings(dialog.getEnteredName(),dialog.isReplaceAllOccurrences(),declareStatic,dialog.isDeclareFinal(),dialog.getInitializerPlace(),dialog.getFieldVisibility(),localVariable,dialog.getFieldType(),localVariable != null,null,false);
}
