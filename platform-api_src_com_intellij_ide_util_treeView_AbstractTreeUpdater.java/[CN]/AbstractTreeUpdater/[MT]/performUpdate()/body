{
  if (myRunBeforeUpdate != null) {
    myRunBeforeUpdate.run();
    myRunBeforeUpdate=null;
  }
  while (!myNodeQueue.isEmpty()) {
    final TreeUpdatePass eachPass=myNodeQueue.removeFirst();
    beforeUpdate(eachPass).doWhenDone(new Runnable(){
      public void run(){
        myTreeBuilder.getUi().updateSubtree(eachPass);
      }
    }
);
  }
  if (myRunAfterUpdate != null) {
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        List<Runnable> runAfterUpdate=null;
synchronized (myRunAfterUpdate) {
          if (!myRunAfterUpdate.isEmpty()) {
            runAfterUpdate=new ArrayList<Runnable>(myRunAfterUpdate);
            myRunAfterUpdate.clear();
          }
        }
        if (runAfterUpdate != null) {
          for (          Runnable r : runAfterUpdate) {
            r.run();
          }
        }
      }
    }
);
  }
}
