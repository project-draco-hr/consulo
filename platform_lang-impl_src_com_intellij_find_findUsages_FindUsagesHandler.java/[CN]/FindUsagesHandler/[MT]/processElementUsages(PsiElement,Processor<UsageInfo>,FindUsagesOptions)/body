{
  final ReadActionProcessor<PsiReference> refProcessor=new ReadActionProcessor<PsiReference>(){
    public boolean processInReadAction(    final PsiReference ref){
      TextRange rangeInElement=ref.getRangeInElement();
      return processor.process(new UsageInfo(ref.getElement(),rangeInElement.getStartOffset(),rangeInElement.getEndOffset(),false));
    }
  }
;
  final SearchScope scope=options.searchScope;
  final boolean searchText=options.isSearchForTextOccurences && scope instanceof GlobalSearchScope;
  if (options.fastTrack != null) {
    SearchRequestor.collectRequests(element,options,options.fastTrack);
    if (searchText) {
      options.fastTrack.searchCustom(new Processor<Processor<PsiReference>>(){
        public boolean process(        Processor<PsiReference> consumer){
          processUsagesInText(element,processor,(GlobalSearchScope)scope);
          return true;
        }
      }
);
    }
    return;
  }
  if (options.isUsages) {
    ReferencesSearch.search(element,scope,false).forEach(refProcessor);
  }
  if (searchText) {
    processUsagesInText(element,processor,(GlobalSearchScope)scope);
  }
}
