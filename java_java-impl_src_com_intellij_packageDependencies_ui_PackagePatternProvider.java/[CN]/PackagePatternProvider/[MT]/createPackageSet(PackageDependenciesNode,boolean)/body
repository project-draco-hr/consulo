{
  GeneralGroupNode groupParent=getGroupParent(node);
  String scope1=PatternPackageSet.SCOPE_ANY;
  if (groupParent != null) {
    String name=groupParent.toString();
    if (TreeModelBuilder.PRODUCTION_NAME.equals(name)) {
      scope1=PatternPackageSet.SCOPE_SOURCE;
    }
 else     if (TreeModelBuilder.TEST_NAME.equals(name)) {
      scope1=PatternPackageSet.SCOPE_TEST;
    }
 else     if (TreeModelBuilder.LIBRARY_NAME.equals(name)) {
      scope1=PatternPackageSet.SCOPE_LIBRARY;
    }
  }
  final String scope=scope1;
  if (node instanceof ModuleGroupNode) {
    if (!recursively)     return null;
    @NonNls final String modulePattern="group:" + ((ModuleGroupNode)node).getModuleGroup().toString();
    return new PatternPackageSet("*..*",scope,modulePattern);
  }
 else   if (node instanceof ModuleNode) {
    if (!recursively)     return null;
    final String modulePattern=((ModuleNode)node).getModuleName();
    return new PatternPackageSet("*..*",scope,modulePattern);
  }
 else   if (node instanceof PackageNode) {
    String pattern=((PackageNode)node).getPackageQName();
    if (pattern != null) {
      pattern+=recursively ? "..*" : ".*";
    }
 else {
      pattern=recursively ? "*..*" : ".*";
    }
    return new PatternPackageSet(pattern,scope,getModulePattern(node));
  }
 else   if (node instanceof FileNode) {
    if (recursively)     return null;
    FileNode fNode=(FileNode)node;
    final PsiElement element=fNode.getPsiElement();
    String qName=null;
    if (element instanceof PsiClassOwner) {
      final PsiClassOwner javaFile=(PsiClassOwner)element;
      final VirtualFile virtualFile=javaFile.getVirtualFile();
      LOG.assertTrue(virtualFile != null);
      final String packageName=ProjectRootManager.getInstance(element.getProject()).getFileIndex().getPackageNameByDirectory(virtualFile.getParent());
      final String name=virtualFile.getNameWithoutExtension();
      if (!JavaPsiFacade.getInstance(element.getProject()).getNameHelper().isIdentifier(name))       return null;
      qName=StringUtil.getQualifiedName(packageName,name);
    }
    if (qName != null) {
      return new PatternPackageSet(qName,scope,getModulePattern(node));
    }
  }
 else   if (node instanceof GeneralGroupNode) {
    return new PatternPackageSet("*..*",scope,null);
  }
  return null;
}
