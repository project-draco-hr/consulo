{
  SMRunnerUtil.addToInvokeLater(new Runnable(){
    public void run(){
      final boolean inDebugMode=SMTestRunnerConnectionUtil.isInDebugMode();
      final String fullTestName=getFullTestName(testName);
      SMTestProxy testProxy=getProxyByFullTestName(fullTestName);
      if (testProxy == null) {
        logProblem("Test wasn't started! TestFailure event: name = {" + testName + "}"+ ", message = {"+ localizedMessage+ "}"+ ", stackTrace = {"+ stackTrace+ "}. "+ cannotFindFullTestNameMsg(fullTestName),inDebugMode);
        if (inDebugMode) {
          return;
        }
 else {
          if (!myFailedTestsSet.contains(testProxy)) {
            onTestStarted(testName,null);
            testProxy=getProxyByFullTestName(fullTestName);
          }
        }
      }
      if (myFailedTestsSet.contains(testProxy)) {
        logProblem("Duplicate failure for test [" + fullTestName + "]: msg = "+ localizedMessage+ ", stacktrace = "+ stackTrace,inDebugMode);
        if (inDebugMode) {
          return;
        }
      }
      if (testProxy == null) {
        return;
      }
      testProxy.setTestFailed(localizedMessage,stackTrace,isTestError);
      myFailedTestsSet.add(testProxy);
      fireOnTestFailed(testProxy);
    }
  }
);
}
