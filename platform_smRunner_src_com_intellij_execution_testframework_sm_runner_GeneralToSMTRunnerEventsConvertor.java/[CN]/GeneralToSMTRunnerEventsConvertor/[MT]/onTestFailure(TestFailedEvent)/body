{
  addToInvokeLater(new Runnable(){
    @Override public void run(){
      final String testName=testFailedEvent.getName();
      if (testName == null) {
        logProblem("No test name specified in " + testFailedEvent);
        return;
      }
      final String localizedMessage=testFailedEvent.getLocalizedFailureMessage();
      final String stackTrace=testFailedEvent.getStacktrace();
      final boolean isTestError=testFailedEvent.isTestError();
      final String comparisionFailureActualText=testFailedEvent.getComparisonFailureActualText();
      final String comparisionFailureExpectedText=testFailedEvent.getComparisonFailureExpectedText();
      final boolean inDebugMode=SMTestRunnerConnectionUtil.isInDebugMode();
      final String fullTestName=getFullTestName(testName);
      SMTestProxy testProxy=getProxyByFullTestName(fullTestName);
      if (testProxy == null) {
        logProblem("Test wasn't started! TestFailure event: name = {" + testName + "}"+ ", message = {"+ localizedMessage+ "}"+ ", stackTrace = {"+ stackTrace+ "}. "+ cannotFindFullTestNameMsg(fullTestName));
        if (inDebugMode) {
          return;
        }
 else {
          onTestStarted(new TestStartedEvent(testName,null));
          testProxy=getProxyByFullTestName(fullTestName);
        }
      }
      if (testProxy == null) {
        return;
      }
      if (comparisionFailureActualText != null && comparisionFailureExpectedText != null) {
        testProxy.setTestComparisonFailed(localizedMessage,stackTrace,comparisionFailureActualText,comparisionFailureExpectedText,testFailedEvent.getFilePath(),testFailedEvent.getActualFilePath());
      }
 else       if (comparisionFailureActualText == null && comparisionFailureExpectedText == null) {
        testProxy.setTestFailed(localizedMessage,stackTrace,isTestError);
      }
 else {
        logProblem("Comparison failure actual and expected texts should be both null or not null.\n" + "Expected:\n" + comparisionFailureExpectedText + "\n"+ "Actual:\n"+ comparisionFailureActualText);
      }
      fireOnTestFailed(testProxy);
    }
  }
);
}
