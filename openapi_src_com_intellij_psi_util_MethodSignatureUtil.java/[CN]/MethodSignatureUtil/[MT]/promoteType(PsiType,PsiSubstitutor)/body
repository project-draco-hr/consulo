{
  if (type instanceof PsiTypeParameter) {
    return parentSubstitutor.substitute((PsiTypeParameter)type);
  }
  if (type instanceof PsiClassType) {
    final PsiClassType.ClassResolveResult resolveResult=((PsiClassType)type).resolveGenerics();
    final PsiClass aClass=resolveResult.getElement();
    final PsiSubstitutor resolvedSubstitutor=resolveResult.getSubstitutor();
    if (aClass != null) {
      final PsiSubstitutor substitutor=combineSubstitutors(resolvedSubstitutor,parentSubstitutor);
      if (aClass instanceof PsiTypeParameter && substitutor.substitute((PsiTypeParameter)aClass) == null) {
        return null;
      }
      type=substitutor.substitute(type);
    }
  }
  return parentSubstitutor.substitute(type);
}
