{
  final XmlFile containingFile=XmlUtil.getContainingFile(this);
  final XmlProlog prolog=getProlog();
  final XmlDoctype doctype=(prolog != null) ? prolog.getDoctype() : null;
  boolean dtdUriFromDocTypeIsNamespace=false;
  if (XmlUtil.HTML_URI.equals(namespace)) {
    XmlNSDescriptor nsDescriptor=(doctype != null) ? getNsDescriptorFormDocType(doctype,containingFile) : null;
    if (nsDescriptor == null)     nsDescriptor=getDefaultNSDescriptor(XmlUtil.XHTML_URI,false);
    return new HtmlNSDescriptorImpl(nsDescriptor);
  }
 else   if (namespace != null && namespace != XmlUtil.EMPTY_URI) {
    if (doctype == null || !namespace.equals(doctype.getDtdUri())) {
      boolean documentIsSchemaThatDefinesNs=namespace.equals(XmlUtil.getTargetSchemaNsFromTag(getRootTag()));
      final XmlFile xmlFile=documentIsSchemaThatDefinesNs ? containingFile : XmlUtil.findNamespace(containingFile,ExternalResourceManager.getInstance().getResourceLocation(namespace));
      if (xmlFile != null) {
        return (XmlNSDescriptor)xmlFile.getDocument().getMetaData();
      }
    }
 else {
      dtdUriFromDocTypeIsNamespace=true;
    }
  }
  if (strict && !dtdUriFromDocTypeIsNamespace)   return null;
  if (doctype != null) {
    XmlNSDescriptor descr=getNsDescriptorFormDocType(doctype,containingFile);
    if (descr != null) {
      final String prefix=containingFile.getDocument().getRootTag().getPrefixByNamespace(XmlUtil.FACELETS_URI);
      if (containingFile instanceof JspFile || prefix != null) {
        descr=new HtmlNSDescriptorImpl(descr,true,containingFile.getFileType() == StdFileTypes.JSP);
      }
      return descr;
    }
  }
  if (strict)   return null;
  if (namespace == XmlUtil.EMPTY_URI) {
    final XmlFile xmlFile=XmlUtil.findNamespace(containingFile,namespace);
    if (xmlFile != null) {
      return (XmlNSDescriptor)xmlFile.getDocument().getMetaData();
    }
  }
  try {
    final PsiFile fileFromText=PsiFileFactory.getInstance(getManager().getProject()).createFileFromText(containingFile.getName() + ".dtd",XmlUtil.generateDocumentDTD(this));
    if (fileFromText instanceof XmlFile) {
      return (XmlNSDescriptor)((XmlFile)fileFromText).getDocument().getMetaData();
    }
  }
 catch (  ProcessCanceledException ex) {
    throw ex;
  }
catch (  RuntimeException ex) {
  }
  return null;
}
