{
  myChangedFilesCollector.ensureAllInvalidateTasksCompleted();
  ProjectIndexableFilesFilter indexableFilesFilter=projectIndexableFiles(project);
  UpdateSemaphore updateSemaphore;
  do {
    updateSemaphore=obtainForceUpdateSemaphore();
    try {
      for (      VirtualFile file : getAllFilesToUpdate()) {
        if (indexableFilesFilter != null && file instanceof VirtualFileWithId && !indexableFilesFilter.containsFileId(((VirtualFileWithId)file).getId())) {
          continue;
        }
        if (filter == null || filter.accept(file) || Comparing.equal(file,restrictedTo)) {
          try {
            updateSemaphore.down();
            processFileImpl(project,new com.intellij.ide.caches.FileContent(file),onlyRemoveOutdatedData);
          }
 catch (          ProcessCanceledException e) {
            updateSemaphore.reportUpdateCanceled();
            throw e;
          }
 finally {
            updateSemaphore.up();
          }
        }
      }
      while (!updateSemaphore.waitFor(500)) {
        if (Thread.holdsLock(PsiLock.LOCK)) {
          break;
        }
      }
    }
  finally {
      releaseForceUpdateSemaphore(updateSemaphore);
    }
  }
 while (updateSemaphore.isUpdateCanceled());
}
