{
  final VirtualFile file=fileContent.getVirtualFile();
  final boolean reallyRemoved=myFilesToUpdate.remove(file);
  if (reallyRemoved && file.isValid()) {
    int fileId=getIdMaskingNonIdBasedFile(file);
    try {
      if (isTooLarge(file)) {
        List<ID<?,?>> nontrivialFileIndexedStates=IndexingStamp.getNontrivialFileIndexedStates(fileId);
        removeFileDataFromIndices(ContainerUtil.intersection(nontrivialFileIndexedStates,myRequiringContentIndices),file);
      }
 else {
        try {
          doIndexFileContent(project,fileContent);
        }
 catch (        ProcessCanceledException ex) {
          myFilesToUpdate.add(file);
          throw ex;
        }
      }
    }
  finally {
      IndexingStamp.flushCache(file);
    }
  }
}
