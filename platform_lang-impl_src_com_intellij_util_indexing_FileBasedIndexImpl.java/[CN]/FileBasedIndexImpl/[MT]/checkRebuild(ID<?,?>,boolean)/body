{
  final AtomicInteger status=ourRebuildStatus.get(indexId);
  if (status.get() == OK) {
    return;
  }
  if (status.compareAndSet(REQUIRES_REBUILD,REBUILD_IN_PROGRESS)) {
    cleanupProcessedFlag();
    try {
      clearIndex(indexId);
    }
 catch (    StorageException ex) {
      requestRebuild(indexId,new Throwable(ex));
    }
    final Runnable rebuildRunnable=new Runnable(){
      @Override public void run(){
        try {
          if (!cleanupOnly) {
            scheduleIndexRebuild(false);
          }
        }
  finally {
          status.compareAndSet(REBUILD_IN_PROGRESS,OK);
        }
      }
    }
;
    if (cleanupOnly || myIsUnitTestMode) {
      rebuildRunnable.run();
    }
 else {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          new Task.Modal(null,"Updating index",false){
            @Override public void run(            @NotNull final ProgressIndicator indicator){
              indicator.setIndeterminate(true);
              rebuildRunnable.run();
            }
          }
.queue();
        }
      }
,ModalityState.NON_MODAL);
    }
  }
  if (status.get() == REBUILD_IN_PROGRESS) {
    throw new ProcessCanceledException();
  }
}
