{
  final ID<K,V> name=extension.getName();
  final int version=extension.getVersion();
  final File versionFile=IndexInfrastructure.getVersionFile(name);
  final boolean versionFileExisted=versionFile.exists();
  boolean versionChanged=false;
  if (isCurrentVersionCorrupted || IndexInfrastructure.versionDiffers(versionFile,version)) {
    if (!isCurrentVersionCorrupted && versionFileExisted) {
      versionChanged=true;
      LOG.info("Version has changed for index " + name + ". The index will be rebuilt.");
    }
    FileUtil.delete(IndexInfrastructure.getIndexRootDir(name));
    IndexInfrastructure.rewriteVersion(versionFile,version);
  }
  initIndexStorage(extension,version,versionFile);
  Map<FileType,Integer> versionMap=extension.getVersionMap();
  for (  Map.Entry<FileType,Integer> entry : versionMap.entrySet()) {
    ID stubId=IndexInfrastructure.getStubId(name,entry.getKey());
    File file=IndexInfrastructure.getVersionFile(stubId);
    Integer stubVersion=entry.getValue();
    if (!file.exists() || IndexInfrastructure.versionDiffers(file,stubVersion)) {
      LOG.info("Version has changed for index " + stubId + ". The index will be rebuilt.");
      IndexInfrastructure.rewriteVersion(file,stubVersion);
    }
  }
  return versionChanged;
}
