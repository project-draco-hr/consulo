{
  final MapReduceIndex<K,V,FileContent> index;
  if (extension instanceof CustomImplementationFileBasedIndexExtension) {
    final UpdatableIndex<K,V,FileContent> custom=((CustomImplementationFileBasedIndexExtension<K,V,FileContent>)extension).createIndexImplementation(indexId,this,storage);
    if (!(custom instanceof MapReduceIndex)) {
      return custom;
    }
    index=(MapReduceIndex<K,V,FileContent>)custom;
  }
 else {
    DataExternalizer<Collection<K>> externalizer=extension.hasSnapshotMapping() && IdIndex.ourSnapshotMappingsEnabled ? createInputsIndexExternalizer(extension,indexId,extension.getKeyDescriptor()) : null;
    index=new MapReduceIndex<K,V,FileContent>(indexId,extension.getIndexer(),storage,externalizer,extension.getValueExternalizer(),extension instanceof PsiDependentIndex);
  }
  index.setInputIdToDataKeysIndex(new Factory<PersistentHashMap<Integer,Collection<K>>>(){
    @Override public PersistentHashMap<Integer,Collection<K>> create(){
      try {
        return createIdToDataKeysIndex(extension,storage);
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
  }
);
  return index;
}
