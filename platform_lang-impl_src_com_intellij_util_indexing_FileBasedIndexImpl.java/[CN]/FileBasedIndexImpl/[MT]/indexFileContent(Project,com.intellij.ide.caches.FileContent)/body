{
  myChangedFilesCollector.ensureAllInvalidateTasksCompleted();
  final VirtualFile file=content.getVirtualFile();
  FileTypeManagerImpl.cacheFileType(file,file.getFileType());
  try {
    PsiFile psiFile=null;
    FileContentImpl fc=null;
    for (    final ID<?,?> indexId : myIndices.keySet()) {
      if (shouldIndexFile(file,indexId)) {
        if (fc == null) {
          byte[] currentBytes;
          try {
            currentBytes=content.getBytes();
          }
 catch (          IOException e) {
            currentBytes=ArrayUtil.EMPTY_BYTE_ARRAY;
          }
          fc=new FileContentImpl(file,currentBytes);
          psiFile=content.getUserData(IndexingDataKeys.PSI_FILE);
          if (psiFile != null) {
            psiFile.putUserData(PsiFileImpl.BUILDING_STUB,true);
            fc.putUserData(IndexingDataKeys.PSI_FILE,psiFile);
          }
          if (project == null) {
            project=ProjectUtil.guessProjectForFile(file);
          }
          fc.putUserData(IndexingDataKeys.PROJECT,project);
        }
        try {
          ProgressManager.checkCanceled();
          updateSingleIndex(indexId,file,fc);
        }
 catch (        ProcessCanceledException e) {
          myChangedFilesCollector.scheduleForUpdate(file);
          throw e;
        }
catch (        StorageException e) {
          requestRebuild(indexId);
          LOG.info(e);
        }
      }
    }
    if (psiFile != null) {
      psiFile.putUserData(PsiFileImpl.BUILDING_STUB,null);
    }
  }
  finally {
    FileTypeManagerImpl.cacheFileType(file,null);
  }
}
