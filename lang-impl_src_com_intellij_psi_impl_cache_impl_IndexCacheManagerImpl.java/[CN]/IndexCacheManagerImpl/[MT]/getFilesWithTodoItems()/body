{
  final FileBasedIndex fileBasedIndex=FileBasedIndex.getInstance();
  final Set<PsiFile> allFiles=new HashSet<PsiFile>();
  final ProjectFileIndex projectFileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
  for (  IndexPattern indexPattern : CacheUtil.getIndexPatterns()) {
    final Collection<VirtualFile> files=fileBasedIndex.getContainingFiles(TodoIndex.NAME,new TodoIndexEntry(indexPattern.getPatternString(),indexPattern.isCaseSensitive()),VirtualFileFilter.ALL);
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        for (        VirtualFile file : files) {
          if (projectFileIndex.isInContent(file)) {
            final PsiFile psiFile=myPsiManager.findFile(file);
            if (psiFile != null) {
              allFiles.add(psiFile);
            }
          }
        }
      }
    }
);
  }
  return allFiles.isEmpty() ? PsiFile.EMPTY_ARRAY : allFiles.toArray(new PsiFile[allFiles.size()]);
}
