{
  if (params == null || params.length == 0)   return null;
  PsiDocumentManager.getInstance(context.getProject()).commitAllDocuments();
  Result result=params[0].calculateQuickResult(context);
  if (result instanceof PsiElementResult) {
    final PsiElement element=((PsiElementResult)result).getElement();
    if (element instanceof PsiVariable) {
      return new PsiTypeResult(((PsiVariable)element).getType(),element.getManager());
    }
  }
 else   if (result instanceof TextResult) {
    PsiFile file=PsiDocumentManager.getInstance(context.getProject()).getPsiFile(context.getEditor().getDocument());
    PsiElement place=file.findElementAt(context.getStartOffset());
    final PsiVariable[] vars=MacroUtil.getVariablesVisibleAt(place,"");
    final String name=result.toString();
    for (    final PsiVariable var : vars) {
      if (name.equals(var.getName()))       return new PsiTypeResult(var.getType(),var.getManager());
    }
  }
  return null;
}
