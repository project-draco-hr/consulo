{
  try {
    final List<PsiFile> movedFiles=new ArrayList<PsiFile>();
    for (    final PsiElement element : myElementsToMove) {
      if (element instanceof PsiDirectory) {
        MoveFilesOrDirectoriesUtil.doMoveDirectory((PsiDirectory)element,myNewParent);
      }
 else       if (element instanceof PsiFile) {
        final PsiFile movedFile=(PsiFile)element;
        MoveFileHandler.forElement(movedFile).prepareMovedFile(movedFile);
        FileReferenceContextUtil.encodeFileReferences(element);
        MoveFilesOrDirectoriesUtil.doMoveFile(movedFile,myNewParent);
        movedFiles.add(movedFile);
      }
      getTransaction().getElementListener(element).elementMoved(element);
    }
    Arrays.sort(usages,new Comparator<UsageInfo>(){
      public int compare(      final UsageInfo o1,      final UsageInfo o2){
        return o1.getElement() == o2.getElement() ? o2.startOffset - o1.startOffset : 0;
      }
    }
);
    for (    UsageInfo usageInfo : usages) {
      final MyUsageInfo info=(MyUsageInfo)usageInfo;
      final PsiElement element=myElementsToMove[info.myIndex];
      if (info.getReference() instanceof FileReference) {
        final PsiElement usageElement=info.getElement();
        if (usageElement != null) {
          final PsiFile usageFile=usageElement.getContainingFile();
          final PsiFile psiFile=usageFile.getViewProvider().getPsi(usageFile.getViewProvider().getBaseLanguage());
          if (psiFile != null && psiFile.equals(element)) {
            continue;
          }
        }
      }
      info.myReference.bindToElement(element);
    }
    for (    PsiFile movedFile : movedFiles) {
      MoveFileHandler.forElement(movedFile).updateMovedFile(movedFile);
      FileReferenceContextUtil.decodeFileReferences(movedFile);
    }
    if (myMoveCallback != null) {
      myMoveCallback.refactoringCompleted();
    }
  }
 catch (  IncorrectOperationException e) {
    @NonNls final String message=e.getMessage();
    final int index=message != null ? message.indexOf("java.io.IOException") : -1;
    if (index >= 0) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          Messages.showMessageDialog(myProject,message.substring(index + "java.io.IOException".length()),RefactoringBundle.message("error.title"),Messages.getErrorIcon());
        }
      }
);
    }
 else {
      LOG.error(e);
    }
  }
}
