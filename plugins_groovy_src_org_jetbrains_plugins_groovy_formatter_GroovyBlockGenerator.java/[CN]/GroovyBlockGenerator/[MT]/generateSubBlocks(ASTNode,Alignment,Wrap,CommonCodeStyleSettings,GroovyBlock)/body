{
  PsiElement blockPsi=block.getNode().getPsi();
  if (blockPsi instanceof GrBinaryExpression && !(blockPsi.getParent() instanceof GrBinaryExpression)) {
    return generateForBinaryExpr(node,myWrap,mySettings,block.myInnerAlignments);
  }
  if ((block.getNode().getElementType() == mSTRING_LITERAL || block.getNode().getElementType() == mGSTRING_LITERAL) && block.getTextRange().equals(block.getNode().getTextRange())) {
    String text=block.getNode().getText();
    if (text.length() > 6) {
      if (text.substring(0,3).equals("'''") && text.substring(text.length() - 3).equals("'''") || text.substring(0,3).equals("\"\"\"") & text.substring(text.length() - 3).equals("\"\"\"")) {
        return generateForMultiLineString(block.getNode(),myAlignment,myWrap,mySettings);
      }
    }
  }
  if (block.getNode().getElementType() == mGSTRING_BEGIN && block.getTextRange().equals(block.getNode().getTextRange())) {
    String text=block.getNode().getText();
    if (text.length() > 3) {
      if (text.substring(0,3).equals("\"\"\"")) {
        return generateForMultiLineGStringBegin(block.getNode(),myAlignment,myWrap,mySettings);
      }
    }
  }
  if (block.getNode().getElementType() == GSTRING) {
    final ArrayList<Block> subBlocks=new ArrayList<Block>();
    ASTNode[] children=getGroovyChildren(node);
    for (    ASTNode childNode : children) {
      if (childNode.getTextRange().getLength() > 0) {
        final Indent indent=GroovyIndentProcessor.getChildIndent(block,childNode);
        subBlocks.add(new GroovyBlock(childNode,myAlignment,indent,myWrap,mySettings));
      }
    }
    return subBlocks;
  }
  if (NESTED.contains(block.getNode().getElementType()) && blockPsi.getParent() != null && !NESTED.contains(blockPsi.getParent().getNode().getElementType())) {
    final List<Block> subBlocks=new ArrayList<Block>();
    Alignment dotsAlignment=mySettings.ALIGN_MULTILINE_CHAINED_METHODS ? Alignment.createAlignment() : null;
    addNestedChildren(node.getPsi(),subBlocks,dotsAlignment,myWrap,mySettings,true);
    return subBlocks;
  }
  if (isListLikeClause(blockPsi)) {
    final ArrayList<Block> subBlocks=new ArrayList<Block>();
    List<ASTNode> astNodes=visibleChildren(node);
    final Alignment alignment=mustAlign(blockPsi,mySettings,astNodes) ? Alignment.createAlignment() : null;
    for (    ASTNode childNode : astNodes) {
      final Indent indent=GroovyIndentProcessor.getChildIndent(block,childNode);
      subBlocks.add(new GroovyBlock(childNode,isKeyword(childNode) ? null : alignment,indent,myWrap,mySettings));
    }
    return subBlocks;
  }
  boolean classLevel=blockPsi instanceof GrTypeDefinitionBody;
  if (blockPsi instanceof GrCodeBlock || blockPsi instanceof GroovyFile || classLevel) {
    List<ASTNode> children=visibleChildren(node);
    Map<PsiElement,Alignment> innerAlignments=calculateInnerAlignments(children,classLevel,mySettings);
    final ArrayList<Block> subBlocks=new ArrayList<Block>();
    for (    ASTNode childNode : children) {
      final Indent indent=GroovyIndentProcessor.getChildIndent(block,childNode);
      subBlocks.add(new GroovyBlock(childNode,classLevel ? myAlignment : null,indent,myWrap,mySettings,innerAlignments));
    }
    return subBlocks;
  }
  final ArrayList<Block> subBlocks=new ArrayList<Block>();
  for (  ASTNode childNode : visibleChildren(node)) {
    final Indent indent=GroovyIndentProcessor.getChildIndent(block,childNode);
    subBlocks.add(new GroovyBlock(childNode,block.myInnerAlignments.get(childNode.getPsi()),indent,myWrap,mySettings,block.myInnerAlignments));
  }
  return subBlocks;
}
