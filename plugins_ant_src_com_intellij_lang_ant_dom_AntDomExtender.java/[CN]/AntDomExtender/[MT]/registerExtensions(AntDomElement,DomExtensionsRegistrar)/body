{
  final XmlElement xmlElement=antDomElement.getXmlElement();
  if (xmlElement instanceof XmlTag) {
    final XmlTag xmlTag=(XmlTag)xmlElement;
    final String tagName=xmlTag.getName();
    final AntDomProject antProject=antDomElement.getAntProject();
    final ReflectedProject reflected=ReflectedProject.getProject(antProject.getClassLoader());
    final DomGenericInfo genericInfo=antDomElement.getGenericInfo();
    AntIntrospector parentElementIntrospector=null;
    final Hashtable<String,Class> coreTaskDefs=reflected.getTaskDefinitions();
    final Hashtable<String,Class> coreTypeDefs=reflected.getDataTypeDefinitions();
    if ("project".equals(tagName)) {
      parentElementIntrospector=getIntrospector(reflected.getProject().getClass());
    }
 else     if ("target".equals(tagName)) {
      parentElementIntrospector=getIntrospector(reflected.getTargetClass());
    }
 else {
      if (antDomElement instanceof AntDomCustomElement) {
        final AntDomCustomElement custom=(AntDomCustomElement)antDomElement;
        final Class definitionClass=custom.getDefinitionClass();
        if (definitionClass != null) {
          parentElementIntrospector=getIntrospector(definitionClass);
        }
      }
 else {
        Class elemType=antDomElement.getChildDescription().getUserData(ELEMENT_IMPL_CLASS_KEY);
        if (elemType == null) {
          if (coreTaskDefs != null) {
            elemType=coreTaskDefs.get(tagName);
          }
        }
        if (elemType == null) {
          if (coreTypeDefs != null) {
            elemType=coreTypeDefs.get(tagName);
          }
        }
        if (elemType != null) {
          parentElementIntrospector=getIntrospector(elemType);
        }
      }
    }
    if (parentElementIntrospector != null) {
      final Enumeration attributes=parentElementIntrospector.getAttributes();
      while (attributes.hasMoreElements()) {
        registerAttribute(registrar,genericInfo,(String)attributes.nextElement());
      }
      if ("project".equals(tagName) || parentElementIntrospector.isContainer()) {
        if (coreTaskDefs != null) {
          for (          Map.Entry<String,Class> entry : coreTaskDefs.entrySet()) {
            final DomExtension extension=registerChild(registrar,genericInfo,entry.getKey());
            if (extension != null) {
              final Class type=entry.getValue();
              if (type != null) {
                extension.putUserData(ELEMENT_IMPL_CLASS_KEY,type);
              }
              extension.putUserData(AntDomElement.ROLE,AntDomElement.Role.TASK);
            }
          }
        }
        if (coreTypeDefs != null) {
          for (          Map.Entry<String,Class> entry : coreTypeDefs.entrySet()) {
            final DomExtension extension=registerChild(registrar,genericInfo,entry.getKey());
            if (extension != null) {
              final Class type=entry.getValue();
              if (type != null) {
                extension.putUserData(ELEMENT_IMPL_CLASS_KEY,type);
              }
              extension.putUserData(AntDomElement.ROLE,AntDomElement.Role.DATA_TYPE);
            }
          }
        }
        registrar.registerCustomChildrenExtension(AntDomCustomElement.class,new AntCustomTagNameDescriptor());
      }
 else {
        final Enumeration<String> nested=parentElementIntrospector.getNestedElements();
        while (nested.hasMoreElements()) {
          final String nestedElementName=nested.nextElement();
          final DomExtension extension=registerChild(registrar,genericInfo,nestedElementName);
          if (extension != null) {
            final Class type=parentElementIntrospector.getElementType(nestedElementName);
            if (type != null) {
              extension.putUserData(ELEMENT_IMPL_CLASS_KEY,type);
            }
            AntDomElement.Role role=null;
            if (coreTaskDefs != null && coreTaskDefs.containsKey(nestedElementName)) {
              role=AntDomElement.Role.TASK;
            }
 else             if (coreTypeDefs != null && coreTypeDefs.containsKey(nestedElementName)) {
              role=AntDomElement.Role.DATA_TYPE;
            }
 else             if (type != null && isAssignableFrom(Task.class.getName(),type)) {
              role=AntDomElement.Role.TASK;
            }
            if (role != null) {
              extension.putUserData(AntDomElement.ROLE,role);
            }
          }
        }
      }
    }
  }
}
