{
  FileDocumentManager.getInstance().saveAllDocuments();
  final AntCommandLineBuilder builder=new AntCommandLineBuilder();
  final AntBuildMessageView messageView;
  final GeneralCommandLine commandLine;
synchronized (builder) {
    Project project=buildFile.getProject();
    try {
      builder.setBuildFile(buildFile.getAllOptions(),VfsUtil.virtualToIoFile(buildFile.getVirtualFile()));
      builder.calculateProperties(dataContext);
      builder.addTargets(targets);
      builder.getCommandLine().setCharset(EncodingProjectManager.getInstance(buildFile.getProject()).getDefaultCharset());
      messageView=prepareMessageView(buildMessageViewToReuse,buildFile,targets);
      commandLine=CommandLineBuilder.createFromJavaParameters(builder.getCommandLine());
      messageView.setBuildCommandLine(commandLine.getCommandLineString());
    }
 catch (    RunCanceledException e) {
      e.showMessage(project,AntBundle.message("run.ant.erorr.dialog.title"));
      antBuildListener.buildFinished(AntBuildListener.FAILED_TO_RUN,0);
      return;
    }
catch (    CantRunException e) {
      ExecutionErrorDialog.show(e,AntBundle.message("cant.run.ant.erorr.dialog.title"),project);
      antBuildListener.buildFinished(AntBuildListener.FAILED_TO_RUN,0);
      return;
    }
catch (    Macro.ExecutionCancelledException e) {
      antBuildListener.buildFinished(AntBuildListener.ABORTED,0);
      return;
    }
catch (    Throwable e) {
      antBuildListener.buildFinished(AntBuildListener.FAILED_TO_RUN,0);
      LOG.error(e);
      return;
    }
  }
  final boolean startInBackground=buildFile.isRunInBackground();
  new Task.Backgroundable(null,AntBundle.message("ant.build.progress.dialog.title"),true){
    public boolean shouldStartInBackground(){
      return startInBackground;
    }
    public void run(    @NotNull final ProgressIndicator indicator){
      try {
        runBuild(indicator,messageView,buildFile,antBuildListener,commandLine);
      }
 catch (      Throwable e) {
        LOG.error(e);
        antBuildListener.buildFinished(AntBuildListener.FAILED_TO_RUN,0);
      }
    }
  }
.queue();
}
