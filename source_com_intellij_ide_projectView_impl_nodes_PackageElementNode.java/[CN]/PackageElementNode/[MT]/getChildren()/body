{
  final List<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  final PackageElement value=getValue();
  final Module module=value.getModule();
  final PsiPackage aPackage=value.getPackage();
  if (!getSettings().isFlattenPackages()) {
    final PsiPackage[] subpackages=PackageUtil.getSubpackages(aPackage,module,myProject,isLibraryElement());
    for (int idx=0; idx < subpackages.length; idx++) {
      PackageUtil.addPackageAsChild(children,subpackages[idx],module,getSettings(),isLibraryElement());
    }
  }
  final GlobalSearchScope scopeToShow=PackageUtil.getScopeToShow(myProject,module,isLibraryElement());
  final PsiDirectory[] dirs=aPackage.getDirectories(scopeToShow);
  for (int idx=0; idx < dirs.length; idx++) {
    final PsiDirectory dir=dirs[idx];
    children.addAll(PackageUtil.getDirectoryChildren(dir,getSettings(),false));
  }
  return children;
}
