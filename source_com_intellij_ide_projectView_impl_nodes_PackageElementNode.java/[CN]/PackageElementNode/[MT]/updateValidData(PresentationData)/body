{
  final PsiPackage aPackage=getValue().getPackage();
  if (!getSettings().isFlattenPackages()) {
    if (getSettings().isHideEmptyMiddlePackages()) {
      if (PackageUtil.isPackageEmpty(aPackage,getValue().getModule(),true,isLibraryElement())) {
        setValue(null);
        return;
      }
    }
  }
  if (showFwName(aPackage)) {
    presentation.setPresentableText(getSettings().isAbbreviatePackageNames() ? TreeViewUtil.calcAbbreviatedPackageFQName(aPackage) : aPackage.getQualifiedName());
  }
 else {
    if (!(getParentValue() instanceof PackageElement)) {
      presentation.setPresentableText(aPackage.getQualifiedName());
    }
 else {
      final PsiPackage parentPackageInTree=((PackageElement)getParentValue()).getPackage();
      PsiPackage parentPackage=aPackage.getParentPackage();
      final StringBuffer buf=new StringBuffer();
      buf.append(aPackage.getName());
      while (parentPackage != null && !parentPackage.equals(parentPackageInTree)) {
        buf.insert(0,".");
        buf.insert(0,parentPackage.getName());
        parentPackage=parentPackage.getParentPackage();
      }
      presentation.setPresentableText(buf.toString());
    }
  }
  presentation.setOpenIcon(Icons.PACKAGE_OPEN_ICON);
  presentation.setClosedIcon(Icons.PACKAGE_ICON);
}
