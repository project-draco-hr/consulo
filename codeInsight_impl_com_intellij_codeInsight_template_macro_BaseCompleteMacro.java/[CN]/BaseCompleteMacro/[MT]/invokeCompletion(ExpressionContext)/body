{
  final Project project=context.getProject();
  final Editor editor=context.getEditor();
  final PsiFile psiFile=PsiUtilBase.getPsiFileInEditor(editor,project);
  new WriteCommandAction.Simple(project,psiFile){
    public void run(){
      PsiDocumentManager.getInstance(project).commitAllDocuments();
    }
  }
.execute();
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    getCompletionHandler().invoke(project,editor,psiFile);
    return;
  }
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      if (project.isDisposed())       return;
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        public void run(){
          if (!ApplicationManager.getApplication().isUnitTestMode()) {
            getCompletionHandler().invoke(project,editor,psiFile);
          }
          final LookupManager lookupManager=LookupManager.getInstance(project);
          Lookup lookup=lookupManager.getActiveLookup();
          if (lookup != null) {
            lookup.addLookupListener(new MyLookupListener(context));
          }
 else {
            TemplateState templateState=TemplateManagerImpl.getTemplateState(editor);
            if (templateState != null) {
              TextRange range=templateState.getCurrentVariableRange();
              if (range != null && range.getLength() > 0) {
                templateState.nextTab();
              }
            }
          }
        }
      }
,"",null);
    }
  }
);
}
