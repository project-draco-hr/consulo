{
  PsiNewExpression newExpression;
  PsiElementFactory factory=JavaPsiFacade.getInstance(originalExpression.getProject()).getElementFactory();
  int caretOffset;
  TextRange selection;
  if (toType instanceof PsiArrayType) {
    caretOffset=-2;
    @NonNls String text="new " + toType.getDeepComponentType().getCanonicalText() + "[0]";
    for (int i=1; i < toType.getArrayDimensions(); i++) {
      text+="[]";
      caretOffset-=2;
    }
    newExpression=(PsiNewExpression)factory.createExpressionFromText(text,originalExpression);
    selection=new TextRange(caretOffset,caretOffset + 1);
  }
 else {
    newExpression=(PsiNewExpression)factory.createExpressionFromText("new " + toType.getCanonicalText() + "()",originalExpression);
    PsiExpressionList argumentList=originalExpression.getArgumentList();
    if (argumentList == null)     return;
    newExpression.getArgumentList().replace(argumentList);
    selection=null;
    caretOffset=-1;
  }
  PsiElement element=originalExpression.replace(newExpression);
  editor.getCaretModel().moveToOffset(element.getTextRange().getEndOffset() + caretOffset);
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  if (selection != null) {
    selection=selection.shiftRight(element.getTextRange().getEndOffset());
    editor.getSelectionModel().setSelection(selection.getStartOffset(),selection.getEndOffset());
  }
}
