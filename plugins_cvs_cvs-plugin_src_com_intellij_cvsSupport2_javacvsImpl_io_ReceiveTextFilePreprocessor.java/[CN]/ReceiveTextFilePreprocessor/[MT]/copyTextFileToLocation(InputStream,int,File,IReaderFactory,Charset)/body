{
  final VirtualFile virtualFile=CvsVfsUtil.findFileByIoFile(targetFile);
  if (myReceivedFileProcessor.shouldProcess(virtualFile,targetFile)) {
    final PrintStream target=new PrintStream(new BufferedOutputStream(new FileOutputStream(targetFile)));
    try {
      final String lineSeparator=getLineSeparatorFor(targetFile);
      byte[] lineSeparatorBytes=null;
      if (charSet != null) {
        lineSeparatorBytes=charSet.encode(lineSeparator).array();
      }
      final LineReader lineReader=new LineReader(textFileSource,length);
      boolean first=true;
      for (byte[] line=lineReader.readLine(); line != null; line=lineReader.readLine()) {
        if (!first) {
          if (charSet == null)           target.print(lineSeparator);
 else           target.write(lineSeparatorBytes);
        }
 else {
          first=false;
        }
        if (charSet == null) {
          target.write(line);
        }
 else {
          target.write(charSet.encode(CharsetToolkit.bytesToString(line,CharsetToolkit.UTF8_CHARSET)).array());
        }
      }
    }
  finally {
      target.close();
    }
  }
 else {
    CvsUtil.skip(textFileSource,length);
  }
}
