{
  VirtualFile virtualFile=CvsVfsUtil.findFileByIoFile(targetFile);
  if (myReceivedFileProcessor.shouldProcess(virtualFile,targetFile)) {
    PrintStream target=new PrintStream(new BufferedOutputStream(new FileOutputStream(targetFile)));
    try {
      String lineSeparator=getLineSeparatorFor(targetFile);
      byte[] lineSeparatorBytes=null;
      if (charSet != null) {
        lineSeparatorBytes=charSet.encode(lineSeparator).array();
      }
      final BufferedInputStream inputStream=new BufferedInputStream(new FileInputStream(textFileSource));
      try {
        Collection<byte[]> lines=new LineReader(inputStream).readLines();
        for (Iterator<byte[]> each=lines.iterator(); each.hasNext(); ) {
          final byte[] bytes=each.next();
          if (charSet == null) {
            target.write(bytes);
          }
 else {
            target.write(charSet.encode(CharsetToolkit.UTF8_CHARSET.decode(ByteBuffer.wrap(bytes))).array());
          }
          if (each.hasNext()) {
            if (charSet == null)             target.print(lineSeparator);
 else             target.write(lineSeparatorBytes);
          }
        }
      }
  finally {
        inputStream.close();
      }
    }
  finally {
      target.close();
    }
  }
}
