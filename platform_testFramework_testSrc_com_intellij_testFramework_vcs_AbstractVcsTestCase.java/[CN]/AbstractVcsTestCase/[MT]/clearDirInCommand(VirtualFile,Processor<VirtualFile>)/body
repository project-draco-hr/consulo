{
  new WriteCommandAction.Simple(myProject){
    @Override protected void run() throws Throwable {
      for (int i=0; i < 5; i++) {
        try {
          final VirtualFile[] children=dir.getChildren();
          for (          VirtualFile child : children) {
            if (filter != null && filter.process(child)) {
              child.delete(AbstractVcsTestCase.this);
            }
          }
          return;
        }
 catch (        IOException e) {
          try {
            Thread.sleep(50);
          }
 catch (          InterruptedException e1) {
          }
          continue;
        }
      }
    }
  }
.execute();
}
