{
  final BufferExposingByteArrayOutputStream bos=new BufferExposingByteArrayOutputStream();
  DataOutput out=new DataOutputStream(bos);
  descriptor.save(out,value);
  final int size=bos.size();
  final byte[] buffer=bos.getInternalBuffer();
  int currentLength=getCurrentLength();
  if (myCompressedAppendableFile != null) {
    myCompressedAppendableFile.append(buffer,size);
    if (!testMode)     return currentLength;
  }
  if (size > ourAppendBufferLength) {
    flushKeyStoreBuffer();
    put(currentLength,buffer,0,size);
    myFileLength+=size;
  }
 else {
    if (size > ourAppendBufferLength - myBufferPosition) {
      flushKeyStoreBuffer();
    }
    if (myAppendBuffer == null) {
      myAppendBuffer=new byte[ourAppendBufferLength];
    }
    System.arraycopy(buffer,0,myAppendBuffer,myBufferPosition,size);
    myBufferPosition+=size;
  }
  return currentLength;
}
