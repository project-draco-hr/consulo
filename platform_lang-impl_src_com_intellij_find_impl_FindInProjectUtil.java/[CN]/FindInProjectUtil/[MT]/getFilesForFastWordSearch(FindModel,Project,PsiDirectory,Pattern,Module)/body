{
  if (DumbService.getInstance(project).isDumb()) {
    return new Pair<Boolean,Collection<PsiFile>>(false,Collections.<PsiFile>emptyList());
  }
  PsiManager pm=PsiManager.getInstance(project);
  CacheManager cacheManager=CacheManager.SERVICE.getInstance(project);
  SearchScope customScope=findModel.getCustomScope();
  @NotNull GlobalSearchScope scope=psiDirectory != null ? GlobalSearchScopes.directoryScope(psiDirectory,true) : module != null ? moduleContentScope(module) : customScope instanceof GlobalSearchScope ? (GlobalSearchScope)customScope : toGlobal(project,customScope);
  Set<Integer> keys=new THashSet<Integer>(30);
  Set<PsiFile> resultFiles=new THashSet<PsiFile>();
  boolean fast=false;
  if (TrigramIndex.ENABLED) {
    TIntHashSet trigrams=TrigramBuilder.buildTrigram(findModel.getStringToFind());
    TIntIterator it=trigrams.iterator();
    while (it.hasNext()) {
      keys.add(it.next());
    }
    if (!keys.isEmpty()) {
      fast=true;
      List<VirtualFile> hits=new ArrayList<VirtualFile>();
      FileBasedIndex.getInstance().getFilesWithKey(TrigramIndex.INDEX_ID,keys,new CommonProcessors.CollectProcessor<VirtualFile>(hits),scope);
      for (      VirtualFile hit : hits) {
        resultFiles.add(pm.findFile(hit));
      }
      filterMaskedFiles(resultFiles,fileMaskRegExp);
      if (resultFiles.isEmpty())       return new Pair<Boolean,Collection<PsiFile>>(true,resultFiles);
    }
  }
  fast|=findModel.isWholeWordsOnly() && findModel.getStringToFind().indexOf('$') < 0;
  List<String> words=StringUtil.getWordsInStringLongestFirst(findModel.getStringToFind());
  for (int i=0; i < words.size(); i++) {
    String word=words.get(i);
    PsiFile[] files=cacheManager.getFilesWithWord(word,UsageSearchContext.ANY,scope,findModel.isCaseSensitive());
    if (files.length == 0) {
      resultFiles.clear();
      break;
    }
    final List<PsiFile> psiFiles=Arrays.asList(files);
    if (i == 0 && keys.isEmpty()) {
      resultFiles.addAll(psiFiles);
    }
 else {
      resultFiles.retainAll(psiFiles);
    }
    filterMaskedFiles(resultFiles,fileMaskRegExp);
    if (resultFiles.isEmpty())     break;
  }
  PsiFile[] allWordsFiles=cacheManager.getFilesWithWord(findModel.getStringToFind(),UsageSearchContext.ANY,scope,findModel.isCaseSensitive());
  ContainerUtil.addAll(resultFiles,allWordsFiles);
  filterMaskedFiles(resultFiles,fileMaskRegExp);
  return new Pair<Boolean,Collection<PsiFile>>(fast,resultFiles);
}
