{
  final VirtualFile virtualFile=psiFile.getVirtualFile();
  if (virtualFile == null)   return 0;
  if (FileTypeManager.getInstance().getFileTypeByFile(virtualFile).isBinary())   return 0;
  final Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
  if (document == null)   return 0;
  final int[] offset=new int[]{0};
  int count=0;
  int found;
  do {
    found=ApplicationManager.getApplication().runReadAction(new Computable<Integer>(){
      @Override @NotNull public Integer compute(){
        if (!psiFile.isValid())         return 0;
        return addToUsages(document,consumer,findModel,psiFile,offset,USAGES_PER_READ_ACTION);
      }
    }
);
    count+=found;
    if (found > 0 && count + alreadyCounted > USAGES_LIMIT && !warningShown[0]) {
      showTooManyUsagesWaring(psiFile.getProject(),FindBundle.message("find.excessive.usage.count.prompt",count));
      warningShown[0]=true;
    }
  }
 while (found != 0);
  return count;
}
