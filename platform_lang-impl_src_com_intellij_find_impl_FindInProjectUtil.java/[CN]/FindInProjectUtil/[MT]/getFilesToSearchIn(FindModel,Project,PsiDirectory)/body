{
  final String moduleName=findModel.getModuleName();
  final Module module=moduleName == null ? null : ApplicationManager.getApplication().runReadAction(new Computable<Module>(){
    @Override public Module compute(){
      return ModuleManager.getInstance(project).findModuleByName(moduleName);
    }
  }
);
  final FileIndex fileIndex=module == null ? ProjectRootManager.getInstance(project).getFileIndex() : ModuleRootManager.getInstance(module).getFileIndex();
  if (psiDirectory == null || findModel.isWithSubdirectories() && fileIndex.isInContent(psiDirectory.getVirtualFile())) {
    final Pattern fileMaskRegExp=createFileMaskRegExp(findModel);
    Pair<Boolean,Collection<PsiFile>> fastWords=getFilesForFastWordSearch(findModel,project,psiDirectory,fileMaskRegExp,module,fileIndex);
    final Collection<PsiFile> filesForFastWordSearch=fastWords.getSecond();
    final boolean useIdIndex=fastWords.getFirst() && canOptimizeForFastWordSearch(findModel);
    SearchScope customScope=findModel.getCustomScope();
    final GlobalSearchScope globalCustomScope=toGlobal(project,customScope);
class EnumContentIterator implements ContentIterator {
      final Set<PsiFile> myFiles=new LinkedHashSet<PsiFile>(filesForFastWordSearch);
      final PsiManager psiManager=PsiManager.getInstance(project);
      @Override public boolean processFile(      @NotNull VirtualFile virtualFile){
        ProgressManager.checkCanceled();
        if (virtualFile.isDirectory() || (fileMaskRegExp != null && !fileMaskRegExp.matcher(virtualFile.getName()).matches()) || (globalCustomScope != null && !globalCustomScope.contains(virtualFile))) {
          return true;
        }
        if (useIdIndex && isCoveredByIdIndex(virtualFile)) {
          return true;
        }
        PsiFile psiFile=findFile(psiManager,virtualFile);
        if (psiFile != null && !(psiFile instanceof PsiBinaryFile)) {
          myFiles.add(psiFile);
        }
        return true;
      }
      @NotNull private Collection<PsiFile> getFiles(){
        return myFiles;
      }
    }
    EnumContentIterator iterator=new EnumContentIterator();
    if (customScope instanceof LocalSearchScope) {
      for (      VirtualFile file : getLocalScopeFiles((LocalSearchScope)customScope)) {
        iterator.processFile(file);
      }
    }
    if (psiDirectory == null) {
      boolean success=fileIndex.iterateContent(iterator);
      if (success && globalCustomScope != null && globalCustomScope.isSearchInLibraries()) {
        final VirtualFile[] librarySources=ApplicationManager.getApplication().runReadAction(new Computable<VirtualFile[]>(){
          @Override public VirtualFile[] compute(){
            OrderEnumerator enumerator=module == null ? OrderEnumerator.orderEntries(project) : OrderEnumerator.orderEntries(module);
            return enumerator.withoutModuleSourceEntries().withoutDepModules().getSourceRoots();
          }
        }
);
        iterateAll(librarySources,globalCustomScope,iterator);
      }
    }
 else {
      fileIndex.iterateContentUnderDirectory(psiDirectory.getVirtualFile(),iterator);
    }
    return iterator.getFiles();
  }
  if (psiDirectory.isValid()) {
    final Collection<PsiFile> fileList=new THashSet<PsiFile>();
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      @Override public void run(){
        addFilesUnderDirectory(psiDirectory,fileList,findModel.isWithSubdirectories(),createFileMaskRegExp(findModel));
      }
    }
);
    return fileList;
  }
  return Collections.emptyList();
}
