{
  final ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  final Collection<PsiFile> psiFiles=getFilesToSearchIn(findModel,project,psiDirectory);
  try {
    final Set<PsiFile> largeFiles=new THashSet<PsiFile>();
    int i=0;
    long totalFilesSize=0;
    int count=0;
    final boolean[] warningShown={false};
    for (    final PsiFile psiFile : psiFiles) {
      final VirtualFile virtualFile=psiFile.getVirtualFile();
      final int index=i++;
      if (virtualFile == null)       continue;
      long fileLength=UsageViewManagerImpl.getFileLength(virtualFile);
      if (fileLength == -1)       continue;
      if (ProjectCoreUtil.isProjectOrWorkspaceFile(virtualFile) && !Registry.is("find.search.in.project.files"))       continue;
      if (fileLength > SINGLE_FILE_SIZE_LIMIT) {
        largeFiles.add(psiFile);
        continue;
      }
      if (progress != null) {
        progress.checkCanceled();
        progress.setFraction((double)index / psiFiles.size());
        String text=FindBundle.message("find.searching.for.string.in.file.progress",findModel.getStringToFind(),virtualFile.getPresentableUrl());
        progress.setText(text);
        progress.setText2(FindBundle.message("find.searching.for.string.in.file.occurrences.progress",count));
      }
      int countInFile=processUsagesInFile(psiFile,findModel,consumer);
      count+=countInFile;
      if (countInFile > 0) {
        totalFilesSize+=fileLength;
        if (totalFilesSize > FILES_SIZE_LIMIT && !warningShown[0]) {
          warningShown[0]=true;
          String message=FindBundle.message("find.excessive.total.size.prompt",UsageViewManagerImpl.presentableSize(totalFilesSize),ApplicationNamesInfo.getInstance().getProductName());
          UsageLimitUtil.showAndCancelIfAborted(project,message);
        }
      }
    }
    if (!largeFiles.isEmpty()) {
      processPresentation.setLargeFilesWereNotScanned(largeFiles);
    }
  }
 catch (  ProcessCanceledException e) {
  }
  if (progress != null && !progress.isCanceled()) {
    progress.setText(FindBundle.message("find.progress.search.completed"));
  }
}
