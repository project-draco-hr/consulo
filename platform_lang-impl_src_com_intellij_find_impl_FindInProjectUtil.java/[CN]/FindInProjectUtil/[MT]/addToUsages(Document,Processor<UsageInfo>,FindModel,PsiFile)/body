{
  int count=0;
  CharSequence text=document.getCharsSequence();
  if (text == null)   return 0;
  int textLength=document.getTextLength();
  int offset=0;
  Project project=psiFile.getProject();
  UsageViewManager usageViewManager=UsageViewManager.getInstance(project);
  FindManager findManager=FindManager.getInstance(project);
  while (offset < textLength) {
    usageViewManager.checkSearchCanceled();
    FindResult result=findManager.findString(text,offset,findModel,psiFile.getVirtualFile());
    if (!result.isStringFound())     break;
    UsageInfo info=new UsageInfo(psiFile,result.getStartOffset(),result.getEndOffset());
    consumer.process(info);
    count++;
    final int prevOffset=offset;
    offset=result.getEndOffset();
    if (prevOffset == offset) {
      ++offset;
    }
  }
  return count;
}
