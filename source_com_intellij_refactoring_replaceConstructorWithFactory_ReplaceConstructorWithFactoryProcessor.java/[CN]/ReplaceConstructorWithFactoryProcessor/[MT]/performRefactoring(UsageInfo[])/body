{
  try {
    PsiReferenceExpression classReferenceExpression=myFactory.createReferenceExpression(myTargetClass);
    PsiReferenceExpression qualifiedMethodReference=(PsiReferenceExpression)myFactory.createExpressionFromText("A." + myFactoryName,null);
    PsiMethod factoryMethod=(PsiMethod)myTargetClass.add(createFactoryMethod());
    if (myConstructor != null) {
      myConstructor.getModifierList().setModifierProperty(PsiModifier.PRIVATE,true);
      VisibilityUtil.escalateVisibility(myConstructor,factoryMethod);
      for (Iterator<PsiElement> iterator=myNonNewConstructorUsages.iterator(); iterator.hasNext(); ) {
        PsiElement place=iterator.next();
        VisibilityUtil.escalateVisibility(myConstructor,place);
      }
    }
    if (myConstructor == null) {
      PsiMethod constructor=myFactory.createConstructor();
      constructor.getModifierList().setModifierProperty(PsiModifier.PRIVATE,true);
      constructor=(PsiMethod)getConstructorContainingClass().add(constructor);
      VisibilityUtil.escalateVisibility(constructor,myTargetClass);
    }
    for (int i=0; i < usages.length; i++) {
      UsageInfo usage=usages[i];
      PsiNewExpression newExpression=(PsiNewExpression)usage.getElement();
      VisibilityUtil.escalateVisibility(factoryMethod,newExpression);
      PsiMethodCallExpression factoryCall=(PsiMethodCallExpression)myFactory.createExpressionFromText(myFactoryName + "()",newExpression);
      factoryCall.getArgumentList().replace(newExpression.getArgumentList());
      boolean replaceMethodQualifier=false;
      PsiExpression newQualifier=newExpression.getQualifier();
      if (newQualifier != null) {
        newQualifier=(PsiExpression)newQualifier.copy();
      }
      PsiElement resolvedFactoryMethod=factoryCall.getMethodExpression().resolve();
      if (resolvedFactoryMethod != factoryMethod || newQualifier != null) {
        factoryCall.getMethodExpression().replace(qualifiedMethodReference);
        replaceMethodQualifier=true;
      }
      factoryCall=(PsiMethodCallExpression)newExpression.replace(factoryCall);
      if (replaceMethodQualifier) {
        if (newQualifier == null) {
          factoryCall.getMethodExpression().getQualifierExpression().replace(classReferenceExpression);
        }
 else {
          factoryCall.getMethodExpression().getQualifierExpression().replace(newQualifier);
        }
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
