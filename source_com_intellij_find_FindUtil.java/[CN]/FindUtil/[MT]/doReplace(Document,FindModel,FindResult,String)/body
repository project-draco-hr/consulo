{
  final int startOffset=result.getStartOffset();
  final int endOffset=result.getEndOffset();
  if (stringToReplace == null)   return new TextRange(Integer.MAX_VALUE,Integer.MIN_VALUE);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      document.replaceString(startOffset,endOffset,StringUtil.convertLineSeparators(stringToReplace));
    }
  }
);
  int newOffset=startOffset + stringToReplace.length();
  int start=startOffset;
  int end=newOffset;
  if (model.isRegularExpressions()) {
    String toFind=model.getStringToFind();
    if (model.isForward()) {
      if (StringUtil.endsWithChar(toFind,'$')) {
        int i=0;
        int length=toFind.length();
        while (i + 2 <= length && toFind.charAt(length - i - 2) == '\\')         i++;
        if (i % 2 == 0)         end++;
      }
 else       if (StringUtil.startsWithChar(toFind,'^')) {
        while (end < document.getTextLength() && document.getCharsSequence().charAt(end) != '\n')         end++;
      }
    }
 else {
      if (StringUtil.startsWithChar(toFind,'^')) {
        start--;
      }
 else       if (StringUtil.endsWithChar(toFind,'$')) {
        while (start >= 0 && document.getCharsSequence().charAt(start) != '\n')         start--;
      }
    }
  }
  return new TextRange(start,end);
}
