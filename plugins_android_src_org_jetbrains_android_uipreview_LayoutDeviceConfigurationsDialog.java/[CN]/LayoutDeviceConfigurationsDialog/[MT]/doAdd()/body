{
  final Object o=getSelectedDeviceOrDeviceConfig();
  LayoutDevice selectedDevice=null;
  if (o instanceof LayoutDevice) {
    selectedDevice=(LayoutDevice)o;
  }
 else   if (o instanceof LayoutDeviceConfiguration) {
    selectedDevice=((LayoutDeviceConfiguration)o).getDevice();
  }
  final EditConfigurationDialog dialog=new EditConfigurationDialog(myProject,selectedDevice != null && selectedDevice.getType() == LayoutDevice.Type.CUSTOM ? selectedDevice : null);
  dialog.setTitle(AndroidBundle.message("android.layout.preview.add.configuration.dialog.title"));
  dialog.show();
  if (dialog.getExitCode() != OK_EXIT_CODE) {
    return;
  }
  final EditDeviceForm editDeviceForm=dialog.getEditDeviceForm();
  final String deviceName=editDeviceForm.getName();
  final DefaultMutableTreeNode root=(DefaultMutableTreeNode)myTable.getTree().getModel().getRoot();
  LayoutDevice device=myLayoutDeviceManager.getUserLayoutDevice(deviceName);
  DefaultMutableTreeNode deviceNode;
  if (device == null) {
    device=myLayoutDeviceManager.addUserDevice(deviceName,editDeviceForm.getXdpi(),editDeviceForm.getYdpi());
    deviceNode=new DefaultMutableTreeNode(device);
    if (myCustomCategoryRoot == null) {
      myCustomCategoryRoot=new DefaultMutableTreeNode(CUSTOM_CATEGORY_NAME);
      root.add(myCustomCategoryRoot);
      myCustomCategoryRoot.add(deviceNode);
      nodeStructureChanged(root);
    }
 else {
      myCustomCategoryRoot.add(deviceNode);
      nodeStructureChanged(myCustomCategoryRoot);
    }
  }
 else {
    final Pair<Integer,DefaultMutableTreeNode> pair=findObjectInTree((TreeNode)myTable.getTree().getModel().getRoot(),device);
    deviceNode=pair != null ? pair.second : null;
  }
  final LayoutDeviceConfiguration newConfig=myLayoutDeviceManager.addUserConfiguration(device,dialog.getConfigName(),dialog.getConfiguration());
  if (deviceNode != null && newConfig != null) {
    final DefaultMutableTreeNode newConfigNode=new DefaultMutableTreeNode(newConfig);
    deviceNode.add(newConfigNode);
    nodeStructureChanged(deviceNode);
    myTable.getTree().expandPath(new TreePath(deviceNode.getPath()));
    final Pair<Integer,DefaultMutableTreeNode> pair=findObjectInTree(root,newConfig);
    if (pair != null) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          selectRowInTableAndScroll(pair.first);
        }
      }
);
    }
  }
}
