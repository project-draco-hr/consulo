{
  final Set<ManagedLibrary> managed=getUsedLibraries();
  final Set<LibraryManager> usedManagers=ContainerUtil.map2Set(managed,new Function<ManagedLibrary,LibraryManager>(){
    public LibraryManager fun(    ManagedLibrary managedLibrary){
      return managedLibrary.manager;
    }
  }
);
  final Set<Library> usedLibraries=ContainerUtil.map2Set(managed,new Function<ManagedLibrary,Library>(){
    public Library fun(    ManagedLibrary managedLibrary){
      return managedLibrary.library;
    }
  }
);
  final MultiMap<LibraryManager,ManagedLibrary> libs=new MultiMap<LibraryManager,ManagedLibrary>(){
    @Override protected Map<LibraryManager,Collection<ManagedLibrary>> createMap(){
      return new TreeMap<LibraryManager,Collection<ManagedLibrary>>(new Comparator<LibraryManager>(){
        public int compare(        LibraryManager o1,        LibraryManager o2){
          return Arrays.asList(myManagers).indexOf(o2) - Arrays.asList(myManagers).indexOf(o1);
        }
      }
);
    }
  }
;
  final List<Object> toAdd=CollectionFactory.arrayList();
  final Map<Object,ListSeparator> separators=CollectionFactory.newTroveMap();
  for (  Library library : myLibrariesContainer.getAllLibraries()) {
    if (!usedLibraries.contains(library)) {
      final LibraryManager manager=findManagerFor(library);
      if (manager != null && !usedManagers.contains(manager)) {
        libs.putValue(manager,new ManagedLibrary(library,manager));
      }
    }
  }
  for (  final LibraryManager manager : libs.keySet()) {
    if (mainOnly && !isGroovyOrGrails(manager)) {
      continue;
    }
    boolean separatorSet=false;
    for (    ManagedLibrary library : libs.get(manager)) {
      if (!separatorSet) {
        separators.put(library,new ListSeparator(manager.getLibraryCategoryName()));
        separatorSet=true;
      }
      toAdd.add(library);
    }
    toAdd.add(manager);
  }
  JBPopupFactory.getInstance().createListPopup(new ManagedLibrariesPopupStep(toAdd,separators)).showUnderneathOf(component);
}
