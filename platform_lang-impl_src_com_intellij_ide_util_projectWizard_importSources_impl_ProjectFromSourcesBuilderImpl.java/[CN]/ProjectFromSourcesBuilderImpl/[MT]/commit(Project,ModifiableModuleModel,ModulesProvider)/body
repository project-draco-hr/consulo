{
  final boolean fromProjectStructure=model != null;
  ModifiableModelsProvider modelsProvider=new IdeaModifiableModelsProvider();
  final LibraryTable.ModifiableModel projectLibraryTable=modelsProvider.getLibraryTableModifiableModel(project);
  final Map<LibraryDescriptor,Library> projectLibs=new HashMap<LibraryDescriptor,Library>();
  final List<Module> result=new ArrayList<Module>();
  try {
    AccessToken token=WriteAction.start();
    try {
      for (      ProjectDescriptor projectDescriptor : getSelectedDescriptors()) {
        for (        LibraryDescriptor lib : projectDescriptor.getLibraries()) {
          final Collection<File> files=lib.getJars();
          final Library projectLib=projectLibraryTable.createLibrary(lib.getName());
          final Library.ModifiableModel libraryModel=projectLib.getModifiableModel();
          for (          File file : files) {
            libraryModel.addRoot(VfsUtil.getUrlForLibraryRoot(file),OrderRootType.CLASSES);
          }
          libraryModel.commit();
          projectLibs.put(lib,projectLib);
        }
      }
      if (!fromProjectStructure) {
        projectLibraryTable.commit();
      }
    }
  finally {
      token.finish();
    }
  }
 catch (  Exception e) {
    LOG.info(e);
    Messages.showErrorDialog(IdeBundle.message("error.adding.module.to.project",e.getMessage()),IdeBundle.message("title.add.module"));
  }
  final Map<ModuleDescriptor,Module> descriptorToModuleMap=new HashMap<ModuleDescriptor,Module>();
  try {
    AccessToken token=WriteAction.start();
    try {
      final ModifiableModuleModel moduleModel=fromProjectStructure ? model : ModuleManager.getInstance(project).getModifiableModel();
      for (      ProjectDescriptor descriptor : getSelectedDescriptors()) {
        for (        final ModuleDescriptor moduleDescriptor : descriptor.getModules()) {
          final Module module;
          if (moduleDescriptor.isReuseExistingElement()) {
            final ExistingModuleLoader moduleLoader=ImportImlMode.setUpLoader(FileUtil.toSystemIndependentName(moduleDescriptor.computeModuleFilePath()));
            module=moduleLoader.createModule(moduleModel);
          }
 else {
            module=createModule(descriptor,moduleDescriptor,projectLibs,moduleModel);
          }
          result.add(module);
          descriptorToModuleMap.put(moduleDescriptor,module);
        }
      }
      if (!fromProjectStructure) {
        moduleModel.commit();
      }
    }
  finally {
      token.finish();
    }
  }
 catch (  Exception e) {
    LOG.info(e);
    Messages.showErrorDialog(IdeBundle.message("error.adding.module.to.project",e.getMessage()),IdeBundle.message("title.add.module"));
  }
  try {
    AccessToken token=WriteAction.start();
    try {
      for (      ProjectDescriptor data : getSelectedDescriptors()) {
        for (        final ModuleDescriptor descriptor : data.getModules()) {
          final Module module=descriptorToModuleMap.get(descriptor);
          if (module == null) {
            continue;
          }
          final Set<ModuleDescriptor> deps=descriptor.getDependencies();
          if (deps.size() == 0) {
            continue;
          }
          final ModifiableRootModel rootModel=ModuleRootManager.getInstance(module).getModifiableModel();
          for (          ModuleDescriptor dependentDescriptor : deps) {
            final Module dependentModule=descriptorToModuleMap.get(dependentDescriptor);
            if (dependentModule != null) {
              rootModel.addModuleOrderEntry(dependentModule);
            }
          }
          rootModel.commit();
        }
      }
    }
  finally {
      token.finish();
    }
  }
 catch (  Exception e) {
    LOG.info(e);
    Messages.showErrorDialog(IdeBundle.message("error.adding.module.to.project",e.getMessage()),IdeBundle.message("title.add.module"));
  }
  AccessToken token=WriteAction.start();
  try {
    ModulesProvider updatedModulesProvider=fromProjectStructure ? modulesProvider : new DefaultModulesProvider(project);
    for (    ProjectConfigurationUpdater updater : myUpdaters) {
      updater.updateProject(project,modelsProvider,updatedModulesProvider);
    }
  }
  finally {
    token.finish();
  }
  return result;
}
