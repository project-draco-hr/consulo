{
  boolean hasMore=visibleNodes.remove(UsageViewImpl.NULL_NODE);
  final Project project=handler.getProject();
  if (visibleNodes.isEmpty()) {
    if (usages.isEmpty()) {
      String text=UsageViewBundle.message("no.usages.found.in",searchScopePresentableName(handler));
      showHint(text,editor,popupPosition,handler,maxUsages);
      Disposer.dispose(usageView);
      return null;
    }
 else {
    }
  }
  if (visibleNodes.size() == 1 && usages.size() == 1) {
    Usage usage=visibleNodes.iterator().next().getUsage();
    navigateAndHint(usage,UsageViewBundle.message("show.usages.only.usage",searchScopePresentableName(handler)),handler,popupPosition,maxUsages);
    Disposer.dispose(usageView);
    return null;
  }
  if (visibleNodes.size() == 1 && usages.size() >= 1) {
    Usage usage=visibleNodes.iterator().next().getUsage();
    navigateAndHint(usage,UsageViewBundle.message("all.usages.are.in.this.line",usages.size(),searchScopePresentableName(handler)),handler,popupPosition,maxUsages);
    Disposer.dispose(usageView);
    return null;
  }
  if (hasMore) {
    usages.add(NullUsage.INSTANCE);
    visibleNodes.add(UsageViewImpl.NULL_NODE);
  }
  addUsageNodes(usageView.getRoot(),usageView,new ArrayList<UsageNode>());
  final JTable table=new MyTable();
  TableScrollingUtil.installActions(table);
  final Vector<Object> data=new Vector<Object>();
  setModel(table,usages,visibleNodes,usageView,data);
  final Runnable navigateRunnable=new Runnable(){
    public void run(){
      int[] selected=table.getSelectedRows();
      for (      int i : selected) {
        Object value=table.getValueAt(i,0);
        if (value instanceof UsageNode) {
          Usage usage=((UsageNode)value).getUsage();
          if (usage == NullUsage.INSTANCE) {
            appendMoreUsages(editor,popupPosition,handler,maxUsages);
            return;
          }
          navigateAndHint(usage,null,handler,popupPosition,maxUsages);
        }
      }
    }
  }
;
  SpeedSearchBase<JTable> speedSearch=new SpeedSearchBase<JTable>(table){
    protected int getSelectedIndex(){
      return table.getSelectedRow();
    }
    protected Object[] getAllElements(){
      return data.toArray(new Object[data.size()]);
    }
    protected String getElementText(    Object element){
      if (!(element instanceof UsageNode))       return element.toString();
      UsageNode node=(UsageNode)element;
      GroupNode group=(GroupNode)node.getParent();
      return node.getUsage().getPresentation().getPlainText() + group.toString();
    }
    protected void selectElement(    Object element,    String selectedText){
      int i=data.indexOf(element);
      if (i == -1)       return;
      table.getSelectionModel().setSelectionInterval(i,i);
    }
  }
;
  speedSearch.setComparator(new SpeedSearchBase.SpeedSearchComparator(false));
  PopupChooserBuilder builder=new PopupChooserBuilder(table);
  if (title != null) {
    String s;
    if (hasMore) {
      s="<html><body><b>Some</b> " + title + " "+ "<b>(Only "+ (visibleNodes.size() - 1)+ " usages shown)</b></body></html>";
    }
 else {
      s=title + " (" + usages.size()+ " usages found)";
    }
    builder.setTitle(s);
  }
  builder.setMovable(true).setResizable(true);
  builder.setItemChoosenCallback(navigateRunnable);
  final JBPopup[] popup=new JBPopup[1];
  ActionListener editSettings=new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      popup[0].cancel();
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          showDialogAndFindUsages(handler,popupPosition,editor,maxUsages);
        }
      }
);
    }
  }
;
  KeyboardShortcut shortcut=getSettingsShortcut();
  if (shortcut != null) {
    builder.registerKeyboardAction(shortcut.getFirstKeyStroke(),editSettings);
  }
  InplaceButton button=createSettingsButton(handler,popupPosition,editor,maxUsages,new Runnable(){
    public void run(){
      popup[0].cancel();
    }
  }
);
  builder.setCommandButton(button);
  DefaultActionGroup filters=new DefaultActionGroup();
  usageView.addFilteringActions(filters);
  filters.add(new AnAction("Open Find Usages Toolwindow","Show all usages in a separate toolwindow",IconLoader.getIcon("/general/toolWindowFind.png")){
{
      AnAction action=ActionManager.getInstance().getAction(IdeActions.ACTION_FIND_USAGES);
      setShortcutSet(action.getShortcutSet());
    }
    @Override public void actionPerformed(    AnActionEvent e){
      hideHints();
      popup[0].cancel();
      FindUsagesManager findUsagesManager=((FindManagerImpl)FindManager.getInstance(project)).getFindUsagesManager();
      FindUsagesManager.SearchData data=new FindUsagesManager.SearchData();
      data.myOptions=handler.getFindUsagesOptions();
      SmartPsiElementPointer<PsiElement> pointer=SmartPointerManager.getInstance(project).createSmartPsiElementPointer(handler.getPsiElement());
      data.myElements=new SmartPsiElementPointer[]{pointer};
      findUsagesManager.rerunAndRecallFromHistory(data);
    }
  }
);
  ActionToolbar actionToolbar=ActionManager.getInstance().createActionToolbar(ActionPlaces.USAGE_VIEW_TOOLBAR,filters,true);
  actionToolbar.setReservePlaceAutoPopupIcon(false);
  final JComponent toolBar=actionToolbar.getComponent();
  toolBar.setOpaque(false);
  builder.setSettingButton(toolBar);
  popup[0]=builder.createPopup();
  Disposer.register(popup[0],usageView);
  for (  AnAction action : filters.getChildren(null)) {
    action.unregisterCustomShortcutSet(usageView.getComponent());
    action.registerCustomShortcutSet(action.getShortcutSet(),popup[0].getContent());
  }
  final MessageBusConnection messageBusConnection=project.getMessageBus().connect(usageView);
  messageBusConnection.subscribe(UsageFilteringRuleProvider.RULES_CHANGED,new Runnable(){
    public void run(){
      rebuildPopup(usageView,usages,table,popup[0]);
    }
  }
);
  return popup[0];
}
