{
  final String title=presentation.getTabText();
  boolean hadMoreSeparator=visibleNodes.remove(MORE_USAGES_SEPARATOR_NODE);
  final Project project=handler.getProject();
  if (hadMoreSeparator) {
    usages.add(MORE_USAGES_SEPARATOR);
    visibleNodes.add(MORE_USAGES_SEPARATOR_NODE);
  }
  List<UsageNode> outNodes=new ArrayList<UsageNode>();
  addUsageNodes(usageView.getRoot(),usageView,outNodes);
  int filtered=filtered(usages,usageView);
  TableScrollingUtil.installActions(table);
  final Vector<Object> data=new Vector<Object>();
  setTableModel(table,visibleNodes,usageView,data,filtered,presentation);
  table.setRowHeight(PlatformIcons.CLASS_ICON.getIconHeight() + 2);
  table.setShowGrid(false);
  table.setShowVerticalLines(false);
  table.setShowHorizontalLines(false);
  table.setTableHeader(null);
  table.setAutoResizeMode(JTable.AUTO_RESIZE_LAST_COLUMN);
  table.setIntercellSpacing(new Dimension(0,0));
  final Runnable navigateRunnable=new Runnable(){
    @Override public void run(){
      int[] selected=table.getSelectedRows();
      for (      int i : selected) {
        Object value=table.getValueAt(i,0);
        if (value instanceof UsageNode) {
          Usage usage=((UsageNode)value).getUsage();
          if (usage == MORE_USAGES_SEPARATOR) {
            appendMoreUsages(editor,popupPosition,handler,maxUsages);
            return;
          }
          navigateAndHint(usage,null,handler,popupPosition,maxUsages,options);
        }
      }
    }
  }
;
  SpeedSearchBase<JTable> speedSearch=new SpeedSearchBase<JTable>(table){
    @Override protected int getSelectedIndex(){
      return table.getSelectedRow();
    }
    @Override protected int convertIndexToModel(    int viewIndex){
      return table.convertRowIndexToModel(viewIndex);
    }
    @NotNull @Override protected Object[] getAllElements(){
      return ArrayUtil.toObjectArray(data);
    }
    @Override protected String getElementText(    @NotNull Object element){
      if (!(element instanceof UsageNode))       return element.toString();
      UsageNode node=(UsageNode)element;
      GroupNode group=(GroupNode)node.getParent();
      Usage usage=node.getUsage();
      if (usage == MORE_USAGES_SEPARATOR)       return "";
      return usage.getPresentation().getPlainText() + group.toString();
    }
    @Override protected void selectElement(    Object element,    String selectedText){
      int i=data.indexOf(element);
      if (i == -1)       return;
      final int viewRow=table.convertRowIndexToView(i);
      table.getSelectionModel().setSelectionInterval(viewRow,viewRow);
    }
  }
;
  speedSearch.setComparator(new SpeedSearchComparator(false));
  PopupChooserBuilder builder=new PopupChooserBuilder(table);
  if (title != null) {
    String result=getFullTitle(usages,title,hadMoreSeparator,visibleNodes.size() - 1);
    builder.setTitle(result);
    builder.setAdText(getSecondInvocationTitle(options,handler));
  }
  builder.setMovable(true).setResizable(true);
  builder.setItemChoosenCallback(navigateRunnable);
  final JBPopup[] popup=new JBPopup[1];
  KeyboardShortcut shortcut=UsageViewImpl.getShowUsagesWithSettingsShortcut();
  if (shortcut != null) {
    new DumbAwareAction(){
      @Override public void actionPerformed(      AnActionEvent e){
        popup[0].cancel();
        showDialogAndFindUsages(handler,popupPosition,editor,maxUsages);
      }
    }
.registerCustomShortcutSet(new CustomShortcutSet(shortcut.getFirstKeyStroke()),table);
  }
  shortcut=getShowUsagesShortcut();
  if (shortcut != null) {
    new DumbAwareAction(){
      @Override public void actionPerformed(      AnActionEvent e){
        popup[0].cancel();
        searchEverywhere(options,handler,editor,popupPosition,maxUsages);
      }
    }
.registerCustomShortcutSet(new CustomShortcutSet(shortcut.getFirstKeyStroke()),table);
  }
  InplaceButton settingsButton=createSettingsButton(handler,popupPosition,editor,maxUsages,new Runnable(){
    @Override public void run(){
      popup[0].cancel();
    }
  }
);
  ActiveComponent spinningProgress=new ActiveComponent(){
    @Override public void setActive(    boolean active){
    }
    @Override public JComponent getComponent(){
      return processIcon;
    }
  }
;
  builder.setCommandButton(new CompositeActiveComponent(spinningProgress,settingsButton));
  DefaultActionGroup toolbar=new DefaultActionGroup();
  usageView.addFilteringActions(toolbar);
  toolbar.add(UsageGroupingRuleProviderImpl.createGroupByFileStructureAction(usageView));
  toolbar.add(new AnAction("Open Find Usages Toolwindow","Show all usages in a separate toolwindow",AllIcons.Toolwindows.ToolWindowFind){
{
      AnAction action=ActionManager.getInstance().getAction(IdeActions.ACTION_FIND_USAGES);
      setShortcutSet(action.getShortcutSet());
    }
    @Override public void actionPerformed(    AnActionEvent e){
      hideHints();
      popup[0].cancel();
      FindUsagesManager findUsagesManager=((FindManagerImpl)FindManager.getInstance(project)).getFindUsagesManager();
      FindUsagesManager.SearchData data=new FindUsagesManager.SearchData();
      data.myOptions=options;
      List<SmartPsiElementPointer<PsiElement>> plist=descriptor.getAllElementPointers();
      data.myElements=plist.toArray(new SmartPsiElementPointer[plist.size()]);
      findUsagesManager.rerunAndRecallFromHistory(data);
    }
  }
);
  ActionToolbar actionToolbar=ActionManager.getInstance().createActionToolbar(ActionPlaces.USAGE_VIEW_TOOLBAR,toolbar,true);
  actionToolbar.setReservePlaceAutoPopupIcon(false);
  final JComponent toolBar=actionToolbar.getComponent();
  toolBar.setOpaque(false);
  builder.setSettingButton(toolBar);
  popup[0]=builder.createPopup();
  JComponent content=popup[0].getContent();
  myWidth=(int)(toolBar.getPreferredSize().getWidth() + new JLabel(getFullTitle(usages,title,hadMoreSeparator,visibleNodes.size() - 1)).getPreferredSize().getWidth() + settingsButton.getPreferredSize().getWidth());
  myWidth=-1;
  for (  AnAction action : toolbar.getChildren(null)) {
    action.unregisterCustomShortcutSet(usageView.getComponent());
    action.registerCustomShortcutSet(action.getShortcutSet(),content);
  }
  return popup[0];
}
