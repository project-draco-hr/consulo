{
  MarkupModel markupModel=getMarkupModel();
  Editor editor=getEditor();
  TextDiffTypeEnum diffTypeEnum=fragment.getType();
  if (diffTypeEnum == null || markupModel == null || editor == null) {
    return;
  }
  TextDiffType type=TextDiffType.create(diffTypeEnum);
  TextRange range=fragment.getRange(getSide());
  TextAttributes attributes=type.getTextAttributes(getEditor());
  if (attributes == null) {
    return;
  }
  RangeHighlighter rangeMarker;
  if (range.getLength() == 0) {
    TextAttributes textAttributes=new TextAttributes(null,null,attributes.getBackgroundColor(),EffectType.BOXED,Font.PLAIN);
    rangeMarker=markupModel.addRangeHighlighter(range.getStartOffset(),range.getStartOffset(),LAYER,textAttributes,HighlighterTargetArea.EXACT_RANGE);
  }
 else {
    rangeMarker=markupModel.addRangeHighlighter(range.getStartOffset(),range.getEndOffset(),LAYER,attributes,HighlighterTargetArea.EXACT_RANGE);
  }
  if (gutterIconRenderer != null) {
    rangeMarker.setGutterIconRenderer(gutterIconRenderer);
  }
  boolean ensureAtLeastOneLineHigh=shouldIncreaseHighlightingHeight(fragment,editor,range);
  rangeMarker.setLineMarkerRenderer(new DiffLineMarkerRenderer(type,ensureAtLeastOneLineHigh));
  Color stripeBarColor=attributes.getErrorStripeColor();
  if (stripeBarColor != null) {
    rangeMarker.setErrorStripeMarkColor(stripeBarColor);
    rangeMarker.setThinErrorStripeMark(true);
  }
  saveHighlighter(rangeMarker);
}
