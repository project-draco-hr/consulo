{
  final PsiReferenceExpressionImpl refExpr=(PsiReferenceExpressionImpl)expr;
  JavaResolveResult result=refExpr.advancedResolve(false);
  PsiElement resolve=result.getElement();
  if (resolve == null) {
    ASTNode refName=refExpr.findChildByRole(ChildRole.REFERENCE_NAME);
    if (refName != null && refName.getText().equals(LENGTH)) {
      ASTNode qualifier=refExpr.findChildByRole(ChildRole.QUALIFIER);
      if (qualifier != null && ElementType.EXPRESSION_BIT_SET.contains(qualifier.getElementType())) {
        PsiType type=((PsiExpression)SourceTreeToPsiMap.treeElementToPsi(qualifier)).getType();
        if (type instanceof PsiArrayType) {
          return PsiType.INT;
        }
      }
    }
    return null;
  }
  PsiType ret;
  if (resolve instanceof PsiVariable) {
    PsiType type=((PsiVariable)resolve).getType();
    ret=type instanceof PsiEllipsisType ? ((PsiEllipsisType)type).toArrayType() : type;
  }
 else   if (resolve instanceof PsiMethod) {
    ret=((PsiMethod)resolve).getReturnType();
  }
 else {
    return null;
  }
  if (ret == null)   return null;
  final LanguageLevel languageLevel=PsiUtil.getLanguageLevel(refExpr);
  if (ret instanceof PsiClassType) {
    ret=((PsiClassType)ret).setLanguageLevel(languageLevel);
  }
  if (languageLevel.compareTo(LanguageLevel.JDK_1_5) >= 0) {
    PsiType substitutedType=result.getSubstitutor().substitute(ret);
    return PsiImplUtil.normalizeWildcardTypeByPosition(substitutedType,refExpr);
  }
  return TypeConversionUtil.erasure(ret);
}
