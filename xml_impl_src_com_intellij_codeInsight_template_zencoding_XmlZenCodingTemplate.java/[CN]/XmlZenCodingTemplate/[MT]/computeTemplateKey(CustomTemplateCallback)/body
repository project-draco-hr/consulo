{
  Editor editor=callback.getEditor();
  int offset=callback.getOffset();
  PsiElement element=callback.getFile().findElementAt(offset > 0 ? offset - 1 : offset);
  int line=editor.getCaretModel().getLogicalPosition().line;
  int lineStart=editor.getDocument().getLineStartOffset(line);
  int parentStart;
  do {
    parentStart=element != null ? element.getTextRange().getStartOffset() : 0;
    int startOffset=parentStart > lineStart ? parentStart : lineStart;
    String key=computeKey(editor,startOffset);
    if (checkTemplateKey(key,callback)) {
      return key;
    }
    if (element != null) {
      element=element.getParent();
    }
  }
 while (element != null && parentStart > lineStart);
  return null;
}
