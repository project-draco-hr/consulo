{
  final Module[] modules=ModuleManager.getInstance(project).getModules();
  Graph<Module> graph=GraphGenerator.create(CachingSemiGraph.create(new GraphGenerator.SemiGraph<Module>(){
    public Collection<Module> getNodes(){
      return Arrays.asList(modules);
    }
    public Iterator<Module> getIn(    Module module){
      return Arrays.asList(ModuleRootManager.getInstance(module).getDependencies()).iterator();
    }
  }
));
  Map<Module,Collection<Module>> result=new HashMap<Module,Collection<Module>>();
  for (Iterator<Module> iterator=graph.getNodes().iterator(); iterator.hasNext(); ) {
    final Module module=iterator.next();
    buildDependenciesForModule(module,graph,result);
  }
  return result;
}
