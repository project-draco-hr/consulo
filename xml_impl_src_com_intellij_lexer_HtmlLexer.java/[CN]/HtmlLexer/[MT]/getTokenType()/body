{
  if (myTokenType != null)   return myTokenType;
  IElementType tokenType=super.getTokenType();
  myTokenStart=super.getTokenStart();
  myTokenEnd=super.getTokenEnd();
  if (hasSeenStyle()) {
    if (hasSeenTag() && ourStyleElementType != null && isStartOfEmbeddmentTagContent(tokenType)) {
      myTokenEnd=skipToTheEndOfTheEmbeddment();
      tokenType=ourStyleElementType;
    }
 else     if (ourInlineStyleElementType != null && isStartOfEmbeddmentAttributeValue(tokenType) && hasSeenAttribute()) {
      tokenType=ourInlineStyleElementType;
    }
  }
 else   if (hasSeenScript()) {
    Language scriptLanguage=getScriptLanguage();
    boolean canInject=scriptLanguage == null || InjectedLanguage.isInjectableLanguage(scriptLanguage);
    if (hasSeenTag() && isStartOfEmbeddmentTagContent(tokenType) && canInject) {
      myTokenEnd=skipToTheEndOfTheEmbeddment();
      IElementType currentScriptElementType=getCurrentScriptElementType();
      tokenType=currentScriptElementType == null ? XmlTokenType.XML_DATA_CHARACTERS : currentScriptElementType;
    }
 else     if (hasSeenAttribute() && isStartOfEmbeddmentAttributeValue(tokenType) && ourInlineScriptElementType != null) {
      myTokenEnd=skipToTheEndOfTheEmbeddment();
      tokenType=ourInlineScriptElementType;
    }
  }
  return myTokenType=tokenType;
}
