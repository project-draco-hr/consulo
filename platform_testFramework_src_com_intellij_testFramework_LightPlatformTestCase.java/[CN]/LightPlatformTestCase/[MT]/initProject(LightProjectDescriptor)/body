{
  ourProjectDescriptor=descriptor;
  final File projectFile=File.createTempFile("lighttemp",ProjectFileType.DOT_DEFAULT_EXTENSION);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @SuppressWarnings({"AssignmentToStaticFieldFromInstanceMethod"}) public void run(){
      if (ourProject != null) {
        closeAndDeleteProject();
      }
 else {
        cleanPersistedVFSContent();
      }
      LocalFileSystem.getInstance().refreshAndFindFileByIoFile(projectFile);
      ByteArrayOutputStream buffer=new ByteArrayOutputStream();
      new Throwable(projectFile.getPath()).printStackTrace(new PrintStream(buffer));
      ourProject=PlatformTestCase.createProject(projectFile,buffer.toString());
      if (!ourHaveShutdownHook) {
        ourHaveShutdownHook=true;
        registerShutdownHook();
      }
      ourPsiManager=null;
      ourModule=createMainModule(descriptor.getModuleType());
      final VirtualFile dummyRoot=VirtualFileManager.getInstance().findFileByUrl("temp:///");
      dummyRoot.refresh(false,false);
      try {
        ourSourceRoot=dummyRoot.createChildDirectory(this,"src");
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
      FileBasedIndex.getInstance().registerIndexableSet(new IndexableFileSet(){
        public boolean isInSet(        final VirtualFile file){
          return ourSourceRoot != null && file.getFileSystem() == ourSourceRoot.getFileSystem();
        }
        public void iterateIndexableFilesIn(        final VirtualFile file,        final ContentIterator iterator){
          if (file.isDirectory()) {
            for (            VirtualFile child : file.getChildren()) {
              iterateIndexableFilesIn(child,iterator);
            }
          }
 else {
            iterator.processFile(file);
          }
        }
      }
);
      final ModuleRootManager rootManager=ModuleRootManager.getInstance(ourModule);
      final ModifiableRootModel rootModel=rootManager.getModifiableModel();
      if (descriptor.getSdk() != null) {
        rootModel.setSdk(descriptor.getSdk());
      }
      final ContentEntry contentEntry=rootModel.addContentEntry(ourSourceRoot);
      contentEntry.addSourceFolder(ourSourceRoot,false);
      descriptor.configureModule(ourModule,rootModel,contentEntry);
      rootModel.commit();
      final MessageBusConnection connection=ourProject.getMessageBus().connect();
      connection.subscribe(ProjectTopics.PROJECT_ROOTS,new ModuleRootListener(){
        public void beforeRootsChange(        ModuleRootEvent event){
          if (!event.isCausedByFileTypesChange()) {
            fail("Root modification in LightIdeaTestCase is not allowed.");
          }
        }
        public void rootsChanged(        ModuleRootEvent event){
        }
      }
);
      connection.subscribe(ProjectTopics.MODULES,new ModuleListener(){
        public void moduleAdded(        Project project,        Module module){
          fail("Adding modules is not permitted in LightIdeaTestCase.");
        }
        public void beforeModuleRemoved(        Project project,        Module module){
        }
        public void moduleRemoved(        Project project,        Module module){
        }
        public void modulesRenamed(        Project project,        List<Module> modules){
        }
      }
);
      ((StartupManagerImpl)StartupManager.getInstance(getProject())).runStartupActivities();
    }
  }
);
}
