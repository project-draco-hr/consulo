{
  try {
    while (true) {
      if (ApplicationManager.getApplication().isDisposeInProgress() || notifierProcess == null || isShuttingDown)       return;
      final String command=readLine();
      if (command == null) {
        startupProcess();
        continue;
      }
      if (GIVEUP_COMMAND.equals(command)) {
        shutdownProcess();
        return;
      }
      if (RESET_COMMAND.equals(command)) {
        reset();
      }
 else       if (UNWATCHEABLE_COMMAND.equals(command)) {
        List<String> roots=new ArrayList<String>();
        do {
          final String path=readLine();
          if (path == null || "#".equals(path))           break;
          roots.add(path);
        }
 while (true);
        setManualWatchRoots(roots);
      }
 else {
        String path=readLine();
        if (path == null) {
          startupProcess();
          continue;
        }
        if (isWatcheable(path)) {
          try {
            onPathChange(ChangeKind.valueOf(command),path);
          }
 catch (          IllegalArgumentException e) {
            LOG.error("Illegal watcher command: " + command);
          }
        }
 else         if (LOG.isDebugEnabled()) {
          LOG.debug("not watcheable, filtered: " + path);
        }
      }
    }
  }
 catch (  IOException e) {
    LOG.info("Watcher terminated and attempt to restart has failed. Exiting watching thread.",e);
  }
}
