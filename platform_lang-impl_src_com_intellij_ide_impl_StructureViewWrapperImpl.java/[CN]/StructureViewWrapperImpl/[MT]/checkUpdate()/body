{
  if (myProject.isDisposed() || !myToolWindow.isVisible())   return;
  final Component owner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
  if (JBPopupFactory.getInstance().isPopupActive())   return;
  final DataContext dataContext=DataManager.getInstance().getDataContext(owner);
  if (dataContext.getData(myKey) == this)   return;
  if (PlatformDataKeys.PROJECT.getData(dataContext) != myProject)   return;
  final VirtualFile[] files=PlatformDataKeys.VIRTUAL_FILE_ARRAY.getData(dataContext);
  if (files != null && files.length == 1) {
    setFile(files[0]);
  }
 else   if (files != null && files.length > 1) {
    setFile(null);
  }
 else   if (myFirstRun) {
    final FileEditorManagerImpl editorManager=(FileEditorManagerImpl)FileEditorManager.getInstance(myProject);
    final List<Pair<VirtualFile,EditorWindow>> history=editorManager.getSelectionHistory();
    if (!history.isEmpty()) {
      setFile(history.get(0).getFirst());
    }
  }
  myFirstRun=false;
}
