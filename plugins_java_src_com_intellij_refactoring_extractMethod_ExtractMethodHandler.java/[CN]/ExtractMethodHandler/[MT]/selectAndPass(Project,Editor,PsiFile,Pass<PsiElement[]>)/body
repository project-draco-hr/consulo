{
  editor.getScrollingModel().scrollToCaret(ScrollType.MAKE_VISIBLE);
  if (!editor.getSelectionModel().hasSelection()) {
    final int offset=editor.getCaretModel().getOffset();
    final List<PsiExpression> expressions=IntroduceVariableBase.collectExpressions(file,editor,offset,true);
    if (expressions.isEmpty()) {
      editor.getSelectionModel().selectLineAtCaret();
    }
 else     if (expressions.size() == 1) {
      callback.pass(new PsiElement[]{expressions.get(0)});
      return;
    }
 else {
      IntroduceTargetChooser.showChooser(editor,expressions,new Pass<PsiExpression>(){
        @Override public void pass(        PsiExpression psiExpression){
          callback.pass(new PsiElement[]{psiExpression});
        }
      }
,new PsiExpressionTrimRenderer.RenderFunction());
      return;
    }
  }
  int startOffset=editor.getSelectionModel().getSelectionStart();
  int endOffset=editor.getSelectionModel().getSelectionEnd();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiElement[] elements;
  PsiExpression expr=CodeInsightUtil.findExpressionInRange(file,startOffset,endOffset);
  if (expr != null) {
    elements=new PsiElement[]{expr};
  }
 else {
    elements=CodeInsightUtil.findStatementsInRange(file,startOffset,endOffset);
    if (elements.length == 0) {
      final PsiExpression expression=IntroduceVariableBase.getSelectedExpression(project,file,startOffset,endOffset);
      if (expression != null && IntroduceVariableBase.getErrorMessage(expression) == null) {
        final PsiType originalType=RefactoringUtil.getTypeByExpressionWithExpectedType(expression);
        if (originalType != null) {
          elements=new PsiElement[]{expression};
        }
      }
    }
  }
  callback.pass(elements);
}
