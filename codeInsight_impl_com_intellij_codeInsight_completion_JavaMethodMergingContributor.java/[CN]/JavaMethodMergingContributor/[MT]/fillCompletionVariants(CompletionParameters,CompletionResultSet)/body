{
  if (parameters.getCompletionType() != CompletionType.SMART && parameters.getCompletionType() != CompletionType.BASIC)   return true;
  final CompletionProcess process=CompletionService.getCompletionService().getCurrentCompletion();
  ProgressManager.getInstance().checkCanceled();
  if (process == null || !process.willAutoInsert(AutoCompletionPolicy.SETTINGS_DEPENDENT,result.getPrefixMatcher()))   return true;
  final Ref<Boolean> wereNonGrouped=Ref.create(false);
  final Map<String,LookupItem<PsiMethod>> methodNameToItem=new LinkedHashMap<String,LookupItem<PsiMethod>>();
  final List<LookupItem<PsiMethod>> allMethodItems=new ArrayList<LookupItem<PsiMethod>>();
  final boolean toContinue=CompletionService.getCompletionService().getVariantsFromContributors(EP_NAME,parameters,this,new Consumer<LookupElement>(){
    public void consume(    final LookupElement element){
      if (!(element instanceof LookupItem)) {
        result.addElement(element);
        return;
      }
      LookupItem item=(LookupItem)element;
      item.setAttribute(JavaCompletionUtil.ALL_METHODS_ATTRIBUTE,null);
      Object o=item.getObject();
      if (item.getAttribute(LookupItem.FORCE_SHOW_SIGNATURE_ATTR) != null || !(o instanceof PsiMethod)) {
        result.addElement(item);
        wereNonGrouped.set(true);
        return;
      }
      allMethodItems.add(item);
      PsiMethod method=(PsiMethod)o;
      String name=method.getName() + "#" + item.getAttribute(JavaCompletionUtil.QUALIFIER_PREFIX_ATTRIBUTE);
      LookupItem<PsiMethod> existing=methodNameToItem.get(name);
      ArrayList<PsiMethod> allMethods;
      if (existing != null) {
        if (existing.getObject().getParameterList().getParametersCount() == 0 && method.getParameterList().getParametersCount() > 0) {
          methodNameToItem.put(name,item);
        }
        allMethods=(ArrayList<PsiMethod>)existing.getAttribute(JavaCompletionUtil.ALL_METHODS_ATTRIBUTE);
      }
 else {
        methodNameToItem.put(name,item);
        allMethods=new ArrayList<PsiMethod>();
      }
      allMethods.add(method);
      item.setAttribute(JavaCompletionUtil.ALL_METHODS_ATTRIBUTE,allMethods);
    }
  }
);
  final boolean justOneMethodName=!wereNonGrouped.get() && methodNameToItem.size() == 1;
  if (!CodeInsightSettings.getInstance().SHOW_SIGNATURES_IN_LOOKUPS || justOneMethodName) {
    for (    final LookupItem<PsiMethod> item : methodNameToItem.values()) {
      result.addElement(item);
    }
  }
 else {
    for (    final LookupItem<PsiMethod> item : allMethodItems) {
      result.addElement(item);
    }
  }
  return toContinue;
}
