{
  Project project=configuration.getProject();
  Module module=getModule(configuration);
  parameters.getProgramParametersList().addParametersString(configuration.getProgramParameters());
  String workingDirectory=configuration.getWorkingDirectory();
  VirtualFile baseDir=project.getBaseDir();
  if (workingDirectory == null || workingDirectory.trim().length() == 0) {
    workingDirectory=PathUtil.getLocalPath(baseDir);
  }
  workingDirectory=expandPath(workingDirectory,module,project);
  if (!FileUtil.isAbsolute(workingDirectory) && baseDir != null) {
    workingDirectory=baseDir.getPath() + "/" + workingDirectory;
  }
  parameters.setWorkingDirectory(workingDirectory);
  parameters.setupEnvs(configuration.getEnvs(),configuration.isPassParentEnvs());
  if (parameters.getEnv() != null) {
    Map<String,String> expanded=new HashMap<String,String>();
    for (    Map.Entry<String,String> each : parameters.getEnv().entrySet()) {
      expanded.put(each.getKey(),expandPath(each.getValue(),module,project));
    }
    parameters.setEnv(expanded);
  }
}
