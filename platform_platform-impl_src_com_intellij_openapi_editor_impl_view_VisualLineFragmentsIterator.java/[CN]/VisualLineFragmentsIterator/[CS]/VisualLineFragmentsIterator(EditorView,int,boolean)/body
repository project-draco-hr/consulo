{
  myView=view;
  EditorImpl editor=view.getEditor();
  myDocument=editor.getDocument();
  FoldingModelEx foldingModel=editor.getFoldingModel();
  FoldRegion[] regions=foldingModel.fetchTopLevel();
  myRegions=regions == null ? FoldRegion.EMPTY_ARRAY : regions;
  int visualLineStartOffset=EditorUtil.getNotFoldedLineStartOffset(editor,offset);
  SoftWrapModelImpl softWrapModel=editor.getSoftWrapModel();
  List<? extends SoftWrap> softWraps=softWrapModel.getRegisteredSoftWraps();
  int currentOrPrevWrapIndex=softWrapModel.getSoftWrapIndex(offset);
  if (currentOrPrevWrapIndex < 0) {
    currentOrPrevWrapIndex=-currentOrPrevWrapIndex - 2;
  }
 else   if (beforeSoftWrap) {
    currentOrPrevWrapIndex--;
  }
  SoftWrap currentOrPrevWrap=currentOrPrevWrapIndex < 0 || currentOrPrevWrapIndex >= softWraps.size() ? null : softWraps.get(currentOrPrevWrapIndex);
  SoftWrap followingWrap=(currentOrPrevWrapIndex + 1) >= softWraps.size() ? null : softWraps.get(currentOrPrevWrapIndex + 1);
  if (currentOrPrevWrap != null && currentOrPrevWrap.getStart() > visualLineStartOffset) {
    visualLineStartOffset=currentOrPrevWrap.getStart();
  }
  myVisualLineStartOffset=mySegmentStartOffset=visualLineStartOffset;
  myCurrentFoldRegionIndex=foldingModel.getLastCollapsedRegionBefore(mySegmentStartOffset) + 1;
  myCurrentEndLogicalLine=myDocument.getLineNumber(mySegmentStartOffset);
  if (mySegmentStartOffset == 0) {
    myCurrentX=myView.getPrefixTextWidthInPixels();
  }
 else   if (currentOrPrevWrap != null && mySegmentStartOffset == currentOrPrevWrap.getStart()) {
    myCurrentX=currentOrPrevWrap.getIndentInPixels();
    myCurrentVisualColumn=currentOrPrevWrap.getIndentInColumns();
  }
  myNextWrapOffset=followingWrap == null ? Integer.MAX_VALUE : followingWrap.getStart();
  setFragmentIterator();
}
