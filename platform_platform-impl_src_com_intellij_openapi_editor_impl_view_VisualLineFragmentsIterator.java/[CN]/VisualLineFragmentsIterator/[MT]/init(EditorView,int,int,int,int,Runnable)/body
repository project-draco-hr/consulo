{
  myQuickEvaluationListener=quickEvaluationListener;
  myView=view;
  EditorImpl editor=view.getEditor();
  myDocument=editor.getDocument();
  FoldingModelEx foldingModel=editor.getFoldingModel();
  FoldRegion[] regions=foldingModel.fetchTopLevel();
  myRegions=regions == null ? FoldRegion.EMPTY_ARRAY : regions;
  SoftWrapModelImpl softWrapModel=editor.getSoftWrapModel();
  List<? extends SoftWrap> softWraps=softWrapModel.getRegisteredSoftWraps();
  SoftWrap currentOrPrevWrap=currentOrPrevWrapIndex < 0 || currentOrPrevWrapIndex >= softWraps.size() ? null : softWraps.get(currentOrPrevWrapIndex);
  SoftWrap followingWrap=(currentOrPrevWrapIndex + 1) < 0 || (currentOrPrevWrapIndex + 1) >= softWraps.size() ? null : softWraps.get(currentOrPrevWrapIndex + 1);
  myVisualLineStartOffset=mySegmentStartOffset=startOffset;
  myCurrentFoldRegionIndex=nextFoldingIndex;
  myCurrentEndLogicalLine=startLogicalLine;
  myCurrentX=myView.getInsets().left;
  if (mySegmentStartOffset == 0) {
    myCurrentX+=myView.getPrefixTextWidthInPixels();
  }
 else   if (currentOrPrevWrap != null && mySegmentStartOffset == currentOrPrevWrap.getStart()) {
    myCurrentX+=currentOrPrevWrap.getIndentInPixels();
    myCurrentVisualColumn=currentOrPrevWrap.getIndentInColumns();
  }
  myNextWrapOffset=followingWrap == null ? Integer.MAX_VALUE : followingWrap.getStart();
  setFragmentIterator();
}
