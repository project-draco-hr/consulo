{
  if (AndroidJpsUtil.isLightBuild(context)) {
    return;
  }
  final Collection<JpsModule> modules=context.getProjectDescriptor().getProject().getModules();
  final Map<JpsModule,AndroidFileSetState> resourcesStates=new HashMap<JpsModule,AndroidFileSetState>();
  final Map<JpsModule,AndroidFileSetState> assetsStates=new HashMap<JpsModule,AndroidFileSetState>();
  final Map<JpsModule,File> manifestFiles=new HashMap<JpsModule,File>();
  try {
    fillStates(modules,resourcesStates,assetsStates,manifestFiles);
    if (!doCaching(context,modules,resourcesStates)) {
      throw new ProjectBuildException();
    }
    if (!doResourcePackaging(context,modules,resourcesStates,assetsStates,manifestFiles)) {
      throw new ProjectBuildException();
    }
    if (!doPackaging(context,modules)) {
      throw new ProjectBuildException();
    }
  }
 catch (  ProjectBuildException e) {
    throw e;
  }
catch (  Exception e) {
    AndroidJpsUtil.handleException(context,e,BUILDER_NAME);
  }
}
