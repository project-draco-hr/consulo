{
  boolean success=true;
  final File dataStorageRoot=context.getDataManager().getDataStorageRoot();
  final boolean releaseBuild=AndroidJpsUtil.isReleaseBuild(context);
  AndroidFileSetStorage resourcesStorage=null;
  AndroidFileSetStorage assetsStorage=null;
  try {
    final String resourcesStorageName=releaseBuild ? "resources_packaging_release" : "resources_packaging_dev";
    resourcesStorage=new AndroidFileSetStorage(dataStorageRoot,resourcesStorageName);
    final String assetsStorageName=releaseBuild ? "assets_packaging_release" : "assets_packaging_dev";
    assetsStorage=new AndroidFileSetStorage(dataStorageRoot,assetsStorageName);
    for (    Module module : modules) {
      final AndroidFacet facet=AndroidJpsUtil.getFacet(module);
      if (facet == null) {
        continue;
      }
      boolean updateState=true;
      if (!facet.isLibrary() && !(context.isMake() && checkUpToDate(module,resourcesStates,resourcesStorage) && checkUpToDate(module,assetsStates,assetsStorage))) {
        updateState=packageResources(facet,context);
        if (!updateState) {
          success=false;
        }
      }
      resourcesStorage.update(module.getName(),updateState ? resourcesStates.get(module) : null);
      assetsStorage.update(module.getName(),updateState ? assetsStates.get(module) : null);
    }
  }
  finally {
    if (resourcesStorage != null) {
      resourcesStorage.close();
    }
    if (assetsStorage != null) {
      assetsStorage.close();
    }
  }
  return success;
}
