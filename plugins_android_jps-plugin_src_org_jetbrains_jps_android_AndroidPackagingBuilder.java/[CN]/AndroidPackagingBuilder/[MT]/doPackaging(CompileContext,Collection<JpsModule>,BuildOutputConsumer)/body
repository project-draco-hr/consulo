{
  final boolean release=AndroidJpsUtil.isReleaseBuild(context);
  final File dataStorageRoot=context.getProjectDescriptor().dataManager.getDataPaths().getDataStorageRoot();
  boolean success=true;
  AndroidFileSetStorage apkFileSetStorage=null;
  AndroidApkBuilderConfigStateStorage apkBuilderConfigStateStorage=null;
  try {
    final String apkFileSetStorageName="apk_builder_file_set" + (release ? "_release" : "_dev");
    apkFileSetStorage=new AndroidFileSetStorage(dataStorageRoot,apkFileSetStorageName);
    final String apkBuilderStateStorageName="apk_builder_config" + (release ? "_release" : "_dev");
    apkBuilderConfigStateStorage=new AndroidApkBuilderConfigStateStorage(dataStorageRoot,apkBuilderStateStorageName);
    for (    JpsModule module : modules) {
      try {
        if (!doPackagingForModule(context,module,apkFileSetStorage,apkBuilderConfigStateStorage,release,outputConsumer)) {
          success=false;
        }
      }
 catch (      IOException e) {
        AndroidJpsUtil.reportExceptionError(context,null,e,BUILDER_NAME);
        success=false;
      }
    }
  }
  finally {
    if (apkFileSetStorage != null) {
      apkFileSetStorage.close();
    }
    if (apkBuilderConfigStateStorage != null) {
      apkBuilderConfigStateStorage.close();
    }
  }
  return success;
}
