{
  if (!AndroidJpsUtil.containsAndroidFacet(context.getProjectDescriptor().project) || AndroidJpsUtil.isLightBuild(context)) {
    return;
  }
  final Collection<Module> modules=context.getProjectDescriptor().project.getModules().values();
  final Map<Module,AndroidFileSetState> resourcesStates=new HashMap<Module,AndroidFileSetState>();
  final Map<Module,AndroidFileSetState> assetsStates=new HashMap<Module,AndroidFileSetState>();
  final Map<Module,File> manifestFiles=new HashMap<Module,File>();
  try {
    fillStates(modules,resourcesStates,assetsStates,manifestFiles);
    if (!doCaching(context,modules,resourcesStates)) {
      throw new ProjectBuildException();
    }
    if (!doResourcePackaging(context,modules,resourcesStates,assetsStates,manifestFiles)) {
      throw new ProjectBuildException();
    }
    if (!doPackaging(context,modules)) {
      throw new ProjectBuildException();
    }
  }
 catch (  ProjectBuildException e) {
    throw e;
  }
catch (  Exception e) {
    AndroidJpsUtil.handleException(context,e,BUILDER_NAME);
  }
}
