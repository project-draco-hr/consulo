{
  if (myInSmartUpdate) {
    for (    RangeHighlighter highlighter : myHighlighters) {
      if (highlighter.isValid() && highlighter.getStartOffset() == textRange.getStartOffset() && highlighter.getEndOffset() == textRange.getEndOffset()) {
        if (attributes.equals(highlighter.getTextAttributes())) {
          highlighter.putUserData(MARKER_USED,YES);
          if (highlighters != myHighlighters) {
            highlighters.add(highlighter);
          }
          return highlighter;
        }
      }
    }
  }
  final RangeHighlighter highlighter=doHightlightRange(textRange,attributes,highlighters);
  if (myInSmartUpdate) {
    highlighter.putUserData(MARKER_USED,YES);
  }
  return highlighter;
}
