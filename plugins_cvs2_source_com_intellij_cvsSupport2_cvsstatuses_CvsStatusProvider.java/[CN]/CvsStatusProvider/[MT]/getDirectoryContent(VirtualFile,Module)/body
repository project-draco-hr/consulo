{
  CvsInfo cvsInfo=getEntriesManager().getCvsInfoFor(directory);
  DirectoryContent result=new DirectoryContent(cvsInfo);
  VirtualFile[] children=CvsVfsUtil.getChildrenOf(directory);
  if (children == null)   children=VirtualFile.EMPTY_ARRAY;
  Collection entries=cvsInfo.getEntries();
  HashMap<String,VirtualFile> nameToFileMap=new HashMap<String,VirtualFile>();
  for (int i=0; i < children.length; i++) {
    VirtualFile child=children[i];
    nameToFileMap.put(child.getName(),child);
  }
  for (Iterator each=entries.iterator(); each.hasNext(); ) {
    Entry entry=(Entry)each.next();
    String fileName=entry.getFileName();
    if (entry.isDirectory()) {
      if (nameToFileMap.containsKey(fileName)) {
        VirtualFile virtualFile=nameToFileMap.get(fileName);
        if (isInContent(virtualFile,module)) {
          result.addDirectory(new VirtualFileEntry(virtualFile,entry));
        }
      }
    }
 else {
      if (nameToFileMap.containsKey(fileName) || entry.isRemoved()) {
        VirtualFile virtualFile=nameToFileMap.get(fileName);
        if (isInContent(virtualFile,module)) {
          result.addFile(new VirtualFileEntry(virtualFile,entry));
        }
      }
 else       if (!entry.isAddedFile()) {
        result.addDeletedFile(entry);
      }
    }
    nameToFileMap.remove(fileName);
  }
  for (Iterator iterator=nameToFileMap.keySet().iterator(); iterator.hasNext(); ) {
    String name=(String)iterator.next();
    VirtualFile unknown=nameToFileMap.get(name);
    if (unknown.isDirectory()) {
      if (isInContent(unknown,module)) {
        result.addUnknownDirectory(unknown);
      }
    }
 else {
      if (isInContent(unknown,module)) {
        boolean isIgnored=result.getCvsInfo().getIgnoreFilter().shouldBeIgnored(unknown.getName());
        if (isIgnored) {
          result.addIgnoredFile(unknown);
        }
 else {
          result.addUnknownFile(unknown);
        }
      }
    }
  }
  return result;
}
