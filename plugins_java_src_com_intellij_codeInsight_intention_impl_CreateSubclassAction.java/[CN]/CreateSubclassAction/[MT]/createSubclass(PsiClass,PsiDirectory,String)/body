{
  final Project project=psiClass.getProject();
  final PsiClass[] targetClass=new PsiClass[1];
  new WriteCommandAction(project,getTitle(psiClass),getTitle(psiClass)){
    @Override protected void run(    Result result) throws Throwable {
      IdeDocumentHistory.getInstance(project).includeCurrentPlaceAsChangePlace();
      final PsiTypeParameterList oldTypeParameterList=psiClass.getTypeParameterList();
      try {
        targetClass[0]=JavaDirectoryService.getInstance().createClass(targetDirectory,className);
      }
 catch (      final IncorrectOperationException e) {
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          @Override public void run(){
            Messages.showErrorDialog(project,CodeInsightBundle.message("intention.error.cannot.create.class.message",className) + "\n" + e.getLocalizedMessage(),CodeInsightBundle.message("intention.error.cannot.create.class.title"));
          }
        }
);
        return;
      }
      startTemplate(oldTypeParameterList,project,psiClass,targetClass[0],false);
    }
  }
.execute();
  if (targetClass[0] == null)   return null;
  if (!ApplicationManager.getApplication().isUnitTestMode() && !psiClass.hasTypeParameters()) {
    final Editor editor=CodeInsightUtil.positionCursor(project,targetClass[0].getContainingFile(),targetClass[0].getLBrace());
    if (editor == null)     return targetClass[0];
    chooseAndImplement(psiClass,project,targetClass[0],editor);
  }
  return targetClass[0];
}
