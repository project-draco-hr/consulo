{
  final String siteStr=getRequestingSite() == null ? null : getRequestingSite().toString();
  LOG.debug("CommonAuthenticator.getPasswordAuthentication called for " + siteStr);
  final String host=getHostNameReliably(getRequestingHost(),getRequestingSite(),getRequestingURL());
  final int port=getRequestingPort();
  final Map<String,NonStaticAuthenticator> copy;
synchronized (myLock) {
    final HostInfo hostInfo=new HostInfo(getRequestingProtocol(),host,port);
    final Pair<HostInfo,Thread> pair=Pair.create(hostInfo,Thread.currentThread());
    if (myNoProxy.contains(pair)) {
      LOG.debug("CommonAuthenticator.getPasswordAuthentication found host in no proxies set (" + siteStr + ")");
      return null;
    }
    if (myNoAuthentication.contains(pair)) {
      LOG.debug("CommonAuthenticator.getPasswordAuthentication found host in no authentication set (" + siteStr + ")");
      return null;
    }
    copy=new HashMap<String,NonStaticAuthenticator>(myCustomAuth);
  }
  if (!copy.isEmpty()) {
    for (    Map.Entry<String,NonStaticAuthenticator> entry : copy.entrySet()) {
      final NonStaticAuthenticator authenticator=entry.getValue();
      prepareAuthenticator(authenticator);
      final PasswordAuthentication authentication=authenticator.getPasswordAuthentication();
      if (authentication != null) {
        LOG.debug("CommonAuthenticator.getPasswordAuthentication found custom authenticator for " + siteStr + ", "+ entry.getKey()+ ", "+ authenticator.toString());
        logAuthentication(authentication);
        return authentication;
      }
    }
  }
  return null;
}
