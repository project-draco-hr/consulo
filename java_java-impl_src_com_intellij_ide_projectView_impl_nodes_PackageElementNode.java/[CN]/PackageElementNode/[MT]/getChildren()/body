{
  final PackageElement value=getValue();
  if (value == null)   return Collections.emptyList();
  final List<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  final Module module=value.getModule();
  final PsiPackage aPackage=value.getPackage();
  if (!getSettings().isFlattenPackages()) {
    final PsiPackage[] subpackages=PackageUtil.getSubpackages(aPackage,module,myProject,isLibraryElement());
    for (    PsiPackage subpackage : subpackages) {
      PackageUtil.addPackageAsChild(children,subpackage,module,getSettings(),isLibraryElement());
    }
  }
  final GlobalSearchScope scopeToShow=PackageUtil.getScopeToShow(myProject,module,isLibraryElement());
  final PsiDirectory[] dirs=aPackage.getDirectories(scopeToShow);
  for (  final PsiDirectory dir : dirs) {
    children.addAll(ProjectViewDirectoryHelper.getInstance(myProject).getDirectoryChildren(dir,getSettings(),false));
  }
  return children;
}
