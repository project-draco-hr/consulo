{
  final XmlTag parentTag=context != null ? context.getParentTag() : null;
  if (parentTag != null) {
    final XmlElementDescriptor parentDescriptorByType=XmlUtil.findXmlDescriptorByType(parentTag);
    if (parentDescriptorByType != null) {
      return parentDescriptorByType.getElementsDescriptors(parentTag);
    }
  }
  XmlElementDescriptor[] elementsDescriptors=getElementsDescriptorsImpl(context);
  final TypeDescriptor type=getType();
  if (type instanceof ComplexTypeDescriptor) {
    final ComplexTypeDescriptor descriptor=(ComplexTypeDescriptor)type;
    String contextNs;
    PsiFile containingFile=context != null ? context.getContainingFile() : null;
    if (context != null && !containingFile.isPhysical() && containingFile.getOriginalFile() != null) {
      containingFile=containingFile.getOriginalFile();
      context=context.getParentTag();
    }
    if (context != null && (descriptor.canContainTag(context.getLocalName(),contextNs=context.getNamespace()) && (!contextNs.equals(getNamespace()) || descriptor.hasAnyInContentModel()))) {
      final XmlNSDescriptor nsDescriptor=getNSDescriptor();
      if (nsDescriptor != null) {
        elementsDescriptors=ArrayUtil.mergeArrays(elementsDescriptors,nsDescriptor.getRootElementsDescriptors(((XmlFile)containingFile).getDocument()),XmlElementDescriptor.class);
      }
    }
  }
  return elementsDescriptors;
}
