{
  if (context != null) {
    final XmlElementDescriptor parentDescriptorByType=XmlUtil.findXmlDescriptorByType(context);
    if (parentDescriptorByType != null && !parentDescriptorByType.equals(this)) {
      return parentDescriptorByType.getElementsDescriptors(context);
    }
  }
  XmlElementDescriptor[] elementsDescriptors=getElementsDescriptorsImpl(context);
  final TypeDescriptor type=getType(context);
  if (type instanceof ComplexTypeDescriptor) {
    final ComplexTypeDescriptor descriptor=(ComplexTypeDescriptor)type;
    String contextNs;
    PsiFile containingFile=context != null ? context.getContainingFile() : null;
    if (context != null && !containingFile.isPhysical() && containingFile.getOriginalFile() != null) {
      containingFile=containingFile.getOriginalFile();
    }
    if (context != null && (descriptor.canContainTag(context.getLocalName(),contextNs=context.getNamespace(),context) && (!contextNs.equals(getNamespace()) || descriptor.hasAnyInContentModel()))) {
      final XmlNSDescriptor nsDescriptor=getNSDescriptor();
      if (nsDescriptor != null) {
        elementsDescriptors=ArrayUtil.mergeArrays(elementsDescriptors,nsDescriptor.getRootElementsDescriptors(((XmlFile)containingFile).getDocument()),XmlElementDescriptor.class);
      }
    }
  }
  return elementsDescriptors;
}
