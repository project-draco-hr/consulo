{
  final PsiClass holder[][]=new PsiClass[1][];
  ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    public void run(){
      final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
      Collection<PsiClass> set=new HashSet<PsiClass>();
      PsiManager manager=PsiManager.getInstance(filter.getProject());
      PsiSearchHelper helper=manager.getSearchHelper();
      GlobalSearchScope scope=filter.getScope();
      GlobalSearchScope projectScope=GlobalSearchScope.projectScope(manager.getProject());
      scope=projectScope.intersectWith(scope);
      PsiClass apsiclass[]=helper.findAllClasses(scope);
      for (      PsiClass psiClass : apsiclass) {
        if (filter.isAccepted(psiClass)) {
          indicator.setText2("Found test class " + psiClass.getQualifiedName());
          set.add(psiClass);
        }
      }
      holder[0]=set.toArray(new PsiClass[set.size()]);
    }
  }
,"Searching For Tests...",true,filter.getProject());
  return holder[0];
}
