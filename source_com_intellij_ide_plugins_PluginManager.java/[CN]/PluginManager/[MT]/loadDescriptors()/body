{
  if (isLoadingOfExternalPluginsDisabled()) {
    return PluginDescriptor.EMPTY_ARRAY;
  }
  final List<PluginDescriptor> result=new ArrayList<PluginDescriptor>();
  loadDescriptors(PathManager.getPluginsPath(),result);
  loadDescriptors(PathManager.getPreinstalledPluginsPath(),result);
  if (Boolean.valueOf(System.getProperty(IdeaApplication.IDEA_IS_INTERNAL_PROPERTY))) {
    loadDescriptorsFromClassPath(result);
  }
  String errorMessage=filterBadPlugins(result);
  PluginDescriptor[] pluginDescriptors=result.toArray(new PluginDescriptor[result.size()]);
  try {
    Arrays.sort(pluginDescriptors,new PluginDescriptorComparator(pluginDescriptors));
  }
 catch (  Exception e) {
    errorMessage=IdeBundle.message("error.plugins.were.not.loaded",e.getMessage());
    pluginDescriptors=PluginDescriptor.EMPTY_ARRAY;
  }
  if (errorMessage != null) {
    JOptionPane.showMessageDialog(null,errorMessage,IdeBundle.message("title.plugin.error"),JOptionPane.ERROR_MESSAGE);
  }
  return pluginDescriptors;
}
