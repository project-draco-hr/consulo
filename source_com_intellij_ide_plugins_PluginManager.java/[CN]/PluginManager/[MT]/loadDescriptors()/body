{
  if (isLoadingOfExternalPluginsDisabled()) {
    return PluginDescriptor.EMPTY_ARRAY;
  }
  final List<PluginDescriptor> result=new ArrayList<PluginDescriptor>();
  loadDescriptors(PathManager.getPluginsPath(),result);
  loadDescriptors(PathManager.getPreinstalledPluginsPath(),result);
  String errorMessage=filterBadPlugins(result);
  PluginDescriptor[] pluginDescriptors=result.toArray(new PluginDescriptor[result.size()]);
  try {
    Arrays.sort(pluginDescriptors,new PluginDescriptorComparator(pluginDescriptors));
  }
 catch (  Exception e) {
    errorMessage="Error loading plugins:\n" + e.getMessage() + "\nPlugins were not loaded.\nCorrect the above error and restart IDEA.";
    pluginDescriptors=PluginDescriptor.EMPTY_ARRAY;
  }
  if (errorMessage != null) {
    JOptionPane.showMessageDialog(null,errorMessage,"Plugin Error",JOptionPane.ERROR_MESSAGE);
  }
  return pluginDescriptors;
}
