{
  final Map<PluginId,PluginDescriptor> idToDescriptorMap=new HashMap<PluginId,PluginDescriptor>();
  final StringBuffer message=new StringBuffer();
  boolean pluginsWithoutIdFound=false;
  for (Iterator<PluginDescriptor> it=result.iterator(); it.hasNext(); ) {
    final PluginDescriptor descriptor=it.next();
    final PluginId id=descriptor.getPluginId();
    if (idToDescriptorMap.containsKey(id)) {
      if (message.length() > 0) {
        message.append("\n");
      }
      message.append("Duplicate plugin id: ");
      message.append(id);
      it.remove();
    }
 else {
      idToDescriptorMap.put(id,descriptor);
    }
  }
  for (Iterator<PluginDescriptor> it=result.iterator(); it.hasNext(); ) {
    final PluginDescriptor pluginDescriptor=it.next();
    final PluginId[] dependentPluginIds=pluginDescriptor.getDependentPluginIds();
    for (    final PluginId dependentPluginId : dependentPluginIds) {
      if (!idToDescriptorMap.containsKey(dependentPluginId)) {
        if (message.length() > 0) {
          message.append("\n");
        }
        message.append("Plugin \"");
        message.append(pluginDescriptor.getPluginId());
        message.append("\" was not loaded: required plugin \"");
        message.append(dependentPluginId);
        message.append("\" not found.");
        it.remove();
        break;
      }
    }
  }
  if (pluginsWithoutIdFound) {
    if (message.length() > 0) {
      message.append("\n");
    }
    message.append("There were plugins without id found, all such plugins were skipped.");
  }
  if (message.length() > 0) {
    message.insert(0,"Problems found loading plugins:\n");
    return message.toString();
  }
  for (Iterator<PluginDescriptor> iterator=result.iterator(); iterator.hasNext(); ) {
    PluginDescriptor descriptor=iterator.next();
    if (!shouldLoadPlugins() || !shouldLoadPlugin(descriptor)) {
      iterator.remove();
    }
  }
  return null;
}
