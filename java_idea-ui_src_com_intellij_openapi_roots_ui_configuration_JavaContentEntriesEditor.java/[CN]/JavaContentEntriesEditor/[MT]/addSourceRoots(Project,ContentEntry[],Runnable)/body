{
  final HashMap<ContentEntry,List<Pair<File,String>>> entryToRootMap=new HashMap<ContentEntry,List<Pair<File,String>>>();
  final Map<File,ContentEntry> fileToEntryMap=new HashMap<File,ContentEntry>();
  for (  final ContentEntry contentEntry : contentEntries) {
    final VirtualFile file=contentEntry.getFile();
    if (file != null) {
      entryToRootMap.put(contentEntry,null);
      fileToEntryMap.put(VfsUtil.virtualToIoFile(file),contentEntry);
    }
  }
  final ProgressWindow progressWindow=new ProgressWindow(true,project);
  final ProgressIndicator progressIndicator=Patches.MAC_HIDE_QUIT_HACK ? progressWindow : new SmoothProgressAdapter(progressWindow,project);
  final Runnable searchRunnable=new Runnable(){
    public void run(){
      final Runnable process=new Runnable(){
        public void run(){
          for (          final File file : fileToEntryMap.keySet()) {
            progressIndicator.setText(ProjectBundle.message("module.paths.searching.source.roots.progress",file.getPath()));
            final List<Pair<File,String>> roots=JavaUtil.suggestRoots(file);
            entryToRootMap.put(fileToEntryMap.get(file),roots);
          }
        }
      }
;
      progressWindow.setTitle(ProjectBundle.message("module.paths.searching.source.roots.title"));
      ProgressManager.getInstance().runProcess(process,progressIndicator);
    }
  }
;
  final Runnable addSourcesRunnable=new Runnable(){
    public void run(){
      for (      final ContentEntry contentEntry : contentEntries) {
        final List<Pair<File,String>> suggestedRoots=entryToRootMap.get(contentEntry);
        if (suggestedRoots != null) {
          for (          final Pair<File,String> suggestedRoot : suggestedRoots) {
            final VirtualFile sourceRoot=LocalFileSystem.getInstance().findFileByIoFile(suggestedRoot.first);
            final VirtualFile fileContent=contentEntry.getFile();
            if (sourceRoot != null && fileContent != null && VfsUtil.isAncestor(fileContent,sourceRoot,false)) {
              contentEntry.addSourceFolder(sourceRoot,false,suggestedRoot.getSecond());
            }
          }
        }
      }
      if (finishRunnable != null) {
        finishRunnable.run();
      }
    }
  }
;
  new SwingWorker(){
    public Object construct(){
      searchRunnable.run();
      return null;
    }
    public void finished(){
      addSourcesRunnable.run();
    }
  }
.start();
}
