{
  List<DocumentWindow> injected=InjectedLanguageUtil.getCachedInjectedDocuments(myFile);
  Collection<PsiElement> hosts=new THashSet<PsiElement>(elements1.size() + elements2.size() + injected.size());
  for (  DocumentWindow documentRange : injected) {
    progress.checkCanceled();
    if (!documentRange.isValid())     continue;
    PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(documentRange);
    if (file == null)     continue;
    PsiElement context=file.getContext();
    if (context != null && context.isValid() && !file.getProject().isDisposed() && (myUpdateAll || new ProperTextRange(myStartOffset,myEndOffset).intersects(context.getTextRange()))) {
      hosts.add(context);
    }
  }
  hosts.addAll(elements1);
  hosts.addAll(elements2);
  for (  PsiElement element : hosts) {
    progress.checkCanceled();
    final List<PsiFile> destination=myPriorityRange.contains(element.getTextRange()) ? inside : outside;
    InjectedLanguageUtil.enumerate(element,myFile,new PsiLanguageInjectionHost.InjectedPsiVisitor(){
      public void visit(      @NotNull PsiFile injectedPsi,      @NotNull List<PsiLanguageInjectionHost.Shred> places){
        destination.add(injectedPsi);
      }
    }
,false);
  }
}
