{
  Project project=PlatformDataKeys.PROJECT.getData(e.getDataContext());
  if (project == null) {
    setDisabled(e);
    return;
  }
  if (!myListenerInstalled) {
    myListenerInstalled=true;
    ProjectManager.getInstance().addProjectManagerListener(new ProjectManagerAdapter(){
      @Override public void projectClosed(      Project project){
        setDisabled(null);
      }
    }
);
  }
  Component owner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
  if (owner == null) {
    setDisabled(e);
    return;
  }
  final Window windowAncestor=SwingUtilities.getWindowAncestor(owner);
  if (!(windowAncestor instanceof IdeFrame) || windowAncestor instanceof IdeFrame.Child) {
    setDisabled(e);
    return;
  }
  ToolWindowManager mgr=ToolWindowManager.getInstance(project);
  ToolWindow window=myToolWindow;
  if (window != null || mgr.getActiveToolWindowId() != null) {
    if (window == null) {
      window=mgr.getToolWindow(mgr.getActiveToolWindowId());
    }
    if (window == null || !window.isAvailable() || !window.isVisible() || window.getType() == ToolWindowType.FLOATING || !window.isActive()) {
      setDisabled(e);
      return;
    }
    update(e,window,mgr);
    if (e.getPresentation().isEnabled()) {
      myLastWindow=window;
      myLastManager=mgr;
    }
 else {
      setDisabled(e);
    }
  }
 else {
    setDisabled(e);
  }
}
