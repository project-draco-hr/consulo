{
  final VcsRoot[] allRoots=ProjectLevelVcsManager.getInstance(myProject).getAllVcsRoots();
  final TreeMap<VirtualFile,Boolean> rootsMap=new TreeMap<VirtualFile,Boolean>(FilePathComparator.getInstance());
  for (  VirtualFile toSave : rootsToSave) {
    rootsMap.put(toSave,true);
  }
  for (  VcsRoot root : allRoots) {
    final VirtualFile floor=rootsMap.floorKey(root.path);
    if (floor != null && !floor.equals(root.path)) {
      rootsMap.put(root.path,false);
    }
  }
  final Map<VirtualFile,Collection<Change>> result=new HashMap<VirtualFile,Collection<Change>>();
  final Collection<Change> allChanges=myChangeManager.getAllChanges();
  for (  Change change : allChanges) {
    if (change.getBeforeRevision() != null) {
      addChangeIfUnderRoot(rootsMap,result,change,change.getBeforeRevision().getFile());
    }
    if (change.getAfterRevision() != null) {
      addChangeIfUnderRoot(rootsMap,result,change,change.getAfterRevision().getFile());
    }
  }
  return result;
}
