{
  Map<VirtualFile,Collection<Change>> result=new HashMap<VirtualFile,Collection<Change>>();
  final Collection<Change> allChanges=myChangeManager.getAllChanges();
  for (  Change change : allChanges) {
    if (change.getBeforeRevision() != null) {
      addChangeToMap(result,change,change.getBeforeRevision(),rootsToSave);
    }
    if (change.getAfterRevision() != null) {
      addChangeToMap(result,change,change.getAfterRevision(),rootsToSave);
    }
  }
  return result;
}
