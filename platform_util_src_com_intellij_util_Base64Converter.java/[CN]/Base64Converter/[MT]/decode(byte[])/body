{
  int paddingCount=0;
  int realLength=0;
  for (int i=bytes.length - 1; i >= 0; i--) {
    if (bytes[i] > ' ') {
      realLength++;
    }
    if (bytes[i] == '=') {
      paddingCount++;
    }
  }
  if (realLength % 4 != 0) {
    throw new IllegalArgumentException("Incorrect length " + realLength + ". Must be a multiple of 4");
  }
  final byte[] out=new byte[realLength / 4 * 3 - paddingCount];
  final byte[] t=new byte[4];
  int outIndex=0;
  int index=0;
  t[0]=t[1]=t[2]=t[3]='=';
  for (  byte c : bytes) {
    if (c > ' ') {
      t[index++]=c;
    }
    if (index == 4) {
      outIndex+=decode(out,outIndex,t[0],t[1],t[2],t[3]);
      index=0;
      t[0]=t[1]=t[2]=t[3]='=';
    }
  }
  if (index > 0) {
    decode(out,outIndex,t[0],t[1],t[2],t[3]);
  }
  return out;
}
