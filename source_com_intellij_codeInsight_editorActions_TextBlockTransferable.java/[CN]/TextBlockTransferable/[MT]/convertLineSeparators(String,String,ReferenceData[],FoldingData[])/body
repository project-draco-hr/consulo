{
  if (referenceData != null || foldingData != null) {
    int size=0;
    if (referenceData != null) {
      size+=referenceData.length * 2;
    }
    if (foldingData != null) {
      size+=foldingData.length * 2;
    }
    int[] offsets=new int[size];
    int index=0;
    if (referenceData != null) {
      for (      ReferenceData data : referenceData) {
        offsets[index++]=data.startOffset;
        offsets[index++]=data.endOffset;
      }
    }
    if (foldingData != null) {
      for (      FoldingData data : foldingData) {
        offsets[index++]=data.startOffset;
        offsets[index++]=data.endOffset;
      }
    }
    text=StringUtil.convertLineSeparators(text,newSeparator,offsets);
    index=0;
    if (referenceData != null) {
      for (      ReferenceData data : referenceData) {
        data.startOffset=offsets[index++];
        data.endOffset=offsets[index++];
      }
    }
    if (foldingData != null) {
      for (      FoldingData data : foldingData) {
        data.startOffset=offsets[index++];
        data.endOffset=offsets[index++];
      }
    }
    return text;
  }
 else {
    return StringUtil.convertLineSeparators(text,newSeparator);
  }
}
