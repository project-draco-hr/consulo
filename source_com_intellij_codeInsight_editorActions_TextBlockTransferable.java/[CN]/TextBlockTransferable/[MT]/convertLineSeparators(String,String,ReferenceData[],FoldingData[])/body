{
  if (referenceData != null || foldingData != null) {
    int size=0;
    if (referenceData != null) {
      size+=referenceData.length * 2;
    }
    if (foldingData != null) {
      size+=foldingData.length * 2;
    }
    int[] offsets=new int[size];
    int index=0;
    if (referenceData != null) {
      for (int i=0; i < referenceData.length; i++) {
        ReferenceData data=referenceData[i];
        offsets[index++]=data.startOffset;
        offsets[index++]=data.endOffset;
      }
    }
    if (foldingData != null) {
      for (int i=0; i < foldingData.length; i++) {
        FoldingData data=foldingData[i];
        offsets[index++]=data.startOffset;
        offsets[index++]=data.endOffset;
      }
    }
    text=StringUtil.convertLineSeparators(text,newSeparator,offsets);
    index=0;
    if (referenceData != null) {
      for (int i=0; i < referenceData.length; i++) {
        ReferenceData data=referenceData[i];
        data.startOffset=offsets[index++];
        data.endOffset=offsets[index++];
      }
    }
    if (foldingData != null) {
      for (int i=0; i < foldingData.length; i++) {
        FoldingData data=foldingData[i];
        data.startOffset=offsets[index++];
        data.endOffset=offsets[index++];
      }
    }
    return text;
  }
 else {
    return StringUtil.convertLineSeparators(text,newSeparator);
  }
}
