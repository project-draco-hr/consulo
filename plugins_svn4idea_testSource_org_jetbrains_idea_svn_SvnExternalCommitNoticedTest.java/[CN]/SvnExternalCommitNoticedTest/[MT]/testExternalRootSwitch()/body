{
  final String branchUrl=prepareBranchesStructure();
  final SubTree tree=new SubTree(myWorkingCopyDir);
  SvnConfiguration.getInstance(myProject).DETECT_NESTED_COPIES=true;
  myVcs.invokeRefreshSvnRoots(false);
  clManager.ensureUpToDate(false);
  clManager.ensureUpToDate(false);
  SvnFileUrlMapping workingCopies=myVcs.getSvnFileUrlMapping();
  List<RootUrlInfo> infos=workingCopies.getAllWcInfos();
  Assert.assertEquals(1,infos.size());
  Assert.assertEquals(myRepoUrl + "/trunk",infos.get(0).getAbsoluteUrl());
  verify(runSvn("switch",branchUrl,myWorkingCopyDir.getPath()));
  myWorkingCopyDir.refresh(false,true);
  imitateEvent(myWorkingCopyDir);
  sleep(300);
  clManager.ensureUpToDate(false);
  clManager.ensureUpToDate(false);
  workingCopies=myVcs.getSvnFileUrlMapping();
  infos=workingCopies.getAllWcInfos();
  Assert.assertEquals(1,infos.size());
  Assert.assertEquals(branchUrl,infos.get(0).getAbsoluteUrl());
}
