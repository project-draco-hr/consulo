{
  FileDocumentManager.getInstance().saveAllDocuments();
  VirtualFile[] childrenAfter=dirAfter.getChildren();
  if (dirAfter.isInLocalFileSystem()) {
    File[] ioAfter=new File(dirAfter.getPath()).listFiles();
    shallowCompare(childrenAfter,ioAfter);
  }
  VirtualFile[] childrenBefore=dirBefore.getChildren();
  if (dirBefore.isInLocalFileSystem()) {
    File[] ioBefore=new File(dirBefore.getPath()).listFiles();
    shallowCompare(childrenBefore,ioBefore);
  }
  HashMap<String,VirtualFile> mapAfter=buildNameToFileMap(childrenAfter,fileFilter);
  HashMap<String,VirtualFile> mapBefore=buildNameToFileMap(childrenBefore,fileFilter);
  Set<String> keySetAfter=mapAfter.keySet();
  Set<String> keySetBefore=mapBefore.keySet();
  assertEquals(dirAfter.getPath(),keySetAfter,keySetBefore);
  for (  String name : keySetAfter) {
    VirtualFile fileAfter=mapAfter.get(name);
    VirtualFile fileBefore=mapBefore.get(name);
    if (fileAfter.isDirectory()) {
      assertDirectoriesEqual(fileAfter,fileBefore,fileFilter);
    }
 else {
      assertFilesEqual(fileAfter,fileBefore);
    }
  }
}
