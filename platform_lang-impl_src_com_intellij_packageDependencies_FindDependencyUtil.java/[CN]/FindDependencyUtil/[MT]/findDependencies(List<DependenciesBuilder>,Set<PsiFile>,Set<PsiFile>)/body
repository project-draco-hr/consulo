{
  final List<UsageInfo> usages=new ArrayList<UsageInfo>();
  ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  int totalCount=searchIn.size();
  int count=0;
  nextFile:   for (  final PsiFile psiFile : searchIn) {
    count=updateIndicator(indicator,totalCount,count,psiFile);
    if (!psiFile.isValid())     continue;
    final Set<PsiFile> precomputedDeps;
    if (builders != null) {
      final Set<PsiFile> depsByFile=new HashSet<PsiFile>();
      for (      DependenciesBuilder builder : builders) {
        final Set<PsiFile> deps=builder.getDependencies().get(psiFile);
        if (deps != null) {
          depsByFile.addAll(deps);
        }
      }
      precomputedDeps=new HashSet<PsiFile>(depsByFile);
      precomputedDeps.retainAll(searchFor);
      if (precomputedDeps.isEmpty())       continue nextFile;
    }
 else {
      precomputedDeps=Collections.unmodifiableSet(searchFor);
    }
    DependenciesBuilder.analyzeFileDependencies(psiFile,new DependenciesBuilder.DependencyProcessor(){
      @Override public void process(      PsiElement place,      PsiElement dependency){
        PsiFile dependencyFile=dependency.getContainingFile();
        if (precomputedDeps.contains(dependencyFile)) {
          usages.add(new UsageInfo(place));
        }
      }
    }
);
  }
  return usages.toArray(new UsageInfo[usages.size()]);
}
