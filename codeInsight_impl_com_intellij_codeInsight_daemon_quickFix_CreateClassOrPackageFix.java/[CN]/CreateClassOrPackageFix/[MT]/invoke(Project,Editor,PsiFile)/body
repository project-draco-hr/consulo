{
  final boolean unitTestMode=ApplicationManager.getApplication().isUnitTestMode();
  PsiDirectory preferredDirectory=myDirectory;
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final Module moduleForFile=fileIndex.getModuleForFile(file.getVirtualFile());
  if (myWritableDirectoryList.size() > 1 && !unitTestMode) {
    if (moduleForFile != null) {
      for (      PsiDirectory d : myWritableDirectoryList) {
        if (fileIndex.getModuleForFile(d.getVirtualFile()) == moduleForFile) {
          preferredDirectory=d;
          break;
        }
      }
    }
    myDirectory=DirectoryChooserUtil.chooseDirectory(myWritableDirectoryList.toArray(new PsiDirectory[myWritableDirectoryList.size()]),preferredDirectory,project,new HashMap<PsiDirectory,String>());
  }
  if (myDirectory == null)   return;
  if (StringUtil.isEmpty(myCanonicalText))   return;
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      doCreate(moduleForFile);
    }
  }
);
}
