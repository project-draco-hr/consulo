{
  PsiType type=myCalculatedTypes.get(expr);
  if (type == null) {
    type=f.fun(expr);
    if (type == null) {
      type=NULL_TYPE;
    }
    type=ConcurrencyUtil.cacheOrGet(myCalculatedTypes,expr,type);
  }
  if (!type.isValid()) {
    LOG.error("Type is invalid: " + type + "; expr: '"+ expr+ "' is "+ (expr.isValid() ? "valid" : "invalid"));
  }
  return type == NULL_TYPE ? null : type;
}
