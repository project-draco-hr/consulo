{
  if (completion instanceof LookupElement && !(completion instanceof LookupItem)) {
    set.add((LookupElement)completion);
    return;
  }
  LookupElement _ret=LookupItemUtil.objectToLookupItem(completion);
  if (_ret == null || !(_ret instanceof LookupItem))   return;
  LookupItem ret=(LookupItem)_ret;
  final InsertHandler insertHandler=variant.getInsertHandler();
  if (insertHandler != null && ret.getInsertHandler() == null) {
  }
  ret.setInsertHandler(new InsertHandler<LookupElement>(){
    @Override public void handleInsert(    InsertionContext context,    LookupElement item){
      final TailType type=analyzeItem(item.getObject(),context.getFile().findElementAt(context.getStartOffset()));
      new DefaultInsertHandler().handleInsert(context,item);
      if (type != TailType.NONE) {
        context.setAddCompletionChar(false);
        type.processTail(context.getEditor(),context.getTailOffset());
      }
    }
  }
);
  final Map<Object,Object> itemProperties=variant.getItemProperties();
  for (  final Object key : itemProperties.keySet()) {
    ret.setAttribute(key,itemProperties.get(key));
  }
  if ((insertHandler == null || ret.getInsertHandler() != null) && tailType != TailType.NONE) {
    set.add(TailTypeDecorator.withTail(ret,tailType));
  }
 else {
    set.add(ret);
  }
}
