{
  if (file instanceof VirtualFileWindow) {
    return;
  }
  Language prevSubstitutedLang=SUBSTITUTED_LANG_KEY.get(file);
  final Language prevLang=ObjectUtil.notNull(prevSubstitutedLang,originalLang);
  if (!prevLang.is(substitutedLang)) {
    if (file.replace(SUBSTITUTED_LANG_KEY,prevSubstitutedLang,substitutedLang)) {
      if (prevSubstitutedLang == null) {
        return;
      }
      if (ApplicationManager.getApplication().isUnitTestMode()) {
        return;
      }
      file.putUserData(REPARSING_SCHEDULED,true);
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (file.replace(REPARSING_SCHEDULED,true,null)) {
            LOG.info("Reparsing " + file.getPath() + " because of language substitution "+ prevLang.getID()+ "->"+ substitutedLang.getID());
            FileContentUtilCore.reparseFiles(file);
          }
        }
      }
,ModalityState.defaultModalityState());
    }
  }
}
