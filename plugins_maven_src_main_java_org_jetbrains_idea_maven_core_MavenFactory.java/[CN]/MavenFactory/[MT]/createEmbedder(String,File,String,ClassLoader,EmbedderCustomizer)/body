{
  Configuration configuration=new DefaultConfiguration();
  configuration.setConfigurationCustomizer(customizer);
  configuration.setClassLoader(classLoader);
  configuration.setLocalRepository(localRepo);
  MavenEmbedderConsoleLogger l=new MavenEmbedderConsoleLogger();
  l.setThreshold(MavenEmbedderLogger.LEVEL_WARN);
  configuration.setMavenEmbedderLogger(l);
  File userSettingsFile=resolveUserSettingsFile(userSettings);
  if (userSettingsFile != null) {
    configuration.setUserSettingsFile(userSettingsFile);
  }
  File globalSettingsFile=resolveGlobalSettingsFile(mavenHome);
  if (globalSettingsFile != null) {
    configuration.setGlobalSettingsFile(globalSettingsFile);
  }
  validate(configuration);
  System.setProperty(PROP_MAVEN_HOME,mavenHome);
  try {
    MavenEmbedder result=new MavenEmbedder(configuration);
    if (customizer != null) {
      customizer.postCustomize(result);
    }
    return result;
  }
 catch (  MavenEmbedderException e) {
    LOG.info(e);
    throw new MavenException(e);
  }
}
