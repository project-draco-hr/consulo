{
  final Project project=PlatformDataKeys.PROJECT.getData(e.getDataContext());
  if (project == null) {
    return;
  }
  DebuggerContextImpl context=(DebuggerManagerEx.getInstanceEx(project)).getContext();
  final DebuggerSession session=context.getDebuggerSession();
  if (session != null && session.isAttached()) {
    final DebugProcessImpl process=context.getDebugProcess();
    process.getManagerThread().invoke(new DebuggerCommandImpl(){
      protected void action() throws Exception {
        final VirtualMachineProxyImpl vm=process.getVirtualMachineProxy();
        vm.suspend();
        try {
          final List<ThreadState> threads=buildThreadStates(vm);
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            public void run(){
              final DebuggerSessionTab sessionTab=DebuggerPanelsManager.getInstance(project).getSessionTab();
              if (sessionTab != null) {
                sessionTab.addThreadDump(threads);
              }
            }
          }
,ModalityState.NON_MODAL);
        }
  finally {
          vm.resume();
        }
      }
    }
);
  }
}
