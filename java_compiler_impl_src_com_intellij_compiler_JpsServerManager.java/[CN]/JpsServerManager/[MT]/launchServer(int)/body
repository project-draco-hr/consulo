{
  final Sdk projectJdk=JavaAwareProjectJdkTableImpl.getInstanceEx().getInternalJdk();
  final GeneralCommandLine cmdLine=new GeneralCommandLine();
  cmdLine.setExePath(((JavaSdkType)projectJdk.getSdkType()).getVMExecutablePath(projectJdk));
  final StringBuilder cp=new StringBuilder();
  cp.append(getResourcePath(Server.class));
  cp.append(File.pathSeparator).append(getResourcePath(com.google.protobuf.Message.class));
  cp.append(File.pathSeparator).append(getResourcePath(org.jboss.netty.bootstrap.Bootstrap.class));
  final String jpsJar=getResourcePath(Jps.class);
  final File parentFile=new File(jpsJar).getParentFile();
  final File[] files=parentFile.listFiles();
  if (files != null) {
    for (    File file : files) {
      final String name=file.getName();
      final boolean shouldAdd=name.endsWith("jar") && (name.startsWith("ant") || name.startsWith("jps") || name.startsWith("asm")|| name.startsWith("gant")|| name.startsWith("groovy")|| name.startsWith("javac2"));
      if (shouldAdd) {
        cp.append(File.pathSeparator).append(file.getPath());
      }
    }
  }
  cmdLine.addParameter("-classpath");
  cmdLine.addParameter(cp.toString());
  cmdLine.addParameter("org.jetbrains.jpsservice.Server");
  cmdLine.addParameter(Integer.toString(port));
  return cmdLine.createProcess();
}
