{
  disableFormatting();
  try {
    final FormatProcessor processor=new FormatProcessor(model.getDocumentModel(),model.getRootBlock(),settings,indentOptions,affectedRange,true);
    LeafBlockWrapper current=processor.getFirstTokenBlock();
    while (current != null) {
      WhiteSpace whiteSpace=current.getWhiteSpace();
      if (!whiteSpace.isReadOnly()) {
        if (whiteSpace.getTextRange().getStartOffset() > affectedRange.getStartOffset()) {
          whiteSpace.setReadOnly(true);
        }
 else {
          whiteSpace.setReadOnly(false);
        }
      }
      current=current.getNextBlock();
    }
    processor.format(model);
  }
  finally {
    enableFormatting();
  }
}
