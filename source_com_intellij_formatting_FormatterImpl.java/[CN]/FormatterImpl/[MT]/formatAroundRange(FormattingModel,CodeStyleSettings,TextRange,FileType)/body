{
  disableFormatting();
  try {
    final FormattingDocumentModel documentModel=model.getDocumentModel();
    final Block block=model.getRootBlock();
    final FormatProcessor processor=new FormatProcessor(documentModel,block,settings,settings.getIndentOptions(fileType),null);
    LeafBlockWrapper tokenBlock=processor.getFirstTokenBlock();
    while (tokenBlock != null) {
      final WhiteSpace whiteSpace=tokenBlock.getWhiteSpace();
      final TextRange whiteSpaceRange=whiteSpace.getTextRange();
      if (whiteSpaceRange.getEndOffset() < textRange.getStartOffset()) {
        whiteSpace.setIsReadOnly(true);
      }
 else       if (whiteSpaceRange.getStartOffset() > textRange.getStartOffset() && whiteSpaceRange.getEndOffset() < textRange.getEndOffset()) {
        if (whiteSpace.containsLineFeeds()) {
          whiteSpace.setLineFeedsAreReadOnly(true);
        }
 else {
          whiteSpace.setIsReadOnly(true);
        }
      }
 else       if (whiteSpaceRange.getEndOffset() > textRange.getEndOffset() + 1) {
        whiteSpace.setIsReadOnly(true);
      }
      tokenBlock=tokenBlock.getNextBlock();
    }
    processor.formatWithoutRealModifications();
    processor.performModifications(model);
  }
  finally {
    enableFormatting();
  }
}
