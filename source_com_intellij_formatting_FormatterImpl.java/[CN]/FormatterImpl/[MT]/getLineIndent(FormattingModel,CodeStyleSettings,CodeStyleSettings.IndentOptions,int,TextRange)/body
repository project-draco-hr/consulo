{
  final FormattingDocumentModel documentModel=model.getDocumentModel();
  final Block block=model.getRootBlock();
  final FormatProcessor processor=new FormatProcessor(documentModel,block,settings,indentOptions,affectedRange);
  final LeafBlockWrapper blockAfterOffset=processor.getBlockAfter(offset);
  if (blockAfterOffset != null) {
    final WhiteSpace whiteSpace=blockAfterOffset.getWhiteSpace();
    processor.setAllWhiteSpacesAreReadOnly();
    whiteSpace.setLineFeedsAreReadOnly(true);
    final IndentInfo indent;
    if (documentModel.getLineNumber(offset) == documentModel.getLineNumber(whiteSpace.getTextRange().getEndOffset())) {
      whiteSpace.setReadOnly(false);
      processor.formatWithoutRealModifications();
      indent=new IndentInfo(0,whiteSpace.getIndentOffset(),whiteSpace.getSpaces());
    }
 else {
      indent=processor.getIndentAt(offset);
    }
    return indent.generateNewWhiteSpace(indentOptions);
  }
 else {
    return null;
  }
}
