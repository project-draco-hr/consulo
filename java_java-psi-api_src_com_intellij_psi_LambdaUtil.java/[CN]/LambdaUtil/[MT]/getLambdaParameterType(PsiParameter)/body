{
  final PsiElement paramParent=param.getParent();
  if (paramParent instanceof PsiParameterList) {
    final int parameterIndex=((PsiParameterList)paramParent).getParameterIndex(param);
    if (parameterIndex > -1) {
      final PsiLambdaExpression lambdaExpression=PsiTreeUtil.getParentOfType(param,PsiLambdaExpression.class);
      if (lambdaExpression != null) {
        Set<PsiParameterList> currentStack=ourParams.get();
        if (currentStack == null) {
          currentStack=new HashSet<PsiParameterList>();
          ourParams.set(currentStack);
        }
        final PsiParameterList parameterList=lambdaExpression.getParameterList();
        final boolean add=currentStack.add(parameterList);
        try {
          PsiType type=getFunctionalInterfaceType(lambdaExpression,true,parameterIndex);
          if (type == null) {
            type=getFunctionalInterfaceType(lambdaExpression,false);
          }
          if (type instanceof PsiIntersectionType) {
            final PsiType[] conjuncts=((PsiIntersectionType)type).getConjuncts();
            for (            PsiType conjunct : conjuncts) {
              final PsiType lambdaParameterFromType=getLambdaParameterFromType(parameterIndex,lambdaExpression,conjunct);
              if (lambdaParameterFromType != null)               return lambdaParameterFromType;
            }
          }
 else {
            final PsiType lambdaParameterFromType=getLambdaParameterFromType(parameterIndex,lambdaExpression,type);
            if (lambdaParameterFromType != null) {
              return lambdaParameterFromType;
            }
          }
        }
  finally {
          if (add)           currentStack.remove(parameterList);
        }
      }
    }
  }
  return new PsiLambdaParameterType(param);
}
