{
  try {
    getBuilder().setUpdate(false);
    final WizardContext wizardContext=new WizardContext(null);
    if (virtualFile.isDirectory()) {
      final String[] supported=getSupportedExtensions();
      for (      VirtualFile file : getFileChildren(virtualFile)) {
        if (canOpenFile(file,supported)) {
          virtualFile=file;
          break;
        }
      }
    }
    wizardContext.setProjectFileDirectory(virtualFile.getParent().getPath());
    if (!doQuickImport(virtualFile,wizardContext))     return null;
    if (wizardContext.getProjectName() == null) {
      wizardContext.setProjectName(IdeBundle.message("project.import.default.name.dotIdea",getName()));
    }
    final String dotIdeaFilePath=wizardContext.getProjectFileDirectory() + File.separator + Project.DIRECTORY_STORE_FOLDER;
    File dotIdeaFile=new File(dotIdeaFilePath);
    String pathToOpen=dotIdeaFile.getParent();
    boolean shouldOpenExisting=false;
    if (!ApplicationManager.getApplication().isHeadlessEnvironment() && dotIdeaFile.exists()) {
      String existingName="an existing project";
      int result=Messages.showYesNoCancelDialog(projectToClose,IdeBundle.message("project.import.open.existing",existingName,pathToOpen,virtualFile.getName()),IdeBundle.message("title.open.project"),IdeBundle.message("project.import.open.existing.openExisting"),IdeBundle.message("project.import.open.existing.reimport"),CommonBundle.message("button.cancel"),Messages.getQuestionIcon());
      if (result == Messages.CANCEL)       return null;
      shouldOpenExisting=result == Messages.OK;
    }
    final Project projectToOpen;
    if (shouldOpenExisting) {
      try {
        projectToOpen=ProjectManagerEx.getInstanceEx().loadProject(pathToOpen);
      }
 catch (      IOException e) {
        return null;
      }
catch (      JDOMException e) {
        return null;
      }
catch (      InvalidDataException e) {
        return null;
      }
    }
 else {
      projectToOpen=ProjectManagerEx.getInstanceEx().newProject(wizardContext.getProjectName(),pathToOpen,true,false);
      if (projectToOpen == null || !getBuilder().validate(projectToClose,projectToOpen)) {
        return null;
      }
      projectToOpen.save();
      getBuilder().commit(projectToOpen,null,ModulesProvider.EMPTY_MODULES_PROVIDER);
    }
    if (!forceOpenInNewFrame) {
      NewProjectUtilPlatform.closePreviousProject(projectToClose);
    }
    ProjectUtil.updateLastProjectLocation(pathToOpen);
    ProjectManagerEx.getInstanceEx().openProject(projectToOpen);
    return projectToOpen;
  }
  finally {
    getBuilder().cleanup();
  }
}
