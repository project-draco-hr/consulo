{
  String path=storageDir.getPath() + "/" + STORAGE_FILE;
  LocalHistoryStorage result=new LocalHistoryStorage(path);
  long fsTimestamp=getVFSTimestamp();
  int storedVersion=result.getVersion();
  boolean versionMismatch=storedVersion != VERSION;
  boolean timestampMismatch=result.getFSTimestamp() != fsTimestamp;
  if (versionMismatch || timestampMismatch) {
    if (versionMismatch) {
      LocalHistoryLog.LOG.info(MessageFormat.format("local history version mismatch (was: {0}, expected: {1}), rebuilding...",storedVersion,VERSION));
    }
    if (timestampMismatch)     LocalHistoryLog.LOG.info("FS has been rebuild, rebuilding local history...");
    result.dispose();
    if (!FileUtil.delete(storageDir)) {
      throw new IOException("cannot clear storage dir: " + storageDir);
    }
    result=new LocalHistoryStorage(path);
    result.setVersion(VERSION);
    result.setFSTimestamp(fsTimestamp);
  }
  return result;
}
