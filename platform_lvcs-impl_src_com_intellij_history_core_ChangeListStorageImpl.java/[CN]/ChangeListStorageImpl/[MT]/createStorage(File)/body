{
  String path=storageDir.getPath() + "/" + STORAGE_FILE;
  LinkedStorage result=new LinkedStorage(path);
  long fsTimestamp=((PersistentFS)ManagingFS.getInstance()).getCreationTimestamp();
  boolean versionMismatch=result.getVersion() != VERSION;
  boolean timestampMismatch=result.getFSTimestamp() != fsTimestamp;
  if (versionMismatch || timestampMismatch) {
    if (versionMismatch)     LocalHistoryLog.LOG.info("local history version mismatch, rebuilding...");
    if (timestampMismatch)     LocalHistoryLog.LOG.info("FS has been rebuild, rebuilding clearing local history...");
    result.dispose();
    if (!FileUtil.delete(storageDir)) {
      throw new IOException("cannot clear storage dir: " + storageDir);
    }
    result=new LinkedStorage(path);
    result.setVersion(VERSION);
    result.setFSTimestamp(fsTimestamp);
  }
  return result;
}
