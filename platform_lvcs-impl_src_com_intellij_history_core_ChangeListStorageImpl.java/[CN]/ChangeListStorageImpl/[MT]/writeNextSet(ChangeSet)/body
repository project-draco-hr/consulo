{
  if (isCompletelyBroken)   return;
  try {
    int id=myStorage.createNextRecord();
    AbstractStorage.StorageDataOutput out=myStorage.writeStream(id,true);
    try {
      changeSet.write(out);
    }
  finally {
      out.close();
    }
    myStorage.setLastId(myLastId);
    myStorage.force();
    Pair<Long,Integer> os=myStorage.getOffsetAndSize(id);
    LocalHistoryLog.LOG.info("Block was written: " + id + " offset: "+ os.first+ " size: "+ os.second);
    if (ApplicationManagerEx.getApplicationEx().isInternal()) {
      try {
        doReadBlock(id);
      }
 catch (      IOException e) {
        handleError(e,"failed to check the just-written block: " + id);
      }
    }
  }
 catch (  IOException e) {
    handleError(e,null);
  }
}
