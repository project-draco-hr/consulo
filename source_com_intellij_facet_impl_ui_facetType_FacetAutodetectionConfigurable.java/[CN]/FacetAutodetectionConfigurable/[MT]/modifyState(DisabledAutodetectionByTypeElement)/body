{
  if (!myEnableAutoDetectionCheckBox.isSelected()) {
    return new DisabledAutodetectionByTypeElement(myFacetType.getStringId());
  }
  if (state == null) {
    if (myAddedModules.isEmpty()) {
      return null;
    }
    DisabledAutodetectionByTypeElement newState=new DisabledAutodetectionByTypeElement(myFacetType.getStringId());
    for (    String moduleName : myAddedModules) {
      newState.getModuleElements().add(new DisabledAutodetectionInModuleElement(moduleName));
    }
    return newState;
  }
  DisabledAutodetectionByTypeElement newState=copyState(state);
  boolean someModuleRemoved=false;
  for (  String url : myRemovedFiles) {
    String moduleName=myFile2Module.get(url);
    DisabledAutodetectionInModuleElement element=newState.findElement(moduleName);
    if (element != null) {
      boolean removed=element.getFiles().remove(url) | element.getDirectories().remove(url);
      if (removed && element.isDisableInWholeModule()) {
        newState.removeDisabled(moduleName);
        someModuleRemoved=true;
      }
    }
  }
  for (  String moduleName : myAddedModules) {
    newState.getModuleElements().add(new DisabledAutodetectionInModuleElement(moduleName));
  }
  for (  String moduleName : myRemovedModules) {
    someModuleRemoved|=newState.findElement(moduleName) != null;
    newState.removeDisabled(moduleName);
  }
  if ((someModuleRemoved || !myAutodetectionWasEnabled) && newState.getModuleElements().isEmpty()) {
    return null;
  }
  return newState;
}
