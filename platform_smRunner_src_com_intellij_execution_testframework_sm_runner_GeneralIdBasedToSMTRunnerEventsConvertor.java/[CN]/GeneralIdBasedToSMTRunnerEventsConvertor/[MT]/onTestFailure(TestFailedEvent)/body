{
  SMRunnerUtil.addToInvokeLater(new Runnable(){
    public void run(){
      Node node=findNode(testFailedEvent);
      if (node == null) {
        logProblem("Test wasn't started! " + testFailedEvent + ".");
        return;
      }
      stopRunningNode(node,State.FAILED,testFailedEvent);
      SMTestProxy testProxy=node.getProxy();
      String comparisonFailureActualText=testFailedEvent.getComparisonFailureActualText();
      String comparisonFailureExpectedText=testFailedEvent.getComparisonFailureExpectedText();
      String failureMessage=testFailedEvent.getLocalizedFailureMessage();
      String stackTrace=testFailedEvent.getStacktrace();
      if (comparisonFailureActualText != null && comparisonFailureExpectedText != null) {
        testProxy.setTestComparisonFailed(failureMessage,stackTrace,comparisonFailureActualText,comparisonFailureExpectedText);
      }
 else       if (comparisonFailureActualText == null && comparisonFailureExpectedText == null) {
        testProxy.setTestFailed(failureMessage,stackTrace,testFailedEvent.isTestError());
      }
 else {
        logProblem("Comparison failure actual and expected texts should be both null or not null.\n" + "Expected:\n" + comparisonFailureExpectedText + "\n"+ "Actual:\n"+ comparisonFailureActualText);
      }
      fireOnTestFailed(testProxy);
    }
  }
);
}
