{
  if (!CodeInsightSettings.getInstance().INDENT_TO_CARET_ON_PASTE) {
    return;
  }
  final Document document=editor.getDocument();
  final PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(document);
  if (psiFile == null || !acceptFileType(psiFile.getFileType())) {
    return;
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      String pastedText=document.getText(new TextRange(bounds.getStartOffset(),bounds.getEndOffset()));
      if (pastedText.trim().indexOf("\n") < 0) {
        return;
      }
      int startLine=document.getLineNumber(bounds.getStartOffset());
      int endLine=document.getLineNumber(bounds.getEndOffset());
      int startLineStart=document.getLineStartOffset(startLine);
      final String textBeforeFirstLine=document.getText(new TextRange(startLineStart,bounds.getStartOffset()));
      if (textBeforeFirstLine.trim().length() == 0) {
        EditorActionUtil.indentLine(project,editor,startLine,-value.getFirstLineLeadingSpaces());
      }
      for (int i=startLine + 1; i <= endLine; i++) {
        EditorActionUtil.indentLine(project,editor,i,caretColumn - value.getIndent());
      }
      indented.set(Boolean.TRUE);
    }
  }
);
}
