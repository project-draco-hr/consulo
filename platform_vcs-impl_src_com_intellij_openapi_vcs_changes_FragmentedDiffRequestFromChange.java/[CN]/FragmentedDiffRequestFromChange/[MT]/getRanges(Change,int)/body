{
  final FilePath filePath=ChangesUtil.getFilePath(change);
  final RangesCalculator calculator=new RangesCalculator();
  calculator.execute(change,filePath,myRangesCache,LineStatusTrackerManager.getInstance(myProject));
  final VcsException exception=calculator.getException();
  if (exception != null) {
    throw exception;
  }
  final List<BeforeAfter<TextRange>> ranges=calculator.expand(extraLines);
  final PreparedFragmentedContent preparedFragmentedContent=new PreparedFragmentedContent(new FragmentedContent(calculator.getOldDocument(),calculator.getDocument(),ranges));
  if (!ranges.isEmpty()) {
    setHighlighters(filePath,calculator,ranges,preparedFragmentedContent);
    final List<Pair<TextRange,TextAttributes>> beforeTodoRanges=new TodoForRanges(myProject,filePath.getName(),calculator.myOldDocument.getText(),true,preparedFragmentedContent.getBeforeFragments()).execute();
    final List<Pair<TextRange,TextAttributes>> afterTodoRanges=new TodoForRanges(myProject,filePath.getName(),calculator.myDocument.getText(),false,preparedFragmentedContent.getAfterFragments()).execute();
    preparedFragmentedContent.setBeforeTodoRanges(beforeTodoRanges);
    preparedFragmentedContent.setAfterTodoRanges(afterTodoRanges);
  }
  return preparedFragmentedContent;
}
