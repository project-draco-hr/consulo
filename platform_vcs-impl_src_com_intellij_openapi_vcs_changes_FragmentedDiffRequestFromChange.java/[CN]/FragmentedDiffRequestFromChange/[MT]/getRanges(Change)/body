{
  final FilePath filePath=ChangesUtil.getFilePath(change);
  final RangesCalculator calculator=new RangesCalculator();
  calculator.execute(change,filePath,myRangesCache,LineStatusTrackerManager.getInstance(myProject));
  final VcsException exception=calculator.getException();
  if (exception != null) {
    throw exception;
  }
  List<BeforeAfter<TextRange>> ranges=calculator.getRanges();
  if (ranges == null || ranges.isEmpty())   return null;
  final PreparedFragmentedContent preparedFragmentedContent=new PreparedFragmentedContent(myProject,new FragmentedContent(calculator.getOldDocument(),calculator.getDocument(),ranges),filePath.getName(),filePath.getFileType());
  VirtualFile file=filePath.getVirtualFile();
  if (file == null) {
    filePath.hardRefresh();
    file=filePath.getVirtualFile();
  }
  preparedFragmentedContent.setVirtualFile(file);
  return preparedFragmentedContent;
}
