{
  Map<VirtualFile,PsiDirectory> fileToPsiDirMap=new THashMap<VirtualFile,PsiDirectory>(myVFileToPsiDirMap);
  if (useFind) {
    myVFileToPsiDirMap.clear();
  }
  for (Iterator<VirtualFile> iterator=fileToPsiDirMap.keySet().iterator(); iterator.hasNext(); ) {
    VirtualFile vFile=iterator.next();
    if (!vFile.isValid()) {
      iterator.remove();
    }
 else {
      PsiDirectory psiDir=findDirectory(vFile);
      if (psiDir == null) {
        iterator.remove();
      }
    }
  }
  myVFileToPsiDirMap.clear();
  myVFileToPsiDirMap.putAll(fileToPsiDirMap);
  Map<VirtualFile,FileViewProvider> fileToPsiFileMap=new THashMap<VirtualFile,FileViewProvider>(myVFileToViewProviderMap);
  Map<VirtualFile,FileViewProvider> originalFileToPsiFileMap=new THashMap<VirtualFile,FileViewProvider>(myVFileToViewProviderMap);
  if (useFind) {
    myVFileToViewProviderMap.clear();
  }
  for (Iterator<VirtualFile> iterator=fileToPsiFileMap.keySet().iterator(); iterator.hasNext(); ) {
    VirtualFile vFile=iterator.next();
    if (!vFile.isValid()) {
      iterator.remove();
      continue;
    }
    if (useFind) {
      FileViewProvider view=fileToPsiFileMap.get(vFile);
      if (view == null) {
        iterator.remove();
        continue;
      }
      PsiFile psiFile1=findFile(vFile);
      if (psiFile1 == null) {
        iterator.remove();
        continue;
      }
      PsiFile psi=view.getPsi(view.getBaseLanguage());
      if (!areViewProvidersEquivalent(view,psiFile1.getViewProvider())) {
        iterator.remove();
      }
 else       if (psi instanceof PsiFileImpl) {
        ((PsiFileImpl)psi).clearCaches();
      }
    }
  }
  myVFileToViewProviderMap.clear();
  myVFileToViewProviderMap.putAll(fileToPsiFileMap);
  markInvalidations(originalFileToPsiFileMap);
}
