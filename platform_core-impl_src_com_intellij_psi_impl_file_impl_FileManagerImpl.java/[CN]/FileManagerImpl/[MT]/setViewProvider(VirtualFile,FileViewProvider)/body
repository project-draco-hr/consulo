{
  FileViewProvider prev=findCachedViewProvider(virtualFile);
  if (prev == fileViewProvider)   return;
  if (prev != null) {
    DebugUtil.startPsiModification(null);
    try {
      ((SingleRootFileViewProvider)prev).markInvalidated();
      DebugUtil.onInvalidated(prev);
    }
  finally {
      DebugUtil.finishPsiModification();
    }
  }
  if (!(virtualFile instanceof VirtualFileWindow)) {
    if (fileViewProvider == null) {
      myVFileToViewProviderMap.remove(virtualFile);
      Document document=FileDocumentManager.getInstance().getCachedDocument(virtualFile);
      if (document != null) {
        PsiDocumentManagerBase.cachePsi(document,null);
      }
      virtualFile.putUserData(myPsiHardRefKey,null);
    }
 else {
      if (virtualFile instanceof LightVirtualFile) {
        virtualFile.putUserData(myPsiHardRefKey,fileViewProvider);
      }
 else {
        myVFileToViewProviderMap.put(virtualFile,fileViewProvider);
      }
    }
  }
}
