{
  Project project=vcsContext.getProject();
  if (project != null) {
    final ProjectLevelVcsManager vcsManager=ProjectLevelVcsManager.getInstance(project);
    final boolean underVcs=vcsManager.hasActiveVcss();
    if (!underVcs) {
      presentation.setVisible(false);
      return;
    }
    String actionName=getCompleteActionName(vcsContext);
    if (myActionInfo.showOptions(project) || OptionsDialog.shiftIsPressed(vcsContext.getModifiers())) {
      actionName+="...";
    }
    presentation.setText(actionName);
    presentation.setVisible(true);
    presentation.setEnabled(true);
    if (supportingVcsesAreEmpty(vcsManager,myActionInfo)) {
      presentation.setVisible(myAlwaysVisible);
      presentation.setEnabled(false);
      return;
    }
    if (filterRootsBeforeAction()) {
      FilePath[] roots=filterRoots(myScopeInfo.getRoots(vcsContext,myActionInfo),vcsContext);
      if (roots.length == 0) {
        presentation.setVisible(myAlwaysVisible);
        presentation.setEnabled(false);
        return;
      }
    }
    if (presentation.isVisible() && presentation.isEnabled() && vcsManager.isBackgroundVcsOperationRunning()) {
      presentation.setEnabled(false);
    }
  }
 else {
    presentation.setVisible(false);
    presentation.setEnabled(false);
  }
}
