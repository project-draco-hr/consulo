{
  myEditor=editor;
  myParameters=parameters;
  myHandler=handler;
  myContextOriginal=contextOriginal;
  myFreezeSemaphore=freezeSemaphore;
  myLookup=(LookupImpl)LookupManager.getInstance(editor.getProject()).createLookup(editor,new LookupItem[0],"",new CompletionPreferencePolicy(parameters));
  myLookup.addLookupListener(new LookupAdapter(){
    public void itemSelected(    LookupEvent event){
      cancel();
      finishCompletion();
      LookupElement item=event.getItem();
      if (item == null)       return;
      setMergeCommand();
      contextOriginal.setStartOffset(myEditor.getCaretModel().getOffset() - item.getLookupString().length());
      CodeCompletionHandlerBase.selectLookupItem(item,event.getCompletionChar(),contextOriginal,myLookup.getItems());
    }
    public void lookupCanceled(    final LookupEvent event){
      cancel();
      finishCompletion();
    }
  }
);
  myLookup.setCalculating(true);
  myQueue=new MergingUpdateQueue("completion lookup progress",200,true,myEditor.getContentComponent());
  ApplicationManager.getApplication().assertIsDispatchThread();
  registerItself();
  ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
    public void run(){
      for (      final CompletionContributor contributor : CompletionContributor.forParameters(myParameters)) {
        if (myLookup.getAdvertisementText() != null)         return;
        if (!myLookup.isCalculating() && !myLookup.isVisible())         return;
        String s=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
          public String compute(){
            return contributor.advertise(myParameters);
          }
        }
);
        if (myLookup.getAdvertisementText() != null)         return;
        if (s != null) {
          myLookup.setAdvertisementText(s);
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            public void run(){
              updateLookup();
            }
          }
);
          return;
        }
      }
    }
  }
);
}
