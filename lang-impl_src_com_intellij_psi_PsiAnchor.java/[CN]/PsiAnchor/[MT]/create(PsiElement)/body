{
  if (element instanceof PsiCompiledElement) {
    return new HardReference(element);
  }
  PsiFile file=element.getContainingFile();
  if (file == null) {
    return new HardReference(element);
  }
  if (element instanceof StubBasedPsiElement && element.isPhysical() && ((PsiFileImpl)file).getContentElementType() instanceof IStubFileElementType) {
    final StubBasedPsiElement elt=(StubBasedPsiElement)element;
    if (elt.getStub() != null || elt.getElementType().shouldCreateStub(element.getNode())) {
      return new StubIndexReference(file,calcStubIndex((StubBasedPsiElement)element));
    }
  }
  TextRange textRange=element.getTextRange();
  if (textRange == null) {
    return new HardReference(element);
  }
  Language lang=null;
  final FileViewProvider viewProvider=file.getViewProvider();
  final Set<Language> languages=viewProvider.getLanguages();
  for (  Language l : languages) {
    if (PsiTreeUtil.isAncestor(viewProvider.getPsi(l),element,false)) {
      lang=l;
      break;
    }
  }
  if (lang == null)   lang=element.getLanguage();
  return new TreeRangeReference(file,textRange.getStartOffset(),textRange.getEndOffset(),element.getClass(),lang);
}
