{
  myIndicator=indicator;
  final ProjectManager projectManager=ProjectManager.getInstance();
  projectManager.addProjectManagerListener(myProject,myCloseListener=new CloseListener());
  final Semaphore semaphore=((CompilerManagerImpl)CompilerManager.getInstance(myProject)).getCompilationSemaphore();
  boolean acquired=false;
  try {
    try {
      final Application app=ApplicationManager.getApplication();
      while (!acquired) {
        acquired=semaphore.tryAcquire(500,TimeUnit.MILLISECONDS);
        if (indicator.isCanceled()) {
          break;
        }
        if (app.isDispatchThread()) {
          UIUtil.dispatchAllInvocationEvents();
        }
      }
    }
 catch (    InterruptedException ignored) {
    }
    if (!isHeadless()) {
      addIndicatorDelegate();
    }
    myCompileWork.run();
  }
  finally {
    try {
      indicator.stop();
      projectManager.removeProjectManagerListener(myProject,myCloseListener);
    }
  finally {
      if (acquired) {
        semaphore.release();
      }
    }
  }
}
