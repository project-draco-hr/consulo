{
  ProgressIndicator indicator=myIndicator;
  if (!(indicator instanceof ProgressIndicatorEx))   return;
  ((ProgressIndicatorEx)indicator).addStateDelegate(new ProgressIndicatorBase(){
    public void cancel(){
      super.cancel();
      closeUI();
      stopAppIconProgress();
    }
    public void stop(){
      super.stop();
      if (!isCanceled()) {
        closeUI();
      }
      stopAppIconProgress();
      Runnable runnable=new Runnable(){
        public void run(){
          NotificationInfo notificationInfo=getNotificationInfo();
          if (notificationInfo != null && !myMessagesAutoActivated && (myErrorCount > 0 || (myWarningCount > 0 && !ErrorTreeViewConfiguration.getInstance(myProject).isHideWarnings()))) {
            MessageType messageType=myErrorCount > 0 ? MessageType.ERROR : myWarningCount > 0 ? MessageType.WARNING : MessageType.INFO;
            ToolWindowManager.getInstance(myProject).notifyByBalloon(ToolWindowId.MESSAGES_WINDOW,messageType,getNotificationInfo().getNotificationText(),null,null);
          }
        }
      }
;
      ApplicationManager.getApplication().invokeLater(runnable);
    }
    private void stopAppIconProgress(){
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        public void run(){
          AppIcon appIcon=AppIcon.getInstance();
          if (appIcon.hideProgress(myProject,APP_ICON_ID)) {
            if (myErrorCount > 0) {
              appIcon.setErrorBadge(myProject,String.valueOf(myErrorCount));
              appIcon.requestAttention(myProject,true);
            }
 else {
              appIcon.setOkBadge(myProject,true);
              appIcon.requestAttention(myProject,false);
            }
          }
        }
      }
);
    }
    public void setText(    final String text){
      super.setText(text);
      updateProgressText();
    }
    public void setText2(    final String text){
      super.setText2(text);
      updateProgressText();
    }
    public void setFraction(    final double fraction){
      super.setFraction(fraction);
      updateProgressText();
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        public void run(){
          AppIcon.getInstance().setProgress(myProject,APP_ICON_ID,AppIconScheme.Progress.BUILD,fraction,true);
        }
      }
);
    }
    protected void onProgressChange(){
      prepareMessageView();
    }
  }
);
}
