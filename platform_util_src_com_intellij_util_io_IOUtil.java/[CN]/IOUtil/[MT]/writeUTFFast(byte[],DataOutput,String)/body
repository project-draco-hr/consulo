{
  int len=value.length();
  if (len < STRING_LENGTH_THRESHOLD) {
    buffer[0]=(byte)len;
    boolean isAscii=true;
    for (int i=0; i < len; i++) {
      char c=value.charAt(i);
      if (c < 0 || c >= 128) {
        isAscii=false;
        break;
      }
      buffer[i + STRING_HEADER_SIZE]=(byte)c;
    }
    if (isAscii) {
      storage.write(buffer,0,len + STRING_HEADER_SIZE);
      return;
    }
  }
  storage.writeByte((byte)0xFF);
  try {
    storage.writeUTF(value);
  }
 catch (  UTFDataFormatException e) {
    storage.writeUTF(LONGER_THAN_64K_MARKER);
    writeString(value,storage);
  }
}
