{
  UpdaterUI ui=new ConsoleUpdaterUI();
  try {
    File tempPatchFile=Utils.createTempFile();
    PatchFileCreator.create(new File(oldFolder),new File(newFolder),tempPatchFile,ignoredFiles,criticalFiles,optionalFiles,ui);
    ui.startProcess("Packing jar file '" + patchFile + "'...");
    ZipOutputWrapper out=new ZipOutputWrapper(new FileOutputStream(patchFile));
    try {
      ZipInputStream in=new ZipInputStream(new FileInputStream(resolveJarFile()));
      try {
        ZipEntry e;
        while ((e=in.getNextEntry()) != null) {
          out.zipEntry(e,in);
        }
      }
  finally {
        in.close();
      }
      ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
      try {
        Properties props=new Properties();
        props.put(OLD_BUILD_DESCRIPTION,oldBuildDesc);
        props.put(NEW_BUILD_DESCRIPTION,newBuildDesc);
        props.store(byteOut,"");
      }
  finally {
        byteOut.close();
      }
      out.zipBytes(PATCH_PROPERTIES_ENTRY,byteOut);
      out.zipFile(PATCH_FILE_NAME,tempPatchFile);
    }
  finally {
      out.close();
    }
  }
  finally {
    cleanup(ui);
  }
}
