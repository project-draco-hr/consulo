{
  Editor editor=callback.getEditor();
  PsiElement element=callback.getContext();
  int line=editor.getCaretModel().getLogicalPosition().line;
  int lineStart=editor.getDocument().getLineStartOffset(line);
  int elementStart=-1;
  do {
    PsiElement e=element;
    while ((e instanceof LeafPsiElement && ((LeafPsiElement)e).getElementType() == XmlTokenType.XML_DATA_CHARACTERS) || e instanceof PsiWhiteSpace || e instanceof PsiErrorElement) {
      elementStart=e.getTextRange().getStartOffset();
      e=e.getPrevSibling();
    }
    if (elementStart >= 0) {
      int startOffset=elementStart > lineStart ? elementStart : lineStart;
      String key=computeKey(editor,startOffset);
      if (key != null) {
        while (key.length() > 0 && !ZenCodingTemplate.checkTemplateKey(key,callback,this)) {
          key=key.substring(1);
        }
        if (key.length() > 0) {
          return key;
        }
      }
    }
    element=element.getParent();
  }
 while (element != null && elementStart > lineStart);
  return null;
}
