{
synchronized (MIRROR_LOCK) {
    if (myMirrorFileElement == null) {
      VirtualFile virtualFile=getVirtualFile();
      final Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
      String text=document.getText();
      String ext=StdFileTypes.JAVA.getDefaultExtension();
      PsiClass[] classes=getClasses();
      String fileName=(classes.length > 0 ? classes[0].getName() : virtualFile.getNameWithoutExtension()) + "." + ext;
      PsiManager manager=getManager();
      PsiFile mirror=PsiFileFactory.getInstance(manager.getProject()).createFileFromText(fileName,StdLanguages.JAVA,text,false,false);
      final ASTNode mirrorTreeElement=SourceTreeToPsiMap.psiElementToTree(mirror);
      ProgressManager.getInstance().executeNonCancelableSection(new Runnable(){
        public void run(){
          setMirror((TreeElement)mirrorTreeElement);
          myMirrorFileElement.putUserData(DOCUMENT_IN_MIRROR_KEY,document);
        }
      }
);
    }
    return myMirrorFileElement.getPsi();
  }
}
