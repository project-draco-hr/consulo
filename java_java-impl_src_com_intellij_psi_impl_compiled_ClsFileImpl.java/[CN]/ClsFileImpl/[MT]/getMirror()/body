{
synchronized (MIRROR_LOCK) {
    if (myMirrorFileElement == null) {
      FileDocumentManager documentManager=FileDocumentManager.getInstance();
      final Document document=documentManager.getDocument(getVirtualFile());
      String text=document.getText();
      String ext=StdFileTypes.JAVA.getDefaultExtension();
      PsiClass aClass=getClasses()[0];
      String fileName=aClass.getName() + "." + ext;
      PsiManager manager=getManager();
      PsiFile mirror=PsiFileFactory.getInstance(manager.getProject()).createFileFromText(fileName,text);
      final ASTNode mirrorTreeElement=SourceTreeToPsiMap.psiElementToTree(mirror);
      ProgressManager.getInstance().executeNonCancelableSection(new Runnable(){
        public void run(){
          setMirror((TreeElement)mirrorTreeElement);
          myMirrorFileElement.putUserData(DOCUMENT_IN_MIRROR_KEY,document);
        }
      }
);
    }
    return myMirrorFileElement.getPsi();
  }
}
