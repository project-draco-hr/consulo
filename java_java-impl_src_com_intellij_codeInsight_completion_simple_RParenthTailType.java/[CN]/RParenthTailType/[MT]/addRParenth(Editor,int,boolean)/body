{
  int existingRParenthOffset=getExistingRParenthOffset(editor,offset);
  if (existingRParenthOffset < 0) {
    if (spaceWithinParens) {
      offset=insertChar(editor,offset,' ');
    }
    editor.getDocument().insertString(offset,")");
    return moveCaret(editor,offset,1);
  }
  if (spaceWithinParens && offset == existingRParenthOffset) {
    existingRParenthOffset=insertChar(editor,offset,' ');
  }
  return moveCaret(editor,existingRParenthOffset,1);
}
