{
  final GlobalSearchScope scopeToShow=getScopeToShow(project,module,searchInLibraries);
  final PsiDirectory[] dirs=aPackage.getDirectories(scopeToShow);
  final Set<PsiPackage> subpackages=new HashSet<PsiPackage>();
  for (  PsiDirectory dir : dirs) {
    final PsiDirectory[] subdirectories=dir.getSubdirectories();
    for (    PsiDirectory subdirectory : subdirectories) {
      final PsiPackage psiPackage=JavaDirectoryService.getInstance().getPackage(subdirectory);
      if (psiPackage != null) {
        final String name=psiPackage.getName();
        if (name != null && !"".equals(name)) {
          subpackages.add(psiPackage);
        }
      }
    }
  }
  return subpackages.toArray(new PsiPackage[subpackages.size()]);
}
