{
  final CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(project);
  int i;
  for (i=text.length() - 1; i >= 0; i--) {
    char c=text.charAt(i);
    if (c == '\n' || c == '\r')     break;
  }
  i++;
  int spaceCount=0;
  int tabCount=0;
  for (int j=i; j < text.length(); j++) {
    char c=text.charAt(j);
    if (c != '\t') {
      if (!includeNonSpace && c != ' ')       break;
      spaceCount++;
    }
 else {
      tabCount++;
    }
  }
  if (tabCount == 0)   return spaceCount;
  int tabSize=settings.getTabSize(fileType);
  int indentSize=settings.getIndentSize(fileType);
  if (indentSize <= 0) {
    indentSize=1;
  }
  int indentLevel=tabCount * tabSize / indentSize;
  return indentLevel * INDENT_FACTOR + spaceCount;
}
