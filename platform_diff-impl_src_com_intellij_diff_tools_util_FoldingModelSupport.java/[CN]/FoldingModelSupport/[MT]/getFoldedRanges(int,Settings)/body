{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  List<FoldedRangeState> ranges=new ArrayList<FoldedRangeState>();
  DocumentEx document=myEditors[index].getDocument();
  for (  FoldedBlock[] blocks : myFoldings) {
    LineRange expanded=null;
    LineRange collapsed=null;
    for (    FoldedBlock folding : blocks) {
      FoldRegion region=folding.getRegion(index);
      if (region == null || !region.isValid())       continue;
      if (region.isExpanded()) {
        if (expanded == null) {
          int line1=document.getLineNumber(region.getStartOffset());
          int line2=document.getLineNumber(region.getEndOffset()) + 1;
          expanded=new LineRange(line1,line2);
        }
      }
 else {
        int line1=document.getLineNumber(region.getStartOffset());
        int line2=document.getLineNumber(region.getEndOffset()) + 1;
        collapsed=new LineRange(line1,line2);
        break;
      }
    }
    if (expanded != null || collapsed != null) {
      ranges.add(new FoldedRangeState(expanded,collapsed));
    }
  }
  return ranges;
}
