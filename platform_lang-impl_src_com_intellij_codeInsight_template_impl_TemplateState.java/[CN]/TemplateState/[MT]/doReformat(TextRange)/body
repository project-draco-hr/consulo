{
  RangeMarker rangeMarker=null;
  if (range != null) {
    rangeMarker=myDocument.createRangeMarker(range);
    rangeMarker.setGreedyToLeft(true);
    rangeMarker.setGreedyToRight(true);
  }
  final RangeMarker finalRangeMarker=rangeMarker;
  final Runnable action=new Runnable(){
    public void run(){
      IntArrayList indices=initEmptyVariables();
      mySegments.setSegmentsGreedy(false);
      LOG.assertTrue(myTemplateRange.isValid());
      reformat(finalRangeMarker);
      mySegments.setSegmentsGreedy(true);
      restoreEmptyVariables(indices);
    }
  }
;
  ApplicationManager.getApplication().runWriteAction(action);
}
