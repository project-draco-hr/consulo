{
  int selectionSegment=myTemplate.getVariableSegmentNumber(TemplateImpl.SELECTION);
  int endSegmentNumber=selectionSegment >= 0 && getSelectionBeforeTemplate() == null ? selectionSegment : myTemplate.getEndSegmentNumber();
  int offset=-1;
  if (endSegmentNumber >= 0) {
    offset=mySegments.getSegmentStart(endSegmentNumber);
  }
 else {
    if (!myTemplate.isSelectionTemplate() && !myTemplate.isInline()) {
      offset=myTemplateRange.getEndOffset();
    }
  }
  if (isMultiCaretMode() && getCurrentVariableNumber() > -1) {
    offset=-1;
  }
  if (offset >= 0) {
    myEditor.getCaretModel().moveToOffset(offset);
    myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  }
  myEditor.getSelectionModel().removeSelection();
  int selStart=myTemplate.getSelectionStartSegmentNumber();
  int selEnd=myTemplate.getSelectionEndSegmentNumber();
  if (selStart >= 0 && selEnd >= 0) {
    myEditor.getSelectionModel().setSelection(mySegments.getSegmentStart(selStart),mySegments.getSegmentStart(selEnd));
  }
}
