{
  if (isFinished()) {
    return;
  }
  unblockDocument();
  myDocumentChangesTerminateTemplate=false;
  final int oldVar=myCurrentVariableNumber;
  int nextVariableNumber=getNextVariableNumber(oldVar);
  if (nextVariableNumber == -1) {
    calcResults(false);
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        reformat(null);
      }
    }
);
    finishTemplateEditing(false);
    return;
  }
  focusCurrentHighlighter(false);
  calcResults(false);
  doReformat(null);
  setCurrentVariableNumber(nextVariableNumber);
  focusCurrentExpression();
  currentVariableChanged(oldVar);
}
