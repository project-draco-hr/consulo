{
  if (isFinished()) {
    return;
  }
  PsiDocumentManager.getInstance(myProject).commitDocument(myDocument);
  final int currentSegmentNumber=getCurrentSegmentNumber();
  lockSegmentAtTheSameOffsetIfAny();
  if (currentSegmentNumber < 0)   return;
  final int start=mySegments.getSegmentStart(currentSegmentNumber);
  final int end=mySegments.getSegmentEnd(currentSegmentNumber);
  myEditor.getCaretModel().moveToOffset(end);
  myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  myEditor.getSelectionModel().removeSelection();
  final RangeMarker selection=myTemplate.getSubSelection();
  if (selection != null && selection.getStartOffset() >= start && selection.getEndOffset() <= end) {
    myEditor.getSelectionModel().setSelection(selection.getStartOffset(),selection.getEndOffset());
  }
 else {
    myEditor.getSelectionModel().setSelection(start,end);
  }
  Expression expressionNode=myTemplate.getExpressionAt(myCurrentVariableNumber);
  final ExpressionContext context=createExpressionContext(start);
  final LookupElement[] lookupItems=expressionNode.calculateLookupItems(context);
  final PsiFile psiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(myDocument);
  if (lookupItems != null && lookupItems.length > 0) {
    if (((TemplateManagerImpl)TemplateManager.getInstance(myProject)).shouldSkipInTests()) {
      final String s=lookupItems[0].getLookupString();
      EditorModificationUtil.insertStringAtCaret(myEditor,s);
      itemSelected(lookupItems[0],psiFile,currentSegmentNumber,' ',lookupItems);
    }
 else {
      runLookup(currentSegmentNumber,lookupItems,expressionNode.getAdvertisingText(),psiFile);
    }
  }
 else {
    Result result=expressionNode.calculateResult(context);
    if (result != null) {
      result.handleFocused(psiFile,myDocument,mySegments.getSegmentStart(currentSegmentNumber),mySegments.getSegmentEnd(currentSegmentNumber));
    }
  }
  focusCurrentHighlighter(true);
}
