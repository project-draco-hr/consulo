{
  if (isFinished())   return;
  String message;
  if (myPrevTemplate != null) {
    message=myPrevTemplate.getKey();
    if (message == null || message.length() == 0) {
      message=myPrevTemplate.getString();
      if (message == null) {
        message=myPrevTemplate.getTemplateText();
      }
    }
  }
 else {
    message="prev template is null";
  }
  LOG.assertTrue(myTemplate != null,message);
  if (myDocumentChanged) {
    if (myDocumentChangesTerminateTemplate || mySegments.isInvalid()) {
      final int oldIndex=myCurrentVariableNumber;
      setCurrentVariableNumber(-1);
      currentVariableChanged(oldIndex);
      fireTemplateCancelled();
    }
 else {
      calcResults(true);
    }
    myDocumentChanged=false;
  }
}
