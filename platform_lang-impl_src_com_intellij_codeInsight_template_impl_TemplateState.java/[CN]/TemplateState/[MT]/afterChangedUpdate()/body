{
  if (isFinished())   return;
  LOG.assertTrue(myTemplate != null,myPrevTemplate != null ? myPrevTemplate.getKey() : "prev template is null");
  if (myDocumentChanged) {
    if (myDocumentChangesTerminateTemplate || mySegments.isInvalid()) {
      final int oldIndex=myCurrentVariableNumber;
      setCurrentVariableNumber(-1);
      currentVariableChanged(oldIndex);
      fireTemplateCancelled();
    }
 else {
      calcResults(true);
    }
    myDocumentChanged=false;
  }
}
