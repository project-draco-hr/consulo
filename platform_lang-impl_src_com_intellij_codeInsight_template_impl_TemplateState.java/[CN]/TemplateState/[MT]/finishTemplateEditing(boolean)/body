{
  if (myTemplate == null)   return;
  LookupManager.getInstance(myProject).hideActiveLookup();
  int endSegmentNumber=myTemplate.getEndSegmentNumber();
  int offset=-1;
  if (endSegmentNumber >= 0) {
    offset=mySegments.getSegmentStart(endSegmentNumber);
  }
 else {
    if (!myTemplate.isSelectionTemplate() && !myTemplate.isInline()) {
      offset=myTemplateRange.getEndOffset();
    }
  }
  if (offset >= 0) {
    myEditor.getCaretModel().moveToOffset(offset);
    myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  }
  myEditor.getSelectionModel().removeSelection();
  int selStart=myTemplate.getSelectionStartSegmentNumber();
  int selEnd=myTemplate.getSelectionEndSegmentNumber();
  if (selStart >= 0 && selEnd >= 0) {
    myEditor.getSelectionModel().setSelection(mySegments.getSegmentStart(selStart),mySegments.getSegmentStart(selEnd));
  }
  final Editor editor=myEditor;
  fireBeforeTemplateFinished();
  int oldVar=myCurrentVariableNumber;
  setCurrentVariableNumber(-1);
  currentVariableChanged(oldVar);
  ((TemplateManagerImpl)TemplateManager.getInstance(myProject)).clearTemplateState(editor);
  fireTemplateFinished(brokenOff);
  myListeners.clear();
  myProject=null;
}
