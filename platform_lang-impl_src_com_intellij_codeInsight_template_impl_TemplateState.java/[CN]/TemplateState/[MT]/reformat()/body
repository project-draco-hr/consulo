{
  final PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(myDocument);
  if (file != null) {
    CodeStyleManager style=CodeStyleManager.getInstance(myProject);
    for (    TemplateOptionalProcessor optionalProcessor : Extensions.getExtensions(TemplateOptionalProcessor.EP_NAME)) {
      optionalProcessor.processText(myProject,myTemplate,myDocument,myTemplateRange,myEditor);
    }
    if (myTemplate.isToReformat()) {
      try {
        int endSegmentNumber=myTemplate.getEndSegmentNumber();
        PsiDocumentManager.getInstance(myProject).commitDocument(myDocument);
        RangeMarker rangeMarker=null;
        if (endSegmentNumber >= 0) {
          int endVarOffset=mySegments.getSegmentStart(endSegmentNumber);
          PsiElement marker=style.insertNewLineIndentMarker(file,endVarOffset);
          if (marker != null)           rangeMarker=myDocument.createRangeMarker(marker.getTextRange());
        }
        style.reformatText(file,myTemplateRange.getStartOffset(),myTemplateRange.getEndOffset());
        PsiDocumentManager.getInstance(myProject).commitDocument(myDocument);
        PsiDocumentManager.getInstance(myProject).doPostponedOperationsAndUnblockDocument(myDocument);
        if (rangeMarker != null && rangeMarker.isValid()) {
          mySegments.replaceSegmentAt(endSegmentNumber,rangeMarker.getStartOffset(),rangeMarker.getEndOffset());
          myDocument.deleteString(rangeMarker.getStartOffset(),rangeMarker.getEndOffset());
        }
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
 else     if (myTemplate.isToIndent()) {
      if (!myTemplateIndented) {
        smartIndent(myTemplateRange.getStartOffset(),myTemplateRange.getEndOffset());
        myTemplateIndented=true;
      }
    }
  }
}
