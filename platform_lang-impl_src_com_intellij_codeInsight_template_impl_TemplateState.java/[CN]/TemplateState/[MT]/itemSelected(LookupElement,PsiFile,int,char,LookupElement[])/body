{
  if (item != null) {
    PsiDocumentManager.getInstance(myProject).commitAllDocuments();
    final OffsetMap offsetMap=new OffsetMap(myDocument);
    final InsertionContext context=new InsertionContext(offsetMap,(char)0,elements,psiFile,myEditor,false);
    context.setTailOffset(myEditor.getCaretModel().getOffset());
    offsetMap.addOffset(CompletionInitializationContext.START_OFFSET,context.getTailOffset() - item.getLookupString().length());
    offsetMap.addOffset(CompletionInitializationContext.SELECTION_END_OFFSET,context.getTailOffset());
    offsetMap.addOffset(CompletionInitializationContext.IDENTIFIER_END_OFFSET,context.getTailOffset());
    final TemplateLookupSelectionHandler handler=item instanceof LookupItem ? ((LookupItem<?>)item).getAttribute(TemplateLookupSelectionHandler.KEY_IN_LOOKUP_ITEM) : null;
    if (handler != null) {
      handler.itemSelected(item,psiFile,myDocument,mySegments.getSegmentStart(currentSegmentNumber),mySegments.getSegmentEnd(currentSegmentNumber));
    }
 else {
      new WriteCommandAction(myProject){
        @Override protected void run(        com.intellij.openapi.application.Result result) throws Throwable {
          item.handleInsert(context);
        }
      }
.execute();
    }
    Disposer.dispose(offsetMap);
    if (completionChar == '.') {
      EditorModificationUtil.insertStringAtCaret(myEditor,".");
      AutoPopupController.getInstance(myProject).autoPopupMemberLookup(myEditor,null);
      return;
    }
    if (!isFinished()) {
      calcResults(true);
    }
  }
  new WriteCommandAction(myProject){
    @Override protected void run(    com.intellij.openapi.application.Result result) throws Throwable {
      nextTab();
    }
  }
.execute();
}
