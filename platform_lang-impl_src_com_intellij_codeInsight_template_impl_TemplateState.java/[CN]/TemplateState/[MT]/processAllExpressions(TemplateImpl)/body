{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      if (!template.isInline())       myDocument.insertString(myTemplateRange.getStartOffset(),template.getTemplateText());
      for (int i=0; i < template.getSegmentsCount(); i++) {
        int segmentOffset=myTemplateRange.getStartOffset() + template.getSegmentOffset(i);
        mySegments.addSegment(segmentOffset,segmentOffset);
      }
      LOG.assertTrue(myTemplateRange.isValid(),getRangesDebugInfo());
      calcResults(false);
      LOG.assertTrue(myTemplateRange.isValid(),getRangesDebugInfo());
      calcResults(false);
      LOG.assertTrue(myTemplateRange.isValid(),getRangesDebugInfo());
      doReformat(null);
      int nextVariableNumber=getNextVariableNumber(-1);
      if (nextVariableNumber >= 0) {
        fireWaitingForInput();
      }
      if (nextVariableNumber == -1) {
        finishTemplateEditing(false);
      }
 else {
        setCurrentVariableNumber(nextVariableNumber);
        initTabStopHighlighters();
        initListeners();
        focusCurrentExpression();
        currentVariableChanged(-1);
        if (isMultiCaretMode()) {
          finishTemplateEditing(false);
        }
      }
    }
  }
);
}
