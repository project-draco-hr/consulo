{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      final PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(myDocument);
      if (file != null) {
        IntArrayList indices=initEmptyVariables();
        mySegments.setSegmentsGreedy(false);
        for (        TemplateOptionalProcessor processor : Extensions.getExtensions(TemplateOptionalProcessor.EP_NAME)) {
          processor.processText(myProject,myTemplate,myDocument,myTemplateRange,myEditor);
        }
        mySegments.setSegmentsGreedy(true);
        restoreEmptyVariables(indices);
      }
    }
  }
);
}
