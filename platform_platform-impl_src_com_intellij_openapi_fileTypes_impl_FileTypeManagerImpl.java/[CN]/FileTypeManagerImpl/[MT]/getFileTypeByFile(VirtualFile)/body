{
  FileType fileType=file.getUserData(FILE_TYPE_KEY);
  if (fileType != null)   return fileType;
  final FileType assignedFileType=file instanceof LightVirtualFile ? ((LightVirtualFile)file).getAssignedFileType() : null;
  if (assignedFileType != null)   return assignedFileType;
  for (int i=0, size=mySpecialFileTypes.size(); i < size; i++) {
    final FileTypeIdentifiableByVirtualFile type=mySpecialFileTypes.get(i);
    if (type.isMyFileType(file))     return type;
  }
  FileType byName=getFileTypeByFileName(file.getName());
  if (byName != UnknownFileType.INSTANCE)   return byName;
  FileType detected=LoadTextUtil.detectFromContent(file);
  if (detected != UnknownFileType.INSTANCE)   cacheFileType(file,detected);
  return detected;
}
