{
  FileType fileType=file.getUserData(FILE_TYPE_KEY);
  if (fileType != null)   return fileType;
  final FileType assignedFileType=file instanceof LightVirtualFile ? ((LightVirtualFile)file).getAssignedFileType() : null;
  if (assignedFileType != null)   return assignedFileType;
  for (int i=0, size=mySpecialFileTypes.size(); i < size; i++) {
    final FileTypeIdentifiableByVirtualFile type=mySpecialFileTypes.get(i);
    if (type.isMyFileType(file))     return type;
  }
  FileType byFileName=getFileTypeByFileName(file.getName());
  if (byFileName != UnknownFileType.INSTANCE)   return byFileName;
  FileType detected=file.getUserData(DETECTED_FROM_CONTENT_FILE_TYPE_KEY);
  if (detected != null) {
    return detected;
  }
  return UnknownFileType.INSTANCE;
}
