{
  String fileTypeName=typeElement.getAttributeValue(ATTRIBUTE_NAME);
  String fileTypeDescr=typeElement.getAttributeValue(ATTRIBUTE_DESCRIPTION);
  String iconPath=typeElement.getAttributeValue(ATTRIBUTE_ICON);
  String extensionsStr=typeElement.getAttributeValue(ATTRIBUTE_EXTENSIONS);
  FileType type=getFileTypeByName(fileTypeName);
  if (isDefaults && !ignoreExisting) {
    extensionsStr=filterAlreadyRegisteredExtensions(extensionsStr);
  }
  List<FileNameMatcher> exts=parse(extensionsStr);
  if (type != null && !ignoreExisting) {
    if (isDefaults)     return type;
    if (extensionsStr != null) {
      removeAllAssociations(type);
      for (      FileNameMatcher ext : exts) {
        associate(type,ext,false);
      }
    }
    if (type instanceof JDOMExternalizable) {
      try {
        ((JDOMExternalizable)type).readExternal(typeElement);
      }
 catch (      InvalidDataException e) {
        throw new RuntimeException(e);
      }
    }
  }
 else {
    type=loadCustomFile(typeElement,info,fileName);
    if (type instanceof UserFileType) {
      setFileTypeAttributes(fileTypeName,fileTypeDescr,iconPath,(UserFileType)type);
    }
    registerFileTypeWithoutNotification(type,exts);
  }
  if (type instanceof UserFileType) {
    UserFileType ft=(UserFileType)type;
    setFileTypeAttributes(fileTypeName,fileTypeDescr,iconPath,ft);
  }
  if (isDefaults) {
    myDefaultTypes.add(type);
    if (type instanceof ExternalizableFileType) {
      ((ExternalizableFileType)type).markDefaultSettings();
    }
  }
 else {
    Element extensions=typeElement.getChild(AbstractFileType.ELEMENT_EXTENSIONMAP);
    if (extensions != null) {
      readMappingsForFileType(extensions,type);
    }
  }
  return type;
}
