{
  final List<VirtualFile> classRoots=getClassRoots();
  if (classRoots.isEmpty()) {
    return super.getSubPackages(psiPackage,scope);
  }
  List<PsiPackage> result=new ArrayList<PsiPackage>();
  for (  final VirtualFile classRoot : classRoots) {
    if (scope.contains(classRoot)) {
      final String pkgName=psiPackage.getName();
      final VirtualFile dir=pkgName != null ? classRoot.findFileByRelativePath(pkgName.replace('.','/')) : classRoot;
      if (dir != null && dir.isDirectory()) {
        for (        final VirtualFile file : dir.getChildren()) {
          if (file.isDirectory()) {
            result.add(createPackage(pkgName + "." + file.getName()));
          }
        }
      }
    }
  }
  return result.toArray(new PsiPackage[result.size()]);
}
