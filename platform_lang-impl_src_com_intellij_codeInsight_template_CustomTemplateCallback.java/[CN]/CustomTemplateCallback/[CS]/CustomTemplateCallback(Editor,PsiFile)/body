{
  myProject=file.getProject();
  myTemplateManager=TemplateManagerImpl.getInstance(myProject);
  int caretOffset=editor.getCaretModel().getOffset();
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  PsiElement element=InjectedLanguageUtil.findElementAtNoCommit(file,caretOffset);
  myFile=element != null ? element.getContainingFile() : file;
  myInInjectedFragment=InjectedLanguageManager.getInstance(myProject).isInjectedFragment(myFile);
  myEditor=myInInjectedFragment ? InjectedLanguageUtil.getEditorForInjectedLanguageNoCommit(editor,file) : editor;
  fixInitialState();
}
