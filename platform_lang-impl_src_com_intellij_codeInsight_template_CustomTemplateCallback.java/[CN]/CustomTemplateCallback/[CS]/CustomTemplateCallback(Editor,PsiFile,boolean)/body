{
  myProject=file.getProject();
  myTemplateManager=TemplateManager.getInstance(myProject);
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  int offset=getOffset(wrapping,editor);
  PsiElement element=InjectedLanguageUtil.findInjectedElementNoCommit(file,offset);
  myFile=element != null ? element.getContainingFile() : file;
  myInInjectedFragment=InjectedLanguageManager.getInstance(myProject).isInjectedFragment(myFile);
  myEditor=myInInjectedFragment ? InjectedLanguageUtil.getEditorForInjectedLanguageNoCommit(editor,file,offset) : editor;
  fixInitialState(wrapping);
}
