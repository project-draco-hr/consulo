{
  final boolean[] templateEnded=new boolean[]{false};
  final boolean[] templateFinished=new boolean[]{false};
  myTemplateManager.startTemplate(myEditor,template,new TemplateEditingAdapter(){
    @Override public void templateExpanded(    Template template){
      int lengthAfter=myEditor.getDocument().getCharsSequence().length();
      CodeStyleManager style=CodeStyleManager.getInstance(myProject);
      style.reformatText(myFile,myStartOffset,myStartOffset + lengthAfter - myStartLength);
    }
    @Override public void templateFinished(    Template template,    boolean brokenOff){
      if (brokenOff)       return;
      templateFinished[0]=true;
      if (templateEnded[0] && listener != null) {
        listener.finished(true,true);
      }
    }
  }
,false);
  templateEnded[0]=true;
  if (templateFinished[0] && listener != null) {
    listener.finished(false,true);
  }
  return templateFinished[0];
}
