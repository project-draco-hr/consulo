{
  final boolean[] templateEnded=new boolean[]{false};
  final boolean[] templateFinished=new boolean[]{false};
  myTemplateManager.startTemplate(myEditor,template,false,predefinedVarValues,new TemplateEditingAdapter(){
    @Override public void templateFinished(    Template template,    final boolean brokenOff){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          if (brokenOff) {
            reformat();
          }
        }
      }
);
      if (brokenOff)       return;
      templateFinished[0]=true;
      if (templateEnded[0] && listener != null) {
        listener.finished(true);
      }
    }
    @Override public void waitingForInput(    Template template){
      reformat();
    }
  }
);
  templateEnded[0]=true;
  if (templateFinished[0] && listener != null) {
    listener.finished(false);
  }
  return templateFinished[0];
}
