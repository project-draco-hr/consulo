{
  final boolean[] templateEnded=new boolean[]{false};
  final boolean[] templateFinished=new boolean[]{false};
  myTemplateManager.startTemplate(myEditor,template,false,predefinedVarValues,new TemplateEditingAdapter(){
    @Override public void templateFinished(    Template template,    boolean brokenOff){
      final int lengthAfter=myEditor.getDocument().getCharsSequence().length();
      final CodeStyleManager style=CodeStyleManager.getInstance(myProject);
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          style.reformatText(myFile,myStartOffset,myStartOffset + lengthAfter - myStartLength);
        }
      }
);
      if (brokenOff)       return;
      templateFinished[0]=true;
      if (templateEnded[0] && listener != null) {
        listener.finished(true);
      }
    }
  }
);
  templateEnded[0]=true;
  if (templateFinished[0] && listener != null) {
    listener.finished(false);
  }
  return templateFinished[0];
}
