{
  if (file instanceof PsiCompiledElement)   return null;
  ApplicationManager.getApplication().assertReadAccessAllowed();
  final Project project=file.getProject();
  Document document=editor.getDocument();
  LOG.assertTrue(!PsiDocumentManager.getInstance(project).isUncommited(document));
  final long timeStamp=document.getModificationStamp();
  Object lastTimeStamp=editor.getUserData(LAST_UPDATE_INJECTED_STAMP_KEY);
  if (lastTimeStamp instanceof Long && ((Long)lastTimeStamp).longValue() == timeStamp)   return null;
  List<DocumentWindow> injectedDocuments=InjectedLanguageUtil.getCachedInjectedDocuments(file);
  if (injectedDocuments.isEmpty())   return null;
  final List<EditorWindow> injectedEditors=new ArrayList<EditorWindow>();
  final List<PsiFile> injectedFiles=new ArrayList<PsiFile>();
  final List<Map<PsiElement,FoldingDescriptor>> maps=new ArrayList<Map<PsiElement,FoldingDescriptor>>();
  for (  DocumentWindow injectedDocument : injectedDocuments) {
    PsiFile injectedFile=PsiDocumentManager.getInstance(project).getPsiFile(injectedDocument);
    if (injectedFile == null || !injectedFile.isValid() || !injectedDocument.isValid())     continue;
    Editor injectedEditor=InjectedLanguageUtil.getInjectedEditorForInjectedFile(editor,injectedFile);
    if (!(injectedEditor instanceof EditorWindow))     continue;
    injectedEditors.add((EditorWindow)injectedEditor);
    injectedFiles.add(injectedFile);
    Map<PsiElement,FoldingDescriptor> map=new TreeMap<PsiElement,FoldingDescriptor>(COMPARE_BY_OFFSET);
    maps.add(map);
    getFoldingsFor(injectedFile,injectedDocument,map,false);
  }
  return new Runnable(){
    public void run(){
      for (int i=0; i < injectedEditors.size(); i++) {
        EditorWindow injectedEditor=injectedEditors.get(i);
        PsiFile injectedFile=injectedFiles.get(i);
        if (!injectedEditor.getDocument().isValid())         continue;
        Map<PsiElement,FoldingDescriptor> map=maps.get(i);
        UpdateFoldRegionsOperation op=new UpdateFoldRegionsOperation(project,injectedEditor,injectedFile,map,applyDefaultState,true);
        injectedEditor.getFoldingModel().runBatchFoldingOperationDoNotCollapseCaret(op);
      }
      editor.putUserData(LAST_UPDATE_INJECTED_STAMP_KEY,timeStamp);
    }
  }
;
}
