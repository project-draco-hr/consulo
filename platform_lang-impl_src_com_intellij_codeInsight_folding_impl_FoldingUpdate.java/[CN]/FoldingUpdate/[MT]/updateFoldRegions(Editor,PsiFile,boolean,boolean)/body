{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  final Project project=file.getProject();
  final Document document=editor.getDocument();
  LOG.assertTrue(!PsiDocumentManager.getInstance(project).isUncommited(document));
  CachedValue<Runnable> value=editor.getUserData(CODE_FOLDING_KEY);
  if (value != null && value.hasUpToDateValue() && !applyDefaultState)   return null;
  if (quick)   return getUpdateResult(file,document,quick,project,editor,applyDefaultState).getValue();
  return CachedValuesManager.getManager(project).getCachedValue(editor,CODE_FOLDING_KEY,new CachedValueProvider<Runnable>(){
    public Result<Runnable> compute(){
      Document document=editor.getDocument();
      PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
      return getUpdateResult(file,document,quick,project,editor,applyDefaultState);
    }
  }
,false);
}
