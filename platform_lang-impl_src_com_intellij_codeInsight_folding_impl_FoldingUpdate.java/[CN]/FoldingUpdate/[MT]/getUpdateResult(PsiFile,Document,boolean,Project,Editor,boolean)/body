{
  final FoldingMap elementsToFoldMap=new FoldingMap();
  if (!isContentSubstituted(file,project)) {
    getFoldingsFor(file instanceof PsiCompiledFile ? ((PsiCompiledFile)file).getDecompiledPsiFile() : file,document,elementsToFoldMap,quick);
  }
  final UpdateFoldRegionsOperation operation=new UpdateFoldRegionsOperation(project,editor,file,elementsToFoldMap,applyDefaultState,false);
  Runnable runnable=new Runnable(){
    public void run(){
      editor.getFoldingModel().runBatchFoldingOperationDoNotCollapseCaret(operation);
    }
  }
;
  Set<Object> dependencies=new HashSet<Object>();
  dependencies.add(document);
  for (  FoldingDescriptor descriptor : elementsToFoldMap.values()) {
    dependencies.addAll(descriptor.getDependencies());
  }
  return CachedValueProvider.Result.create(runnable,ArrayUtil.toObjectArray(dependencies));
}
