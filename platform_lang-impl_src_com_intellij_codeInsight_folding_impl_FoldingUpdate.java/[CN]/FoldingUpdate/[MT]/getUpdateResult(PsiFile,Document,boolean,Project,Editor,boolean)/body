{
  final TreeMap<PsiElement,FoldingDescriptor> elementsToFoldMap=new TreeMap<PsiElement,FoldingDescriptor>(COMPARE_BY_OFFSET);
  getFoldingsFor(file instanceof PsiCompiledElement ? (PsiFile)((PsiCompiledElement)file).getMirror() : file,document,elementsToFoldMap,quick);
  final UpdateFoldRegionsOperation operation=new UpdateFoldRegionsOperation(project,editor,elementsToFoldMap,applyDefaultState,false);
  Runnable runnable=new Runnable(){
    public void run(){
      editor.getFoldingModel().runBatchFoldingOperationDoNotCollapseCaret(operation);
    }
  }
;
  Set<Object> dependencies=new HashSet<Object>();
  dependencies.add(document);
  for (  FoldingDescriptor descriptor : elementsToFoldMap.values()) {
    dependencies.addAll(descriptor.getDependencies());
  }
  return CachedValueProvider.Result.create(runnable,ArrayUtil.toObjectArray(dependencies));
}
