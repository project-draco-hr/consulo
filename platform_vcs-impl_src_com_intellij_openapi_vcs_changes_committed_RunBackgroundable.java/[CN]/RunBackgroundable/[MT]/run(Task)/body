{
  final ProgressManager pm=ProgressManager.getInstance();
  if (ApplicationManager.getApplication().isDispatchThread()) {
    pm.run(task);
  }
 else {
    try {
      task.run(pm.getProgressIndicator());
    }
 catch (    ProcessCanceledException e) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          task.onCancel();
        }
      }
);
      return;
    }
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        task.onSuccess();
      }
    }
);
  }
}
