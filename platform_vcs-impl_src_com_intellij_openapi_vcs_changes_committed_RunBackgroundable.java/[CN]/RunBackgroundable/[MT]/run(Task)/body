{
  final ProgressManager pm=ProgressManager.getInstance();
  if (ApplicationManager.getApplication().isDispatchThread()) {
    pm.run(task);
  }
 else {
    boolean canceled=true;
    try {
      task.run(pm.getProgressIndicator());
      canceled=pm.getProgressIndicator() != null && pm.getProgressIndicator().isCanceled();
    }
 catch (    ProcessCanceledException e) {
    }
    final boolean finalCanceled=canceled;
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        if (finalCanceled) {
          task.onCancel();
        }
 else {
          task.onSuccess();
        }
      }
    }
);
  }
}
