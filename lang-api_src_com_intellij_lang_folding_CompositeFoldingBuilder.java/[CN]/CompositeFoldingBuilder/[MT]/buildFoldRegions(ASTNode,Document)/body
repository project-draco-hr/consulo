{
  final PsiElement psi=node.getPsi();
  if (psi == null)   return FoldingDescriptor.EMPTY;
  final PsiFile file=PsiDocumentManager.getInstance(psi.getProject()).getPsiFile(document);
  final VirtualFile vf;
  if (file == null || (vf=file.getVirtualFile()) == null)   return FoldingDescriptor.EMPTY;
  final List<FoldingDescriptor> descriptors=new ArrayList<FoldingDescriptor>();
  Map<ASTNode,FoldingBuilder> builders;
  builders=foldings.get(vf);
  if (builders == null) {
    builders=new HashMap<ASTNode,FoldingBuilder>();
    foldings.put(vf,builders);
  }
  for (  FoldingBuilder builder : myBuilders) {
    final FoldingDescriptor[] foldingDescriptors=builder.buildFoldRegions(node,document);
    if (foldingDescriptors.length > 0) {
      descriptors.addAll(Arrays.asList(foldingDescriptors));
      for (      FoldingDescriptor descriptor : foldingDescriptors) {
        builders.put(descriptor.getElement(),builder);
      }
    }
  }
  final FileEditorManager editorManager=FileEditorManager.getInstance(psi.getProject());
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (      VirtualFile virtualFile : new HashSet<VirtualFile>(foldings.keySet())) {
        if (!editorManager.isFileOpen(virtualFile)) {
          foldings.remove(virtualFile);
        }
      }
    }
  }
);
  return descriptors.toArray(new FoldingDescriptor[descriptors.size()]);
}
