{
  final PsiElement psi=node.getPsi();
  if (psi == null)   return FoldingDescriptor.EMPTY;
  checkSubscription(psi.getProject());
  final PsiFile file=PsiDocumentManager.getInstance(psi.getProject()).getPsiFile(document);
  final VirtualFile vf;
  if (file == null || (vf=file.getVirtualFile()) == null)   return FoldingDescriptor.EMPTY;
  final List<FoldingDescriptor> descriptors=new ArrayList<FoldingDescriptor>();
  final Map<ASTNode,FoldingBuilder> builders=new HashMap<ASTNode,FoldingBuilder>();
  foldings.put(vf,builders);
  for (  FoldingBuilder builder : myBuilders) {
    final FoldingDescriptor[] foldingDescriptors=builder.buildFoldRegions(node,document);
    if (foldingDescriptors.length > 0) {
      descriptors.addAll(Arrays.asList(foldingDescriptors));
      for (      FoldingDescriptor descriptor : foldingDescriptors) {
        builders.put(descriptor.getElement(),builder);
      }
    }
  }
  return descriptors.toArray(new FoldingDescriptor[descriptors.size()]);
}
