def _updatebranchcache(self, partial, ctxgen):
    newbranches = {}
    for c in ctxgen:
        newbranches.setdefault(c.branch(), []).append(c.node())
    for (branch, newnodes) in newbranches.iteritems():
        bheads = partial.setdefault(branch, [])
        bheads.extend(newnodes)
        if (len(bheads) < 2):
            continue
        newbheads = []
        while newnodes:
            latest = newnodes.pop()
            if (latest not in bheads):
                continue
            minbhrev = self[min([self[bh].rev() for bh in bheads])].node()
            reachable = self.changelog.reachable(latest, minbhrev)
            bheads = [b for b in bheads if (b not in reachable)]
            newbheads.insert(0, latest)
        bheads.extend(newbheads)
        partial[branch] = bheads
