def _lock(self, lockname, wait, releasefn, acquirefn, desc):
    try:
        l = lock.lock(lockname, 0, releasefn, desc=desc)
    except error.LockHeld as inst:
        if (not wait):
            raise
        self.ui.warn((_('waiting for lock on %s held by %r\n') % (desc, inst.locker)))
        l = lock.lock(lockname, int(self.ui.config('ui', 'timeout', '600')), releasefn, desc=desc)
    if acquirefn:
        acquirefn()
    return l
