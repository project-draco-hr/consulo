def branchmap(self):
    'returns a dictionary {branch: [branchheads]}'
    tip = self.changelog.tip()
    if ((self._branchcache is not None) and (self._branchcachetip == tip)):
        return self._branchcache
    oldtip = self._branchcachetip
    self._branchcachetip = tip
    if ((oldtip is None) or (oldtip not in self.changelog.nodemap)):
        (partial, last, lrev) = self._readbranchcache()
    else:
        lrev = self.changelog.rev(oldtip)
        partial = self._branchcache
    self._branchtags(partial, lrev)
    self._branchcache = partial
    return self._branchcache
