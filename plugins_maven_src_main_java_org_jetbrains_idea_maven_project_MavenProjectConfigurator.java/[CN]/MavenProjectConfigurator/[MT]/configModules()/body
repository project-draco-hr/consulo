{
  List<MavenProjectModel> projects=getMavenProjectsToConfigure();
  Set<MavenProjectModel> projectsWithNewlyCreatedModules=new HashSet<MavenProjectModel>();
  for (  MavenProjectModel each : projects) {
    if (ensureModuleCreated(each)) {
      projectsWithNewlyCreatedModules.add(each);
    }
  }
  LinkedHashMap<Module,ModifiableRootModel> rootModels=new LinkedHashMap<Module,ModifiableRootModel>();
  for (  MavenProjectModel each : projects) {
    Module module=myMavenProjectToModule.get(each);
    MavenModuleConfigurator c=createModuleConfigurator(module,each);
    rootModels.put(module,c.config(projectsWithNewlyCreatedModules.contains(each)));
  }
  for (  MavenProjectModel each : projects) {
    Module module=myMavenProjectToModule.get(each);
    createModuleConfigurator(module,each).preConfigFacets();
  }
  for (  MavenProjectModel each : projects) {
    Module module=myMavenProjectToModule.get(each);
    createModuleConfigurator(module,each).configFacets(rootModels.get(module));
  }
  myRootModelsToCommit.addAll(rootModels.values());
  ArrayList<Module> modules=new ArrayList<Module>(myMavenProjectToModule.values());
  MavenProjectsManager.getInstance(myProject).setMavenizedModules(modules);
}
