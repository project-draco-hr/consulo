{
  DebuggerManagerThreadImpl.assertIsManagerThread();
  if (myState.compareAndSet(STATE_INITIAL,STATE_DETACHING) || myState.compareAndSet(STATE_ATTACHED,STATE_DETACHING)) {
    try {
      getManagerThread().close();
    }
  finally {
      myVirtualMachineProxy=null;
      myPositionManager=null;
      myReturnValueWatcher=null;
      myNodeRederersMap.clear();
      myRenderers.clear();
      myState.set(STATE_DETACHED);
      try {
        myDebugProcessDispatcher.getMulticaster().processDetached(this,closedByUser);
      }
  finally {
        setBreakpointsMuted(false);
        myWaitFor.up();
      }
    }
  }
}
