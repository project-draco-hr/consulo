{
  final PsiDirectory[] directories=new PsiDirectory[elements.length];
  final String prompt=getPromptToMoveDirectoryLibrariesSafe(elements);
  if (prompt != null) {
    System.arraycopy(elements,0,directories,0,directories.length);
    moveDirectoriesLibrariesSafe(project,targetContainer,callback,directories,prompt);
    return;
  }
  if (canMoveOrRearrangePackages(elements)) {
    System.arraycopy(elements,0,directories,0,directories.length);
    SelectMoveOrRearrangePackageDialog dialog=new SelectMoveOrRearrangePackageDialog(project,directories,targetContainer == null);
    dialog.show();
    if (!dialog.isOK())     return;
    if (dialog.isPackageRearrageSelected()) {
      MoveClassesOrPackagesImpl.doRearrangePackage(project,directories);
      return;
    }
    if (dialog.isMoveDirectory()) {
      moveAsDirectory(project,targetContainer,callback,directories);
      return;
    }
  }
  final PsiElement[] adjustedElements=MoveClassesOrPackagesImpl.adjustForMove(project,elements,targetContainer);
  if (adjustedElements == null)   return;
  if (targetContainer instanceof PsiDirectory) {
    if (CommonRefactoringUtil.checkReadOnlyStatusRecursively(project,Arrays.asList(adjustedElements),true)) {
      if (!packageHasMultipleDirectoriesInModule(project,(PsiDirectory)targetContainer)) {
        new MoveClassesOrPackagesToNewDirectoryDialog((PsiDirectory)targetContainer,adjustedElements,callback).show();
        return;
      }
    }
  }
  MoveClassesOrPackagesImpl.doMove(project,adjustedElements,targetContainer,callback);
}
