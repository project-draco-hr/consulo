{
  final InspectionTool tool=toolNode.getTool();
  final boolean runWithEditorProfile=tool.getContext().RUN_WITH_EDITOR_PROFILE;
  final Map<RefEntity,CommonProblemDescriptor[]> problems=tool instanceof DescriptorProviderInspection ? ((DescriptorProviderInspection)tool).getProblemElements() : null;
  Function<RefElement,UserObjectContainer<RefElement>> computeContainer=new Function<RefElement,UserObjectContainer<RefElement>>(){
    public UserObjectContainer<RefElement> fun(    final RefElement refElement){
      return new RefElementContainer(refElement,problems != null ? problems.get(refElement) : null);
    }
  }
;
  List<InspectionTreeNode> list=buildTree(tool.getPackageContent(),false,tool,computeContainer,showStructure);
  for (  InspectionTreeNode node : list) {
    merge(node,toolNode,runWithEditorProfile);
  }
  if (tool.isOldProblemsIncluded()) {
    final Map<RefEntity,CommonProblemDescriptor[]> oldProblems=tool instanceof DescriptorProviderInspection ? ((DescriptorProviderInspection)tool).getOldProblemElements() : null;
    computeContainer=new Function<RefElement,UserObjectContainer<RefElement>>(){
      public UserObjectContainer<RefElement> fun(      final RefElement refElement){
        return new RefElementContainer(refElement,oldProblems != null ? oldProblems.get(refElement) : null);
      }
    }
;
    list=buildTree(tool.getOldPackageContent(),true,tool,computeContainer,showStructure);
    for (    InspectionTreeNode node : list) {
      merge(node,toolNode,true);
    }
  }
  merge(toolNode,parentNode,runWithEditorProfile);
}
