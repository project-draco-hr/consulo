{
  Document document=myEditor.getDocument();
  TIntHashSet softWrapsToRemoveIndices=new TIntHashSet();
  List<TextChangeImpl> softWraps=myStorage.getSoftWraps();
  for (  DeferredChange change : myDeferredChanges) {
    if (change.startLine >= document.getLineCount()) {
      continue;
    }
    int index=myStorage.getSoftWrapIndex(document.getLineStartOffset(change.startLine));
    if (index < 0) {
      index=-index - 1;
    }
    for (int i=index; i < softWraps.size(); i++) {
      TextChangeImpl softWrap=softWraps.get(i);
      if (softWrap.getStart() >= document.getTextLength()) {
        continue;
      }
      int softWrapLine=document.getLineNumber(softWrap.getStart());
      if (myDirtyLines.contains(softWrapLine)) {
        softWrapsToRemoveIndices.add(i);
        continue;
      }
      softWrap.advance(change.symbolsDifference);
    }
  }
  softWrapsToRemoveIndices.forEach(new TIntProcedure(){
    @Override public boolean execute(    int value){
      myStorage.removeByIndex(value);
      return true;
    }
  }
);
  myDirtyLines.clear();
  myDeferredChanges.clear();
}
