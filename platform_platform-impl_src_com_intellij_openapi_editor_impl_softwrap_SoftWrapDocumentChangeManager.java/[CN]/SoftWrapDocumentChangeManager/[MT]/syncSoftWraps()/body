{
  Document document=myEditor.getDocument();
  TIntHashSet softWrapsToRemoveIndices=new TIntHashSet();
  List<TextChangeImpl> softWraps=myStorage.getSoftWraps();
  for (  DeferredChange change : myDeferredChanges) {
    if (change.startOffset >= document.getTextLength()) {
      continue;
    }
    int index=myStorage.getSoftWrapIndex(change.startOffset);
    if (index < 0) {
      index=-index - 1;
    }
    for (int i=index; i < softWraps.size(); i++) {
      TextChangeImpl softWrap=softWraps.get(i);
      if (softWrapsToRemoveIndices.contains(i)) {
        continue;
      }
      if (softWrap.getStart() < change.endOffset || softWrap.getStart() >= document.getTextLength()) {
        softWrapsToRemoveIndices.add(i);
        continue;
      }
      softWrap.advance(change.symbolsDifference);
    }
  }
  softWrapsToRemoveIndices.forEach(new TIntProcedure(){
    @Override public boolean execute(    int value){
      myStorage.removeByIndex(value);
      return true;
    }
  }
);
  myDeferredChanges.clear();
}
