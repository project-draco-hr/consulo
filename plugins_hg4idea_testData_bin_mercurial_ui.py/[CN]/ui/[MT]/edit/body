def edit(self, text, user):
    (fd, name) = tempfile.mkstemp(prefix='hg-editor-', suffix='.txt', text=True)
    try:
        f = os.fdopen(fd, 'w')
        f.write(text)
        f.close()
        editor = self.geteditor()
        util.system(('%s "%s"' % (editor, name)), environ={'HGUSER': user, }, onerr=util.Abort, errprefix=_('edit failed'))
        f = open(name)
        t = f.read()
        f.close()
    finally:
        os.unlink(name)
    return t
