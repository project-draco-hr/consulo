{
  if (instruction instanceof ReadWriteVariableInstruction && ((ReadWriteVariableInstruction)instruction).isWrite()) {
    final PsiElement element=instruction.getElement();
    final GrExpression initializer=getInitializer(element);
    if (initializer != null) {
      final TypeInferenceHelper helper=GroovyPsiManager.getInstance(initializer.getProject()).getTypeInferenceHelper();
      final PsiType type;
      try {
        helper.setCurrentEnvironment(map);
        type=initializer.getType();
      }
  finally {
        helper.setCurrentEnvironment(null);
      }
      if (type != null) {
        map.put(((ReadWriteVariableInstruction)instruction).getVariableName(),type);
      }
    }
  }
}
