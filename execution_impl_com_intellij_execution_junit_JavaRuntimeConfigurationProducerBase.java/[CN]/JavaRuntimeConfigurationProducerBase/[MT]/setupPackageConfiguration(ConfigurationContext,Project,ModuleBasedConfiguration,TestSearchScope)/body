{
  final RunnerAndConfigurationSettingsImpl template=((RunManagerImpl)context.getRunManager()).getConfigurationTemplate(getConfigurationFactory());
  if (scope != TestSearchScope.WHOLE_PROJECT) {
    final Module contextModule=context.getModule();
    final Module predefinedModule=((ModuleBasedConfiguration)template.getConfiguration()).getConfigurationModule().getModule();
    if (predefinedModule != null) {
      configuration.setModule(predefinedModule);
    }
 else     if (contextModule != null) {
      configuration.setModule(contextModule);
    }
 else {
      return TestSearchScope.WHOLE_PROJECT;
    }
  }
  copyStepsBeforeRun(project,configuration);
  return scope;
}
