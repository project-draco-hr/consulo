{
  final Project project=myPsiManager.getProject();
  final PsiFile containingFile=listOwner.getContainingFile();
  if (!(containingFile instanceof PsiJavaFile)) {
    notifyAfterAnnotationChanging(listOwner,annotationFQName,false);
    return;
  }
  final String packageName=((PsiJavaFile)containingFile).getPackageName();
  final VirtualFile containingVirtualFile=containingFile.getVirtualFile();
  LOG.assertTrue(containingVirtualFile != null);
  final List<OrderEntry> entries=ProjectRootManager.getInstance(project).getFileIndex().getOrderEntriesForFile(containingVirtualFile);
  if (entries.isEmpty()) {
    notifyAfterAnnotationChanging(listOwner,annotationFQName,false);
    return;
  }
  for (  final OrderEntry entry : entries) {
    if (entry instanceof ModuleOrderEntry)     continue;
    VirtualFile[] roots=AnnotationOrderRootType.getFiles(entry);
    roots=filterByReadOnliness(roots);
    if (roots.length > 0) {
      chooseRootAndAnnotateExternally(listOwner,annotationFQName,fromFile,project,packageName,roots,value);
    }
 else {
      Application application=ApplicationManager.getApplication();
      if (application.isUnitTestMode() || application.isHeadlessEnvironment()) {
        notifyAfterAnnotationChanging(listOwner,annotationFQName,false);
        return;
      }
      application.invokeLater(new Runnable(){
        @Override public void run(){
          setupRootAndAnnotateExternally(entry,project,listOwner,annotationFQName,fromFile,packageName,value);
        }
      }
,project.getDisposed());
    }
    break;
  }
}
