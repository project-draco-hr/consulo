{
  PsiFile file=context.file;
  int offset=context.getStartOffset();
  PsiElement lastElement=InjectedLanguageUtil.findElementAtNoCommit(file,offset - 1);
  if (lastElement == null)   return;
  if (!doCompleteIfNeeded(offset1,offset2,context,dummyIdentifier,editor,invocationCount,file,lastElement)) {
    FileViewProvider fileViewProvider=file.getViewProvider();
    Language templateDataLanguage;
    final PsiElement parent=lastElement.getParent();
    if (parent == null) {
      throw new AssertionError("Null parent for " + lastElement + " of class "+ lastElement.getClass());
    }
    if (fileViewProvider instanceof TemplateLanguageFileViewProvider && (templateDataLanguage=((TemplateLanguageFileViewProvider)fileViewProvider).getTemplateDataLanguage()) != parent.getLanguage()) {
      lastElement=fileViewProvider.findElementAt(offset - 1,templateDataLanguage);
      if (lastElement == null)       return;
      doCompleteIfNeeded(offset1,offset2,context,dummyIdentifier,editor,invocationCount,file,lastElement);
    }
  }
}
