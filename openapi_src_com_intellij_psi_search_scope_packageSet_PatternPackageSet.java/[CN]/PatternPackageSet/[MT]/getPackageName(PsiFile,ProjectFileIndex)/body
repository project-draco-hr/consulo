{
  VirtualFile vFile=file.getVirtualFile();
  if (fileIndex.isInLibrarySource(vFile)) {
    return fileIndex.getPackageNameByDirectory(vFile.getParent()) + "." + file.getVirtualFile().getNameWithoutExtension();
  }
  if (file instanceof PsiJavaFile)   return ((PsiJavaFile)file).getPackageName() + "." + file.getVirtualFile().getNameWithoutExtension();
  PsiDirectory dir=file.getContainingDirectory();
  PsiPackage aPackage=JavaDirectoryService.getInstance().getPackage(dir);
  return aPackage == null ? file.getName() : aPackage.getQualifiedName() + "." + file.getVirtualFile().getNameWithoutExtension();
}
