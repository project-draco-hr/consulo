{
  final Module module=index.getModuleForFile(virtualFile);
  if (module != null) {
    final VirtualFile projectParent=module.getProject().getProjectFile().getParent();
    if (projectParent != null) {
      if (VfsUtil.isAncestor(projectParent,virtualFile,false)) {
        final String projectRelativePath=VfsUtil.getRelativePath(virtualFile,projectParent,'/');
        return useFQName ? projectRelativePath : projectRelativePath.substring(projectRelativePath.indexOf('/') + 1);
      }
    }
    return virtualFile.getPath();
  }
 else {
    return VfsUtil.getRelativePath(virtualFile,index.getContentRootForFile(virtualFile),'/');
  }
}
