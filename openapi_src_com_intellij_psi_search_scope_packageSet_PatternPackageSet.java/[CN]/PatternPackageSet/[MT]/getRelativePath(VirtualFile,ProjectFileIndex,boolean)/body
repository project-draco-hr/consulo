{
  final Module module=index.getModuleForFile(virtualFile);
  if (module != null) {
    final VirtualFile projectParent=module.getProject().getBaseDir();
    if (projectParent != null) {
      if (VfsUtil.isAncestor(projectParent,virtualFile,false)) {
        final String projectRelativePath=VfsUtil.getRelativePath(virtualFile,projectParent,'/');
        return useFQName ? projectRelativePath : projectRelativePath.substring(projectRelativePath.indexOf('/') + 1);
      }
    }
    return virtualFile.getPath();
  }
 else {
    final VirtualFile contentRootForFile=index.getContentRootForFile(virtualFile);
    if (contentRootForFile != null) {
      return VfsUtil.getRelativePath(virtualFile,contentRootForFile,'/');
    }
    return getLibRelativePath(virtualFile,index);
  }
}
