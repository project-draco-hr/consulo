{
  int numOfThreads=10;
  final int readIterations=50000;
  final int writeIterations=30;
synchronized (this) {
    PsiClass myClass=myJavaFacade.findClass("StressClass",GlobalSearchScope.allScope(myProject));
    assertNotNull(myClass);
    myFile=(PsiJavaFile)myClass.getContainingFile();
  }
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(getProject());
  final CountDownLatch reads=new CountDownLatch(numOfThreads);
  final Random random=new Random();
  for (int i=0; i < numOfThreads; i++) {
    new Thread(new Runnable(){
      public void run(){
        for (int i=0; i < readIterations; i++) {
          if (myPsiManager == null)           return;
          ApplicationManager.getApplication().runReadAction(new Runnable(){
            public void run(){
              try {
                readStep(random);
              }
 catch (              StorageException e) {
                LOG.error(e);
              }
            }
          }
);
        }
        reads.countDown();
      }
    }
,"stress thread" + i).start();
  }
  final Document document=documentManager.getDocument(myFile);
  for (int i=0; i < writeIterations; i++) {
    Thread.sleep(100);
    new WriteCommandAction(myProject,myFile){
      protected void run(      final Result result) throws Throwable {
        documentManager.commitAllDocuments();
        writeStep(random);
        documentManager.commitAllDocuments();
        assertEquals(document.getText(),myFile.getText());
      }
    }
.execute();
  }
  reads.await();
}
