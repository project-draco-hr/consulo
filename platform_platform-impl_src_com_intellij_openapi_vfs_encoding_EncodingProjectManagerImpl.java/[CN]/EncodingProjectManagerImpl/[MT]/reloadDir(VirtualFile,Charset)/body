{
  if (file == null) {
    for (    VirtualFile virtualFile : ProjectRootManager.getInstance(myProject).getContentRoots()) {
      reloadDir(virtualFile,newCharset);
    }
    return;
  }
  VfsUtilCore.visitChildrenRecursively(file,new VirtualFileVisitor(){
    @Override public boolean visitFile(    @NotNull final VirtualFile file){
      if (!(file instanceof VirtualFileSystemEntry))       return false;
      if (!file.isCharsetSet())       return true;
      Charset oldCharset=file.getCharset();
      if (!Comparing.equal(newCharset,oldCharset)) {
        ProgressManager.progress("Reloading files...",file.getPresentableUrl());
        UIUtil.invokeLaterIfNeeded(new Runnable(){
          @Override public void run(){
            setAndSaveOrReload(file,newCharset);
          }
        }
);
      }
      return true;
    }
  }
);
}
