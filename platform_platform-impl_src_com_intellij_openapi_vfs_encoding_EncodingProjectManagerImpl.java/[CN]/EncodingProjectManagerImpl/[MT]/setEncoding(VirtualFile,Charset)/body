{
  Charset oldCharset;
  if (virtualFileOrDir == null) {
    oldCharset=myProjectCharset;
    myProjectCharset=charset;
  }
 else {
    if (charset == null) {
      oldCharset=myMapping.remove(virtualFileOrDir);
    }
 else {
      oldCharset=myMapping.put(virtualFileOrDir,charset);
    }
  }
  if (!Comparing.equal(oldCharset,charset)) {
    myModificationTracker.incModificationCount();
    if (virtualFileOrDir != null) {
      virtualFileOrDir.setCharset(virtualFileOrDir.getBOM() == null ? charset : null);
    }
    reloadAllFilesUnder(virtualFileOrDir);
  }
}
