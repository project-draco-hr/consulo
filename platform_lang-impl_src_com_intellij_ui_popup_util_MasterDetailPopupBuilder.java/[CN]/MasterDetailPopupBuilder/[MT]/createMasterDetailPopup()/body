{
  setupRenderer();
  myPathLabel=new JLabel(" ");
  myPathLabel.setHorizontalAlignment(SwingConstants.RIGHT);
  final Font font=myPathLabel.getFont();
  myPathLabel.setFont(font.deriveFont((float)10));
  myUpdateAlarm=new Alarm(Alarm.ThreadToUse.SWING_THREAD);
  if (myDetailView == null) {
    myDetailView=new DetailViewImpl(myProject);
  }
  JPanel footerPanel=new JPanel(new BorderLayout()){
    @Override protected void paintComponent(    Graphics g){
      super.paintComponent(g);
      g.setColor(BORDER_COLOR);
      g.drawLine(0,0,getWidth(),0);
    }
  }
;
  Runnable runnable=new Runnable(){
    public void run(){
      IdeFocusManager.getInstance(myProject).doWhenFocusSettlesDown(new Runnable(){
        public void run(){
          Object[] values=getSelectedItems();
          if (values.length == 1) {
            myDelegate.itemChosen((ItemWrapper)values[0],myProject,myPopup,false);
          }
 else {
            for (            Object value : values) {
              if (value instanceof ItemWrapper) {
                myDelegate.itemChosen((ItemWrapper)value,myProject,myPopup,false);
              }
            }
          }
        }
      }
);
    }
  }
;
  footerPanel.setBorder(BorderFactory.createEmptyBorder(4,4,4,4));
  footerPanel.add(myPathLabel);
  JComponent toolBar=null;
  if (myActions != null) {
    myActionToolbar=ActionManager.getInstance().createActionToolbar("",myActions,true);
    myActionToolbar.setReservePlaceAutoPopupIcon(false);
    myActionToolbar.setMinimumButtonSize(new Dimension(20,20));
    toolBar=myActionToolbar.getComponent();
    toolBar.setOpaque(false);
  }
  final PopupChooserBuilder builder=createInnerBuilder().setMovable(true).setResizable(true).setAutoselectOnMouseMove(false).setSettingButton(toolBar).setSouthComponent(footerPanel).setCancelOnWindowDeactivation(myCancelOnWindowDeactivation).setCancelOnClickOutside(myCancelOnClickOutside);
  if (myAddDetailViewToEast) {
    builder.setEastComponent((JComponent)myDetailView);
  }
  if (myDoneRunnable != null) {
    final JButton done=new JButton("Done");
    done.setMnemonic('o');
    done.addActionListener(new ActionListener(){
      @Override public void actionPerformed(      ActionEvent event){
        myDoneRunnable.run();
      }
    }
);
    builder.setCommandButton(new ActiveComponent(){
      @Override public void setActive(      boolean active){
      }
      @Override public JComponent getComponent(){
        return done;
      }
    }
);
  }
  String title=myDelegate.getTitle();
  if (title != null) {
    builder.setTitle(title);
  }
  builder.setItemChoosenCallback(runnable).setCloseOnEnter(myCloseOnEnter).setMayBeParent(true).setDimensionServiceKey(myDimensionServiceKey).setFilteringEnabled(new Function<Object,String>(){
    public String fun(    Object o){
      return ((ItemWrapper)o).speedSearchText();
    }
  }
);
  if (myMinSize != null) {
    builder.setMinSize(myMinSize);
  }
  myPopup=builder.createPopup();
  builder.getScrollPane().setBorder(IdeBorderFactory.createBorder(SideBorder.RIGHT));
  myPopup.addListener(new JBPopupListener(){
    @Override public void beforeShown(    LightweightWindowEvent event){
    }
    @Override public void onClosed(    LightweightWindowEvent event){
      myDetailView.clearEditor();
    }
  }
);
  if (myDoneRunnable != null) {
    new AnAction("Done"){
      @Override public void actionPerformed(      AnActionEvent e){
        myDoneRunnable.run();
      }
    }
.registerCustomShortcutSet(KeyEvent.VK_ENTER,InputEvent.CTRL_DOWN_MASK,myPopup.getContent());
  }
  return myPopup;
}
