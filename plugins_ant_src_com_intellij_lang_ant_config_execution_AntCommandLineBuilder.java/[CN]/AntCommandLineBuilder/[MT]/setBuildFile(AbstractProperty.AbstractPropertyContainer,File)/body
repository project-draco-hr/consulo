{
  String jdkName=AntBuildFileImpl.CUSTOM_JDK_NAME.get(container);
  ProjectJdk jdk;
  if (jdkName != null && jdkName.length() > 0) {
    jdk=GlobalAntConfiguration.findJdk(jdkName);
  }
 else {
    jdkName=AntConfigurationImpl.DEFAULT_JDK_NAME.get(container);
    if (jdkName == null || jdkName.length() == 0) {
      throw new CantRunException(AntBundle.message("project.jdk.not.specified.error.message"));
    }
    jdk=GlobalAntConfiguration.findJdk(jdkName);
  }
  if (jdk == null) {
    throw new CantRunException(AntBundle.message("jdk.with.name.not.configured.error.message",jdkName));
  }
  VirtualFile homeDirectory=jdk.getHomeDirectory();
  if (homeDirectory == null) {
    throw new CantRunException(AntBundle.message("jdk.with.name.bad.configured.error.message",jdkName));
  }
  myCommandLine.setJdk(jdk);
  ParametersList vmParametersList=myCommandLine.getVMParametersList();
  vmParametersList.add("-Xmx" + AntBuildFileImpl.MAX_HEAP_SIZE.get(container) + "m");
  final AntInstallation antInstallation=AntBuildFileImpl.ANT_INSTALLATION.get(container);
  if (antInstallation == null) {
    throw new CantRunException(AntBundle.message("ant.installation.not.configured.error.message"));
  }
  final String antHome=AntInstallation.HOME_DIR.get(antInstallation.getProperties());
  vmParametersList.add("-Dant.home=" + antHome);
  String[] urls=jdk.getRootProvider().getUrls(OrderRootType.CLASSES);
  final String jdkHome=homeDirectory.getPath().replace('/',File.separatorChar);
  @NonNls final String pathToJre=jdkHome + File.separator + "jre"+ File.separator;
  for (  String url : urls) {
    final String path=PathUtil.toPresentableUrl(url);
    if (!path.startsWith(pathToJre)) {
      myCommandLine.getClassPath().add(path);
    }
  }
  myCommandLine.getClassPath().addAllFiles(AntBuildFileImpl.ALL_CLASS_PATH.get(container));
  myCommandLine.getClassPath().addAllFiles(AntBuildFileImpl.getUserHomeLibraries());
  final String toolsJar=jdk.getToolsPath();
  if (toolsJar != null) {
    myCommandLine.getClassPath().add(toolsJar);
  }
  PathUtilEx.addRtJar(myCommandLine.getClassPath());
  myCommandLine.setMainClass(AntMain2.class.getName());
  ParametersList programParameters=myCommandLine.getProgramParametersList();
  programParameters.add("-logger",IdeaAntLogger2.class.getName());
  programParameters.addParametersString(AntBuildFileImpl.ANT_COMMAND_LINE_PARAMETERS.get(container));
  if (!programParameters.getList().contains(INPUT_HANDLER_PARAMETER)) {
    programParameters.add(INPUT_HANDLER_PARAMETER,IdeaInputHandler.class.getName());
  }
  myProperties=AntBuildFileImpl.ANT_PROPERTIES.get(container);
  myBuildFilePath=buildFile.getAbsolutePath();
  myCommandLine.setWorkingDirectory(buildFile.getParent());
}
