{
  List<Module> modules=new ArrayList<Module>();
  File modulesFile=new File(ideaDir,"modules.xml");
  final Document document=JDOMUtil.loadDocument(modulesFile);
  PathMacroManager.getInstance(project).expandPaths(document.getRootElement());
  XPath xpathExpression=XPath.newInstance("/project[@version='4']/component[@name='ProjectModuleManager']/modules/*");
  final List list=xpathExpression.selectNodes(document);
  for (  Object o : list) {
    Element element=(Element)o;
    String filepath=element.getAttributeValue("filepath");
    if (filepath == null) {
      continue;
    }
    filepath=StringUtil.replace(filepath,"$PROJECT_DIR$",projectPath);
    modules.add(loadModule(projectPath,filepath,modifiableModuleModel,modulesProvider,project));
  }
  return modules;
}
