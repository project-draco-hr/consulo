{
  if (element instanceof PsiDirectory && !myProject.isDisposed()) {
    final PsiDirectory dir=(PsiDirectory)element;
    final ProjectTreeStructure treeStructure=(ProjectTreeStructure)myTreeStructure;
    PsiDirectory dirToUpdateFrom=dir;
    if (!treeStructure.isFlattenPackages() && treeStructure.isHideEmptyMiddlePackages()) {
      while (dirToUpdateFrom != null && BaseProjectViewDirectoryHelper.isEmptyMiddleDirectory(dirToUpdateFrom,true)) {
        dirToUpdateFrom=dirToUpdateFrom.getParentDirectory();
      }
    }
    boolean addedOk;
    while (!(addedOk=super.addSubtreeToUpdateByElement(dirToUpdateFrom == null ? myTreeStructure.getRootElement() : dirToUpdateFrom))) {
      if (dirToUpdateFrom == null) {
        break;
      }
      dirToUpdateFrom=dirToUpdateFrom.getParentDirectory();
    }
    return addedOk;
  }
  return super.addSubtreeToUpdateByElement(element);
}
