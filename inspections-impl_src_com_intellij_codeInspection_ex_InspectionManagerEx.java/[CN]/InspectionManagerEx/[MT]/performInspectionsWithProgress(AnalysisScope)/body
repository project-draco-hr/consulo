{
  try {
    myProgressIndicator=ProgressManager.getInstance().getProgressIndicator();
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        try {
          PsiManager.getInstance(myProject).startBatchFilesProcessingMode();
          getRefManager().inspectionReadActionStarted();
          EntryPointsManager.getInstance(getProject()).resolveEntryPoints(getRefManager());
          InspectionTool[] tools=getCurrentProfile().getInspectionTools();
          ArrayList<LocalInspectionToolWrapper> localTools=initJobDescriptors(tools,scope);
          List<InspectionTool> needRepeatSearchRequest=new ArrayList<InspectionTool>();
          runTools(tools,localTools,needRepeatSearchRequest,scope);
          performPostRunFindUsages(needRepeatSearchRequest);
        }
 catch (        ProcessCanceledException e) {
          cleanup();
          throw e;
        }
 finally {
          PsiManager.getInstance(myProject).finishBatchFilesProcessingMode();
        }
      }
    }
);
  }
  finally {
    if (myRefManager != null) {
      getRefManager().inspectionReadActionFinished();
    }
  }
}
