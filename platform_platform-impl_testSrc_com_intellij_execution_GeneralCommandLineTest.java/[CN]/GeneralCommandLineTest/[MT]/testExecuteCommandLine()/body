{
  final File tempFile;
  if (SystemInfo.isWindows) {
    final URL url=getClass().getClassLoader().getResource("com/intellij/execution/printArgs.exe");
    assertNotNull(url);
    tempFile=FileUtil.createTempFile("path with spaces 'and quotes' ",".exe");
    FileUtil.copy(new File(url.getFile()),tempFile);
  }
 else {
    tempFile=ExecUtil.createTempExecutableScript("path with spaces \"and quotes\" ",".sh","#!/bin/sh\n\n" + "echo \"=====\"\n" + "for f in \"$@\" ; do echo \"$f\"; done\n"+ "echo \"=====\"\n");
  }
  final String[] parameters={"with space","\"quoted\"","\"quoted with spaces\"","","  ","param 1","\"","param2","trailing slash\\"};
  try {
    final GeneralCommandLine commandLine=new GeneralCommandLine();
    commandLine.setExePath(tempFile.getCanonicalPath());
    commandLine.addParameters(parameters);
    commandLine.setRedirectErrorStream(true);
    final Process process=commandLine.createProcess();
    final String output=FileUtil.loadTextAndClose(process.getInputStream());
    final int result=process.waitFor();
    assertEquals("Command:\n" + commandLine.getCommandLineString() + "\nOutput:\n"+ output,0,result);
    assertEquals("=====\n" + StringUtil.join(parameters,"\n") + "\n=====\n",StringUtil.convertLineSeparators(output));
  }
  finally {
    FileUtil.delete(tempFile);
  }
}
