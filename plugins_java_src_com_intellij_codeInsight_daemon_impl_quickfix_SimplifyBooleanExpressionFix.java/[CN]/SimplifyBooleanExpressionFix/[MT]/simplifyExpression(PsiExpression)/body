{
  final PsiExpression[] result={(PsiExpression)expression.copy()};
  final ExpressionVisitor expressionVisitor=new ExpressionVisitor(expression.getManager(),true);
  final IncorrectOperationException[] exception={null};
  result[0].accept(new JavaRecursiveElementVisitor(){
    @Override public void visitElement(    PsiElement element){
      PsiElement[] children=element.getChildren();
      for (      PsiElement child : children) {
        child.accept(this);
      }
    }
    @Override public void visitExpression(    PsiExpression expression){
      super.visitExpression(expression);
      expressionVisitor.clear();
      expression.accept(expressionVisitor);
      if (expressionVisitor.resultExpression != null) {
        LOG.assertTrue(expressionVisitor.resultExpression.isValid());
        try {
          if (expression != result[0]) {
            expression.replace(expressionVisitor.resultExpression);
          }
 else {
            result[0]=expressionVisitor.resultExpression;
          }
        }
 catch (        IncorrectOperationException e) {
          exception[0]=e;
        }
      }
    }
  }
);
  if (exception[0] != null) {
    throw exception[0];
  }
  PsiExpression newExpression=(PsiExpression)expression.replace(result[0]);
  if (newExpression instanceof PsiLiteralExpression) {
    final PsiElement parent=newExpression.getParent();
    if (parent instanceof PsiAssertStatement && ((PsiLiteralExpression)newExpression).getValue() == Boolean.TRUE) {
      parent.delete();
      return;
    }
  }
  simplifyIfStatement(newExpression);
}
