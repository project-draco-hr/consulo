{
  String fileName=null;
  final String contentDisposition=connection.getHeaderField("Content-Disposition");
  LOG.debug("header: " + contentDisposition);
  if (contentDisposition != null && contentDisposition.contains(FILENAME)) {
    final int startIdx=contentDisposition.indexOf(FILENAME);
    final int endIdx=contentDisposition.indexOf(';',startIdx);
    fileName=contentDisposition.substring(startIdx + FILENAME.length(),endIdx > 0 ? endIdx : contentDisposition.length());
    if (StringUtil.startsWithChar(fileName,'\"') && StringUtil.endsWithChar(fileName,'\"')) {
      fileName=fileName.substring(1,fileName.length() - 1);
    }
  }
  if (fileName == null) {
    final String usedURL=connection.getURL().toString();
    fileName=usedURL.substring(usedURL.lastIndexOf("/") + 1);
    if (fileName.length() == 0 || fileName.contains("?")) {
      fileName=myPluginUrl.substring(myPluginUrl.lastIndexOf("/") + 1);
    }
  }
  if (fileName == null || !PathUtil.isValidFileName(fileName)) {
    FileUtil.delete(file);
    throw new IOException("Invalid filename returned by the server");
  }
  return fileName;
}
