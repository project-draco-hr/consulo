{
  final PsiManager manager=context.getManager();
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(manager.getProject());
  final PsiResolveHelper resolveHelper=facade.getResolveHelper();
  return new Processor<PsiClass>(){
    public boolean process(    final PsiClass inheritor){
      ProgressManager.checkCanceled();
      return ApplicationManager.getApplication().runReadAction(new Computable<Boolean>(){
        public Boolean compute(){
          if (!context.isValid() || !inheritor.isValid() || !facade.getResolveHelper().isAccessible(inheritor,context,null))           return true;
          if (inheritor.getQualifiedName() == null && !manager.areElementsEquivalent(inheritor.getContainingFile(),context.getContainingFile().getOriginalFile())) {
            return true;
          }
          if (JavaCompletionUtil.isInExcludedPackage(inheritor))           return true;
          PsiSubstitutor superSubstitutor=TypeConversionUtil.getClassSubstitutor(baseClass,inheritor,PsiSubstitutor.EMPTY);
          if (superSubstitutor == null)           return true;
          if (getRawSubtypes) {
            result.add(createType(inheritor,facade.getElementFactory().createRawSubstitutor(inheritor),arrayDim));
            return true;
          }
          PsiSubstitutor inheritorSubstitutor=PsiSubstitutor.EMPTY;
          for (          PsiTypeParameter inheritorParameter : PsiUtil.typeParametersIterable(inheritor)) {
            for (            PsiTypeParameter baseParameter : PsiUtil.typeParametersIterable(baseClass)) {
              final PsiType substituted=superSubstitutor.substitute(baseParameter);
              PsiType arg=baseSubstitutor.substitute(baseParameter);
              if (arg instanceof PsiWildcardType)               arg=((PsiWildcardType)arg).getExtendsBound();
              PsiType substitution=resolveHelper.getSubstitutionForTypeParameter(inheritorParameter,substituted,arg,true,PsiUtil.getLanguageLevel(context));
              if (PsiType.NULL.equals(substitution) || substitution instanceof PsiWildcardType)               continue;
              if (substitution == null) {
                result.add(createType(inheritor,facade.getElementFactory().createRawSubstitutor(inheritor),arrayDim));
                return true;
              }
              inheritorSubstitutor=inheritorSubstitutor.put(inheritorParameter,substitution);
              break;
            }
          }
          PsiType toAdd=createType(inheritor,inheritorSubstitutor,arrayDim);
          if (baseType.isAssignableFrom(toAdd)) {
            result.add(toAdd);
          }
          return true;
        }
      }
).booleanValue();
    }
  }
;
}
