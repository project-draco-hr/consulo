{
  String name="myclass";
  FileTemplate template=FileTemplateManager.getInstance().addInternal(name,"java");
  try {
    template.setText("package ${PACKAGE_NAME}; public class ${NAME} {}");
    File temp=FileUtil.createTempDirectory(getTestName(true),"");
    myFilesToDelete.add(temp);
    VirtualFile tempDir=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(temp);
    ModuleRootManager rootManager=ModuleRootManager.getInstance(getModule());
    ModifiableRootModel model=rootManager.getModifiableModel();
    ContentEntry contentEntry=model.addContentEntry(tempDir);
    contentEntry.addSourceFolder(tempDir,false);
    model.commit();
    VirtualFile sourceRoot=rootManager.getSourceRoots()[0];
    PsiDirectory psiDirectory=PsiManager.getInstance(getProject()).findDirectory(sourceRoot);
    PsiClass psiClass=JavaDirectoryService.getInstance().createClass(psiDirectory,"XXX",name);
    assertNotNull(psiClass);
    assertEquals("public class XXX {\n}",psiClass.getContainingFile().getText());
  }
  finally {
    FileTemplateManager.getInstance().saveAll();
    FileTemplateManager.getInstance().removeTemplate(template,false);
  }
}
