{
  String name="myclass";
  FileTemplate template=FileTemplateManager.getInstance().addInternal(name,"java");
  try {
    template.setText("package ${PACKAGE_NAME}; public class ${NAME} {}");
    File temp=FileUtil.createTempDirectory(getTestName(true),"");
    myFilesToDelete.add(temp);
    final VirtualFile tempDir=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(temp);
    final ModuleRootManager rootManager=ModuleRootManager.getInstance(getModule());
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        ModifiableRootModel model=rootManager.getModifiableModel();
        ContentEntry contentEntry=model.addContentEntry(tempDir);
        contentEntry.addSourceFolder(tempDir,false);
        model.commit();
      }
    }
);
    VirtualFile sourceRoot=rootManager.getSourceRoots()[0];
    PsiDirectory psiDirectory=PsiManager.getInstance(getProject()).findDirectory(sourceRoot);
    PsiClass psiClass=JavaDirectoryService.getInstance().createClass(psiDirectory,"XXX",name);
    assertNotNull(psiClass);
    assertEquals("public class XXX {\n}",psiClass.getContainingFile().getText());
  }
  finally {
    FileTemplateManager.getInstance().removeTemplate(template);
  }
}
