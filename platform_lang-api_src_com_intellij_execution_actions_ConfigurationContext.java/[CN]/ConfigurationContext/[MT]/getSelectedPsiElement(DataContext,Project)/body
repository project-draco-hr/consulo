{
  PsiElement element=null;
  final Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  if (editor != null) {
    final PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (psiFile != null) {
      final int offset=editor.getCaretModel().getOffset();
      element=psiFile.findElementAt(offset);
      if (element == null && offset > 0 && offset == psiFile.getTextLength()) {
        element=psiFile.findElementAt(offset - 1);
      }
    }
  }
  if (element == null) {
    element=LangDataKeys.PSI_ELEMENT.getData(dataContext);
  }
  if (element == null) {
    final VirtualFile file=PlatformDataKeys.VIRTUAL_FILE.getData(dataContext);
    if (file != null) {
      element=PsiManager.getInstance(project).findFile(file);
    }
  }
  return element;
}
