{
  final VirtualFileManagerEx manager=(VirtualFileManagerEx)VirtualFileManager.getInstance();
  Application app=ApplicationManager.getApplication();
  boolean fireCommonRefreshSession=app.isDispatchThread() || app.isWriteAccessAllowed();
  if (fireCommonRefreshSession)   manager.fireBeforeRefreshStart(false);
  try {
    List<VirtualFile> filesToRefresh=new ArrayList<VirtualFile>();
    for (    File file : files) {
      final VirtualFile virtualFile=refreshAndFindFileByIoFile(file);
      if (virtualFile != null) {
        filesToRefresh.add(virtualFile);
      }
    }
    RefreshQueue.getInstance().refresh(false,false,null,VfsUtil.toVirtualFileArray(filesToRefresh));
  }
  finally {
    if (fireCommonRefreshSession)     manager.fireAfterRefreshFinish(false);
  }
}
