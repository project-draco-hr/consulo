{
  if (element instanceof FileElement) {
    final FileElement fileElement=(FileElement)element;
    final VirtualFile elementFile=getValidFile(fileElement);
    if (elementFile != null && myRootElement.getFile() != null && myRootElement.getFile().equals(elementFile)) {
      return null;
    }
    final VirtualFile parentElementFile=getValidFile(fileElement.getParent());
    if (elementFile != null && parentElementFile != null) {
      final VirtualFile parentFile=elementFile.getParent();
      if (parentElementFile.equals(parentFile))       return fileElement.getParent();
    }
    VirtualFile file=fileElement.getFile();
    if (file == null)     return null;
    VirtualFile parent=file.getParent();
    if (parent != null && parent.getFileSystem() instanceof ArchiveFileSystem && parent.getParent() == null) {
      String localPath=parent.getPath().substring(0,parent.getPath().length() - ArchiveFileSystem.ARCHIVE_SEPARATOR.length());
      parent=LocalFileSystem.getInstance().findFileByPath(localPath);
    }
    if (parent != null && parent.isValid() && parent.equals(myRootElement.getFile())) {
      return myRootElement;
    }
    if (parent == null) {
      return myRootElement;
    }
    return new FileElement(parent,parent.getName());
  }
  return null;
}
