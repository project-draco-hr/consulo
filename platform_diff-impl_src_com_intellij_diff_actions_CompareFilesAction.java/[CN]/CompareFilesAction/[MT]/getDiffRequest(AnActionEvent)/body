{
  Project project=e.getProject();
  DiffRequest diffRequest=e.getData(DIFF_REQUEST);
  if (diffRequest != null) {
    return diffRequest;
  }
  VirtualFile[] data=e.getRequiredData(CommonDataKeys.VIRTUAL_FILE_ARRAY);
  if (data.length == 1) {
    VirtualFile otherFile=getOtherFile(project,data[0]);
    if (otherFile == null)     return null;
    if (!data[0].isValid())     return null;
    return DiffRequestFactory.getInstance().createFromFiles(project,data[0],otherFile);
  }
 else {
    return DiffRequestFactory.getInstance().createFromFiles(project,data[0],data[1]);
  }
}
