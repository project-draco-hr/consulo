{
  PsiManager manager=aPackage.getManager();
  final PackageWrapper targetPackage=moveDestination.getTargetPackage();
  Map<MoveRenameUsageInfo,String> targetPackages=new HashMap<MoveRenameUsageInfo,String>();
  final String newPrefix;
  if ("".equals(targetPackage.getQualifiedName())) {
    newPrefix="";
  }
 else {
    newPrefix=targetPackage.getQualifiedName() + ".";
  }
  final String newPackageQualifiedName=newPrefix + aPackage.getName();
  for (int i=0; i < usages.length; i++) {
    MoveRenameUsageInfo usage=(MoveRenameUsageInfo)usages[i];
    LOG.assertTrue(usage.referencedElement instanceof PsiPackage);
    final PsiPackage oldPackage=(PsiPackage)usage.referencedElement;
    LOG.assertTrue(!"".equals(oldPackage.getName()));
    targetPackages.put(usage,newPrefix + oldPackage.getName());
  }
  final GlobalSearchScope projectScope=GlobalSearchScope.projectScope(aPackage.getProject());
  PsiDirectory[] dirs=aPackage.getDirectories(projectScope);
  for (int i=0; i < dirs.length; i++) {
    PsiDirectory dir=dirs[i];
    final PsiDirectory targetDirectory=moveDestination.getTargetDirectory(dir);
    if (targetDirectory != null) {
      moveDirectoryRecursively(dir,targetDirectory);
    }
  }
  for (int i=0; i < usages.length; i++) {
    MoveRenameUsageInfo usage=(MoveRenameUsageInfo)usages[i];
    if (!usage.getElement().isValid())     continue;
    PsiReference reference=usage.reference;
    if (reference != null) {
      final String newQName=targetPackages.get(usage);
      final PsiPackage newPackage=manager.findPackage(newQName);
      reference.bindToElement(newPackage);
    }
  }
  aPackage.handleQualifiedNameChange(newPackageQualifiedName);
  return manager.findPackage(newPackageQualifiedName);
}
