{
  @SuppressWarnings("IOResourceOpenedButNotSafelyClosed") InputStream stream=loader.getResourceAsStream(templateName);
  if (stream == null) {
    throw new IOException("Template '" + templateName + "' not found by "+ loader);
  }
  String template=FileUtil.loadTextAndClose(new InputStreamReader(stream,CharsetToolkit.UTF8));
  if (variables == null || variables.size() == 0) {
    return template;
  }
  StringBuilder buffer=new StringBuilder(template);
  for (  Map.Entry<String,String> var : variables.entrySet()) {
    String name=var.getKey();
    int pos=buffer.indexOf(name);
    if (pos >= 0) {
      buffer.replace(pos,pos + name.length(),var.getValue());
    }
  }
  return buffer.toString();
}
