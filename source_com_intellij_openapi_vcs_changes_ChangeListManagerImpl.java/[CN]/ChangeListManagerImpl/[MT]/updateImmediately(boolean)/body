{
  try {
synchronized (myPendingUpdatesLock) {
      myUpdateInProgress=true;
    }
    if (myDisposed)     throw new DisposedException();
    final VcsDirtyScopeManagerImpl dirtyScopeManager=((VcsDirtyScopeManagerImpl)VcsDirtyScopeManager.getInstance(myProject));
    final boolean wasEverythingDirty=dirtyScopeManager.isEverythingDirty();
    final List<VcsDirtyScope> scopes=dirtyScopeManager.retreiveScopes();
    final UnversionedFilesHolder unversionedHolder;
    final DeletedFilesHolder deletedHolder;
    if (updateUnversionedFiles) {
      unversionedHolder=myUnversionedFilesHolder.copy();
      deletedHolder=myDeletedFilesHolder.copy();
      if (wasEverythingDirty) {
        unversionedHolder.cleanAll();
        deletedHolder.cleanAll();
      }
    }
 else {
      unversionedHolder=myUnversionedFilesHolder;
      deletedHolder=myDeletedFilesHolder;
    }
    for (    final VcsDirtyScope scope : scopes) {
      final AbstractVcs vcs=scope.getVcs();
      if (vcs == null)       continue;
      myCurrentlyUpdatingScope=scope;
      ChangesViewManager.getInstance(myProject).updateProgressText(VcsBundle.message("changes.update.progress.message",vcs.getDisplayName()));
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
synchronized (myChangeLists) {
            for (            LocalChangeList list : getChangeLists()) {
              if (myDisposed)               throw new DisposedException();
              list.startProcessingChanges(scope);
            }
          }
        }
      }
);
      if (updateUnversionedFiles && !wasEverythingDirty) {
        unversionedHolder.cleanScope(scope);
        deletedHolder.cleanScope(scope);
      }
      try {
        final ChangeProvider changeProvider=vcs.getChangeProvider();
        if (changeProvider != null) {
          changeProvider.getChanges(scope,new ChangelistBuilder(){
            public void processChange(            final Change change){
              processChangeInList(change,null);
            }
            public void processChangeInList(            final Change change,            final ChangeList changeList){
              if (myDisposed)               throw new DisposedException();
              final String fileName=ChangesUtil.getFilePath(change).getName();
              if (FileTypeManager.getInstance().isFileIgnored(fileName))               return;
              ApplicationManager.getApplication().runReadAction(new Runnable(){
                public void run(){
                  if (isUnder(change,scope)) {
                    try {
synchronized (myChangeLists) {
                        if (changeList instanceof LocalChangeList) {
                          ((LocalChangeList)changeList).addChange(change);
                        }
 else {
                          for (                          LocalChangeList list : myChangeLists) {
                            if (list == myDefaultChangelist)                             continue;
                            if (list.processChange(change))                             return;
                          }
                          myDefaultChangelist.processChange(change);
                        }
                      }
                    }
  finally {
                      ChangesViewManager.getInstance(myProject).scheduleRefresh();
                    }
                  }
                }
              }
);
            }
            public void processUnversionedFile(            VirtualFile file){
              if (file == null || !updateUnversionedFiles)               return;
              if (myDisposed)               throw new DisposedException();
              if (FileTypeManager.getInstance().isFileIgnored(file.getName()))               return;
              if (scope.belongsTo(PeerFactory.getInstance().getVcsContextFactory().createFilePathOn(file))) {
                unversionedHolder.addFile(file);
                ChangesViewManager.getInstance(myProject).scheduleRefresh();
              }
            }
            public void processLocallyDeletedFile(            FilePath file){
              if (!updateUnversionedFiles)               return;
              if (myDisposed)               throw new DisposedException();
              if (FileTypeManager.getInstance().isFileIgnored(file.getName()))               return;
              if (scope.belongsTo(file)) {
                deletedHolder.addFile(file);
                ChangesViewManager.getInstance(myProject).scheduleRefresh();
              }
            }
            public void processModifiedWithoutEditing(            VirtualFile file){
              if (myDisposed)               throw new DisposedException();
            }
            public boolean isUpdatingUnversionedFiles(){
              return updateUnversionedFiles;
            }
          }
,null);
        }
      }
  finally {
        myCurrentlyUpdatingScope=null;
        if (!myDisposed) {
          List<ChangeList> changedLists=new ArrayList<ChangeList>();
synchronized (myChangeLists) {
            for (            LocalChangeList list : myChangeLists) {
              if (list.doneProcessingChanges()) {
                changedLists.add(list);
              }
            }
          }
          for (          ChangeList changeList : changedLists) {
            myListeners.getMulticaster().changeListChanged(changeList);
          }
        }
      }
      if (updateUnversionedFiles) {
        myUnversionedFilesHolder=unversionedHolder;
        myDeletedFilesHolder=deletedHolder;
      }
      myListeners.getMulticaster().changeListUpdateDone();
    }
  }
 catch (  DisposedException e) {
  }
catch (  Exception ex) {
    LOG.error(ex);
  }
 finally {
    ChangesViewManager.getInstance(myProject).updateProgressText("");
synchronized (myPendingUpdatesLock) {
      myUpdateInProgress=false;
      myPendingUpdatesLock.notifyAll();
    }
  }
}
