{
  ErrorState state=builder.getUserDataUnprotected(ERROR_STATE_KEY);
  if (state == null) {
    builder.putUserDataUnprotected(ERROR_STATE_KEY,state=new ErrorState());
    PsiFile file=builder.getUserDataUnprotected(FileContextUtil.CONTAINING_FILE_KEY);
    state.completionState=file == null ? null : file.getUserData(COMPLETION_STATE_KEY);
    if (file != null) {
      Language language=file.getLanguage();
      state.caseSensitive=language.isCaseSensitive();
      PairedBraceMatcher matcher=LanguageBraceMatching.INSTANCE.forLanguage(language);
      state.braces=matcher == null ? null : matcher.getPairs();
      if (state.braces != null && state.braces.length == 0)       state.braces=null;
      ParserDefinition parserDefinition=LanguageParserDefinitions.INSTANCE.forLanguage(language);
      if (parserDefinition != null) {
        state.commentTokens=parserDefinition.getCommentTokens();
        state.whitespaceTokens=parserDefinition.getWhitespaceTokens();
      }
    }
  }
  return state;
}
