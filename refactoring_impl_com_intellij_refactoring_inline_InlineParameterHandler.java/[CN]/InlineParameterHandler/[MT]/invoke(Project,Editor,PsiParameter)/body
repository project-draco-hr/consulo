{
  String errorMessage=getCannotInlineMessage(psiParameter);
  if (errorMessage != null) {
    CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("inline.parameter.refactoring"),errorMessage,null,project);
    return;
  }
  final PsiParameterList parameterList=(PsiParameterList)psiParameter.getParent();
  if (!(parameterList.getParent() instanceof PsiMethod)) {
    return;
  }
  final int index=parameterList.getParameterIndex(psiParameter);
  final PsiMethod method=(PsiMethod)parameterList.getParent();
  final Ref<PsiExpression> refInitializer=new Ref<PsiExpression>();
  final Ref<PsiExpression> refConstantInitializer=new Ref<PsiExpression>();
  final Ref<PsiMethodCallExpression> refMethodCall=new Ref<PsiMethodCallExpression>();
  final List<PsiReference> occurrences=new ArrayList<PsiReference>();
  final Collection<PsiFile> containingFiles=new HashSet<PsiFile>();
  boolean result=ReferencesSearch.search(method).forEach(new Processor<PsiReference>(){
    public boolean process(    final PsiReference psiReference){
      PsiElement element=psiReference.getElement();
      if (element.getParent() instanceof PsiMethodCallExpression) {
        occurrences.add(psiReference);
        containingFiles.add(element.getContainingFile());
        PsiMethodCallExpression methodCall=(PsiMethodCallExpression)element.getParent();
        PsiExpression argument=methodCall.getArgumentList().getExpressions()[index];
        if (!refInitializer.isNull()) {
          return false;
        }
        if (InlineToAnonymousConstructorProcessor.isConstant(argument)) {
          if (refConstantInitializer.isNull()) {
            refConstantInitializer.set(argument);
          }
 else           if (!isSameConstant(argument,refConstantInitializer.get())) {
            return false;
          }
        }
 else {
          refInitializer.set(argument);
          refMethodCall.set(methodCall);
        }
      }
      return true;
    }
  }
);
  if (occurrences.isEmpty()) {
    CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("inline.parameter.refactoring"),"Method has no usages",null,project);
    return;
  }
  if (!result) {
    CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("inline.parameter.refactoring"),"Cannot find constant initializer for parameter",null,project);
    return;
  }
  final ApplicationEx app=(ApplicationEx)ApplicationManager.getApplication();
  if ((app.isInternal() || app.isUnitTestMode()) && !refInitializer.isNull()) {
    tryInlineReferenceArgument(refMethodCall.get(),method,psiParameter,refInitializer.get());
    return;
  }
  if (refConstantInitializer.isNull()) {
    CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("inline.parameter.refactoring"),"Cannot find constant initializer for parameter",null,project);
    return;
  }
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    String occurencesString=RefactoringBundle.message("occurences.string",occurrences.size());
    String question=RefactoringBundle.message("inline.parameter.confirmation",psiParameter.getName(),refConstantInitializer.get().getText()) + " " + occurencesString;
    RefactoringMessageDialog dialog=new RefactoringMessageDialog(REFACTORING_NAME,question,HelpID.INLINE_VARIABLE,"OptionPane.questionIcon",true,project);
    dialog.show();
    if (!dialog.isOK()) {
      return;
    }
  }
  new WriteCommandAction(project,RefactoringBundle.message("inline.parameter.command.name",psiParameter.getName()),containingFiles.toArray(new PsiFile[containingFiles.size()])){
    protected void run(    final Result result) throws Throwable {
      SameParameterValueInspection.InlineParameterValueFix.inlineSameParameterValue(method,psiParameter,refConstantInitializer.get());
    }
    protected UndoConfirmationPolicy getUndoConfirmationPolicy(){
      return UndoConfirmationPolicy.DEFAULT;
    }
  }
.execute();
}
