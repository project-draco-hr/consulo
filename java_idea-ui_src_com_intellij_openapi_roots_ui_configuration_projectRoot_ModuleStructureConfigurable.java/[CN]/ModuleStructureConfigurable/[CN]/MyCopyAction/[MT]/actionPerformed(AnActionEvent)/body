{
  final NamedConfigurable namedConfigurable=getSelectedConfigurable();
  if (namedConfigurable instanceof ModuleConfigurable) {
    try {
      final ModuleEditor moduleEditor=((ModuleConfigurable)namedConfigurable).getModuleEditor();
      final String modulePresentation=IdeBundle.message("project.new.wizard.module.identification");
      final NamePathComponent component=new NamePathComponent(IdeBundle.message("label.module.name"),IdeBundle.message("label.component.file.location",StringUtil.capitalize(modulePresentation)),IdeBundle.message("title.select.project.file.directory",modulePresentation),IdeBundle.message("description.select.project.file.directory",StringUtil.capitalize(modulePresentation)),true,false);
      final Module originalModule=moduleEditor.getModule();
      if (originalModule != null) {
        component.setPath(FileUtil.toSystemDependentName(PathUtil.getParentPath(originalModule.getModuleFilePath())));
      }
      final DialogBuilder dialogBuilder=new DialogBuilder(myTree);
      dialogBuilder.setTitle(ProjectBundle.message("copy.module.dialog.title"));
      dialogBuilder.setCenterPanel(component);
      dialogBuilder.setPreferedFocusComponent(component.getNameComponent());
      dialogBuilder.setOkOperation(new Runnable(){
        @Override public void run(){
          final String name=component.getNameValue();
          if (name.length() == 0) {
            Messages.showErrorDialog(ProjectBundle.message("enter.module.copy.name.error.message"),CommonBundle.message("title.error"));
            return;
          }
          if (getModule(name) != null) {
            Messages.showErrorDialog(ProjectBundle.message("module.0.already.exists.error.message",name),CommonBundle.message("title.error"));
            return;
          }
          if (component.getPath().length() == 0) {
            Messages.showErrorDialog(IdeBundle.message("prompt.enter.project.file.location",modulePresentation),CommonBundle.message("title.error"));
            return;
          }
          if (!ProjectWizardUtil.createDirectoryIfNotExists(IdeBundle.message("directory.project.file.directory",modulePresentation),component.getPath(),true)) {
            Messages.showErrorDialog(ProjectBundle.message("path.0.is.invalid.error.message",component.getPath()),CommonBundle.message("title.error"));
            return;
          }
          dialogBuilder.getDialogWrapper().close(DialogWrapper.OK_EXIT_CODE);
        }
      }
);
      if (dialogBuilder.show() != DialogWrapper.OK_EXIT_CODE)       return;
      final ModifiableRootModel rootModel=moduleEditor.getModifiableRootModel();
      final String path=component.getPath();
      final ModuleBuilder builder=new ModuleBuilder(){
        public void setupRootModel(        final ModifiableRootModel modifiableRootModel) throws ConfigurationException {
          if (rootModel.isSdkInherited()) {
            modifiableRootModel.inheritSdk();
          }
 else {
            modifiableRootModel.setSdk(rootModel.getSdk());
          }
          modifiableRootModel.getModuleExtension(CompilerModuleExtension.class).inheritCompilerOutputPath(true);
          modifiableRootModel.getModuleExtension(LanguageLevelModuleExtension.class).setLanguageLevel(LanguageLevelModuleExtension.getInstance(rootModel.getModule()).getLanguageLevel());
          for (          OrderEntry entry : rootModel.getOrderEntries()) {
            if (entry instanceof JdkOrderEntry)             continue;
            if (entry instanceof ModuleSourceOrderEntry)             continue;
            if (entry instanceof ClonableOrderEntry) {
              modifiableRootModel.addOrderEntry(((ClonableOrderEntry)entry).cloneEntry((RootModelImpl)modifiableRootModel,(ProjectRootManagerImpl)ProjectRootManager.getInstance(myProject),VirtualFilePointerManager.getInstance()));
            }
          }
          VirtualFile content=LocalFileSystem.getInstance().findFileByPath(component.getPath());
          if (content == null) {
            content=LocalFileSystem.getInstance().refreshAndFindFileByPath(component.getPath());
          }
          modifiableRootModel.addContentEntry(content);
        }
        public ModuleType getModuleType(){
          return ModuleType.get(rootModel.getModule());
        }
      }
;
      builder.setName(component.getNameValue());
      builder.setModuleFilePath(path + "/" + builder.getName()+ ModuleFileType.DOT_DEFAULT_EXTENSION);
      final Module module=myContext.myModulesConfigurator.addModule(builder);
      if (module != null) {
        addModuleNode(module);
      }
    }
 catch (    Exception e1) {
      LOG.error(e1);
    }
  }
 else {
    copyByExtension(namedConfigurable);
  }
}
