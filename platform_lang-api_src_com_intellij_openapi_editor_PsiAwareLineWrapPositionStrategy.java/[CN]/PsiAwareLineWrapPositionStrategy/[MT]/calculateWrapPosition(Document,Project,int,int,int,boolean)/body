{
  if (project == null) {
    return -1;
  }
  PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  if (documentManager == null) {
    return -1;
  }
  PsiFile psiFile=documentManager.getPsiFile(document);
  if (psiFile == null) {
    return -1;
  }
  PsiElement element=psiFile.findElementAt(maxPreferredOffset);
  if (element == null) {
    return -1;
  }
  for (; element != null && element.getTextRange().getEndOffset() > startOffset; element=getPrevious(element)) {
    if (allowToWrapInside(element)) {
      TextRange textRange=element.getTextRange();
      int start=textRange.getStartOffset();
      int end=textRange.getEndOffset();
      int result=doCalculateWrapPosition(document,project,start,end,end,false);
      if (result >= 0) {
        return result;
      }
      if (end <= maxPreferredOffset) {
        return end;
      }
      if (start > startOffset) {
        return start;
      }
    }
  }
  return -1;
}
