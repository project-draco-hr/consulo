{
  if (t == null || (upper && t.getCanonicalText().equals("java.lang.Object"))) {
    return factory.create(context);
  }
  if (t instanceof PsiClassType) {
    final PsiClassType.ClassResolveResult result=resolveType(t);
    final PsiSubstitutor aSubst=result.getSubstitutor();
    final PsiClass aClass=result.getElement();
    PsiSubstitutor theSubst=PsiSubstitutor.EMPTY;
    final HashSet<PsiTypeVariable> cluster=new HashSet<PsiTypeVariable>();
    for (    final PsiTypeParameter parm : aSubst.getSubstitutionMap().keySet()) {
      final PsiType type=createParameterizedType(aSubst.substitute(parm),factory,false,context);
      if (type instanceof PsiTypeVariable) {
        cluster.add((PsiTypeVariable)type);
      }
      theSubst=theSubst.put(parm,type);
    }
    if (cluster.size() > 1) {
      factory.registerCluster(cluster);
    }
    return aClass.getManager().getElementFactory().createType(aClass,theSubst);
  }
 else   if (t instanceof PsiArrayType) {
    return createParameterizedType(((PsiArrayType)t).getComponentType(),factory,upper,context).createArrayType();
  }
  return t;
}
