{
  if (t instanceof PsiArrayType) {
    PsiType normType=normalize(((PsiArrayType)t).getComponentType(),objectBottom);
    return normType == null ? null : normType.createArrayType();
  }
 else   if (t instanceof PsiClassType) {
    PsiClassType.ClassResolveResult result=resolveType(t);
    if (result == null) {
      return null;
    }
    PsiClass aclass=result.getElement();
    PsiSubstitutor subst=result.getSubstitutor();
    PsiManager manager=aclass.getManager();
    final Iterator<PsiTypeParameter> iterator=PsiUtil.typeParametersIterator(aclass);
    PsiSubstitutor newbst=PsiSubstitutor.EMPTY;
    boolean anyBottom=false;
    while (iterator.hasNext()) {
      final PsiTypeParameter typeParameter=iterator.next();
      PsiType p=subst.substitute(typeParameter);
      if (p != null) {
        PsiType pp=normalize(p,objectBottom);
        if (pp == null) {
          return null;
        }
        if (pp == Bottom.BOTTOM || (objectBottom && pp.getCanonicalText().equals("java.lang.Object"))) {
          anyBottom=true;
        }
        newbst=newbst.put(typeParameter,pp);
      }
 else {
        anyBottom=true;
      }
    }
    if (anyBottom || newbst == PsiSubstitutor.EMPTY) {
      newbst=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory().createRawSubstitutor(aclass);
    }
    return JavaPsiFacade.getInstance(manager.getProject()).getElementFactory().createType(aclass,newbst);
  }
 else {
    return t;
  }
}
