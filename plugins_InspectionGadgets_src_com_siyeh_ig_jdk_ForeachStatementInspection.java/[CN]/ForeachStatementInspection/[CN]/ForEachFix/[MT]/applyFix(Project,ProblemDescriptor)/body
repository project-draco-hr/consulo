{
  if (ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(new VirtualFile[]{descriptor.getPsiElement().getContainingFile().getVirtualFile()}).hasReadonlyFiles()) {
    return;
  }
  final PsiForeachStatement statement=(PsiForeachStatement)descriptor.getPsiElement();
  StringBuffer newStatement=new StringBuffer();
  final PsiExpression iteratedValue=statement.getIteratedValue();
  if (iteratedValue.getType() instanceof PsiArrayType) {
    newStatement.append("for(int i = 0;i<").append(iteratedValue.getText()).append(".length;i++)");
    newStatement.append("{ ").append(statement.getIterationParameter().getType().getPresentableText()).append(" ").append(statement.getIterationParameter()).append(" = ").append(iteratedValue.getText()).append("[i];");
    final PsiStatement body=statement.getBody();
    if (body instanceof PsiBlockStatement) {
      final PsiElement[] children=body.getChildren();
      for (int i=1; i < children.length - 1; i++) {
        PsiElement child=children[i];
        newStatement.append(child.getText());
      }
    }
 else {
      newStatement.append(body.getText());
    }
    newStatement.append("}");
  }
 else {
    newStatement.append("for(Iterator it = ").append(iteratedValue.getText()).append(".iterator;it.hasNext();)");
    newStatement.append("{");
    final PsiStatement body=statement.getBody();
    if (body instanceof PsiBlockStatement) {
      final PsiElement[] children=body.getChildren();
      for (int i=1; i < children.length - 1; i++) {
        PsiElement child=children[i];
        newStatement.append(child.getText());
      }
    }
 else {
      newStatement.append(body.getText());
    }
    newStatement.append("}");
  }
  replaceStatement(project,statement,newStatement.toString());
}
