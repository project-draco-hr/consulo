{
  final PsiElement root=getRootElement(psi);
  if (root == null) {
    return Collections.emptyList();
  }
  List<T> cached=_getCachedSemElements(key,true,psi,root);
  if (cached != null) {
    return cached;
  }
  RecursionGuard.StackStamp stamp=RecursionManager.createGuard("semService").markStack();
  LinkedHashSet<T> result=new LinkedHashSet<T>();
  final Map<SemKey,List<SemElement>> map=new THashMap<SemKey,List<SemElement>>();
  for (  final SemKey each : myInheritors.get(key)) {
    List<SemElement> list=createSemElements(each,psi);
    map.put(each,list);
    result.addAll((List<T>)list);
  }
  if (stamp.mayCacheNow()) {
    final ConcurrentMap<SemKey,List<SemElement>> persistent=cacheOrGetMap(psi,root);
    for (    SemKey semKey : map.keySet()) {
      persistent.putIfAbsent(semKey,map.get(semKey));
    }
  }
  return new ArrayList<T>(result);
}
