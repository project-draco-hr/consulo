{
  myProject=project;
  project.getMessageBus().connect().subscribe(ProjectTopics.MODIFICATION_TRACKER,new PsiModificationTracker.Listener(){
    public void modificationCountChanged(){
      if (!isInsideAtomicChange()) {
        clearCache();
      }
    }
  }
);
  ((PsiManagerEx)psiManager).registerRunnableToRunOnChange(new Runnable(){
    public void run(){
      if (!isInsideAtomicChange()) {
        clearCache();
      }
    }
  }
);
  final MutablePicoContainer container=(MutablePicoContainer)project.getPicoContainer();
  final String serviceKey=SemService.class.getName();
  container.unregisterComponent(serviceKey);
  container.registerComponentInstance(serviceKey,this);
  SemKey[] allKeys=collectProducers();
  cacheKeyHierarchy(allKeys);
  final LowMemoryWatcher watcher=LowMemoryWatcher.register(new LowMemoryWatcher.ForceableAdapter(){
    public void force(){
      myCache.clear();
    }
  }
);
  ProjectManager.getInstance().addProjectManagerListener(project,new ProjectManagerAdapter(){
    public void projectClosing(    Project project){
      watcher.stop();
    }
  }
);
}
