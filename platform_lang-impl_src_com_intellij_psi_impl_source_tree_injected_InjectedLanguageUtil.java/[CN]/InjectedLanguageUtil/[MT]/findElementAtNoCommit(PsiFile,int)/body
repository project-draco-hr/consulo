{
  FileViewProvider viewProvider=file.getViewProvider();
  Trinity<PsiElement,PsiElement,Language> result=null;
  if (!(viewProvider instanceof InjectedFileViewProvider)) {
    PsiDocumentManager documentManager=PsiDocumentManager.getInstance(file.getProject());
    result=tryOffset(file,offset,documentManager);
    PsiElement injected=result.first;
    if (injected != null) {
      return injected;
    }
  }
  Language baseLanguage=viewProvider.getBaseLanguage();
  if (result != null && baseLanguage == result.third) {
    return result.second;
  }
  return viewProvider.findElementAt(offset,baseLanguage);
}
