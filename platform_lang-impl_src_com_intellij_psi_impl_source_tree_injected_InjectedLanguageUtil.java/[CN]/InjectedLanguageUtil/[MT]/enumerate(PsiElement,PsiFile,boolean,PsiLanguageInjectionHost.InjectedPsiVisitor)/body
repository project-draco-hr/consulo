{
  if (!containingFile.isPhysical() && containingFile.getOriginalFile() == containingFile) {
    final PsiElement context=containingFile.getContext();
    if (context == null)     return;
    final PsiFile file=context.getContainingFile();
    if (file == null || !file.isPhysical() && file.getOriginalFile() == file)     return;
  }
  PsiElement inTree=loadTree(host,containingFile);
  if (inTree != host) {
    host=inTree;
    containingFile=host.getContainingFile();
  }
  MultiHostRegistrarImpl registrar=probeElementsUp(host,containingFile,probeUp);
  if (registrar == null)   return;
  List<Pair<Place,PsiFile>> places=registrar.result;
  for (  Pair<Place,PsiFile> pair : places) {
    PsiFile injectedPsi=pair.second;
    visitor.visit(injectedPsi,pair.first);
  }
}
