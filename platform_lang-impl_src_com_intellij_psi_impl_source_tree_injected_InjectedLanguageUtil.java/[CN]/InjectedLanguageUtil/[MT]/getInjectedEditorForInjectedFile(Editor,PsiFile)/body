{
  if (injectedFile == null || editor instanceof EditorWindow)   return editor;
  Document document=PsiDocumentManager.getInstance(editor.getProject()).getDocument(injectedFile);
  if (!(document instanceof DocumentWindowImpl))   return editor;
  DocumentWindowImpl documentWindow=(DocumentWindowImpl)document;
  SelectionModel selectionModel=editor.getSelectionModel();
  if (selectionModel.hasSelection()) {
    int selstart=selectionModel.getSelectionStart();
    int selend=selectionModel.getSelectionEnd();
    if (!documentWindow.containsRange(selstart,selend)) {
      return editor;
    }
  }
  if (!documentWindow.isValid())   return editor;
  return EditorWindow.create(documentWindow,(EditorImpl)editor,injectedFile);
}
