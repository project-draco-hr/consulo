{
  if (injectedFile == null || hostEditor instanceof EditorWindow || hostEditor.isDisposed())   return hostEditor;
  Project project=hostEditor.getProject();
  if (project == null)   project=injectedFile.getProject();
  Document document=PsiDocumentManager.getInstance(project).getDocument(injectedFile);
  if (!(document instanceof DocumentWindowImpl))   return hostEditor;
  DocumentWindowImpl documentWindow=(DocumentWindowImpl)document;
  SelectionModel selectionModel=hostEditor.getSelectionModel();
  if (selectionModel.hasSelection()) {
    int selstart=selectionModel.getSelectionStart();
    if (selstart != -1) {
      int selend=Math.max(selstart,selectionModel.getSelectionEnd());
      if (!documentWindow.containsRange(selstart,selend)) {
        return hostEditor;
      }
    }
  }
  if (!documentWindow.isValid())   return hostEditor;
  return EditorWindowImpl.create(documentWindow,(EditorImpl)hostEditor,injectedFile);
}
