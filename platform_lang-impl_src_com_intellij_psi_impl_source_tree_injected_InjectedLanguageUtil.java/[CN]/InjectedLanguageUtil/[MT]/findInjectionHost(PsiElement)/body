{
  if (psi == null)   return null;
  PsiFile containingFile=psi.getContainingFile().getOriginalFile();
  PsiElement fileContext=containingFile.getContext();
  if (fileContext instanceof PsiLanguageInjectionHost)   return (PsiLanguageInjectionHost)fileContext;
  Place shreds=getShreds(containingFile.getViewProvider());
  if (shreds == null) {
    VirtualFile virtualFile=PsiUtilCore.getVirtualFile(containingFile);
    if (virtualFile instanceof LightVirtualFile) {
      virtualFile=((LightVirtualFile)virtualFile).getOriginalFile();
    }
    if (virtualFile instanceof VirtualFileWindow) {
      shreds=getShreds(((VirtualFileWindow)virtualFile).getDocumentWindow());
    }
  }
  return shreds != null ? shreds.getHostPointer().getElement() : null;
}
