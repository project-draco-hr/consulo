{
  PsiManager psiManager=hostPsiFile.getManager();
  final Project project=psiManager.getProject();
  InjectedLanguageManagerImpl injectedManager=InjectedLanguageManagerImpl.getInstanceImpl(project);
  if (injectedManager == null)   return null;
  for (PsiElement current=element; current != null && current != hostPsiFile; current=current.getParent()) {
    ProgressManager.checkCanceled();
    if ("EL".equals(current.getLanguage().getID()))     break;
    ParameterizedCachedValue<MultiHostRegistrarImpl,PsiElement> data=current.getUserData(INJECTED_PSI_KEY);
    MultiHostRegistrarImpl registrar;
    if (data == null) {
      registrar=InjectedPsiCachedValueProvider.doCompute(current,injectedManager,project,hostPsiFile);
      if (registrar != null) {
        ParameterizedCachedValue<MultiHostRegistrarImpl,PsiElement> cachedValue=CachedValuesManager.getManager(psiManager.getProject()).createParameterizedCachedValue(INJECTED_PSI_PROVIDER,false);
        Document hostDocument=hostPsiFile.getViewProvider().getDocument();
        CachedValueProvider.Result<MultiHostRegistrarImpl> result=CachedValueProvider.Result.create(registrar,PsiModificationTracker.MODIFICATION_COUNT,hostDocument);
        ((PsiParameterizedCachedValue<MultiHostRegistrarImpl,PsiElement>)cachedValue).setValue(result);
        current.putUserData(INJECTED_PSI_KEY,cachedValue);
      }
    }
 else {
      registrar=data.getValue(current);
    }
    if (registrar != null) {
      List<Pair<Place,PsiFile>> places=registrar.result;
      TextRange elementRange=element.getTextRange();
      for (      Pair<Place,PsiFile> pair : places) {
        Place place=pair.first;
        for (        PsiLanguageInjectionHost.Shred shred : place) {
          if (shred.host.getTextRange().intersects(elementRange)) {
            if (place.isValid())             return registrar;
          }
        }
      }
    }
    if (!probeUp)     break;
  }
  return null;
}
