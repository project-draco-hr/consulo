{
  final ProgressManager progressManager=ProgressManager.getInstance();
  final int totalFiles=scope.getFileCount();
  final Set<Module> modulesWithoutAnnotations=new HashSet<Module>();
  final Set<Module> modulesWithLL=new HashSet<Module>();
  if (!progressManager.runProcessWithProgressSynchronously(new Runnable(){
    @Override public void run(){
      scope.accept(new PsiElementVisitor(){
        private int myFileCount=0;
        final private Set<Module> processed=new HashSet<Module>();
        @Override public void visitFile(        PsiFile file){
          myFileCount++;
          final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
          if (progressIndicator != null) {
            final VirtualFile virtualFile=file.getVirtualFile();
            if (virtualFile != null) {
              progressIndicator.setText2(ProjectUtil.calcRelativeToProjectPath(virtualFile,project));
            }
            progressIndicator.setFraction(((double)myFileCount) / totalFiles);
          }
          final Module module=ModuleUtil.findModuleForPsiElement(file);
          if (module != null && !processed.contains(module)) {
            processed.add(module);
            if (JavaPsiFacade.getInstance(project).findClass(NullableNotNullManager.getInstance(project).getDefaultNullable(),GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(module)) == null) {
              modulesWithoutAnnotations.add(module);
            }
            if (PsiUtil.getLanguageLevel(file).compareTo(LanguageLevel.JDK_1_5) < 0) {
              modulesWithLL.add(module);
            }
          }
        }
      }
);
    }
  }
,"Check applicability...",true,project))   return;
  if (!modulesWithLL.isEmpty()) {
    Messages.showErrorDialog(project,"Infer Nullity Annotations requires the project language level be set to 1.5 or greater.",INFER_NULLITY_ANNOTATIONS);
    return;
  }
  if (!modulesWithoutAnnotations.isEmpty()) {
    final Library annotationsLib=LibraryUtil.findLibraryByClass(NullableNotNullManager.getInstance(project).getDefaultNullable(),project);
    if (annotationsLib != null) {
      String message="Module" + (modulesWithoutAnnotations.size() == 1 ? " " : "s ");
      message+=StringUtil.join(modulesWithoutAnnotations,new Function<Module,String>(){
        @Override public String fun(        Module module){
          return module.getName();
        }
      }
,", ");
      message+=(modulesWithoutAnnotations.size() == 1 ? " doesn't" : " don't");
      message+=" refer to the existing '" + annotationsLib.getName() + "' library with IDEA nullity annotations. Would you like to add the dependenc";
      message+=(modulesWithoutAnnotations.size() == 1 ? "y" : "ies") + " now?";
      if (Messages.showOkCancelDialog(project,message,INFER_NULLITY_ANNOTATIONS,Messages.getErrorIcon()) == DialogWrapper.OK_EXIT_CODE) {
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          @Override public void run(){
            for (            Module module : modulesWithoutAnnotations) {
              final ModifiableRootModel modifiableModel=ModuleRootManager.getInstance(module).getModifiableModel();
              modifiableModel.addLibraryEntry(annotationsLib);
              modifiableModel.commit();
            }
          }
        }
);
      }
    }
 else     if (Messages.showOkCancelDialog(project,"Infer Nullity Annotations requires that the nullity annotations" + " be available in all your project sources.\n\nYou will need to add annotations.jar as a library. " + "It is possible to configure custom jar in e.g. Constant Conditions & Exceptions inspection or use JetBrains annotations available in installation. "+ " The IDEA nullity annotations are freely usable and redistributable under the Apache 2.0 license. Would you like to do it now?",INFER_NULLITY_ANNOTATIONS,Messages.getErrorIcon()) == DialogWrapper.OK_EXIT_CODE) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          final LocateLibraryDialog dialog=new LocateLibraryDialog(modulesWithoutAnnotations.iterator().next(),PathManager.getLibPath(),"annotations.jar",QuickFixBundle.message("add.library.annotations.description"));
          dialog.show();
          if (dialog.isOK()) {
            final String path=dialog.getResultingLibraryPath();
            new WriteCommandAction(project){
              protected void run(              final Result result) throws Throwable {
                for (                Module module : modulesWithoutAnnotations) {
                  OrderEntryFix.addBundledJarToRoots(project,null,module,null,AnnotationUtil.NOT_NULL,path);
                }
              }
            }
.execute();
          }
        }
      }
);
    }
    return;
  }
  if (scope.checkScopeWritable(project))   return;
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final NullityInferrer inferrer=new NullityInferrer(myAnnotateLocalVariablesCb.isSelected(),project);
  final PsiManager psiManager=PsiManager.getInstance(project);
  if (!progressManager.runProcessWithProgressSynchronously(new Runnable(){
    @Override public void run(){
      scope.accept(new PsiElementVisitor(){
        int myFileCount=0;
        @Override public void visitFile(        final PsiFile file){
          myFileCount++;
          final VirtualFile virtualFile=file.getVirtualFile();
          final FileViewProvider viewProvider=psiManager.findViewProvider(virtualFile);
          final Document document=viewProvider == null ? null : viewProvider.getDocument();
          if (document == null || virtualFile.getFileType().isBinary())           return;
          final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
          if (progressIndicator != null) {
            if (virtualFile != null) {
              progressIndicator.setText2(ProjectUtil.calcRelativeToProjectPath(virtualFile,project));
            }
            progressIndicator.setFraction(((double)myFileCount) / totalFiles);
          }
          if (file instanceof PsiJavaFile) {
            inferrer.collect(file);
          }
        }
      }
);
    }
  }
,INFER_NULLITY_ANNOTATIONS,true,project))   return;
  final Runnable applyRunnable=new Runnable(){
    @Override public void run(){
      new WriteCommandAction(project,INFER_NULLITY_ANNOTATIONS){
        @Override protected void run(        Result result) throws Throwable {
          if (!inferrer.nothingFoundMessage(project)) {
            final SequentialModalProgressTask progressTask=new SequentialModalProgressTask(project,INFER_NULLITY_ANNOTATIONS,false);
            progressTask.setMinIterationTime(200);
            progressTask.setTask(new AnnotateTask(project,inferrer,progressTask));
            ProgressManager.getInstance().run(progressTask);
          }
        }
      }
.execute();
    }
  }
;
  SwingUtilities.invokeLater(applyRunnable);
}
