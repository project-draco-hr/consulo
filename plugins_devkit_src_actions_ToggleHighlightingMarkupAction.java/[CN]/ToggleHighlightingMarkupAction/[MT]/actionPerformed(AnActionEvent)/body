{
  final Editor editor=PlatformDataKeys.EDITOR.getData(e.getDataContext());
  PsiFile file=LangDataKeys.PSI_FILE.getData(e.getDataContext());
  if (editor == null || file == null)   return;
  final Project project=file.getProject();
  CommandProcessorEx commandProcessor=(CommandProcessorEx)CommandProcessorEx.getInstance();
  Object commandToken=commandProcessor.startCommand(project,e.getPresentation().getText(),e.getPresentation().getText(),UndoConfirmationPolicy.DEFAULT);
  AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(getClass());
  try {
    final SelectionModel selectionModel=editor.getSelectionModel();
    int[] starts=selectionModel.getBlockSelectionStarts();
    int[] ends=selectionModel.getBlockSelectionEnds();
    int startOffset=starts.length == 0 ? 0 : starts[0];
    int endOffset=ends.length == 0 ? editor.getDocument().getTextLength() : ends[ends.length - 1];
    perform(project,editor.getDocument(),startOffset,endOffset);
  }
  finally {
    token.finish();
    commandProcessor.finishCommand(project,commandToken,null);
  }
}
