{
  final Editor editor=PlatformDataKeys.EDITOR.getData(e.getDataContext());
  PsiFile file=LangDataKeys.PSI_FILE.getData(e.getDataContext());
  if (editor == null || file == null)   return;
  final Project project=file.getProject();
  CommandProcessorEx commandProcessor=(CommandProcessorEx)CommandProcessorEx.getInstance();
  Object commandToken=commandProcessor.startCommand(project,e.getPresentation().getText(),e.getPresentation().getText(),UndoConfirmationPolicy.DEFAULT);
  AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(getClass());
  try {
    perform(project,editor.getDocument());
  }
  finally {
    token.finish();
    commandProcessor.finishCommand(project,commandToken,null);
  }
}
