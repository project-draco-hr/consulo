{
  final CharSequence sequence=document.getCharsSequence();
  final StringBuilder sb=new StringBuilder();
  Pattern pattern=Pattern.compile("<(error|warning|EOLError|EOLWarning|info|weak_warning)((?:\\s|=|\\w+|\\\"(?:[^\"]|\\\\\\\")*?\\\")*?)>(.*?)</\\1>");
  Matcher matcher=pattern.matcher(sequence);
  List<TextRange> ranges=new ArrayList<TextRange>();
  if (matcher.find(startOffset)) {
    boolean compactMode=false;
    int pos;
    do {
      if (matcher.start(0) >= endOffset)       break;
      if (matcher.start(2) < matcher.end(2)) {
        if (!compactMode) {
          ranges.clear();
          compactMode=true;
        }
        ranges.add(new TextRange(matcher.start(2),matcher.end(2)));
      }
 else       if (!compactMode) {
        ranges.add(new TextRange(matcher.start(0),matcher.start(3)));
        ranges.add(new TextRange(matcher.end(3),matcher.end(0)));
      }
      pos=Math.max(matcher.end(1),matcher.end(2));
    }
 while (matcher.find(pos));
    Collections.sort(ranges,IndentsPass.RANGE_COMPARATOR);
  }
  if (!ranges.isEmpty()) {
    int pos=0;
    for (    TextRange range : ranges) {
      sb.append(sequence,pos,range.getStartOffset());
      pos=range.getEndOffset();
    }
    sb.append(sequence,pos,sequence.length());
  }
 else {
    final int[] offset=new int[]{0};
    final ArrayList<HighlightInfo> infos=new ArrayList<HighlightInfo>();
    DaemonCodeAnalyzerImpl.processHighlights(document,project,HighlightSeverity.WARNING,0,sequence.length(),new Processor<HighlightInfo>(){
      @Override public boolean process(      HighlightInfo info){
        if (info.severity != HighlightSeverity.WARNING && info.severity != HighlightSeverity.ERROR)         return true;
        if (info.getStartOffset() >= endOffset)         return false;
        if (info.getEndOffset() > startOffset) {
          offset[0]=appendInfo(info,sb,sequence,offset[0],infos,false);
        }
        return true;
      }
    }
);
    offset[0]=appendInfo(null,sb,sequence,offset[0],infos,false);
    sb.append(sequence.subSequence(offset[0],sequence.length()));
  }
  document.setText(sb);
}
