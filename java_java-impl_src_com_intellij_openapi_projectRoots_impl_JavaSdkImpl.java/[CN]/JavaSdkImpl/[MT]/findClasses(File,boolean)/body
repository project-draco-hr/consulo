{
  FileFilter jarFileFilter=new FileFilter(){
    @Override @SuppressWarnings({"HardCodedStringLiteral"}) public boolean accept(    File f){
      return !f.isDirectory() && f.getName().endsWith(".jar");
    }
  }
;
  File[] jarDirs;
  if (SystemInfo.isMac && !file.getName().startsWith("mockJDK")) {
    final File openJdkRtJar=new File(new File(new File(file,"jre"),"lib"),"rt.jar");
    if (openJdkRtJar.exists() && !openJdkRtJar.isDirectory()) {
      File libFile=new File(file,"lib");
      @NonNls File classesFile=openJdkRtJar.getParentFile();
      @NonNls File libExtFile=new File(openJdkRtJar.getParentFile(),"ext");
      @NonNls File libEndorsedFile=new File(libFile,"endorsed");
      jarDirs=new File[]{libEndorsedFile,libFile,classesFile,libExtFile};
    }
 else {
      File libFile=new File(file,"lib");
      @NonNls File classesFile=new File(file,"../Classes");
      @NonNls File libExtFile=new File(libFile,"ext");
      @NonNls File libEndorsedFile=new File(libFile,"endorsed");
      jarDirs=new File[]{libEndorsedFile,libFile,classesFile,libExtFile};
    }
  }
 else {
    @NonNls final String jre="jre";
    File jreLibFile=isJre ? new File(file,"lib") : new File(new File(file,jre),"lib");
    @NonNls File jreLibExtFile=new File(jreLibFile,"ext");
    @NonNls File jreLibEndorsedFile=new File(jreLibFile,"endorsed");
    jarDirs=new File[]{jreLibEndorsedFile,jreLibFile,jreLibExtFile};
  }
  Set<File> filter=new LinkedHashSet<File>();
  List<File> children=new ArrayList<File>();
  for (  File jarDir : jarDirs) {
    if (jarDir != null && jarDir.isDirectory()) {
      File[] jarFiles=jarDir.listFiles(jarFileFilter);
      for (      File jarFile : jarFiles) {
        final String jarFileName=jarFile.getName();
        if (jarFileName.equals("alt-rt.jar") || jarFileName.equals("alt-string.jar"))         continue;
        try {
          if (filter.add(jarFile.getCanonicalFile()))           children.add(jarFile);
        }
 catch (        IOException e) {
        }
      }
    }
  }
  ArrayList<VirtualFile> result=new ArrayList<VirtualFile>();
  for (  File child : children) {
    String url=JarFileSystem.PROTOCOL_PREFIX + FileUtil.toSystemIndependentName(child.getAbsolutePath()) + JarFileSystem.JAR_SEPARATOR;
    VirtualFile vFile=VirtualFileManager.getInstance().findFileByUrl(url);
    if (vFile != null) {
      result.add(vFile);
    }
  }
  File classesZip=new File(new File(file,"lib"),"classes.zip");
  if (classesZip.isFile()) {
    String url=JarFileSystem.PROTOCOL_PREFIX + FileUtil.toSystemIndependentName(classesZip.getAbsolutePath()) + JarFileSystem.JAR_SEPARATOR;
    VirtualFile vFile=VirtualFileManager.getInstance().findFileByUrl(url);
    if (vFile != null) {
      result.add(vFile);
    }
  }
  File classesDir=new File(file,"classes");
  if (result.isEmpty() && classesDir.isDirectory()) {
    String url=LocalFileSystem.PROTOCOL_PREFIX + FileUtil.toSystemIndependentName(classesDir.getAbsolutePath());
    VirtualFile vFile=VirtualFileManager.getInstance().findFileByUrl(url);
    if (vFile != null) {
      result.add(vFile);
    }
  }
  return VfsUtil.toVirtualFileArray(result);
}
