{
  if (!file.isWritable())   return;
  EditorUtil.fillVirtualSpaceUntil(editor,editor.getCaretModel().getLogicalPosition().column,editor.getCaretModel().getLogicalPosition().line);
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  int offset=editor.getCaretModel().getOffset();
  String prefix=getPrefix(editor.getDocument(),offset);
  int contextType=TemplateManager.getInstance(project).getContextType(file,offset);
  TemplateImpl[] templates=TemplateSettings.getInstance().getTemplates();
  ArrayList<LookupItem> array=new ArrayList<LookupItem>();
  for (  TemplateImpl template : templates) {
    if (template.isDeactivated() || template.isSelectionTemplate())     continue;
    String key=template.getKey();
    if (key.startsWith(prefix) && template.getTemplateContext().isInContext(contextType)) {
      LookupItem item=new LookupItem(template,key);
      array.add(item);
    }
  }
  LookupItem[] items=array.toArray(new LookupItem[array.size()]);
  if (items.length == 0) {
    String text=prefix.length() == 0 ? "No templates defined in this context" : "No templates starting with '" + prefix + "' defined in this context";
    HintManager.getInstance().showErrorHint(editor,text);
    return;
  }
  Lookup lookup=LookupManager.getInstance(project).showLookup(editor,items,prefix,null,new CharFilter(){
    public int accept(    char c){
      if (isInPrefix(c))       return CharFilter.ADD_TO_PREFIX;
      return CharFilter.SELECT_ITEM_AND_FINISH_LOOKUP;
    }
  }
);
  lookup.addLookupListener(new LookupAdapter(){
    public void itemSelected(    LookupEvent event){
      TemplateManager.getInstance(project).startTemplate(editor,'\0');
    }
  }
);
}
