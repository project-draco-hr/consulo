{
  Editor editorToApply=null;
  PsiFile fileToApply=null;
  int offset=hostEditor.getCaretModel().getOffset();
  PsiFile injectedFile=InjectedLanguageUtil.findInjectedPsiNoCommit(hostFile,offset);
  if (injectedFile != null) {
    Editor injectedEditor=InjectedLanguageUtil.getInjectedEditorForInjectedFile(hostEditor,injectedFile);
    if (predicate.process(injectedFile,injectedEditor)) {
      editorToApply=injectedEditor;
      fileToApply=injectedFile;
    }
  }
  if (editorToApply == null && predicate.process(hostFile,hostEditor)) {
    editorToApply=hostEditor;
    fileToApply=hostFile;
  }
  if (editorToApply == null)   return null;
  return Pair.create(fileToApply,editorToApply);
}
