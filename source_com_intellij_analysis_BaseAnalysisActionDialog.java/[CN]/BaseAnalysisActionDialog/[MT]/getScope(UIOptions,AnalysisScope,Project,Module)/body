{
  if (isProjectScopeSelected()) {
    scope=new AnalysisScope(project);
    uiOptions.SCOPE_TYPE=AnalysisScope.PROJECT;
  }
 else {
    final SearchScope customScope=getCustomScope();
    if (customScope != null) {
      scope=new AnalysisScope(customScope,project);
      uiOptions.SCOPE_TYPE=AnalysisScope.CUSTOM;
      uiOptions.CUSTOM_SCOPE_NAME=customScope.getDisplayName();
    }
 else     if (isModuleScopeSelected()) {
      scope=new AnalysisScope(module);
      uiOptions.SCOPE_TYPE=AnalysisScope.MODULE;
    }
 else     if (isUncommitedFilesSelected()) {
      scope=new AnalysisScope(project,new HashSet<VirtualFile>(ChangeListManager.getInstance(project).getAffectedFiles()));
      uiOptions.SCOPE_TYPE=AnalysisScope.UNCOMMITED_FILES;
    }
 else {
      uiOptions.SCOPE_TYPE=AnalysisScope.FILE;
    }
  }
  uiOptions.ANALYZE_TEST_SOURCES=isInspectTestSources();
  scope.setIncludeTestSource(isInspectTestSources());
  return scope;
}
