{
  final JTextField editor=search.getTextEditor();
  editor.getDocument().addDocumentListener(new DocumentAdapter(){
    @Override protected void textChanged(    DocumentEvent e){
      final String pattern=editor.getText();
      if (editor.hasFocus()) {
        rebuildList(pattern);
      }
    }
  }
);
  editor.addFocusListener(new FocusAdapter(){
    @Override public void focusGained(    FocusEvent e){
      if (mySkipFocusGain) {
        mySkipFocusGain=false;
        return;
      }
      search.setText("");
      search.getTextEditor().setForeground(UIUtil.getLabelForeground());
      editor.setColumns(SEARCH_FIELD_COLUMNS);
      myFocusComponent=e.getOppositeComponent();
      SwingUtilities.invokeLater(new Runnable(){
        @Override public void run(){
          final JComponent parent=(JComponent)editor.getParent();
          parent.revalidate();
          parent.repaint();
        }
      }
);
      rebuildList("");
    }
    @Override public void focusLost(    FocusEvent e){
      if (myPopup instanceof AbstractPopup && myPopup.isVisible() && ((myList == e.getOppositeComponent()) || ((AbstractPopup)myPopup).getPopupWindow() == e.getOppositeComponent())) {
        return;
      }
      if (myNonProjectCheckBox == e.getOppositeComponent()) {
        mySkipFocusGain=true;
        editor.requestFocus();
        return;
      }
      onFocusLost();
    }
  }
);
}
