{
  Component cmp;
  PsiElement file;
  myLocationString=null;
  String pattern="*" + myPopupField.getText();
  Matcher matcher=NameUtil.buildMatcher(pattern,0,true,true,pattern.toLowerCase().equals(pattern));
  if (isMoreItem(index)) {
    cmp=More.get(isSelected);
  }
 else   if (value instanceof VirtualFile && myProject != null && ((((VirtualFile)value).isDirectory() && (file=PsiManager.getInstance(myProject).findDirectory((VirtualFile)value)) != null) || (file=PsiManager.getInstance(myProject).findFile((VirtualFile)value)) != null)) {
    myFileRenderer.setPatternMatcher(matcher);
    cmp=myFileRenderer.getListCellRendererComponent(list,file,index,isSelected,cellHasFocus);
  }
 else   if (value instanceof PsiElement) {
    myFileRenderer.setPatternMatcher(matcher);
    cmp=myFileRenderer.getListCellRendererComponent(list,value,index,isSelected,isSelected);
  }
 else {
    cmp=super.getListCellRendererComponent(list,value,index,isSelected,isSelected);
    final JPanel p=new JPanel(new BorderLayout());
    p.setBackground(UIUtil.getListBackground(isSelected));
    p.add(cmp,BorderLayout.CENTER);
    cmp=p;
  }
  if (myLocationString != null || value instanceof BooleanOptionDescription) {
    final JPanel panel=new JPanel(new BorderLayout());
    panel.setBackground(UIUtil.getListBackground(isSelected));
    panel.add(cmp,BorderLayout.CENTER);
    final Component rightComponent;
    if (value instanceof BooleanOptionDescription) {
      final OnOffButton button=new OnOffButton();
      button.setSelected(((BooleanOptionDescription)value).isOptionEnabled());
      rightComponent=button;
    }
 else {
      rightComponent=myLocation.getListCellRendererComponent(list,value,index,isSelected,isSelected);
    }
    panel.add(rightComponent,BorderLayout.EAST);
    cmp=panel;
  }
  Color bg=cmp.getBackground();
  if (bg == null) {
    cmp.setBackground(UIUtil.getListBackground(isSelected));
    bg=cmp.getBackground();
  }
  myMainPanel.setBorder(new CustomLineBorder(bg,0,0,2,0));
  String title=getModel().titleIndex.getTitle(index);
  myMainPanel.removeAll();
  if (title != null) {
    myTitle.setText(title);
    myMainPanel.add(createTitle(" " + title),BorderLayout.NORTH);
  }
  myMainPanel.add(cmp,BorderLayout.CENTER);
  final int width=myMainPanel.getPreferredSize().width;
  if (width > myPopupActualWidth) {
    myPopupActualWidth=width;
  }
  return myMainPanel;
}
