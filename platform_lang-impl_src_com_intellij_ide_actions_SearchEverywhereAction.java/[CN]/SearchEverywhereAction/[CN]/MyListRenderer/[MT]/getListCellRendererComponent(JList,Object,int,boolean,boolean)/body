{
  Component cmp;
  PsiFile file=null;
  myLocationString=null;
  if (isMoreItem(index)) {
    cmp=More.get(isSelected);
  }
 else   if (value instanceof VirtualFile && myProject != null && (((VirtualFile)value).isDirectory() || (file=PsiManager.getInstance(myProject).findFile((VirtualFile)value)) != null)) {
    cmp=new GotoFileCellRenderer(Math.min(800,list.getWidth())).getListCellRendererComponent(list,file == null ? value : file,index,isSelected,cellHasFocus);
  }
 else   if (value instanceof PsiElement) {
    cmp=myPsiRenderer.getListCellRendererComponent(list,value,index,isSelected,cellHasFocus);
  }
 else {
    cmp=super.getListCellRendererComponent(list,value,index,isSelected,cellHasFocus);
    final JPanel p=new JPanel(new BorderLayout());
    p.setBackground(UIUtil.getListBackground(isSelected));
    p.add(cmp,BorderLayout.CENTER);
    cmp=p;
  }
  if (myLocationString != null || value instanceof BooleanOptionDescription) {
    final JPanel panel=new JPanel(new BorderLayout());
    panel.setBackground(UIUtil.getListBackground(isSelected));
    panel.add(cmp,BorderLayout.CENTER);
    final Component rightComponent;
    if (value instanceof BooleanOptionDescription) {
      final OnOffButton button=new OnOffButton();
      button.setSelected(((BooleanOptionDescription)value).isOptionEnabled());
      rightComponent=button;
    }
 else {
      rightComponent=myLocation.getListCellRendererComponent(list,value,index,isSelected,cellHasFocus);
    }
    panel.add(rightComponent,BorderLayout.EAST);
    cmp=panel;
  }
  Color bg=cmp.getBackground();
  cmp.setBackground(UIUtil.getListBackground(isSelected));
  if (bg == null) {
    bg=cmp.getBackground();
  }
  myMainPanel.setBorder(new CustomLineBorder(bg,0,0,2,0));
  String title=myTitleIndexes.getTitle(index);
  myMainPanel.removeAll();
  if (title != null) {
    myTitle.setText(title);
    myMainPanel.add(createTitle(" " + title),BorderLayout.NORTH);
  }
  myMainPanel.add(cmp,BorderLayout.CENTER);
  final int width=myMainPanel.getPreferredSize().width;
  if (width > myPopupActualWidth) {
    myPopupActualWidth=width;
    schedulePopupUpdate();
  }
  return myMainPanel;
}
