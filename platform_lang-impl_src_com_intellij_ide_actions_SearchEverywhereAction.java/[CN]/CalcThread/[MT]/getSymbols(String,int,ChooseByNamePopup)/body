{
  final SearchResult symbols=new SearchResult();
  if (!Registry.is("search.everywhere.symbols")) {
    return symbols;
  }
  final GlobalSearchScope scope=GlobalSearchScope.projectScope(project);
  if (chooseByNamePopup == null)   return symbols;
  final ChooseByNameItemProvider provider=chooseByNamePopup.getProvider();
  provider.filterElements(chooseByNamePopup,pattern,false,myProgressIndicator,new Processor<Object>(){
    @Override public boolean process(    Object o){
      if (o instanceof PsiElement && !(((PsiElement)o).getParent() instanceof PsiFile)) {
        final PsiElement element=(PsiElement)o;
        final PsiFile file=element.getContainingFile();
        if (!myListModel.contains(o) && (file == null || (file.getVirtualFile() != null && scope.accept(file.getVirtualFile())))) {
          symbols.add(o);
        }
      }
      symbols.needMore=symbols.size() == max;
      return !symbols.needMore;
    }
  }
);
  return symbols;
}
