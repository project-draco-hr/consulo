{
  if (myPopup == null || !myPopup.isVisible()) {
    return;
  }
  final Container parent=getField().getParent();
  final Dimension size=myList.getParent().getParent().getPreferredSize();
  size.width=myPopupActualWidth - 2;
  if (size.width + 2 < parent.getWidth()) {
    size.width=parent.getWidth();
  }
  if (myList.getItemsCount() == 0) {
    size.height=30;
  }
  Dimension sz=new Dimension(size.width,myList.getPreferredSize().height);
  if (sz.width > POPUP_MAX_WIDTH || sz.height > POPUP_MAX_WIDTH) {
    final JBScrollPane pane=new JBScrollPane();
    final int extraWidth=pane.getVerticalScrollBar().getWidth() + 1;
    final int extraHeight=pane.getHorizontalScrollBar().getHeight() + 1;
    sz=new Dimension(Math.min(POPUP_MAX_WIDTH,Math.max(getField().getWidth(),sz.width + extraWidth)),Math.min(POPUP_MAX_WIDTH,sz.height + extraHeight));
    sz.width+=20;
    sz.height+=2;
  }
 else {
    sz.width+=2;
    sz.height+=2;
  }
  sz.width=Math.max(sz.width,myPopup.getSize().width);
  myPopup.setSize(sz);
  if (myActionEvent != null && myActionEvent.getInputEvent() == null) {
    final Point p=parent.getLocationOnScreen();
    p.y+=parent.getHeight();
    if (parent.getWidth() < sz.width) {
      p.x-=sz.width - parent.getWidth();
    }
    myPopup.setLocation(p);
  }
 else {
    try {
      adjustPopup();
    }
 catch (    Exception ignore) {
    }
  }
}
