{
  try {
    final FilePathImpl filePath=new FilePathImpl(fileToPatch);
    final CurrentContentRevision currentRevision=new CurrentContentRevision(filePath);
    final Document doc=FileDocumentManager.getInstance().getDocument(fileToPatch);
    String baseContent=doc.getText();
    StringBuilder newText=new StringBuilder();
    patch.applyModifications(baseContent,newText);
    ContentRevision revision=new SimpleContentRevision(newText.toString(),(newFilePath == null) ? filePath : newFilePath,patch.getAfterVersionId());
    return new Change(currentRevision,revision);
  }
 catch (  ApplyPatchException e) {
    ApplyPatchContext context=new ApplyPatchContext(getBaseDirectory(),0,false,false);
    ApplyPatchAction.mergeAgainstBaseVersion(myProject,fileToPatch,context,patch,ApplyPatchAction.ApplyPatchMergeRequestFactory.INSTANCE_READ_ONLY);
    return null;
  }
}
