{
  if (targetClass.isInterface()) {
    final PsiCodeBlock body=result.getBody();
    if (body != null)     body.delete();
  }
  FileType fileType=FileTypeManager.getInstance().getFileTypeByExtension(template.getExtension());
  PsiType returnType=result.getReturnType();
  if (returnType == null) {
    returnType=PsiType.VOID;
  }
  Properties properties=FileTemplateManager.getInstance().getDefaultProperties(targetClass.getProject());
  properties.setProperty(FileTemplate.ATTRIBUTE_RETURN_TYPE,returnType.getPresentableText());
  properties.setProperty(FileTemplate.ATTRIBUTE_DEFAULT_RETURN_VALUE,PsiTypesUtil.getDefaultValueOfType(returnType));
  properties.setProperty(FileTemplate.ATTRIBUTE_CALL_SUPER,callSuper(originalMethod,result));
  JavaTemplateUtil.setClassAndMethodNameProperties(properties,targetClass,result);
  JVMElementFactory factory=JVMElementFactories.getFactory(targetClass.getLanguage(),originalMethod.getProject());
  if (factory == null)   factory=JavaPsiFacade.getInstance(originalMethod.getProject()).getElementFactory();
  @NonNls String methodText;
  try {
    methodText="void foo () {\n" + template.getText(properties) + "\n}";
    methodText=FileTemplateUtil.indent(methodText,result.getProject(),fileType);
  }
 catch (  Exception e) {
    throw new IncorrectOperationException("Failed to parse file template",e);
  }
  if (methodText != null) {
    PsiMethod m;
    try {
      m=factory.createMethodFromText(methodText,originalMethod);
    }
 catch (    IncorrectOperationException e) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          Messages.showErrorDialog(CodeInsightBundle.message("override.implement.broken.file.template.message"),CodeInsightBundle.message("override.implement.broken.file.template.title"));
        }
      }
);
      return;
    }
    PsiCodeBlock oldBody=result.getBody();
    if (oldBody != null) {
      oldBody.replace(m.getBody());
    }
  }
}
