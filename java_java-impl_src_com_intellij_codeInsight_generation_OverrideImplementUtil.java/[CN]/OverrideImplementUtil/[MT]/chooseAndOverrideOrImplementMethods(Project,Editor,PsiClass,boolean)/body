{
  LOG.assertTrue(aClass.isValid());
  ApplicationManager.getApplication().assertReadAccessAllowed();
  Collection<CandidateInfo> candidates=getMethodsToOverrideImplement(aClass,toImplement);
  Collection<CandidateInfo> secondary=toImplement ? Collections.<CandidateInfo>emptyList() : getMethodsToOverrideImplement(aClass,true);
  if (candidates.isEmpty() && secondary.isEmpty())   return;
  final PsiMethodMember[] onlyPrimary=convertToMethodMembers(candidates);
  final PsiMethodMember[] all=ArrayUtil.mergeArrays(onlyPrimary,convertToMethodMembers(secondary),PsiMethodMember.class);
  final String toMerge=PropertiesComponent.getInstance(project).getValue(PROP_COMBINED_OVERRIDE_IMPLEMENT);
  final Ref<Boolean> merge=Ref.create(!"false".equals(toMerge));
  final boolean isAll=merge.get().booleanValue();
  final MemberChooser<PsiMethodMember> chooser=new MemberChooser<PsiMethodMember>(isAll ? all : onlyPrimary,false,true,project,PsiUtil.isLanguageLevel5OrHigher(aClass)){
    @Override protected void fillToolbarActions(    DefaultActionGroup group){
      super.fillToolbarActions(group);
      if (toImplement)       return;
      final ToggleAction mergeAction=new ToggleAction("Show methods to implement","Show methods to implement",IconLoader.findIcon("/general/show_to_implement.png")){
        @Override public boolean isSelected(        AnActionEvent e){
          return merge.get().booleanValue();
        }
        @Override public void setSelected(        AnActionEvent e,        boolean state){
          merge.set(state);
          resetElements(state ? all : onlyPrimary);
          setTitle(getChooserTitle(false,merge));
        }
      }
;
      mergeAction.registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke(KeyEvent.VK_I,InputEvent.ALT_MASK)),myTree);
      group.add(mergeAction);
    }
  }
;
  chooser.setTitle(getChooserTitle(toImplement,merge));
  registerHandlerForComplementaryAction(project,editor,aClass,toImplement,chooser);
  chooser.setCopyJavadocVisible(true);
  if (toImplement) {
    chooser.selectElements(isAll ? all : onlyPrimary);
  }
  chooser.show();
  if (chooser.getExitCode() != DialogWrapper.OK_EXIT_CODE)   return;
  PropertiesComponent.getInstance(project).setValue(PROP_COMBINED_OVERRIDE_IMPLEMENT,merge.get().toString());
  final List<PsiMethodMember> selectedElements=chooser.getSelectedElements();
  if (selectedElements == null || selectedElements.isEmpty())   return;
  new WriteCommandAction(project,aClass.getContainingFile()){
    protected void run(    final Result result) throws Throwable {
      overrideOrImplementMethodsInRightPlace(editor,aClass,selectedElements,chooser.isCopyJavadoc(),chooser.isInsertOverrideAnnotation());
    }
  }
.execute();
}
