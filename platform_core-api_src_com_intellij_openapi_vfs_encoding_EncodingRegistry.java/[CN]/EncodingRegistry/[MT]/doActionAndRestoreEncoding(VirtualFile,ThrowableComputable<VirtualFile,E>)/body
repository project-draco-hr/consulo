{
  EncodingRegistry registry=getInstance();
  Charset charsetBefore=registry.getEncoding(fileBefore,true);
  VirtualFile fileAfter=null;
  try {
    fileAfter=action.compute();
    return fileAfter;
  }
  finally {
    if (fileAfter != null) {
      Charset actual=registry.getEncoding(fileAfter,true);
      if (!Comparing.equal(actual,charsetBefore)) {
        registry.setEncoding(fileAfter,charsetBefore);
      }
    }
  }
}
