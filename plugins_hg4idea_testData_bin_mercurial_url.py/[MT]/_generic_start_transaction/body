def _generic_start_transaction(handler, h, req):
    if (hasattr(req, '_tunnel_host') and req._tunnel_host):
        tunnel_host = req._tunnel_host
        if (tunnel_host[:7] not in ['http://', 'https:/']):
            tunnel_host = ('https://' + tunnel_host)
        new_tunnel = True
    else:
        tunnel_host = req.get_selector()
        new_tunnel = False
    if (new_tunnel or (tunnel_host == req.get_full_url())):
        urlparts = urlparse.urlparse(tunnel_host)
        if (new_tunnel or (urlparts[0] == 'https')):
            realhostport = urlparts[1]
            if ((realhostport[(-1)] == ']') or (':' not in realhostport)):
                realhostport += ':443'
            h.realhostport = realhostport
            h.headers = req.headers.copy()
            h.headers.update(handler.parent.addheaders)
            return
    h.realhostport = None
    h.headers = None
