{
  PsiClassType.ClassResolveResult resolveResult=null;
  if (target instanceof PsiField) {
    resolveResult=PsiUtil.resolveGenericsClassInType(((PsiField)target).getType());
  }
 else   if (target instanceof PsiMethod) {
    resolveResult=PsiUtil.resolveGenericsClassInType(((PsiMethod)target).getReturnType());
  }
  if (resolveResult == null || resolveResult.getElement() == null)   return null;
  PsiClass targetClass=resolveResult.getElement();
  PsiSubstitutor substitutor=resolveResult.getSubstitutor();
  int offset=editor.getCaretModel().getOffset();
  PsiElement element=file.findElementAt(offset);
  if (element == null)   return null;
  PsiClass aClass=PsiTreeUtil.getParentOfType(element,PsiClass.class);
  if (aClass == null)   return null;
  List<CandidateInfo> methodInstances=new ArrayList<CandidateInfo>();
  final PsiMethod[] allMethods=targetClass.getAllMethods();
  final Set<MethodSignature> signatures=new HashSet<MethodSignature>();
  Map<PsiClass,PsiSubstitutor> superSubstitutors=new HashMap<PsiClass,PsiSubstitutor>();
  PsiManager manager=targetClass.getManager();
  for (  PsiMethod method : allMethods) {
    final PsiClass superClass=method.getContainingClass();
    if (superClass.getQualifiedName().equals("java.lang.Object"))     continue;
    if (method.isConstructor())     continue;
    PsiSubstitutor superSubstitutor=superSubstitutors.get(superClass);
    if (superSubstitutor == null) {
      superSubstitutor=TypeConversionUtil.getSuperClassSubstitutor(superClass,targetClass,substitutor);
      superSubstitutors.put(superClass,superSubstitutor);
    }
    PsiSubstitutor methodSubstitutor=GenerateMembersUtil.correctSubstitutor(method,superSubstitutor);
    MethodSignature signature=method.getSignature(methodSubstitutor);
    if (!signatures.contains(signature)) {
      signatures.add(signature);
      if (manager.getResolveHelper().isAccessible(method,target,aClass)) {
        methodInstances.add(new CandidateInfo(method,methodSubstitutor));
      }
    }
  }
  CandidateInfo[] result;
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    MemberChooser chooser=new MemberChooser(methodInstances.toArray(new Object[methodInstances.size()]),false,true,project);
    chooser.setTitle(CodeInsightBundle.message("generate.delegate.method.chooser.title"));
    chooser.setCopyJavadocVisible(false);
    chooser.show();
    if (chooser.getExitCode() != MemberChooser.OK_EXIT_CODE)     return null;
    final Object[] selectedElements=chooser.getSelectedElements();
    result=new CandidateInfo[selectedElements.length];
    System.arraycopy(selectedElements,0,result,0,selectedElements.length);
  }
 else {
    result=new CandidateInfo[]{methodInstances.get(0)};
  }
  return result;
}
