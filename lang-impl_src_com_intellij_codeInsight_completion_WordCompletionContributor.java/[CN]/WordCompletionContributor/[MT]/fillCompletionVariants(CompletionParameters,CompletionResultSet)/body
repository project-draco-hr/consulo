{
  if (parameters.getCompletionType() != CompletionType.BASIC)   return;
  final PsiFile file=parameters.getOriginalFile();
  final int startOffset=parameters.getOffset();
  final PsiElement element=ApplicationManager.getApplication().runReadAction(new Computable<PsiElement>(){
    public PsiElement compute(){
      return file.findElementAt(startOffset - 1);
    }
  }
);
  final PsiElement insertedElement=parameters.getPosition();
  final CompletionData data=CompletionUtil.getCompletionDataByElement(file);
  if (!(data instanceof SyntaxTableCompletionData)) {
    Set<CompletionVariant> toAdd=new HashSet<CompletionVariant>();
    data.addKeywordVariants(toAdd,insertedElement,file);
    for (    CompletionVariant completionVariant : toAdd) {
      if (completionVariant.hasKeywordCompletions()) {
        return;
      }
    }
  }
  final PsiReference reference=ApplicationManager.getApplication().runReadAction(new Computable<PsiReference>(){
    public PsiReference compute(){
      return file.findReferenceAt(startOffset);
    }
  }
);
  if (reference == null) {
    ASTNode textContainer=element != null ? element.getNode() : null;
    while (textContainer != null) {
      final IElementType elementType=textContainer.getElementType();
      if (LanguageWordCompletion.INSTANCE.isEnabledIn(elementType) || elementType == PlainTextTokenTypes.PLAIN_TEXT) {
        final CompletionResultSet javaResultSet=result.withPrefixMatcher(CompletionUtil.findJavaIdentifierPrefix(insertedElement,startOffset));
        final CompletionResultSet plainResultSet=result.withPrefixMatcher(CompletionUtil.findIdentifierPrefix(insertedElement,startOffset,character().javaIdentifierPart().andNot(character().equalTo('$')),character().javaIdentifierStart()));
        for (        final String word : AllWordsGetter.getAllWords(insertedElement,startOffset)) {
          final LookupItem<String> item=new LookupItem<String>(word,word).setTailType(TailType.SPACE);
          javaResultSet.addElement(item);
          plainResultSet.addElement(item);
        }
      }
      textContainer=textContainer.getTreeParent();
    }
  }
}
