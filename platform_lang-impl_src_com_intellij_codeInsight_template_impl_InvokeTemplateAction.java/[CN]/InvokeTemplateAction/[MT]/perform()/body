{
  final Document document=myEditor.getDocument();
  final VirtualFile file=FileDocumentManager.getInstance().getFile(document);
  if (file != null) {
    ReadonlyStatusHandler.getInstance(myProject).ensureFilesWritable(file);
  }
  if (myEditor.getSelectionModel().hasSelection() && myTemplate.isToReformat()) {
    int offset=myEditor.getSelectionModel().getSelectionStart();
    int selectionEnd=myEditor.getSelectionModel().getSelectionEnd();
    int lineEnd=document.getLineEndOffset(document.getLineNumber(offset));
    while (offset < lineEnd && offset < selectionEnd && (document.getCharsSequence().charAt(offset) == ' ' || document.getCharsSequence().charAt(offset) == '\t')) {
      offset++;
    }
    if (selectionEnd == document.getLineStartOffset(document.getLineNumber(selectionEnd))) {
      selectionEnd--;
    }
    if (offset < lineEnd && offset < selectionEnd) {
      myEditor.getSelectionModel().setSelection(offset,selectionEnd);
    }
  }
  String selectionString=myEditor.getSelectionModel().getSelectedText();
  TemplateManager.getInstance(myProject).startTemplate(myEditor,selectionString,myTemplate);
}
