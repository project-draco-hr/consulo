{
  context.setAddCompletionChar(false);
  final Editor editor=context.getEditor();
  final char completionChar=context.getCompletionChar();
  TailType tailType=getTailType(item,editor,completionChar);
  final Document document=editor.getDocument();
  final PsiFile file=context.getFile();
  final LookupElement[] allItems=context.getElements();
  boolean signatureSelected=allItems.length > 1 && CodeInsightSettings.getInstance().SHOW_SIGNATURES_IN_LOOKUPS || item.getUserData(LookupItem.FORCE_SHOW_SIGNATURE_ATTR) != null;
  int offset=editor.getCaretModel().getOffset();
  final boolean needLeftParenth=isToInsertParenth(file.findElementAt(context.getStartOffset()));
  final boolean hasParams=MethodParenthesesHandler.hasParams(item,allItems,!signatureSelected,myMethod);
  if (needLeftParenth) {
    final CodeStyleSettings styleSettings=CodeStyleSettingsManager.getSettings(context.getProject());
    new MethodParenthesesHandler(myMethod,!signatureSelected,styleSettings.SPACE_BEFORE_METHOD_CALL_PARENTHESES,styleSettings.SPACE_WITHIN_METHOD_CALL_PARENTHESES && hasParams,shouldInsertRightParenthesis(hasParams,tailType)).handleInsert(context,item);
  }
  insertExplicitTypeParams(item,document,offset,file);
  final PsiType type=myMethod.getReturnType();
  if (completionChar == '!' && type != null && PsiType.BOOLEAN.isAssignableFrom(type)) {
    PsiDocumentManager.getInstance(myMethod.getProject()).commitDocument(document);
    final PsiMethodCallExpression methodCall=PsiTreeUtil.findElementOfClassAtOffset(file,offset,PsiMethodCallExpression.class,false);
    if (methodCall != null) {
      FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EXCLAMATION_FINISH);
      document.insertString(methodCall.getTextRange().getStartOffset(),"!");
    }
  }
  if (needLeftParenth && hasParams) {
    AutoPopupController.getInstance(myMethod.getProject()).autoPopupParameterInfo(editor,signatureSelected ? myMethod : null);
  }
  tailType.processTail(editor,context.getTailOffset());
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
}
