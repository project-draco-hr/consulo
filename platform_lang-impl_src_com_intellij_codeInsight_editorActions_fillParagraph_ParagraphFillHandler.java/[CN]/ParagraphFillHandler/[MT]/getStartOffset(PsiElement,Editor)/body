{
  if (element instanceof PsiComment) {
    final PsiElement firstCommentElement=getFirstCommentElement(element);
    return firstCommentElement != null ? firstCommentElement.getTextRange().getStartOffset() : element.getTextRange().getStartOffset();
  }
  final int offset=editor.getCaretModel().getOffset();
  final int elementTextOffset=element.getTextOffset();
  final Document document=editor.getDocument();
  int lineNumber=document.getLineNumber(offset);
  while (lineNumber != document.getLineNumber(elementTextOffset)) {
    final String text=document.getText(TextRange.create(document.getLineStartOffset(lineNumber),document.getLineEndOffset(lineNumber)));
    if (StringUtil.isEmptyOrSpaces(text)) {
      break;
    }
    lineNumber-=1;
  }
  final int lineStartOffset=document.getLineStartOffset(lineNumber + 1);
  final String lineText=document.getText(TextRange.create(lineStartOffset,document.getLineEndOffset(lineNumber + 1)));
  int shift=StringUtil.findFirst(lineText,CharFilter.NOT_WHITESPACE_FILTER);
  return lineStartOffset + shift;
}
