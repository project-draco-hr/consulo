{
  final Document document=editor.getDocument();
  final TextRange textRange=getTextRange(element,editor);
  if (textRange.isEmpty())   return;
  final String text=textRange.substring(element.getContainingFile().getText());
  final List<String> subStrings=StringUtil.split(text,"\n",true);
  final String prefix=getPrefix(element);
  final String postfix=getPostfix(element);
  final StringBuilder stringBuilder=new StringBuilder();
  appendPrefix(element,text,stringBuilder);
  for (  String string : subStrings) {
    final String startTrimmed=StringUtil.trimStart(string.trim(),prefix.trim());
    final String str=StringUtil.trimEnd(startTrimmed,postfix.trim());
    stringBuilder.append(str.trim()).append(" ");
  }
  appendPostfix(element,text,stringBuilder);
  final String replacementText=stringBuilder.toString();
  CommandProcessor.getInstance().executeCommand(element.getProject(),new Runnable(){
    public void run(){
      document.replaceString(textRange.getStartOffset(),textRange.getEndOffset(),replacementText);
      final CodeFormatterFacade codeFormatter=new CodeFormatterFacade(CodeStyleSettingsManager.getSettings(element.getProject()));
      codeFormatter.doWrapLongLinesIfNecessary(editor,element.getProject(),document,textRange.getStartOffset(),textRange.getStartOffset() + replacementText.length() + 1);
    }
  }
,null,document);
}
