{
  ArrayList<LookupItem> array=new ArrayList<LookupItem>();
  for (  TemplateImpl template : matchingTemplates) {
    array.add(new LookupItem(template,template.getKey()));
  }
  LookupElement[] items=array.toArray(new LookupElement[array.size()]);
  final LookupImpl lookup=(LookupImpl)LookupManager.getInstance(project).createLookup(editor,items,prefix,LookupArranger.DEFAULT);
  lookup.addLookupListener(new LookupAdapter(){
    public void itemSelected(    LookupEvent event){
      final LookupElement lookupElement=event.getItem();
      if (lookupElement != null) {
        final TemplateImpl template=(TemplateImpl)lookupElement.getObject();
        new WriteCommandAction(project){
          protected void run(          Result result) throws Throwable {
            ((TemplateManagerImpl)TemplateManager.getInstance(project)).startTemplateWithPrefix(editor,template,null);
          }
        }
.execute();
      }
    }
  }
);
  lookup.show();
}
