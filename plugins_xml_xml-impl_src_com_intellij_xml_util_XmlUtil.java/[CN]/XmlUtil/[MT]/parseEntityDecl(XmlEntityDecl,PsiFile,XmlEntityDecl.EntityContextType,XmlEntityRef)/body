{
synchronized (PsiLock.LOCK) {
    CachedValue<PsiElement> value=entityRef.getUserData(PARSED_DECL_KEY);
    if (value == null) {
      value=CachedValuesManager.getManager(entityDecl.getProject()).createCachedValue(new CachedValueProvider<PsiElement>(){
        public Result<PsiElement> compute(){
          final PsiElement res=entityDecl.parse(targetFile,type,entityRef);
          if (res == null)           return new Result<PsiElement>(res,targetFile);
          if (!entityDecl.isInternalReference())           XmlEntityRefImpl.copyEntityCaches(res.getContainingFile(),targetFile);
          return new Result<PsiElement>(res,res.getUserData(XmlElement.DEPENDING_ELEMENT),entityDecl,targetFile,entityRef);
        }
      }
,false);
      entityRef.putUserData(PARSED_DECL_KEY,value);
    }
    return value.getValue();
  }
}
