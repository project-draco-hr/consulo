{
  final PsiElement[] children=tag.getChildren();
  String name=tag.getName();
  boolean insideEndTag=false;
  XmlToken startTagNameToken=null;
  ProgressManager progressManager=ProgressManager.getInstance();
  for (  PsiElement child : children) {
    progressManager.checkCanceled();
    if (child instanceof XmlToken) {
      final XmlToken xmlToken=(XmlToken)child;
      if (xmlToken.getTokenType() == XmlTokenType.XML_EMPTY_ELEMENT_END) {
        return;
      }
      if (xmlToken.getTokenType() == XmlTokenType.XML_END_TAG_START) {
        insideEndTag=true;
      }
      if (xmlToken.getTokenType() == XmlTokenType.XML_NAME) {
        if (insideEndTag) {
          String text=xmlToken.getText();
          if (tag instanceof HtmlTag) {
            text=text.toLowerCase();
            name=name.toLowerCase();
          }
          boolean isExtraHtmlTagEnd=false;
          if (text.equals(name)) {
            isExtraHtmlTagEnd=tag instanceof HtmlTag && HtmlUtil.isSingleHtmlTag(name);
            if (!isExtraHtmlTagEnd) {
              return;
            }
          }
          markClosingTag(xmlToken,startTagNameToken,tag,isExtraHtmlTagEnd,holder);
          return;
        }
 else {
          startTagNameToken=xmlToken;
        }
      }
    }
  }
}
