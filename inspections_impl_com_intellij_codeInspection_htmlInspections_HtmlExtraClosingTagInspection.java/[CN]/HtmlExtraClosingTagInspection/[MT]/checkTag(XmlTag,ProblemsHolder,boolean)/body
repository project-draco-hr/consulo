{
  ProgressManager progressManager=ProgressManager.getInstance();
  final String name=tag.getName();
  final boolean htmlTag=tag instanceof HtmlTag;
  final String tagName=htmlTag ? name.toLowerCase() : name;
  boolean matchesNothing=false;
  final PsiElement[] children=tag.getChildren();
  for (int i=children.length - 1; i >= 0; i--) {
    progressManager.checkCanceled();
    final PsiElement child=children[i];
    if (child instanceof XmlToken) {
      final XmlToken token=(XmlToken)child;
      final IElementType type=token.getTokenType();
      if (XmlTokenType.XML_NAME == type) {
        if (isEndTagName(token)) {
          final String tokenName=htmlTag ? token.getText().toLowerCase() : token.getText();
          if (tagName.equals(tokenName)) {
            matchesNothing=true;
            if (htmlTag && HtmlUtil.isSingleHtmlTag(name)) {
              markClosingTag(token,tag,matchesNothing,holder,tag);
            }
          }
 else {
            markClosingTag(token,tag,matchesNothing,holder,tag);
          }
        }
      }
    }
 else     if (child instanceof PsiErrorElement) {
      final PsiElement[] errorChildren=child.getChildren();
      boolean insideEndTag=false;
      for (      final PsiElement each : errorChildren) {
        if (each instanceof XmlToken) {
          final XmlToken token=(XmlToken)each;
          if (token.getTokenType() == XmlTokenType.XML_END_TAG_START) {
            insideEndTag=true;
            continue;
          }
          if (insideEndTag && token.getTokenType() == XmlTokenType.XML_NAME) {
            final String tokenName=htmlTag ? token.getText().toLowerCase() : token.getText();
            if (!tagName.equals(tokenName)) {
              markClosingTag((XmlToken)each,tag,matchesNothing,holder,child);
            }
            break;
          }
        }
      }
    }
  }
}
