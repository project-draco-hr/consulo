{
  Project project=e.getData(PlatformDataKeys.PROJECT);
  if (project == null) {
    project=ProjectManager.getInstance().getDefaultProject();
  }
  FileChooserDescriptor fcd=FileChooserDescriptorFactory.createSingleFolderDescriptor();
  fcd.setShowFileSystemRoots(true);
  fcd.setTitle(GitBundle.getString("init.destination.directory.title"));
  fcd.setDescription(GitBundle.getString("init.destination.directory.description"));
  fcd.setHideIgnored(false);
  VirtualFile baseDir=e.getData(PlatformDataKeys.VIRTUAL_FILE);
  if (baseDir == null) {
    baseDir=project.getBaseDir();
  }
  final VirtualFile root=FileChooser.chooseFile(fcd,project,baseDir);
  if (root == null) {
    return;
  }
  if (GitUtil.isUnderGit(root)) {
    final int v=Messages.showYesNoDialog(project,GitBundle.message("init.warning.already.under.git",StringUtil.escapeXml(root.getPresentableUrl())),GitBundle.getString("init.warning.title"),Messages.getWarningIcon());
    if (v != 0) {
      return;
    }
  }
  Git git=ServiceManager.getService(Git.class);
  GitVcs vcs=GitVcs.getInstance(project);
  GitCommandResult result=git.init(project,root);
  if (!result.success()) {
    if (vcs != null && vcs.getExecutableValidator().isExecutableValid()) {
      GitUIUtil.notify(GitVcs.IMPORTANT_ERROR_NOTIFICATION,project,"Git init failed",result.getErrorOutputAsHtmlString(),NotificationType.ERROR,null);
    }
    return;
  }
  if (project.isDefault())   return;
  int rc=Messages.showYesNoDialog(project,GitBundle.getString("init.add.root.message"),GitBundle.getString("init.add.root.title"),Messages.getQuestionIcon());
  if (rc != 0) {
    return;
  }
  final String path=root.equals(baseDir) ? "" : root.getPath();
  final Project finalProject=project;
  GitVcs.runInBackground(new Task.Backgroundable(finalProject,GitBundle.getString("common.refreshing")){
    public void run(    @NotNull ProgressIndicator indicator){
      refreshAndConfigureVcsMappings(finalProject,root,path);
    }
  }
);
}
