{
  Project project=e.getData(PlatformDataKeys.PROJECT);
  if (project == null) {
    project=ProjectManager.getInstance().getDefaultProject();
  }
  FileChooserDescriptor fcd=FileChooserDescriptorFactory.createSingleFolderDescriptor();
  fcd.setShowFileSystemRoots(true);
  fcd.setTitle(GitBundle.getString("init.destination.directory.title"));
  fcd.setDescription(GitBundle.getString("init.destination.directory.description"));
  fcd.setHideIgnored(false);
  final VirtualFile baseDir=project.getBaseDir();
  final VirtualFile root=FileChooser.chooseFile(project,fcd,baseDir);
  if (root == null) {
    return;
  }
  if (GitUtil.isUnderGit(root)) {
    final int v=Messages.showYesNoDialog(project,GitBundle.message("init.warning.already.under.git",StringUtil.escapeXml(root.getPresentableUrl())),GitBundle.getString("init.warning.title"),Messages.getWarningIcon());
    if (v != 0) {
      return;
    }
  }
  GitVcs vcs=GitVcs.getInstance(project);
  try {
    Git.init(project,root);
  }
 catch (  VcsException ex) {
    if (vcs == null || vcs.getExecutableValidator().isExecutableValid()) {
      GitUIUtil.showOperationErrors(project,Collections.singleton(ex),"git init");
    }
    return;
  }
  if (project.isDefault())   return;
  int rc=Messages.showYesNoDialog(project,GitBundle.getString("init.add.root.message"),GitBundle.getString("init.add.root.title"),Messages.getQuestionIcon());
  if (rc != 0) {
    return;
  }
  final String path=root.equals(baseDir) ? "" : root.getPath();
  final Project finalProject=project;
  GitVcs.runInBackground(new Task.Backgroundable(finalProject,GitBundle.getString("common.refreshing")){
    public void run(    @NotNull ProgressIndicator indicator){
      refreshAndConfigureVcsMappings(finalProject,root,path);
    }
  }
);
}
