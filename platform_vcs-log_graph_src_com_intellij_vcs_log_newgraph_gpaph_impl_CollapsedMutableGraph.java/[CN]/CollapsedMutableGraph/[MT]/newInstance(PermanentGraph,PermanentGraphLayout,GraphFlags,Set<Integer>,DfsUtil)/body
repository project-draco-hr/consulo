{
  final Flags visibleNodes=graphFlags.getVisibleNodes();
  final Flags visibleNodesInBranches=graphFlags.getVisibleNodesInBranches();
  setAllValues(visibleNodes,true);
  UpdatableIntToIntMap intToIntMap=ListIntToIntMap.newInstance(new BooleanFunction<Integer>(){
    @Override public boolean fun(    Integer integer){
      return visibleNodes.get(integer) && visibleNodesInBranches.get(integer);
    }
  }
,permanentGraph.nodesCount());
  GraphWithElementsInfoImpl graphWithElementsInfo=new GraphWithElementsInfoImpl(permanentGraph,visibleNodesInBranches,visibleNodes,intToIntMap,dfsUtil);
  return new CollapsedMutableGraph(permanentGraph,layout,intToIntMap,graphFlags.getThickFlags(),dfsUtil,branchNodeIndexes,graphWithElementsInfo);
}
