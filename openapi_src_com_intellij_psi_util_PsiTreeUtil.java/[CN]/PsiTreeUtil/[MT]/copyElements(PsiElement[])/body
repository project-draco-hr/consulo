{
  ArrayList<PsiElement> roots=new ArrayList<PsiElement>();
  for (int i=0; i < elements.length; i++) {
    PsiElement rootCandidate=elements[i];
    boolean failed=false;
    for (int j=0; j < elements.length; j++) {
      PsiElement element=elements[j];
      if (i != j && isAncestor(element,rootCandidate,true)) {
        failed=true;
        break;
      }
    }
    if (!failed) {
      roots.add(rootCandidate);
    }
  }
  for (int i=0; i < elements.length; i++) {
    PsiElement element=elements[i];
    element.putCopyableUserData(INDEX,Integer.valueOf(i));
  }
  PsiElement[] newRoots=new PsiElement[roots.size()];
  for (int i=0; i < roots.size(); i++) {
    PsiElement root=roots.get(i);
    newRoots[i]=root.copy();
  }
  final PsiElement[] result=new PsiElement[elements.length];
  for (  PsiElement newRoot : newRoots) {
    decodeIndices(newRoot,result);
  }
  return result;
}
