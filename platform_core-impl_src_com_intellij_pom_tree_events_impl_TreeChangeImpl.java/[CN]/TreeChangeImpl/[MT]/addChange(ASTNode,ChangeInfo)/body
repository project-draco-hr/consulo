{
  LOG.assertTrue(child.getTreeParent() == myParent);
  final ChangeInfo current=myChanges.get(child);
  if (current != null && changeInfo.getChangeType() == ChangeInfo.CONTENTS_CHANGED) {
    return;
  }
  if (changeInfo.getChangeType() == ChangeInfo.REPLACE) {
    final ReplaceChangeInfoImpl replaceChangeInfo=(ReplaceChangeInfoImpl)changeInfo;
    final ASTNode replaced=replaceChangeInfo.getReplaced();
    final ChangeInfo replacedInfo=myChanges.get(replaced);
    if (replacedInfo == null) {
      addChangeInternal(child,changeInfo);
    }
 else {
switch (replacedInfo.getChangeType()) {
case ChangeInfo.REPLACE:
        replaceChangeInfo.setOldLength(replacedInfo.getOldLength());
      replaceChangeInfo.setReplaced(((ReplaceChangeInfo)replacedInfo).getReplaced());
    break;
case ChangeInfo.ADD:
  changeInfo=ChangeInfoImpl.create(ChangeInfo.ADD,replaced);
removeChangeInternal(replaced);
break;
}
addChangeInternal(child,changeInfo);
}
return;
}
if (current != null && current.getChangeType() == ChangeInfo.REMOVED) {
if (changeInfo.getChangeType() == ChangeInfo.ADD) {
if (!(child instanceof LeafElement)) {
changeInfo=ChangeInfoImpl.create(ChangeInfo.CONTENTS_CHANGED,child);
((ChangeInfoImpl)changeInfo).setOldLength(current.getOldLength());
myChanges.put(child,changeInfo);
}
 else {
removeChangeInternal(child);
}
}
return;
}
if (current != null && current.getChangeType() == ChangeInfo.ADD) {
if (changeInfo.getChangeType() == ChangeInfo.REMOVED) {
removeChangeInternal(child);
}
return;
}
if (changeInfo.getChangeType() == ChangeInfo.REMOVED) {
if (child instanceof LeafElement) {
final CharSequence charTabIndex=child.getChars();
if (checkLeaf(child.getTreeNext(),charTabIndex) || checkLeaf(child.getTreePrev(),charTabIndex)) return;
}
addChangeInternal(child,changeInfo);
if (current != null) {
((ChangeInfoImpl)changeInfo).setOldLength(current.getOldLength());
}
return;
}
if (current == null) {
addChangeInternal(child,changeInfo);
}
}
