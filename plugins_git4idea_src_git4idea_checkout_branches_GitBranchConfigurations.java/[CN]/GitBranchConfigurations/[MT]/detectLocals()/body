{
synchronized (myStateLock) {
    HashMap<VirtualFile,String> currents=new HashMap<VirtualFile,String>();
    for (    VirtualFile root : myGitRoots) {
      GitBranch current=GitBranch.current(myProject,root);
      currents.put(root,current == null ? "" : current.getName());
    }
    if (myConfigurations.isEmpty()) {
      List<String> locals=detectConfigurations(true,myGitRoots);
      if (locals.isEmpty()) {
        locals.add("master");
      }
      for (      String localName : locals) {
        GitBranchConfiguration c=createConfiguration(localName);
        c.setAutoDetected(true);
        boolean currentsMatched=true;
        for (        VirtualFile root : myGitRoots) {
          c.setBranch(root.getPath(),localName);
          currentsMatched&=currents.get(root).equals(localName);
        }
        if (currentsMatched) {
          myCurrentConfiguration=c;
        }
      }
      if (myCurrentConfiguration == null) {
        String name="untitled";
        if (locals.contains(name)) {
          String p=name;
          name=null;
          for (int i=0; i < Integer.MAX_VALUE; i++) {
            final String c=p + i;
            if (!locals.contains(c)) {
              name=c;
              break;
            }
          }
          if (name == null) {
            name="untitled 1";
          }
        }
        GitBranchConfiguration c=createConfiguration(name);
        for (        VirtualFile root : myGitRoots) {
          c.setBranch(root.getPath(),describeRoot(root));
        }
      }
    }
    fireCurrentConfigurationChanged();
    fireConfigurationsChanged();
  }
}
