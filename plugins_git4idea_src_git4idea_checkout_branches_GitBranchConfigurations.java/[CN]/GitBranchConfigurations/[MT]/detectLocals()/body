{
synchronized (myStateLock) {
    final HashMap<VirtualFile,String> rootToCurrentBranch=new HashMap<VirtualFile,String>();
    for (    VirtualFile root : myGitRoots) {
      GitBranch current=GitBranch.current(myProject,root);
      rootToCurrentBranch.put(root,current == null ? "" : current.getName());
    }
    if (myConfigurations.isEmpty()) {
      detectLocalConfigurations(true);
      updateCurrentConfiguration(rootToCurrentBranch);
      if (myCurrentConfiguration == null) {
        String name="untitled";
        if (myConfigurations.containsKey(name)) {
          String p=name;
          name=null;
          for (int i=0; i < Integer.MAX_VALUE; i++) {
            final String c=p + i;
            if (!myConfigurations.containsKey(c)) {
              name=c;
              break;
            }
          }
          if (name == null) {
            name="untitled 1";
          }
        }
        GitBranchConfiguration c=createConfiguration(name);
        for (        VirtualFile root : myGitRoots) {
          c.setReference(root.getPath(),describeRoot(root));
        }
      }
    }
 else     if (myCurrentConfiguration == null) {
      updateCurrentConfiguration(rootToCurrentBranch);
    }
    fireCurrentConfigurationChanged();
    fireConfigurationsChanged();
  }
}
