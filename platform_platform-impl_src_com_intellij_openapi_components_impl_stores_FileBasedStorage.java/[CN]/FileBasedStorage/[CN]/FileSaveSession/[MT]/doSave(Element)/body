{
  if (myLineSeparator == null) {
    myLineSeparator=isUseLfLineSeparatorByDefault() ? LineSeparator.LF : LineSeparator.getSystemLineSeparator();
  }
  BufferExposingByteArrayOutputStream content=element == null ? null : StorageUtil.writeToBytes(element,myLineSeparator.getSeparatorString());
  if (ApplicationManager.getApplication().isUnitTestMode() && StringUtil.startsWithChar(myFile.getPath(),'$')) {
    throw new StateStorageException("It seems like some macros were not expanded for path: " + myFile.getPath());
  }
  try {
    if (myStreamProvider != null && myStreamProvider.isEnabled()) {
      saveForProvider(myLineSeparator == LineSeparator.LF ? content : null,element);
    }
  }
 catch (  Throwable e) {
    LOG.error(e);
  }
  if (LOG.isDebugEnabled() && myFileSpec.equals(StoragePathMacros.MODULE_FILE)) {
    LOG.debug("doSave " + getFilePath());
  }
  if (content == null) {
    StorageUtil.deleteFile(myFile,this,getVirtualFile());
    myCachedVirtualFile=null;
  }
 else {
    VirtualFile file=getVirtualFile();
    if (file == null || !file.exists()) {
      FileUtil.createParentDirs(myFile);
      file=null;
    }
    myCachedVirtualFile=StorageUtil.writeFile(myFile,this,file,content,isUseXmlProlog() ? myLineSeparator : null);
  }
}
