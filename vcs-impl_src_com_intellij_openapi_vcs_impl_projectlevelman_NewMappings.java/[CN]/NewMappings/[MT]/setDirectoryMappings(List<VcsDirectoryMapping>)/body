{
  LOG.debug("setDirectoryMappings, size: " + items.size());
  MySetMappingsPreProcessor setMappingsPreProcessor=new MySetMappingsPreProcessor(items);
  setMappingsPreProcessor.invoke();
  final List<VcsDirectoryMapping> itemsCopy=setMappingsPreProcessor.getItemsCopy();
  final Map<VcsDirectoryMapping,LocalFileSystem.WatchRequest> requests=setMappingsPreProcessor.getRequests();
  final Collection<LocalFileSystem.WatchRequest> toRemove=new ArrayList<LocalFileSystem.WatchRequest>();
  keepActiveVcs(new Runnable(){
    public void run(){
      toRemove.addAll(myDirectoryMappingWatches.values());
      myDirectoryMappingWatches.clear();
      myVcsToPaths.clear();
      for (      VcsDirectoryMapping mapping : itemsCopy) {
        listForVcsFromMap(mapping.getVcs()).add(mapping);
      }
      sortedMappingsByMap();
    }
  }
);
  toRemove.removeAll(requests.values());
  LocalFileSystem.getInstance().removeWatchedRoots(toRemove);
  mappingsChanged();
}
