{
  for (Iterator<PatchAndVariants> iterator=candidates.iterator(); iterator.hasNext(); ) {
    final PatchAndVariants candidate=iterator.next();
    if (candidate.getVariants().size() == 1) {
      final FilePatchInProgress oneCandidate=candidate.getVariants().get(0);
      result.putValue(oneCandidate.getBase(),oneCandidate);
      iterator.remove();
    }
 else {
      final List<FilePatchInProgress> exact=new ArrayList<FilePatchInProgress>(candidate.getVariants().size());
      for (      FilePatchInProgress patch : candidate.getVariants()) {
        if (patch.getCurrentStrip() == 0) {
          exact.add(patch);
        }
      }
      if (exact.size() == 1) {
        final FilePatchInProgress patchInProgress=exact.get(0);
        putSelected(result,candidate.getVariants(),patchInProgress);
        iterator.remove();
      }
 else       if (!exact.isEmpty()) {
        candidate.getVariants().retainAll(exact);
      }
    }
  }
}
