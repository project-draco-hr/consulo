{
  CheckedTreeNode parentNode=myDescriptorToNodeMap.get(parentDescriptor);
  try {
    if (parentNode != null) {
      final boolean parentChecked=parentNode.isChecked() || childNode.isChecked();
      final boolean checkedValueChanged=parentNode.isChecked() != parentChecked;
      parentNode.setChecked(parentChecked);
      parentNode.add(childNode);
      if (checkedValueChanged && parentChecked) {
        for (CheckedTreeNode parent=(CheckedTreeNode)parentNode.getParent(); parent != null; parent=(CheckedTreeNode)parent.getParent()) {
          parent.setChecked(true);
        }
      }
      return null;
    }
    parentNode=createNode(parentDescriptor);
    parentNode.setChecked(childNode.isChecked());
    parentNode.add(childNode);
    return parentNode;
  }
  finally {
    if (parentNode != null && parentNode.getChildCount() == 1) {
      expandPath(new TreePath(parentNode.getPath()));
    }
  }
}
