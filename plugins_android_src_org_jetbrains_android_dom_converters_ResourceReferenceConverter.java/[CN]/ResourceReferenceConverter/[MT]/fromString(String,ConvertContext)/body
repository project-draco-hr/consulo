{
  if (s == null)   return null;
  ResourceValue parsed=ResourceValue.parse(s,true,myWithPrefix);
  final ResolvingConverter<String> additionalConverter=getAdditionalConverter(context);
  if ((parsed == null || !parsed.isReference()) && additionalConverter != null) {
    String value=additionalConverter.fromString(s,context);
    if (value != null) {
      return ResourceValue.literal(value);
    }
 else     if (!myAdditionalConverterSoft) {
      return null;
    }
  }
  if (parsed != null) {
    final String resType=parsed.getResourceType();
    if (parsed.getPrefix() == '?') {
      if (!myAllowAttributeReferences) {
        return null;
      }
      if (resType == null) {
        parsed.setResourceType(ResourceType.ATTR.getName());
      }
 else       if (!ResourceType.ATTR.getName().equals(resType)) {
        return null;
      }
    }
 else     if (resType == null && parsed.isReference()) {
      if (myWithExplicitResourceType && !"@null".equals(s)) {
        return null;
      }
      if (myResourceTypes.size() == 1) {
        parsed.setResourceType(myResourceTypes.get(0));
      }
    }
  }
  return parsed;
}
