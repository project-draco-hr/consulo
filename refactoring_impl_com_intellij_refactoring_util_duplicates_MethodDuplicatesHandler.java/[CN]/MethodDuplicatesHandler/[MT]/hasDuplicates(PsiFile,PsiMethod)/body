{
  final PsiCodeBlock body=method.getBody();
  LOG.assertTrue(body != null);
  final PsiStatement[] statements=body.getStatements();
  final DuplicatesFinder duplicatesFinder;
  final PsiElement[] pattern;
  if (statements.length != 1 || !(statements[0] instanceof PsiReturnStatement)) {
    final PsiStatement lastStatement=statements[statements.length - 1];
    if (lastStatement instanceof PsiReturnStatement) {
      final PsiExpression returnValue=((PsiReturnStatement)lastStatement).getReturnValue();
      if (returnValue instanceof PsiReferenceExpression && ((PsiReferenceExpression)returnValue).resolve() instanceof PsiVariable) {
        pattern=new PsiElement[statements.length - 1];
        System.arraycopy(statements,0,pattern,0,statements.length - 1);
      }
 else {
        pattern=statements;
      }
    }
 else {
      pattern=statements;
    }
  }
 else {
    final PsiExpression returnValue=((PsiReturnStatement)statements[0]).getReturnValue();
    if (returnValue != null) {
      pattern=new PsiElement[]{returnValue};
    }
 else {
      pattern=statements;
    }
  }
  duplicatesFinder=new DuplicatesFinder(pattern,Arrays.asList(method.getParameterList().getParameters()),new ArrayList<PsiVariable>());
  return duplicatesFinder.findDuplicates(file);
}
