{
  final int offset=editor.getCaretModel().getOffset();
  final PsiElement element=file.findElementAt(offset);
  final PsiMethod method=PsiTreeUtil.getParentOfType(element,PsiMethod.class);
  if (method == null) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("locate.caret.inside.a.method"));
    showErrorMessage(message,project);
    return;
  }
  if (method.isConstructor()) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("replace.with.method.call.does.not.work.for.constructors"));
    showErrorMessage(message,project);
  }
  final PsiCodeBlock body=method.getBody();
  if (body == null) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("method.does.not.have.a.body",method.getName()));
    showErrorMessage(message,project);
    return;
  }
  final PsiStatement[] statements=body.getStatements();
  if (statements.length == 0) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("method.has.an.empty.body",method.getName()));
    showErrorMessage(message,project);
    return;
  }
  AnalysisScope scope=new AnalysisScope(file);
  final Module module=ModuleUtil.findModuleForPsiElement(file);
  BaseAnalysisActionDialog dlg=new BaseAnalysisActionDialog(RefactoringBundle.message("replace.method.duplicates.scope.chooser.title",REFACTORING_NAME),RefactoringBundle.message("replace.method.duplicates.scope.chooser.message"),project,scope,module != null ? module.getName() : null,false);
  dlg.show();
  if (dlg.isOK()) {
    scope=dlg.getScope(AnalysisUIOptions.getInstance(project),scope,project,module);
    invokeOnScope(project,method,scope);
  }
}
