{
  LocalHistoryAction a=LocalHistory.startAction(project,REFACTORING_NAME);
  try {
    final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
    if (progressIndicator != null && progressIndicator.isCanceled())     return;
    final Runnable replaceRunnable=new Runnable(){
      public void run(){
        final int duplicatesNo=duplicates.size();
        WindowManager.getInstance().getStatusBar(project).setInfo(getStatusMessage(duplicatesNo));
        CommandProcessor.getInstance().executeCommand(project,new Runnable(){
          public void run(){
            PostprocessReformattingAspect.getInstance(project).postponeFormattingInside(new Runnable(){
              public void run(){
                DuplicatesImpl.invoke(project,new MethodDuplicatesMatchProvider(method,duplicates));
              }
            }
);
          }
        }
,REFACTORING_NAME,REFACTORING_NAME);
        WindowManager.getInstance().getStatusBar(project).setInfo("");
      }
    }
;
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      replaceRunnable.run();
    }
 else {
      ApplicationManager.getApplication().invokeLater(replaceRunnable,ModalityState.NON_MODAL);
    }
  }
  finally {
    a.finish();
  }
}
