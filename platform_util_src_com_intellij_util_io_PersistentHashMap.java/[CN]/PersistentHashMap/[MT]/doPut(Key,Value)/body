{
  myEnumerator.lockStorage();
  try {
    myEnumerator.markDirty(true);
    myAppendCache.remove(key);
    final AppendStream record=new AppendStream();
    myValueExternalizer.save(record,value);
    final BufferExposingByteArrayOutputStream bytes=record.getInternalBuffer();
    final int id=enumerate(key);
    long oldheader=readValueId(id);
    if (oldheader != NULL_ADDR) {
      myLiveAndGarbageKeysCounter++;
    }
 else {
      myLiveAndGarbageKeysCounter+=LIVE_KEY_MASK;
    }
    long header=myValueStorage.appendBytes(bytes.getInternalBuffer(),0,bytes.size(),0);
    updateValueId(id,header,oldheader,key,0);
  }
  finally {
    myEnumerator.unlockStorage();
  }
}
