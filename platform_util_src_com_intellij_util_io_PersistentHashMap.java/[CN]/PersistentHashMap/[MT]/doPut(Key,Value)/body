{
  myEnumerator.lockStorage();
  try {
    myEnumerator.markDirty(true);
    myAppendCache.remove(key);
    final BufferExposingByteArrayOutputStream bytes=new BufferExposingByteArrayOutputStream();
    if (myFlyweightAppenderStream == null)     myFlyweightAppenderStream=new AppendStream();
    myFlyweightAppenderStream.setOut(bytes);
    myValueExternalizer.save(myFlyweightAppenderStream,value);
    myFlyweightAppenderStream.setOut(null);
    final int id=enumerate(key);
    long oldheader=readValueId(id);
    if (oldheader != NULL_ADDR) {
      myLiveAndGarbageKeysCounter++;
    }
 else {
      myLiveAndGarbageKeysCounter+=LIVE_KEY_MASK;
    }
    long header=myValueStorage.appendBytes(bytes.getInternalBuffer(),0,bytes.size(),0);
    updateValueId(id,header,oldheader,key,0);
  }
  finally {
    myEnumerator.unlockStorage();
  }
}
