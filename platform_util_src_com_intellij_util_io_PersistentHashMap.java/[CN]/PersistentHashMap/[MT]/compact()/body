{
synchronized (PersistentEnumerator.ourLock) {
    final long now=System.currentTimeMillis();
    final String newPath=getDataFile(myEnumerator.myFile).getPath() + ".new";
    final PersistentHashMapValueStorage newStorage=PersistentHashMapValueStorage.create(newPath);
    myValueStorage.switchToCompactionMode();
    traverseAllRecords(new PersistentEnumerator.RecordsProcessor(){
      public boolean process(      final int keyId) throws IOException {
        final HeaderRecord record=readValueId(keyId);
        if (record.address != NULL_ADDR) {
          final byte[] bytes=new byte[record.size];
          myValueStorage.readBytes(record.address,bytes);
          record.address=newStorage.appendBytes(new ByteSequence(bytes),0);
          updateValueId(keyId,record);
        }
        return true;
      }
    }
);
    myValueStorage.dispose();
    newStorage.dispose();
    FileUtil.rename(new File(newPath),getDataFile(myEnumerator.myFile));
    myValueStorage=PersistentHashMapValueStorage.create(getDataFile(myEnumerator.myFile).getPath());
    LOG.info("Compacted " + myEnumerator.myFile.getPath() + " in "+ (System.currentTimeMillis() - now)+ "ms.");
    myGarbageSize=0;
    myEnumerator.putMetaData(0);
  }
}
