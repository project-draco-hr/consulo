{
synchronized (PersistentEnumerator.ourLock) {
    final long now=System.currentTimeMillis();
    final String newPath=getDataFile(myEnumerator.myFile).getPath() + ".new";
    final PersistentHashMapValueStorage newStorage=PersistentHashMapValueStorage.create(newPath);
    myValueStorage.switchToCompactionMode();
    myLiveAndGarbageKeysCounter=0;
    traverseAllRecords(new PersistentEnumerator.RecordsProcessor(){
      public boolean process(      final int keyId) throws IOException {
        final HeaderRecord record=readValueId(keyId);
        if (record.address != NULL_ADDR) {
          Pair<Long,byte[]> readResult=myValueStorage.readBytes(record.address);
          HeaderRecord value=new HeaderRecord(newStorage.appendBytes(new ByteSequence(readResult.second),0));
          updateValueId(keyId,value,record,null,getCurrentKey());
          myLiveAndGarbageKeysCounter+=LIVE_KEY_MASK;
        }
        return true;
      }
    }
);
    myValueStorage.dispose();
    newStorage.dispose();
    FileUtil.rename(new File(newPath),getDataFile(myEnumerator.myFile));
    myValueStorage=PersistentHashMapValueStorage.create(getDataFile(myEnumerator.myFile).getPath());
    LOG.info("Compacted " + myEnumerator.myFile.getPath() + " in "+ (System.currentTimeMillis() - now)+ "ms.");
    myEnumerator.putMetaData(myLiveAndGarbageKeysCounter);
  }
}
