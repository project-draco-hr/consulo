{
  String toFind=model.getStringToFind();
  String toReplace=model.getStringToReplace();
  Pattern pattern;
  try {
    int flags=Pattern.MULTILINE;
    if (!model.isCaseSensitive()) {
      flags|=Pattern.CASE_INSENSITIVE;
    }
    pattern=Pattern.compile(toFind,flags);
  }
 catch (  PatternSyntaxException e) {
    return toReplace;
  }
  Matcher matcher=pattern.matcher(foundString);
  if (matcher.matches()) {
    try {
      return matcher.replaceAll(StringUtil.unescapeStringCharacters(toReplace));
    }
 catch (    Exception e) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          Messages.showErrorDialog(myProject,FindBundle.message("find.replace.invalid.replacement.string",model.getStringToReplace()),FindBundle.message("find.replace.invalid.replacement.string.title"));
        }
      }
);
      return null;
    }
  }
 else {
    return toReplace;
  }
}
