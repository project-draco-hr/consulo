{
  clear();
  PsiDocumentManager.getInstance(myProject).commitDocument(editor.getDocument());
  EditorFoldingInfo info=EditorFoldingInfo.get(editor);
  FoldRegion[] foldRegions=editor.getFoldingModel().getAllFoldRegions();
  for (  FoldRegion region : foldRegions) {
    PsiElement element=info.getPsiElement(region);
    boolean expanded=region.isExpanded();
    boolean collapseByDefault=element != null && FoldingPolicy.isCollapseByDefault(element);
    if (collapseByDefault != !expanded || element == null) {
      if (element != null) {
        SmartPsiElementPointer pointer=SmartPointerManager.getInstance(myProject).createSmartPsiElementPointer(element);
        mySmartPointersOrRangeMarkers.add(pointer);
      }
 else       if (region.isValid()) {
        mySmartPointersOrRangeMarkers.add(region);
        String placeholderText=region.getPlaceholderText();
        if (placeholderText == null)         placeholderText=DEFAULT_PLACEHOLDER;
        myPlaceholderTexts.put(region,placeholderText);
      }
      myExpandedStates.add(expanded ? Boolean.TRUE : Boolean.FALSE);
    }
  }
}
