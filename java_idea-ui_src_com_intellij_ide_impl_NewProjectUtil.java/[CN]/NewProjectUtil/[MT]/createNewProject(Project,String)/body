{
  final boolean proceed=ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    public void run(){
      ProjectManager.getInstance().getDefaultProject();
    }
  }
,ProjectBundle.message("project.new.wizard.progress.title"),true,null);
  if (!proceed)   return;
  AddModuleWizard dialog=new AddModuleWizard(null,ModulesProvider.EMPTY_MODULES_PROVIDER,defaultPath);
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  final ProjectManagerEx projectManager=ProjectManagerEx.getInstanceEx();
  final String projectFilePath=dialog.getNewProjectFilePath();
  final ProjectBuilder projectBuilder=dialog.getProjectBuilder();
  try {
    if (StorageScheme.DIRECTORY_BASED == dialog.getStorageScheme()) {
      final File ideaDir=new File(projectFilePath + File.separator + ".idea");
      if (!ideaDir.exists() && !ideaDir.mkdirs()) {
        SwingUtilities.invokeLater(new Runnable(){
          @Override public void run(){
            Messages.showErrorDialog("Unable to create '.idea' directory at: " + projectFilePath,"Project initialization failed");
          }
        }
);
        return;
      }
    }
    final Project newProject=projectBuilder == null || !projectBuilder.isUpdate() ? projectManager.newProject(dialog.getProjectName(),projectFilePath,true,false) : projectToClose;
    if (newProject == null)     return;
    final Sdk jdk=dialog.getNewProjectJdk();
    if (jdk != null) {
      CommandProcessor.getInstance().executeCommand(newProject,new Runnable(){
        public void run(){
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            public void run(){
              applyJdkToProject(newProject,jdk);
            }
          }
);
        }
      }
,null,null);
    }
    final String compileOutput=dialog.getNewCompileOutput();
    CommandProcessor.getInstance().executeCommand(newProject,new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            String canonicalPath=compileOutput;
            try {
              canonicalPath=FileUtil.resolveShortWindowsName(compileOutput);
            }
 catch (            IOException e) {
            }
            canonicalPath=FileUtil.toSystemIndependentName(canonicalPath);
            CompilerProjectExtension.getInstance(newProject).setCompilerOutputUrl(VfsUtil.pathToUrl(canonicalPath));
          }
        }
);
      }
    }
,null,null);
    newProject.save();
    if (projectBuilder != null && !projectBuilder.validate(projectToClose,newProject)) {
      return;
    }
    if (newProject != projectToClose) {
      closePreviousProject(projectToClose);
    }
    if (projectBuilder != null) {
      projectBuilder.commit(newProject,null,ModulesProvider.EMPTY_MODULES_PROVIDER);
      newProject.save();
    }
    final boolean need2OpenProjectStructure=projectBuilder == null || projectBuilder.isOpenProjectSettingsAfter();
    StartupManager.getInstance(newProject).registerPostStartupActivity(new Runnable(){
      public void run(){
        SwingUtilities.invokeLater(new Runnable(){
          public void run(){
            if (newProject.isDisposed())             return;
            if (need2OpenProjectStructure) {
              ModulesConfigurator.showDialog(newProject,null,null);
            }
            ApplicationManager.getApplication().invokeLater(new Runnable(){
              public void run(){
                if (newProject.isDisposed())                 return;
                final ToolWindow toolWindow=ToolWindowManager.getInstance(newProject).getToolWindow(ToolWindowId.PROJECT_VIEW);
                if (toolWindow != null) {
                  toolWindow.activate(null);
                }
              }
            }
,ModalityState.NON_MODAL);
          }
        }
);
      }
    }
);
    if (newProject != projectToClose) {
      ProjectUtil.updateLastProjectLocation(projectFilePath);
      if (SystemInfo.isMacOSLion) {
        IdeFocusManager instance=IdeFocusManager.findInstance();
        IdeFrame lastFocusedFrame=instance.getLastFocusedFrame();
        if (lastFocusedFrame != null) {
          boolean fullScreen=WindowManagerEx.getInstanceEx().isFullScreen((Frame)lastFocusedFrame);
          if (fullScreen) {
            newProject.putUserData(MacMainFrameDecorator.SHOULD_OPEN_IN_FULLSCREEN,Boolean.TRUE);
          }
        }
      }
      projectManager.openProject(newProject);
    }
  }
  finally {
    if (projectBuilder != null) {
      projectBuilder.cleanup();
    }
  }
}
