{
  if (commandLine == null || commandLine.isEmpty()) {
    throw new IllegalArgumentException("commandLine is empty");
  }
  StringWriter out=new StringWriter();
  StringWriter err=new StringWriter();
  HgCommandResult result=new HgCommandResult(out,err);
  try {
    ProcessBuilder processBuilder=new ProcessBuilder(commandLine);
    if (dir != null) {
      processBuilder=processBuilder.directory(new File(dir));
    }
    Process process=processBuilder.start();
    Thread outReaderThread=startReader(new InputStreamReader(process.getInputStream(),charset),out);
    Thread errReaderThread=startReader(new InputStreamReader(process.getErrorStream()),err);
    process.waitFor();
    outReaderThread.join();
    errReaderThread.join();
    return result;
  }
 catch (  IOException e) {
    throw new ShellCommandException(e);
  }
catch (  InterruptedException e) {
    throw new ShellCommandException(e);
  }
}
