{
  final PsiManager manager=psiClass.getManager();
  final PsiElementFactory factory=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory();
  if (JUnitUtil.isJUnit4TestClass(psiClass)) {
    final PsiMethod[] methods=psiClass.getMethods();
    for (    PsiMethod method : methods) {
      if (AnnotationUtil.isAnnotated(method,"org.junit.Before",false))       return method;
    }
    final PsiMethod method=(PsiMethod)psiClass.add(factory.createMethodFromText("@org.junit.Before public void setUp() throws Exception {\n}",null));
    JavaCodeStyleManager.getInstance(manager.getProject()).shortenClassReferences(method);
    return method;
  }
  final PsiMethod patternMethod=factory.createMethodFromText("protected void setUp() throws Exception {\nsuper.setUp();\n}",null);
  final PsiClass baseClass=psiClass.getSuperClass();
  if (baseClass != null) {
    final PsiMethod baseMethod=baseClass.findMethodBySignature(patternMethod,false);
    if (baseMethod != null && baseMethod.hasModifierProperty(PsiModifier.PUBLIC)) {
      patternMethod.getModifierList().setModifierProperty(PsiModifier.PROTECTED,false);
      patternMethod.getModifierList().setModifierProperty(PsiModifier.PUBLIC,true);
    }
  }
  PsiMethod inClass=psiClass.findMethodBySignature(patternMethod,false);
  if (inClass == null) {
    return (PsiMethod)psiClass.add(patternMethod);
  }
 else   if (inClass.getBody() == null) {
    return (PsiMethod)inClass.replace(patternMethod);
  }
  return inClass;
}
