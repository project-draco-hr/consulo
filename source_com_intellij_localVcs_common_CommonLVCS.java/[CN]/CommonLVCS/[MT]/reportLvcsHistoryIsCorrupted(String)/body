{
  checkOldLvcsEnabled();
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    throw new RuntimeException("Local history is corrupt and will be rebuilt: \n" + message);
  }
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      Messages.showMessageDialog(LocalHistoryBundle.message("message.text.local.history.corrupt.with.message",message),LocalHistoryBundle.message("message.title.local.history.corrupt"),Messages.getWarningIcon());
    }
  }
,ModalityState.NON_MODAL);
  Runnable rebuildAction=new Runnable(){
    public void run(){
      ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
        public void run(){
          clearAndRecreateLocation();
          resynchronizeRoots();
        }
      }
,LocalHistoryBundle.message("progress.title.rebuilding.local.history"),false,myProject);
    }
  }
;
  if (ApplicationManager.getApplication().isDispatchThread()) {
    rebuildAction.run();
  }
 else {
    try {
      SwingUtilities.invokeAndWait(rebuildAction);
    }
 catch (    InterruptedException e) {
      LOG.error(e);
    }
catch (    InvocationTargetException e) {
      LOG.error(e);
    }
  }
}
