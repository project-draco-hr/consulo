{
  if (!myIsLocked)   return;
  if (purge) {
    purge();
  }
  try {
    createTransactionFile();
    myImplementation.save(getVcsLocation());
    DataOutputStream activitiesOut=new DataOutputStream(new BufferedOutputStream(new FileOutputStream(getActivitiesRegistryFile())));
    try {
      myUserActivitiesRegistry.save(activitiesOut);
    }
  finally {
      activitiesOut.close();
    }
    FileUtil.delete(getTransactionFile());
  }
 catch (  final Throwable e) {
    LOG.info(e);
    if (!ApplicationManager.getApplication().isUnitTestMode()) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          Messages.showMessageDialog(LocalVcsBundle.message("message.text.could.not.save.local.history.with.error",e.getLocalizedMessage()),LocalVcsBundle.message("message.title.saving.local.history"),Messages.getErrorIcon());
        }
      }
);
    }
  }
}
