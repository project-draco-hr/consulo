{
  if (UnitTestMode.getInstance(myProject).isInUnitTestMode(BackgroundTaskQueue.class.getName())) {
    task.run(new EmptyProgressIndicator());
    task.onSuccess();
  }
 else   if (task.isConditionalModal() && !task.shouldStartInBackground()) {
    ProgressManager.getInstance().run(task);
  }
 else {
    boolean hadActiveTask;
synchronized (myQueue) {
      hadActiveTask=myHasActiveTask;
      myQueue.offer(task);
      myHasActiveTask=true;
    }
    if (!hadActiveTask) {
      runRunner();
    }
  }
}
