{
  if (assertion instanceof KnownException)   return ((KnownException)assertion).getPacketFactory();
  if (assertion instanceof ComparisonFailure || assertion instanceof org.junit.ComparisonFailure) {
    return ComparisonDetailsExtractor.create(assertion);
  }
  final Throwable cause=assertion.getCause();
  if (cause instanceof ComparisonFailure || cause instanceof org.junit.ComparisonFailure) {
    try {
      return ComparisonDetailsExtractor.create(assertion,ComparisonDetailsExtractor.getExpected(cause),ComparisonDetailsExtractor.getActual(cause));
    }
 catch (    Throwable ignore) {
    }
  }
  if (assertion.getMessage() != null) {
    final Matcher matcher=Pattern.compile("\nExpected: \"(.*)\"\n     got: \"(.*)\"\n",Pattern.DOTALL).matcher(assertion.getMessage());
    if (matcher.matches()) {
      return ComparisonDetailsExtractor.create(assertion,matcher.group(1).replaceAll("\\\\n","\n"),matcher.group(2).replaceAll("\\\\n","\n"));
    }
  }
  return new ExceptionPacketFactory(PoolOfTestStates.FAILED_INDEX,assertion);
}
