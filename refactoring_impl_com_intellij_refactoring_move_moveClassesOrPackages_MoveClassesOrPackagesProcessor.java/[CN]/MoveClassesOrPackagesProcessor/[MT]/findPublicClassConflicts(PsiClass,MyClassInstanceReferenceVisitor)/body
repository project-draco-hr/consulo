{
  NonPublicClassMemberWrappersSet members=new NonPublicClassMemberWrappersSet();
  members.addElements(aClass.getFields());
  members.addElements(aClass.getMethods());
  members.addElements(aClass.getInnerClasses());
  RefactoringUtil.IsDescendantOf isDescendantOf=new RefactoringUtil.IsDescendantOf(aClass);
  final PsiPackage aPackage=aClass.getContainingFile().getContainingDirectory().getPackage();
  final GlobalSearchScope packageScope=GlobalSearchScope.packageScopeWithoutLibraries(aPackage,false);
  for (  ClassMemberWrapper memberWrapper : members) {
    for (    PsiReference reference : ReferencesSearch.search(memberWrapper.getMember(),packageScope,false).findAll()) {
      final PsiElement element=reference.getElement();
      if (element instanceof PsiReferenceExpression) {
        final PsiReferenceExpression expression=((PsiReferenceExpression)element);
        final PsiExpression qualifierExpression=expression.getQualifierExpression();
        if (qualifierExpression != null) {
          final PsiType type=qualifierExpression.getType();
          if (type != null) {
            final PsiClass resolvedTypeClass=PsiUtil.resolveClassInType(type);
            if (isDescendantOf.value(resolvedTypeClass)) {
              instanceReferenceVisitor.visitMemberReference(memberWrapper.getMember(),expression,isDescendantOf);
            }
          }
        }
 else {
          instanceReferenceVisitor.visitMemberReference(memberWrapper.getMember(),expression,isDescendantOf);
        }
      }
    }
  }
}
