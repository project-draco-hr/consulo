{
  if (session.isAsynchronous()) {
    ModalityState state=session.getModalityState();
    queueSession(session,state);
  }
 else {
    final Application application=ApplicationManager.getApplication();
    boolean isEDT=application.isDispatchThread();
    if (isEDT) {
      try {
        updateSessionMap(session,true);
        session.scan();
      }
  finally {
        updateSessionMap(session,false);
      }
      boolean hasWriteAction=application.isWriteAccessAllowed();
      session.fireEvents(hasWriteAction);
    }
 else {
      if (((ApplicationEx)application).holdsReadLock()) {
        LOG.error("Do not call synchronous refresh from inside read action except for event dispatch thread. " + "This will eventually cause deadlock if there are any events to fire");
        return;
      }
      queueSession(session,ModalityState.defaultModalityState());
      session.waitFor();
    }
  }
}
