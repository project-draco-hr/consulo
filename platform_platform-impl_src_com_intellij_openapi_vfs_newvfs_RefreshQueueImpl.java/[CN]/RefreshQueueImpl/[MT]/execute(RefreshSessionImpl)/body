{
  if (session.isAsynchronous()) {
    queueSession(session,session.getModalityState(),session.getTransaction());
  }
 else {
    Application app=ApplicationManager.getApplication();
    if (app.isDispatchThread()) {
      ((TransactionGuardImpl)TransactionGuard.getInstance()).assertWriteActionAllowed();
      doScan(session);
      session.fireEvents();
    }
 else {
      if (((ApplicationEx)app).holdsReadLock()) {
        LOG.error("Do not call synchronous refresh under read lock (except from EDT) - " + "this will cause a deadlock if there are any events to fire.");
        return;
      }
      queueSession(session,ModalityState.defaultModalityState(),TransactionGuard.getInstance().getContextTransaction());
      session.waitFor();
    }
  }
}
