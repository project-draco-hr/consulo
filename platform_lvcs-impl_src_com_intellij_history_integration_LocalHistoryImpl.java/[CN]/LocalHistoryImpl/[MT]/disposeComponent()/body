{
  if (!isInitialized.getAndSet(false))   return;
  if (myAutoSaveFuture != null)   myAutoSaveFuture.cancel(false);
  int period=Registry.intValue("localHistory.daysToKeep") * 1000 * 60* 60* 24;
  VirtualFileManager fm=VirtualFileManagerEx.getInstance();
  fm.removeVirtualFileListener(myEventDispatcher);
  fm.removeVirtualFileManagerListener(myEventDispatcher);
  CommandProcessor.getInstance().removeCommandListener(myEventDispatcher);
  myChangeList.purgeObsolete(period);
  validateStorage();
  myChangeList.close();
  LocalHistoryLog.LOG.info("Local history storage successfully closed.");
  ShutDownTracker.getInstance().unregisterShutdownTask(myShutdownTask);
}
