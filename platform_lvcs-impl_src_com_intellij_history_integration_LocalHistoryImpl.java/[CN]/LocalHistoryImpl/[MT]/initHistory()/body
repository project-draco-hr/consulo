{
  ChangeListStorage storage;
  try {
    storage=new ChangeListStorageImpl(getStorageDir());
  }
 catch (  Throwable e) {
    LocalHistoryLog.LOG.warn("cannot create storage, in-memory  implementation will be used",e);
    storage=new InMemoryChangeListStorage();
  }
  myChangeList=new ChangeList(storage);
  myVcs=new LocalHistoryFacade(myChangeList);
  myGateway=new IdeaGateway();
  myEventDispatcher=new LocalHistoryEventDispatcher(myVcs,myGateway);
  CommandProcessor.getInstance().addCommandListener(myEventDispatcher);
  VirtualFileManager fm=VirtualFileManager.getInstance();
  fm.addVirtualFileListener(myEventDispatcher);
  fm.addVirtualFileManagerListener(myEventDispatcher);
  ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
    @Override public void run(){
      validateStorage();
    }
  }
);
}
