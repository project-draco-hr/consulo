{
  Stack<StubElement> parentStubs=new Stack<StubElement>();
  Stack<PsiElement> parentElements=new Stack<PsiElement>();
  parentElements.push(root);
  parentStubs.push(parentStub);
  while (!parentElements.isEmpty()) {
    StubElement stub=parentStubs.pop();
    PsiElement elt=parentElements.pop();
    if (elt instanceof StubBasedPsiElement) {
      final IStubElementType type=((StubBasedPsiElement)elt).getElementType();
      if (type.shouldCreateStub(elt.getNode())) {
        @SuppressWarnings("unchecked") StubElement s=type.createStub(elt,stub);
        stub=s;
      }
    }
 else {
      final ASTNode node=elt.getNode();
      final IElementType type=node == null ? null : node.getElementType();
      if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(node)) {
        LOG.error("Non-StubBasedPsiElement requests stub creation. Stub type: " + type + ", PSI: "+ elt);
      }
    }
    for (PsiElement child=elt.getLastChild(); child != null; child=child.getPrevSibling()) {
      if (!skipChildProcessingWhenBuildingStubs(elt,child)) {
        parentStubs.push(stub);
        parentElements.push(child);
      }
    }
  }
  return parentStub;
}
