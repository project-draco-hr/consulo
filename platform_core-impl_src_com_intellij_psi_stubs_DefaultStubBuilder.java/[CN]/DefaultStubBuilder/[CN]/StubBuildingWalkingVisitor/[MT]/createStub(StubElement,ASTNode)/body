{
  IElementType nodeType=node.getElementType();
  if (nodeType instanceof IStubElementType) {
    final IStubElementType type=(IStubElementType)nodeType;
    if (type.shouldCreateStub(node)) {
      PsiElement element=node.getPsi();
      if (!(element instanceof StubBasedPsiElement)) {
        LOG.error("Non-StubBasedPsiElement requests stub creation. Stub type: " + type + ", PSI: "+ element);
      }
      @SuppressWarnings("unchecked") StubElement stub=type.createStub(element,parentStub);
      LOG.assertTrue(stub != null,element);
      return stub;
    }
  }
  return null;
}
