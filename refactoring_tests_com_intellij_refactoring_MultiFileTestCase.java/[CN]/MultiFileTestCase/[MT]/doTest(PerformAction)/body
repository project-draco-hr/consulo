{
  String testName=getTestName(true);
  String root=PathManagerEx.getTestDataPath() + getTestRoot() + testName;
  String rootBefore=root + "/before";
  VirtualFile rootDir=PsiTestUtil.createTestProjectStructure(myProject,myModule,rootBefore,myFilesToDelete,false);
  setupProject(rootDir);
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  String rootAfter=root + "/after";
  VirtualFile rootDir2=LocalFileSystem.getInstance().findFileByPath(rootAfter.replace(File.separatorChar,'/'));
  performAction.performAction(rootDir,rootDir2);
  myProject.getComponent(PostprocessReformattingAspect.class).doPostponedFormatting();
  FileDocumentManager.getInstance().saveAllDocuments();
  if (myDoCompare) {
    IdeaTestUtil.assertDirectoriesEqual(rootDir2,rootDir,CVS_FILE_FILTER);
  }
}
