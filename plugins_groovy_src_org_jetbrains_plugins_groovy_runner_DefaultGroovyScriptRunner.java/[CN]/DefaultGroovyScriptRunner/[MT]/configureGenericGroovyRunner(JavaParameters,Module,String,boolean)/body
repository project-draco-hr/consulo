{
  final VirtualFile groovyJar=findGroovyJar(module);
  if (useBundled) {
    params.getClassPath().add(GroovyUtils.getBundledGroovyJar());
  }
 else   if (groovyJar != null) {
    params.getClassPath().add(groovyJar);
  }
  setToolsJar(params);
  String groovyHome=useBundled ? FileUtil.toCanonicalPath(GroovyUtils.getBundledGroovyJar().getParentFile().getParent()) : LibrariesUtil.getGroovyHomePath(module);
  if (groovyHome != null) {
    groovyHome=FileUtil.toSystemDependentName(groovyHome);
  }
  setGroovyHome(params,groovyHome);
  final String confPath=getConfPath(groovyHome);
  params.getVMParametersList().add("-Dgroovy.starter.conf=" + confPath);
  params.getVMParametersList().addAll(HttpConfigurable.convertArguments(HttpConfigurable.getJvmPropertiesList(false,null)));
  params.setMainClass("org.codehaus.groovy.tools.GroovyStarter");
  params.getProgramParametersList().add("--conf");
  params.getProgramParametersList().add(confPath);
  params.getProgramParametersList().add("--main");
  params.getProgramParametersList().add(mainClass);
  if (params.getVMParametersList().getPropertyValue(GroovycOSProcessHandler.GRAPE_ROOT) == null) {
    String sysRoot=System.getProperty(GroovycOSProcessHandler.GRAPE_ROOT);
    if (sysRoot != null) {
      params.getVMParametersList().defineProperty(GroovycOSProcessHandler.GRAPE_ROOT,sysRoot);
    }
  }
}
