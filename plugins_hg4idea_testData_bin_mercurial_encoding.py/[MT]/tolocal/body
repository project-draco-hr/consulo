def tolocal(s):
    '\n    Convert a string from internal UTF-8 to local encoding\n\n    All internal strings should be UTF-8 but some repos before the\n    implementation of locale support may contain latin1 or possibly\n    other character sets. We attempt to decode everything strictly\n    using UTF-8, then Latin-1, and failing that, we use UTF-8 and\n    replace unknown characters.\n    '
    for e in ('UTF-8', fallbackencoding):
        try:
            u = s.decode(e)
            return u.encode(encoding, 'replace')
        except LookupError as k:
            raise error.Abort(('%s, please check your locale settings' % k))
        except UnicodeDecodeError:
            pass
    u = s.decode('utf-8', 'replace')
    return u.encode(encoding, 'replace')
