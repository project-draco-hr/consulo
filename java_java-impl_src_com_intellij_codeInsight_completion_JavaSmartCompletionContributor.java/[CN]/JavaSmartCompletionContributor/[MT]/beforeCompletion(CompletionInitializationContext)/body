{
  if (context.getCompletionType() != CompletionType.SMART) {
    return;
  }
  if (!context.getEditor().getSelectionModel().hasSelection()) {
    final PsiFile file=context.getFile();
    PsiElement element=file.findElementAt(context.getStartOffset());
    if (element instanceof PsiIdentifier) {
      element=element.getParent();
      while (element instanceof PsiJavaCodeReferenceElement || element instanceof PsiCall || element instanceof PsiThisExpression|| element instanceof PsiSuperExpression|| element instanceof PsiTypeElement|| element instanceof PsiClassObjectAccessExpression) {
        int newEnd=element.getTextRange().getEndOffset();
        if (element instanceof PsiMethodCallExpression) {
          newEnd=((PsiMethodCallExpression)element).getMethodExpression().getTextRange().getEndOffset();
        }
 else         if (element instanceof PsiNewExpression) {
          final PsiJavaCodeReferenceElement classReference=((PsiNewExpression)element).getClassReference();
          if (classReference != null) {
            newEnd=classReference.getTextRange().getEndOffset();
          }
        }
        context.getOffsetMap().addOffset(CompletionInitializationContext.IDENTIFIER_END_OFFSET,newEnd);
        element=element.getParent();
      }
    }
  }
  PsiElement lastElement=context.getFile().findElementAt(context.getStartOffset() - 1);
  if (lastElement != null && lastElement.getText().equals("(")) {
    final PsiElement parent=lastElement.getParent();
    if (parent instanceof PsiTypeCastExpression) {
      context.setFileCopyPatcher(new DummyIdentifierPatcher(""));
      return;
    }
    if (parent instanceof PsiParenthesizedExpression) {
      context.setFileCopyPatcher(new DummyIdentifierPatcher("xxx)yyy "));
      return;
    }
  }
  context.setFileCopyPatcher(new DummyIdentifierPatcher("xxx"));
}
