{
  if (myTag == null)   return null;
  XmlNSDescriptorImpl nsDescriptor=(XmlNSDescriptorImpl)myTag.getNSDescriptor(namespace,true);
  if (nsDescriptor != this && nsDescriptor != null) {
    return nsDescriptor.getAttributeImpl(localName,namespace,visited);
  }
  if (visited == null)   visited=new HashSet<XmlTag>(1);
 else   if (visited.contains(myTag))   return null;
  visited.add(myTag);
  XmlTag[] tags=myTag.getSubTags();
  for (  XmlTag tag : tags) {
    if (equalsToSchemaName(tag,ATTRIBUTE_TAG_NAME)) {
      String name=tag.getAttributeValue("name");
      if (name != null) {
        if (checkElementNameEquivalence(localName,namespace,name,tag)) {
          return createAttributeDescriptor(tag);
        }
      }
    }
 else     if (equalsToSchemaName(tag,INCLUDE_TAG_NAME) || (equalsToSchemaName(tag,IMPORT_TAG_NAME) && namespace.equals(tag.getAttributeValue("namespace")))) {
      final XmlAttribute schemaLocation=tag.getAttribute("schemaLocation",null);
      if (schemaLocation != null) {
        final XmlFile xmlFile=XmlUtil.findNamespaceByLocation(myTag.getContainingFile(),schemaLocation.getValue());
        if (xmlFile != null) {
          final XmlDocument includedDocument=xmlFile.getDocument();
          if (includedDocument != null) {
            final PsiMetaData data=includedDocument.getMetaData();
            if (data instanceof XmlNSDescriptorImpl) {
              final XmlAttributeDescriptor attributeDescriptor=((XmlNSDescriptorImpl)data).getAttributeImpl(localName,namespace,visited);
              if (attributeDescriptor != null) {
                final CachedValue<XmlAttributeDescriptor> value=includedDocument.getManager().getCachedValuesManager().createCachedValue(new CachedValueProvider<XmlAttributeDescriptor>(){
                  public Result<XmlAttributeDescriptor> compute(){
                    return new Result<XmlAttributeDescriptor>(attributeDescriptor,attributeDescriptor.getDependences());
                  }
                }
,false);
                return value.getValue();
              }
            }
          }
        }
      }
    }
  }
  return null;
}
