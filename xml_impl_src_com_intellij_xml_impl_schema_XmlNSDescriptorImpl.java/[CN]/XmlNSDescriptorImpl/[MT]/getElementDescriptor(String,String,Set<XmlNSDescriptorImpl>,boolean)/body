{
  if (visited.contains(this))   return null;
  final QNameKey pair=new QNameKey(namespace,localName);
  final CachedValue<XmlElementDescriptor> descriptor=myDescriptorsMap.get(pair);
  if (descriptor != null) {
    final XmlElementDescriptor value=descriptor.getValue();
    if (value == null || value.getDeclaration().isValid())     return value;
  }
  final XmlTag rootTag=myTag;
  if (rootTag == null)   return null;
  XmlTag[] tags=rootTag.getSubTags();
  visited.add(this);
  for (  final XmlTag tag : tags) {
    if (equalsToSchemaName(tag,ELEMENT_TAG_NAME)) {
      String name=tag.getAttributeValue("name");
      if (name != null) {
        if (checkElementNameEquivalence(localName,namespace,name,tag)) {
          final CachedValue<XmlElementDescriptor> cachedValue=tag.getManager().getCachedValuesManager().createCachedValue(new CachedValueProvider<XmlElementDescriptor>(){
            public Result<XmlElementDescriptor> compute(){
              final String name=tag.getAttributeValue("name");
              if (name != null && !name.equals(pair.second)) {
                myDescriptorsMap.remove(pair);
                return new Result<XmlElementDescriptor>(null);
              }
              final XmlElementDescriptor xmlElementDescriptor=createElementDescriptor(tag);
              return new Result<XmlElementDescriptor>(xmlElementDescriptor,xmlElementDescriptor.getDependences());
            }
          }
,false);
          myDescriptorsMap.put(pair,cachedValue);
          return cachedValue.getValue();
        }
      }
    }
 else     if (equalsToSchemaName(tag,INCLUDE_TAG_NAME) || (reference && equalsToSchemaName(tag,IMPORT_TAG_NAME) && (namespace.equals(tag.getAttributeValue("namespace")) || namespace.length() == 0 && tag.getAttributeValue("namespace") == null))) {
      final XmlAttribute schemaLocation=tag.getAttribute("schemaLocation",null);
      if (schemaLocation != null) {
        final XmlFile xmlFile=XmlUtil.findNamespaceByLocation(rootTag.getContainingFile(),schemaLocation.getValue());
        if (xmlFile != null) {
          final XmlDocument includedDocument=xmlFile.getDocument();
          if (includedDocument != null) {
            final PsiMetaData data=includedDocument.getMetaData();
            if (data instanceof XmlNSDescriptorImpl) {
              final XmlElementDescriptor elementDescriptor=((XmlNSDescriptorImpl)data).getElementDescriptor(localName,namespace,visited,reference);
              if (elementDescriptor != null) {
                return elementDescriptor;
              }
            }
          }
        }
      }
    }
 else     if (equalsToSchemaName(tag,REDEFINE_TAG_NAME)) {
      final XmlNSDescriptorImpl nsDescriptor=getRedefinedElementDescriptor(tag);
      if (nsDescriptor != null) {
        final XmlElementDescriptor xmlElementDescriptor=nsDescriptor.getElementDescriptor(localName,namespace,visited,reference);
        if (xmlElementDescriptor != null)         return xmlElementDescriptor;
      }
    }
  }
  return null;
}
