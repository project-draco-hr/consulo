{
  XmlNSDescriptorImpl nsDescriptor=getNSDescriptorToSearchIn(rootTag,name,this);
  if (nsDescriptor != this) {
    return nsDescriptor.findTypeDescriptor(nsDescriptor.getDescriptorFile().getDocument().getRootTag(),XmlUtil.findLocalNameByQualifiedName(name));
  }
  if (rootTag == null)   return null;
  if (visited != null) {
    if (visited.contains(rootTag))     return null;
    visited.add(rootTag);
  }
  final Pair<String,XmlTag> pair=new Pair<String,XmlTag>(name,rootTag);
  final CachedValue<TypeDescriptor> descriptor=myTypesMap.get(pair);
  if (descriptor != null) {
    TypeDescriptor value=descriptor.getValue();
    if (value == null || (value instanceof ComplexTypeDescriptor && ((ComplexTypeDescriptor)value).getDeclaration().isValid()))     return value;
  }
  XmlTag[] tags=rootTag.getSubTags();
  if (visited == null) {
    visited=new HashSet<XmlTag>(1);
    visited.add(rootTag);
  }
  return doFindIn(tags,name,pair,rootTag,visited);
}
