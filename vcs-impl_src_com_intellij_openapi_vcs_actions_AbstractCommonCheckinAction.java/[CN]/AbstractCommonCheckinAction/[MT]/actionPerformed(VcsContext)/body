{
  final Project project=context.getProject();
  if (project == null)   return;
  FilePath[] roots=filterDescindingFiles(getRoots(context),project);
  if (ApplicationManager.getApplication().isDispatchThread()) {
    ApplicationManager.getApplication().saveAll();
  }
  final ChangeListManager changeListManager=ChangeListManager.getInstance(project);
  if (changeListManager.ensureUpToDate(true)) {
    ChangeList initialSelection=getInitiallySelectedChangeList(context,project);
    Change[] changes=context.getSelectedChanges();
    if (changes != null && changes.length > 0) {
      Collection<Change> changeCollection=new ArrayList<Change>();
      Collections.addAll(changeCollection,changes);
      CommitChangeListDialog.commitChanges(project,changeCollection,initialSelection,getExecutor(project));
    }
 else {
      CommitChangeListDialog.commitPaths(project,Arrays.asList(roots),initialSelection,getExecutor(project));
    }
  }
}
