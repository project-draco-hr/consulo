{
  for (lexer.start(chars,0,chars.length(),0); ; lexer.advance()) {
    IElementType tokenType=lexer.getTokenType();
    if (tokenType == null)     break;
    if (range != null) {
      if (lexer.getTokenEnd() <= range.getStartOffset())       continue;
      if (lexer.getTokenStart() >= range.getEndOffset())       break;
    }
    boolean isComment=commentTokens.contains(tokenType);
    if (!isComment) {
      final Language commentLang=tokenType.getLanguage();
      final ParserDefinition parserDefinition=LanguageParserDefinitions.INSTANCE.forLanguage(commentLang);
      if (parserDefinition != null) {
        final TokenSet langCommentTokens=parserDefinition.getCommentTokens();
        isComment=langCommentTokens.contains(tokenType);
      }
    }
    if (isComment) {
      final int startDelta=builderForFile != null ? builderForFile.getCommentStartDelta(lexer.getTokenType()) : 0;
      final int endDelta=builderForFile != null ? builderForFile.getCommentEndDelta(lexer.getTokenType()) : 0;
      commentStarts.add(lexer.getTokenStart() + startDelta);
      commentEnds.add(lexer.getTokenEnd() - endDelta);
    }
  }
}
