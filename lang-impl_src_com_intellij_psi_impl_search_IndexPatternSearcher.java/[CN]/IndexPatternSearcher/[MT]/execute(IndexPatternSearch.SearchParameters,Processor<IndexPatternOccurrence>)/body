{
  final PsiFile file=queryParameters.getFile();
  if (file instanceof PsiBinaryFile || file instanceof PsiCompiledElement || file.getVirtualFile() == null) {
    return true;
  }
  final CacheManager cacheManager=((PsiManagerEx)file.getManager()).getCacheManager();
  final IndexPatternProvider patternProvider=queryParameters.getPatternProvider();
  if (patternProvider != null) {
    if (cacheManager.getTodoCount(file.getVirtualFile(),patternProvider) == 0)     return true;
  }
 else {
    if (cacheManager.getTodoCount(file.getVirtualFile(),queryParameters.getPattern()) == 0)     return true;
  }
  TIntArrayList commentStarts=new TIntArrayList();
  TIntArrayList commentEnds=new TIntArrayList();
  final CharSequence chars=file.getViewProvider().getContents();
  findCommentTokenRanges(file,chars,queryParameters.getRange(),commentStarts,commentEnds);
  for (int i=0; i < commentStarts.size(); i++) {
    int commentStart=commentStarts.get(i);
    int commentEnd=commentEnds.get(i);
    if (patternProvider != null) {
      for (      final IndexPattern pattern : patternProvider.getIndexPatterns()) {
        if (!collectPatternMatches(pattern,chars,commentStart,commentEnd,file,queryParameters.getRange(),consumer)) {
          return false;
        }
      }
    }
 else {
      if (!collectPatternMatches(queryParameters.getPattern(),chars,commentStart,commentEnd,file,queryParameters.getRange(),consumer)) {
        return false;
      }
    }
  }
  return true;
}
