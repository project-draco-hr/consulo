{
  if (targetFile instanceof XmlFile) {
    XmlDocument document=((XmlFile)targetFile).getDocument();
    if (document != null && document.getUserData(DISABLE_ENTITY_EXPAND) != null)     return null;
  }
  final String entityName=text.substring(1,text.length() - 1);
  final PsiElement targetElement=targetFile != null ? targetFile : element;
  CachedValue<XmlEntityDecl> value;
synchronized (PsiLock.LOCK) {
    Map<String,CachedValue<XmlEntityDecl>> map=getCachingMap(targetElement);
    value=map.get(entityName);
    final PsiFile containingFile=element.getContainingFile();
    if (value == null) {
      final PsiManager manager=element.getManager();
      if (manager == null) {
        return resolveEntity(targetElement,entityName,containingFile).getValue();
      }
      value=CachedValuesManager.getManager(manager.getProject()).createCachedValue(new CachedValueProvider<XmlEntityDecl>(){
        public Result<XmlEntityDecl> compute(){
          return resolveEntity(targetElement,entityName,containingFile);
        }
      }
);
      map.put(entityName,value);
    }
  }
  return value.getValue();
}
