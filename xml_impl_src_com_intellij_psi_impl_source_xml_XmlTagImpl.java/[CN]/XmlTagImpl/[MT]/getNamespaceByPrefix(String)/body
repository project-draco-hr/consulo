{
  final PsiElement parent=getParent();
  BidirectionalMap<String,String> map=initNamespaceMaps(parent);
  if (map != null) {
    final String ns=map.get(prefix);
    if (ns != null)     return ns;
  }
  if (parent instanceof XmlTag)   return ((XmlTag)parent).getNamespaceByPrefix(prefix);
  if ("xml".equals(prefix))   return XmlUtil.XML_NAMESPACE_URI;
  if (prefix.length() > 0 && !hasNamespaceDeclarations() && getNamespacePrefix().equals(prefix) && ourGetNsByPrefixRecursionLock.get() == null) {
    ourGetNsByPrefixRecursionLock.set(Boolean.TRUE);
    try {
      final String nsFromEmptyPrefix=getNamespaceByPrefix("");
      final XmlNSDescriptor nsDescriptor=getNSDescriptor(nsFromEmptyPrefix,false);
      final XmlElementDescriptor descriptor=nsDescriptor != null ? nsDescriptor.getElementDescriptor(this) : null;
      final String nameFromRealDescriptor=descriptor != null && descriptor.getDeclaration() != null && descriptor.getDeclaration().isPhysical() ? descriptor.getName() : "";
      if (nameFromRealDescriptor.equals(getName()))       return nsFromEmptyPrefix;
    }
  finally {
      ourGetNsByPrefixRecursionLock.set(null);
    }
  }
  return XmlUtil.EMPTY_URI;
}
