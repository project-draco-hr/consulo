{
  w.lock();
  try {
    DbConnection.markDirty();
    final int next=getRecords().getInt(HEADER_FREE_RECORD_OFFSET);
    if (next == 0) {
      final int filelength=(int)getRecords().length();
      LOG.assertTrue(filelength % RECORD_SIZE == 0);
      int result=filelength / RECORD_SIZE;
      DbConnection.cleanRecord(result);
      return result;
    }
 else {
      getRecords().putInt(HEADER_FREE_RECORD_OFFSET,getNextFree(next));
      setNextFree(next,0);
      return next;
    }
  }
 catch (  IOException e) {
    throw DbConnection.handleError(e);
  }
 finally {
    w.unlock();
  }
}
