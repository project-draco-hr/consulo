{
  final List<OrderRoot> result=new ArrayList<OrderRoot>();
  final List<SuggestedChildRootInfo> suggestedRoots=new ArrayList<SuggestedChildRootInfo>();
  new Task.Modal(project,"Scanning for Roots",true){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      for (      RootDetector detector : detectors) {
        for (        VirtualFile rootCandidate : rootCandidates) {
          final Collection<VirtualFile> roots=detector.detectRoots(rootCandidate,indicator);
          final VirtualFile first=ContainerUtil.getFirstItem(roots);
          if (first != null && roots.size() == 1 && first.equals(rootCandidate)) {
            result.add(new OrderRoot(first,detector.getRootType(),detector.isJarDirectory()));
          }
 else {
            for (            VirtualFile root : roots) {
              suggestedRoots.add(new SuggestedChildRootInfo(detector,rootCandidate,root));
            }
          }
        }
      }
    }
  }
.queue();
  if (!suggestedRoots.isEmpty()) {
    final DetectedSourceRootsDialog dialog=new DetectedSourceRootsDialog(parentComponent,suggestedRoots);
    dialog.show();
    if (!dialog.isOK()) {
      return result;
    }
    for (    SuggestedChildRootInfo rootInfo : dialog.getChosenRoots()) {
      result.add(new OrderRoot(rootInfo.getSuggestedRoot(),rootInfo.getDetector().getRootType(),rootInfo.getDetector().isJarDirectory()));
    }
  }
  return result;
}
