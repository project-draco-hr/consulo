{
  final List<OrderRoot> result=new ArrayList<OrderRoot>();
  final List<SuggestedChildRootInfo> suggestedRoots=new ArrayList<SuggestedChildRootInfo>();
  new Task.Modal(project,"Scanning for Roots",true){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      for (      RootDetector detector : detectors) {
        for (        VirtualFile rootCandidate : rootCandidates) {
          final Collection<VirtualFile> roots=detector.detectRoots(rootCandidate,indicator);
          final VirtualFile first=ContainerUtil.getFirstItem(roots);
          if (first != null && roots.size() == 1 && first.equals(rootCandidate)) {
            result.add(new OrderRoot(first,detector.getRootType(),detector.isJarDirectory()));
          }
 else {
            for (            VirtualFile root : roots) {
              suggestedRoots.add(new SuggestedChildRootInfo(detector,rootCandidate,root));
            }
          }
        }
      }
    }
  }
.queue();
  if (!suggestedRoots.isEmpty()) {
    final DetectedRootsChooserDialog dialog=parentComponent != null ? new DetectedRootsChooserDialog(parentComponent,suggestedRoots) : new DetectedRootsChooserDialog(project,suggestedRoots);
    dialog.show();
    if (!dialog.isOK()) {
      return Collections.emptyList();
    }
    for (    SuggestedChildRootInfo rootInfo : dialog.getChosenRoots()) {
      result.add(new OrderRoot(rootInfo.getSuggestedRoot(),rootInfo.getDetector().getRootType(),rootInfo.getDetector().isJarDirectory()));
    }
  }
  if (result.isEmpty() && allowUserToSelectRootTypeIfNothingIsDetected) {
    List<String> names=new ArrayList<String>();
    for (    RootDetector detector : detectors) {
      names.add(detector.getPresentableRootTypeName());
    }
    final int i=Messages.showChooseDialog("Choose category for selected files:","Attach Files",ArrayUtil.toStringArray(names),names.get(0),null);
    if (i != -1) {
      final RootDetector detector=detectors.get(i);
      for (      VirtualFile candidate : rootCandidates) {
        result.add(new OrderRoot(candidate,detector.getRootType(),detector.isJarDirectory()));
      }
    }
  }
  return result;
}
