{
  VisualPosition visStart=new VisualPosition(line,0);
  LogicalPosition logStart=editor.visualToLogicalPosition(visStart);
  int lastLogLine=logStart.line;
  while (lastLogLine < editor.getDocument().getLineCount() - 1) {
    logStart=new LogicalPosition(logStart.line + 1,logStart.column);
    VisualPosition tryVisible=editor.logicalToVisualPosition(logStart);
    if (tryVisible.line != visStart.line)     break;
    lastLogLine=logStart.line;
  }
  int lastLine=editor.getDocument().getLineCount() - 1;
  if (lastLine < 0) {
    return 0;
  }
  return editor.offsetToVisualPosition(editor.getDocument().getLineEndOffset(Math.min(lastLogLine,lastLine))).column;
}
