{
  final Module moduleA=createModule("a.iml");
  final Module moduleB=createModule("b.iml");
  assertEventsCount(2);
  final Library libraryA=libraryTable.createLibrary("A");
  final Library.ModifiableModel libraryModifiableModel=libraryA.getModifiableModel();
  libraryModifiableModel.addRoot("file:///a",OrderRootType.CLASSES);
  libraryModifiableModel.commit();
  assertEventsCount(0);
  final ModifiableRootModel rootModelA=ModuleRootManager.getInstance(moduleA).getModifiableModel();
  final ModifiableRootModel rootModelB=ModuleRootManager.getInstance(moduleB).getModifiableModel();
  rootModelA.addLibraryEntry(libraryA);
  rootModelB.addLibraryEntry(libraryA);
  final Library.ModifiableModel libraryModifiableModel2=libraryA.getModifiableModel();
  libraryModifiableModel2.addRoot("file:///b",OrderRootType.CLASSES);
  libraryModifiableModel2.commit();
  assertEventsCount(0);
  libraryTable.removeLibrary(libraryA);
  assertEventsCount(0);
  rootModelA.addInvalidLibrary("Q",libraryTable.getTableLevel());
  rootModelB.addInvalidLibrary("Q",libraryTable.getTableLevel());
  assertEventsCount(0);
  final Library libraryQ=libraryTable.createLibrary("Q");
  assertEventsCount(0);
  ModifiableRootModel[] rootModels=new ModifiableRootModel[]{rootModelA,rootModelB};
  if (rootModels.length > 0) {
    ModifiableModelCommitter.multiCommit(rootModels,ModuleManager.getInstance(rootModels[0].getProject()).getModifiableModel());
  }
  assertEventsCount(1);
  libraryTable.removeLibrary(libraryQ);
  assertEventsCount(1);
}
