{
  if (elementToCopy instanceof PsiFile) {
    PsiFile file=(PsiFile)elementToCopy;
    if (newName != null) {
      file=(PsiFile)file.copy();
      file=(PsiFile)file.setName(newName);
    }
    PsiFile newFile=(PsiFile)targetDirectory.add(file);
    return newFile;
  }
 else   if (elementToCopy instanceof PsiDirectory) {
    PsiDirectory directory=(PsiDirectory)elementToCopy;
    if (directory.equals(targetDirectory)) {
      return null;
    }
    PsiDirectory subdirectory=targetDirectory.createSubdirectory(newName == null ? directory.getName() : newName);
    PsiFile firstFile=null;
    PsiElement[] children=directory.getChildren();
    for (int i=0; i < children.length; i++) {
      PsiElement child=children[i];
      PsiFile f=copyToDirectory(child,null,subdirectory);
      if (firstFile == null) {
        firstFile=f;
      }
    }
    return firstFile;
  }
 else {
    throw new IllegalArgumentException("unexpected elementToCopy: " + elementToCopy);
  }
}
