{
  VirtualFile hgDir=repository.getHgDir();
  myWatchRequest=LocalFileSystem.getInstance().addRootToWatch(hgDir.getPath(),true);
  myRepositoryFiles=HgRepositoryFiles.getInstance(hgDir);
  RepositoryUtil.visitVcsDirVfs(hgDir,HgRepositoryFiles.getSubDirRelativePaths());
  myBranchHeadsDir=VcsUtil.getVirtualFile(myRepositoryFiles.getBranchHeadsDirPath());
  Project project=repository.getProject();
  myUpdateQueue=new QueueProcessor<Object>(new RepositoryUtil.Updater(repository),project.getDisposed());
  myUpdateConfigQueue=new QueueProcessor<Object>(new Consumer<Object>(){
    @Override public void consume(    Object dummy){
      repository.updateConfig();
    }
  }
,project.getDisposed());
  if (!project.isDisposed()) {
    myMessageBusConnection=project.getMessageBus().connect();
    myMessageBusConnection.subscribe(VirtualFileManager.VFS_CHANGES,this);
  }
 else {
    myMessageBusConnection=null;
  }
}
