{
  DataContext dataContext=e.getDataContext();
  final Project project=DataKeys.PROJECT.getData(dataContext);
  final Module module=DataKeys.MODULE.getData(dataContext);
  if (project != null) {
    PsiFile psiFile=DataKeys.PSI_FILE.getData(dataContext);
    if (psiFile != null && !(psiFile instanceof PsiJavaFile)) {
      return;
    }
    AnalysisScope scope=getInspectionScope(dataContext);
    if (scope == null || scope.getScopeType() != AnalysisScope.MODULES) {
      ProjectModuleOrPackageDialog dlg=new ProjectModuleOrPackageDialog(module != null ? ModuleUtil.getModuleNameInReadAction(module) : null);
      dlg.show();
      if (!dlg.isOK())       return;
      if (dlg.isProjectScopeSelected()) {
        scope=getProjectScope(dataContext);
      }
 else {
        if (dlg.isModuleScopeSelected()) {
          scope=getModuleScope(dataContext);
        }
      }
    }
    FileDocumentManager.getInstance().saveAllDocuments();
    new CyclicDependenciesHandler(project,scope).analyze();
  }
}
