{
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
  final VirtualFile vFile=dir.getVirtualFile();
  final Set<Module> modules=new HashSet<Module>();
  final Module module=fileIndex.getModuleForFile(vFile);
  if (module != null) {
    modules.add(module);
  }
  if (fileIndex.isInLibrarySource(vFile) || fileIndex.isInLibraryClasses(vFile)) {
    final OrderEntry[] orderEntries=fileIndex.getOrderEntriesForFile(vFile);
    if (orderEntries.length == 0) {
      return Module.EMPTY_ARRAY;
    }
    for (int j=0; j < orderEntries.length; j++) {
      modules.add(orderEntries[j].getOwnerModule());
    }
  }
  return modules.toArray(new Module[modules.size()]);
}
