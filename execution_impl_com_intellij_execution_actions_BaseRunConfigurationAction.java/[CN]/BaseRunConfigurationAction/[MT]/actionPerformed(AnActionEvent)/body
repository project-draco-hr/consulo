{
  final DataContext dataContext=e.getDataContext();
  final ConfigurationContext context=new ConfigurationContext(dataContext);
  final RunnerAndConfigurationSettingsImpl existing=context.findExisting();
  if (existing == null) {
    final List<RuntimeConfigurationProducer> producers=PreferedProducerFind.findPreferedProducers(context.getLocation(),context);
    if (producers == null || producers.size() == 0)     return;
    final RuntimeConfigurationProducer first=producers.get(0);
    for (Iterator<RuntimeConfigurationProducer> it=producers.iterator(); it.hasNext(); ) {
      RuntimeConfigurationProducer producer=it.next();
      if (RuntimeConfigurationProducer.COMPARATOR.compare(producer,first) >= 0) {
        it.remove();
      }
    }
    if (producers.size() > 1) {
      final Editor editor=(Editor)dataContext.getData(DataConstants.EDITOR);
      final ListPopup popup=JBPopupFactory.getInstance().createListPopup(new BaseListPopupStep<RuntimeConfigurationProducer>(ExecutionBundle.message("configuration.action.chooser.title"),producers){
        @NotNull public String getTextFor(        final RuntimeConfigurationProducer producer){
          return producer.getConfigurationType().getDisplayName();
        }
        public Icon getIconFor(        final RuntimeConfigurationProducer producer){
          return producer.getConfigurationType().getIcon();
        }
        public PopupStep onChosen(        final RuntimeConfigurationProducer producer,        final boolean finalChoice){
          final RunnerAndConfigurationSettings configuration=context.getConfiguration(producer);
          if (configuration != null) {
            perform(context);
          }
          return PopupStep.FINAL_CHOICE;
        }
      }
);
      if (editor != null) {
        popup.showInBestPositionFor(editor);
      }
 else {
        popup.showInBestPositionFor(dataContext);
      }
      return;
    }
  }
  final RunnerAndConfigurationSettingsImpl configuration=existing != null ? existing : context.getConfiguration();
  if (configuration == null)   return;
  perform(context);
}
