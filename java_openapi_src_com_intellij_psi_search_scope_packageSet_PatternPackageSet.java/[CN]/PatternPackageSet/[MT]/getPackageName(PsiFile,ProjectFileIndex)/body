{
  VirtualFile virtualFile=file.getVirtualFile();
  if (fileIndex.isInLibrarySource(virtualFile)) {
    return StringUtil.getQualifiedName(fileIndex.getPackageNameByDirectory(virtualFile.getParent()),virtualFile.getNameWithoutExtension());
  }
  if (file instanceof PsiJavaFile)   return StringUtil.getQualifiedName(((PsiJavaFile)file).getPackageName(),virtualFile.getNameWithoutExtension());
  PsiDirectory dir=file.getContainingDirectory();
  PsiPackage aPackage=JavaDirectoryService.getInstance().getPackage(dir);
  return aPackage == null ? file.getName() : StringUtil.getQualifiedName(aPackage.getQualifiedName(),virtualFile.getNameWithoutExtension());
}
