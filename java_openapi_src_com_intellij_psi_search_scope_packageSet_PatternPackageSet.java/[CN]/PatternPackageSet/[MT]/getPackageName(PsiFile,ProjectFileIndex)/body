{
  VirtualFile virtualFile=file.getVirtualFile();
  if (fileIndex.isInLibrarySource(virtualFile)) {
    return fileIndex.getPackageNameByDirectory(virtualFile.getParent()) + "." + virtualFile.getNameWithoutExtension();
  }
  if (file instanceof PsiJavaFile)   return ((PsiJavaFile)file).getPackageName() + "." + virtualFile.getNameWithoutExtension();
  PsiDirectory dir=file.getContainingDirectory();
  PsiPackage aPackage=JavaDirectoryService.getInstance().getPackage(dir);
  return aPackage == null ? file.getName() : aPackage.getQualifiedName() + "." + virtualFile.getNameWithoutExtension();
}
