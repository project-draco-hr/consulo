{
  if (files == null || files.length == 0) {
    return VirtualFile.EMPTY_ARRAY;
  }
  final PsiManager psiManager=PsiManager.getInstance(project);
  final CompilerConfiguration compilerConfiguration=CompilerConfiguration.getInstance(project);
  final FileTypeManager typeManager=FileTypeManager.getInstance();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final CompilerManager compilerManager=CompilerManager.getInstance(project);
  final List<VirtualFile> filesToCompile=new ArrayList<VirtualFile>();
  for (  final VirtualFile file : files) {
    if (!fileIndex.isInSourceContent(file)) {
      continue;
    }
    if (!file.isInLocalFileSystem()) {
      continue;
    }
    if (file.isDirectory()) {
      final PsiDirectory directory=psiManager.findDirectory(file);
      if (directory == null || JavaDirectoryService.getInstance().getPackage(directory) == null) {
        continue;
      }
    }
 else {
      FileType fileType=typeManager.getFileTypeByFile(file);
      if (!(compilerManager.isCompilableFileType(fileType) || compilerConfiguration.isResourceFile(file.getName()))) {
        continue;
      }
    }
    filesToCompile.add(file);
  }
  return filesToCompile.size() > 0 ? filesToCompile.toArray(new VirtualFile[filesToCompile.size()]) : VirtualFile.EMPTY_ARRAY;
}
