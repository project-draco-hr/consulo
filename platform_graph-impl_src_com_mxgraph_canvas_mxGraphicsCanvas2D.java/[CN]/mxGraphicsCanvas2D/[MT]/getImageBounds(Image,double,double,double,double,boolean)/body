{
  x=(state.dx + x) * state.scale;
  y=(state.dy + y) * state.scale;
  w*=state.scale;
  h*=state.scale;
  if (aspect) {
    Dimension size=getImageSize(img);
    double s=Math.min(w / size.width,h / size.height);
    int sw=(int)Math.round(size.width * s);
    int sh=(int)Math.round(size.height * s);
    x+=(w - sw) / 2;
    y+=(h - sh) / 2;
    w=sw;
    h=sh;
  }
 else {
    w=Math.round(w);
    h=Math.round(h);
  }
  return new Rectangle((int)x,(int)y,(int)w,(int)h);
}
