{
  VisualPosition visualPosition=editor.getUserData(ANCHOR_POPUP_POSITION);
  if (visualPosition == null) {
    CaretModel caretModel=editor.getCaretModel();
    if (caretModel.isUpToDate()) {
      visualPosition=caretModel.getVisualPosition();
    }
 else {
      visualPosition=editor.offsetToVisualPosition(caretModel.getOffset());
    }
  }
  Point p=editor.visualPositionToXY(new VisualPosition(visualPosition.line + 1,visualPosition.column));
  final Rectangle visibleArea=editor.getScrollingModel().getVisibleArea();
  if (!visibleArea.contains(p)) {
    p=new Point((visibleArea.x + visibleArea.width) / 2,(visibleArea.y + visibleArea.height) / 2);
  }
  return new RelativePoint(editor.getContentComponent(),p);
}
