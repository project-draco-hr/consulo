{
  FormattingDocumentModel documentModel=model.getDocumentModel();
  Document document=documentModel.getDocument();
  if (document == null) {
    return false;
  }
  List<TextChange> changes=new ArrayList<TextChange>();
  for (  LeafBlockWrapper block : blocksToModify) {
    WhiteSpace whiteSpace=block.getWhiteSpace();
    CharSequence newWs=documentModel.adjustWhiteSpaceIfNecessary(whiteSpace.generateWhiteSpace(indentOption),whiteSpace.getStartOffset(),whiteSpace.getEndOffset());
    changes.add(new TextChangeImpl(newWs,whiteSpace.getStartOffset(),whiteSpace.getEndOffset()));
  }
  CharSequence mergeResult=ourBulkChangesMerger.merge(document.getChars(),document.getTextLength(),changes);
  if (myBulkReformatListener != null) {
    myBulkReformatListener.beforeProcessing(document,mergeResult);
  }
  document.replaceString(0,document.getTextLength(),mergeResult);
  cleanupBlocks(blocksToModify);
  if (myBulkReformatListener != null) {
    myBulkReformatListener.afterProcessing();
  }
  return true;
}
