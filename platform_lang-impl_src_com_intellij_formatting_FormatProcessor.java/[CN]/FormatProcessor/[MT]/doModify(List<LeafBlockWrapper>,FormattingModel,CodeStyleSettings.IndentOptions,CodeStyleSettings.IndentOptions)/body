{
  final int blocksToModifyCount=blocksToModify.size();
  DocumentEx updatedDocument=null;
  try {
    final boolean bulkReformat=blocksToModifyCount > 50;
    updatedDocument=bulkReformat ? getAffectedDocument(model) : null;
    if (updatedDocument != null) {
      updatedDocument.setInBulkUpdate(true);
    }
    if (blocksToModifyCount > BULK_REPLACE_OPTIMIZATION_CRITERIA) {
      if (applyChangesAtBulkMode(blocksToModify,model,indentOption)) {
        return;
      }
    }
    int shift=0;
    for (int i=0; i < blocksToModifyCount; ++i) {
      final LeafBlockWrapper block=blocksToModify.get(i);
      shift=replaceWhiteSpace(model,block,shift,block.getWhiteSpace().generateWhiteSpace(indentOption),javaOptions);
      block.getParent().dispose();
      block.dispose();
      blocksToModify.set(i,null);
    }
  }
  finally {
    if (updatedDocument != null) {
      updatedDocument.setInBulkUpdate(false);
    }
    model.commitChanges();
  }
}
