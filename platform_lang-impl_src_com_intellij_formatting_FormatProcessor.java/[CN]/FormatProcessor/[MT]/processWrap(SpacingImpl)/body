{
  final WhiteSpace whiteSpace=myCurrentBlock.getWhiteSpace();
  boolean wrapWasPresent=whiteSpace.containsLineFeeds();
  if (wrapWasPresent) {
    myFirstWrappedBlockOnLine=null;
  }
  if (whiteSpace.containsLineFeeds() && !whiteSpace.containsLineFeedsInitially()) {
    whiteSpace.removeLineFeeds(spacing,this);
  }
  boolean wrapIsPresent=whiteSpace.containsLineFeeds();
  final ArrayList<WrapImpl> wraps=myCurrentBlock.getWraps();
  final int wrapsCount=wraps.size();
  for (int i=0; i < wrapsCount; ++i) {
    wraps.get(i).processNextEntry(myCurrentBlock.getStartOffset());
  }
  final WrapImpl wrap=getWrapToBeUsed(wraps);
  if (wrap != null || wrapIsPresent) {
    if (!wrapIsPresent && !canReplaceWrapCandidate(wrap)) {
      myCurrentBlock=myWrapCandidate;
      return true;
    }
    if (wrap != null && wrap.getFirstEntry() != null) {
      myCurrentBlock=getFirstBlockOnNewLine();
      wrap.markAsUsed();
      return true;
    }
    if (wrap != null && wrapCanBeUsedInTheFuture(wrap)) {
      wrap.markAsUsed();
    }
    if (!whiteSpace.containsLineFeeds()) {
      whiteSpace.ensureLineFeed();
      if (!wrapWasPresent && wrap != null) {
        if (myFirstWrappedBlockOnLine != null && wrap.isChildOf(myFirstWrappedBlockOnLine.getWrap(),myCurrentBlock)) {
          wrap.ignoreParentWrap(myFirstWrappedBlockOnLine.getWrap(),myCurrentBlock);
          myCurrentBlock=myFirstWrappedBlockOnLine;
          return true;
        }
 else {
          myFirstWrappedBlockOnLine=myCurrentBlock;
        }
      }
    }
    myWrapCandidate=null;
  }
 else {
    for (int i=0; i < wrapsCount; ++i) {
      final WrapImpl wrap1=wraps.get(i);
      if (isCandidateToBeWrapped(wrap1) && canReplaceWrapCandidate(wrap1)) {
        myWrapCandidate=myCurrentBlock;
      }
      if (wrapCanBeUsedInTheFuture(wrap1)) {
        wrap1.saveFirstEntry(myCurrentBlock);
      }
    }
  }
  if (!whiteSpace.containsLineFeeds() && myWrapCandidate != null && !whiteSpace.isReadOnly() && lineOver()) {
    myCurrentBlock=myWrapCandidate;
    return true;
  }
  return false;
}
