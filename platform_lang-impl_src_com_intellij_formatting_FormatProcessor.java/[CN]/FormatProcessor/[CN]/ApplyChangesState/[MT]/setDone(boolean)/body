{
  super.setDone(done);
  if (myResetBulkUpdateState) {
    DocumentEx document=getAffectedDocument(myModel);
    if (document != null) {
      document.setInBulkUpdate(false);
      myResetBulkUpdateState=false;
    }
  }
  if (done) {
    myModel.commitChanges();
    if (myModel instanceof PsiBasedFormattingModel) {
      PsiBasedFormattingModel psiModel=((PsiBasedFormattingModel)myModel);
      final ASTNode rootNode=psiModel.getRootNode();
      if (rootNode == null) {
        return;
      }
      final PsiElement psi=rootNode.getPsi();
      if (psi == null) {
        return;
      }
      if (ProjectManager.getInstance().getDefaultProject() != psi.getProject()) {
        return;
      }
      final Document document=psiModel.getDocumentModel().getDocument();
      if (!document.getText().equals(rootNode.getText()) && ApplicationManager.getApplication().isDispatchThread()) {
        document.setText(rootNode.getText());
      }
    }
  }
}
