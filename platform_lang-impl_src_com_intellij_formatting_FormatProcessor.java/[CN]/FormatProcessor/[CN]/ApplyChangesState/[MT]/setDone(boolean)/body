{
  super.setDone(done);
  if (myResetBulkUpdateState) {
    DocumentEx document=getAffectedDocument(myModel);
    if (document != null) {
      document.setInBulkUpdate(false);
      myResetBulkUpdateState=false;
    }
  }
  if (done) {
    myModel.commitChanges();
    if (myModel instanceof PsiBasedFormattingModel) {
      PsiBasedFormattingModel psiModel=((PsiBasedFormattingModel)myModel);
      final ASTNode rootNode=psiModel.getRootNode();
      final Document document=psiModel.getDocumentModel().getDocument();
      if (rootNode != null && !document.getText().equals(rootNode.getText())) {
        document.setText(rootNode.getText());
      }
    }
  }
}
