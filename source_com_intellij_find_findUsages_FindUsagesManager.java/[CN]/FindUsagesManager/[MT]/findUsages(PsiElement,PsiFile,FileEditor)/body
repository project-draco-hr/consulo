{
  PsiElement[] elementsToSearch=null;
  PsiElement[] secondaryElementsToSearch=null;
  if (!canFindUsages(psiElement)) {
    return;
  }
  if (psiElement instanceof PsiDirectory) {
    PsiPackage psiPackage=((PsiDirectory)psiElement).getPackage();
    if (psiPackage == null) {
      return;
    }
    psiElement=psiPackage;
  }
  boolean isOpenInNewTabEnabled;
  boolean toOpenInNewTab;
  Content selectedContent=UsageViewManager.getInstance(myProject).getSelectedContent(true);
  if (selectedContent != null && selectedContent.isPinned()) {
    toOpenInNewTab=true;
    isOpenInNewTabEnabled=false;
  }
 else {
    toOpenInNewTab=myToOpenInNewTab;
    isOpenInNewTabEnabled=(UsageViewManager.getInstance(myProject).getReusableContentsCount() > 0);
  }
  final String actionString=FindBundle.message("find.super.method.warning.action.verb");
  if (psiElement instanceof PsiMethod) {
    final PsiMethod[] methods=SuperMethodWarningUtil.checkSuperMethods((PsiMethod)psiElement,actionString);
    if (methods.length > 1) {
      elementsToSearch=methods;
    }
 else     if (methods.length == 1) {
      psiElement=methods[0];
    }
 else {
      return;
    }
  }
  if (psiElement == null) {
    return;
  }
  final FindUsagesDialog dialog=getFindUsagesDialog(psiElement,scopeFile != null,toOpenInNewTab,isOpenInNewTabEnabled);
  if (dialog == null) {
    return;
  }
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  if (isOpenInNewTabEnabled) {
    myToOpenInNewTab=toOpenInNewTab=dialog.isShowInSeparateWindow();
  }
  FindUsagesOptions findUsagesOptions=dialog.calcFindUsagesOptions();
  if (scopeFile != null) {
    findUsagesOptions=(FindUsagesOptions)findUsagesOptions.clone();
    findUsagesOptions.isDerivedClasses=false;
    findUsagesOptions.isDerivedInterfaces=false;
    findUsagesOptions.isImplementingClasses=false;
  }
  clearFindingNextUsageInFile();
  LOG.assertTrue(psiElement.isValid());
  if (psiElement instanceof PsiParameter) {
    final PsiParameter parameter=(PsiParameter)psiElement;
    final PsiElement scope=parameter.getDeclarationScope();
    if (scope instanceof PsiMethod) {
      final PsiMethod method=(PsiMethod)scope;
      if (PsiUtil.canBeOverriden(method)) {
        final PsiClass aClass=method.getContainingClass();
        LOG.assertTrue(aClass != null);
        final boolean findInInheritors;
        if (aClass.isInterface() || method.hasModifierProperty(PsiModifier.ABSTRACT)) {
          findInInheritors=true;
        }
 else {
          findInInheritors=Messages.showDialog(psiElement.getProject(),FindBundle.message("find.parameter.usages.in.overriding.methods.prompt",parameter.getName()),FindBundle.message("find.parameter.usages.in.overriding.methods.title"),new String[]{CommonBundle.getYesButtonText(),CommonBundle.getNoButtonText()},0,Messages.getQuestionIcon()) == 0;
        }
        if (findInInheritors) {
          elementsToSearch=getParameterElementsToSearch(parameter);
        }
      }
    }
  }
 else   if (psiElement instanceof PsiField) {
    final PsiField field=(PsiField)psiElement;
    if (field.getContainingClass() != null && field.getType() != null) {
      final String propertyName=field.getManager().getCodeStyleManager().variableNameToPropertyName(field.getName(),VariableKind.FIELD);
      PsiMethod getter=PropertyUtil.findPropertyGetterWithType(propertyName,field.hasModifierProperty(PsiModifier.STATIC),field.getType(),ContainerUtil.iterate(field.getContainingClass().getMethods()));
      PsiMethod setter=PropertyUtil.findPropertySetterWithType(propertyName,field.hasModifierProperty(PsiModifier.STATIC),field.getType(),ContainerUtil.iterate(field.getContainingClass().getMethods()));
      if (getter != null || setter != null) {
        if (Messages.showDialog(FindBundle.message("find.field.accessors.prompt",field.getName()),FindBundle.message("find.field.accessors.title"),new String[]{CommonBundle.getYesButtonText(),CommonBundle.getNoButtonText()},0,Messages.getQuestionIcon()) == DialogWrapper.OK_EXIT_CODE) {
          final List<PsiElement> elements=new ArrayList<PsiElement>();
          if (getter != null) {
            elements.addAll(Arrays.asList(SuperMethodWarningUtil.checkSuperMethods(getter,actionString)));
          }
          if (setter != null) {
            elements.addAll(Arrays.asList(SuperMethodWarningUtil.checkSuperMethods(setter,actionString)));
          }
          secondaryElementsToSearch=elements.toArray(new PsiElement[elements.size()]);
        }
      }
    }
  }
  if (elementsToSearch == null) {
    elementsToSearch=new PsiElement[]{psiElement};
  }
  final UsageInfoToUsageConverter.TargetElementsDescriptor descriptor=new UsageInfoToUsageConverter.TargetElementsDescriptor(elementsToSearch,secondaryElementsToSearch);
  if (scopeFile == null) {
    findUsages(descriptor,dialog.isSkipResultsWhenOneUsage(),toOpenInNewTab,findUsagesOptions);
  }
 else {
    editor.putUserData(KEY_START_USAGE_AGAIN,null);
    findUsagesInEditor(descriptor,scopeFile,FROM_START,findUsagesOptions,editor);
  }
}
