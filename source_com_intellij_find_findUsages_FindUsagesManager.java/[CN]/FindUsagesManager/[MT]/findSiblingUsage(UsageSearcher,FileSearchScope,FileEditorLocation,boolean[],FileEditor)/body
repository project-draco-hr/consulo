{
  final Usage[] foundUsage=new Usage[]{null};
  if (fileEditor.getUserData(KEY_START_USAGE_AGAIN) != null) {
    if (dir == AFTER_CARET) {
      dir=FROM_START;
    }
 else {
      dir=FROM_END;
    }
  }
  final FileSearchScope direction=dir;
  usageSearcher.generate(new Processor<Usage>(){
    public boolean process(    Usage usage){
      usagesWereFound[0]=true;
      if (direction == FROM_START) {
        foundUsage[0]=usage;
        return false;
      }
 else       if (direction == FROM_END) {
        foundUsage[0]=usage;
      }
 else       if (direction == AFTER_CARET) {
        if (usage.getLocation().compareTo(currentLocation) > 0) {
          foundUsage[0]=usage;
          return false;
        }
      }
 else       if (direction == BEFORE_CARET) {
        if (usage.getLocation().compareTo(currentLocation) < 0) {
          if (foundUsage[0] != null) {
            if (foundUsage[0].getLocation().compareTo(usage.getLocation()) < 0) {
              foundUsage[0]=usage;
            }
          }
 else {
            foundUsage[0]=usage;
          }
        }
 else {
          return false;
        }
      }
      return true;
    }
  }
);
  fileEditor.putUserData(KEY_START_USAGE_AGAIN,null);
  Usage fUsage=foundUsage[0];
  return fUsage;
}
