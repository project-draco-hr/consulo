{
  startElement(expression);
  try {
    DfaValue dfaValue=myFactory.create(expression);
    if (dfaValue != null) {
      addInstruction(new PushInstruction(dfaValue));
    }
 else {
      IElementType op=expression.getOperationSign().getTokenType();
      PsiExpression lExpr=expression.getLOperand();
      PsiExpression rExpr=expression.getROperand();
      if (rExpr == null) {
        pushUnknown();
        return;
      }
      PsiType type=expression.getType();
      if (op == JavaTokenType.ANDAND) {
        generateAndExpression(lExpr,rExpr,type);
      }
 else       if (op == JavaTokenType.OROR) {
        generateOrExpression(lExpr,rExpr,type);
      }
 else       if (op == JavaTokenType.XOR && type == PsiType.BOOLEAN) {
        generateXorExpression(expression,lExpr,rExpr,type);
      }
 else {
        lExpr.accept(this);
        boolean comparingRef=(op == JavaTokenType.EQEQ || op == JavaTokenType.NE) && !TypeConversionUtil.isPrimitiveAndNotNull(lExpr.getType()) && !TypeConversionUtil.isPrimitiveAndNotNull(rExpr.getType());
        if (!comparingRef) {
          generateBoxingUnboxingInstructionFor(lExpr,type);
        }
        rExpr.accept(this);
        if (!comparingRef) {
          generateBoxingUnboxingInstructionFor(rExpr,type);
        }
        String opSign=expression.getOperationSign().getText();
        if ("+".equals(opSign)) {
          if (!type.equalsToText("java.lang.String")) {
            opSign=null;
          }
        }
        addInstruction(new BinopInstruction(opSign,expression.isPhysical() ? expression : null));
      }
    }
  }
  finally {
    finishElement(expression);
  }
}
