{
  final Object LOCK=new Object();
  final AtomicBoolean completed=new AtomicBoolean();
  if (modal) {
    final ModalTask task=new ModalTask(myProject,myHandler,myTitle){
      @Override public void onSuccess(){
        commonOnSuccess(LOCK,resultHandler);
        completed.set(true);
      }
      @Override public void onCancel(){
        commonOnCancel(LOCK,resultHandler);
        completed.set(true);
      }
    }
;
    ApplicationManager.getApplication().invokeAndWait(new Runnable(){
      @Override public void run(){
        ProgressManager.getInstance().run(task);
      }
    }
,ModalityState.defaultModalityState());
  }
 else {
    final BackgroundableTask task=new BackgroundableTask(myProject,myHandler,myTitle){
      @Override public void onSuccess(){
        commonOnSuccess(LOCK,resultHandler);
        completed.set(true);
      }
      @Override public void onCancel(){
        commonOnCancel(LOCK,resultHandler);
        completed.set(true);
      }
    }
;
    if (myProgressIndicator == null) {
      GitVcs.runInBackground(task);
    }
 else {
      task.runAlone();
    }
  }
  if (sync) {
    while (!completed.get()) {
      try {
synchronized (LOCK) {
          LOCK.wait(50);
        }
      }
 catch (      InterruptedException e) {
        LOG.info(e);
      }
    }
  }
}
