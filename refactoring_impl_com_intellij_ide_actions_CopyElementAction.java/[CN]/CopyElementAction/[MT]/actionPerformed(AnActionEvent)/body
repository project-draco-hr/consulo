{
  final DataContext dataContext=e.getDataContext();
  final Project project=(Project)dataContext.getData(DataConstants.PROJECT);
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      PsiDocumentManager.getInstance(project).commitAllDocuments();
    }
  }
,"",null);
  PsiElement[] elements;
  PsiDirectory defaultTargetDirectory;
  if (ToolWindowManager.getInstance(project).isEditorComponentActive()) {
    Editor editor=(Editor)dataContext.getData(DataConstants.EDITOR);
    PsiClass aClass=getTopLevelClass(editor,project);
    PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    elements=new PsiElement[]{aClass};
    if (aClass == null || !CopyHandler.canCopy(elements)) {
      elements=new PsiElement[]{file};
    }
    defaultTargetDirectory=file.getContainingDirectory();
  }
 else {
    Object element=dataContext.getData(DataConstantsEx.TARGET_PSI_ELEMENT);
    defaultTargetDirectory=element instanceof PsiDirectory ? (PsiDirectory)element : null;
    elements=(PsiElement[])dataContext.getData(DataConstantsEx.PSI_ELEMENT_ARRAY);
  }
  doCopy(elements,defaultTargetDirectory);
}
