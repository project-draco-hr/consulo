{
  Charset utf8Charset=Charset.forName("UTF-8");
  VirtualFile virtualFile=CvsVfsUtil.findFileByIoFile(targetFile);
  if (myReceivedFileProcessor.shouldProcess(virtualFile,targetFile)) {
    PrintStream target=new PrintStream(new BufferedOutputStream(new FileOutputStream(targetFile)));
    try {
      String lineSeparator=getLineSeparatorFor(targetFile);
      byte[] lineSeparatorBytes=null;
      if (charSet != null) {
        lineSeparatorBytes=charSet.encode(lineSeparator).array();
      }
      Collection<byte[]> lines=new LineReader().readLines(new BufferedInputStream(new FileInputStream(textFileSource)));
      for (Iterator<byte[]> each=lines.iterator(); each.hasNext(); ) {
        final byte[] bytes=each.next();
        if (charSet == null) {
          target.write(bytes);
        }
 else {
          target.write(charSet.encode(utf8Charset.decode(ByteBuffer.wrap(bytes))).array());
        }
        if (each.hasNext()) {
          if (charSet == null)           target.print(lineSeparator);
 else           target.write(lineSeparatorBytes);
        }
      }
    }
  finally {
      target.close();
    }
  }
}
