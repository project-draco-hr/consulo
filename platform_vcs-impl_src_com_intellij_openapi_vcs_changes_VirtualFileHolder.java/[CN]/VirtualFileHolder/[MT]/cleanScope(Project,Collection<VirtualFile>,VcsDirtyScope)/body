{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      if (project.isDisposed() || files.isEmpty())       return;
      final List<VirtualFile> currentFiles=new ArrayList<VirtualFile>(files);
      if (scope.getRecursivelyDirtyDirectories().size() == 0) {
        final Set<FilePath> dirtyFiles=scope.getDirtyFiles();
        boolean cleanedDroppedFiles=false;
        for (        FilePath dirtyFile : dirtyFiles) {
          VirtualFile f=dirtyFile.getVirtualFile();
          if (f != null) {
            files.remove(f);
          }
 else {
            if (!cleanedDroppedFiles) {
              cleanedDroppedFiles=true;
              for (              VirtualFile file : currentFiles) {
                if (fileDropped(project,file))                 files.remove(file);
              }
            }
          }
        }
      }
 else {
        for (        VirtualFile file : currentFiles) {
          if (fileDropped(project,file) || scope.belongsTo(new FilePathImpl(file))) {
            files.remove(file);
          }
        }
      }
    }
  }
);
}
