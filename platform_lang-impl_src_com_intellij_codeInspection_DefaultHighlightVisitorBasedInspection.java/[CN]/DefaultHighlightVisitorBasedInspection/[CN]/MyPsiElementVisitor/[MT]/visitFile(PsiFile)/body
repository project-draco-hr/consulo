{
  final VirtualFile virtualFile=file.getVirtualFile();
  if (virtualFile == null) {
    return;
  }
  final Project project=file.getProject();
  Document document=PsiDocumentManager.getInstance(project).getDocument(file);
  if (document == null)   return;
  GeneralHighlightingPass pass=new GeneralHighlightingPass(project,file,document,0,file.getTextLength(),true){
    @NotNull @Override protected HighlightVisitor[] createHighlightVisitors(){
      return new HighlightVisitor[]{new DefaultHighlightVisitor(project,highlightErrorElements,runAnnotators)};
    }
    @Override protected HighlightInfoHolder createInfoHolder(    final PsiFile file){
      final HighlightInfoFilter[] filters=ApplicationManager.getApplication().getExtensions(HighlightInfoFilter.EXTENSION_POINT_NAME);
      return new HighlightInfoHolder(file,getColorsScheme(),filters){
        @Override public boolean add(        @Nullable HighlightInfo info){
          if (info == null)           return true;
          if (info.severity == HighlightInfoType.INJECTED_FRAGMENT_SEVERITY)           return true;
          if (info.severity == HighlightSeverity.INFORMATION)           return true;
          ProblemHighlightType problemHighlightType=HighlightInfo.convertType(info.type);
          TextRange range=new TextRange(info.startOffset,info.endOffset);
          PsiElement element=file.findElementAt(info.startOffset);
          while (element != null && !element.getTextRange().contains(range)) {
            element=element.getParent();
          }
          if (element == null) {
            element=file;
          }
          GlobalInspectionUtil.createProblem(element,info.description,problemHighlightType,range.shiftRight(-element.getTextOffset()),myManager,myProblemDescriptionsProcessor,myGlobalContext);
          return true;
        }
      }
;
    }
  }
;
  pass.setFailFastOnAcquireReadAction(false);
  DaemonProgressIndicator progress=new DaemonProgressIndicator();
  progress.start();
  pass.collectInformation(progress);
}
