{
  myPreviewRangesToHighlight.clear();
  MarkupModel markupModel=myEditor.getMarkupModel();
  markupModel.removeAllHighlighters();
  int textLength=myEditor.getDocument().getTextLength();
  boolean highlightPreview=false;
  Collection<TextRange> ranges=myDiffCalculator.calculateDiff(beforeReformat,myEditor.getDocument());
  for (  TextRange range : ranges) {
    if (range.getStartOffset() >= textLength) {
      continue;
    }
    highlightPreview=true;
    TextRange rangeToUse=calculateChangeHighlightRange(range);
    myPreviewRangesToHighlight.add(rangeToUse);
  }
  if (highlightPreview) {
    myEndHighlightPreviewChangesTimeMillis=System.currentTimeMillis() + TIME_TO_HIGHLIGHT_PREVIEW_CHANGES_IN_MILLIS;
    myShowsPreviewHighlighters=true;
  }
}
