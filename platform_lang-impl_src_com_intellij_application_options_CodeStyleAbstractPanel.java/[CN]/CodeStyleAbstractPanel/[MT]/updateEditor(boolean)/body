{
  if (!myShouldUpdatePreview || !myEditor.getComponent().isShowing()) {
    return;
  }
  if (myLastDocumentModificationStamp != myEditor.getDocument().getModificationStamp()) {
    myTextToReformat=myEditor.getDocument().getText();
  }
 else   if (useDefaultSample || myTextToReformat == null) {
    myTextToReformat=getPreviewText();
  }
  int currOffs=myEditor.getScrollingModel().getVerticalScrollOffset();
  final Project finalProject=ProjectUtil.guessCurrentProject(getPanel());
  CommandProcessor.getInstance().executeCommand(finalProject,new Runnable(){
    @Override public void run(){
      replaceText(finalProject);
    }
  }
,null,null);
  myEditor.getSettings().setRightMargin(getAdjustedRightMargin());
  myLastDocumentModificationStamp=myEditor.getDocument().getModificationStamp();
  myEditor.getScrollingModel().scrollVertically(currOffs);
}
