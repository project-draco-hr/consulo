{
  PsiFile psiFile=createFileFromText(project,myTextToReformat);
  prepareForReformat(psiFile);
  PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  Document document;
  if (documentManager != null) {
    document=documentManager.getDocument(psiFile);
    if (document != null) {
      CodeStyleSettings clone=mySettings.clone();
      clone.RIGHT_MARGIN=getAdjustedRightMargin();
      CodeStyleSettingsManager.getInstance(project).setTemporarySettings(clone);
      try {
        CodeStyleManager.getInstance(project).reformat(psiFile);
      }
  finally {
        CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
      }
      return document;
    }
  }
  return null;
}
