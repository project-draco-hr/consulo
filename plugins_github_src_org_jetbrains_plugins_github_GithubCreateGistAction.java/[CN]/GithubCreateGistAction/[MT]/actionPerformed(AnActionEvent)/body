{
  final Project project=e.getData(PlatformDataKeys.PROJECT);
  if (project == null || project.isDefault()) {
    return;
  }
  final Editor editor=e.getData(PlatformDataKeys.EDITOR);
  if (editor == null) {
    return;
  }
  final VirtualFile file=e.getData(PlatformDataKeys.VIRTUAL_FILE);
  if (file == null) {
    return;
  }
  final boolean useGitHubAccount;
  if (!GithubUtil.checkCredentials(project)) {
    final GithubLoginDialog dialog=new GithubLoginDialog(project);
    dialog.show();
    useGitHubAccount=GithubUtil.checkCredentials(project);
  }
 else {
    useGitHubAccount=true;
  }
  final GitHubCreateGistDialog dialog=new GitHubCreateGistDialog(project,useGitHubAccount);
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  final GithubSettings settings=GithubSettings.getInstance();
  final String password=settings.getPassword();
  final Ref<String> url=new Ref<String>();
  final String description=dialog.getDescription();
  final boolean isPrivate=dialog.isPrivate();
  final boolean anonymous=dialog.isAnonymous();
  final boolean openInBrowser=dialog.isOpenInBrowser();
  final String text=editor.getSelectionModel().getSelectedText();
  ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    @Override public void run(){
      final HttpClient client=anonymous ? GithubUtil.getHttpClient(null,null) : GithubUtil.getHttpClient(settings.getLogin(),password);
      final PostMethod method=new PostMethod("https://api.github.com/gists");
      String request=prepareJsonRequest(description,isPrivate,text,file);
      String response;
      try {
        method.setRequestEntity(new StringRequestEntity(request,"application/json","UTF-8"));
        client.executeMethod(method);
        response=method.getResponseBodyAsString();
      }
 catch (      IOException e1) {
        showError(project,"Failed to create gist",null,null,e1);
        return;
      }
 finally {
        method.releaseConnection();
      }
      JsonObject jsonResponse;
      try {
        jsonResponse=new JsonParser().parse(response).getAsJsonObject();
      }
 catch (      JsonSyntaxException jse) {
        showError(project,"Couldn't parse GitHub response",null,response,jse);
        return;
      }
      JsonElement htmlUrl=jsonResponse.get("html_url");
      if (htmlUrl == null) {
        showError(project,"Invalid GitHub response","No html_url property",response,null);
        return;
      }
      url.set(htmlUrl.getAsString());
    }
  }
,"Communicating With GitHub",false,project);
  if (url.isNull()) {
    return;
  }
  if (openInBrowser) {
    BrowserUtil.launchBrowser(url.get());
  }
 else {
    Notificator.getInstance(project).notify(GitVcs.IMPORTANT_ERROR_NOTIFICATION,"Gist Created Successfully","Your gist url: <a href='open'>" + url.get() + "</a>",NotificationType.INFORMATION,new NotificationListener(){
      @Override public void hyperlinkUpdate(      @NotNull Notification notification,      @NotNull HyperlinkEvent event){
        if (event.getEventType() == HyperlinkEvent.EventType.ACTIVATED) {
          BrowserUtil.launchBrowser(url.get());
        }
      }
    }
);
  }
}
