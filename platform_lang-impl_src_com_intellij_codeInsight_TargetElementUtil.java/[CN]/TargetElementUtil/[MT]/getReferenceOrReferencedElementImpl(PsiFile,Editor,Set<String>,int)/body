{
  PsiReference ref=findReference(editor,offset);
  if (ref == null)   return null;
  PsiElement referenceOrReferencedElement=TargetElementUtilEx.EP_NAME.composite().getReferenceOrReferencedElement(file,editor,flags,offset);
  if (referenceOrReferencedElement != null) {
    return referenceOrReferencedElement;
  }
  PsiManager manager=file.getManager();
  PsiElement refElement=ref.resolve();
  if (refElement == null) {
    if (ApplicationManager.getApplication().isDispatchThread()) {
      DaemonCodeAnalyzer.getInstance(manager.getProject()).updateVisibleHighlighters(editor);
    }
    return null;
  }
 else {
    return refElement;
  }
}
