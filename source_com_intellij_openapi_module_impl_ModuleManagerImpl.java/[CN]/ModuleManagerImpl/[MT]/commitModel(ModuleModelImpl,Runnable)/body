{
  myModificationCount++;
  ApplicationManager.getApplication().assertWriteAccessAllowed();
  final Collection<Module> oldModules=myModuleModel.myPath2ModelMap.values();
  final Collection<Module> newModules=moduleModel.myPath2ModelMap.values();
  List<Module> removedModules=new ArrayList<Module>(oldModules);
  removedModules.removeAll(newModules);
  List<Module> addedModules=new ArrayList<Module>(newModules);
  addedModules.removeAll(oldModules);
  ProjectRootManagerEx.getInstanceEx(myProject).beforeRootsChange(false);
  try {
    for (    Module removedModule : removedModules) {
      fireBeforeModuleRemoved(removedModule);
      cleanCachedStuff();
    }
    List<Module> neverAddedModules=new ArrayList<Module>(moduleModel.myModulesToDispose);
    neverAddedModules.removeAll(myModuleModel.myPath2ModelMap.values());
    for (    final Module neverAddedModule : neverAddedModules) {
      ModuleImpl module=(ModuleImpl)neverAddedModule;
      Disposer.dispose(module);
    }
    myModuleModel=moduleModel;
    if (runnable != null) {
      runnable.run();
    }
    for (    Module module : removedModules) {
      fireModuleRemoved(module);
      cleanCachedStuff();
      Disposer.dispose(module);
      cleanCachedStuff();
    }
    for (    Module addedModule : addedModules) {
      ((ModuleImpl)addedModule).moduleAdded();
      cleanCachedStuff();
      fireModuleAdded(addedModule);
      cleanCachedStuff();
    }
    final Map<Module,String> modulesToNewNamesMap=moduleModel.myModulesToNewNamesMap;
    final Set<Module> modulesToBeRenamed=modulesToNewNamesMap.keySet();
    final List<Module> modules=new ArrayList<Module>();
    for (    final Module aModulesToBeRenamed : modulesToBeRenamed) {
      ModuleImpl module=(ModuleImpl)aModulesToBeRenamed;
      modules.add(module);
      module.rename(modulesToNewNamesMap.get(module));
      cleanCachedStuff();
    }
    fireModulesRenamed(modules);
    cleanCachedStuff();
  }
  finally {
    ProjectRootManagerEx.getInstanceEx(myProject).rootsChanged(false);
  }
}
