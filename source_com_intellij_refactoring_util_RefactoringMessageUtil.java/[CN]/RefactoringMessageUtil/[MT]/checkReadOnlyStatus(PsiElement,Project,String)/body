{
  if (element instanceof PsiDirectory) {
    PsiDirectory dir=(PsiDirectory)element;
    final VirtualFile vFile=dir.getVirtualFile();
    if (vFile.getFileSystem() instanceof JarFileSystem) {
      String message1=messagePrefix + ".\n Directory " + vFile.getPresentableUrl()+ " is located in a jar file.";
      showErrorMessage("Cannot Modify Jar",message1,null,project);
      return false;
    }
 else {
      final ReadonlyStatusHandler.OperationStatus status=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(new VirtualFile[]{vFile});
      if (status.hasReadonlyFiles()) {
        String message1=messagePrefix + ".\n Directory " + vFile.getPresentableUrl()+ " is read-only.";
        showErrorMessage("Read-only Directory",message1,null,project);
        return false;
      }
      return true;
    }
  }
 else   if (element instanceof PsiPackage) {
    final PsiDirectory[] directories=((PsiPackage)element).getDirectories();
    final List<VirtualFile> readOnlyDirs=new ArrayList<VirtualFile>();
    final List<VirtualFile> failedDirs=new ArrayList<VirtualFile>();
    for (int i=0; i < directories.length; i++) {
      PsiDirectory directory=directories[i];
      if (!directory.isWritable()) {
        final VirtualFile virtualFile=directory.getVirtualFile();
        if (virtualFile.getFileSystem() instanceof JarFileSystem) {
          failedDirs.add(virtualFile);
        }
 else {
          readOnlyDirs.add(virtualFile);
        }
      }
    }
    final ReadonlyStatusHandler.OperationStatus status=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(readOnlyDirs.toArray(new VirtualFile[readOnlyDirs.size()]));
    failedDirs.addAll(Arrays.asList(status.getReadonlyFiles()));
    if (failedDirs.size() > 0) {
      StringBuffer message=new StringBuffer(messagePrefix);
      message.append('\n');
      for (Iterator<VirtualFile> iterator=failedDirs.iterator(); iterator.hasNext(); ) {
        VirtualFile virtualFile=iterator.next();
        final String presentableUrl=virtualFile.getPresentableUrl();
        if (virtualFile.getFileSystem() instanceof JarFileSystem) {
          message.append("Directory " + presentableUrl + " is located in a jar file.\n");
        }
 else {
          message.append("Directory " + presentableUrl + " is read-only.\n");
          readOnlyDirs.add(virtualFile);
        }
      }
      return false;
    }
    return true;
  }
 else   if (element instanceof PsiCompiledElement) {
    PsiFile file=element.getContainingFile();
    String qName=((PsiJavaFile)file).getClasses()[0].getQualifiedName();
    showErrorMessage("Compiled Class",messagePrefix + " on compiled class " + qName+ ".",null,project);
    return false;
  }
 else {
    PsiFile file=element.getContainingFile();
    if (file == null) {
      if (element instanceof PsiVariable) {
        String message1="Variable " + element.getText() + " cannot be renamed.";
        showErrorMessage("Read-only entity",message1,null,project);
      }
 else {
        String message1="Cannot rename " + element.getText() + ".";
        showErrorMessage("Read-only entity",message1,null,project);
      }
      return false;
    }
    VirtualFile vFile=file.getVirtualFile();
    if (vFile.getFileSystem() instanceof JarFileSystem) {
      String message1=messagePrefix + ".\n File " + vFile.getPresentableUrl()+ " is located in a jar file.";
      showErrorMessage("Cannot Modify Jar",message1,null,project);
      return false;
    }
 else {
      final ReadonlyStatusHandler.OperationStatus status=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(new VirtualFile[]{vFile});
      if (status.hasReadonlyFiles()) {
        String message1=messagePrefix + ".\n File " + vFile.getPresentableUrl()+ " is read-only.";
        showErrorMessage("Read-only File",message1,null,project);
        return false;
      }
      return true;
    }
  }
}
