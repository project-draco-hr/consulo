{
  if (element instanceof PsiDirectory) {
    PsiDirectory dir=(PsiDirectory)element;
    final VirtualFile vFile=dir.getVirtualFile();
    if (vFile.getFileSystem() instanceof JarFileSystem) {
      String message1=messagePrefix + ".\n Directory " + vFile.getPresentableUrl()+ " is located in a jar file.";
      showErrorMessage("Cannot Modify Jar",message1,null,project);
      return false;
    }
 else {
      VirtualFile[] vFiles;
      if (recursively) {
        List<VirtualFile> list=new ArrayList<VirtualFile>();
        addVirtualFiles(vFile,list);
        vFiles=list.toArray(new VirtualFile[list.size()]);
      }
 else       vFiles=new VirtualFile[]{vFile};
      final ReadonlyStatusHandler.OperationStatus status=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(vFiles);
      final VirtualFile[] readonlyFiles=status.getReadonlyFiles();
      if (readonlyFiles.length > 0) {
        String subj=readonlyFiles[0].isDirectory() ? "Directory" : "File";
        String message1=messagePrefix + ".\n " + subj+ " "+ readonlyFiles[0].getPresentableUrl()+ " is read-only.";
        showErrorMessage("Read-only " + subj,message1,null,project);
        return false;
      }
      return true;
    }
  }
 else   if (element instanceof PsiPackage) {
    final PsiDirectory[] directories=((PsiPackage)element).getDirectories();
    final List<VirtualFile> readonlyList=new ArrayList<VirtualFile>();
    final List<VirtualFile> failedDirs=new ArrayList<VirtualFile>();
    for (int i=0; i < directories.length; i++) {
      PsiDirectory directory=directories[i];
      VirtualFile virtualFile=directory.getVirtualFile();
      if (recursively) {
        if (virtualFile.getFileSystem() instanceof JarFileSystem) {
          failedDirs.add(virtualFile);
        }
 else {
          addVirtualFiles(virtualFile,readonlyList);
        }
      }
 else {
        if (!directory.isWritable()) {
          if (virtualFile.getFileSystem() instanceof JarFileSystem) {
            failedDirs.add(virtualFile);
          }
 else {
            readonlyList.add(virtualFile);
          }
        }
      }
    }
    final ReadonlyStatusHandler.OperationStatus status=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(readonlyList.toArray(new VirtualFile[readonlyList.size()]));
    failedDirs.addAll(Arrays.asList(status.getReadonlyFiles()));
    if (failedDirs.size() > 0) {
      StringBuffer message=new StringBuffer(messagePrefix);
      message.append('\n');
      for (Iterator<VirtualFile> iterator=failedDirs.iterator(); iterator.hasNext(); ) {
        VirtualFile virtualFile=iterator.next();
        final String presentableUrl=virtualFile.getPresentableUrl();
        final String subj=virtualFile.isDirectory() ? "Directory " : "File ";
        if (virtualFile.getFileSystem() instanceof JarFileSystem) {
          message.append(subj + presentableUrl + " is located in a jar file.\n");
        }
 else {
          message.append(subj + presentableUrl + " is read-only.\n");
        }
      }
      return false;
    }
    return true;
  }
 else   if (element instanceof PsiCompiledElement) {
    PsiFile file=element.getContainingFile();
    String qName=((PsiJavaFile)file).getClasses()[0].getQualifiedName();
    showErrorMessage("Compiled Class",messagePrefix + " on compiled class " + qName+ ".",null,project);
    return false;
  }
 else {
    PsiFile file=element.getContainingFile();
    if (file == null) {
      if (element instanceof PsiVariable) {
        String message1="Variable " + element.getText() + " cannot be renamed.";
        showErrorMessage("Read-only entity",message1,null,project);
      }
 else {
        String message1="Cannot rename " + element.getText() + ".";
        showErrorMessage("Read-only entity",message1,null,project);
      }
      return false;
    }
    VirtualFile vFile=file.getVirtualFile();
    if (vFile.getFileSystem() instanceof JarFileSystem) {
      String message1=messagePrefix + ".\n File " + vFile.getPresentableUrl()+ " is located in a jar file.";
      showErrorMessage("Cannot Modify Jar",message1,null,project);
      return false;
    }
 else {
      final ReadonlyStatusHandler.OperationStatus status=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(new VirtualFile[]{vFile});
      if (status.hasReadonlyFiles()) {
        String message1=messagePrefix + ".\n File " + vFile.getPresentableUrl()+ " is read-only.";
        showErrorMessage("Read-only File",message1,null,project);
        return false;
      }
      return true;
    }
  }
}
