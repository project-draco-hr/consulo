{
  final Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return Result.Continue;
  }
  if (!file.getViewProvider().getLanguages().contains(myLanguage)) {
    return Result.Continue;
  }
  if (editor.isViewer()) {
    return Result.Continue;
  }
  final Document document=editor.getDocument();
  if (!document.isWritable()) {
    return Result.Continue;
  }
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  int caret=editor.getCaretModel().getOffset();
  if (caret <= 0) {
    return Result.Continue;
  }
  final int lineNumber=document.getLineNumber(caret);
  final int lineStartOffset=document.getLineStartOffset(lineNumber);
  final int previousLineStartOffset=lineNumber > 0 ? document.getLineStartOffset(lineNumber - 1) : lineStartOffset;
  final EditorHighlighter highlighter=((EditorEx)editor).getHighlighter();
  final HighlighterIterator iterator=highlighter.createIterator(caret - 1);
  final IElementType type=getNonWhitespaceElementType(iterator,previousLineStartOffset);
  final CharSequence editorCharSequence=editor.getDocument().getCharsSequence();
  final CharSequence lineIndent=editorCharSequence.subSequence(lineStartOffset,EditorActionUtil.findFirstNonSpaceOffsetOnTheLine(document,lineNumber));
  if (type == myLineCommentType) {
    final String restString=editorCharSequence.subSequence(caret,document.getLineEndOffset(lineNumber)).toString();
    if (!StringUtil.isEmptyOrSpaces(restString)) {
      EditorModificationUtil.insertStringAtCaret(editor,"\n" + lineIndent + myLineCommentPrefix);
      editor.getCaretModel().moveToLogicalPosition(new LogicalPosition(lineNumber + 1,1));
      return Result.Stop;
    }
 else     if (iterator.getStart() < lineStartOffset) {
      EditorModificationUtil.insertStringAtCaret(editor,"\n" + lineIndent);
      return Result.Stop;
    }
  }
  if (LanguageFormatting.INSTANCE.forLanguage(myLanguage) != null) {
    return Result.Continue;
  }
 else {
    if (myIndentTokens.contains(type)) {
      final String newIndent=getNewIndent(file,lineIndent);
      EditorModificationUtil.insertStringAtCaret(editor,"\n" + newIndent);
      return Result.Stop;
    }
    EditorModificationUtil.insertStringAtCaret(editor,"\n" + lineIndent);
    editor.getCaretModel().moveToLogicalPosition(new LogicalPosition(lineNumber + 1,calcLogicalLength(editor,lineIndent)));
    return Result.Stop;
  }
}
