{
  final Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return Result.Continue;
  }
  if (!file.getViewProvider().getLanguages().contains(myLanguage)) {
    return Result.Continue;
  }
  if (editor.isViewer()) {
    return Result.Continue;
  }
  final Document document=editor.getDocument();
  if (!document.isWritable()) {
    return Result.Continue;
  }
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  int caret=editor.getCaretModel().getOffset();
  if (caret == 0) {
    return Result.Continue;
  }
  final int lineNumber=document.getLineNumber(caret);
  final int previousLineStartOffset=document.getLineStartOffset(lineNumber - 1);
  final int lineStartOffset=document.getLineStartOffset(lineNumber);
  final EditorHighlighter highlighter=((EditorEx)editor).getHighlighter();
  final HighlighterIterator iterator=highlighter.createIterator(caret - 1);
  final IElementType type=getNonWhitespaceElementType(iterator,previousLineStartOffset);
  final CharSequence editorCharSequence=editor.getDocument().getCharsSequence();
  final CharSequence lineIndent=editorCharSequence.subSequence(lineStartOffset,EditorActionUtil.findFirstNonSpaceOffsetOnTheLine(document,lineNumber));
  if (type == myLineCommentType) {
    final String restString=editorCharSequence.subSequence(caret,document.getLineEndOffset(lineNumber)).toString();
    if (!StringUtil.isEmptyOrSpaces(restString)) {
      EditorModificationUtil.insertStringAtCaret(editor,"\n" + lineIndent + myLineCommentPrefix);
      editor.getCaretModel().moveToLogicalPosition(new LogicalPosition(lineNumber + 1,1));
      return Result.Stop;
    }
  }
  if (myIndentTokens.contains(type)) {
    return Result.Continue;
  }
  if (LanguageFormatting.INSTANCE.forLanguage(myLanguage) != null) {
    return Result.Continue;
  }
  EditorModificationUtil.insertStringAtCaret(editor,"\n" + lineIndent);
  editor.getCaretModel().moveToLogicalPosition(new LogicalPosition(lineNumber + 1,lineIndent.length()));
  return Result.Stop;
}
