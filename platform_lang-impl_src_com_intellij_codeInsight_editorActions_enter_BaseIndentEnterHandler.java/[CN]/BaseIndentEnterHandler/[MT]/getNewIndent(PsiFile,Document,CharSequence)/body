{
  CharSequence nonEmptyIndent=oldIndent;
  final CharSequence editorCharSequence=document.getCharsSequence();
  final int nLines=document.getLineCount();
  for (int line=0; line < nLines && nonEmptyIndent.length() == 0; ++line) {
    final int lineStart=document.getLineStartOffset(line);
    final int indentEnd=EditorActionUtil.findFirstNonSpaceOffsetOnTheLine(document,line);
    if (lineStart < indentEnd) {
      nonEmptyIndent=editorCharSequence.subSequence(lineStart,indentEnd);
    }
  }
  final boolean usesSpacesForIndentation=nonEmptyIndent.length() > 0 && nonEmptyIndent.charAt(nonEmptyIndent.length() - 1) == ' ';
  final boolean firstIndent=nonEmptyIndent.length() == 0;
  final CodeStyleSettings currentSettings=CodeStyleSettingsManager.getSettings(file.getProject());
  final CommonCodeStyleSettings.IndentOptions indentOptions=currentSettings.getIndentOptions(file.getFileType());
  if (firstIndent && indentOptions.USE_TAB_CHARACTER || !firstIndent && !usesSpacesForIndentation) {
    int nTabsToIndent=indentOptions.INDENT_SIZE / indentOptions.TAB_SIZE;
    if (indentOptions.INDENT_SIZE % indentOptions.TAB_SIZE != 0) {
      ++nTabsToIndent;
    }
    return oldIndent + StringUtil.repeatSymbol('\t',nTabsToIndent);
  }
  return oldIndent + StringUtil.repeatSymbol(' ',indentOptions.INDENT_SIZE);
}
