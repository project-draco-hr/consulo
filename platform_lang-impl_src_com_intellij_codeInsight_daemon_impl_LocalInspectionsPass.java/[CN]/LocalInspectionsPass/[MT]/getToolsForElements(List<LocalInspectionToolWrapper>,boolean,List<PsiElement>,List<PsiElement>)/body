{
  Set<Language> languages=new THashSet<Language>();
  Map<String,Language> langIds=new THashMap<String,Language>();
  Set<String> dialects=new THashSet<String>();
  for (  PsiElement element : inside) {
    Language language=element.getLanguage();
    if (languages.add(language)) {
      langIds.put(language.getID(),language);
      for (      Language dialect : language.getDialects()) {
        dialects.add(dialect.getID());
      }
    }
  }
  for (  PsiElement element : outside) {
    Language language=element.getLanguage();
    if (languages.add(language)) {
      langIds.put(language.getID(),language);
      for (      Language dialect : language.getDialects()) {
        dialects.add(dialect.getID());
      }
    }
  }
  MultiMap<LocalInspectionTool,String> map=new MultiMap<LocalInspectionTool,String>(){
    @Override protected Collection<String> createCollection(){
      return new THashSet<String>();
    }
    @Override protected Collection<String> createEmptyCollection(){
      return Collections.emptySet();
    }
  }
;
  for (  LocalInspectionToolWrapper wrapper : toolWrappers) {
    String language=wrapper.getLanguage();
    if (language == null) {
      LocalInspectionTool tool=wrapper.getTool();
      if (!checkDumbAwareness || tool instanceof DumbAware) {
        map.put(tool,null);
      }
      continue;
    }
    Language lang=langIds.get(language);
    if (lang != null) {
      LocalInspectionTool tool=wrapper.getTool();
      if (!checkDumbAwareness || tool instanceof DumbAware) {
        map.putValue(tool,language);
        if (wrapper.applyToDialects()) {
          for (          Language dialect : lang.getDialects()) {
            map.putValue(tool,dialect.getID());
          }
        }
      }
    }
 else     if (wrapper.applyToDialects() && dialects.contains(language)) {
      LocalInspectionTool tool=wrapper.getTool();
      if (!checkDumbAwareness || tool instanceof DumbAware) {
        map.putValue(tool,language);
      }
    }
  }
  return map;
}
