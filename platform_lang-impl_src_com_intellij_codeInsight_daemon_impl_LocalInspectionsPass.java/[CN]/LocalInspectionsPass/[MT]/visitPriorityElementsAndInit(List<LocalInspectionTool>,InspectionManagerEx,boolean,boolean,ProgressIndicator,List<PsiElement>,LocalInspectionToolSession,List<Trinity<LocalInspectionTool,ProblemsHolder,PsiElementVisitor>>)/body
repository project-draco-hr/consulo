{
  boolean result=JobUtil.invokeConcurrentlyUnderMyProgress(tools,new Processor<LocalInspectionTool>(){
    public boolean process(    final LocalInspectionTool tool){
      indicator.checkCanceled();
      ApplicationManager.getApplication().assertReadAccessAllowed();
      ProblemsHolder holder=new ProblemsHolder(iManager,myFile,isOnTheFly){
        @Override public void registerProblem(        @NotNull ProblemDescriptor descriptor){
          super.registerProblem(descriptor);
          if (isOnTheFly) {
            addDescriptorIncrementally(descriptor,tool,ignoreSuppressed,indicator);
          }
        }
      }
;
      PsiElementVisitor visitor=createVisitorAndAcceptElements(tool,holder,isOnTheFly,session,elements,indicator);
synchronized (init) {
        init.add(Trinity.create(tool,holder,visitor));
      }
      advanceProgress(1);
      if (holder.hasResults()) {
        appendDescriptors(myFile,holder.getResults(),tool);
      }
      return true;
    }
  }
,myFailFastOnAcquireReadAction);
  if (!result)   throw new ProcessCanceledException();
  inspectInjectedPsi(elements,tools,isOnTheFly,ignoreSuppressed,indicator,session);
}
