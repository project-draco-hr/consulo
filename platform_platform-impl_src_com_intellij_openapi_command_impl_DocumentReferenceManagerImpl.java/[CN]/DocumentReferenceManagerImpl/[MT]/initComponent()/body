{
  VirtualFileManager.getInstance().addVirtualFileListener(new VirtualFileAdapter(){
    @Override public void fileCreated(    VirtualFileEvent event){
      VirtualFile f=event.getFile();
      DocumentReference ref=myDeletedFilePathToRef.remove(new FilePath(f.getUrl()));
      if (ref != null) {
        myFileToRef.put(f,ref);
        ((DocumentReferenceByVirtualFile)ref).update(f);
      }
    }
    @Override public void beforeFileDeletion(    VirtualFileEvent event){
      VirtualFile f=event.getFile();
      f.putUserData(DELETED_FILES,collectDeletedFiles(f,new ArrayList<VirtualFile>()));
    }
    @Override public void fileDeleted(    VirtualFileEvent event){
      VirtualFile f=event.getFile();
      List<VirtualFile> files=f.getUserData(DELETED_FILES);
      f.putUserData(DELETED_FILES,null);
      for (      VirtualFile each : files) {
        DocumentReference ref=myFileToRef.remove(each);
        if (ref != null) {
          myDeletedFilePathToRef.put(new FilePath(each.getUrl()),ref);
        }
      }
    }
  }
);
}
