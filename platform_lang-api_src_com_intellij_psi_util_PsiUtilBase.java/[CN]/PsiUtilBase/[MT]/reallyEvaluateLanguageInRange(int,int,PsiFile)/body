{
  if (file instanceof PsiBinaryFile) {
    return file.getLanguage();
  }
  Language lang=null;
  int curOffset=start;
  do {
    PsiElement elt=getElementAtOffset(file,curOffset);
    if (!(elt instanceof PsiWhiteSpace)) {
      final Language language=findLanguageFromElement(elt);
      if (lang == null) {
        lang=language;
      }
 else       if (lang != language) {
        return null;
      }
    }
    TextRange range=elt.getTextRange();
    if (range == null) {
      LOG.error("Null range for element " + elt + " of "+ elt.getClass()+ " in file "+ file+ " at offset "+ curOffset);
      return file.getLanguage();
    }
    int endOffset=range.getEndOffset();
    curOffset=endOffset <= curOffset ? curOffset + 1 : endOffset;
  }
 while (curOffset < end);
  return narrowLanguage(lang,file.getLanguage());
}
