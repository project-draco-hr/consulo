{
  ASTNode node=root.getNode();
  while (node != null && node.getTreeParent() != null) {
    node=node.getTreeParent();
  }
  if (node != null)   root=node.getPsi();
  final PsiFile containingFile=root.getContainingFile();
  FileViewProvider provider=containingFile.getViewProvider();
  Set<Language> languages=provider.getLanguages();
  if (languages.size() == 1) {
    return 0;
  }
  List<Language> array=new ArrayList<Language>(languages);
  Collections.sort(array,LANGUAGE_COMPARATOR);
  for (int i=0; i < array.size(); i++) {
    Language language=array.get(i);
    if (provider.getPsi(language) == containingFile)     return i;
  }
  throw new RuntimeException("Cannot find root for: " + root);
}
