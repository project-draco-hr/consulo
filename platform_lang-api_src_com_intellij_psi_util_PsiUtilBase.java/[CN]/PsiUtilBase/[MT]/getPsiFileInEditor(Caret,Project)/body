{
  Editor editor=caret.getEditor();
  final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  if (file == null)   return null;
  PsiUtilCore.ensureValid(file);
  final Language language=getLanguageInEditor(caret,project);
  if (language == null)   return file;
  if (language == file.getLanguage())   return file;
  int caretOffset=caret.getOffset();
  int mostProbablyCorrectLanguageOffset=caretOffset == caret.getSelectionEnd() ? caret.getSelectionStart() : caretOffset;
  return getPsiFileAtOffset(file,mostProbablyCorrectLanguageOffset);
}
