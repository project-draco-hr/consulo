{
  final PsiFile psiFile=psiElement.getContainingFile();
  final PsiFile originalFile=psiFile.getOriginalFile();
  if (originalFile == psiFile)   return psiElement;
  final TextRange range=psiElement.getTextRange();
  final PsiElement element=originalFile.findElementAt(range.getStartOffset());
  final int maxLength=range.getLength();
  T parent=PsiTreeUtil.getParentOfType(element,elementClass,false);
  for (T next=parent; next != null && next.getTextLength() <= maxLength; parent=next, next=PsiTreeUtil.getParentOfType(next,elementClass,true)) {
  }
  return parent;
}
