{
  final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  if (file == null)   return null;
  final Language language=getLanguageInEditor(editor,project);
  if (language == null)   return file;
  if (language == file.getLanguage())   return file;
  final SelectionModel selectionModel=editor.getSelectionModel();
  int caretOffset=editor.getCaretModel().getOffset();
  int mostProbablyCorrectLanguageOffset=caretOffset == selectionModel.getSelectionStart() || caretOffset == selectionModel.getSelectionEnd() ? selectionModel.getSelectionStart() : caretOffset;
  return getPsiFileAtOffset(file,mostProbablyCorrectLanguageOffset);
}
