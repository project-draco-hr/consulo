{
  JBPopupFactory jbPopupFactory=JBPopupFactory.getInstance();
  List<String> actions=new ArrayList<String>();
  final String libraryChoice=ProjectBundle.message("add.new.library.text");
  actions.add(libraryChoice);
  final String jdkChoice=ProjectBundle.message("add.new.jdk.text");
  actions.add(jdkChoice);
  final String moduleChoice=ProjectBundle.message("add.new.module.text");
  if (!myProject.isDefault()) {
    actions.add(moduleChoice);
  }
  List<Icon> icons=new ArrayList<Icon>();
  final ListPopup listPopup=jbPopupFactory.createWizardStep(new BaseListPopupStep<String>(ProjectBundle.message("add.action.name"),actions,icons){
    public boolean hasSubstep(    final String selectedValue){
      return selectedValue.compareTo(moduleChoice) != 0;
    }
    public PopupStep onChosen(    final String selectedValue,    final boolean finalChoice){
      if (selectedValue.compareTo(libraryChoice) == 0) {
        return createLibrariesStep(e);
      }
 else       if (selectedValue.compareTo(jdkChoice) == 0) {
        return createJdksStep(e.getDataContext());
      }
      SwingUtilities.invokeLater(new Runnable(){
        public void run(){
          final Module module=myModulesConfigurator.addModule(myTree);
          if (module != null) {
            final MyNode node=new MyNode(new ModuleConfigurable(myModulesConfigurator,module,TREE_UPDATER));
            addNode(node,myProjectNode);
            selectNodeInTree(node);
          }
        }
      }
);
      return PopupStep.FINAL_CHOICE;
    }
    public int getDefaultOptionIndex(){
      final Object selectedObject=getSelectedObject();
      if (selectedObject instanceof Library || selectedObject instanceof String) {
        return 0;
      }
 else       if (selectedObject instanceof ProjectJdk || selectedObject instanceof ProjectJdksModel) {
        return 1;
      }
 else       if (selectedObject instanceof Module) {
        return 2;
      }
      return 0;
    }
  }
);
  listPopup.showUnderneathOf(myNorthPanel);
  final int defaultOptionIndex=listPopup.getListStep().getDefaultOptionIndex();
  if (defaultOptionIndex == 0 || defaultOptionIndex == 1) {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        ((ListPopupImpl)listPopup).handleSelect(true);
      }
    }
);
  }
}
