{
  if (rootPaths.isEmpty() || !myWatcher.isOperational()) {
    removeWatchedRoots(watchRequests);
    return Collections.emptySet();
  }
  final Set<WatchRequest> result=new HashSet<WatchRequest>();
  final Set<VirtualFile> filesToSync=new HashSet<VirtualFile>();
  final AccessToken token=ApplicationManager.getApplication().acquireReadActionLock();
  try {
synchronized (myLock) {
      final boolean update=doAddRootsToWatch(rootPaths,watchRecursively,result,filesToSync) || doRemoveWatchedRoots(watchRequests);
      if (update) {
        myCachedNormalizedRequests=null;
        setUpFileWatcher();
      }
    }
  }
  finally {
    token.finish();
  }
  syncFiles(filesToSync,watchRecursively);
  return result;
}
