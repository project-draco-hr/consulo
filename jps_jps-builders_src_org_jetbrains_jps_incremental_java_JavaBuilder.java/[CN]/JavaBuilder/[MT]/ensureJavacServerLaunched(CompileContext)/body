{
  final ExternalJavacDescriptor descriptor=ExternalJavacDescriptor.KEY.get(context);
  if (descriptor != null) {
    return descriptor.client;
  }
  final String vmExecPath=System.getProperty(GlobalOptions.VM_EXE_PATH_OPTION,System.getProperty("java.home") + "/bin/java");
  final String hostString=System.getProperty(GlobalOptions.HOSTNAME_OPTION,"localhost");
  final int port=findFreePort();
  final int heapSize=getJavacServerHeapSize(context);
  final BaseOSProcessHandler processHandler=JavacServerBootstrap.launchJavacServer(vmExecPath,heapSize,port,Paths.getSystemRoot(),getCompilationVMOptions(context));
  final JavacServerClient client=new JavacServerClient();
  try {
    client.connect(hostString,port);
  }
 catch (  Throwable ex) {
    processHandler.destroyProcess();
    throw new Exception("Failed to connect to external javac process: ",ex);
  }
  ExternalJavacDescriptor.KEY.set(context,new ExternalJavacDescriptor(processHandler,client));
  return client;
}
