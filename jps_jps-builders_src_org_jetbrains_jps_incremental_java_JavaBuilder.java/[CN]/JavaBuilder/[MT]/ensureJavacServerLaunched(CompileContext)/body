{
  final ExternalJavacDescriptor descriptor=ExternalJavacDescriptor.KEY.get(context);
  if (descriptor != null) {
    return descriptor.client;
  }
  final int port=findFreePort();
  final int heapSize=getJavacServerHeapSize(context);
  final String javaHome=SystemProperties.getJavaHome();
  final BaseOSProcessHandler processHandler=JavacServerBootstrap.launchJavacServer(javaHome,heapSize,port,Utils.getSystemRoot(),getCompilationVMOptions(context),useEclipseCompiler(context));
  final JavacServerClient client=new JavacServerClient();
  try {
    client.connect("127.0.0.1",port);
  }
 catch (  Throwable ex) {
    processHandler.destroyProcess();
    throw new Exception("Failed to connect to external javac process: ",ex);
  }
  ExternalJavacDescriptor.KEY.set(context,new ExternalJavacDescriptor(processHandler,client));
  return client;
}
