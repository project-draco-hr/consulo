{
  try {
    final Set<File> filesToCompile=new HashSet<File>();
    final Set<File> formsToCompile=new HashSet<File>();
    context.processFilesToRecompile(chunk,new FileProcessor(){
      public boolean apply(      Module module,      File file,      String sourceRoot) throws IOException {
        if (JAVA_SOURCES_FILTER.accept(file)) {
          filesToCompile.add(file);
        }
 else         if (FORM_SOURCES_FILTER.accept(file)) {
          formsToCompile.add(file);
        }
        return true;
      }
    }
);
    final CompilerExcludes excludes=context.getProject().getCompilerConfiguration().getExcludes();
    if (!context.isProjectRebuild()) {
      for (Iterator<File> formsIterator=formsToCompile.iterator(); formsIterator.hasNext(); ) {
        final File form=formsIterator.next();
        final RootDescriptor descriptor=context.getModuleAndRoot(form);
        if (descriptor == null) {
          continue;
        }
        for (        RootDescriptor rd : context.getModuleRoots(descriptor.module)) {
          final File boundSource=getBoundSource(rd.root,form);
          if (boundSource == null) {
            continue;
          }
          if (!excludes.isExcluded(boundSource)) {
            filesToCompile.add(boundSource);
          }
 else {
            formsIterator.remove();
          }
          break;
        }
      }
      final SourceToFormMapping sourceToFormMap=context.getDataManager().getSourceToFormMap();
      for (      File srcFile : filesToCompile) {
        final String srcPath=srcFile.getPath();
        final String formPath=sourceToFormMap.getState(srcPath);
        if (formPath == null) {
          continue;
        }
        final File formFile=new File(formPath);
        if (!excludes.isExcluded(formFile)) {
          if (formFile.exists()) {
            context.markDirty(formFile);
            formsToCompile.add(formFile);
          }
          sourceToFormMap.remove(srcPath);
        }
      }
    }
    if (LOG.isDebugEnabled()) {
      if (filesToCompile.size() > 0 && context.isMake()) {
        LOG.info("Compiling files:");
        final String[] buffer=new String[filesToCompile.size()];
        int i=0;
        for (        final File f : filesToCompile) {
          buffer[i++]=FileUtil.toSystemIndependentName(f.getCanonicalPath());
        }
        Arrays.sort(buffer);
        for (        final String s : buffer) {
          LOG.info(s);
        }
        LOG.info("End of files");
      }
    }
    return compile(context,chunk,filesToCompile,formsToCompile);
  }
 catch (  ProjectBuildException e) {
    throw e;
  }
catch (  Exception e) {
    String message=e.getMessage();
    if (message == null) {
      final ByteArrayOutputStream out=new ByteArrayOutputStream();
      e.printStackTrace(new PrintStream(out));
      message="Internal error: \n" + out.toString();
    }
    context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,message));
    throw new ProjectBuildException(message,e);
  }
}
