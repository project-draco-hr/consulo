{
  for (  final OutputFileObject fileObject : sink.getFileObjects()) {
    final OutputFileObject.Content originalContent=fileObject.getContent();
    if (originalContent == null || fileObject.getKind() != JavaFileObject.Kind.CLASS) {
      continue;
    }
    final ClassReader reader=new ClassReader(originalContent.getBuffer(),originalContent.getOffset(),originalContent.getLength());
    final int version=getClassFileVersion(reader);
    if (version >= Opcodes.V1_5) {
      boolean success=false;
      final ClassWriter writer=new InstrumenterClassWriter(getAsmClassWriterFlags(version),finder);
      try {
        final NotNullVerifyingInstrumenter instrumenter=new NotNullVerifyingInstrumenter(writer);
        reader.accept(instrumenter,0);
        if (instrumenter.isModification()) {
          fileObject.updateContent(writer.toByteArray());
        }
        success=true;
      }
 catch (      Throwable e) {
        final StringBuilder msg=new StringBuilder();
        msg.append("@NotNull instrumentation failed ");
        final File sourceFile=fileObject.getSourceFile();
        if (sourceFile != null) {
          msg.append(" for ").append(sourceFile.getName());
        }
        msg.append(": ").append(e.getMessage());
        context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,msg.toString(),sourceFile != null ? sourceFile.getPath() : null));
      }
 finally {
        if (!success) {
          sink.markError(fileObject);
        }
      }
    }
  }
}
