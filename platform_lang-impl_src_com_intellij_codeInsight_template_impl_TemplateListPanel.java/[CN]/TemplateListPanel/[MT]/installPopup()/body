{
  final DumbAwareAction rename=new DumbAwareAction("Rename"){
    @Override public void update(    AnActionEvent e){
      final int selected=getSingleSelectedIndex();
      final TemplateGroup templateGroup=getGroup(selected);
      boolean enabled=templateGroup != null;
      e.getPresentation().setEnabled(enabled);
      e.getPresentation().setVisible(enabled);
      super.update(e);
    }
    @Override public void actionPerformed(    AnActionEvent e){
      renameGroup();
    }
  }
;
  rename.registerCustomShortcutSet(ActionManager.getInstance().getAction(IdeActions.ACTION_RENAME).getShortcutSet(),myTree);
  final DefaultActionGroup move=new DefaultActionGroup("Move",true){
    @Override public void update(    AnActionEvent e){
      final int selected=getSingleSelectedIndex();
      final TemplateImpl template=getTemplate(selected);
      boolean enabled=template != null;
      e.getPresentation().setEnabled(enabled);
      e.getPresentation().setVisible(enabled);
      if (enabled) {
        final String oldGroupName=template.getGroupName();
        removeAll();
        SchemesManager<TemplateGroup,TemplateGroup> schemesManager=TemplateSettings.getInstance().getSchemesManager();
        for (        TemplateGroup group : getTemplateGroups()) {
          final String newGroupName=group.getName();
          if (!Comparing.equal(newGroupName,oldGroupName) && !schemesManager.isShared(group)) {
            add(new DumbAwareAction(newGroupName){
              @Override public void actionPerformed(              AnActionEvent e){
                moveTemplate(template,newGroupName,getNode(selected));
              }
            }
);
          }
        }
        addSeparator();
        add(new DumbAwareAction("New group..."){
          @Override public void actionPerformed(          AnActionEvent e){
            String newName=Messages.showInputDialog(myTree,"Enter the new group name:","Move to a new group",null,"",new TemplateGroupInputValidator(null));
            if (newName != null) {
              moveTemplate(template,newName,getNode(selected));
            }
          }
        }
);
      }
    }
  }
;
  myTree.addMouseListener(new PopupHandler(){
    @Override public void invokePopup(    Component comp,    int x,    int y){
      final DefaultActionGroup group=new DefaultActionGroup();
      group.add(rename);
      group.add(move);
      ActionManager.getInstance().createActionPopupMenu(ActionPlaces.UNKNOWN,group).getComponent().show(comp,x,y);
    }
  }
);
}
