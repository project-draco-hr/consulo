{
  myTreeRoot=new CheckedTreeNode(null);
  myTree=new CheckboxTree(new CheckboxTree.CheckboxTreeCellRenderer(){
    @Override public void customizeRenderer(    final JTree tree,    Object value,    final boolean selected,    final boolean expanded,    final boolean leaf,    final int row,    final boolean hasFocus){
      if (!(value instanceof DefaultMutableTreeNode))       return;
      value=((DefaultMutableTreeNode)value).getUserObject();
      if (value instanceof TemplateImpl) {
        getTextRenderer().append(((TemplateImpl)value).getKey(),SimpleTextAttributes.REGULAR_ATTRIBUTES);
        String description=((TemplateImpl)value).getDescription();
        if (description != null && description.length() > 0) {
          getTextRenderer().append(" (" + description + ")",SimpleTextAttributes.GRAY_ATTRIBUTES);
        }
      }
 else       if (value instanceof TemplateGroup) {
        getTextRenderer().append(((TemplateGroup)value).getName(),SimpleTextAttributes.REGULAR_BOLD_ATTRIBUTES);
      }
    }
  }
,myTreeRoot){
    @Override protected void onNodeStateChanged(    final CheckedTreeNode node){
      Object obj=node.getUserObject();
      if (obj instanceof TemplateImpl) {
        ((TemplateImpl)obj).setDeactivated(!node.isChecked());
      }
    }
    @Override protected void installSpeedSearch(){
      new TreeSpeedSearch(this,new Convertor<TreePath,String>(){
        @Override public String convert(        TreePath o){
          Object object=((DefaultMutableTreeNode)o.getLastPathComponent()).getUserObject();
          if (object instanceof TemplateGroup) {
            return ((TemplateGroup)object).getName();
          }
          if (object instanceof TemplateImpl) {
            TemplateImpl template=(TemplateImpl)object;
            return StringUtil.notNullize(template.getKey()) + " " + StringUtil.notNullize(template.getDescription())+ " "+ template.getTemplateText();
          }
          return "";
        }
      }
,true);
    }
  }
;
  myTree.setRootVisible(false);
  myTree.setShowsRootHandles(true);
  myTree.getSelectionModel().addTreeSelectionListener(new TreeSelectionListener(){
    @Override public void valueChanged(    final TreeSelectionEvent e){
      TemplateSettings templateSettings=TemplateSettings.getInstance();
      TemplateImpl template=getTemplate(getSingleSelectedIndex());
      if (template != null) {
        templateSettings.setLastSelectedTemplate(template.getGroupName(),template.getKey());
      }
 else {
        templateSettings.setLastSelectedTemplate(null,null);
        ((CardLayout)myDetailsPanel.getLayout()).show(myDetailsPanel,NO_SELECTION);
      }
      if (myUpdateNeeded) {
        myAlarm.cancelAllRequests();
        myAlarm.addRequest(new Runnable(){
          @Override public void run(){
            updateTemplateDetails(false);
          }
        }
,100);
      }
    }
  }
);
  myTree.registerKeyboardAction(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent event){
      myCurrentTemplateEditor.focusKey();
    }
  }
,KeyStroke.getKeyStroke(KeyEvent.VK_ENTER,0),JComponent.WHEN_FOCUSED);
  new DoubleClickListener(){
    @Override protected boolean onDoubleClick(    MouseEvent e){
      renameGroup();
      return true;
    }
  }
.installOn(myTree);
  installPopup();
  DnDSupport.createBuilder(myTree).setBeanProvider(new NullableFunction<DnDActionInfo,DnDDragStartBean>(){
    @Override public DnDDragStartBean fun(    DnDActionInfo dnDActionInfo){
      Point point=dnDActionInfo.getPoint();
      if (myTree.getPathForLocation(point.x,point.y) == null)       return null;
      Map<TemplateImpl,DefaultMutableTreeNode> templates=getSelectedTemplates();
      return !templates.isEmpty() ? new DnDDragStartBean(templates) : null;
    }
  }
).setDisposableParent(this).setTargetChecker(new DnDTargetChecker(){
    @Override public boolean update(    DnDEvent event){
      @SuppressWarnings("unchecked") Set<String> oldGroupNames=getAllGroups((Map<TemplateImpl,DefaultMutableTreeNode>)event.getAttachedObject());
      TemplateGroup group=getDropGroup(event);
      boolean differentGroup=group != null && !oldGroupNames.contains(group.getName());
      event.setDropPossible(differentGroup,"");
      return true;
    }
  }
).setDropHandler(new DnDDropHandler(){
    @Override public void drop(    DnDEvent event){
      moveTemplates((Map<TemplateImpl,DefaultMutableTreeNode>)event.getAttachedObject(),ObjectUtil.assertNotNull(getDropGroup(event)).getName());
    }
  }
).setImageProvider(new NullableFunction<DnDActionInfo,DnDImage>(){
    @Override public DnDImage fun(    DnDActionInfo dnDActionInfo){
      Point point=dnDActionInfo.getPoint();
      TreePath path=myTree.getPathForLocation(point.x,point.y);
      return path == null ? null : new DnDImage(DnDAwareTree.getDragImage(myTree,path,point).first);
    }
  }
).install();
  if (myTemplateGroups.size() > 0) {
    myTree.setSelectionInterval(0,0);
  }
  return initToolbar().createPanel();
}
