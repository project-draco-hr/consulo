{
  String result;
  int startOffset=fileText.indexOf(TestUtils.BEGIN_MARKER);
  if (startOffset < 0) {
    startOffset=fileText.indexOf(ALL_MARKER);
    replaceAllOccurences=true;
    fileText=removeAllMarker(fileText);
  }
 else {
    replaceAllOccurences=false;
    fileText=TestUtils.removeBeginMarker(fileText);
  }
  int endOffset=fileText.indexOf(TestUtils.END_MARKER);
  fileText=TestUtils.removeEndMarker(fileText);
  myFixture.configureByText(GroovyFileType.GROOVY_FILE_TYPE,fileText);
  Editor myEditor=myFixture.getEditor();
  myEditor.getSelectionModel().setSelection(startOffset,endOffset);
  final GroovyIntroduceVariableBase introduceVariableBase=new GroovyIntroduceVariableHandler();
  GrExpression selectedExpr=GroovyRefactoringUtil.findElementInRange(((GroovyFileBase)myFixture.getFile()),startOffset,endOffset,GrExpression.class);
  Assert.assertNotNull("Selected expression reference points to null",selectedExpr);
  final PsiElement tempContainer=GroovyRefactoringUtil.getEnclosingContainer(selectedExpr);
  Assert.assertTrue(tempContainer instanceof GroovyPsiElement);
  PsiElement[] occurences=GroovyRefactoringUtil.getExpressionOccurrences(PsiUtil.skipParentheses(selectedExpr,false),tempContainer);
  final String varName="preved";
  final PsiType varType;
  if (explicitType) {
    varType=selectedExpr.getType();
  }
 else {
    varType=null;
  }
  final GrIntroduceContext context=new GrIntroduceContext(getProject(),myEditor,selectedExpr,occurences,tempContainer,null);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      introduceVariableBase.runRefactoring(context,new GroovyIntroduceVariableSettings(){
        @Override public boolean isDeclareFinal(){
          return false;
        }
        @Nullable @Override public PsiType getSelectedType(){
          return varType;
        }
        @Override public String getName(){
          return varName;
        }
        @Override public boolean replaceAllOccurrences(){
          return replaceAllOccurences;
        }
      }
);
      PostprocessReformattingAspect.getInstance(getProject()).doPostponedFormatting();
    }
  }
);
  result=myEditor.getDocument().getText();
  int caretOffset=myEditor.getCaretModel().getOffset();
  result=result.substring(0,caretOffset) + TestUtils.CARET_MARKER + result.substring(caretOffset);
  return result;
}
