{
  builder.setLength(0);
  if (isIdentifier(text)) {
    if (lower) {
      if (!isUnderscored(text)) {
        builder.append(text);
        return;
      }
      boolean prevIsUnderscore=false;
      for (int i=0; i < text.length(); i++) {
        char c=text.charAt(i);
        if (c == '_' && i > 0) {
          prevIsUnderscore=true;
          continue;
        }
        if (prevIsUnderscore) {
          builder.append(Character.toUpperCase(c));
          prevIsUnderscore=false;
        }
 else {
          builder.append(Character.toLowerCase(c));
        }
      }
    }
 else {
      if (!isCamelCased(text)) {
        builder.append(text);
        return;
      }
      boolean prevWasLower=false;
      for (int i=0; i < text.length(); i++) {
        char c=text.charAt(i);
        if (Character.isUpperCase(c)) {
          if (prevWasLower) {
            builder.append('_');
            prevWasLower=false;
          }
        }
 else         if (Character.isLowerCase(c)) {
          prevWasLower=true;
        }
        builder.append(Character.toUpperCase(c));
      }
    }
  }
 else {
    boolean prevIsSlash=false;
    for (int i=0; i < text.length(); ++i) {
      char c=text.charAt(i);
      if (!prevIsSlash) {
        c=(lower) ? Character.toLowerCase(c) : Character.toUpperCase(c);
      }
      prevIsSlash=c == '\\';
      builder.append(c);
    }
  }
}
