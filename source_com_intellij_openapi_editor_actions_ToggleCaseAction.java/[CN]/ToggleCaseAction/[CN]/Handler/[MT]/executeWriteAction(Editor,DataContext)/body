{
  if (!editor.getSelectionModel().hasSelection()) {
    editor.getSelectionModel().selectWordAtCaret(false);
  }
  int startOffset=editor.getSelectionModel().getSelectionStart();
  int endOffset=editor.getSelectionModel().getSelectionEnd();
  StringBuilder builder=StringBuilderSpinAllocator.alloc();
  try {
    final String text=editor.getDocument().getCharsSequence().subSequence(startOffset,endOffset).toString();
    toCase(builder,text,true);
    if (text.equals(builder.toString())) {
      toCase(builder,text,false);
    }
    final String finalText=builder.toString();
    editor.getDocument().replaceString(startOffset,endOffset,finalText);
    editor.getSelectionModel().setSelection(startOffset,startOffset + finalText.length());
  }
  finally {
    StringBuilderSpinAllocator.dispose(builder);
  }
}
