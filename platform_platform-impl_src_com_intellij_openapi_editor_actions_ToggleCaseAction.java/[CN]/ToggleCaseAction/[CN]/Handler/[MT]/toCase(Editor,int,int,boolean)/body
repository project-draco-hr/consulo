{
  CharSequence text=editor.getDocument().getImmutableCharSequence();
  EditorHighlighter highlighter;
  if (editor instanceof EditorEx) {
    highlighter=((EditorEx)editor).getHighlighter();
  }
 else {
    highlighter=new EmptyEditorHighlighter(null);
    highlighter.setText(text);
  }
  HighlighterIterator iterator=highlighter.createIterator(startOffset);
  StringBuilder builder=new StringBuilder(endOffset - startOffset);
  while (!iterator.atEnd()) {
    int start=trim(iterator.getStart(),startOffset,endOffset);
    int end=trim(iterator.getEnd(),startOffset,endOffset);
    CharSequence fragment=text.subSequence(start,end);
    builder.append(iterator.getTokenType() == VALID_STRING_ESCAPE_TOKEN ? fragment : lower ? fragment.toString().toLowerCase(Locale.getDefault()) : fragment.toString().toUpperCase(Locale.getDefault()));
    if (end == endOffset)     break;
    iterator.advance();
  }
  return builder.toString();
}
