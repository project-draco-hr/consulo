{
  final Ref<Boolean> toLowerCase=new Ref<Boolean>(Boolean.FALSE);
  runForCaret(editor,caret,new CaretAction(){
    @Override public void perform(    Caret caret){
      if (!caret.hasSelection()) {
        caret.selectWordAtCaret(true);
      }
      int selectionStartOffset=caret.getSelectionStart();
      int selectionEndOffset=caret.getSelectionEnd();
      String originalText=editor.getDocument().getText(new TextRange(selectionStartOffset,selectionEndOffset));
      if (!originalText.equals(toCase(editor,selectionStartOffset,selectionEndOffset,true))) {
        toLowerCase.set(Boolean.TRUE);
      }
    }
  }
);
  runForCaret(editor,caret,new CaretAction(){
    @Override public void perform(    Caret caret){
      VisualPosition caretPosition=caret.getVisualPosition();
      int selectionStartOffset=caret.getSelectionStart();
      int selectionEndOffset=caret.getSelectionEnd();
      VisualPosition selectionStartPosition=caret.getSelectionStartPosition();
      VisualPosition selectionEndPosition=caret.getSelectionEndPosition();
      caret.removeSelection();
      editor.getDocument().replaceString(selectionStartOffset,selectionEndOffset,toCase(editor,selectionStartOffset,selectionEndOffset,toLowerCase.get()));
      caret.moveToVisualPosition(caretPosition);
      caret.setSelection(selectionStartPosition,selectionStartOffset,selectionEndPosition,selectionEndOffset);
    }
  }
);
}
