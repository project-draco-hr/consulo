{
  Map<VirtualFile,T> repositories;
  try {
    REPO_LOCK.readLock().lock();
    repositories=new HashMap<VirtualFile,T>(myRepositories);
  }
  finally {
    REPO_LOCK.readLock().unlock();
  }
  final VirtualFile[] roots=myVcsManager.getRootsUnderVcs(myVcs);
  for (Iterator<Map.Entry<VirtualFile,T>> iterator=repositories.entrySet().iterator(); iterator.hasNext(); ) {
    if (!ArrayUtil.contains(iterator.next().getValue().getRoot(),roots)) {
      iterator.remove();
    }
  }
  for (  VirtualFile root : roots) {
    if (!repositories.containsKey(root)) {
      if (isRootValid(root)) {
        try {
          T repository=createRepository(root);
          repositories.put(root,repository);
        }
 catch (        IllegalStateException e) {
          LOG.error("Couldn't initialize Repository in " + root.getPresentableUrl(),e);
        }
      }
 else {
        LOG.info("Invalid vcs root: " + root);
      }
    }
  }
  REPO_LOCK.writeLock().lock();
  try {
    myRepositories.clear();
    myRepositories.putAll(repositories);
    myInitializationWaiter.countDown();
  }
  finally {
    REPO_LOCK.writeLock().unlock();
  }
}
