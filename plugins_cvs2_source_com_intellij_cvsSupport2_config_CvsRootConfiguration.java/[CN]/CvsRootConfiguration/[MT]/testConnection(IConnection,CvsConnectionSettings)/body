{
  ErrorMessagesProcessor errorProcessor=new ErrorMessagesProcessor();
  final CvsExecutionEnvironment cvsExecutionEnvironment=new CvsExecutionEnvironment(errorProcessor,CvsExecutionEnvironment.DUMMY_STOPPER,errorProcessor,new ModalityContextImpl(true),PostCvsActivity.DEAF);
  final CvsResult result=new CvsResultEx();
  try {
    ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
      public void run(){
        final GetModulesListOperation operation=new GetModulesListOperation(settings);
        final CvsRootProvider cvsRootProvider=operation.getCvsRootProvider();
        try {
          if (connection instanceof SelfTestingConnection) {
            ((SelfTestingConnection)connection).test(CvsListenerWithProgress.createOnProgress());
          }
          operation.execute(cvsRootProvider,cvsExecutionEnvironment,connection);
        }
 catch (        ValidRequestsExpectedException ex) {
          result.addError(new CvsException(ex,cvsRootProvider.getCvsRootAsString()));
        }
catch (        CommandException ex) {
          result.addError(new CvsException(ex.getUnderlyingException(),cvsRootProvider.getCvsRootAsString()));
        }
catch (        ProcessCanceledException ex) {
          result.setIsCanceled();
        }
catch (        BugLog.BugException e) {
          LOG.error(e);
        }
catch (        Exception e) {
          result.addError(new CvsException(e,cvsRootProvider.getCvsRootAsString()));
        }
      }
    }
,CvsBundle.message("operation.name.test.connection"),true,null);
    if (result.isCanceled())     throw new ProcessCanceledException();
    if (!result.hasNoErrors()) {
      VcsException vcsException=result.composeError();
      throw new AuthenticationException(vcsException.getLocalizedMessage(),vcsException.getCause());
    }
    List<VcsException> errors=errorProcessor.getErrors();
    if (!errors.isEmpty()) {
      VcsException firstError=errors.get(0);
      throw new AuthenticationException(firstError.getLocalizedMessage(),firstError);
    }
  }
  finally {
    connection.close();
  }
}
