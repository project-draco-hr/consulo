def debugstate(ui, repo, nodates=None):
    'show the contents of the current dirstate'
    timestr = ''
    showdate = (not nodates)
    for (file_, ent) in sorted(repo.dirstate._map.iteritems()):
        if showdate:
            if (ent[3] == (-1)):
                locale_len = len(time.strftime('%Y-%m-%d %H:%M:%S ', time.localtime(0)))
                timestr = 'unset'
                timestr = (timestr[:locale_len] + (' ' * (locale_len - len(timestr))))
            else:
                timestr = time.strftime('%Y-%m-%d %H:%M:%S ', time.localtime(ent[3]))
        if (ent[1] & 8192):
            mode = 'lnk'
        else:
            mode = ('%3o' % (ent[1] & 511))
        ui.write(('%c %s %10d %s%s\n' % (ent[0], mode, ent[2], timestr, file_)))
    for f in repo.dirstate.copies():
        ui.write((_('copy: %s -> %s\n') % (repo.dirstate.copied(f), f)))
