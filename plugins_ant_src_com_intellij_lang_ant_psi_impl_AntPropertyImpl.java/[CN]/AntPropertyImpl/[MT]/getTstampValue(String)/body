{
  final XmlTag se=getSourceElement();
  Date d=new Date();
  final XmlTag formatTag=se.findFirstSubTag(AntFileImpl.FORMAT_TAG);
  if (formatTag != null) {
    final String offsetStr=formatTag.getAttributeValue("offset");
    int offset;
    if (offsetStr != null) {
      try {
        offset=Integer.parseInt(offsetStr);
      }
 catch (      NumberFormatException e) {
        offset=0;
      }
      final String unitStr=formatTag.getAttributeValue("unit");
      int unit=0;
      if (unitStr != null) {
        if ("millisecond".equals(unitStr)) {
          unit=Calendar.MILLISECOND;
        }
 else         if ("second".equals(unitStr)) {
          unit=Calendar.SECOND;
        }
 else         if ("minute".equals(unitStr)) {
          unit=Calendar.MINUTE;
        }
 else         if ("hour".equals(unitStr)) {
          unit=Calendar.HOUR_OF_DAY;
        }
 else         if ("day".equals(unitStr)) {
          unit=Calendar.DAY_OF_MONTH;
        }
 else         if ("week".equals(unitStr)) {
          unit=Calendar.WEEK_OF_YEAR;
        }
 else         if ("year".equals(unitStr)) {
          unit=Calendar.YEAR;
        }
      }
      if (offset != 0 && unit != 0) {
        final Calendar cal=Calendar.getInstance();
        cal.setTime(d);
        cal.add(unit,offset);
        d=cal.getTime();
      }
    }
  }
  final String _propName=propName != null ? cutPrefix(propName) : null;
  if (_propName != null) {
    if (_propName.equals("DSTAMP")) {
      return new SimpleDateFormat("yyyyMMdd").format(d);
    }
 else     if (_propName.equals("TSTAMP")) {
      return new SimpleDateFormat("HHmm").format(d);
    }
 else     if (_propName.equals("TODAY")) {
      return new SimpleDateFormat("MMMM d yyyy",Locale.US).format(d);
    }
  }
  for (  XmlAttributeValue value : getTstampPropertyAttributeValues()) {
    if (value != null && (_propName == null || _propName.equals(value.getValue()))) {
      if (formatTag != null) {
        final String pattern=formatTag.getAttributeValue("pattern");
        final DateFormat format=(pattern != null) ? new SimpleDateFormat(pattern) : DateFormat.getTimeInstance();
        final String tz=formatTag.getAttributeValue("timezone");
        if (tz != null) {
          format.setTimeZone(TimeZone.getTimeZone(tz));
        }
        return format.format(d);
      }
    }
  }
  return null;
}
