{
  final TextRange selection=new TextRange(editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd());
  final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  if (file == null)   return Collections.emptyList();
  final List<T> results=new ArrayList<T>();
  final PsiElementVisitor visitor=new JavaRecursiveElementWalkingVisitor(){
    @Override public void visitElement(    PsiElement element){
      if (!selection.intersects(element.getTextRange()))       return;
      if (filter.isAssignableFrom(element.getClass())) {
        results.add((T)element);
        if (dontStopOnFound) {
          super.visitElement(element);
        }
      }
 else {
        super.visitElement(element);
      }
    }
  }
;
  file.accept(visitor);
  return results;
}
