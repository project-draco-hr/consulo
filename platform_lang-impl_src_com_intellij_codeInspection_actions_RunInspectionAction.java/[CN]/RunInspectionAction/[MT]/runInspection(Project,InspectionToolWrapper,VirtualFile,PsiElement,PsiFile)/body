{
  final InspectionManagerEx managerEx=(InspectionManagerEx)InspectionManager.getInstance(project);
  final Module module=virtualFile != null ? ModuleUtilCore.findModuleForFile(virtualFile,project) : null;
  AnalysisScope analysisScope=null;
  if (psiFile != null) {
    analysisScope=new AnalysisScope(psiFile);
  }
 else {
    if (virtualFile != null && virtualFile.isDirectory()) {
      final PsiDirectory psiDirectory=PsiManager.getInstance(project).findDirectory(virtualFile);
      if (psiDirectory != null) {
        analysisScope=new AnalysisScope(psiDirectory);
      }
    }
    if (analysisScope == null && virtualFile != null) {
      analysisScope=new AnalysisScope(project,Arrays.asList(virtualFile));
    }
    if (analysisScope == null) {
      analysisScope=new AnalysisScope(project);
    }
  }
  final FileFilterPanel fileFilterPanel=new FileFilterPanel();
  fileFilterPanel.init();
  final BaseAnalysisActionDialog dialog=new BaseAnalysisActionDialog(AnalysisScopeBundle.message("specify.analysis.scope",InspectionsBundle.message("inspection.action.title")),AnalysisScopeBundle.message("analysis.scope.title",InspectionsBundle.message("inspection.action.noun")),project,analysisScope,module != null ? module.getName() : null,true,AnalysisUIOptions.getInstance(project),psiElement){
    @Override protected JComponent getAdditionalActionSettings(    Project project){
      return fileFilterPanel.getPanel();
    }
    @Override public SearchScope getCustomScope(){
      return PsiSearchScopeUtil.union(fileFilterPanel.getSearchScope(),super.getCustomScope());
    }
  }
;
  dialog.show();
  if (!dialog.isOK())   return;
  final AnalysisUIOptions uiOptions=AnalysisUIOptions.getInstance(project);
  AnalysisScope scope=dialog.getScope(uiOptions,analysisScope,project,module);
  PsiElement element=psiFile == null ? psiElement : psiFile;
  RunInspectionIntention.rerunInspection(toolWrapper,managerEx,scope,element);
}
