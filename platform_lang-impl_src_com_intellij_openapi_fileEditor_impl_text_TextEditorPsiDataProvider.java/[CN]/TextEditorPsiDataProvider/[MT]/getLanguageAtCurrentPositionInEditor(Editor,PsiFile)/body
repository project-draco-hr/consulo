{
  final SelectionModel selectionModel=editor.getSelectionModel();
  int caretOffset=editor.getCaretModel().getOffset();
  int mostProbablyCorrectLanguageOffset=caretOffset == selectionModel.getSelectionStart() || caretOffset == selectionModel.getSelectionEnd() ? selectionModel.getSelectionStart() : caretOffset;
  if (selectionModel.hasSelection()) {
    return getLanguageAtOffset(psiFile,mostProbablyCorrectLanguageOffset,selectionModel.getSelectionEnd());
  }
  return PsiUtilCore.getLanguageAtOffset(psiFile,mostProbablyCorrectLanguageOffset);
}
