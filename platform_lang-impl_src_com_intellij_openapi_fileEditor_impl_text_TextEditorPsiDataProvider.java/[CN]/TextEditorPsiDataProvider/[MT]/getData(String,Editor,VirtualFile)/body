{
  if (!file.isValid())   return null;
  if (dataId.equals(AnActionEvent.injectedId(DataConstants.EDITOR))) {
    if (PsiDocumentManager.getInstance(e.getProject()).isUncommited(e.getDocument())) {
      return e;
    }
 else {
      return InjectedLanguageUtil.getEditorForInjectedLanguageNoCommit(e,getPsiFile(e,file));
    }
  }
  if (dataId.equals(AnActionEvent.injectedId(DataConstants.PSI_ELEMENT))) {
    return getPsiElementIn((Editor)getData(AnActionEvent.injectedId(DataConstants.EDITOR),e,file),file);
  }
  if (DataConstants.PSI_ELEMENT.equals(dataId)) {
    return getPsiElementIn(e,file);
  }
  if (dataId.equals(AnActionEvent.injectedId(DataConstants.LANGUAGE))) {
    PsiFile psiFile=(PsiFile)getData(AnActionEvent.injectedId(DataConstants.PSI_FILE),e,file);
    Editor editor=(Editor)getData(AnActionEvent.injectedId(DataConstants.EDITOR),e,file);
    if (psiFile == null || editor == null)     return null;
    return getLanguageAtCurrentPositionInEditor(editor,psiFile);
  }
  if (DataConstants.LANGUAGE.equals(dataId)) {
    final PsiFile psiFile=getPsiFile(e,file);
    if (psiFile == null)     return null;
    return getLanguageAtCurrentPositionInEditor(e,psiFile);
  }
  if (dataId.equals(AnActionEvent.injectedId(DataConstants.VIRTUAL_FILE))) {
    PsiFile psiFile=(PsiFile)getData(AnActionEvent.injectedId(DataConstants.PSI_FILE),e,file);
    if (psiFile == null)     return null;
    return psiFile.getVirtualFile();
  }
  if (dataId.equals(AnActionEvent.injectedId(DataConstants.PSI_FILE))) {
    Editor editor=(Editor)getData(AnActionEvent.injectedId(DataConstants.EDITOR),e,file);
    if (editor == null)     return null;
    return PsiDocumentManager.getInstance(editor.getProject()).getPsiFile(editor.getDocument());
  }
  if (dataId.equals(DataConstants.PSI_FILE)) {
    return getPsiFile(e,file);
  }
  if (LangDataKeys.IDE_VIEW.is(dataId)) {
    final PsiFile psiFile=PsiManager.getInstance(e.getProject()).findFile(file);
    final PsiDirectory psiDirectory=psiFile != null ? psiFile.getParent() : null;
    if (psiDirectory != null && psiDirectory.isPhysical()) {
      return new IdeView(){
        public void selectElement(        final PsiElement element){
          Editor editor=EditorHelper.openInEditor(element);
          if (editor != null) {
            ToolWindowManager.getInstance(element.getProject()).activateEditorComponent();
          }
        }
        public PsiDirectory[] getDirectories(){
          return new PsiDirectory[]{psiDirectory};
        }
        public PsiDirectory getOrChooseDirectory(){
          return psiDirectory;
        }
      }
;
    }
  }
  return null;
}
