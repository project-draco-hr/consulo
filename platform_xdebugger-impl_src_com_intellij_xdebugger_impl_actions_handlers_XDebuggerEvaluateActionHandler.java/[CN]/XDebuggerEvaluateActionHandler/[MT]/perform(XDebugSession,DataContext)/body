{
  XDebuggerEditorsProvider editorsProvider=session.getDebugProcess().getEditorsProvider();
  XStackFrame stackFrame=session.getCurrentStackFrame();
  if (stackFrame == null)   return;
  final XDebuggerEvaluator evaluator=stackFrame.getEvaluator();
  if (evaluator == null)   return;
  @Nullable Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  @Nullable Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  String selectedText=editor != null ? editor.getSelectionModel().getSelectedText() : null;
  if (selectedText != null) {
    selectedText=evaluator.formatTextForEvaluation(selectedText);
  }
  String text=selectedText;
  if (text == null && editor != null) {
    Document document=editor.getDocument();
    TextRange range=evaluator.getExpressionRangeAtOffset(project,document,editor.getCaretModel().getOffset(),true);
    text=range == null ? null : document.getText(range);
  }
  if (text == null) {
    XValue value=XDebuggerTreeActionBase.getSelectedValue(dataContext);
    if (value != null) {
      text=value.getEvaluationExpression();
    }
  }
  if (text == null) {
    text="";
  }
  final XDebuggerEvaluationDialog dialog=new XDebuggerEvaluationDialog(session,editorsProvider,evaluator,text,stackFrame.getSourcePosition());
  dialog.show();
}
