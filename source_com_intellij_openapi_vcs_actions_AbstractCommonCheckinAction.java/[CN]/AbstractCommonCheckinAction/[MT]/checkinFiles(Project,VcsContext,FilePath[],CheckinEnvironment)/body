{
  final boolean showDialog=ProjectLevelVcsManagerEx.getInstanceEx(project).getOptions(VcsConfiguration.StandardOption.CHECKIN).getValue() || OptionsDialog.shiftIsPressed(context.getModifiers());
  if (showDialog) {
    CheckinFileDialog dialog=new CheckinFileDialog(project,getActionName(context),checkinEnvironment,roots);
    dialog.show();
    if (!dialog.isOK())     return;
    checkinFiles(checkinEnvironment,roots,project,dialog.getPreparedComment(checkinEnvironment),context,dialog.getHandlers());
  }
 else {
    final List<CheckinHandler> handlers=new ArrayList<CheckinHandler>();
    final List<CheckinHandlerFactory> factories=ProjectLevelVcsManager.getInstance(project).getRegisteredCheckinHandlerFactories();
    final CheckinProjectPanel checkinPanel=createMockPanel(getVirtualFiles(roots),getFiles(roots),project,checkinEnvironment.prepareCheckinMessage(CheckinDialog.getInitialMessage(roots,project)),getVcs(checkinEnvironment,project));
    for (    CheckinHandlerFactory factory : factories) {
      handlers.add(factory.createHandler(checkinPanel));
    }
    for (    CheckinHandler handler : handlers) {
      final CheckinHandler.ReturnResult returnResult=handler.beforeCheckin();
      if (returnResult != CheckinHandler.ReturnResult.COMMIT) {
        return;
      }
    }
    checkinFiles(checkinEnvironment,roots,project,checkinPanel.getCommitMessage(),context,handlers);
  }
}
