{
  VcsConfiguration configuration=VcsConfiguration.getInstance(project);
  if (configuration.SHOW_CHECKIN_OPTIONS || OptionsDialog.shiftIsPressed(context.getModifiers())) {
    CheckinFileDialog dialog=new CheckinFileDialog(project,getActionName(context),checkinEnvironment,roots);
    dialog.show();
    if (!dialog.isOK())     return;
    List<VcsException> vcsExceptions=checkinEnvironment.commit(roots,project,dialog.getPreparedComment(checkinEnvironment));
    if (!vcsExceptions.isEmpty()) {
      AbstractVcsHelper.getInstance(project).showErrors(vcsExceptions,getActionName(context));
    }
  }
 else {
    List<VcsException> vcsExceptions=checkinEnvironment.commit(roots,project,checkinEnvironment.prepareCheckinMessage(CheckinDialog.getInitialMessage(roots,project)));
    if (!vcsExceptions.isEmpty()) {
      AbstractVcsHelper.getInstance(project).showErrors(vcsExceptions,getActionName(context));
    }
  }
  final LvcsAction lvcsAction=LocalVcs.getInstance(project).startAction(getActionName(context),"",true);
  VirtualFileManager.getInstance().refresh(true,new Runnable(){
    public void run(){
      lvcsAction.finish();
      FileStatusManager.getInstance(project).fileStatusesChanged();
      final Refreshable refreshablePanel=context.getRefreshableDialog();
      if (refreshablePanel != null) {
        refreshablePanel.refresh();
      }
      refreshFileView(project);
    }
  }
);
}
