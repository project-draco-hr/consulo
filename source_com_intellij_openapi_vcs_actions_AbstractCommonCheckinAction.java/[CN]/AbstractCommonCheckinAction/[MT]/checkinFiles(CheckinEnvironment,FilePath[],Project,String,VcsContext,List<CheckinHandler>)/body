{
  Runnable checkinFilesAction=new Runnable(){
    public void run(){
      List<VcsException> vcsExceptions=checkinEnvironment.commit(roots,project,message);
      try {
        if (!vcsExceptions.isEmpty()) {
          AbstractVcsHelper.getInstance(project).showErrors(vcsExceptions,getActionName(context));
        }
        final LvcsAction lvcsAction=LocalVcs.getInstance(project).startAction(getActionName(context),"",true);
        VcsUtil.refreshFiles(roots,new Runnable(){
          public void run(){
            lvcsAction.finish();
            FileStatusManager.getInstance(project).fileStatusesChanged();
            final Refreshable refreshablePanel=context.getRefreshableDialog();
            if (refreshablePanel != null) {
              refreshablePanel.refresh();
            }
            refreshFileView(project);
          }
        }
);
      }
  finally {
        commitCompleted(vcsExceptions,VcsConfiguration.getInstance(project),handlers);
      }
    }
  }
;
  AbstractVcsHelper.getInstance(project).optimizeImportsAndReformatCode(getVirtualFiles(roots),VcsConfiguration.getInstance(project),checkinFilesAction,true);
}
