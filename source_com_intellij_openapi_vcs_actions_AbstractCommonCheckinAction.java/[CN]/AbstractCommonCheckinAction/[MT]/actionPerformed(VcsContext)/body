{
  final Project project=context.getProject();
  if (project == null)   return;
  FilePath[] roots=filterDescindingFiles(getRoots(context),project);
  if (ApplicationManager.getApplication().isDispatchThread()) {
    ApplicationManager.getApplication().saveAll();
  }
  boolean enforceOldCommit=false;
  final AbstractVcs[] activeVcss=ProjectLevelVcsManager.getInstance(project).getAllActiveVcss();
  for (  AbstractVcs activeVcs : activeVcss) {
    if (activeVcs.getChangeProvider() == null) {
      enforceOldCommit=true;
    }
  }
  if (enforceOldCommit) {
    oldActionPerformed(roots,project,context);
  }
 else {
    if (ChangeListManager.getInstance(project).ensureUpToDate(true)) {
      ChangeList initialSelection;
      ChangeList[] selectedChangeLists=context.getSelectedChangeLists();
      if (selectedChangeLists != null && selectedChangeLists.length > 0) {
        initialSelection=ChangeListManager.getInstance(project).findChangeList(selectedChangeLists[0].getName());
      }
 else {
        Change[] selectedChanges=context.getSelectedChanges();
        if (selectedChanges != null && selectedChanges.length > 0) {
          initialSelection=ChangeListManager.getInstance(project).getChangeList(selectedChanges[0]);
        }
 else {
          initialSelection=ChangeListManager.getInstance(project).getDefaultChangeList();
        }
      }
      CommitChangeListDialog.commitPaths(project,Arrays.asList(roots),initialSelection);
    }
  }
}
