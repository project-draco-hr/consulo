{
  Runnable checkinAction=new Runnable(){
    public void run(){
      List<VcsException> vcsExceptions=new ArrayList<VcsException>();
      vcsExceptions.addAll(checkinEnvironment.commit(roots,project,comment));
      if (!vcsExceptions.isEmpty()) {
        AbstractVcsHelper.getInstance(project).showErrors(vcsExceptions,getActionName(context));
      }
      final LvcsAction lvcsAction=LocalVcs.getInstance(project).startAction(getActionName(context),"",true);
      VcsUtil.refreshFiles(roots,new Runnable(){
        public void run(){
          lvcsAction.finish();
          FileStatusManager.getInstance(project).fileStatusesChanged();
          final Refreshable refreshablePanel=context.getRefreshableDialog();
          if (refreshablePanel != null) {
            refreshablePanel.refresh();
          }
          refreshFileView(project);
        }
      }
);
      processErrors(vcsExceptions,VcsConfiguration.getInstance(project));
    }
  }
;
  AbstractVcsHelper.getInstance(project).optimizeImportsAndReformatCode(getVirtualFiles(roots),VcsConfiguration.getInstance(project),checkinAction,true);
}
