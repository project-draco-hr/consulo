{
  final PsiManager psiManager=PsiManager.getInstance(project);
  final List<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  final Set<PsiPackage> topLevelPackages=new HashSet<PsiPackage>();
  for (Iterator<VirtualFile> it=sourceRoots.iterator(); it.hasNext(); ) {
    final VirtualFile root=it.next();
    final PsiDirectory directory=psiManager.findDirectory(root);
    if (directory == null) {
      continue;
    }
    final PsiPackage directoryPackage=directory.getPackage();
    if (directoryPackage == null || isPackageDefault(directoryPackage)) {
      final PsiDirectory[] subdirectories=directory.getSubdirectories();
      for (int i=0; i < subdirectories.length; i++) {
        final PsiPackage aPackage=subdirectories[i].getPackage();
        if (aPackage != null && !isPackageDefault(aPackage)) {
          topLevelPackages.add(aPackage);
        }
      }
      children.addAll(getDirectoryChildren(directory,settings,false));
    }
 else {
      topLevelPackages.add(directoryPackage);
    }
  }
  for (Iterator<PsiPackage> it=topLevelPackages.iterator(); it.hasNext(); ) {
    addPackageAsChild(children,it.next(),module,settings,inLibrary);
  }
  return children;
}
