{
  PsiPackage aPackage=psiDirectory.getPackage();
  final VirtualFile virtualFile=psiDirectory.getVirtualFile();
  if (isPackage(psiDirectory) && !isSourceRoot(psiDirectory) && !settings.isFlattenPackages()&& settings.isHideEmptyMiddlePackages()) {
    if (TreeViewUtil.isEmptyMiddlePackage(psiDirectory,true)) {
      node.setValue(null);
      return;
    }
  }
  final boolean isWritable=virtualFile.isWritable();
  final String name;
  if (parentValue instanceof Project) {
    name=psiDirectory.getVirtualFile().getPresentableUrl();
  }
 else {
    if (isFQNameShown(psiDirectory,parentValue,settings)) {
      name=(settings.isAbbreviatePackageNames() ? TreeViewUtil.calcAbbreviatedPackageFQName(aPackage) : aPackage.getQualifiedName());
    }
 else {
      if (!isSourceRoot(psiDirectory) && aPackage != null && aPackage.getQualifiedName().length() > 0 && parentValue instanceof PsiDirectory) {
        final PsiPackage parentPackageInTree=((PsiDirectory)parentValue).getPackage();
        PsiPackage parentPackage=aPackage.getParentPackage();
        final StringBuffer buf=new StringBuffer();
        buf.append(aPackage.getName());
        while (parentPackage != null && !parentPackage.equals(parentPackageInTree)) {
          final String parentPackageName=parentPackage.getName();
          if (parentPackageName == null || "".equals(parentPackageName)) {
            break;
          }
          buf.insert(0,".");
          buf.insert(0,parentPackageName);
          parentPackage=parentPackage.getParentPackage();
        }
        name=buf.toString();
      }
 else {
        name=psiDirectory.getName();
      }
    }
  }
  final String packagePrefix=isSourceRoot(psiDirectory) && aPackage != null ? aPackage.getQualifiedName() : "";
  data.setPresentableText(name);
  data.setLocationString(packagePrefix);
  if (isPackage(psiDirectory)) {
    data.setOpenIcon(addReadMark(PACKAGE_OPEN_ICON,isWritable));
    data.setClosedIcon(addReadMark(PACKAGE_CLOSED_ICON,isWritable));
  }
 else {
    data.setOpenIcon(addReadMark(TREE_OPEN_ICON,isWritable));
    data.setClosedIcon(addReadMark(TREE_CLOSED_ICON,isWritable));
  }
}
