{
  final GlobalSearchScope scopeToShow=getScopeToShow(project,module,searchInLibraries);
  final PsiDirectory[] dirs=aPackage.getDirectories(scopeToShow);
  final Set<PsiPackage> subpackages=new HashSet<PsiPackage>();
  for (int idx=0; idx < dirs.length; idx++) {
    PsiDirectory dir=dirs[idx];
    final PsiDirectory[] subdirectories=dir.getSubdirectories();
    for (int i=0; i < subdirectories.length; i++) {
      PsiDirectory subdirectory=subdirectories[i];
      final PsiPackage psiPackage=subdirectory.getPackage();
      if (psiPackage != null) {
        final String name=psiPackage.getName();
        if (name != null && !"".equals(name)) {
          subpackages.add(psiPackage);
        }
      }
    }
  }
  return subpackages.toArray(new PsiPackage[subpackages.size()]);
}
