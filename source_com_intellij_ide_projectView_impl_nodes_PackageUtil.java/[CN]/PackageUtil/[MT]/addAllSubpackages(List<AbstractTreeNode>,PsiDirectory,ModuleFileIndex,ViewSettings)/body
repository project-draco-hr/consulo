{
  final Project project=dir.getProject();
  PsiDirectory[] subdirs=dir.getSubdirectories();
  for (  PsiDirectory subdir : subdirs) {
    if (JavaDirectoryService.getInstance().getPackage(subdir) == null) {
      continue;
    }
    if (moduleFileIndex != null) {
      if (!moduleFileIndex.isInContent(subdir.getVirtualFile())) {
        continue;
      }
    }
    if (viewSettings.isHideEmptyMiddlePackages()) {
      if (!TreeViewUtil.isEmptyMiddlePackage(subdir,false)) {
        container.add(new PsiDirectoryNode(project,subdir,viewSettings));
      }
    }
 else {
      container.add(new PsiDirectoryNode(project,subdir,viewSettings));
    }
    addAllSubpackages(container,subdir,moduleFileIndex,viewSettings);
  }
}
