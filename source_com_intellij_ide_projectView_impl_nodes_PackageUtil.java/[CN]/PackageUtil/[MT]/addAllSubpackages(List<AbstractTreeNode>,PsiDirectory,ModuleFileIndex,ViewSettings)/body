{
  final Project project=dir.getManager().getProject();
  PsiDirectory[] subdirs=dir.getSubdirectories();
  for (int i=0; i < subdirs.length; i++) {
    PsiDirectory subdir=subdirs[i];
    if (subdir.getPackage() == null) {
      continue;
    }
    if (moduleFileIndex != null) {
      if (!moduleFileIndex.isInContent(subdir.getVirtualFile())) {
        continue;
      }
    }
    if (viewSettings.isHideEmptyMiddlePackages()) {
      if (!TreeViewUtil.isEmptyMiddlePackage(subdir,false)) {
        container.add(new PsiDirectoryNode(project,subdir,viewSettings));
      }
    }
 else {
      container.add(new PsiDirectoryNode(project,subdir,viewSettings));
    }
    addAllSubpackages(container,subdir,moduleFileIndex,viewSettings);
  }
}
