{
  final boolean shouldSkipPackage=settings.isHideEmptyMiddlePackages() && isPackageEmpty(aPackage,module,false,inLibrary);
  final Project project=aPackage.getManager().getProject();
  if (!shouldSkipPackage) {
    children.add(new PackageElementNode(project,new PackageElement(module,aPackage,inLibrary),settings));
  }
  if (settings.isFlattenPackages() || shouldSkipPackage) {
    final PsiPackage[] subpackages=PackageUtil.getSubpackages(aPackage,module,project,inLibrary);
    for (int idx=0; idx < subpackages.length; idx++) {
      addPackageAsChild(children,subpackages[idx],module,settings,inLibrary);
    }
  }
}
