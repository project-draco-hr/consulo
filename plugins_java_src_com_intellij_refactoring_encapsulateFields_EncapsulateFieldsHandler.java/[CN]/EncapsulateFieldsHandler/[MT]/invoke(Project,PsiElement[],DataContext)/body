{
  PsiClass aClass=null;
  final HashSet<PsiField> preselectedFields=new HashSet<PsiField>();
  if (elements.length == 1) {
    if (elements[0] instanceof PsiClass) {
      aClass=(PsiClass)elements[0];
    }
 else     if (elements[0] instanceof PsiField) {
      PsiField field=(PsiField)elements[0];
      aClass=field.getContainingClass();
      preselectedFields.add(field);
    }
 else {
      return;
    }
  }
 else {
    for (    PsiElement element : elements) {
      if (!(element instanceof PsiField)) {
        return;
      }
      PsiField field=(PsiField)element;
      if (aClass == null) {
        aClass=field.getContainingClass();
        preselectedFields.add(field);
      }
 else {
        if (aClass.equals(field.getContainingClass())) {
          preselectedFields.add(field);
        }
 else {
          String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("fields.to.be.refactored.should.belong.to.the.same.class"));
          Editor editor=CommonDataKeys.EDITOR.getData(dataContext);
          CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.ENCAPSULATE_FIELDS);
          return;
        }
      }
    }
  }
  LOG.assertTrue(aClass != null);
  final PsiField[] fields=aClass.getFields();
  if (fields.length == 0) {
    CommonRefactoringUtil.showErrorHint(project,CommonDataKeys.EDITOR.getData(dataContext),"Class has no fields to encapsulate",REFACTORING_NAME,HelpID.ENCAPSULATE_FIELDS);
    return;
  }
  if (aClass.isInterface()) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("encapsulate.fields.refactoring.cannot.be.applied.to.interface"));
    Editor editor=CommonDataKeys.EDITOR.getData(dataContext);
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.ENCAPSULATE_FIELDS);
    return;
  }
  if (!CommonRefactoringUtil.checkReadOnlyStatus(project,aClass))   return;
  EncapsulateFieldsDialog dialog=createDialog(project,aClass,preselectedFields);
  dialog.show();
}
