{
  final PsiElement bottomost=file.findElementAt(offset);
  if (bottomost != null && bottomost.getLanguage().getEffectiveFormattingModelBuilder(bottomost) != null) {
    return bottomost;
  }
  final Language fileLang=file.getLanguage();
  if (fileLang instanceof CompositeLanguage) {
    return file.getViewProvider().findElementAt(offset,fileLang);
  }
  return bottomost;
}
