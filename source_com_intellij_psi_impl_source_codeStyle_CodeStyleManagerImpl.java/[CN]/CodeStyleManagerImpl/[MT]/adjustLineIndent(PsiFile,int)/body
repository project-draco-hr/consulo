{
  final PsiElement element=file.findElementAt(offset);
  if (element == null)   return offset;
  if (CodeFormatterFacade.useBlockFormatter(file) && CodeFormatterFacade.useBlockFormatter(element.getLanguage())) {
    final CodeStyleSettings settings=getSettings();
    final CodeStyleSettings.IndentOptions indentOptions=settings.getIndentOptions(file.getFileType());
    final TextRange significantRange=getSignificantRange(file,offset);
    final PsiBasedFormattingModel model=new PsiBasedFormattingModel(file,settings,SourceTreeToPsiMap.psiElementToTree(file.findElementAt(offset)).getTextRange());
    int result=Formatter.getInstance().adjustLineIndent(model,CodeFormatterFacade.createBlock(file,settings),settings,indentOptions,offset,significantRange);
    return result;
  }
 else {
    return adjustLineIndent(file,offset,true);
  }
}
