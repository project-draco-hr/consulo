{
  CheckUtil.checkWritable(element);
  if (!SourceTreeToPsiMap.hasTreeElement(element))   return element;
  ASTNode treeElement=SourceTreeToPsiMap.psiElementToTree(element);
  if (treeElement instanceof CompositeElement) {
    ChameleonTransforming.transformChildren(treeElement,true);
  }
  FileType fileType=StdFileTypes.JAVA;
  PsiFile file=element.getContainingFile();
  if (file != null) {
    fileType=file.getFileType();
  }
  Helper helper=new Helper(fileType,myProject);
  final CodeFormatterFacade codeFormatter=new CodeFormatterFacade(getSettings(),helper);
  final PsiElement start=element.getContainingFile().findElementAt(startOffset);
  final PsiElement end=element.getContainingFile().findElementAt(endOffset);
  final SmartPsiElementPointer startPointer=start == null ? null : SmartPointerManager.getInstance(getProject()).createSmartPsiElementPointer(start);
  final SmartPsiElementPointer endPointer=end == null ? null : SmartPointerManager.getInstance(getProject()).createSmartPsiElementPointer(end);
  final PsiElement formatted=SourceTreeToPsiMap.treeElementToPsi(codeFormatter.processRange(treeElement,startOffset,endOffset));
  final PsiElement startElement=startPointer == null ? null : startPointer.getElement();
  final PsiElement endElement=endPointer == null ? null : endPointer.getElement();
  if (!canChangeWhiteSpacesOnly && startElement != null && endElement != null) {
    return new BraceEnforcer(getSettings()).process(formatted,startElement.getTextRange().getStartOffset(),endElement.getTextRange().getEndOffset());
  }
 else {
    return formatted;
  }
}
