{
  PatchInfo patch=newVersion.findPatchFor(ApplicationInfo.getInstance().getBuildNumber().trim());
  if (patch == null)   throw new IOException("No patch is available for current version");
  String osSuffix="";
  if (SystemInfo.isWindows)   osSuffix="-win";
  if (SystemInfo.isMac)   osSuffix="-mac";
  if (SystemInfo.isUnix)   osSuffix="-unix";
  String fileName="idea-" + patch.getFromBuild() + "-"+ patch.getToBuild()+ "-patch"+ osSuffix+ ".jar";
  URLConnection connection=null;
  InputStream in=null;
  OutputStream out=null;
  File patchFile=new File(PathManager.getHomePath(),"patch.jar");
  try {
    connection=new URL(new URL(getPatchesUrl()),fileName).openConnection();
    in=UrlConnectionUtil.getConnectionInputStreamWithException(connection,i);
    out=new BufferedOutputStream(new FileOutputStream(patchFile));
    StreamUtil.copyStreamContent(in,out);
  }
 catch (  IOException e) {
    patchFile.delete();
    throw e;
  }
catch (  Throwable e) {
    patchFile.delete();
    throw new RuntimeException(e);
  }
 finally {
    if (out != null)     out.close();
    if (in != null)     in.close();
    if (connection instanceof HttpURLConnection)     ((HttpURLConnection)connection).disconnect();
  }
  return true;
}
