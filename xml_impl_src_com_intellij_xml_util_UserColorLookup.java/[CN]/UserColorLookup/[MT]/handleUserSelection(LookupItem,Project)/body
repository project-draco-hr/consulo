{
  Color myColorAtCaret=null;
  Editor selectedTextEditor=FileEditorManager.getInstance(project).getSelectedTextEditor();
  PsiElement element=PsiDocumentManager.getInstance(project).getPsiFile(selectedTextEditor.getDocument()).findElementAt(selectedTextEditor.getCaretModel().getOffset());
  if (element instanceof XmlToken) {
    myColorAtCaret=getColorFromElement(element);
  }
  Color color=ColorChooser.chooseColor(WindowManager.getInstance().suggestParentWindow(project),XmlBundle.message("choose.color.dialog.title"),myColorAtCaret,true);
  if (color != null) {
    String s=Integer.toHexString(color.getRGB() & 0xFFFFFF);
    if (s.length() != 6) {
      StringBuffer buf=new StringBuffer(s);
      for (int i=6 - buf.length(); i > 0; --i) {
        buf.insert(0,'0');
      }
      s=buf.toString();
    }
    item.setLookupString("#" + s);
  }
  return color != null;
}
