{
  DomainObjectSet<? extends IdeaModule> gradleModules=gradleProject.getModules();
  if (gradleModules == null || gradleModules.isEmpty()) {
    throw new IllegalStateException("No modules found for the target project: " + gradleProject);
  }
  Map<String,Pair<ExternalModule,IdeaModule>> result=new HashMap<String,Pair<ExternalModule,IdeaModule>>();
  for (  IdeaModule gradleModule : gradleModules) {
    if (gradleModule == null) {
      continue;
    }
    String moduleName=gradleModule.getName();
    if (moduleName == null) {
      throw new IllegalStateException("Module with undefined name detected: " + gradleModule);
    }
    ExternalModule intellijModule=new ExternalModule(moduleName,intellijProject.getProjectFileDirectoryPath());
    Pair<ExternalModule,IdeaModule> previouslyParsedModule=result.get(moduleName);
    if (previouslyParsedModule != null) {
      throw new IllegalStateException(String.format("Modules with duplicate name (%s) detected: '%s' and '%s'",moduleName,intellijModule,previouslyParsedModule));
    }
    result.put(moduleName,new Pair<ExternalModule,IdeaModule>(intellijModule,gradleModule));
    intellijProject.addModule(intellijModule);
  }
  return result;
}
