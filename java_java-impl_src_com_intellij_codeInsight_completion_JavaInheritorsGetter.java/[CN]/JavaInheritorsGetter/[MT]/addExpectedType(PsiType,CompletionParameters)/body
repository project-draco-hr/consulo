{
  if (!JavaCompletionUtil.hasAccessibleConstructor(type))   return null;
  final PsiClass psiClass=PsiUtil.resolveClassInType(type);
  if (psiClass == null)   return null;
  final PsiClass parentClass=psiClass.getContainingClass();
  if (parentClass != null && !psiClass.hasModifierProperty(PsiModifier.STATIC) && !PsiTreeUtil.isAncestor(parentClass,parameters.getPosition(),false) && !(parentClass.getContainingFile().equals(parameters.getOriginalFile()) && parentClass.getTextRange().contains(parameters.getOffset()))) {
    return null;
  }
  PsiType psiType=JavaCompletionUtil.eliminateWildcards(type);
  if (JavaSmartCompletionContributor.AFTER_NEW.accepts(parameters.getOriginalPosition()) && PsiUtil.getLanguageLevel(parameters.getOriginalFile()).isAtLeast(LanguageLevel.JDK_1_7)) {
    final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(psiClass.getProject());
    if (psiClass.hasTypeParameters() && !((PsiClassType)type).isRaw()) {
      final String canonicalText=TypeConversionUtil.erasure(psiType).getCanonicalText();
      final PsiStatement statement=elementFactory.createStatementFromText(psiType.getCanonicalText() + " v = new " + canonicalText+ "<>()",parameters.getOriginalFile());
      final PsiVariable declaredVar=(PsiVariable)((PsiDeclarationStatement)statement).getDeclaredElements()[0];
      final PsiNewExpression initializer=(PsiNewExpression)declaredVar.getInitializer();
      final boolean hasDefaultConstructorOrNoGenericsOne=PsiDiamondType.hasDefaultConstructor(psiClass) || !PsiDiamondType.haveConstructorsGenericsParameters(psiClass);
      if (hasDefaultConstructorOrNoGenericsOne && PsiDiamondType.resolveInferredTypes(initializer).getErrorMessage() == null && !psiClass.hasModifierProperty(PsiModifier.ABSTRACT)) {
        psiType=initializer.getType();
      }
    }
  }
  final LookupItem item=PsiTypeLookupItem.createLookupItem(psiType,parameters.getPosition());
  JavaCompletionUtil.setShowFQN(item);
  if (psiClass.isInterface() || psiClass.hasModifierProperty(PsiModifier.ABSTRACT)) {
    item.setAutoCompletionPolicy(AutoCompletionPolicy.NEVER_AUTOCOMPLETE);
    item.setAttribute(LookupItem.INDICATE_ANONYMOUS,"");
  }
  return LookupElementDecorator.withInsertHandler(item,myConstructorInsertHandler);
}
