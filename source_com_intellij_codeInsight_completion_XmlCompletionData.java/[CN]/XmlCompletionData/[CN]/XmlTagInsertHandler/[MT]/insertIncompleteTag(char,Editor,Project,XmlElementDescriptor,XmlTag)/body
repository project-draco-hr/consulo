{
  TemplateManager templateManager=TemplateManager.getInstance(project);
  Template template=templateManager.createTemplate("","");
  template.setToReformat(true);
  template.setToIndent(true);
  FileType fileType=tag.getContainingFile().getFileType();
  boolean htmlCode=fileType == StdFileTypes.HTML || fileType == StdFileTypes.XHTML;
  XmlAttributeDescriptor[] attributes=descriptor.getAttributesDescriptors();
  for (int i=0; i < attributes.length; i++) {
    XmlAttributeDescriptor attributeDecl=attributes[i];
    String attributeName=attributeDecl.getDefaultName();
    if (attributeDecl.isRequired()) {
      template.addTextSegment(" " + attributeName + "=\"");
      Expression expression=new MacroCallNode(MacroFactory.createMacro("complete"));
      template.addVariable(attributeName,expression,expression,true);
      template.addTextSegment("\"");
    }
 else     if (attributeDecl.isFixed() && attributeDecl.getDefaultValue() != null && !htmlCode) {
      template.addTextSegment(" " + attributeName + "=\""+ attributeDecl.getDefaultValue()+ "\"");
    }
  }
  if (completionChar == '>') {
    template.addTextSegment(">");
    template.addEndVariable();
    template.addTextSegment("</");
    template.addTextSegment(descriptor.getName(tag));
    template.addTextSegment(">");
  }
 else   if (completionChar == '/') {
    template.addTextSegment("/>");
  }
  templateManager.startTemplate(editor,template);
}
