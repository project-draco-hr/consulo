{
  PsiElement psiElement=descriptor instanceof ProblemDescriptor ? ((ProblemDescriptor)descriptor).getPsiElement() : null;
  @NonNls String message=descriptor != null ? descriptor.getDescriptionTemplate().replaceAll("<[^>]*>","") : "";
  if (isReplaceProblemDescriptorTemplateMessage) {
    message=StringUtil.replace(message,"#ref",psiElement != null && psiElement.isValid() ? psiElement.getText() : "");
  }
 else {
    final int endIndex=message.indexOf("#end");
    if (endIndex > 0) {
      message=message.substring(0,endIndex);
    }
  }
  message=StringUtil.replace(message,"#loc","");
  message=XmlUtil.unescape(message);
  return message;
}
