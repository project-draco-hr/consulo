{
  final ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.pushState();
    progress.setText(ProjectBundle.message("project.index.scanning.files.progress"));
  }
  if (forDir == null) {
    myDirToInfoMap.clear();
    myPackageNameToDirsMap.clear();
  }
  if (forDir != null) {
    VirtualFile dir=forDir;
    do {
      myDirToInfoMap.remove(dir);
      dir=dir.getParent();
    }
 while (dir != null);
  }
  ModuleManager moduleManager=ModuleManager.getInstance(myProject);
  Module[] modules=moduleManager.getModules();
  if (reverseAllSets) {
    modules=ArrayUtil.reverseArray(modules);
  }
  if (progress != null) {
    progress.setText2(ProjectBundle.message("project.index.building.exclude.roots.progress"));
  }
  Set<VirtualFile> excludeRoots=new THashSet<VirtualFile>();
  for (  Module module1 : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module1);
    excludeRoots.addAll(Arrays.asList(rootManager.getExcludeRoots()));
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.setText2(ProjectBundle.message("project.index.processing.module.content.progress",module.getName()));
    }
    VirtualFile[] contentRoots=rootManager.getContentRoots();
    if (reverseAllSets) {
      contentRoots=ArrayUtil.reverseArray(contentRoots);
    }
    for (    final VirtualFile contentRoot : contentRoots) {
      fillMapWithModuleContent(contentRoot,module,contentRoot,excludeRoots,forDir);
    }
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.setText2(ProjectBundle.message("project.index.processing.module.sources.progress",module.getName()));
    }
    ContentEntry[] contentEntries=rootManager.getContentEntries();
    if (reverseAllSets) {
      contentEntries=ArrayUtil.reverseArray(contentEntries);
    }
    for (    ContentEntry contentEntry : contentEntries) {
      SourceFolder[] sourceFolders=contentEntry.getSourceFolders();
      if (reverseAllSets) {
        sourceFolders=ArrayUtil.reverseArray(sourceFolders);
      }
      for (      SourceFolder sourceFolder : sourceFolders) {
        VirtualFile dir=sourceFolder.getFile();
        if (dir != null) {
          fillMapWithModuleSource(dir,module,sourceFolder.getPackagePrefix(),dir,sourceFolder.isTestSource(),forDir);
        }
      }
    }
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.setText2(ProjectBundle.message("project.index.processing.library.sources.progress",module.getName()));
    }
    OrderEntry[] orderEntries=rootManager.getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      boolean isLibrary=orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry;
      if (isLibrary) {
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        final VirtualFile sourceRoot : sourceRoots) {
          fillMapWithLibrarySources(sourceRoot,"",sourceRoot,forDir);
        }
      }
    }
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.setText2(ProjectBundle.message("project.index.processing.library.classes.progress",module.getName()));
    }
    OrderEntry[] orderEntries=rootManager.getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      boolean isLibrary=orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry;
      if (isLibrary) {
        VirtualFile[] classRoots=orderEntry.getFiles(OrderRootType.CLASSES);
        for (        final VirtualFile classRoot : classRoots) {
          fillMapWithLibraryClasses(classRoot,"",classRoot,forDir);
        }
      }
    }
  }
  if (progress != null) {
    progress.setText2("");
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    OrderEntry[] orderEntries=rootManager.getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      List<OrderEntry> oneEntryList=Arrays.asList(new OrderEntry[]{orderEntry});
      if (orderEntry instanceof ModuleOrderEntry) {
        Module entryModule=null;
        VirtualFile[] importedClassRoots=orderEntry.getFiles(OrderRootType.COMPILATION_CLASSES);
        for (        VirtualFile importedClassRoot : importedClassRoots) {
          fillMapWithOrderEntries(importedClassRoot,oneEntryList,entryModule,null,null,forDir,null,null);
        }
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        VirtualFile sourceRoot : sourceRoots) {
          fillMapWithOrderEntries(sourceRoot,oneEntryList,entryModule,null,null,forDir,null,null);
        }
      }
 else       if (orderEntry instanceof ModuleSourceOrderEntry) {
        Module entryModule=orderEntry.getOwnerModule();
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        VirtualFile sourceRoot : sourceRoots) {
          fillMapWithOrderEntries(sourceRoot,oneEntryList,entryModule,null,null,forDir,null,null);
        }
      }
 else       if (orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry) {
        VirtualFile[] classRoots=orderEntry.getFiles(OrderRootType.CLASSES);
        for (        VirtualFile classRoot : classRoots) {
          fillMapWithOrderEntries(classRoot,oneEntryList,null,classRoot,null,forDir,null,null);
        }
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        VirtualFile sourceRoot : sourceRoots) {
          fillMapWithOrderEntries(sourceRoot,oneEntryList,null,null,sourceRoot,forDir,null,null);
        }
      }
    }
  }
  if (progress != null) {
    progress.popState();
  }
}
