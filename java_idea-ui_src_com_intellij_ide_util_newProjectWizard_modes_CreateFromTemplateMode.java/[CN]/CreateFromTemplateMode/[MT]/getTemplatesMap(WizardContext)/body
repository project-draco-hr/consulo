{
  ProjectTemplatesFactory[] factories=ProjectTemplatesFactory.EP_NAME.getExtensions();
  final MultiMap<TemplatesGroup,ProjectTemplate> groups=new MultiMap<TemplatesGroup,ProjectTemplate>();
  for (  ProjectTemplatesFactory factory : factories) {
    for (    String group : factory.getGroups()) {
      ProjectTemplate[] templates=factory.createTemplates(group,context);
      List<ProjectTemplate> values=context.isCreatingNewProject() ? Arrays.asList(templates) : ContainerUtil.filter(templates,TEMPLATE_CONDITION);
      if (!values.isEmpty()) {
        groups.putValues(new TemplatesGroup(group,null,null),values);
      }
    }
  }
  final MultiMap<TemplatesGroup,ProjectTemplate> sorted=new MultiMap<TemplatesGroup,ProjectTemplate>();
  for (  Map.Entry<TemplatesGroup,Collection<ProjectTemplate>> entry : groups.entrySet()) {
    Collection<ProjectTemplate> templates=entry.getValue();
    if (templates.size() == 1 && !ProjectTemplatesFactory.CUSTOM_GROUP.equals(entry.getKey().getName())) {
      if (!(templates.iterator().next() instanceof LocalArchivedTemplate)) {
        sorted.putValues(new TemplatesGroup(ProjectTemplatesFactory.OTHER_GROUP,null,null),templates);
        continue;
      }
    }
    sorted.putValues(entry.getKey(),templates);
  }
  return sorted;
}
