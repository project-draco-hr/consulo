{
  ProjectTemplatesFactory[] factories=ProjectTemplatesFactory.EP_NAME.getExtensions();
  final MultiMap<String,ProjectTemplate> groups=new MultiMap<String,ProjectTemplate>();
  for (  ProjectTemplatesFactory factory : factories) {
    for (    String group : factory.getGroups()) {
      ProjectTemplate[] templates=factory.createTemplates(group,context);
      List<ProjectTemplate> values=context.isCreatingNewProject() ? Arrays.asList(templates) : ContainerUtil.filter(templates,TEMPLATE_CONDITION);
      if (!values.isEmpty()) {
        groups.putValues(group,values);
      }
    }
  }
  final MultiMap<String,ProjectTemplate> sorted=new MultiMap<String,ProjectTemplate>();
  for (  Map.Entry<String,Collection<ProjectTemplate>> entry : groups.entrySet()) {
    Collection<ProjectTemplate> templates=entry.getValue();
    if (templates.size() == 1 && !ArchivedTemplatesFactory.CUSTOM_GROUP.equals(entry.getKey())) {
      if (!(templates.iterator().next() instanceof ArchivedProjectTemplate)) {
        sorted.putValues(ProjectTemplatesFactory.OTHER_GROUP,templates);
        continue;
      }
    }
    sorted.putValues(entry.getKey(),templates);
  }
  return sorted;
}
