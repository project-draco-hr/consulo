{
  Set<JpsArtifact> affected=new HashSet<JpsArtifact>();
  for (  JpsArtifact artifact : JpsArtifactService.getInstance().getArtifacts(context.getProjectDescriptor().jpsProject)) {
    if (context.getScope().isAffected(artifact)) {
      affected.add(artifact);
    }
  }
  final Set<JpsArtifact> toBuild=ArtifactSorter.addIncludedArtifacts(affected,context.getProjectDescriptor().project,context.getProjectDescriptor().jpsModel);
  final ArtifactSorter sorter=new ArtifactSorter(context.getProjectDescriptor().jpsModel);
  final Map<JpsArtifact,JpsArtifact> selfIncludingNameMap=sorter.getArtifactToSelfIncludingNameMap();
  for (  JpsArtifact artifact : sorter.getArtifactsSortedByInclusion()) {
    context.checkCanceled();
    if (toBuild.contains(artifact)) {
      final JpsArtifact selfIncluding=selfIncludingNameMap.get(artifact);
      if (selfIncluding != null) {
        String name=selfIncluding.equals(artifact) ? "it" : "'" + selfIncluding.getName() + "' artifact";
        context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,"Cannot build '" + artifact.getName() + "' artifact: "+ name+ " includes itself in the output layout"));
        break;
      }
      if (StringUtil.isEmpty(artifact.getOutputPath())) {
        context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,"Cannot build '" + artifact.getName() + "' artifact: output path is not specified"));
        break;
      }
      buildArtifact(artifact,context);
    }
  }
}
