{
  final File projectBuildFileDestDir=VfsUtil.virtualToIoFile(project.getBaseDir());
  projectBuildFileDestDir.mkdirs();
  final List<File> generated=new ArrayList<File>();
  final File projectBuildFile=new File(projectBuildFileDestDir,BuildProperties.getProjectBuildFileName(project) + XML_EXTENSION);
  final File propertiesFile=new File(projectBuildFileDestDir,BuildProperties.getPropertyFileName(project));
  final ModuleChunk[] chunks=genOptions.getModuleChunks();
  final File[] chunkFiles=new File[chunks.length];
  for (int idx=0; idx < chunks.length; idx++) {
    final ModuleChunk chunk=chunks[idx];
    final File chunkBaseDir=BuildProperties.getModuleChunkBaseDir(chunk);
    chunkFiles[idx]=new File(chunkBaseDir,BuildProperties.getModuleChunkBuildFileName(chunk) + XML_EXTENSION);
  }
  final List<File> allFiles=new ArrayList<File>(2 + chunkFiles.length);
  allFiles.add(projectBuildFile);
  allFiles.add(propertiesFile);
  allFiles.addAll(Arrays.asList(chunkFiles));
  ensureFilesWritable(project,allFiles.toArray(new File[allFiles.size()]));
  if (!backup(projectBuildFile,project,genOptions,filesToRefresh)) {
    return null;
  }
  if (!backup(propertiesFile,project,genOptions,filesToRefresh)) {
    return null;
  }
  projectBuildFile.createNewFile();
  final DataOutputStream mainDataOutput=new DataOutputStream(new BufferedOutputStream(new FileOutputStream(projectBuildFile)));
  try {
    final MultipleFileProjectBuild build=new MultipleFileProjectBuild(project,genOptions);
    build.generate(mainDataOutput);
    generated.add(projectBuildFile);
    for (int idx=0; idx < chunks.length; idx++) {
      final ModuleChunk chunk=chunks[idx];
      final File chunkBuildFile=chunkFiles[idx];
      final File chunkBaseDir=chunkBuildFile.getParentFile();
      if (chunkBaseDir != null) {
        chunkBaseDir.mkdirs();
      }
      final boolean moduleBackupOk=backup(chunkBuildFile,project,genOptions,filesToRefresh);
      if (!moduleBackupOk) {
        return null;
      }
      chunkBuildFile.createNewFile();
      final DataOutputStream out=new DataOutputStream(new BufferedOutputStream(new FileOutputStream(chunkBuildFile)));
      try {
        new ModuleChunkAntProject(project,chunk,genOptions).generate(out);
        generated.add(chunkBuildFile);
      }
  finally {
        out.close();
      }
    }
  }
  finally {
    mainDataOutput.close();
  }
  final DataOutputStream propertiesOut=new DataOutputStream(new BufferedOutputStream(new FileOutputStream(propertiesFile)));
  try {
    new PropertyFileGenerator(project,genOptions).generate(propertiesOut);
    generated.add(propertiesFile);
  }
  finally {
    propertiesOut.close();
  }
  filesToRefresh.addAll(generated);
  return generated.toArray(new File[generated.size()]);
}
