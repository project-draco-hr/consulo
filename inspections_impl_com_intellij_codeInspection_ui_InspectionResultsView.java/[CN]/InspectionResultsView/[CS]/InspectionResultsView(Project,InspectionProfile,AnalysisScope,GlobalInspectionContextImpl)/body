{
  setLayout(new BorderLayout());
  myProject=project;
  myInspectionProfile=inspectionProfile;
  myScope=scope;
  myGlobalInspectionContext=globalInspectionContext;
  myTree=new InspectionTree(project);
  myOccurenceNavigator=new OccurenceNavigatorSupport(myTree){
    @Nullable protected Navigatable createDescriptorForNode(    DefaultMutableTreeNode node){
      if (node instanceof RefElementNode) {
        final RefElementNode refNode=(RefElementNode)node;
        if (refNode.hasDescriptorsUnder())         return null;
        final RefElement element=refNode.getElement();
        if (element == null || !element.isValid())         return null;
        final CommonProblemDescriptor problem=refNode.getProblem();
        if (problem != null) {
          return navigate(problem);
        }
        return getOpenFileDescriptor(element);
      }
 else       if (node instanceof ProblemDescriptionNode) {
        if (!((ProblemDescriptionNode)node).isValid())         return null;
        final CommonProblemDescriptor descriptor=((ProblemDescriptionNode)node).getDescriptor();
        return navigate(descriptor);
      }
      return null;
    }
    @Nullable private Navigatable navigate(    final CommonProblemDescriptor descriptor){
      if (descriptor instanceof ProblemDescriptorImpl) {
        Navigatable navigatable=((ProblemDescriptorImpl)descriptor).getNavigatable();
        if (navigatable != null) {
          return navigatable;
        }
      }
      final PsiElement psiElement=descriptor instanceof ProblemDescriptor ? ((ProblemDescriptor)descriptor).getPsiElement() : null;
      if (psiElement == null || !psiElement.isValid())       return null;
      return getOpenFileDescriptor(psiElement);
    }
    public String getNextOccurenceActionName(){
      return InspectionsBundle.message("inspection.action.go.next");
    }
    public String getPreviousOccurenceActionName(){
      return InspectionsBundle.message("inspection.actiongo.prev");
    }
  }
;
  myBrowser=new Browser(this);
  final InspectionManagerEx manager=(InspectionManagerEx)InspectionManager.getInstance(project);
  mySplitter=new Splitter(false,manager.getUIOptions().SPLITTER_PROPORTION);
  mySplitter.setFirstComponent(ScrollPaneFactory.createScrollPane(myTree));
  mySplitter.setSecondComponent(myBrowser);
  mySplitter.addPropertyChangeListener(new PropertyChangeListener(){
    public void propertyChange(    PropertyChangeEvent evt){
      if (Splitter.PROP_PROPORTION.equals(evt.getPropertyName())) {
        myGlobalInspectionContext.setSplitterProportion(((Float)evt.getNewValue()).floatValue());
      }
    }
  }
);
  myTree.getSelectionModel().addTreeSelectionListener(new TreeSelectionListener(){
    public void valueChanged(    TreeSelectionEvent e){
      syncBrowser();
      syncSource();
    }
  }
);
  myTree.addMouseListener(new MouseAdapter(){
    public void mouseClicked(    MouseEvent e){
      if (!e.isPopupTrigger() && e.getClickCount() == 2) {
        OpenSourceUtil.openSourcesFrom(DataManager.getInstance().getDataContext(InspectionResultsView.this),true);
      }
    }
  }
);
  myTree.addKeyListener(new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      if (e.getKeyCode() == KeyEvent.VK_ENTER) {
        OpenSourceUtil.openSourcesFrom(DataManager.getInstance().getDataContext(InspectionResultsView.this),false);
      }
    }
  }
);
  myTree.addMouseListener(new PopupHandler(){
    public void invokePopup(    Component comp,    int x,    int y){
      popupInvoked(comp,x,y);
    }
  }
);
  SmartExpander.installOn(myTree);
  myBrowser.addClickListener(new Browser.ClickListener(){
    public void referenceClicked(    final Browser.ClickEvent e){
      if (e.getEventType() == Browser.ClickEvent.REF_ELEMENT) {
        showSource(e.getClickedElement());
      }
 else       if (e.getEventType() == Browser.ClickEvent.FILE_OFFSET) {
        final VirtualFile file=e.getFile();
        OpenFileDescriptor descriptor=new OpenFileDescriptor(project,file,e.getStartOffset());
        Editor editor=FileEditorManager.getInstance(project).openTextEditor(descriptor,true);
        TextAttributes selectionAttributes=EditorColorsManager.getInstance().getGlobalScheme().getAttributes(EditorColors.SEARCH_RESULT_ATTRIBUTES);
        HighlightManager.getInstance(project).addRangeHighlight(editor,e.getStartOffset(),e.getEndOffset(),selectionAttributes,true,null);
      }
    }
  }
);
  final CommonActionsManager actionsManager=CommonActionsManager.getInstance();
  add(mySplitter,BorderLayout.CENTER);
  DefaultActionGroup group=new DefaultActionGroup();
  group.add(new RerunAction(this));
  group.add(new CloseAction());
  final TreeExpander treeExpander=new TreeExpander(){
    public void expandAll(){
      TreeUtil.expandAll(myTree);
    }
    public boolean canExpand(){
      return true;
    }
    public void collapseAll(){
      TreeUtil.collapseAll(myTree,0);
    }
    public boolean canCollapse(){
      return true;
    }
  }
;
  group.add(actionsManager.createExpandAllAction(treeExpander,myTree));
  group.add(actionsManager.createCollapseAllAction(treeExpander,myTree));
  group.add(actionsManager.createPrevOccurenceAction(getOccurenceNavigator()));
  group.add(actionsManager.createNextOccurenceAction(getOccurenceNavigator()));
  group.add(myGlobalInspectionContext.createToggleAutoscrollAction());
  group.add(new ExportHTMLAction(this));
  group.add(new HelpAction());
  JPanel westPanel=new JPanel(new BorderLayout());
  westPanel.add(ActionManager.getInstance().createActionToolbar(ActionPlaces.CODE_INSPECTION,group,false).getComponent(),BorderLayout.WEST);
  DefaultActionGroup specialGroup=new DefaultActionGroup();
  specialGroup.add(myGlobalInspectionContext.getUIOptions().createGroupBySeverityAction(this));
  specialGroup.add(myGlobalInspectionContext.getUIOptions().createFilterResolvedItemsAction(this));
  specialGroup.add(myGlobalInspectionContext.getUIOptions().createShowOutdatedProblemsAction(this));
  specialGroup.add(myGlobalInspectionContext.getUIOptions().createShowDiffOnlyAction(this));
  specialGroup.add(new EditSettingsAction());
  specialGroup.add(new DisableInspectionAction());
  final InvokeQuickFixAction invokeQuickFixAction=new InvokeQuickFixAction(this);
  specialGroup.add(invokeQuickFixAction);
  specialGroup.add(new SuppressInspectionToolbarAction(this));
  final JComponent toolbarComponent=ActionManager.getInstance().createActionToolbar(ActionPlaces.CODE_INSPECTION,specialGroup,false).getComponent();
  westPanel.add(toolbarComponent,BorderLayout.EAST);
  add(westPanel,BorderLayout.WEST);
  final Component actionButton=toolbarComponent.getComponent(ArrayUtil.find(specialGroup.getChildren(null),invokeQuickFixAction));
  invokeQuickFixAction.setupPopupCoordinates(new RelativePoint(actionButton,new Point(0,actionButton.getHeight())));
}
