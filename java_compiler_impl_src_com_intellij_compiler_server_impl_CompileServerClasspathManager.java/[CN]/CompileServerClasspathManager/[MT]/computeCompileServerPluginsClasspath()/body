{
  final List<File> classpath=new ArrayList<File>();
  for (  CompileServerPlugin serverPlugin : CompileServerPlugin.EP_NAME.getExtensions()) {
    final PluginId pluginId=serverPlugin.getPluginDescriptor().getPluginId();
    final IdeaPluginDescriptor plugin=PluginManager.getPlugin(pluginId);
    LOG.assertTrue(plugin != null,pluginId);
    final File baseFile=plugin.getPath();
    if (baseFile.isFile()) {
      classpath.add(baseFile);
    }
 else     if (baseFile.isDirectory()) {
      for (      String relativePath : StringUtil.split(serverPlugin.getClasspath(),";")) {
        final File jarFile=new File(new File(baseFile,"lib"),relativePath);
        if (jarFile.exists()) {
          classpath.add(jarFile);
        }
 else {
          final String moduleName=FileUtil.getNameWithoutExtension(PathUtil.getFileName(relativePath));
          final File dir=new File(baseFile.getParentFile(),moduleName);
          if (dir.exists()) {
            classpath.add(dir);
          }
 else {
            File pluginDir=getPluginDir(plugin);
            if (pluginDir != null) {
              File libraryFile=new File(pluginDir,"lib" + File.separator + PathUtil.getFileName(relativePath));
              if (libraryFile.exists()) {
                classpath.add(libraryFile);
              }
 else {
                LOG.error("Cannot add plugin '" + plugin.getName() + "' to external compiler classpath: library "+ libraryFile.getAbsolutePath()+ " not found");
              }
            }
 else {
              LOG.error("Cannot add plugin '" + plugin.getName() + "' to external compiler classpath: home directory of plugin not found");
            }
          }
        }
      }
    }
  }
  return classpath;
}
