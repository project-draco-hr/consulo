{
  super(project,true);
  myCommitContext=new CommitContext();
  myProject=project;
  myVcsConfiguration=ObjectUtils.assertNotNull(VcsConfiguration.getInstance(myProject));
  myExecutors=executors;
  myShowVcsCommit=showVcsCommit;
  myVcs=singleVcs;
  myResultHandler=customResultHandler;
  myListComments=new HashMap<>();
  myAdditionalData=new PseudoMap<>();
  myDiffDetails=new MyChangeProcessor(myProject);
  if (!myShowVcsCommit && ContainerUtil.isEmpty(myExecutors)) {
    throw new IllegalArgumentException("nothing found to execute commit with");
  }
  myAllOfDefaultChangeListChangesIncluded=ContainerUtil.newHashSet(changes).containsAll(ContainerUtil.newHashSet(defaultChangeList.getChanges()));
  myIsAlien=isAlien;
  if (isAlien) {
    myBrowser=new AlienChangeListBrowser(project,changeLists,changes,initialSelection,true,true,singleVcs);
  }
 else {
    boolean unversionedFilesEnabled=myShowVcsCommit && Registry.is("vcs.unversioned.files.in.commit");
    MultipleChangeListBrowser browser=new MultipleChangeListBrowser(project,changeLists,(List)changes,initialSelection,true,true,new Runnable(){
      @Override public void run(){
        updateWarning();
      }
    }
,new Runnable(){
      @Override public void run(){
        for (        CheckinHandler handler : myHandlers) {
          handler.includedChangesChanged();
        }
      }
    }
,unversionedFilesEnabled){
      @Override protected void afterDiffRefresh(){
        myBrowser.rebuildList();
        myBrowser.setDataIsDirty(false);
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          @Override public void run(){
            IdeFocusManager.findInstance().requestFocus(myBrowser.getViewer().getPreferredFocusedComponent(),true);
          }
        }
);
      }
    }
;
    browser.addSelectedListChangeListener(new SelectedListChangeListener(){
      @Override public void selectedListChanged(){
        updateOnListSelection();
      }
    }
);
    myBrowser=browser;
    myBrowser.setAlwayExpandList(false);
  }
  myBrowser.getViewer().addSelectionListener(new Runnable(){
    @Override public void run(){
      SwingUtilities.invokeLater(new Runnable(){
        @Override public void run(){
          changeDetails();
        }
      }
);
    }
  }
);
  myCommitMessageArea=new CommitMessage(project);
  if (!myVcsConfiguration.CLEAR_INITIAL_COMMIT_MESSAGE) {
    setComment(initialSelection,comment);
  }
  myBrowser.setDiffBottomComponent(new DiffCommitMessageEditor(this));
  myActionName=VcsBundle.message("commit.dialog.title");
  Box optionsBox=Box.createVerticalBox();
  boolean hasVcsOptions=false;
  Box vcsCommitOptions=Box.createVerticalBox();
  final List<AbstractVcs> vcses=ContainerUtil.sorted(getAffectedVcses(),new Comparator<AbstractVcs>(){
    @Override public int compare(    @NotNull AbstractVcs o1,    @NotNull AbstractVcs o2){
      return o1.getKeyInstanceMethod().getName().compareToIgnoreCase(o2.getKeyInstanceMethod().getName());
    }
  }
);
  myCheckinChangeListSpecificComponents=ContainerUtil.newHashMap();
  for (  AbstractVcs vcs : vcses) {
    final CheckinEnvironment checkinEnvironment=vcs.getCheckinEnvironment();
    if (checkinEnvironment != null) {
      final RefreshableOnComponent options=checkinEnvironment.createAdditionalOptionsPanel(this,myAdditionalData);
      if (options != null) {
        JPanel vcsOptions=new JPanel(new BorderLayout());
        vcsOptions.add(options.getComponent(),BorderLayout.CENTER);
        vcsOptions.setBorder(IdeBorderFactory.createTitledBorder(vcs.getDisplayName(),true));
        vcsCommitOptions.add(vcsOptions);
        myPerVcsOptionsPanels.put(vcs,vcsOptions);
        myAdditionalComponents.add(options);
        if (options instanceof CheckinChangeListSpecificComponent) {
          myCheckinChangeListSpecificComponents.put(vcs.getName(),(CheckinChangeListSpecificComponent)options);
        }
        hasVcsOptions=true;
      }
    }
  }
  if (hasVcsOptions) {
    vcsCommitOptions.add(Box.createVerticalGlue());
    optionsBox.add(vcsCommitOptions);
  }
  boolean beforeVisible=false;
  boolean afterVisible=false;
  Box beforeBox=Box.createVerticalBox();
  Box afterBox=Box.createVerticalBox();
  for (  BaseCheckinHandlerFactory factory : getCheckInFactories(project)) {
    final CheckinHandler handler=factory.createHandler(this,myCommitContext);
    if (CheckinHandler.DUMMY.equals(handler))     continue;
    myHandlers.add(handler);
    final RefreshableOnComponent beforePanel=handler.getBeforeCheckinConfigurationPanel();
    if (beforePanel != null) {
      beforeBox.add(beforePanel.getComponent());
      beforeVisible=true;
      myAdditionalComponents.add(beforePanel);
    }
    final RefreshableOnComponent afterPanel=handler.getAfterCheckinConfigurationPanel(getDisposable());
    if (afterPanel != null) {
      afterBox.add(afterPanel.getComponent());
      afterVisible=true;
      myAdditionalComponents.add(afterPanel);
    }
  }
  final String actionName=getCommitActionName();
  final String borderTitleName=actionName.replace("_","").replace("&","");
  if (beforeVisible) {
    beforeBox.add(Box.createVerticalGlue());
    JPanel beforePanel=new JPanel(new BorderLayout());
    beforePanel.add(beforeBox);
    beforePanel.setBorder(IdeBorderFactory.createTitledBorder(VcsBundle.message("border.standard.checkin.options.group",borderTitleName),true));
    optionsBox.add(beforePanel);
  }
  if (afterVisible) {
    afterBox.add(Box.createVerticalGlue());
    JPanel afterPanel=new JPanel(new BorderLayout());
    afterPanel.add(afterBox);
    afterPanel.setBorder(IdeBorderFactory.createTitledBorder(VcsBundle.message("border.standard.after.checkin.options.group",borderTitleName),true));
    optionsBox.add(afterPanel);
  }
  if (hasVcsOptions || beforeVisible || afterVisible) {
    optionsBox.add(Box.createVerticalGlue());
    myAdditionalOptionsPanel=new JPanel(new BorderLayout());
    myAdditionalOptionsPanel.add(optionsBox,BorderLayout.NORTH);
  }
 else {
    myAdditionalOptionsPanel=null;
  }
  myOkActionText=actionName;
  if (myShowVcsCommit) {
    setTitle(myActionName);
  }
 else {
    setTitle(trimEllipsis(myExecutors.get(0).getActionText()));
  }
  restoreState();
  if (myExecutors != null) {
    myExecutorActions=new CommitExecutorAction[myExecutors.size()];
    for (int i=0; i < myExecutors.size(); i++) {
      final CommitExecutor commitExecutor=myExecutors.get(i);
      myExecutorActions[i]=new CommitExecutorAction(commitExecutor,i == 0 && !myShowVcsCommit);
    }
  }
 else {
    myExecutorActions=null;
  }
  myWarningLabel=new JLabel();
  myWarningLabel.setUI(new MultiLineLabelUI());
  myWarningLabel.setForeground(JBColor.RED);
  updateWarning();
  init();
  updateButtons();
  updateVcsOptionsVisibility();
  updateOnListSelection();
  myCommitMessageArea.requestFocusInMessage();
  for (  EditChangelistSupport support : Extensions.getExtensions(EditChangelistSupport.EP_NAME,project)) {
    support.installSearch(myCommitMessageArea.getEditorField(),myCommitMessageArea.getEditorField());
  }
  showDetailsIfSaved();
}
