{
  final IndexState originalState=myState;
  IndexState state=originalState;
  int parentId=getId(parent);
  DirectoryInfo parentInfo=originalState.myDirToInfoMap.get(parentId);
  for (  Module eachModule : ModuleManager.getInstance(myProject).getModules()) {
    for (    ContentEntry eachRoot : getContentEntries(eachModule)) {
      if (parentInfo != null) {
        VirtualFile contFile=eachRoot.getFile();
        if (contFile != null && contFile.equals(parentInfo.getContentRoot()))         continue;
      }
      String url=eachRoot.getUrl();
      if (FileUtil.startsWith(url,file.getUrl())) {
        String rel=FileUtil.getRelativePath(file.getUrl(),url,'/');
        if (rel != null) {
          VirtualFile f=file.findFileByRelativePath(rel);
          if (f != null) {
            if (state == originalState)             state=state.copy();
            state.fillMapWithModuleContent(f,eachModule,f,null);
          }
        }
      }
    }
  }
  if (parentInfo == null)   return state;
  Module module=parentInfo.getModule();
  for (  DirectoryIndexExcludePolicy policy : myExcludePolicies) {
    if (policy.isExcludeRoot(file))     return state;
  }
  if (state == originalState)   state=state.copy();
  state.fillMapWithModuleContent(file,module,parentInfo.getContentRoot(),null);
  String parentPackage=state.myDirToPackageName.get(parentId);
  if (module != null) {
    if (parentInfo.isInModuleSource()) {
      String newDirPackageName=getPackageNameForSubdir(parentPackage,file.getName());
      state.fillMapWithModuleSource(file,module,newDirPackageName,parentInfo.getSourceRoot(),parentInfo.isTestSource(),null);
    }
  }
  if (parentInfo.hasLibraryClassRoot()) {
    String newDirPackageName=getPackageNameForSubdir(parentPackage,file.getName());
    state.fillMapWithLibraryClasses(file,newDirPackageName,parentInfo.getLibraryClassRoot(),null);
  }
  if (parentInfo.isInLibrarySource()) {
    String newDirPackageName=getPackageNameForSubdir(parentPackage,file.getName());
    state.fillMapWithLibrarySources(file,newDirPackageName,parentInfo.getSourceRoot(),null);
  }
  OrderEntry[] entries=parentInfo.getOrderEntries();
  if (entries.length != 0) {
    state.fillMapWithOrderEntries(file,entries,null,null,null,parentInfo,null);
  }
  return state;
}
