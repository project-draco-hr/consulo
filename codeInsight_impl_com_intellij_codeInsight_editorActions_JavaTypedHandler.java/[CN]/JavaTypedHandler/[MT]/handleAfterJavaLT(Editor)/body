{
  if (!CodeInsightSettings.getInstance().AUTOINSERT_PAIR_BRACKET)   return;
  int offset=editor.getCaretModel().getOffset();
  HighlighterIterator iterator=((EditorEx)editor).getHighlighter().createIterator(offset);
  while (iterator.getStart() > 0 && !JavaTypedHandlerUtil.isTokenInvalidInsideReference(iterator.getTokenType())) {
    iterator.retreat();
  }
  if (JavaTypedHandlerUtil.isTokenInvalidInsideReference(iterator.getTokenType()))   iterator.advance();
  int balance=0;
  while (!iterator.atEnd() && balance >= 0) {
    final IElementType tokenType=iterator.getTokenType();
    if (tokenType == JavaTokenType.LT) {
      balance++;
    }
 else     if (tokenType == JavaTokenType.GT) {
      balance--;
    }
 else     if (JavaTypedHandlerUtil.isTokenInvalidInsideReference(tokenType)) {
      break;
    }
    iterator.advance();
  }
  if (balance == 1) {
    editor.getDocument().insertString(offset,">");
  }
}
