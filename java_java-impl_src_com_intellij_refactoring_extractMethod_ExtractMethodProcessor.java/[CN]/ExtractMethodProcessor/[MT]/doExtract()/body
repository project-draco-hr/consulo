{
  PsiMethod newMethod=generateEmptyMethod(myThrownExceptions,myStatic);
  myExpression=myInputVariables.replaceWrappedReferences(myElements,myExpression);
  renameInputVariables();
  LOG.assertTrue(myElements[0].isValid());
  PsiCodeBlock body=newMethod.getBody();
  myMethodCall=generateMethodCall(null,true);
  LOG.assertTrue(myElements[0].isValid());
  if (myExpression == null) {
    String outVariableName=myOutputVariable != null ? getNewVariableName(myOutputVariable) : null;
    PsiReturnStatement returnStatement;
    if (myNullConditionalCheck) {
      returnStatement=(PsiReturnStatement)myElementFactory.createStatementFromText("return null;",null);
    }
 else     if (myOutputVariable != null) {
      returnStatement=(PsiReturnStatement)myElementFactory.createStatementFromText("return " + outVariableName + ";",null);
    }
 else     if (myGenerateConditionalExit) {
      returnStatement=(PsiReturnStatement)myElementFactory.createStatementFromText("return true;",null);
    }
 else {
      returnStatement=(PsiReturnStatement)myElementFactory.createStatementFromText("return;",null);
    }
    boolean hasNormalExit=false;
    PsiElement lastElement=myElements[myElements.length - 1];
    if (!(lastElement instanceof PsiReturnStatement || lastElement instanceof PsiBreakStatement || lastElement instanceof PsiContinueStatement)) {
      hasNormalExit=true;
    }
    PsiStatement exitStatementCopy=myControlFlowWrapper.getExitStatementCopy(returnStatement,myElements);
    declareNecessaryVariablesInsideBody(body);
    if (myNeedChangeContext) {
      for (      PsiElement element : myElements) {
        ChangeContextUtil.encodeContextInfo(element,false);
      }
    }
    body.addRange(myElements[0],myElements[myElements.length - 1]);
    if (myNullConditionalCheck) {
      body.add(myElementFactory.createStatementFromText("return " + myOutputVariable.getName() + ";",null));
    }
 else     if (myGenerateConditionalExit) {
      body.add(myElementFactory.createStatementFromText("return false;",null));
    }
 else     if (!myHasReturnStatement && hasNormalExit && myOutputVariable != null) {
      final PsiReturnStatement insertedReturnStatement=(PsiReturnStatement)body.add(returnStatement);
      if (myOutputVariables.length == 1) {
        final PsiExpression returnValue=insertedReturnStatement.getReturnValue();
        if (returnValue instanceof PsiReferenceExpression) {
          final PsiElement resolved=((PsiReferenceExpression)returnValue).resolve();
          if (resolved instanceof PsiLocalVariable && Comparing.strEqual(((PsiVariable)resolved).getName(),outVariableName)) {
            final PsiStatement statement=PsiTreeUtil.getPrevSiblingOfType(insertedReturnStatement,PsiStatement.class);
            if (statement instanceof PsiDeclarationStatement) {
              final PsiElement[] declaredElements=((PsiDeclarationStatement)statement).getDeclaredElements();
              if (ArrayUtil.find(declaredElements,resolved) != -1) {
                InlineUtil.inlineVariable((PsiVariable)resolved,((PsiVariable)resolved).getInitializer(),(PsiReferenceExpression)returnValue);
                resolved.delete();
              }
            }
          }
        }
      }
    }
    if (myNullConditionalCheck) {
      final String varName=myOutputVariable.getName();
      if (isDeclaredInside(myOutputVariable)) {
        declareVariableAtMethodCallLocation(varName);
      }
 else {
        PsiExpressionStatement assignmentExpression=(PsiExpressionStatement)myElementFactory.createStatementFromText(varName + "=x;",null);
        assignmentExpression=(PsiExpressionStatement)addToMethodCallLocation(assignmentExpression);
        myMethodCall=(PsiMethodCallExpression)((PsiAssignmentExpression)assignmentExpression.getExpression()).getRExpression().replace(myMethodCall);
      }
      declareNecessaryVariablesAfterCall(myOutputVariable);
      PsiIfStatement ifStatement=(PsiIfStatement)myElementFactory.createStatementFromText(myHasReturnStatementOutput || (myGenerateConditionalExit && myFirstExitStatementCopy instanceof PsiReturnStatement && ((PsiReturnStatement)myFirstExitStatementCopy).getReturnValue() != null) ? "if (" + varName + "==null) return null;" : "if (" + varName + "==null) return;",null);
      ifStatement=(PsiIfStatement)addToMethodCallLocation(ifStatement);
      CodeStyleManager.getInstance(myProject).reformat(ifStatement);
    }
 else     if (myGenerateConditionalExit) {
      PsiIfStatement ifStatement=(PsiIfStatement)myElementFactory.createStatementFromText("if (a) b;",null);
      ifStatement=(PsiIfStatement)addToMethodCallLocation(ifStatement);
      myMethodCall=(PsiMethodCallExpression)ifStatement.getCondition().replace(myMethodCall);
      ifStatement.getThenBranch().replace(myFirstExitStatementCopy);
      CodeStyleManager.getInstance(myProject).reformat(ifStatement);
    }
 else     if (myOutputVariable != null) {
      String name=myOutputVariable.getName();
      boolean toDeclare=isDeclaredInside(myOutputVariable);
      if (!toDeclare) {
        PsiExpressionStatement statement=(PsiExpressionStatement)myElementFactory.createStatementFromText(name + "=x;",null);
        statement=(PsiExpressionStatement)myStyleManager.reformat(statement);
        statement=(PsiExpressionStatement)addToMethodCallLocation(statement);
        PsiAssignmentExpression assignment=(PsiAssignmentExpression)statement.getExpression();
        myMethodCall=(PsiMethodCallExpression)assignment.getRExpression().replace(myMethodCall);
      }
 else {
        declareVariableAtMethodCallLocation(name);
      }
    }
 else     if (myHasReturnStatementOutput) {
      PsiStatement statement=myElementFactory.createStatementFromText("return x;",null);
      statement=(PsiStatement)addToMethodCallLocation(statement);
      myMethodCall=(PsiMethodCallExpression)((PsiReturnStatement)statement).getReturnValue().replace(myMethodCall);
    }
 else {
      PsiStatement statement=myElementFactory.createStatementFromText("x();",null);
      statement=(PsiStatement)addToMethodCallLocation(statement);
      myMethodCall=(PsiMethodCallExpression)((PsiExpressionStatement)statement).getExpression().replace(myMethodCall);
    }
    if (myHasReturnStatement && !myHasReturnStatementOutput && !hasNormalExit) {
      PsiStatement statement=myElementFactory.createStatementFromText("return;",null);
      addToMethodCallLocation(statement);
    }
 else     if (!myGenerateConditionalExit && exitStatementCopy != null) {
      addToMethodCallLocation(exitStatementCopy);
    }
    if (!myNullConditionalCheck) {
      declareNecessaryVariablesAfterCall(myOutputVariable);
    }
    deleteExtracted();
  }
 else {
    declareNecessaryVariablesInsideBody(body);
    if (myHasExpressionOutput) {
      PsiReturnStatement returnStatement=(PsiReturnStatement)myElementFactory.createStatementFromText("return x;",null);
      final PsiExpression returnValue=RefactoringUtil.convertInitializerToNormalExpression(myExpression,myForcedReturnType);
      returnStatement.getReturnValue().replace(returnValue);
      body.add(returnStatement);
    }
 else {
      PsiExpressionStatement statement=(PsiExpressionStatement)myElementFactory.createStatementFromText("x;",null);
      statement.getExpression().replace(myExpression);
      body.add(statement);
    }
    PsiExpression expression2Replace=myExpression;
    if (myExpression instanceof PsiAssignmentExpression) {
      expression2Replace=((PsiAssignmentExpression)myExpression).getRExpression();
    }
 else     if (myExpression instanceof PsiPostfixExpression || myExpression instanceof PsiPrefixExpression) {
      final IElementType elementType=myExpression instanceof PsiPostfixExpression ? ((PsiPostfixExpression)myExpression).getOperationTokenType() : ((PsiPrefixExpression)myExpression).getOperationTokenType();
      if (elementType == JavaTokenType.PLUSPLUS || elementType == JavaTokenType.MINUSMINUS) {
        PsiExpression operand=myExpression instanceof PsiPostfixExpression ? ((PsiPostfixExpression)myExpression).getOperand() : ((PsiPrefixExpression)myExpression).getOperand();
        expression2Replace=((PsiBinaryExpression)myExpression.replace(myElementFactory.createExpressionFromText(operand.getText() + " + x",operand))).getROperand();
      }
    }
    myExpression=(PsiExpression)IntroduceVariableBase.replace(expression2Replace,myMethodCall,myProject);
    myMethodCall=PsiTreeUtil.getParentOfType(myExpression.findElementAt(myExpression.getText().indexOf(myMethodCall.getText())),PsiMethodCallExpression.class);
    declareNecessaryVariablesAfterCall(myOutputVariable);
  }
  if (myAnchor instanceof PsiField) {
    ((PsiField)myAnchor).normalizeDeclaration();
  }
  adjustFinalParameters(newMethod);
  int i=0;
  for (  ParameterTablePanel.VariableData data : myVariableDatum) {
    if (!data.passAsParameter)     continue;
    final PsiVariable variable=data.variable;
    final PsiParameter psiParameter=newMethod.getParameterList().getParameters()[i++];
    if (!TypeConversionUtil.isAssignable(variable.getType(),psiParameter.getType())) {
      for (      PsiReference reference : ReferencesSearch.search(psiParameter,new LocalSearchScope(body))) {
        final PsiElement element=reference.getElement();
        if (element != null) {
          final PsiElement parent=element.getParent();
          if (parent instanceof PsiTypeCastExpression) {
            RedundantCastUtil.removeCast((PsiTypeCastExpression)parent);
          }
        }
      }
    }
  }
  myExtractedMethod=(PsiMethod)myTargetClass.addAfter(newMethod,myAnchor);
  if (isNeedToChangeCallContext() && myNeedChangeContext) {
    ChangeContextUtil.decodeContextInfo(myExtractedMethod,myTargetClass,RefactoringUtil.createThisExpression(myManager,null));
    if (myMethodCall.resolveMethod() != myExtractedMethod) {
      final PsiReferenceExpression methodExpression=myMethodCall.getMethodExpression();
      methodExpression.setQualifierExpression(RefactoringUtil.createThisExpression(myManager,myTargetClass));
    }
  }
}
