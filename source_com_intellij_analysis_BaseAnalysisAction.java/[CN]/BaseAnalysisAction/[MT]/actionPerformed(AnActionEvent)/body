{
  DataContext dataContext=e.getDataContext();
  final Project project=(Project)dataContext.getData(DataConstants.PROJECT);
  final Module module=(Module)dataContext.getData(DataConstants.MODULE);
  if (project != null) {
    AnalysisScope scope;
    boolean calledFromNonJavaFile=false;
    PsiFile psiFile=(PsiFile)dataContext.getData(DataConstants.PSI_FILE);
    if (psiFile != null && !(psiFile instanceof PsiJavaFile)) {
      scope=new AnalysisScope(psiFile,myFileFilter);
      calledFromNonJavaFile=true;
    }
 else {
      scope=getInspectionScope(dataContext);
    }
    if (calledFromNonJavaFile || scope.getScopeType() == AnalysisScope.FILE && (ActionPlaces.MAIN_MENU.equals(e.getPlace()) || ActionPlaces.EDITOR_POPUP.equals(e.getPlace()))) {
      FileProjectOrModuleDialog dlg=new FileProjectOrModuleDialog(scope.getDisplayName(),module != null ? ModuleUtil.getModuleNameInReadAction(module) : null,calledFromNonJavaFile);
      dlg.show();
      if (!dlg.isOK())       return;
      if (dlg.isProjectScopeSelected()) {
        scope=getProjectScope(dataContext);
      }
 else {
        if (dlg.isModuleScopeSelected()) {
          scope=getModuleScope(dataContext);
        }
      }
    }
    FileDocumentManager.getInstance().saveAllDocuments();
    analyze(project,scope);
  }
}
