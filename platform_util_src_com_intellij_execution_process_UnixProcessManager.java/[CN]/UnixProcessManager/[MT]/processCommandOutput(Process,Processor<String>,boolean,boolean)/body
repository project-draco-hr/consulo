{
  BufferedReader stdOutput=new BufferedReader(new InputStreamReader(process.getInputStream()));
  try {
    BufferedReader stdError=new BufferedReader(new InputStreamReader(process.getErrorStream()));
    try {
      if (skipFirstLine) {
        stdOutput.readLine();
      }
      String s;
      while ((s=stdOutput.readLine()) != null) {
        processor.process(s);
      }
      StringBuilder errorStr=new StringBuilder();
      while ((s=stdError.readLine()) != null) {
        if (s.contains("environment variables being ignored")) {
          continue;
        }
        errorStr.append(s).append("\n");
      }
      if (throwOnError && errorStr.length() > 0) {
        throw new IOException("Error reading ps output:" + errorStr.toString());
      }
    }
  finally {
      stdError.close();
    }
  }
  finally {
    stdOutput.close();
  }
}
