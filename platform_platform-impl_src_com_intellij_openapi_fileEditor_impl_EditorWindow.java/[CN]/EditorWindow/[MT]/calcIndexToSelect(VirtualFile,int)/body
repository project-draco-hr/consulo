{
  final int currentlySelectedIndex=myTabbedPane.getSelectedIndex();
  if (currentlySelectedIndex != fileIndex) {
    return currentlySelectedIndex;
  }
  UISettings uiSettings=UISettings.getInstance();
  if (uiSettings.ACTIVATE_MRU_EDITOR_ON_CLOSE) {
    final VirtualFile[] histFiles=EditorHistoryManager.getInstance(getManager().getProject()).getFiles();
    for (int idx=histFiles.length - 1; idx >= 0; idx--) {
      final VirtualFile histFile=histFiles[idx];
      if (histFile.equals(fileBeingClosed)) {
        continue;
      }
      final EditorWithProviderComposite editor=findFileComposite(histFile);
      if (editor == null) {
        continue;
      }
      final int histFileIndex=findComponentIndex(editor.getComponent());
      if (histFileIndex >= 0) {
        return histFileIndex;
      }
    }
  }
 else   if (uiSettings.ACTIVATE_RIGHT_EDITOR_ON_CLOSE && (fileIndex + 1 < myTabbedPane.getTabCount())) {
    return fileIndex + 1;
  }
  if (fileIndex > 0) {
    return fileIndex - 1;
  }
  return -1;
}
