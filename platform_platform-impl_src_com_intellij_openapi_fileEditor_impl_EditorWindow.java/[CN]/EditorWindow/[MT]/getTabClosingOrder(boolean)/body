{
  final VirtualFile[] allFiles=getFiles();
  final Set<VirtualFile> histFiles=EditorHistoryManager.getInstance(getManager().getProject()).getFileSet();
  LinkedHashSet<VirtualFile> closingOrder=ContainerUtil.newLinkedHashSet();
  for (  final VirtualFile file : allFiles) {
    if (!histFiles.contains(file)) {
      closingOrder.add(file);
    }
  }
  if (closeNonModifiedFilesFirst) {
    for (    final VirtualFile file : histFiles) {
      EditorWithProviderComposite composite=findFileComposite(file);
      if (composite != null && !myOwner.getManager().isChanged(composite)) {
        closingOrder.add(file);
      }
    }
    for (int i=0; i < myTabbedPane.getTabCount(); i++) {
      final VirtualFile file=getFileAt(i);
      if (!myOwner.getManager().isChanged(getEditorAt(i))) {
        closingOrder.add(file);
      }
    }
  }
  closingOrder.addAll(histFiles);
  for (int i=0; i < myTabbedPane.getTabCount(); i++) {
    closingOrder.add(getFileAt(i));
  }
  final VirtualFile selectedFile=getSelectedFile();
  closingOrder.remove(selectedFile);
  closingOrder.add(selectedFile);
  return closingOrder;
}
