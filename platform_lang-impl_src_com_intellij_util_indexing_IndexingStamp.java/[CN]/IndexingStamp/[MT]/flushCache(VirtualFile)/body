{
  while (finishedFile == null || !ourFinishedFiles.offer(finishedFile)) {
    List<VirtualFile> files=new ArrayList<VirtualFile>(ourFinishedFiles.size());
    ourFinishedFiles.drainTo(files);
    if (!files.isEmpty()) {
      for (      VirtualFile file : files) {
synchronized (getStripedLock(file)) {
          Timestamps timestamp=myTimestampsCache.remove(file);
          if (timestamp == null)           continue;
          try {
            if (timestamp.isDirty() && file.isValid()) {
              final DataOutputStream sink=Timestamps.PERSISTENCE.writeAttribute(file);
              timestamp.writeToStream(sink);
              sink.close();
            }
          }
 catch (          IOException e) {
            throw new RuntimeException(e);
          }
        }
      }
    }
    if (finishedFile == null)     break;
  }
}
