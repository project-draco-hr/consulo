{
  if (finishedFile != null && finishedFile == INVALID_FILE_ID)   finishedFile=0;
  while (finishedFile == null || !ourFinishedFiles.offer(finishedFile)) {
    List<Integer> files=new ArrayList<Integer>(ourFinishedFiles.size());
    ourFinishedFiles.drainTo(files);
    if (!files.isEmpty()) {
      for (      Integer file : files) {
synchronized (getStripedLock(file)) {
          Timestamps timestamp=myTimestampsCache.remove(file);
          if (timestamp == null)           continue;
          try {
            if (timestamp.isDirty()) {
              final DataOutputStream sink=FSRecords.writeAttribute(file,Timestamps.PERSISTENCE);
              timestamp.writeToStream(sink);
              sink.close();
            }
          }
 catch (          IOException e) {
            throw new RuntimeException(e);
          }
        }
      }
    }
    if (finishedFile == null)     break;
  }
}
