{
  if (thisElement == null)   return null;
  PsiElement element=lang != null ? thisElement.getContainingFile().getViewProvider().findElementAt(offset,lang) : thisElement.findElementAt(offset);
  if (element == null || element instanceof OuterLanguageElement)   return null;
  offset=thisElement.getTextRange().getStartOffset() + offset - element.getTextRange().getStartOffset();
  List<PsiReference> referencesList=new ArrayList<PsiReference>();
  while (element != null) {
    addReferences(offset,element,referencesList);
    if (element instanceof PsiFile)     break;
    if (element instanceof HintedReferenceHost && !((HintedReferenceHost)element).shouldAskParentForReferences(new PsiReferenceService.Hints(null,offset))) {
      break;
    }
    offset=element.getStartOffsetInParent() + offset;
    element=element.getParent();
  }
  if (referencesList.isEmpty())   return null;
  if (referencesList.size() == 1)   return referencesList.get(0);
  return new PsiMultiReference(referencesList.toArray(new PsiReference[referencesList.size()]),referencesList.get(referencesList.size() - 1).getElement());
}
