{
  Dimension dim=myLookup.getComponent().getPreferredSize();
  int lookupStart=myLookup.getLookupStart();
  Editor editor=myLookup.getEditor();
  if (lookupStart < 0 || lookupStart > editor.getDocument().getTextLength()) {
    LOG.error(lookupStart + "; offset=" + editor.getCaretModel().getOffset()+ "; element="+ myLookup.getPsiElement());
  }
  LogicalPosition pos=editor.offsetToLogicalPosition(lookupStart);
  Point location=editor.logicalPositionToXY(pos);
  location.y+=editor.getLineHeight();
  location.x-=myLookup.myCellRenderer.getIconIndent() + myLookup.getComponent().getInsets().left;
  SwingUtilities.convertPointToScreen(location,editor.getContentComponent());
  final Rectangle screenRectangle=ScreenUtil.getScreenRectangle(location);
  if (!isPositionedAboveCaret()) {
    int shiftLow=screenRectangle.height - (location.y + dim.height);
    myPositionedAbove=shiftLow < 0 && shiftLow < location.y - dim.height && location.y >= dim.height;
  }
  if (isPositionedAboveCaret()) {
    location.y-=dim.height + editor.getLineHeight();
    if (pos.line == 0) {
      location.y+=1;
    }
  }
  if (!screenRectangle.contains(location)) {
    location=ScreenUtil.findNearestPointOnBorder(screenRectangle,location);
  }
  final JRootPane rootPane=editor.getComponent().getRootPane();
  if (rootPane == null) {
    LOG.error("editor.disposed=" + editor.isDisposed() + "; lookup.disposed="+ myLookup.isLookupDisposed()+ "; editorShowing="+ editor.getContentComponent().isShowing());
  }
  Rectangle candidate=new Rectangle(location,dim);
  ScreenUtil.cropRectangleToFitTheScreen(candidate);
  SwingUtilities.convertPointFromScreen(location,rootPane.getLayeredPane());
  myMaximumHeight=candidate.height;
  return new Rectangle(location.x,location.y,dim.width,candidate.height);
}
