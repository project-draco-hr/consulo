{
  int offsetInLeftFragment=injectedToHost(offset,true);
  int offsetInRightFragment=injectedToHost(offset,false);
  if (offsetInLeftFragment == offsetInRightFragment)   return offsetInLeftFragment;
  Editor editor=PlatformDataKeys.EDITOR.getData(DataManager.getInstance().getDataContext());
  if (editor instanceof EditorWindow)   editor=((EditorWindow)editor).getDelegate();
  if (editor != null) {
    int caret=editor.getCaretModel().getOffset();
    return Math.abs(caret - offsetInLeftFragment) < Math.abs(caret - offsetInRightFragment) ? offsetInLeftFragment : offsetInRightFragment;
  }
  return offsetInLeftFragment;
}
