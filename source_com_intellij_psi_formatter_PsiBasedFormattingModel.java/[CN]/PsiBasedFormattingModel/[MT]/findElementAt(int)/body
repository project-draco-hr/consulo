{
  final PsiElement[] psiRoots=myASTNode.getPsi().getContainingFile().getPsiRoots();
  for (int i=psiRoots.length - 1; i >= 0; i--) {
    PsiElement psiRoot=psiRoots[i];
    final ASTNode found=psiRoot.getNode().findLeafElementAt(offset);
    if (found != null) {
      if (!myCanModifyAllWhiteSpaces && found.getElementType() == ElementType.WHITE_SPACE)       return found;
      if (!(found.getPsi() instanceof JspText) && found.getTextRange().getStartOffset() == offset) {
        if (found.getElementType() == ElementType.XML_COMMENT_START) {
          return found.getTreeParent();
        }
 else {
          return found;
        }
      }
    }
  }
  final ASTNode found=myASTNode.findLeafElementAt(offset);
  if (found != null && found.getElementType() == ElementType.XML_COMMENT_START) {
    return found.getTreeParent();
  }
 else {
    return found;
  }
}
