{
  myDocument.replaceString(textRange.getStartOffset(),textRange.getEndOffset(),whiteSpace);
  int shift=whiteSpace.length() - textRange.getLength();
  TextRange newBlockRange=new TextRange(oldBlockTextRange.getStartOffset() + shift,oldBlockTextRange.getEndOffset() + shift);
  int delta=0;
  final String elementText=myDocument.getCharsSequence().subSequence(newBlockRange.getStartOffset(),newBlockRange.getEndOffset()).toString();
  if (blockIsWritable && elementText.indexOf("\n") > 0 && whiteSpace.indexOf('\n') >= 0) {
    try {
      Indent lastLineIndent=getLastLineIndent(elementText);
      Indent whiteSpaceIndent=createIndentOn(getLastLine(whiteSpace));
      delta=shiftIndentInside(newBlockRange,calcShiftInDocument(lastLineIndent,whiteSpaceIndent));
    }
 catch (    IOException e) {
      throw new RuntimeException(e);
    }
  }
  return new TextRange(oldBlockTextRange.getStartOffset(),oldBlockTextRange.getEndOffset() + delta);
}
