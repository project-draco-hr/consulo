{
  final int offset=textRange.getEndOffset();
  final ASTNode leafElement=findElementAt(offset);
  if (leafElement != null) {
    if (!myCanModifyAllWhiteSpaces) {
      if (leafElement.getElementType() == ElementType.WHITE_SPACE)       return false;
      LOG.assertTrue(leafElement.getPsi().isValid());
      ASTNode prevNode=TreeUtil.prevLeaf(leafElement);
      if (prevNode != null) {
        IElementType type=prevNode.getElementType();
        if (type == ElementType.WHITE_SPACE) {
          final String s=prevNode.getText();
          if (s.indexOf("<![CDATA[") != -1) {
            return false;
          }
          prevNode=TreeUtil.prevLeaf(prevNode);
          type=prevNode != null ? prevNode.getElementType() : null;
        }
        if (type == XmlElementType.XML_CDATA_END)         return false;
      }
    }
    FormatterUtil.replaceWhiteSpace(whiteSpace,leafElement,ElementType.WHITE_SPACE,textRange);
    return true;
  }
 else   if (textRange.getEndOffset() == myASTNode.getTextLength()) {
    FormatterUtil.replaceLastWhiteSpace(myASTNode,whiteSpace,textRange);
    return true;
  }
 else {
    return false;
  }
}
