{
  final int offset=textRange.getEndOffset();
  final ASTNode leafElement=findElementAt(offset);
  if (leafElement != null) {
    if (!myCanModifyAllWhiteSpaces) {
      if (leafElement.getElementType() == ElementType.WHITE_SPACE)       return false;
      if (isNonEmptyWhiteSpace(leafElement))       return false;
      LOG.assertTrue(leafElement.getPsi().isValid());
      ASTNode prevNode=TreeUtil.prevLeaf(leafElement);
      if (prevNode != null && prevNode.getElementType() == XmlElementType.XML_CDATA_END)       return false;
      if (isNonEmptyWhiteSpace(prevNode)) {
        return false;
      }
    }
    changeWhiteSpaceBeforeLeaf(whiteSpace,leafElement,textRange);
    return true;
  }
 else   if (textRange.getEndOffset() == myASTNode.getTextLength()) {
    changeLastWhiteSpace(whiteSpace,textRange);
    return true;
  }
 else {
    return false;
  }
}
