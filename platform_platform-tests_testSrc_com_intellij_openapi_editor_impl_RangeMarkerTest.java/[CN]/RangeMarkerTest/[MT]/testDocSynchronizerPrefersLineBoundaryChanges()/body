{
  RangeMarker marker=createMarker("import java.awt.List;\n" + "[import java.util.ArrayList;\n]" + "import java.util.HashMap;\n"+ "import java.util.Map;");
  PsiToDocumentSynchronizer synchronizer=((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(getProject())).getSynchronizer();
  Document document=marker.getDocument();
  synchronizer.startTransaction(getProject(),document,null);
  String newText=StringUtil.replaceSubstring(document.getText(),TextRange.create(marker),"");
  synchronizer.replaceString(document,0,document.getTextLength(),newText);
  final List<DocumentEvent> events=new ArrayList<DocumentEvent>();
  document.addDocumentListener(new DocumentAdapter(){
    @Override public void documentChanged(    DocumentEvent e){
      events.add(e);
    }
  }
);
  synchronizer.doCommitTransaction(document);
  assertEquals(newText,document.getText());
  DocumentEvent event=assertOneElement(events);
  assertEquals("DocumentEventImpl[myOffset=22, myOldLength=28, myNewLength=0, myOldString='import java.util.ArrayList;\n', myNewString=''].",event.toString());
}
