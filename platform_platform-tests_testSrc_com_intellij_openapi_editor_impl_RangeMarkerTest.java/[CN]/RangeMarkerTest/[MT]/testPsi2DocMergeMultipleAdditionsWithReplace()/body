{
  StringBuilder buffer=new StringBuilder("0123456789");
  RangeMarker marker=createMarker(buffer.toString(),2,5);
  synchronizer.startTransaction(getProject(),document,psiFile);
  final PsiToDocumentSynchronizer.DocumentChangeTransaction transaction=synchronizer.getTransaction(document);
  final Map<TextRange,CharSequence> affectedFragments=transaction.getAffectedFragments();
  for (int i=0; i < 10; i++) {
    synchronizer.insertString(document,i,"" + i);
    buffer.insert(i,"" + i);
  }
  assertEquals(1,affectedFragments.size());
  synchronizer.replaceString(document,0,20,"0123456789");
  buffer.replace(0,20,"0123456789");
  assertEquals(1,affectedFragments.size());
  synchronizer.commitTransaction(document);
  assertEquals(buffer.toString(),document.getText());
  assertValidMarker(marker,2,5);
}
