{
  StringBuilder buffer=new StringBuilder("0123456789");
  RangeMarker marker=createMarker(buffer.toString(),2,5);
  synchronizer.startTransaction(getProject(),document,psiFile);
  synchronizer.insertString(document,1,"a");
  buffer.insert(1,"a");
  synchronizer.replaceString(document,3,4,"a");
  buffer.replace(3,4,"a");
  synchronizer.replaceString(document,3,5,"bb");
  buffer.replace(3,5,"bb");
  final PsiToDocumentSynchronizer.DocumentChangeTransaction transaction=synchronizer.getTransaction(document);
  final Set<Pair<PsiToDocumentSynchronizer.MutableTextRange,StringBuffer>> affectedFragments=transaction.getAffectedFragments();
  assertEquals(affectedFragments.size(),2);
  synchronizer.commitTransaction(document);
  assertEquals(buffer.toString(),document.getText());
  assertValidMarker(marker,3,6);
}
