{
  final FoldingBuilder foldingBuilder=LanguageFolding.INSTANCE.forLanguage(psiFile.getLanguage());
  final ASTNode node=psiFile.getNode();
  if (node == null)   return Collections.emptyMap();
  ChameleonTransforming.transformChildren(node,true);
  final FoldingDescriptor[] descriptors=foldingBuilder.buildFoldRegions(node,editor.getDocument());
  Map<PsiElement,FoldingDescriptor> ranges=new HashMap<PsiElement,FoldingDescriptor>();
  for (  FoldingDescriptor descriptor : descriptors) {
    final ASTNode ast=descriptor.getElement();
    if (ast instanceof ChameleonElement)     continue;
    final PsiElement psi=ast.getPsi();
    if (psi != null) {
      ranges.put(psi,descriptor);
    }
  }
  return ranges;
}
