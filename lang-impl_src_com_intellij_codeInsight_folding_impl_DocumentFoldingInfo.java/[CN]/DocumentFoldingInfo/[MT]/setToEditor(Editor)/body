{
  LOG.assertTrue(ApplicationManager.getApplication().isReadAccessAllowed());
  if (PsiManager.getInstance(myProject).isDisposed())   return;
  for (int i=0; i < myPsiElementsOrRangeMarkers.size(); i++) {
    Object o=myPsiElementsOrRangeMarkers.get(i);
    if (o instanceof PsiElement) {
      PsiElement element=(PsiElement)o;
      if (!element.isValid())       continue;
      FoldRegion region=FoldingUtil.findFoldRegion(editor,element);
      if (region != null) {
        boolean state=myExpandedStates.get(i).booleanValue();
        region.setExpanded(state);
      }
    }
 else     if (o instanceof RangeMarker) {
      RangeMarker marker=(RangeMarker)o;
      if (!marker.isValid())       continue;
      FoldRegion region=FoldingUtil.findFoldRegion(editor,marker.getStartOffset(),marker.getEndOffset());
      if (region == null) {
        String placeHolderText=myPlaceholderTexts.get(marker);
        region=editor.getFoldingModel().addFoldRegion(marker.getStartOffset(),marker.getEndOffset(),placeHolderText);
      }
      if (region != null) {
        boolean state=myExpandedStates.get(i).booleanValue();
        region.setExpanded(state);
      }
    }
 else {
      LOG.error("o = " + o);
    }
  }
}
