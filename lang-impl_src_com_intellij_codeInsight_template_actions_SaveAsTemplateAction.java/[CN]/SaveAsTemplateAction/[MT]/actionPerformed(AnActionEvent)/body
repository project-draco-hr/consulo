{
  DataContext dataContext=e.getDataContext();
  final Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  PsiFile file=LangDataKeys.PSI_FILE.getData(dataContext);
  final Project project=file.getProject();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final TextRange selection=new TextRange(editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd());
  PsiElement current=file.findElementAt(selection.getStartOffset());
  int startOffset=selection.getStartOffset();
  while (current instanceof PsiWhiteSpace) {
    current=current.getNextSibling();
    if (current == null)     break;
    startOffset=current.getTextRange().getStartOffset();
  }
  if (startOffset >= selection.getEndOffset())   startOffset=selection.getStartOffset();
  final PsiElement[] psiElements=PsiTreeUtil.collectElements(file,new PsiElementFilter(){
    public boolean isAccepted(    PsiElement element){
      return selection.contains(element.getTextRange()) && element.getReferences().length > 0;
    }
  }
);
  final Document document=EditorFactory.getInstance().createDocument(editor.getDocument().getText().substring(startOffset,selection.getEndOffset()));
  final int offsetDelta=startOffset;
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          Map<RangeMarker,String> rangeToText=new HashMap<RangeMarker,String>();
          for (          PsiElement element : psiElements) {
            for (            PsiReference reference : element.getReferences()) {
              if (!(reference instanceof PsiQualifiedReference) || ((PsiQualifiedReference)reference).getQualifier() == null) {
                String canonicalText=reference.getCanonicalText();
                TextRange referenceRange=reference.getRangeInElement();
                TextRange range=element.getTextRange().cutOut(referenceRange).shiftRight(-offsetDelta);
                final String oldText=document.getText().substring(range.getStartOffset(),range.getEndOffset());
                if (!canonicalText.equals(oldText)) {
                  rangeToText.put(document.createRangeMarker(range),canonicalText);
                }
              }
            }
          }
          for (          Map.Entry<RangeMarker,String> entry : rangeToText.entrySet()) {
            document.replaceString(entry.getKey().getStartOffset(),entry.getKey().getEndOffset(),entry.getValue());
          }
        }
      }
);
    }
  }
,null,null);
  TemplateSettings templateSettings=TemplateSettings.getInstance();
  TemplateImpl template=new TemplateImpl("",document.getText(),TemplateSettings.USER_GROUP_NAME);
  FileType fileType=FileTypeManager.getInstance().getFileTypeByFile(file.getVirtualFile());
  boolean anyApplicable=false;
  for (  TemplateContextType contextType : Extensions.getExtensions(TemplateContextType.EP_NAME)) {
    if (contextType.isInContext(fileType)) {
      contextType.setEnabled(template.getTemplateContext(),true);
      anyApplicable=true;
    }
 else {
      contextType.setEnabled(template.getTemplateContext(),false);
    }
  }
  if (!anyApplicable) {
    new OtherContextType().setEnabled(template.getTemplateContext(),true);
  }
  String defaultShortcut="";
  if (templateSettings.getDefaultShortcutChar() == TemplateSettings.ENTER_CHAR) {
    defaultShortcut=CodeInsightBundle.message("template.shortcut.enter");
  }
  if (templateSettings.getDefaultShortcutChar() == TemplateSettings.TAB_CHAR) {
    defaultShortcut=CodeInsightBundle.message("template.shortcut.tab");
  }
  if (templateSettings.getDefaultShortcutChar() == TemplateSettings.SPACE_CHAR) {
    defaultShortcut=CodeInsightBundle.message("template.shortcut.space");
  }
  Map<TemplateOptionalProcessor,Boolean> options=template.createOptions();
  Map<TemplateContextType,Boolean> context=template.createContext();
  EditTemplateDialog dialog=new EditTemplateDialog(editor.getComponent(),CodeInsightBundle.message("dialog.edit.live.template.title"),template,templateSettings.getTemplateGroups(),defaultShortcut,options,context);
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  dialog.apply();
  template.applyOptions(options);
  template.applyContext(context);
  templateSettings.addTemplate(template);
  templateSettings.setLastSelectedTemplateKey(template.getKey());
}
