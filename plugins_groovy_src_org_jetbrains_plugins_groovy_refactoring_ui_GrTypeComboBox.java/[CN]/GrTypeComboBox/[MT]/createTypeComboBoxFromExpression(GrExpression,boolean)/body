{
  PsiType type=expression.getType();
  if (expression instanceof GrReferenceExpression) {
    PsiElement resolved=((GrReferenceExpression)expression).resolve();
    if (resolved instanceof PsiClass) {
      type=TypesUtil.createJavaLangClassType(type,expression.getProject(),expression.getResolveScope());
    }
  }
  if (GroovyRefactoringUtil.isDiamondNewOperator(expression)) {
    LOG.assertTrue(expression instanceof GrNewExpression);
    PsiType expected=PsiImplUtil.inferExpectedTypeForDiamond(expression);
    return new GrTypeComboBox(type,expected,expected == null,expression.getManager(),expression.getResolveScope(),selectDef);
  }
 else {
    if (type == PsiType.NULL) {
      type=PsiType.getJavaLangObject(expression.getManager(),expression.getResolveScope());
    }
    return new GrTypeComboBox(type,null,true,null,null,selectDef);
  }
}
