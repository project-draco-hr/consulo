{
  VirtualFile vFile=psiFile.getVirtualFile();
  if (vFile == null)   return psiFile;
  PsiFile fileCopy;
  if (psiFile instanceof ClsFileImpl) {
    ClsFileImpl implFile=(ClsFileImpl)psiFile;
    if (implFile.isRepositoryIdInitialized()) {
      fileCopy=implFile;
    }
 else {
      fileCopy=new ClsFileImpl((PsiManagerImpl)psiFile.getManager(),psiFile.getViewProvider());
      fileCopy.putUserData(CACHE_COPY_KEY,Boolean.TRUE);
      ((ClsFileImpl)fileCopy).setContent(content);
      ((ClsFileImpl)fileCopy).setRepositoryId(-1);
    }
  }
 else   if (psiFile instanceof PsiFileImpl) {
    PsiFileImpl implFile=(PsiFileImpl)psiFile;
    if (implFile.isContentsLoaded()) {
      fileCopy=implFile;
    }
 else {
      CharSequence text;
      if (content == null) {
        Document document=FileDocumentManager.getInstance().getDocument(vFile);
        text=document.getCharsSequence();
      }
 else {
        text=getContentText(content);
      }
      FileType fileType=psiFile.getFileType();
      final String name=psiFile.getName();
      fileCopy=PsiFileFactory.getInstance(psiFile.getProject()).createFileFromText(name,fileType,text,psiFile.getModificationStamp(),false,false);
      fileCopy.putUserData(CACHE_COPY_KEY,Boolean.TRUE);
      ((PsiFileImpl)fileCopy).setOriginalFile(psiFile);
    }
  }
 else {
    fileCopy=psiFile;
  }
  return fileCopy;
}
