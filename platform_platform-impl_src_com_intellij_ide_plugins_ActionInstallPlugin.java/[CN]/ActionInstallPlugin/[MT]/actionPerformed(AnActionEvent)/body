{
  IdeaPluginDescriptor[] selection=getPluginTable().getSelectedObjects();
  if (userConfirm(selection)) {
    ArrayList<PluginNode> list=new ArrayList<PluginNode>();
    for (    IdeaPluginDescriptor descr : selection) {
      PluginNode pluginNode=null;
      if (descr instanceof PluginNode) {
        pluginNode=(PluginNode)descr;
      }
 else       if (descr instanceof IdeaPluginDescriptorImpl) {
        pluginNode=new PluginNode(descr.getPluginId());
        pluginNode.setName(descr.getName());
        pluginNode.setDepends(Arrays.asList(descr.getDependentPluginIds()),descr.getOptionalDependentPluginIds());
        pluginNode.setSize("-1");
      }
      if (pluginNode != null) {
        list.add(pluginNode);
      }
    }
    try {
      if (PluginManagerMain.downloadPlugins(list,host.getPluginsModel().view)) {
        for (        PluginNode pluginNode : list) {
          final String idString=pluginNode.getPluginId().getIdString();
          if (!PluginManagerUISettings.getInstance().myInstalledPlugins.contains(idString)) {
            PluginManagerUISettings.getInstance().myInstalledPlugins.add(idString);
          }
        }
        final InstalledPluginsTableModel installedPluginsModel=(InstalledPluginsTableModel)installed.getPluginsModel();
        for (        PluginNode node : list) {
          installedPluginsModel.appendOrUpdateDescriptor(node);
        }
        installed.setRequireShutdown(true);
      }
    }
 catch (    IOException e1) {
      PluginManagerMain.LOG.error(e1);
      IOExceptionDialog.showErrorDialog(IdeBundle.message("action.download.and.install.plugin"),IdeBundle.message("error.plugin.download.failed"));
    }
    getPluginTable().updateUI();
  }
}
