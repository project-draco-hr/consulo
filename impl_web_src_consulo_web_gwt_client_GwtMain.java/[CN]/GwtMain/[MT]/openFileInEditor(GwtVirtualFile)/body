{
  Integer indexOfOpened=myOpenedFiles.get(virtualFile.getUrl());
  if (indexOfOpened != null) {
    myTabPanel.selectTab(indexOfOpened);
    return;
  }
  ourAsyncService.getContent(virtualFile.getUrl(),new AsyncCallback<String>(){
    @Override public void onFailure(    Throwable caught){
    }
    @Override public void onSuccess(    String result){
      if (result == null) {
        return;
      }
      final Editor editor=new Editor(result);
      editor.repaint();
      final TabLink tabLink=new TabLink();
      final HorizontalPanel tab=new HorizontalPanel();
      tab.add(icon(virtualFile.getIconLayers()));
      InlineHTML span=new InlineHTML(virtualFile.getName());
      span.setStyleName("textAfterIcon18");
      tab.add(span);
      Image closeImage=new Image("/icons/actions/closeNew.png");
      tab.add(closeImage);
      tabLink.add(tab);
      myTabPanel.add(tabLink);
      TabPane tabPane=tabLink.getTabPane();
      tabPane.setHeight("100%");
      tabPane.setWidth("100%");
      tabPane.addStyleName("disableOverflow");
      tabPane.add(editor.getComponent());
      int index=myOpenedFiles.size();
      myTabPanel.selectTab(index);
      myOpenedFiles.put(virtualFile.getUrl(),index);
      closeImage.addClickHandler(new ClickHandler(){
        @Override public void onClick(        ClickEvent event){
          myOpenedFiles.remove(virtualFile.getUrl());
          myTabPanel.remove(tabLink);
          int size=myOpenedFiles.size();
          if (size > 0) {
            myTabPanel.selectTab(size - 1);
          }
        }
      }
);
      ourAsyncService.getLexerHighlight(virtualFile.getUrl(),new ReportableCallable<List<GwtHighlightInfo>>(){
        @Override public void onSuccess(        List<GwtHighlightInfo> result){
          editor.addHighlightInfos(result,ourLexerFlag);
          runHighlightPasses(virtualFile,editor,0);
          editor.setCaretHandler(new EditorCaretHandler(){
            @Override public void caretPlaced(            @NotNull final EditorCaretEvent event){
              runHighlightPasses(virtualFile,editor,event.getOffset());
              ourAsyncService.getNavigationInfo(virtualFile.getUrl(),event.getOffset(),new ReportableCallable<List<GwtNavigatable>>(){
                @Override public void onSuccess(                List<GwtNavigatable> result){
                  if (!result.isEmpty()) {
                    final PopupPanel popupPanel=new PopupPanel(true);
                    for (                    final GwtNavigatable navigatable : result) {
                      Anchor anchor=new Anchor("Navigate to declaration");
                      anchor.addClickHandler(new ClickHandler(){
                        @Override public void onClick(                        ClickEvent event){
                          ourAsyncService.findFileByUrl(navigatable.getFileUrl(),new ReportableCallable<GwtVirtualFile>(){
                            @Override public void onSuccess(                            GwtVirtualFile result){
                              popupPanel.hide();
                              openFileInEditor(result);
                            }
                          }
);
                        }
                      }
);
                      popupPanel.add(anchor);
                    }
                    popupPanel.setPopupPosition(event.getClientX(),event.getClientY());
                    popupPanel.show();
                  }
                }
              }
);
            }
          }
);
        }
      }
);
    }
  }
);
}
