{
  if (!FileModificationService.getInstance().prepareFileForWrite(file))   return;
  final XmlElementFactory elementFactory=XmlElementFactory.getInstance(file.getProject());
  if (tag.getAttributeValue(XMLNS_XSI_ATTR_NAME) == null) {
    tag.add(elementFactory.createXmlAttribute(XMLNS_XSI_ATTR_NAME,XmlUtil.XML_SCHEMA_INSTANCE_URI));
  }
  final XmlAttribute locationAttribute=tag.getAttribute(XSI_SCHEMA_LOCATION_ATTR_NAME);
  final String toInsert=uri + " " + s;
  int offset=s.length();
  if (locationAttribute == null) {
    tag.add(elementFactory.createXmlAttribute(XSI_SCHEMA_LOCATION_ATTR_NAME,toInsert));
  }
 else {
    final String newValue=locationAttribute.getValue() + "\n" + toInsert;
    locationAttribute.setValue(newValue);
  }
  CodeStyleManager.getInstance(file.getProject()).reformat(tag);
  @SuppressWarnings("ConstantConditions") final TextRange range=tag.getAttribute(XSI_SCHEMA_LOCATION_ATTR_NAME).getValueElement().getTextRange();
  final TextRange textRange=new TextRange(range.getEndOffset() - offset - 1,range.getEndOffset() - 1);
  editor.getCaretModel().moveToOffset(textRange.getStartOffset());
}
