{
  boolean showBackgroundButton=false;
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    final CacheUpdater[] updaters=syncSession.getUpdaters();
    for (int i=0; i < updaters.length; i++) {
      CacheUpdater updater=updaters[i];
      if (updater instanceof BackgroundableCacheUpdater) {
        if (((BackgroundableCacheUpdater)updater).initiallyBackgrounded()) {
          List<VirtualFile> remaining=syncSession.backgrounded(i);
          if (remaining != null && !remaining.isEmpty()) {
            ((BackgroundableCacheUpdater)updater).backgrounded(remaining);
          }
        }
 else {
          showBackgroundButton=true;
        }
      }
    }
  }
  final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  if (indicator instanceof ProgressWindow && showBackgroundButton) {
    final ProgressWindow progressWindow=(ProgressWindow)indicator;
    progressWindow.setBackgroundHandler(new Runnable(){
      public void run(){
        handleBackgroundAction(progressWindow,syncSession);
      }
    }
);
  }
  try {
    super.updateFiles(syncSession);
  }
  finally {
    if (indicator instanceof ProgressWindow) {
      ((ProgressWindow)indicator).setBackgroundHandler(null);
    }
  }
}
