{
  final SubTree tree=new SubTree(myWorkingCopyDir);
  checkin();
  final VirtualFile inner=createDirInCommand(tree.mySourceDir,"inner");
  final VirtualFile innerFile=createFileInCommand(inner,"inInner.txt","kdfjsdisdjiuewjfew wefn w");
  checkin();
  runAndVerifyStatusSorted();
  editFileInCommand(myProject,innerFile,"some content");
  renameFileInCommand(myProject,tree.mySourceDir,"newName");
  myDirtyScopeManager.markEverythingDirty();
  myChangeListManager.ensureUpToDate(false);
  final Change change=assertRenamedChange(tree.mySourceDir);
  final Change s1Change=assertMovedChange(tree.myS1File);
  final Change s2Change=assertMovedChange(tree.myS2File);
  assertMovedChange(inner);
  final Change innerChange=assertMovedChange(innerFile);
  rollbackIMpl(Arrays.asList(change),Arrays.asList(new Change(innerChange.getBeforeRevision(),innerChange.getBeforeRevision(),FileStatus.MODIFIED)));
}
