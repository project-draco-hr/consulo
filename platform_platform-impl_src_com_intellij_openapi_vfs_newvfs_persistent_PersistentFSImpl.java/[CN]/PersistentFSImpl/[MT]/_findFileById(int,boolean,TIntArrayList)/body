{
  NewVirtualFile cached=myIdToDirCache.get(id);
  if (cached != null) {
    return cached;
  }
  if (visited != null) {
    if (visited.size() < DEPTH_LIMIT) {
      visited.add(id);
    }
 else {
      StringBuilder sb=new StringBuilder("Dead loop detected in persistent FS:");
      for (int i=0; i < visited.size(); i++) {
        int _id=visited.get(i);
        sb.append("\n  ").append(_id).append(" '").append(getName(_id)).append("' ").append(String.format("%02x",getFileAttributes(_id)));
      }
      LOG.error(sb.toString());
      return null;
    }
  }
  NewVirtualFile result=doFindFile(id,cachedOnly,visited);
  if (result != null && result.isDirectory()) {
    NewVirtualFile old=myIdToDirCache.put(id,result);
    if (old != null)     result=old;
  }
  return result;
}
