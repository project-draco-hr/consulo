{
  NewVirtualFile cached=myIdToDirCache.get(id);
  if (cached != null) {
    return cached;
  }
  if (visited != null) {
    if (visited.size() < DEPTH_LIMIT) {
      visited.add(id);
    }
 else {
      @NonNls StringBuilder sb=new StringBuilder("Dead loop detected in persistent FS:");
      for (int i=0; i < visited.size(); i++) {
        int _id=visited.get(i);
        sb.append("\n  ");
        sb.append(_id);
        sb.append(" '");
        sb.append(getName(_id));
        sb.append("' ");
        sb.append(String.format("%02x",getFileAttributes(_id)));
      }
      LOG.error(sb.toString());
      return null;
    }
  }
  final int parentId=getParent(id);
  NewVirtualFile result;
  if (parentId == 0) {
    myRootsLock.readLock().lock();
    try {
      result=myRootsById.get(id);
    }
  finally {
      myRootsLock.readLock().unlock();
    }
  }
 else {
    NewVirtualFile parentFile=_findFileById(parentId,cachedOnly,visited);
    if (parentFile == null) {
      result=null;
    }
 else {
      result=cachedOnly ? parentFile.findChildByIdIfCached(id) : parentFile.findChildById(id);
    }
  }
  if (result != null && result.isDirectory()) {
    NewVirtualFile old=myIdToDirCache.put(id,result);
    if (old != null)     result=old;
  }
  return result;
}
