{
  VirtualFileSystemEntry cached=myIdToDirCache.get(id);
  if (cached != null)   return cached;
  if (visited != null && (visited.size() >= DEPTH_LIMIT || (mask & id) == id && visited.contains(id))) {
    @NonNls String sb="Dead loop detected in persistent FS (id=" + id + " cached-only="+ cachedOnly+ "):";
    for (int i=0; i < visited.size(); i++) {
      int _id=visited.get(i);
      sb+="\n  " + _id + " '"+ getName(_id)+ "' "+ String.format("%02x",getFileAttributes(_id))+ ' '+ myIdToDirCache.containsKey(_id);
    }
    LOG.error(sb);
    return null;
  }
  int parentId=getParent(id);
  if (parentId >= id) {
    if (visited == null)     visited=new TIntArrayList(DEPTH_LIMIT);
  }
  if (visited != null)   visited.add(id);
  VirtualFileSystemEntry result;
  if (parentId == 0) {
    myRootsLock.readLock().lock();
    try {
      result=myRootsById.get(id);
    }
  finally {
      myRootsLock.readLock().unlock();
    }
  }
 else {
    VirtualFileSystemEntry parentFile=findFileById(parentId,cachedOnly,visited,mask | id);
    if (parentFile instanceof VirtualDirectoryImpl) {
      result=((VirtualDirectoryImpl)parentFile).findChildById(id,cachedOnly);
    }
 else {
      result=null;
    }
  }
  if (result != null && result.isDirectory()) {
    VirtualFileSystemEntry old=myIdToDirCache.put(id,result);
    if (old != null)     result=old;
  }
  return result;
}
