{
  NewVirtualFile cached=myIdToDirCache.get(id);
  if (cached != null) {
    return cached;
  }
  if (visited.size() >= DEPTH_LIMIT || (mask & id) == id && visited.contains(id)) {
    StringBuilder sb=new StringBuilder("Dead loop detected in persistent FS (id=" + id + " cached-only="+ cachedOnly+ "):");
    for (int i=0; i < visited.size(); i++) {
      int _id=visited.get(i);
      sb.append("\n  ").append(_id).append(" '").append(getName(_id)).append("' ").append(String.format("%02x",getFileAttributes(_id))).append(' ').append(myIdToDirCache.containsKey(_id));
    }
    LOG.error(sb.toString());
    return null;
  }
  visited.add(id);
  int parentId=getParent(id);
  NewVirtualFile result;
  if (parentId == 0) {
    myRootsLock.readLock().lock();
    try {
      result=myRootsById.get(id);
    }
  finally {
      myRootsLock.readLock().unlock();
    }
  }
 else {
    NewVirtualFile parentFile=_findFileById(parentId,cachedOnly,visited,mask|=id);
    if (parentFile == null) {
      result=null;
    }
 else {
      result=cachedOnly ? parentFile.findChildByIdIfCached(id) : parentFile.findChildById(id);
    }
  }
  if (result != null && result.isDirectory()) {
    NewVirtualFile old=myIdToDirCache.put(id,result);
    if (old != null)     result=old;
  }
  return result;
}
