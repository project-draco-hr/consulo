{
  final VirtualFile canonicalFile=getCanonicalFile(file);
synchronized (INPUT_LOCK) {
    InputStream contentStream;
    if (mustReloadContent(canonicalFile) || (contentStream=readContent(canonicalFile)) == null) {
      final NewVirtualFileSystem delegate=getDelegate(canonicalFile);
      final long len=delegate.getLength(canonicalFile);
      FSRecords.setLength(getFileId(canonicalFile),len);
      final InputStream nativeStream=delegate.getInputStream(canonicalFile);
      if (len > PersistentFSConstants.FILE_LENGTH_TO_CACHE_THRESHOLD)       return nativeStream;
      return createReplicator(canonicalFile,nativeStream,len,delegate.isReadOnly());
    }
 else {
      return contentStream;
    }
  }
}
