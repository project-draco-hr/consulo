{
  if (basePath.isEmpty()) {
    LOG.error("Invalid root, fs=" + fs);
    return null;
  }
  String rootUrl=normalizeRootUrl(basePath,fs);
  myRootsLock.readLock().lock();
  try {
    VirtualFileSystemEntry root=myRoots.get(rootUrl);
    if (root != null)     return root;
  }
  finally {
    myRootsLock.readLock().unlock();
  }
  final VirtualFileSystemEntry newRoot;
  int rootId=FSRecords.findRootRecord(rootUrl);
  VfsData.Segment segment=VfsData.getSegment(rootId,true);
  VfsData.DirectoryData directoryData=new VfsData.DirectoryData();
  if (fs instanceof JarFileSystem) {
    String parentPath=basePath.substring(0,basePath.indexOf(JarFileSystem.JAR_SEPARATOR));
    VirtualFile parentFile=LocalFileSystem.getInstance().findFileByPath(parentPath);
    if (parentFile == null)     return null;
    FileType type=FileTypeRegistry.getInstance().getFileTypeByFileName(parentFile.getName());
    if (!(type instanceof ArchiveFileType))     return null;
    newRoot=new JarRoot(fs,rootId,segment,directoryData,parentFile);
  }
 else {
    newRoot=new FsRoot(fs,rootId,segment,directoryData,basePath);
  }
  FileAttributes attributes=fs.getAttributes(new StubVirtualFile(){
    @NotNull @Override public String getPath(){
      return newRoot.getPath();
    }
    @Nullable @Override public VirtualFile getParent(){
      return null;
    }
  }
);
  if (attributes == null || !attributes.isDirectory()) {
    return null;
  }
  boolean mark=false;
  myRootsLock.writeLock().lock();
  try {
    VirtualFileSystemEntry root=myRoots.get(rootUrl);
    if (root != null)     return root;
    VfsData.initFile(rootId,segment,-1,directoryData);
    mark=writeAttributesToRecord(rootId,0,newRoot,fs,attributes);
    myRoots.put(rootUrl,newRoot);
    myRootsById.put(rootId,newRoot);
  }
  finally {
    myRootsLock.writeLock().unlock();
  }
  if (!mark && attributes.lastModified != FSRecords.getTimestamp(rootId)) {
    newRoot.markDirtyRecursively();
  }
  LOG.assertTrue(rootId == newRoot.getId(),"root=" + newRoot + " expected="+ rootId+ " actual="+ newRoot.getId());
  return newRoot;
}
