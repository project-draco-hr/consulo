{
  final ArrayList<ProcessingItem> compiledItems=new ArrayList<ProcessingItem>();
  context.getProgressIndicator().setText(UIDesignerBundle.message("progress.compiling.ui.forms"));
  int formsProcessed=0;
  final Project project=context.getProject();
  final FormSourceCodeGenerator generator=new FormSourceCodeGenerator(project);
  final HashSet<Module> processedModules=new HashSet<Module>();
  final List<File> filesToRefresh=new ArrayList<File>();
  for (  ProcessingItem item1 : items) {
    context.getProgressIndicator().setFraction((double)(++formsProcessed) / ((double)items.length));
    final MyInstrumentationItem item=(MyInstrumentationItem)item1;
    final VirtualFile formFile=item.getFormFile();
    if (GuiDesignerConfiguration.getInstance(project).COPY_FORMS_RUNTIME_TO_OUTPUT) {
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          final Module module=ModuleUtil.findModuleForFile(formFile,project);
          if (module != null && !processedModules.contains(module)) {
            processedModules.add(module);
            final String moduleOutputPath=CompilerPaths.getModuleOutputPath(module,false);
            try {
              if (moduleOutputPath != null) {
                filesToRefresh.addAll(CopyResourcesUtil.copyFormsRuntime(moduleOutputPath,false));
              }
              final String testsOutputPath=CompilerPaths.getModuleOutputPath(module,true);
              if (testsOutputPath != null && !testsOutputPath.equals(moduleOutputPath)) {
                filesToRefresh.addAll(CopyResourcesUtil.copyFormsRuntime(testsOutputPath,false));
              }
            }
 catch (            IOException e) {
              addError(context,new FormErrorInfo(null,UIDesignerBundle.message("error.cannot.copy.gui.designer.form.runtime",module.getName(),e.toString())),null);
            }
          }
        }
      }
);
    }
    ApplicationManager.getApplication().invokeAndWait(new Runnable(){
      public void run(){
        CommandProcessor.getInstance().executeCommand(project,new Runnable(){
          public void run(){
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                PsiDocumentManager.getInstance(project).commitAllDocuments();
                generator.generate(formFile);
                final ArrayList<FormErrorInfo> errors=generator.getErrors();
                if (errors.size() == 0) {
                  compiledItems.add(item);
                }
 else {
                  for (                  final FormErrorInfo e : errors) {
                    addError(context,e,formFile);
                  }
                }
              }
            }
);
          }
        }
,"",null);
        FileDocumentManager.getInstance().saveAllDocuments();
      }
    }
,ModalityState.NON_MODAL);
  }
  CompilerUtil.refreshIOFiles(filesToRefresh);
  return compiledItems.toArray(new ProcessingItem[compiledItems.size()]);
}
