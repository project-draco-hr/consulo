{
  final SelectionModel selectionModel=editor.getSelectionModel();
  final int startLine;
  final int endLine;
  LineRange range;
  if (selectionModel.hasSelection()) {
    startLine=editor.offsetToLogicalPosition(selectionModel.getSelectionStart()).line;
    final LogicalPosition endPos=editor.offsetToLogicalPosition(selectionModel.getSelectionEnd());
    endLine=endPos.column == 0 ? endPos.line - 1 : endPos.line;
    range=new LineRange(startLine,endLine);
  }
 else {
    startLine=editor.getCaretModel().getLogicalPosition().line;
    endLine=startLine;
    range=new LineRange(startLine,endLine);
  }
  final int maxLine=editor.offsetToLogicalPosition(editor.getDocument().getTextLength()).line;
  if (range.startLine <= 1 && !myIsDown)   return false;
  if (range.endLine >= maxLine - 1 && myIsDown)   return false;
  int nearLine=myIsDown ? range.endLine + 2 : range.startLine - 1;
  whatToMove=range;
  insertOffset=editor.logicalPositionToOffset(new LogicalPosition(nearLine,0));
  return true;
}
