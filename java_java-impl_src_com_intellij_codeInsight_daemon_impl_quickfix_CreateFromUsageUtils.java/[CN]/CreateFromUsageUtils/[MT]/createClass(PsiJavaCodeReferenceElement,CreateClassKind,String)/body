{
  final String name=referenceElement.getReferenceName();
  final PsiElement qualifierElement;
  if (referenceElement.getQualifier() instanceof PsiJavaCodeReferenceElement) {
    PsiJavaCodeReferenceElement qualifier=(PsiJavaCodeReferenceElement)referenceElement.getQualifier();
    qualifierElement=qualifier == null ? null : qualifier.resolve();
    if (qualifierElement instanceof PsiClass) {
      return ApplicationManager.getApplication().runWriteAction(new Computable<PsiClass>(){
        public PsiClass compute(){
          try {
            PsiClass psiClass=(PsiClass)qualifierElement;
            if (!CodeInsightUtilBase.preparePsiElementForWrite(psiClass))             return null;
            PsiManager manager=psiClass.getManager();
            PsiElementFactory elementFactory=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory();
            PsiClass result=classKind == INTERFACE ? elementFactory.createInterface(name) : classKind == CLASS ? elementFactory.createClass(name) : elementFactory.createEnum(name);
            result=(PsiClass)manager.getCodeStyleManager().reformat(result);
            return (PsiClass)psiClass.add(result);
          }
 catch (          IncorrectOperationException e) {
            LOG.error(e);
            return null;
          }
        }
      }
);
    }
  }
 else {
    qualifierElement=null;
  }
  final PsiManager manager=referenceElement.getManager();
  final PsiFile sourceFile=referenceElement.getContainingFile();
  final Module module=ModuleUtil.findModuleForPsiElement(sourceFile);
  PsiPackage aPackage=null;
  if (qualifierElement instanceof PsiPackage) {
    aPackage=((PsiPackage)qualifierElement);
  }
 else {
    final PsiDirectory directory=sourceFile.getContainingDirectory();
    if (directory != null) {
      aPackage=JavaDirectoryService.getInstance().getPackage(directory);
    }
    if (aPackage == null) {
      aPackage=JavaPsiFacade.getInstance(manager.getProject()).findPackage("");
    }
  }
  if (aPackage == null)   return null;
  final PsiDirectory targetDirectory;
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    Project project=manager.getProject();
    String title=QuickFixBundle.message("create.class.title",StringUtil.capitalize(classKind.getDescription()));
    CreateClassDialog dialog=new CreateClassDialog(project,title,name,aPackage.getQualifiedName(),classKind,false,module);
    dialog.show();
    if (dialog.getExitCode() != DialogWrapper.OK_EXIT_CODE)     return null;
    targetDirectory=dialog.getTargetDirectory();
    if (targetDirectory == null)     return null;
  }
 else {
    targetDirectory=null;
  }
  return createClass(classKind,targetDirectory,name,manager,referenceElement,sourceFile,superClassName);
}
