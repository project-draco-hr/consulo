{
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(manager.getProject());
  final PsiElementFactory factory=facade.getElementFactory();
  return ApplicationManager.getApplication().runWriteAction(new Computable<PsiClass>(){
    @Override public PsiClass compute(){
      try {
        PsiClass targetClass;
        if (directory != null) {
          try {
            if (classKind == CreateClassKind.INTERFACE) {
              targetClass=JavaDirectoryService.getInstance().createInterface(directory,name);
            }
 else             if (classKind == CreateClassKind.CLASS) {
              targetClass=JavaDirectoryService.getInstance().createClass(directory,name);
            }
 else             if (classKind == CreateClassKind.ENUM) {
              targetClass=JavaDirectoryService.getInstance().createEnum(directory,name);
            }
 else             if (classKind == CreateClassKind.ANNOTATION) {
              targetClass=JavaDirectoryService.getInstance().createAnnotationType(directory,name);
            }
 else {
              LOG.error("Unknown kind of a class to create");
              return null;
            }
          }
 catch (          final IncorrectOperationException e) {
            scheduleFileOrPackageCreationFailedMessageBox(e,name,directory,false);
            return null;
          }
          if (!facade.getResolveHelper().isAccessible(targetClass,contextElement,null)) {
            PsiUtil.setModifierProperty(targetClass,PsiModifier.PUBLIC,true);
          }
        }
 else {
          PsiClass aClass;
          if (classKind == CreateClassKind.INTERFACE) {
            aClass=factory.createInterface(name);
          }
 else           if (classKind == CreateClassKind.CLASS) {
            aClass=factory.createClass(name);
          }
 else           if (classKind == CreateClassKind.ENUM) {
            aClass=factory.createEnum(name);
          }
 else           if (classKind == CreateClassKind.ANNOTATION) {
            aClass=factory.createAnnotationType(name);
          }
 else {
            LOG.error("Unknown kind of a class to create");
            return null;
          }
          targetClass=(PsiClass)sourceFile.add(aClass);
        }
        if (superClassName != null) {
          final PsiClass superClass=facade.findClass(superClassName,targetClass.getResolveScope());
          final PsiJavaCodeReferenceElement superClassReference=factory.createReferenceElementByFQClassName(superClassName,targetClass.getResolveScope());
          final PsiReferenceList list=classKind == CreateClassKind.INTERFACE || superClass == null || !superClass.isInterface() ? targetClass.getExtendsList() : targetClass.getImplementsList();
          list.add(superClassReference);
        }
        if (contextElement instanceof PsiJavaCodeReferenceElement) {
          CreateFromUsageBaseFix.setupGenericParameters(targetClass,(PsiJavaCodeReferenceElement)contextElement);
        }
        return targetClass;
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
        return null;
      }
    }
  }
);
}
