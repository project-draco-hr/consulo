{
  element.accept(new PsiRecursiveElementVisitor(true){
    @Override public void visitElement(    PsiElement element){
      final PsiFileSystemItem item=element.getCopyableUserData(REF_FILE_SYSTEM_ITEM_KEY);
      element.putCopyableUserData(REF_FILE_SYSTEM_ITEM_KEY,null);
      if (item != null && item.isValid()) {
        PsiReference[] refs=element.getReferences();
        if (refs.length > 0 && refs[0] instanceof FileReferenceOwner) {
          final FileReference ref=((FileReferenceOwner)refs[0]).getLastFileReference();
          if (ref != null) {
            try {
              element=ref.bindToElement(item);
            }
 catch (            IncorrectOperationException e) {
              LOG.error(e);
            }
          }
        }
      }
      if (element != null) {
        element.acceptChildren(this);
      }
    }
  }
);
}
