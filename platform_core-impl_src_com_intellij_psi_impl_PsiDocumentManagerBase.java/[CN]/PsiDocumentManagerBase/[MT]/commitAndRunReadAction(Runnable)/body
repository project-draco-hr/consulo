{
  final Application application=ApplicationManager.getApplication();
  if (SwingUtilities.isEventDispatchThread()) {
    commitAllDocuments();
    runnable.run();
    return;
  }
  if (ApplicationManager.getApplication().isReadAccessAllowed()) {
    LOG.error("Don't call commitAndRunReadAction inside ReadAction, it will cause a deadlock otherwise. " + Thread.currentThread());
  }
  while (true) {
    boolean executed=application.runReadAction(new Computable<Boolean>(){
      @Override public Boolean compute(){
        if (myUncommittedDocuments.isEmpty()) {
          runnable.run();
          return true;
        }
        return false;
      }
    }
);
    if (executed)     break;
    final Semaphore semaphore=new Semaphore();
    semaphore.down();
    application.invokeLater(new Runnable(){
      @Override public void run(){
        performWhenAllCommitted(new Runnable(){
          @Override public void run(){
            semaphore.up();
          }
        }
);
      }
    }
,ModalityState.any());
    semaphore.waitFor();
  }
}
