{
  final Document document=event.getDocument();
  if (!(document instanceof DocumentWindow) && !myLastCommittedTexts.containsKey(document)) {
    myLastCommittedTexts.put(document,document.getImmutableCharSequence());
  }
  final FileViewProvider viewProvider=getCachedViewProvider(document);
  if (viewProvider == null)   return;
  if (!isRelevant(viewProvider))   return;
  VirtualFile virtualFile=viewProvider.getVirtualFile();
  if (virtualFile.getFileType().isBinary())   return;
  final List<PsiFile> files=viewProvider.getAllFiles();
  PsiFile psiCause=null;
  for (  PsiFile file : files) {
    if (file == null) {
      throw new AssertionError("View provider " + viewProvider + " ("+ viewProvider.getClass()+ ") returned null in its files array: "+ files+ " for file "+ viewProvider.getVirtualFile());
    }
    mySmartPointerManager.fastenBelts(file,event.getOffset(),null);
    if (mySynchronizer.isInsideAtomicChange(file)) {
      psiCause=file;
    }
  }
  if (psiCause == null) {
    beforeDocumentChangeOnUnlockedDocument(viewProvider);
  }
  ((SingleRootFileViewProvider)viewProvider).beforeDocumentChanged(psiCause);
}
