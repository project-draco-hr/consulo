{
  if (file instanceof PsiBinaryFile)   return null;
  Document document=getCachedDocument(file);
  if (document != null) {
    if (!file.getViewProvider().isPhysical() && document.getUserData(HARD_REF_TO_PSI) == null) {
      cachePsi(document,file);
    }
    return document;
  }
  if (!file.getViewProvider().isEventSystemEnabled())   return null;
  document=FileDocumentManager.getInstance().getDocument(file.getViewProvider().getVirtualFile());
  if (document != null) {
    if (document.getTextLength() != file.getTextLength()) {
      throw new AssertionError("Modified PSI with no document: " + file + "; physical="+ file.getViewProvider().isPhysical());
    }
    if (!file.getViewProvider().isPhysical()) {
      cachePsi(document,file);
    }
  }
  return document;
}
