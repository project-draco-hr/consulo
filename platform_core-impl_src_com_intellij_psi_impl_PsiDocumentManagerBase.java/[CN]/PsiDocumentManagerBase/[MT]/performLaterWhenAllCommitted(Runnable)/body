{
  final ModalityState modalityState=ModalityState.defaultModalityState();
  final Runnable whenAllCommitted=new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (hasUncommitedDocuments()) {
            performLaterWhenAllCommitted(runnable);
          }
 else {
            runnable.run();
          }
        }
      }
,modalityState,myProject.getDisposed());
    }
  }
;
  if (ApplicationManager.getApplication().isDispatchThread() && isInsideCommitHandler()) {
    whenAllCommitted.run();
  }
 else {
    UIUtil.invokeLaterIfNeeded(new Runnable(){
      @Override public void run(){
        performWhenAllCommitted(whenAllCommitted);
      }
    }
);
  }
}
