{
  String regex=text;
  @NonNls Collection<String> properties=new ArrayList<String>((Collection)FileTemplateManager.getInstance().getDefaultProperties(project).keySet());
  properties.add("PACKAGE_NAME");
  regex=escapeRegexChars(regex);
  int groupNumber=1;
  for (  String name : properties) {
    String escaped=escapeRegexChars("${" + name + "}");
    boolean first=true;
    for (int i=regex.indexOf(escaped); i != -1 && i < regex.length(); i=regex.indexOf(escaped,i + 1)) {
      String replacement=first ? "(.*)" : "\\" + groupNumber;
      final int delta=escaped.length() - replacement.length();
      int[] offs=offsetToProperty.keys();
      for (      int off : offs) {
        if (off > i) {
          String prop=offsetToProperty.remove(off);
          offsetToProperty.put(off - delta,prop);
        }
      }
      offsetToProperty.put(i,name);
      regex=regex.substring(0,i) + replacement + regex.substring(i + escaped.length());
      if (first) {
        groupNumber++;
        first=false;
      }
    }
  }
  return regex;
}
