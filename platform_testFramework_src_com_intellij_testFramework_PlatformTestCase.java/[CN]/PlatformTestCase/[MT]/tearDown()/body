{
  checkAllTimersAreDisposed();
  if (myProject != null) {
    ((StartupManagerImpl)StartupManager.getInstance(myProject)).prepareForNextTest();
    final LookupManager lookupManager=LookupManager.getInstance(myProject);
    if (lookupManager != null) {
      lookupManager.hideActiveLookup();
    }
    ((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(getProject())).clearUncommitedDocuments();
  }
  InspectionProfileManager.getInstance().deleteProfile(PROFILE);
  try {
    checkForSettingsDamage();
    assertNotNull("Application components damaged",ProjectManager.getInstance());
    ApplicationManager.getApplication().runWriteAction(EmptyRunnable.getInstance());
    FileDocumentManager.getInstance().saveAllDocuments();
    doPostponedFormatting(myProject);
    try {
      disposeProject();
      ((UndoManagerImpl)UndoManager.getGlobalInstance()).dropHistoryInTests();
      for (      final File fileToDelete : myFilesToDelete) {
        delete(fileToDelete);
      }
      LocalFileSystem.getInstance().refreshIoFiles(myFilesToDelete);
      FileUtil.asyncDelete(new File(myTempDirPath));
      setTmpDir(ourOriginalTempDir);
      Throwable fromThreadGroup=MY_THREAD_GROUP.popThrowable();
      if (fromThreadGroup != null) {
        throw new RuntimeException(fromThreadGroup);
      }
      if (!myAssertionsInTestDetected) {
        if (IdeaLogger.ourErrorsOccurred != null) {
          throw IdeaLogger.ourErrorsOccurred;
        }
        assertTrue("Logger errors occurred in " + getFullName(),IdeaLogger.ourErrorsOccurred == null);
      }
      ourApplication.setDataProvider(null);
    }
  finally {
      ourTestCase=null;
    }
    CompletionProgressIndicator.cleanupForNextTest();
    super.tearDown();
    EditorFactory editorFactory=EditorFactory.getInstance();
    final Editor[] allEditors=editorFactory.getAllEditors();
    ((EditorFactoryImpl)editorFactory).validateEditorsAreReleased(getProject());
    for (    Editor editor : allEditors) {
      editorFactory.releaseEditor(editor);
    }
    assertEquals(0,allEditors.length);
    myEditorListenerTracker.checkListenersLeak();
    myThreadTracker.checkLeak();
  }
  finally {
    myProjectManager=null;
    myProject=null;
    myModule=null;
    myFilesToDelete.clear();
  }
}
