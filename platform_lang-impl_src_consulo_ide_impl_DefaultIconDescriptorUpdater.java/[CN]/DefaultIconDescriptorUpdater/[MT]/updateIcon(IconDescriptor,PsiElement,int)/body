{
  if (element instanceof PsiDirectory) {
    PsiDirectory psiDirectory=(PsiDirectory)element;
    VirtualFile virtualFile=psiDirectory.getVirtualFile();
    Project project=psiDirectory.getProject();
    Icon symbolIcon;
    if (virtualFile.getFileSystem() instanceof ArchiveFileSystem) {
      if (virtualFile.getParent() == null) {
        symbolIcon=AllIcons.Nodes.PpJar;
      }
 else {
        PsiPackage psiPackage=PsiPackageManager.getInstance(project).findAnyPackage(psiDirectory);
        symbolIcon=psiPackage != null ? AllIcons.Nodes.Package : AllIcons.Nodes.TreeClosed;
      }
    }
 else     if (ProjectRootsUtil.isModuleContentRoot(virtualFile,project)) {
      symbolIcon=AllIcons.Nodes.Module;
    }
 else {
      boolean ignored=ProjectRootManager.getInstance(project).getFileIndex().isExcluded(virtualFile);
      if (ignored) {
        symbolIcon=AllIcons.Modules.ExcludeRoot;
      }
 else {
        ContentFolder contentFolder=ProjectRootsUtil.getContentFolderIfIs(virtualFile,project);
        if (contentFolder != null) {
          symbolIcon=contentFolder.getType().getIcon(contentFolder.getProperties());
        }
 else {
          ContentFolderTypeProvider contentFolderTypeForFile=ProjectFileIndex.SERVICE.getInstance(project).getContentFolderTypeForFile(virtualFile);
          symbolIcon=contentFolderTypeForFile != null ? contentFolderTypeForFile.getChildDirectoryIcon(psiDirectory) : AllIcons.Nodes.TreeClosed;
        }
      }
    }
    iconDescriptor.setMainIcon(symbolIcon);
    if (virtualFile.is(VFileProperty.SYMLINK)) {
      iconDescriptor.addLayerIcon(AllIcons.Nodes.Symlink);
    }
  }
 else   if (element instanceof PsiPackage) {
    iconDescriptor.setMainIcon(AllIcons.Nodes.Package);
  }
 else   if (element instanceof PsiFile) {
    if (iconDescriptor.getMainIcon() == null) {
      VirtualFile virtualFile=((PsiFile)element).getVirtualFile();
      if (virtualFile != null) {
        iconDescriptor.setMainIcon(NativeFileIconUtil.INSTANCE.getIcon(virtualFile));
      }
      if (iconDescriptor.getMainIcon() == null) {
        FileType fileType=((PsiFile)element).getFileType();
        iconDescriptor.setMainIcon(fileType.getIcon());
      }
    }
    VirtualFile virtualFile=((PsiFile)element).getVirtualFile();
    if (virtualFile != null && virtualFile.is(VFileProperty.SYMLINK)) {
      iconDescriptor.addLayerIcon(AllIcons.Nodes.Symlink);
    }
  }
 else {
    Icon languageElementIcon=LanguageElementIcons.INSTANCE.forLanguage(element.getLanguage());
    if (languageElementIcon == null) {
      return;
    }
    iconDescriptor.addLayerIcon(languageElementIcon);
  }
}
