{
  HighlighterIterator iterator=((EditorEx)editor).getHighlighter().createIterator(offset);
  while (iterator.getStart() > 0 && !BraceMatchingUtil.isTokenInvalidInsideReference(iterator.getTokenType())) {
    iterator.retreat();
  }
  if (BraceMatchingUtil.isTokenInvalidInsideReference(iterator.getTokenType()))   iterator.advance();
  int balance=0;
  while (!iterator.atEnd() && balance >= 0) {
    final IElementType tokenType=iterator.getTokenType();
    if (tokenType == JavaTokenType.LT) {
      balance++;
    }
 else     if (tokenType == JavaTokenType.GT) {
      balance--;
    }
 else     if (BraceMatchingUtil.isTokenInvalidInsideReference(tokenType)) {
      break;
    }
    iterator.advance();
  }
  if (balance < 0) {
    editor.getDocument().deleteString(offset,offset + 1);
  }
  return true;
}
