{
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  Document document=editor.getDocument();
  final PsiFile file=documentManager.getPsiFile(document);
  final int offset=editor.getCaretModel().getOffset();
  PsiElement elementAtCaret=file.findElementAt(offset);
  if (elementAtCaret == null)   return;
  fqn=fqn.replace('#','.');
  String toInsert;
  String suffix="";
  PsiElement elementToInsert=targetElement;
  if (targetElement instanceof PsiMethod && PsiUtil.isInsideJavadocComment(elementAtCaret)) {
    PsiMethod method=(PsiMethod)targetElement;
    PsiClass aClass=method.getContainingClass();
    String className=aClass == null ? "" : aClass.getQualifiedName();
    toInsert=className == null ? "" : className;
    if (toInsert.length() != 0)     toInsert+="#";
    toInsert+=method.getName() + "(";
    PsiParameter[] parameters=method.getParameterList().getParameters();
    for (int i=0; i < parameters.length; i++) {
      PsiParameter parameter=parameters[i];
      if (i != 0)       toInsert+=", ";
      toInsert+=parameter.getType().getCanonicalText();
    }
    toInsert+=")";
  }
 else   if (targetElement == null || PsiTreeUtil.getNonStrictParentOfType(elementAtCaret,PsiLiteralExpression.class,PsiComment.class) != null || PsiTreeUtil.getNonStrictParentOfType(elementAtCaret,PsiJavaFile.class) == null) {
    toInsert=fqn;
  }
 else {
    toInsert=targetElement.getName();
    if (targetElement instanceof PsiMethod) {
      suffix="()";
      if (((PsiMethod)targetElement).isConstructor()) {
        targetElement=targetElement.getContainingClass();
      }
    }
 else     if (targetElement instanceof PsiClass && isAfterNew(file,elementAtCaret)) {
      suffix="()";
    }
    final PsiElementFactory factory=JavaPsiFacade.getInstance(project).getElementFactory();
    final PsiExpression expression=factory.createExpressionFromText(toInsert + suffix,elementAtCaret);
    final PsiReferenceExpression referenceExpression=expression instanceof PsiMethodCallExpression ? ((PsiMethodCallExpression)expression).getMethodExpression() : expression instanceof PsiReferenceExpression ? (PsiReferenceExpression)expression : null;
    if (referenceExpression == null) {
      toInsert=fqn;
    }
 else     if (referenceExpression.advancedResolve(true).getElement() != targetElement) {
      try {
        referenceExpression.bindToElement(targetElement);
      }
 catch (      IncorrectOperationException e) {
      }
      if (referenceExpression.advancedResolve(true).getElement() != targetElement) {
        toInsert=fqn;
      }
    }
  }
  if (toInsert == null)   toInsert="";
  document.insertString(offset,toInsert + suffix);
  documentManager.commitAllDocuments();
  int endOffset=offset + toInsert.length() + suffix.length();
  RangeMarker rangeMarker=document.createRangeMarker(endOffset,endOffset);
  elementAtCaret=file.findElementAt(offset);
  if (elementAtCaret != null && elementAtCaret.isValid()) {
    shortenReference(elementAtCaret,targetElement);
  }
  CodeInsightUtil.forcePsiPostprocessAndRestoreElement(file);
  CodeStyleManager.getInstance(project).adjustLineIndent(file,offset);
  int caretOffset=rangeMarker.getEndOffset();
  if (elementToInsert instanceof PsiMethod && ((PsiMethod)elementToInsert).getParameterList().getParametersCount() != 0 && StringUtil.endsWithChar(suffix,')')) {
    caretOffset--;
  }
  editor.getCaretModel().moveToOffset(caretOffset);
}
