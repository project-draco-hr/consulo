{
  final AbstractVcs vcs=ProjectLevelVcsManager.getInstance(project).findVcsByName(vcsKey.getName());
  if (vcs == null)   return;
  if (!isInLocalFSHack(virtualFile) && !canPresentNonLocal(project,vcsKey,virtualFile))   return;
  final String title=VcsBundle.message("paths.affected.in.revision",revision instanceof ShortVcsRevisionNumber ? ((ShortVcsRevisionNumber)revision).toShortString() : revision.asString());
  final CommittedChangeList[] list=new CommittedChangeList[1];
  final VcsException[] exc=new VcsException[1];
  ProgressManager.getInstance().run(new Task.Backgroundable(project,title,true,BackgroundFromStartOption.getInstance()){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      try {
        final CommittedChangesProvider provider=vcs.getCommittedChangesProvider();
        if (isInLocalFSHack(virtualFile)) {
          final Pair<CommittedChangeList,FilePath> pair=provider.getOneList(virtualFile,revision);
          if (pair != null) {
            list[0]=pair.getFirst();
          }
        }
 else {
          if (location != null) {
            final ChangeBrowserSettings settings=provider.createDefaultSettings();
            settings.USE_CHANGE_BEFORE_FILTER=true;
            settings.CHANGE_BEFORE=revision.asString();
            final List<CommittedChangeList> changes=provider.getCommittedChanges(settings,location,1);
            if (changes != null && changes.size() == 1) {
              list[0]=changes.get(0);
            }
            return;
          }
 else {
            final RepositoryLocation local=provider.getForNonLocal(virtualFile);
            if (local != null) {
              final String number=revision.asString();
              final ChangeBrowserSettings settings=provider.createDefaultSettings();
              final List<CommittedChangeList> changes=provider.getCommittedChanges(settings,local,provider.getUnlimitedCountValue());
              if (changes != null) {
                for (                CommittedChangeList change : changes) {
                  if (number.equals(String.valueOf(change.getNumber()))) {
                    list[0]=change;
                  }
                }
              }
            }
          }
        }
      }
 catch (      VcsException e) {
        exc[0]=e;
      }
    }
    @Override public void onSuccess(){
      final AbstractVcsHelper instance=AbstractVcsHelper.getInstance(project);
      if (exc[0] != null) {
        instance.showError(exc[0],failedText(virtualFile,revision));
      }
 else       if (list[0] == null) {
        Messages.showErrorDialog(project,failedText(virtualFile,revision),getTitle());
      }
 else {
        instance.showChangesListBrowser(list[0],virtualFile,title);
      }
    }
  }
);
}
