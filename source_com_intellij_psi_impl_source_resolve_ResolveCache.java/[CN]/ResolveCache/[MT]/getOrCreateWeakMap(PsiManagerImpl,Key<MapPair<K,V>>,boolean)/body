{
  MapPair<K,V> pair=manager.getUserData(key);
  if (pair == null) {
    pair=new MapPair<K,V>();
    manager.putUserData(key,pair);
    final MapPair<K,V> _pair=pair;
    manager.registerRunnableToRunOnChange(new Runnable(){
      public void run(){
synchronized (PsiLock.LOCK) {
          myClearCount++;
          _pair.physicalMap.clear();
        }
      }
    }
);
    manager.registerRunnableToRunOnAnyChange(new Runnable(){
      public void run(){
synchronized (PsiLock.LOCK) {
          myClearCount++;
          _pair.nonPhysicalMap.clear();
        }
      }
    }
);
  }
  return forPhysical ? pair.physicalMap : pair.nonPhysicalMap;
}
