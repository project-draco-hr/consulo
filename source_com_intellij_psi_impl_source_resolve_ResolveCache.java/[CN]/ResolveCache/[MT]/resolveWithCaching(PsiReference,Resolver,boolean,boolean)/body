{
  ProgressManager.getInstance().checkCanceled();
  boolean physical=ref.getElement().isPhysical();
  final Reference<PsiElement> cached=getCachedResolve(ref,physical,incompleteCode);
  if (cached != null)   return cached.get();
  if (incompleteCode) {
    final PsiElement results=resolveWithCaching(ref,resolver,needToPreventRecursion,false);
    if (results != null) {
      setCachedResolve(ref,results,physical,true);
      return results;
    }
  }
  if (!lockElement(ref,needToPreventRecursion))   return null;
  PsiElement result=null;
  try {
    result=resolver.resolve(ref,incompleteCode);
  }
  finally {
    unlockElement(ref,needToPreventRecursion);
  }
  setCachedResolve(ref,result,physical,incompleteCode);
  return result;
}
