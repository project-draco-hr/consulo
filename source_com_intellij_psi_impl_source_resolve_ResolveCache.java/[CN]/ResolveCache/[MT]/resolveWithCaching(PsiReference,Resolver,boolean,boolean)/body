{
  ProgressManager.getInstance().checkCanceled();
synchronized (PsiLock.LOCK) {
    boolean physical=ref.getElement().isPhysical();
    final Reference<PsiElement> cached=getCachedResolve(ref,physical,incompleteCode);
    if (cached != null)     return cached.get();
    ;
    if (incompleteCode) {
      final PsiElement results=resolveWithCaching(ref,resolver,needToPreventRecursion,false);
      if (results != null) {
        setCachedResolve(ref,results,physical,true);
        return results;
      }
    }
    if (needToPreventRecursion) {
      PsiElement element=ref.getElement();
      if (element.getUserData(IS_BEING_RESOLVED_KEY) != null)       return null;
      element.putUserData(IS_BEING_RESOLVED_KEY,"");
    }
    final PsiElement result=resolver.resolve(ref,incompleteCode);
    if (needToPreventRecursion) {
      PsiElement element=ref.getElement();
      element.putUserData(IS_BEING_RESOLVED_KEY,null);
    }
    setCachedResolve(ref,result,physical,incompleteCode);
    return result;
  }
}
