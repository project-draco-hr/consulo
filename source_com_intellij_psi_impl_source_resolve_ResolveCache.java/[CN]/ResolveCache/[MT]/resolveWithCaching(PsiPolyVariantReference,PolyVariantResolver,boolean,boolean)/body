{
  ProgressManager.getInstance().checkCanceled();
  boolean physical=ref.getElement().isPhysical();
  final ResolveResult[] cached=getCachedPolyVariantResolve(ref,physical,incompleteCode);
  if (cached != null)   return cached;
  if (incompleteCode) {
    final ResolveResult[] results=resolveWithCaching(ref,resolver,needToPreventRecursion,false);
    if (results != null && results.length > 0) {
      setCachedPolyVariantResolve(ref,results,physical,true);
      return results;
    }
  }
  if (!lockElement(ref,needToPreventRecursion))   return JavaResolveResult.EMPTY_ARRAY;
  ResolveResult[] result;
  try {
    result=resolver.resolve(ref,incompleteCode);
  }
  finally {
    unlockElement(ref,needToPreventRecursion);
  }
  setCachedPolyVariantResolve(ref,result,physical,incompleteCode);
  return result;
}
