{
  ProgressManager.getInstance().checkCanceled();
synchronized (PsiLock.LOCK) {
    boolean physical=ref.getElement().isPhysical();
    final ResolveResult[] cached=getCachedPolyVariantResolve(ref,physical,incompleteCode);
    if (cached != null)     return cached;
    if (incompleteCode) {
      final ResolveResult[] results=resolveWithCaching(ref,resolver,needToPreventRecursion,false);
      if (results != null && results.length > 0) {
        setCachedPolyVariantResolve(ref,results,physical,true);
        return results;
      }
    }
    if (needToPreventRecursion) {
      PsiElement element=ref.getElement();
      if (element.getUserData(IS_BEING_RESOLVED_KEY) != null)       return JavaResolveResult.EMPTY_ARRAY;
      element.putUserData(IS_BEING_RESOLVED_KEY,"");
    }
    final ResolveResult[] result=resolver.resolve(ref,incompleteCode);
    if (needToPreventRecursion) {
      PsiElement element=ref.getElement();
      element.putUserData(IS_BEING_RESOLVED_KEY,null);
    }
    setCachedPolyVariantResolve(ref,result,physical,incompleteCode);
    return result;
  }
}
