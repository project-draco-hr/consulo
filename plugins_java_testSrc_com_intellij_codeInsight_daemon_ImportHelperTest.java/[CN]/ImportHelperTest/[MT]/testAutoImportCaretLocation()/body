{
  boolean old=CodeInsightSettings.getInstance().ADD_UNAMBIGIOUS_IMPORTS_ON_THE_FLY;
  try {
    CodeInsightSettings.getInstance().ADD_UNAMBIGIOUS_IMPORTS_ON_THE_FLY=true;
    configureByText(StdFileTypes.JAVA,"class X { ArrayList<caret> c; }");
    ((UndoManagerImpl)UndoManager.getInstance(getProject())).flushCurrentCommandMerger();
    ((UndoManagerImpl)UndoManager.getInstance(getProject())).clearUndoRedoQueueInTests(getFile().getVirtualFile());
    type(" ");
    backspace();
    assertOneElement(highlightErrors());
    int offset=myEditor.getCaretModel().getOffset();
    PsiReference ref=myFile.findReferenceAt(offset - 1);
    assertTrue(ref instanceof PsiJavaCodeReferenceElement);
    ImportClassFixBase.Result result=new ImportClassFix((PsiJavaCodeReferenceElement)ref).doFix(getEditor(),true,false);
    assertEquals(ImportClassFixBase.Result.POPUP_NOT_SHOWN,result);
    UIUtil.dispatchAllInvocationEvents();
    myEditor.getCaretModel().moveToOffset(offset - 1);
    result=new ImportClassFix((PsiJavaCodeReferenceElement)ref).doFix(getEditor(),true,false);
    assertEquals(ImportClassFixBase.Result.CLASS_AUTO_IMPORTED,result);
    UIUtil.dispatchAllInvocationEvents();
    assertEmpty(highlightErrors());
  }
  finally {
    CodeInsightSettings.getInstance().ADD_UNAMBIGIOUS_IMPORTS_ON_THE_FLY=old;
  }
}
