{
  assert released;
  released=false;
  boolean success=true;
  RefCountHolder refCountHolder;
  if (updateWholeFile) {
    Project project=file.getProject();
    DaemonCodeAnalyzer daemonCodeAnalyzer=DaemonCodeAnalyzer.getInstance(project);
    FileStatusMap fileStatusMap=((DaemonCodeAnalyzerImpl)daemonCodeAnalyzer).getFileStatusMap();
    refCountHolder=RefCountHolder.getInstance(file);
    success=refCountHolder.startAnalyzing();
    if (success) {
      Document document=PsiDocumentManager.getInstance(project).getDocument(file);
      TextRange fileRange=file.getTextRange();
      TextRange dirtyScope=document == null ? fileRange : fileStatusMap.getFileDirtyScope(document,Pass.UPDATE_ALL);
      if (dirtyScope != null) {
        if (dirtyScope.equals(fileRange)) {
          refCountHolder.clear();
        }
 else {
          refCountHolder.removeInvalidRefs();
        }
      }
    }
  }
 else {
    refCountHolder=null;
  }
  myRefCountHolder=refCountHolder;
  return success;
}
