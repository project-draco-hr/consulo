{
  assert released;
  released=false;
  boolean success=true;
  RefCountHolder refCountHolder;
  if (updateWholeFile) {
    Project project=file.getProject();
    DaemonCodeAnalyzer daemonCodeAnalyzer=DaemonCodeAnalyzer.getInstance(project);
    FileStatusMap fileStatusMap=((DaemonCodeAnalyzerImpl)daemonCodeAnalyzer).getFileStatusMap();
    refCountHolder=RefCountHolder.getInstance(file);
    success=refCountHolder.startAnalyzing();
    Document document=PsiDocumentManager.getInstance(project).getDocument(file);
    PsiElement dirtyScope=document == null ? file : fileStatusMap.getFileDirtyScope(document,Pass.UPDATE_ALL);
    if (dirtyScope != null) {
      if (dirtyScope instanceof PsiFile) {
        refCountHolder.clear();
      }
 else {
        refCountHolder.removeInvalidRefs();
      }
    }
  }
 else {
    refCountHolder=null;
  }
  myRefCountHolder=refCountHolder;
  myXmlVisitor.setRefCountHolder(refCountHolder);
  return success;
}
