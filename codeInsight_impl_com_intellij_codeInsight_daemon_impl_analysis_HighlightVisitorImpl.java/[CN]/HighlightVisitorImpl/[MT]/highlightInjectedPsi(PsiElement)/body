{
  if (!(element instanceof PsiLanguageInjectionHost)) {
    return false;
  }
  PsiLanguageInjectionHost injectionHost=(PsiLanguageInjectionHost)element;
  List<Pair<PsiElement,TextRange>> injected=injectionHost.getInjectedPsi();
  if (injected == null)   return false;
  PsiDocumentManager documentManager=PsiDocumentManager.getInstance(element.getProject());
  for (  Pair<PsiElement,TextRange> pair : injected) {
    PsiElement injectedPsi=pair.getFirst();
    final DocumentRange documentRange=(DocumentRange)documentManager.getDocument((PsiFile)injectedPsi);
    Language injectedLanguage=injectedPsi.getLanguage();
    VirtualFile virtualFile=element.getContainingFile().getVirtualFile();
    SyntaxHighlighter syntaxHighlighter=injectedLanguage.getSyntaxHighlighter(element.getProject(),virtualFile);
    final Annotator languageAnnotator=injectedLanguage.getAnnotator();
    final SyntaxHighlighterAsAnnotator syntaxAnnotator=new SyntaxHighlighterAsAnnotator(syntaxHighlighter);
    PsiRecursiveElementVisitor visitor=new PsiRecursiveElementVisitor(){
      final AnnotationHolderImpl fixingAnnotationHolder=new AnnotationHolderImpl(){
        protected Annotation createAnnotation(        TextRange range,        HighlightSeverity severity,        String message){
          if (!documentRange.isEditable(range))           return null;
          TextRange patched=new TextRange(documentRange.injectedToHost(range.getStartOffset()),documentRange.injectedToHost(range.getEndOffset()));
          Annotation annotation=super.createAnnotation(patched,severity,message);
          myAnnotationHolder.add(annotation);
          return annotation;
        }
      }
;
      public void visitElement(      PsiElement element){
        super.visitElement(element);
        syntaxAnnotator.annotate(element,fixingAnnotationHolder);
        if (languageAnnotator != null) {
          languageAnnotator.annotate(element,fixingAnnotationHolder);
        }
      }
      public void visitErrorElement(      PsiErrorElement element){
        HighlightInfo info=createErrorElementInfo(element);
        HighlightInfo fixed=new HighlightInfo(HighlightInfoType.ERROR,documentRange.injectedToHost(info.startOffset),documentRange.injectedToHost(info.endOffset),info.description,info.toolTip);
        myHolder.add(fixed);
      }
    }
;
    injectedPsi.accept(visitor);
  }
  return true;
}
