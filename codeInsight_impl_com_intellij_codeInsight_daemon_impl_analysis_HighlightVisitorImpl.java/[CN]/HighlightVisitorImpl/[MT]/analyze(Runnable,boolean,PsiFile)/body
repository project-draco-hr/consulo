{
  myFile=file;
  assert released;
  released=false;
  boolean success=true;
  try {
    if (updateWholeFile) {
      Project project=file.getProject();
      DaemonCodeAnalyzer daemonCodeAnalyzer=DaemonCodeAnalyzer.getInstance(project);
      FileStatusMap fileStatusMap=((DaemonCodeAnalyzerImpl)daemonCodeAnalyzer).getFileStatusMap();
      RefCountHolder refCountHolder=RefCountHolder.getInstance(file);
      myRefCountHolder=refCountHolder;
      Document document=PsiDocumentManager.getInstance(project).getDocument(file);
      TextRange fileRange=file.getTextRange();
      TextRange dirtyScope=document == null ? fileRange : fileStatusMap.getFileDirtyScope(document,Pass.UPDATE_ALL);
      success=refCountHolder.analyze(action,dirtyScope,file);
    }
 else {
      myRefCountHolder=null;
      action.run();
    }
  }
  finally {
    myUninitializedVarProblems.clear();
    myFinalVarProblems.clear();
    mySingleImportedClasses.clear();
    mySingleImportedFields.clear();
    myParameterIsReassigned.clear();
    myRefCountHolder=null;
    myFile=null;
    released=true;
    myHolder=null;
  }
  return success;
}
