{
  final Application app=ApplicationManager.getApplication();
  final IdeaPluginDescriptor plugin=app.getPlugin(pluginId);
  @NonNls final String resBundleName=plugin != null ? plugin.getResourceBundleBaseName() : ACTIONS_BUNDLE;
  ResourceBundle bundle=null;
  if (resBundleName != null) {
    bundle=ResourceBundle.getBundle(resBundleName,Locale.getDefault(),loader);
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("enter: processActionElement(" + element.getName() + ")");
  }
  if (!ACTION_ELEMENT_NAME.equals(element.getName())) {
    LOG.error("unexpected name of element \"" + element.getName() + "\"");
    return null;
  }
  String className=element.getAttributeValue(CLASS_ATTR_NAME);
  if (className == null || className.length() == 0) {
    LOG.error("action element should have specified \"class\" attribute");
    return null;
  }
  String id=element.getAttributeValue(ID_ATTR_NAME);
  if (id == null || id.length() == 0) {
    LOG.error("ID of the action cannot be an empty string");
    return null;
  }
  if (Boolean.valueOf(element.getAttributeValue(INTERNAL_ATTR_NAME)).booleanValue() && !ApplicationManagerEx.getApplicationEx().isInternal()) {
    myNotRegisteredInternalActionIds.add(id);
    return null;
  }
  String text=loadTextForElement(element,bundle,id,ACTION_ELEMENT_NAME);
  if (text == null) {
    LOG.error("'text' attribute is mandatory (action ID=" + id + ")");
    return null;
  }
  ActionStub stub=new ActionStub(className,id,text,loader);
  Presentation presentation=stub.getTemplatePresentation();
  presentation.setText(text);
  presentation.setDescription(loadDescriptionForElement(element,bundle,id,ACTION_ELEMENT_NAME));
  String iconPath=element.getAttributeValue(ICON_ATTR_NAME);
  if (iconPath != null) {
    try {
      final Class actionClass=Class.forName(className,true,loader);
      presentation.setIcon(IconLoader.getIcon(iconPath,actionClass));
    }
 catch (    ClassNotFoundException ignored) {
    }
  }
  for (  final Object o : element.getChildren()) {
    Element e=(Element)o;
    if (ADD_TO_GROUP_ELEMENT_NAME.equals(e.getName())) {
      processAddToGroupNode(stub,e);
    }
 else     if (SHORTCUT_ELEMENT_NAME.equals(e.getName())) {
      processKeyboardShortcutNode(e,id);
    }
 else     if (MOUSE_SHORTCUT_ELEMENT_NAME.equals(e.getName())) {
      processMouseShortcutNode(e,id);
    }
 else {
      LOG.error("unexpected name of element \"" + e.getName() + "\"");
      return null;
    }
  }
  if (element.getAttributeValue(USE_SHORTCUT_OF_ATTR_NAME) != null) {
    ((KeymapManagerEx)myKeymapManager).bindShortcuts(element.getAttributeValue(USE_SHORTCUT_OF_ATTR_NAME),id);
  }
  registerAction(id,stub,pluginId);
  return stub;
}
