{
  myOneSide=fragmentedContent.isOneSide();
  myIsAddition=fragmentedContent.isAddition();
  List<BeforeAfter<TextRange>> expandedRanges=expand(fragmentedContent.getRanges(),VcsConfiguration.getInstance(myProject).SHORT_DIFF_EXTRA_LINES,fragmentedContent.getBefore(),fragmentedContent.getAfter());
  BeforeAfter<Integer> lines=new BeforeAfter<Integer>(0,0);
  for (  BeforeAfter<TextRange> lineNumbers : expandedRanges) {
    if (lines.getBefore() > 0 || lines.getAfter() > 0) {
      oldConvertor.emptyLine(lines.getBefore());
      newConvertor.emptyLine(lines.getAfter());
      lines=new BeforeAfter<Integer>(lines.getBefore() + 1,lines.getAfter() + 1);
      sbOld.append('\n');
      sbNew.append('\n');
    }
    myLineRanges.add(lines);
    oldConvertor.put(lines.getBefore(),lineNumbers.getBefore().getStartOffset());
    newConvertor.put(lines.getAfter(),lineNumbers.getAfter().getStartOffset());
    final Document document=fragmentedContent.getBefore();
    if (sbOld.length() > 0) {
      sbOld.append('\n');
    }
    final TextRange beforeRange=new TextRange(document.getLineStartOffset(lineNumbers.getBefore().getStartOffset()),document.getLineEndOffset(lineNumbers.getBefore().getEndOffset()));
    myBeforeFragments.add(beforeRange);
    sbOld.append(document.getText(beforeRange));
    final Document document1=fragmentedContent.getAfter();
    if (sbNew.length() > 0) {
      sbNew.append('\n');
    }
    final TextRange afterRange=new TextRange(document1.getLineStartOffset(lineNumbers.getAfter().getStartOffset()),document1.getLineEndOffset(lineNumbers.getAfter().getEndOffset()));
    myAfterFragments.add(afterRange);
    sbNew.append(document1.getText(afterRange));
    int before=lines.getBefore() + lineNumbers.getBefore().getEndOffset() - lineNumbers.getBefore().getStartOffset() + 1;
    int after=lines.getAfter() + lineNumbers.getAfter().getEndOffset() - lineNumbers.getAfter().getStartOffset() + 1;
    lines=new BeforeAfter<Integer>(before,after);
  }
  myLineRanges.add(new BeforeAfter<Integer>(lines.getBefore() == 0 ? 0 : lines.getBefore() - 1,lines.getAfter() == 0 ? 0 : lines.getAfter() - 1));
  setHighlighters(fragmentedContent.getBefore(),fragmentedContent.getAfter(),expandedRanges);
  setTodoHighlighting(fragmentedContent.getBefore(),fragmentedContent.getAfter());
}
