{
  if (myStorages.get(key) == null) {
    final StateStorage stateStorage=createStateStorage(storageSpec);
    if (stateStorage instanceof FileBasedStorage) {
      String filePath=((FileBasedStorage)stateStorage).getFilePath();
      if (myPathToStorage.containsKey(filePath)) {
        StateStorage existing=myPathToStorage.get(filePath);
        myStorages.put(key,existing);
      }
 else {
        myStorages.put(key,stateStorage);
      }
    }
 else {
      if (stateStorage == null)       return null;
      myStorages.put(key,stateStorage);
    }
  }
  return myStorages.get(key);
}
