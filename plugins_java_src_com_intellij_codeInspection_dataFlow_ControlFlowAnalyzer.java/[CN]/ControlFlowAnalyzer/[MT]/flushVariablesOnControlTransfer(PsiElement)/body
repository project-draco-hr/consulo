{
  for (int i=myElementStack.size() - 1; i >= 0; i--) {
    PsiElement scope=myElementStack.get(i);
    if (PsiTreeUtil.isAncestor(scope,stopWhenAncestorOf,true)) {
      break;
    }
    if (scope instanceof PsiCodeBlock) {
      flushCodeBlockVariables((PsiCodeBlock)scope);
      if (scope.getParent() instanceof PsiTryStatement && scope == ((PsiTryStatement)scope.getParent()).getFinallyBlock()) {
        addInstruction(new PopOffsetInstruction());
      }
    }
  }
}
