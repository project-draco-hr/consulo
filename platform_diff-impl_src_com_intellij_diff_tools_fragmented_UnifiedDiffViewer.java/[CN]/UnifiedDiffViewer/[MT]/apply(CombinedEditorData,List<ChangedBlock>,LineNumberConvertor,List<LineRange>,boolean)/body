{
  return new Runnable(){
    @Override public void run(){
      myFoldingModel.updateContext(myRequest,getFoldingModelSettings());
      clearDiffPresentation();
      if (isContentsEqual)       myPanel.addNotification(DiffNotifications.createEqualContents());
      TIntFunction separatorLines=myFoldingModel.getLineNumberConvertor();
      myEditor.getGutterComponentEx().setLineNumberConvertor(mergeConverters(data.getLineConvertor1(),separatorLines),mergeConverters(data.getLineConvertor2(),separatorLines));
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          myDuringOnesideDocumentModification=true;
          try {
            myDocument.setText(data.getText());
          }
  finally {
            myDuringOnesideDocumentModification=false;
          }
        }
      }
);
      if (data.getHighlighter() != null)       myEditor.setHighlighter(data.getHighlighter());
      DiffUtil.setEditorCodeStyle(myProject,myEditor,data.getFileType());
      if (data.getRangeHighlighter() != null)       data.getRangeHighlighter().apply(myProject,myDocument);
      ArrayList<UnifiedDiffChange> diffChanges=new ArrayList<UnifiedDiffChange>(blocks.size());
      for (      ChangedBlock block : blocks) {
        diffChanges.add(new UnifiedDiffChange(UnifiedDiffViewer.this,block));
      }
      List<RangeMarker> guarderRangeBlocks=new ArrayList<RangeMarker>();
      if (!myEditor.isViewer()) {
        for (        ChangedBlock block : blocks) {
          LineRange range=myMasterSide.select(block.getRange2(),block.getRange1());
          TextRange textRange=DiffUtil.getLinesRange(myDocument,range.start,range.end);
          if (textRange.isEmpty())           continue;
          guarderRangeBlocks.add(createGuardedBlock(textRange.getStartOffset(),textRange.getEndOffset()));
        }
        int textLength=myDocument.getTextLength();
        guarderRangeBlocks.add(createGuardedBlock(textLength,textLength));
      }
      myChangedBlockData=new ChangedBlockData(diffChanges,guarderRangeBlocks,convertor,isContentsEqual);
      myFoldingModel.install(changedLines,myRequest,getFoldingModelSettings());
      myInitialScrollHelper.onRediff();
      myStatusPanel.update();
      myPanel.setGoodContent();
    }
  }
;
}
