{
  final LookupElement currentItem=lookup.getCurrentItem();
  if (currentItem != null && charTyped != ' ' && charTyped != '*') {
    String postfix=lookup.getAdditionalPrefix() + charTyped;
    final PrefixMatcher matcher=currentItem.getPrefixMatcher();
    if (matcher.cloneWithPrefix(matcher.getPrefix() + postfix).prefixMatches(currentItem)) {
      return CharFilter.Result.ADD_TO_PREFIX;
    }
    for (    final LookupElement element : lookup.getItems()) {
      if (element.isPrefixMatched() && element.getPrefixMatcher().cloneWithPrefix(element.getPrefixMatcher().getPrefix() + postfix).prefixMatches(element)) {
        return CharFilter.Result.ADD_TO_PREFIX;
      }
    }
  }
  final CharFilter[] filters=Extensions.getExtensions(CharFilter.EP_NAME);
  for (  final CharFilter extension : filters) {
    final CharFilter.Result result=extension.acceptChar(charTyped,lookup.getMinPrefixLength() + lookup.getAdditionalPrefix().length(),lookup);
    if (result != null) {
      return result;
    }
  }
  throw new AssertionError("Typed char not handler by char filter: c=" + charTyped + "; prefix="+ currentItem+ "; filters="+ Arrays.toString(filters));
}
