{
  FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_FINISH_BY_DOT_ETC);
  final boolean charInserted=!editor.getSelectionModel().hasSelection() && !editor.getSelectionModel().hasBlockSelection();
  final Runnable restore=CodeCompletionHandlerBase.rememberDocumentState(editor);
  if (charInserted) {
    CommandProcessor.getInstance().executeCommand(editor.getProject(),new Runnable(){
      @Override public void run(){
        lookup.performGuardedChange(new Runnable(){
          public void run(){
            EditorModificationUtil.typeInStringAtCaretHonorBlockSelection(editor,String.valueOf(charTyped),true);
          }
        }
);
      }
    }
,null,"Just insert the completion char");
  }
  inside=false;
  CommandProcessor.getInstance().executeCommand(editor.getProject(),new Runnable(){
    @Override public void run(){
      if (charInserted) {
        lookup.performGuardedChange(restore);
      }
      lookup.finishLookup(charTyped);
    }
  }
,null,"Undo inserting the completion char and select the item");
}
