{
  LOG.assertTrue(!(param instanceof PsiEllipsisType));
  if (param instanceof PsiArrayType && arg instanceof PsiArrayType) {
    return getSubstitutionForTypeParameterConstraint(typeParam,((PsiArrayType)param).getComponentType(),((PsiArrayType)arg).getComponentType(),isContraVariantPosition);
  }
  if (param instanceof PsiClassType) {
    PsiManager manager=typeParam.getManager();
    if (arg instanceof PsiPrimitiveType) {
      arg=((PsiPrimitiveType)arg).getBoxedType(manager,typeParam.getResolveScope());
      if (arg == null)       return null;
    }
    JavaResolveResult paramResult=((PsiClassType)param).resolveGenerics();
    PsiClass paramClass=(PsiClass)paramResult.getElement();
    if (typeParam == paramClass) {
      return arg == null || arg.getDeepComponentType() instanceof PsiPrimitiveType || PsiUtil.resolveClassInType(arg) != null ? new Pair<PsiType,ConstraintType>(arg,ConstraintType.SUPERTYPE) : null;
    }
    if (paramClass == null)     return null;
    if (arg instanceof PsiClassType) {
      JavaResolveResult argResult=((PsiClassType)arg).resolveGenerics();
      PsiClass argClass=(PsiClass)argResult.getElement();
      if (argClass == null)       return null;
      PsiElementFactory factory=manager.getElementFactory();
      PsiType patternType=factory.createType(typeParam);
      if (isContraVariantPosition) {
        PsiSubstitutor substitutor=TypeConversionUtil.getClassSubstitutor(paramClass,argClass,argResult.getSubstitutor());
        if (substitutor == null)         return null;
        arg=factory.createType(paramClass,substitutor);
      }
 else {
        PsiSubstitutor substitutor=TypeConversionUtil.getClassSubstitutor(argClass,paramClass,paramResult.getSubstitutor());
        if (substitutor == null)         return null;
        param=factory.createType(argClass,substitutor);
      }
      return getSubstitutionForTypeParameterInner(param,arg,patternType,ConstraintType.SUPERTYPE);
    }
  }
  return null;
}
