{
  LOG.assertTrue(!(param instanceof PsiEllipsisType));
  if (param instanceof PsiArrayType && arg instanceof PsiArrayType) {
    return getSubstitutionForTypeParameter(typeParam,((PsiArrayType)param).getComponentType(),((PsiArrayType)arg).getComponentType(),isContraVariantPosition);
  }
  if (param instanceof PsiClassType) {
    PsiManager manager=typeParam.getManager();
    if (arg instanceof PsiPrimitiveType) {
      arg=((PsiPrimitiveType)arg).getBoxedType(manager,typeParam.getResolveScope());
      if (arg == null)       return PsiType.NULL;
    }
    ResolveResult paramResult=((PsiClassType)param).resolveGenerics();
    PsiClass paramClass=(PsiClass)paramResult.getElement();
    if (typeParam == paramClass) {
      return arg == null || arg.getDeepComponentType() instanceof PsiPrimitiveType || PsiUtil.resolveClassInType(arg) != null ? arg : PsiType.NULL;
    }
    if (paramClass == null)     return PsiType.NULL;
    if (arg instanceof PsiClassType) {
      ResolveResult argResult=((PsiClassType)arg).resolveGenerics();
      PsiClass argClass=(PsiClass)argResult.getElement();
      if (argClass == null)       return PsiType.NULL;
      PsiElementFactory factory=manager.getElementFactory();
      PsiType patternType=factory.createType(typeParam);
      if (isContraVariantPosition) {
        PsiSubstitutor substitutor=TypeConversionUtil.getClassSubstitutor(paramClass,argClass,argResult.getSubstitutor());
        if (substitutor == null)         return PsiType.NULL;
        arg=factory.createType(paramClass,substitutor);
      }
 else {
        PsiSubstitutor substitutor=TypeConversionUtil.getClassSubstitutor(argClass,paramClass,paramResult.getSubstitutor());
        if (substitutor == null)         return PsiType.NULL;
        param=factory.createType(argClass,substitutor);
      }
      PsiType substitution=getSubstitutionForTypeParameterInner(param,arg,patternType,false);
      return substitution != PsiType.NULL ? substitution : getSubstitutionForTypeParameterInner(param,arg,patternType,true);
    }
  }
  return PsiType.NULL;
}
