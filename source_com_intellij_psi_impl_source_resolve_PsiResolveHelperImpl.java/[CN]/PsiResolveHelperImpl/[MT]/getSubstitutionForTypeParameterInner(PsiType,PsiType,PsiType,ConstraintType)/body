{
  if (arg instanceof PsiCapturedWildcardType)   arg=((PsiCapturedWildcardType)arg).getWildcard();
  if (patternType.equals(param)) {
    return processArgType(arg,constraintType);
  }
  if (param instanceof PsiWildcardType) {
    final PsiWildcardType wildcardParam=(PsiWildcardType)param;
    final PsiType paramBound=wildcardParam.getBound();
    if (paramBound == null)     return null;
    ConstraintType constrType=wildcardParam.isExtends() ? ConstraintType.SUPERTYPE : ConstraintType.SUBTYPE;
    if (arg instanceof PsiWildcardType) {
      if (((PsiWildcardType)arg).isExtends() == wildcardParam.isExtends()) {
        Pair<PsiType,ConstraintType> res=getSubstitutionForTypeParameterInner(paramBound,((PsiWildcardType)arg).getBound(),patternType,constrType);
        if (res != null)         return res;
      }
    }
 else     if (patternType.equals(paramBound)) {
      Pair<PsiType,ConstraintType> res=getSubstitutionForTypeParameterInner(paramBound,arg,patternType,constrType);
      if (res != null)       return res;
    }
 else     if (paramBound instanceof PsiArrayType && arg instanceof PsiArrayType) {
      Pair<PsiType,ConstraintType> res=getSubstitutionForTypeParameterInner(((PsiArrayType)paramBound).getComponentType(),((PsiArrayType)arg).getComponentType(),patternType,constrType);
      if (res != null)       return res;
    }
 else     if (paramBound instanceof PsiClassType && arg instanceof PsiClassType) {
      final PsiClassType.ClassResolveResult boundResult=((PsiClassType)paramBound).resolveGenerics();
      final PsiClass boundClass=boundResult.getElement();
      if (boundClass != null) {
        final PsiClassType.ClassResolveResult argResult=((PsiClassType)arg).resolveGenerics();
        final PsiClass argClass=argResult.getElement();
        if (argClass != null) {
          if (wildcardParam.isExtends()) {
            PsiSubstitutor superSubstitutor=TypeConversionUtil.getClassSubstitutor(boundClass,argClass,argResult.getSubstitutor());
            if (superSubstitutor != null) {
              final Iterator<PsiTypeParameter> iterator=PsiUtil.typeParametersIterator(boundClass);
              while (iterator.hasNext()) {
                final PsiTypeParameter typeParameter=iterator.next();
                PsiType substituted=superSubstitutor.substitute(typeParameter);
                if (substituted != null) {
                  final Pair<PsiType,ConstraintType> res;
                  res=getSubstitutionForTypeParameterInner(boundResult.getSubstitutor().substitute(typeParameter),substituted,patternType,ConstraintType.EQUALS);
                  if (res != null)                   return res;
                }
              }
            }
          }
 else {
            PsiSubstitutor superSubstitutor=TypeConversionUtil.getClassSubstitutor(argClass,boundClass,boundResult.getSubstitutor());
            if (superSubstitutor != null) {
              final Iterator<PsiTypeParameter> iterator=PsiUtil.typeParametersIterator(argClass);
              while (iterator.hasNext()) {
                final PsiTypeParameter typeParameter=iterator.next();
                PsiType substituted=argResult.getSubstitutor().substitute(typeParameter);
                if (substituted != null) {
                  final Pair<PsiType,ConstraintType> res;
                  res=getSubstitutionForTypeParameterInner(superSubstitutor.substitute(typeParameter),substituted,patternType,ConstraintType.EQUALS);
                  if (res != null)                   return res;
                }
              }
            }
          }
        }
      }
    }
  }
  if (param instanceof PsiArrayType && arg instanceof PsiArrayType) {
    return getSubstitutionForTypeParameterInner(((PsiArrayType)param).getComponentType(),((PsiArrayType)arg).getComponentType(),patternType,constraintType);
  }
  if (param instanceof PsiClassType && arg instanceof PsiClassType) {
    PsiClass paramClass=((PsiClassType)param).resolve();
    if (paramClass == null)     return null;
    PsiClass argClass=((PsiClassType)arg).resolve();
    if (argClass != paramClass)     return null;
    PsiType[] paramTypes=((PsiClassType)param).getParameters();
    PsiType[] argTypes=((PsiClassType)arg).getParameters();
    if (paramTypes.length != argTypes.length)     return null;
    Pair<PsiType,ConstraintType> wildcardCaptured=null;
    for (int i=0; i < argTypes.length; i++) {
      final PsiType argType=argTypes[i];
      final PsiType paramType=paramTypes[i];
      Pair<PsiType,ConstraintType> res=getSubstitutionForTypeParameterInner(paramType,argType,patternType,ConstraintType.EQUALS);
      if (res != null) {
        PsiType type=res.getFirst();
        if (!(type instanceof PsiWildcardType))         return res;
        if (wildcardCaptured != null)         return null;
        if (argType instanceof PsiWildcardType || argType instanceof PsiCapturedWildcardType) {
          wildcardCaptured=res;
        }
      }
    }
    return wildcardCaptured;
  }
  return null;
}
