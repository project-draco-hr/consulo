{
  PsiSearchHelper helper=aPackage.getManager().getSearchHelper();
  PsiReference[] refs=helper.findReferences(aPackage,options.searchScope,false);
  HashSet<PsiFile> filesSet=new HashSet<PsiFile>();
  ArrayList<PsiFile> files=new ArrayList<PsiFile>();
  for (int i=0; i < refs.length; i++) {
    PsiElement ref=refs[i].getElement();
    PsiFile file=ref.getContainingFile();
    if (filesSet.add(file)) {
      files.add(file);
    }
  }
  ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.pushState();
  }
  ArrayList<PsiClass> classes=new ArrayList<PsiClass>();
  addClassesInPackage(aPackage,options.isIncludeSubpackages,classes);
  for (int i=0; i < classes.size(); i++) {
    PsiClass aClass=classes.get(i);
    if (progress != null) {
      StringBuffer buffer=new StringBuffer(100);
      buffer.append("Searching for references to class ");
      buffer.append(aClass.getName());
      buffer.append("...");
      progress.setText(buffer.toString());
    }
    for (int j=0; j < files.size(); j++) {
      ProgressManager.getInstance().checkCanceled();
      PsiFile file=files.get(j);
      refs=helper.findReferences(aClass,new LocalSearchScope(file),false);
      addResults(results,refs,options,aClass);
    }
  }
  if (progress != null) {
    progress.popState();
  }
}
