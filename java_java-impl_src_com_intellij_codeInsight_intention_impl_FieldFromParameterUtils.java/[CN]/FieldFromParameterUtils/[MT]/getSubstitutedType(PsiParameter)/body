{
  if (parameter == null)   return null;
  final PsiType type=getType(parameter);
  if (type instanceof PsiArrayType) {
    return type;
  }
  final PsiClassType.ClassResolveResult result=PsiUtil.resolveGenericsClassInType(type);
  final PsiClass psiClass=result.getElement();
  if (psiClass == null)   return type;
  final HashSet<PsiTypeParameter> usedTypeParameters=new HashSet<PsiTypeParameter>();
  RefactoringUtil.collectTypeParameters(usedTypeParameters,parameter);
  for (Iterator<PsiTypeParameter> iterator=usedTypeParameters.iterator(); iterator.hasNext(); ) {
    PsiTypeParameter usedTypeParameter=iterator.next();
    if (parameter.getDeclarationScope() != usedTypeParameter.getOwner()) {
      iterator.remove();
    }
  }
  final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(parameter.getProject());
  PsiSubstitutor subst=PsiSubstitutor.EMPTY;
  for (  PsiTypeParameter usedTypeParameter : usedTypeParameters) {
    subst=subst.put(usedTypeParameter,TypeConversionUtil.typeParameterErasure(usedTypeParameter));
  }
  PsiSubstitutor substitutor=PsiSubstitutor.EMPTY;
  final Map<PsiTypeParameter,PsiType> typeMap=result.getSubstitutor().getSubstitutionMap();
  for (  PsiTypeParameter typeParameter : typeMap.keySet()) {
    final PsiType psiType=typeMap.get(typeParameter);
    substitutor=substitutor.put(typeParameter,psiType != null ? subst.substitute(psiType) : null);
  }
  return psiClass instanceof PsiTypeParameter ? subst.substitute((PsiTypeParameter)psiClass) : elementFactory.createType(psiClass,substitutor);
}
