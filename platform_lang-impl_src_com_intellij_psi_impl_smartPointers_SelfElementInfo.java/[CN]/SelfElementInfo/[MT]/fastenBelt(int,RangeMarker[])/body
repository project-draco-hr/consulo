{
  if (!mySyncMarkerIsValid)   return;
  RangeMarker marker=getMarker();
  int actualEndOffset=marker == null || !marker.isValid() ? getSyncEndOffset() : marker.getEndOffset();
  if (offset > actualEndOffset) {
    return;
  }
  if (marker == null) {
    Document document=myVirtualFile == null ? null : FileDocumentManager.getInstance().getDocument(myVirtualFile);
    if (document == null) {
      mySyncMarkerIsValid=false;
      return;
    }
    int start=Math.min(getSyncStartOffset(),document.getTextLength());
    int end=Math.min(Math.max(getSyncEndOffset(),start),document.getTextLength());
    if (cachedRangeMarkers != null) {
      for (      RangeMarker cachedRangeMarker : cachedRangeMarkers) {
        if (cachedRangeMarker.isValid() && cachedRangeMarker.getStartOffset() == start && cachedRangeMarker.getEndOffset() == end) {
          marker=cachedRangeMarker;
          break;
        }
      }
    }
 else {
      marker=document.createRangeMarker(start,end,true);
    }
    setMarker(marker);
  }
 else   if (!marker.isValid()) {
    mySyncMarkerIsValid=false;
    marker.dispose();
    setMarker(null);
    marker=null;
  }
  myRangeMarker=marker;
}
