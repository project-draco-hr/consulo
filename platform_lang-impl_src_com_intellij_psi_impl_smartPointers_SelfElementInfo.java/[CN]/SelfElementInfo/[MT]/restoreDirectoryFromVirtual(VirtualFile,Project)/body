{
  if (virtualFile == null)   return null;
  return ApplicationManager.getApplication().runReadAction(new Computable<PsiDirectory>(){
    @Override public PsiDirectory compute(){
      VirtualFile child;
      if (virtualFile.isValid()) {
        child=virtualFile;
      }
 else {
        VirtualFile vParent=virtualFile.getParent();
        if (vParent == null || !vParent.isDirectory())         return null;
        String name=virtualFile.getName();
        child=vParent.findChild(name);
      }
      if (child == null || !child.isValid())       return null;
      PsiDirectory file=PsiManager.getInstance(project).findDirectory(child);
      if (file == null || !file.isValid())       return null;
      return file;
    }
  }
);
}
