{
  final Project[] project=new Project[]{p};
  ProjectReloadState.getInstance(project[0]).onBeforeAutomaticProjectReload();
  final Application application=ApplicationManager.getApplication();
  application.invokeLater(new Runnable(){
    public void run(){
      LOG.info("Reloading project.");
      ProjectImpl projectImpl=(ProjectImpl)project[0];
      IProjectStore projectStore=projectImpl.getStateStore();
      final String path=projectStore.getProjectFilePath();
      final List<VirtualFile> original=projectStore.getAllStorageFiles(true);
      if (project[0].isDisposed() || ProjectUtil.closeProject(project[0])) {
        application.runWriteAction(new Runnable(){
          public void run(){
            for (            final VirtualFile aOriginal : original) {
              restoreCopy(aOriginal);
            }
          }
        }
);
        project[0]=null;
        if (takeMemorySnapshot) {
          String outputFileName=ProfilingUtil.createDumpFileName(ApplicationInfo.getInstance().getBuildNumber());
          ProfilingUtil.forceCaptureMemorySnapshot();
        }
        ProjectUtil.openProject(path,null,true);
      }
    }
  }
,ModalityState.NON_MODAL);
}
