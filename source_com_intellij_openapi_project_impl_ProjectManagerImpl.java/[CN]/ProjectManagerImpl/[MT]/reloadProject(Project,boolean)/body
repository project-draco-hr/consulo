{
  final Project[] project=new Project[]{p};
  ProjectReloadState.getInstance(project[0]).onBeforeAutomaticProjectReload();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      LOG.info("Reloading project.");
      final String path=project[0].getProjectFilePath();
      final List<VirtualFile> original=getAllProjectFiles(project[0]);
      if (project[0].isDisposed() || ProjectUtil.closeProject(project[0])) {
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            for (            final VirtualFile aOriginal : original) {
              restoreCopy(aOriginal);
            }
          }
        }
);
        project[0]=null;
        if (takeMemorySnapshot) {
          String outputFileName=ProfilingUtil.createDumpFileName(ApplicationInfo.getInstance().getBuildNumber());
          ProfilingUtil.forceCaptureMemorySnapshot(outputFileName);
        }
        ProjectUtil.openProject(path,null,true);
      }
    }
  }
,ModalityState.NON_MODAL);
}
