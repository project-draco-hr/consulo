{
  virtualFileManager.addVirtualFileManagerListener(new VirtualFileManagerListener(){
    public void beforeRefreshStart(    boolean asynchonous){
      myIsInRefresh=true;
    }
    public void afterRefreshFinish(    boolean asynchonous){
      myIsInRefresh=false;
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          if (myChangedProjectFiles.size() > 0) {
            Set<Project> projects=myChangedProjectFiles.keySet();
            List<Project> projectsToReload=new ArrayList<Project>();
            for (            Project project : projects) {
              List<VirtualFile> causes=myChangedProjectFiles.get(project);
              Set<VirtualFile> liveCauses=new HashSet<VirtualFile>(causes);
              for (              VirtualFile cause : causes) {
                if (!cause.isValid())                 liveCauses.remove(cause);
              }
              if (!liveCauses.isEmpty()) {
                String message;
                if (liveCauses.size() == 1) {
                  message=ProjectBundle.message("project.reload.external.change.single",causes.get(0).getPresentableUrl());
                }
 else {
                  StringBuffer filesBuilder=new StringBuffer();
                  boolean first=true;
                  for (                  VirtualFile cause : liveCauses) {
                    if (!first)                     filesBuilder.append("\n");
                    first=false;
                    filesBuilder.append(cause.getPresentableUrl());
                  }
                  message=ProjectBundle.message("project.reload.external.change.multiple",filesBuilder.toString());
                }
                if (Messages.showYesNoDialog(project,message,ProjectBundle.message("project.reload.external.change.title"),Messages.getQuestionIcon()) == 0) {
                  projectsToReload.add(project);
                }
              }
              for (              final Project projectToReload : projectsToReload) {
                reloadProject(projectToReload);
              }
            }
            myChangedProjectFiles.clear();
          }
        }
      }
,ModalityState.NON_MMODAL);
    }
  }
);
  virtualFileManager.addVirtualFileListener(new VirtualFileAdapter(){
    public void contentsChanged(    VirtualFileEvent event){
      if (event.getRequestor() == null && myIsInRefresh) {
        saveChangedProjectFile(event.getFile());
      }
    }
  }
);
}
