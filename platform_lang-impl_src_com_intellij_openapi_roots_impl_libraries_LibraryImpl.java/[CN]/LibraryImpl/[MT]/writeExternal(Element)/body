{
  LOG.assertTrue(!isDisposed(),"Already disposed!");
  Element element=new Element(ELEMENT);
  if (myName != null) {
    element.setAttribute(LIBRARY_NAME_ATTR,myName);
  }
  if (myType != null) {
    element.setAttribute(LIBRARY_TYPE_ATTR,myType.getKind().getKindId());
    final Object state=myProperties.getState();
    if (state != null) {
      final Element propertiesElement=XmlSerializer.serialize(state,SERIALIZATION_FILTERS);
      if (propertiesElement != null && (!propertiesElement.getContent().isEmpty() || !propertiesElement.getAttributes().isEmpty())) {
        element.addContent(propertiesElement.setName(PROPERTIES_ELEMENT));
      }
    }
  }
  ArrayList<OrderRootType> storableRootTypes=new ArrayList<OrderRootType>();
  storableRootTypes.addAll(Arrays.asList(OrderRootType.getAllTypes()));
  if (myType != null) {
    storableRootTypes.addAll(Arrays.asList(myType.getAdditionalRootTypes()));
  }
  for (  OrderRootType rootType : sortRootTypes(storableRootTypes)) {
    final VirtualFilePointerContainer roots=myRoots.get(rootType);
    if (roots.size() == 0 && rootType.skipWriteIfEmpty())     continue;
    final Element rootTypeElement=new Element(rootType.name());
    roots.writeExternal(rootTypeElement,ROOT_PATH_ELEMENT);
    element.addContent(rootTypeElement);
  }
  final List<OrderRootType> rootTypes=sortRootTypes(myJarDirectories.getRootTypes());
  for (  OrderRootType rootType : rootTypes) {
    final List<String> urls=new ArrayList<String>(myJarDirectories.getDirectories(rootType));
    Collections.sort(urls,String.CASE_INSENSITIVE_ORDER);
    for (    String url : urls) {
      final Element jarDirElement=new Element(JAR_DIRECTORY_ELEMENT);
      jarDirElement.setAttribute(URL_ATTR,url);
      jarDirElement.setAttribute(RECURSIVE_ATTR,Boolean.toString(myJarDirectories.isRecursive(rootType,url)));
      if (!rootType.equals(DEFAULT_JAR_DIRECTORY_TYPE)) {
        jarDirElement.setAttribute(ROOT_TYPE_ATTR,rootType.name());
      }
      element.addContent(jarDirElement);
    }
  }
  rootElement.addContent(element);
}
