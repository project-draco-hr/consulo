{
  if (isProcessingNow() || !myCanRunRestore || myUi.hasNodesToUpdate())   return false;
  invalidateToSelectWithRefsToParent(actionNode);
  myProcessingNow=true;
  System.out.println("UpdaterTreeState.restore actionNode=" + actionNode);
  final Object[] toSelect=getToSelect();
  final Object[] toExpand=getToExpand();
  final Map<Object,Condition> adjusted=new WeakHashMap<Object,Condition>();
  adjusted.putAll(myAdjustedSelection);
  clearSelection();
  clearExpansion();
  final Set<Object> originallySelected=myUi.getSelectedElements();
  System.out.println("UpdaterTreeState.restore toSelect=" + Arrays.asList(toSelect) + " now selected="+ originallySelected);
  myUi._select(toSelect,new Runnable(){
    public void run(){
      System.out.println("UpdaterTreeState.run finished selecting=" + Arrays.asList(toSelect) + " now selected="+ myUi.getSelectedElements()+ " adjuested="+ adjusted);
      processUnsuccessfulSelections(toSelect,new Function<Object,Object>(){
        public Object fun(        final Object o){
          if (myUi.getTree().isRootVisible() || !myUi.getTreeStructure().getRootElement().equals(o)) {
            addSelection(o);
          }
          return o;
        }
      }
,originallySelected);
      processAjusted(adjusted,originallySelected).doWhenDone(new Runnable(){
        public void run(){
          myUi.expand(toExpand,new Runnable(){
            public void run(){
              if (!isEmpty()) {
                myCanRunRestore=false;
                myUi.setUpdaterState(UpdaterTreeState.this);
              }
              myProcessingNow=false;
            }
          }
,true);
        }
      }
);
    }
  }
,false,true,true,false);
  return true;
}
