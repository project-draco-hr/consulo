{
  setAuthenticator();
  URL url=new URL(location);
  final URLConnection urlConnection;
  if (USE_HTTP_PROXY) {
    InetSocketAddress proxyAddress=new InetSocketAddress(InetAddress.getByName(PROXY_HOST),PROXY_PORT);
    Proxy proxy=new Proxy(Proxy.Type.HTTP,proxyAddress);
    urlConnection=url.openConnection(proxy);
  }
 else {
    urlConnection=url.openConnection();
  }
  if (urlConnection instanceof HttpURLConnection) {
    return (HttpURLConnection)urlConnection;
  }
 else {
    throw new IOException("Expected " + HttpURLConnection.class + ", but got "+ url.getClass());
  }
}
