{
  final VirtualFile dir=myModule1Dir.createChildDirectory(null,"dir");
  final VirtualFile excluded=dir.createChildDirectory(null,"excluded");
  new WriteCommandAction.Simple(getProject()){
    @Override protected void run() throws Throwable {
      ModifiableRootModel m=ModuleRootManager.getInstance(myModule).getModifiableModel();
      ContentEntry[] ee=m.getContentEntries();
      assertEquals(1,ee.length);
      ee[0].addExcludeFolder(excluded);
      m.commit();
      dir.delete(null);
    }
  }
.execute().throwException();
  boolean created=new File(myModule1Dir.getPath(),"dir/excluded/foo").mkdirs();
  assertTrue(created);
  final List<Boolean> toAssert=new ArrayList<Boolean>();
  VirtualFileListener l=new VirtualFileAdapter(){
    @Override public void fileCreated(    VirtualFileEvent e){
      assertEquals("dir",e.getFileName());
      toAssert.add(myIndex.getInfoForDirectory(e.getFile()) != null);
      toAssert.add(myIndex.getInfoForDirectory(e.getFile().findFileByRelativePath("excluded")) == null);
      toAssert.add(myIndex.getInfoForDirectory(e.getFile().findFileByRelativePath("excluded/foo")) == null);
    }
  }
;
  VirtualFileManager.getInstance().addVirtualFileListener(l);
  try {
    VirtualFileManager.getInstance().refresh(false);
  }
  finally {
    VirtualFileManager.getInstance().removeVirtualFileListener(l);
  }
  assertEquals(Arrays.asList(true,true,true),toAssert);
}
