{
  myIndex.checkConsistency();
  new WriteCommandAction.Simple(getProject()){
    @Override protected void run() throws Throwable {
      VirtualFile newModuleContent=myRootVFile.createChildDirectory(null,"newModule");
      newModuleContent.createChildDirectory(null,"subDir");
      ModuleManager moduleManager=ModuleManager.getInstance(myProject);
      Module module=moduleManager.newModule(myRootVFile.getPath() + "/newModule.iml",StdModuleTypes.JAVA);
      ModifiableRootModel rootModel=ModuleRootManager.getInstance(module).getModifiableModel();
      rootModel.addContentEntry(newModuleContent);
      rootModel.commit();
    }
  }
.execute().throwException();
  myIndex.checkConsistency();
}
