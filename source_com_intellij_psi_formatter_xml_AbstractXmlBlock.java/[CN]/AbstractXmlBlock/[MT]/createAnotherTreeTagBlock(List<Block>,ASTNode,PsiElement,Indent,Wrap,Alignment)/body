{
  Indent childIndent=indent;
  if (myNode.getElementType() == ElementType.HTML_DOCUMENT && tag.getParent() instanceof XmlTag && myXmlFormattingPolicy.indentChildrenOf((XmlTag)tag.getParent())) {
    childIndent=Indent.getNormalIndent();
  }
  result.add(new XmlTagBlock(tag.getNode(),null,null,createPolicyFor(tag),childIndent));
  ASTNode currentChild=findChildAfter(child,tag.getTextRange().getEndOffset());
  while (currentChild != null && currentChild.getTextRange().getEndOffset() > tag.getTextRange().getEndOffset()) {
    PsiElement psiElement=JspTextBlock.findXmlTagAt(currentChild,tag.getTextRange().getEndOffset());
    if (psiElement != null) {
      if (psiElement instanceof XmlTag && psiElement.getTextRange().getStartOffset() >= currentChild.getTextRange().getStartOffset() && containsTag(psiElement)) {
        result.add(new XmlTagBlock(psiElement.getNode(),null,null,createPolicyFor(psiElement),childIndent));
        currentChild=findChildAfter(currentChild,psiElement.getTextRange().getEndOffset());
        tag=psiElement;
      }
 else {
        result.add(new XmlBlock(currentChild,wrap,alignment,myXmlFormattingPolicy,indent,new TextRange(tag.getTextRange().getEndOffset(),currentChild.getTextRange().getEndOffset())));
        return currentChild;
      }
    }
 else {
      return currentChild;
    }
  }
  return currentChild;
}
