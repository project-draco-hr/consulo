{
  Indent childIndent=indent;
  if (myNode.getElementType() == ElementType.HTML_DOCUMENT && tag.getParent() instanceof XmlTag && myXmlFormattingPolicy.indentChildrenOf((XmlTag)tag.getParent())) {
    childIndent=Indent.getNormalIndent();
  }
  result.add(createAnotherTreeTagBlock(tag,childIndent));
  TextRange tagRange=tag.getTextRange();
  ASTNode currentChild=findChildAfter(child,tagRange.getEndOffset());
  TextRange childRange=currentChild != null ? currentChild.getTextRange() : null;
  while (currentChild != null && childRange.getEndOffset() > tagRange.getEndOffset()) {
    PsiElement psiElement=JspTextBlock.findXmlTagAt(currentChild,tagRange.getEndOffset());
    if (psiElement != null) {
      if (psiElement instanceof XmlTag && psiElement.getTextRange().getStartOffset() >= childRange.getStartOffset() && containsTag(psiElement) && doesNotIntersectSubTagsWith(psiElement)) {
        result.add(createAnotherTreeTagBlock(psiElement,childIndent));
        currentChild=findChildAfter(currentChild,psiElement.getTextRange().getEndOffset());
        childRange=currentChild != null ? currentChild.getTextRange() : null;
        tagRange=psiElement.getTextRange();
      }
 else {
        result.add(new XmlBlock(currentChild,wrap,alignment,myXmlFormattingPolicy,indent,new TextRange(tagRange.getEndOffset(),childRange.getEndOffset())));
        return currentChild;
      }
    }
 else {
      result.add(new XmlBlock(currentChild,wrap,alignment,myXmlFormattingPolicy,indent,new TextRange(tagRange.getEndOffset(),childRange.getEndOffset())));
      return currentChild;
    }
  }
  return currentChild;
}
