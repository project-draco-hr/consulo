{
  Indent childIndent=indent;
  if (myNode.getElementType() == ElementType.HTML_DOCUMENT && tag.getParent() instanceof XmlTag && myXmlFormattingPolicy.indentChildrenOf((XmlTag)tag.getParent())) {
    childIndent=Indent.createNormalIndent();
  }
  result.add(new XmlTagBlock(tag.getNode(),null,null,myXmlFormattingPolicy,childIndent));
  ASTNode currentChild=findChildAfter(child,tag.getTextRange().getEndOffset());
  while (currentChild != null && currentChild.getTextRange().getEndOffset() > tag.getTextRange().getEndOffset()) {
    PsiElement psiElement=JspTextBlock.findXmlElementAt(currentChild,tag.getTextRange().getEndOffset());
    if (psiElement != null) {
      if (psiElement instanceof XmlTag && psiElement.getTextRange().getStartOffset() >= currentChild.getTextRange().getStartOffset() && psiElement.getTextRange().getEndOffset() <= myNode.getTextRange().getEndOffset()) {
        result.add(new XmlTagBlock(psiElement.getNode(),null,null,myXmlFormattingPolicy,childIndent));
        currentChild=findChildAfter(currentChild,psiElement.getTextRange().getEndOffset());
        tag=psiElement;
      }
 else {
        result.add(new XmlBlock(currentChild,wrap,alignment,myXmlFormattingPolicy,indent,new TextRange(tag.getTextRange().getEndOffset(),currentChild.getTextRange().getEndOffset())));
        return currentChild;
      }
    }
  }
  return currentChild;
}
