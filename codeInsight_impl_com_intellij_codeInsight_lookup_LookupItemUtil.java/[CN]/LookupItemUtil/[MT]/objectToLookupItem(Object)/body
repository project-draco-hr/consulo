{
  if (object instanceof LookupItem)   return (LookupItem)object;
  String s=null;
  LookupItem item=new LookupItem(object,"");
  int tailType=TailType.NONE;
  if (object instanceof PsiElement) {
    PsiElement element=(PsiElement)object;
    if (element.getUserData(PsiUtil.ORIGINAL_KEY) != null) {
      element=element.getUserData(PsiUtil.ORIGINAL_KEY);
      object=element;
      item=new LookupItem(object,"");
    }
    s=PsiUtil.getName(element);
  }
  if (object instanceof PsiMethod) {
    PsiMethod method=(PsiMethod)object;
    s=method.getName();
    PsiType type=method.getReturnType();
    if (type == PsiType.VOID) {
      tailType=TailType.SEMICOLON;
    }
  }
 else   if (object instanceof PsiPackage) {
    tailType=TailType.DOT;
  }
 else   if (object instanceof PsiKeyword) {
    s=((PsiKeyword)object).getText();
  }
 else   if (object instanceof PsiExpression) {
    s=((PsiExpression)object).getText();
  }
 else   if (object instanceof PsiType) {
    final PsiType type=(PsiType)object;
    if (type instanceof PsiPrimitiveType) {
      s=((PsiType)object).getPresentableText();
    }
 else     if (type instanceof PsiArrayType) {
      PsiType contentType=type;
      int dim=0;
      final StringBuffer tail=new StringBuffer();
      while (contentType instanceof PsiArrayType) {
        contentType=((PsiArrayType)contentType).getComponentType();
        tail.append("[]");
        dim++;
      }
      if (contentType instanceof PsiClassType) {
        PsiClassType.ClassResolveResult classResolveResult=((PsiClassType)contentType).resolveGenerics();
        final PsiClass psiClass=classResolveResult.getElement();
        final PsiSubstitutor substitutor=classResolveResult.getSubstitutor();
        final String text;
        if (psiClass != null) {
          text=formatTypeName(psiClass,substitutor);
        }
 else {
          text=type.getPresentableText();
        }
        String typeString=text;
        if (text.indexOf('<') > 0) {
          typeString=text.substring(0,text.indexOf('<'));
        }
        s=text.substring(typeString.lastIndexOf('.') + 1);
        item=psiClass != null ? new LookupItem(psiClass,s) : new LookupItem(text,s);
        item.setAttribute(LookupItem.SUBSTITUTOR,substitutor);
      }
 else {
        item=new LookupItem(contentType,"");
        s=contentType.getPresentableText();
      }
      item.setAttribute(LookupItem.TAIL_TEXT_ATTR," " + tail.toString() + "");
      item.setAttribute(LookupItem.TAIL_TEXT_SMALL_ATTR,"");
      item.setAttribute(LookupItem.BRACKETS_COUNT_ATTR,new Integer(dim));
    }
 else     if (type instanceof PsiClassType) {
      PsiClassType.ClassResolveResult classResolveResult=((PsiClassType)type).resolveGenerics();
      final PsiClass psiClass=classResolveResult.getElement();
      final PsiSubstitutor substitutor=classResolveResult.getSubstitutor();
      final String text;
      if (psiClass != null) {
        text=formatTypeName(psiClass,substitutor);
      }
 else {
        text=type.getPresentableText();
      }
      if (text != null) {
        String typeString=text;
        if (text.indexOf('<') > 0) {
          typeString=text.substring(0,text.indexOf('<'));
        }
        s=text.substring(typeString.lastIndexOf('.') + 1);
        item=psiClass != null ? new LookupItem(psiClass,s) : new LookupItem(text,s);
        item.setAttribute(LookupItem.SUBSTITUTOR,substitutor);
      }
 else {
        s=type.getPresentableText();
      }
    }
 else {
      s=type.getPresentableText();
    }
    item.setAttribute(LookupItem.TYPE,type);
  }
 else   if (object instanceof PsiMetaData) {
    s=((PsiMetaData)object).getName();
  }
 else   if (object instanceof String) {
    s=(String)object;
  }
 else   if (object instanceof Template) {
    s="";
  }
 else   if (object instanceof PsiPointcutDef) {
    s=((PsiPointcutDef)object).getName();
  }
 else   if (object instanceof PresentableLookupValue) {
    s=((PresentableLookupValue)object).getPresentation();
  }
  if (s == null) {
    LOG.assertTrue(false,"Null string for object: " + object + " of class "+ (object != null ? object.getClass() : null));
  }
  item.setLookupString(s);
  item.setAttribute(CompletionUtil.TAIL_TYPE_ATTR,new Integer(tailType));
  return item;
}
