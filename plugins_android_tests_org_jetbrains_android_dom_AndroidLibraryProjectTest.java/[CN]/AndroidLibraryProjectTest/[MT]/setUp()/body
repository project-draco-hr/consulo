{
  super.setUp();
  final TestFixtureBuilder<IdeaProjectTestFixture> projectBuilder=IdeaTestFixtureFactory.getFixtureFactory().createFixtureBuilder();
  myFixture=JavaTestFixtureFactory.getFixtureFactory().createCodeInsightFixture(projectBuilder.getFixture());
  String androidJarPath=getTestSdkPath() + myTestProfile.getAndroidJarDirPath();
  final JavaModuleFixtureBuilder appModuleBuilder=projectBuilder.addModule(JavaModuleFixtureBuilder.class);
  String appModuleDir=myFixture.getTempDirPath() + "/app";
  new File(appModuleDir).mkdir();
  AndroidTestCase.tuneModule(appModuleBuilder,androidJarPath,getTestDataPath(),appModuleDir);
  final JavaModuleFixtureBuilder libModuleBuilder=projectBuilder.addModule(JavaModuleFixtureBuilder.class);
  String libModuleDir=myFixture.getTempDirPath() + "/lib";
  new File(libModuleDir).mkdir();
  AndroidTestCase.tuneModule(libModuleBuilder,androidJarPath,getTestDataPath(),libModuleDir);
  myFixture.setUp();
  myFixture.setTestDataPath(getTestDataPath());
  myAppModule=appModuleBuilder.getFixture().getModule();
  myLibModule=libModuleBuilder.getFixture().getModule();
  myAppFacet=AndroidTestCase.addAndroidFacet(myAppModule,myTestProfile,getTestSdkPath());
  myLibFacet=AndroidTestCase.addAndroidFacet(myLibModule,myTestProfile,getTestSdkPath());
  final ModifiableRootModel model=ModuleRootManager.getInstance(myAppModule).getModifiableModel();
  model.addModuleOrderEntry(myLibModule);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      model.commit();
    }
  }
);
  myFixture.copyFileToProject(SdkConstants.FN_ANDROID_MANIFEST_XML,"app/" + SdkConstants.FN_ANDROID_MANIFEST_XML);
  myFixture.copyFileToProject(BASE_PATH + "LibAndroidManifest.xml","lib/" + SdkConstants.FN_ANDROID_MANIFEST_XML);
  myFixture.copyDirectoryToProject("res","app/res");
  myFixture.copyDirectoryToProject(BASE_PATH + "res","lib/res");
}
