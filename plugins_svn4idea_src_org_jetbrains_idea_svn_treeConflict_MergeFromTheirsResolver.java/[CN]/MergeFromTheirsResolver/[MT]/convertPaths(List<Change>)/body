{
  initAddOption();
  final List<Change> changes=new ArrayList<Change>();
  for (  Change change : changesForPatch) {
    if (!isUnderOldDir(change,myOldFilePath))     continue;
    ContentRevision before=null;
    ContentRevision after=null;
    if (change.getBeforeRevision() != null) {
      before=new SimpleContentRevision(change.getBeforeRevision().getContent(),rebasePath(myOldFilePath,myNewFilePath,change.getBeforeRevision().getFile()),change.getBeforeRevision().getRevisionNumber().asString());
    }
    if (change.getAfterRevision() != null) {
      if (myAdd && (change.getBeforeRevision() == null || change.isMoved() || change.isRenamed())) {
        after=change.getAfterRevision();
      }
 else {
        after=new SimpleContentRevision(change.getAfterRevision().getContent(),rebasePath(myOldFilePath,myNewFilePath,change.getAfterRevision().getFile()),change.getAfterRevision().getRevisionNumber().asString());
      }
    }
    changes.add(new Change(before,after));
  }
  return changes;
}
