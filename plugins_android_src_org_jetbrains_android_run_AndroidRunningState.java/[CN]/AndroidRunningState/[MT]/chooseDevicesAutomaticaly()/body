{
  final AndroidDebugBridge bridge=AndroidDebugBridge.getBridge();
  if (bridge == null) {
    return EMPTY_DEVICE_ARRAY;
  }
  IDevice[] devices=bridge.getDevices();
  boolean showChooserDialog=false;
  IDevice targetDevice=null;
  for (  IDevice device : devices) {
    if (isCompatibleDevice(device) != Boolean.FALSE) {
      if (targetDevice == null) {
        targetDevice=device;
      }
 else {
        showChooserDialog=true;
        break;
      }
    }
  }
  if (showChooserDialog) {
    final IDevice[][] devicesWrapper={null};
    ApplicationManager.getApplication().invokeAndWait(new Runnable(){
      @Override public void run(){
        devicesWrapper[0]=chooseDevicesManually(new Condition<IDevice>(){
          @Override public boolean value(          IDevice device){
            return isCompatibleDevice(device) != Boolean.FALSE;
          }
        }
);
      }
    }
,ModalityState.defaultModalityState());
    return devicesWrapper[0].length > 0 ? devicesWrapper[0] : null;
  }
  return targetDevice != null ? new IDevice[]{targetDevice} : EMPTY_DEVICE_ARRAY;
}
