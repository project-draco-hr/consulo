{
  return new WriteAction<PsiFile>(){
    @Override protected void run(    Result<PsiFile> result) throws Throwable {
      if (!ModuleRootManager.getInstance(module).getFileIndex().isInSourceContent(vDir)) {
        addSourceContentToRoots(module,vDir);
      }
      final VirtualFile vFile=vDir.createChildData(vDir,fileName);
      VfsUtil.saveText(vFile,text);
      assertNotNull(vFile);
      final PsiFile file=myPsiManager.findFile(vFile);
      assertNotNull(file);
      result.setResult(file);
    }
  }
.execute().getResultObject();
}
