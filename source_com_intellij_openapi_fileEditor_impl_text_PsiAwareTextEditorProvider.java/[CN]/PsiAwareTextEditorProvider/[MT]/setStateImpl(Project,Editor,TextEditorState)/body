{
  super.setStateImpl(project,editor,state);
  if (project != null && state.FOLDING_STATE != null) {
    PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
    editor.getFoldingModel().runBatchFoldingOperation(new Runnable(){
      public void run(){
        CodeFoldingManager.getInstance(project).restoreFoldingState(editor,state.FOLDING_STATE);
      }
    }
);
  }
}
