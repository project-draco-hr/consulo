{
  final FileTemplate template=FileTemplateManager.getInstance().getJ2eeTemplate(templateName);
  Properties properties=new Properties(FileTemplateManager.getInstance().getDefaultProperties());
  FileTemplateUtil.setPackageNameAttribute(properties,directory);
  properties.setProperty(NAME_TEMPLATE_PROPERTY,name);
  properties.setProperty(LOW_CASE_NAME_TEMPLATE_PROPERTY,name.substring(0,1).toLowerCase() + name.substring(1));
  for (int i=0; i < parameters.length; i+=2) {
    properties.setProperty(parameters[i],parameters[i + 1]);
  }
  String text;
  try {
    text=template.getText(properties);
  }
 catch (  Exception e) {
    throw new RuntimeException("Unable to load template for " + FileTemplateManager.getInstance().internalTemplateToSubject(templateName),e);
  }
  final PsiManager psiManager=PsiManager.getInstance(directory.getProject());
  final PsiFile file=psiManager.getElementFactory().createFileFromText(fileName,text);
  CodeStyleManager.getInstance(psiManager).reformat(file,false);
  return (PsiFile)directory.add(file);
}
