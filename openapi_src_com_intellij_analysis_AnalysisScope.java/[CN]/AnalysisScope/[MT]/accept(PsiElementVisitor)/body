{
  if (myType == VIRTUAL_FILES) {
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    for (    VirtualFile file : myFilesSet) {
      final PsiFile psiFile=psiManager.findFile(file);
      if (psiFile != null) {
        psiFile.accept(visitor);
      }
    }
  }
 else   if (myScope instanceof GlobalSearchScope) {
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    final FileIndex projectFileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
    projectFileIndex.iterateContent(new ContentIterator(){
      public boolean processFile(      VirtualFile fileOrDir){
        if (fileOrDir.isDirectory())         return true;
        if (((GlobalSearchScope)myScope).contains(fileOrDir) && (myIncludeTestSource || !projectFileIndex.isInTestSourceContent(fileOrDir))) {
          PsiFile psiFile=psiManager.findFile(fileOrDir);
          if (psiFile == null)           return true;
          if (!(psiFile instanceof PsiJavaFile))           return true;
          psiFile.accept(visitor);
        }
        return true;
      }
    }
);
  }
 else   if (myScope instanceof LocalSearchScope) {
    final PsiElement[] psiElements=((LocalSearchScope)myScope).getScope();
    for (    PsiElement element : psiElements) {
      element.accept(visitor);
    }
  }
 else   if (myProject != null) {
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    final FileIndex projectFileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
    projectFileIndex.iterateContent(new ContentIterator(){
      public boolean processFile(      VirtualFile fileOrDir){
        if (fileOrDir.isDirectory())         return true;
        if (projectFileIndex.isInContent(fileOrDir) && (myIncludeTestSource || !projectFileIndex.isInTestSourceContent(fileOrDir))) {
          PsiFile psiFile=psiManager.findFile(fileOrDir);
          if (psiFile == null)           return true;
          psiFile.accept(visitor);
        }
        return true;
      }
    }
);
  }
 else   if (myModule != null) {
    final FileIndex moduleFileIndex=ModuleRootManager.getInstance(myModule).getFileIndex();
    moduleFileIndex.iterateContent(new ContentIterator(){
      public boolean processFile(      VirtualFile fileOrDir){
        if (fileOrDir.isDirectory())         return true;
        if (moduleFileIndex.isInContent(fileOrDir) && (myIncludeTestSource || !moduleFileIndex.isInTestSourceContent(fileOrDir))) {
          PsiFile psiFile=PsiManager.getInstance(myModule.getProject()).findFile(fileOrDir);
          if (psiFile == null)           return true;
          psiFile.accept(visitor);
        }
        return true;
      }
    }
);
  }
 else   if (myModules != null) {
    for (    final Module module : myModules) {
      final FileIndex moduleFileIndex=ModuleRootManager.getInstance(module).getFileIndex();
      moduleFileIndex.iterateContent(new ContentIterator(){
        public boolean processFile(        VirtualFile fileOrDir){
          if (fileOrDir.isDirectory())           return true;
          if (moduleFileIndex.isInContent(fileOrDir) && (myIncludeTestSource || !moduleFileIndex.isInTestSourceContent(fileOrDir))) {
            PsiFile psiFile=PsiManager.getInstance(module.getProject()).findFile(fileOrDir);
            if (psiFile == null)             return true;
            psiFile.accept(visitor);
          }
          return true;
        }
      }
);
    }
  }
 else   if (myElement instanceof PsiPackage) {
    PsiPackage pack=(PsiPackage)myElement;
    PsiDirectory[] dirs=pack.getDirectories(GlobalSearchScope.projectScope(myElement.getProject()));
    for (    PsiDirectory dir : dirs) {
      accept(dir,visitor);
    }
  }
 else {
    myElement.accept(visitor);
  }
}
