{
  final Project project=dir.getProject();
  final PsiManager psiManager=PsiManager.getInstance(project);
  final ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
  index.iterateContentUnderDirectory(dir.getVirtualFile(),new ContentIterator(){
    @SuppressWarnings({"SimplifiableIfStatement"}) public boolean processFile(    final VirtualFile fileOrDir){
      if (!myIncludeTestSource && index.isInTestSourceContent(fileOrDir))       return true;
      if (!fileOrDir.isDirectory()) {
        return AnalysisScope.processFile(fileOrDir,visitor,psiManager);
      }
      return true;
    }
  }
);
}
