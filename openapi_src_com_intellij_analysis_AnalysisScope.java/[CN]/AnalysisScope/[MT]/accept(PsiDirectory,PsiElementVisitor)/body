{
  final Project project=dir.getProject();
  final PsiManager psiManager=PsiManager.getInstance(project);
  final ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
  index.iterateContentUnderDirectory(dir.getVirtualFile(),new ContentIterator(){
    public boolean processFile(    VirtualFile fileOrDir){
      if (!myIncludeTestSource && index.isInTestSourceContent(fileOrDir))       return true;
      if (!fileOrDir.isDirectory()) {
        final PsiFile psiFile=psiManager.findFile(fileOrDir);
        if (psiFile != null) {
          psiFile.accept(visitor);
        }
      }
      return true;
    }
  }
);
}
