{
  Document document=editor.getDocument();
  CharSequence text=document.getText();
  Project project=file.getProject();
  int caretOffset=caretOffsetRef.get().intValue();
  if (CodeInsightSettings.getInstance().INSERT_BRACE_ON_ENTER && isAfterUnmatchedLBrace(editor,caretOffset,file.getFileType())) {
    int offset=CharArrayUtil.shiftForward(text,caretOffset," \t");
    if (offset < document.getTextLength()) {
      char c=text.charAt(offset);
      if (c != ')' && c != ']' && c != ';' && c != ',' && c != '%' && c != '<') {
        offset=CharArrayUtil.shiftForwardUntil(text,caretOffset,"\n");
      }
    }
    offset=Math.min(offset,document.getTextLength());
    document.insertString(offset,"\n}");
    PsiDocumentManager.getInstance(project).commitDocument(document);
    try {
      CodeStyleManager.getInstance(project).adjustLineIndent(file,offset + 1);
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
    return Result.DefaultForceIndent;
  }
  return Result.Continue;
}
