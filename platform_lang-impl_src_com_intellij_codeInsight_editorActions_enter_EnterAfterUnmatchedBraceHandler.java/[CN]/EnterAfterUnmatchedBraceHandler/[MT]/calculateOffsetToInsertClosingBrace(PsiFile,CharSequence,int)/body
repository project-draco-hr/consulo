{
  PsiElement element=PsiUtilBase.getElementAtOffset(file,offset);
  ASTNode node=element.getNode();
  if (node != null && node.getElementType() == TokenType.WHITE_SPACE) {
    return CharArrayUtil.shiftForwardUntil(text,offset,"\n");
  }
  for (PsiElement parent=element.getParent(); parent != null && parent.getTextOffset() == offset; parent=parent.getParent()) {
    element=parent;
  }
  if (element.getTextOffset() != offset) {
    return CharArrayUtil.shiftForwardUntil(text,offset,"\n");
  }
 else {
    return element.getTextRange().getEndOffset();
  }
}
