{
  final Dimension size=getSize();
  final boolean pressed=getModel().isPressed();
  final boolean forced=myWasPressed && !pressed || !myWasPressed && pressed;
  myWasPressed=pressed;
  if (myBufferedImage == null || forced) {
    myBufferedImage=UIUtil.createImage(size.width,size.height,BufferedImage.TYPE_INT_ARGB);
    final Graphics bg=myBufferedImage.getGraphics().create();
    final Runtime runtime=Runtime.getRuntime();
    final long maxMemory=runtime.maxMemory();
    final long freeMemory=maxMemory - runtime.totalMemory() + runtime.freeMemory();
    final Insets insets=SystemInfo.isMac ? getInsets() : new Insets(0,0,0,0);
    final int totalBarLength=size.width - insets.left - insets.right;
    final int usedBarLength=totalBarLength - (int)(totalBarLength * freeMemory / maxMemory);
    final int allocatedBarWidth=totalBarLength - (int)(totalBarLength * (freeMemory - runtime.freeMemory()) / maxMemory);
    final int barHeight=SystemInfo.isMac ? HEIGHT : size.height - insets.top - insets.bottom;
    final Graphics2D g2=(Graphics2D)bg;
    final int yOffset=(size.height - barHeight) / 2;
    final int xOffset=insets.left;
    if (!UIUtil.isUnderAquaLookAndFeel()) {
      g2.setColor(UIUtil.getControlColor());
      g2.fillRect(xOffset,yOffset,totalBarLength,barHeight);
    }
 else {
      g2.setPaint(new GradientPaint(0,0,Gray._190,0,size.height - 1,Gray._230));
      g2.fillRect(xOffset,yOffset,totalBarLength,barHeight);
      g2.setPaint(new GradientPaint(0,0,Gray._200.withAlpha(100),0,size.height - 1,Gray._150.withAlpha(130)));
      g2.fillRect(xOffset + 1,yOffset,allocatedBarWidth,barHeight);
      g2.setColor(Gray._175);
      g2.drawLine(xOffset + allocatedBarWidth,yOffset + 1,xOffset + allocatedBarWidth,yOffset + barHeight - 1);
    }
    if (pressed) {
      Color start=new Color(101,111,135);
      Color end=new Color(175,185,202);
      if (UIUtil.isUnderDarcula()) {
        start=start.darker();
        end=end.darker();
      }
      g2.setPaint(new GradientPaint(1,1,start,0,size.height - 2,end));
      g2.fillRect(xOffset + 1,yOffset,usedBarLength,barHeight);
    }
 else {
      Color start=new Color(175,185,202);
      Color end=new Color(126,138,168);
      if (UIUtil.isUnderDarcula()) {
        start=start.darker();
        end=end.darker();
      }
      g2.setPaint(new GradientPaint(1,1,start,0,size.height - 2,end));
      g2.fillRect(xOffset + 1,yOffset,usedBarLength,barHeight);
      if (SystemInfo.isMac && !UIUtil.isUnderDarcula()) {
        g2.setColor(new Color(194,197,203));
        g2.drawLine(xOffset + 1,yOffset + 1,allocatedBarWidth,yOffset + 1);
      }
    }
    if (SystemInfo.isMac && !UIUtil.isUnderDarcula()) {
      g2.setColor(Gray._110);
      g2.drawRect(xOffset,yOffset,totalBarLength,barHeight - 1);
    }
    g2.setFont(getFont());
    final long used=(maxMemory - freeMemory) / MEGABYTE;
    final long total=maxMemory / MEGABYTE;
    final String info=UIBundle.message("memory.usage.panel.message.text",Long.toString(used),Long.toString(total));
    final FontMetrics fontMetrics=g.getFontMetrics();
    final int infoWidth=fontMetrics.charsWidth(info.toCharArray(),0,info.length());
    final int infoHeight=fontMetrics.getHeight() - fontMetrics.getDescent();
    UIUtil.applyRenderingHints(g2);
    g2.setColor(UIUtil.getListForeground());
    g2.drawString(info,xOffset + (totalBarLength - infoWidth) / 2,yOffset + (barHeight + infoHeight) / 2 - 1);
    bg.dispose();
  }
  g.drawImage(myBufferedImage,0,0,null);
}
