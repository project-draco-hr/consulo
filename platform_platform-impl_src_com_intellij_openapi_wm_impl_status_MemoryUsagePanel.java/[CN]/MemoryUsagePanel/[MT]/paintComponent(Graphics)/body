{
  final boolean pressed=getModel().isPressed();
  final boolean stateChanged=myWasPressed != pressed;
  myWasPressed=pressed;
  if (myBufferedImage == null || stateChanged) {
    final Dimension size=getSize();
    final Insets insets=getInsets();
    myBufferedImage=UIUtil.createImage(size.width,size.height,BufferedImage.TYPE_INT_ARGB);
    final Graphics2D g2=(Graphics2D)myBufferedImage.getGraphics().create();
    final Runtime rt=Runtime.getRuntime();
    final long maxMem=rt.maxMemory();
    final long allocatedMem=rt.totalMemory();
    final long unusedMem=rt.freeMemory();
    final long usedMem=allocatedMem - unusedMem;
    final int totalBarLength=size.width - insets.left - insets.right;
    final int usedBarLength=(int)(totalBarLength * usedMem / maxMem);
    final int unusedBarLength=(int)(totalBarLength * unusedMem / maxMem);
    final int barHeight=Math.max(size.height,getFont().getSize() + JBUI.scale(2));
    final int yOffset=(size.height - barHeight) / 2;
    final int xOffset=insets.left;
    g2.setColor(UIUtil.getPanelBackground());
    g2.fillRect(0,0,size.width,size.height);
    g2.setColor(USED_COLOR);
    g2.fillRect(xOffset,yOffset,usedBarLength,barHeight);
    g2.setColor(UNUSED_COLOR);
    g2.fillRect(xOffset + usedBarLength,yOffset,unusedBarLength,barHeight);
    g2.setFont(getFont());
    final long used=usedMem / MEGABYTE;
    final long total=maxMem / MEGABYTE;
    final String info=UIBundle.message("memory.usage.panel.message.text",used,total);
    final FontMetrics fontMetrics=g.getFontMetrics();
    final int infoWidth=fontMetrics.charsWidth(info.toCharArray(),0,info.length());
    final int infoHeight=fontMetrics.getAscent();
    UISettings.setupAntialiasing(g2);
    final Color fg=pressed ? UIUtil.getLabelDisabledForeground() : JBColor.foreground();
    g2.setColor(fg);
    g2.drawString(info,xOffset + (totalBarLength - infoWidth) / 2,yOffset + infoHeight + (barHeight - infoHeight) / 2 - JBUI.scale(1));
    g2.dispose();
  }
  UIUtil.drawImage(g,myBufferedImage,0,0,null);
  if (UIUtil.isRetina() && !UIUtil.isUnderDarcula()) {
    Graphics2D g2=(Graphics2D)g.create(0,0,getWidth(),getHeight());
    g2.scale(0.5,0.5);
    g2.setColor(Gray.x91);
    g2.drawLine(0,0,2 * getWidth(),0);
    g2.scale(1,1);
    g2.dispose();
  }
}
