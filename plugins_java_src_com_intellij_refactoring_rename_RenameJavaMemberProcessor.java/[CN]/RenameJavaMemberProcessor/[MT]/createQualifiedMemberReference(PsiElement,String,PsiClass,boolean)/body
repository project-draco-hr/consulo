{
  PsiReferenceExpression ref;
  final PsiJavaCodeReferenceElement qualifier;
  final PsiManager manager=containingClass.getManager();
  final PsiElementFactory factory=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory();
  if (isStatic) {
    ref=(PsiReferenceExpression)factory.createExpressionFromText("A." + name,context);
    qualifier=(PsiJavaCodeReferenceElement)ref.getQualifierExpression();
    final PsiReferenceExpression classReference=factory.createReferenceExpression(containingClass);
    qualifier.replace(classReference);
  }
 else {
    PsiClass contextClass=PsiTreeUtil.getParentOfType(context,PsiClass.class);
    if (InheritanceUtil.isInheritorOrSelf(contextClass,containingClass,true)) {
      ref=(PsiReferenceExpression)factory.createExpressionFromText("this." + name,context);
      return ref;
    }
    while (contextClass != null && !InheritanceUtil.isInheritorOrSelf(contextClass,containingClass,true)) {
      contextClass=PsiTreeUtil.getParentOfType(contextClass,PsiClass.class,true);
    }
    ref=(PsiReferenceExpression)factory.createExpressionFromText("A.this." + name,null);
    qualifier=((PsiThisExpression)ref.getQualifierExpression()).getQualifier();
    final PsiJavaCodeReferenceElement classReference=factory.createClassReferenceElement(contextClass != null ? contextClass : containingClass);
    qualifier.replace(classReference);
  }
  return ref;
}
