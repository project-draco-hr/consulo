{
  final VirtualFile f=createFile("f.txt");
  CommandProcessor.getInstance().executeCommand(myProject,new RunnableAdapter(){
    @Override public void doRun() throws IOException {
      setContent(f,"file");
      setDocumentTextFor(f,"doc1");
      LocalHistoryAction a=LocalHistory.getInstance().startAction("action");
      setDocumentTextFor(f,"doc2");
      a.finish();
      saveDocument(f);
      setContent(f,"doc3");
    }
  }
,"command",null);
  List<Revision> rr=getRevisionsFor(f);
  assertEquals(4,rr.size());
  assertContent("doc3",rr.get(0).findEntry());
  assertContent("doc1",rr.get(1).findEntry());
  assertContent("",rr.get(2).findEntry());
  assertEquals("command",rr.get(1).getChangeSetName());
  assertNull(rr.get(2).getChangeSetName());
}
