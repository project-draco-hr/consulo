{
  final PsiTypeParameter[] typeParameters=method.getTypeParameters();
  if (myArgumentTypes != null) {
    final PsiParameter[] parameters=method.getParameterList().getParameters();
    final int max=Math.max(parameters.length,myArgumentTypes.length);
    PsiType[] parameterTypes=new PsiType[max];
    PsiType[] argumentTypes=new PsiType[max];
    for (int i=0; i < parameterTypes.length; i++) {
      if (i < parameters.length) {
        final PsiType type=parameters[i].getType();
        if (myArgumentTypes.length == parameters.length && type instanceof PsiEllipsisType && !(myArgumentTypes[myArgumentTypes.length - 1] instanceof PsiArrayType)) {
          parameterTypes[i]=((PsiEllipsisType)type).getComponentType();
        }
 else {
          parameterTypes[i]=type;
        }
      }
 else {
        if (parameters.length > 0) {
          final PsiType lastParameterType=parameters[parameters.length - 1].getType();
          if (myArgumentTypes.length > parameters.length && lastParameterType instanceof PsiEllipsisType) {
            parameterTypes[i]=((PsiEllipsisType)lastParameterType).getComponentType();
          }
 else {
            parameterTypes[i]=lastParameterType;
          }
        }
 else {
          parameterTypes[i]=PsiType.NULL;
        }
      }
      argumentTypes[i]=i < myArgumentTypes.length ? myArgumentTypes[i] : PsiType.NULL;
    }
    final PsiResolveHelper helper=method.getManager().getResolveHelper();
    PsiSubstitutor substitutor=helper.inferTypeArguments(typeParameters,parameterTypes,argumentTypes,LanguageLevel.HIGHEST);
    for (    PsiTypeParameter typeParameter : typeParameters) {
      if (!substitutor.getSubstitutionMap().containsKey(typeParameter)) {
        substitutor=inferFromContext(typeParameter,method.getReturnType(),substitutor,helper);
      }
    }
    return substitutor;
  }
  return partialSubstitutor;
}
