{
  final Runnable antAwareRunnable=new Runnable(){
    public void run(){
      if (configuration instanceof RunConfiguration) {
        final RunConfiguration runConfiguration=(RunConfiguration)configuration;
        final RunManagerImpl runManager=RunManagerImpl.getInstanceImpl(myProject);
        final Map<String,Boolean> beforeRun=runManager.getStepsBeforeLaunch(runConfiguration);
        final Collection<StepsBeforeRunProvider> activeProviders=new ArrayList<StepsBeforeRunProvider>();
        for (        final StepsBeforeRunProvider provider : Extensions.getExtensions(StepsBeforeRunProvider.EXTENSION_POINT_NAME,myProject)) {
          final Boolean enabled=beforeRun.get(provider.getStepName());
          if (enabled != null && enabled.booleanValue() && provider.hasTask(runConfiguration)) {
            activeProviders.add(provider);
          }
        }
        if (!activeProviders.isEmpty()) {
          ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
            public void run(){
              final DataContext dataContext=SimpleDataContext.getProjectContext(myProject);
              for (              StepsBeforeRunProvider provider : activeProviders) {
                if (!provider.executeTask(dataContext,runConfiguration)) {
                  return;
                }
              }
              ApplicationManager.getApplication().invokeLater(startRunnable);
            }
          }
);
        }
 else {
          startRunnable.run();
        }
      }
 else {
        startRunnable.run();
      }
    }
  }
;
  Module[] modulesToCompile=state.getModulesToCompile();
  if (modulesToCompile == null)   modulesToCompile=Module.EMPTY_ARRAY;
  if (getConfig().isCompileBeforeRunning(configuration) && modulesToCompile.length > 0) {
    final CompileStatusNotification callback=new CompileStatusNotification(){
      public void finished(      final boolean aborted,      final int errors,      final int warnings,      CompileContext compileContext){
        if (errors == 0 && !aborted) {
          ApplicationManager.getApplication().invokeLater(antAwareRunnable);
        }
      }
    }
;
    CompileScope scope;
    final CompilerManager compilerManager=CompilerManager.getInstance(myProject);
    if (Boolean.valueOf(System.getProperty(MAKE_PROJECT_ON_RUN_KEY,Boolean.FALSE.toString())).booleanValue()) {
      scope=compilerManager.createProjectCompileScope(myProject);
    }
 else {
      scope=compilerManager.createModulesCompileScope(modulesToCompile,true);
    }
    scope.putUserData(RUN_PROFILE_STATE_KEY,state);
    compilerManager.make(scope,callback);
  }
 else {
    antAwareRunnable.run();
  }
}
