{
  if (detectedFacets == null || detectedFacets.isEmpty()) {
    SmartList<Integer> old=myDetectedFacetIds;
    myFacets=null;
    myDetectedFacetIds=null;
    return old;
  }
  if (myFacets == null) {
    myFacets=new SmartList<FacetPointer>();
  }
 else {
    myFacets.clear();
  }
  if (myDetectedFacetIds == null) {
    myDetectedFacetIds=new SmartList<Integer>();
  }
  Set<Integer> toRemove=new HashSet<Integer>(myDetectedFacetIds);
  for (  FacetInfo2<Module> info : detectedFacets) {
    if (info instanceof FacetInfoBackedByFacet) {
      FacetPointer<Facet> pointer=facetPointersManager.create(((FacetInfoBackedByFacet)info).getFacet());
      LOG.assertTrue(pointer.getModuleName().length() > 0);
      myFacets.add(pointer);
    }
 else {
      Integer id=((DetectedFacetInfo)info).getId();
      boolean removed=toRemove.remove(id);
      if (!removed) {
        myDetectedFacetIds.add(id);
      }
    }
  }
  myDetectedFacetIds.removeAll(toRemove);
  return toRemove;
}
