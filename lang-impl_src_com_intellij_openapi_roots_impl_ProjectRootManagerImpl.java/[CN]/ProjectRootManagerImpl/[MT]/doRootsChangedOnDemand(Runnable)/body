{
  if (getBatchSession(false).myBatchLevel == 0) {
    LOG.assertTrue(!myIsRootsChangedOnDemandStartedButNotDemanded,"Nested on-demand rootsChanged not supported");
    LOG.assertTrue(myRootsChangeCounter == 0,"On-demand rootsChanged not allowed inside rootsChanged, rootsChanged level == " + myRootsChangeCounter);
    myIsRootsChangedOnDemandStartedButNotDemanded=true;
    try {
      r.run();
    }
  finally {
      if (myIsRootsChangedOnDemandStartedButNotDemanded) {
        myIsRootsChangedOnDemandStartedButNotDemanded=false;
      }
 else {
        if (myRootsChangeCounter != 1) {
          LOG.assertTrue(false,"myRootsChangedCounter = " + myRootsChangeCounter);
        }
        myIsRootsChangedOnDemandStartedButNotDemanded=false;
        rootsChangedInternal(false);
      }
    }
  }
 else {
    r.run();
  }
}
