{
  LOG.assertTrue(!myIsRootsChangedOnDemandStartedButNotDemanded,"Nested on-demand rootsChanged not supported");
  LOG.assertTrue(myRootsChangeCounter == 0,"On-demand rootsChanged not allowed inside rootsChanged");
  myIsRootsChangedOnDemandStartedButNotDemanded=true;
  try {
    r.run();
  }
  finally {
    if (myIsRootsChangedOnDemandStartedButNotDemanded) {
      myIsRootsChangedOnDemandStartedButNotDemanded=false;
    }
 else {
      if (myRootsChangeCounter != 1) {
        String message="myRootsChangedCounter = " + myRootsChangeCounter;
        if (myRootsChangeCounter > 1) {
          for (          String rootsChangedEvent : myRootsChangedEvents) {
            message+="\n" + rootsChangedEvent + "\n";
          }
          LOG.assertTrue(false,message);
        }
 else {
          LOG.assertTrue(false,"myRootsChangedCounter = " + myRootsChangeCounter);
        }
      }
      myIsRootsChangedOnDemandStartedButNotDemanded=false;
      rootsChanged(false);
    }
  }
}
