{
  myProject=project;
  myFile=file;
  myEditor=editor;
  myDocument=myEditor.getDocument();
  if (!myFile.isWritable()) {
    if (!FileDocumentManager.fileForDocumentCheckedOutSuccessfully(getDocument(),project)) {
      return;
    }
  }
  FeatureUsageTracker.getInstance().triggerFeatureUsed("codeassists.comment.line");
  myCodeStyleManager=CodeStyleManager.getInstance(myProject);
  final SelectionModel selectionModel=myEditor.getSelectionModel();
  boolean hasSelection=selectionModel.hasSelection();
  myStartOffset=selectionModel.getSelectionStart();
  myEndOffset=selectionModel.getSelectionEnd();
  if (myDocument.getTextLength() == 0)   return;
  int lastLineEnd=myDocument.getLineEndOffset(myDocument.getLineNumber(myEndOffset));
  FoldRegion collapsedAt=((FoldingModelImpl)myEditor.getFoldingModel()).getCollapsedRegionAtOffset(lastLineEnd);
  if (collapsedAt != null) {
    myEndOffset=Math.max(myEndOffset,collapsedAt.getEndOffset());
  }
  boolean wholeLinesSelected=!hasSelection || (myStartOffset == myDocument.getLineStartOffset(myDocument.getLineNumber(myStartOffset)) && myEndOffset == myDocument.getLineEndOffset(myDocument.getLineNumber(myEndOffset - 1)) + 1);
  doComment();
  if (!hasSelection) {
    editor.getCaretModel().moveCaretRelatively(0,1,false,false,true);
  }
 else {
    if (wholeLinesSelected) {
      selectionModel.setSelection(myStartOffset,selectionModel.getSelectionEnd());
    }
  }
}
