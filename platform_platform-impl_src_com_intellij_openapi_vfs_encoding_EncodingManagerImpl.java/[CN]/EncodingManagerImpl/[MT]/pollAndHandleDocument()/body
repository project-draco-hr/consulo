{
  final Document document=myChangedDocuments.poll();
  if (document == null)   return false;
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
      if (virtualFile == null)       return;
      Project project=guessProject(virtualFile);
      if (project != null && project.isDisposed())       return;
      Charset charset=LoadTextUtil.charsetFromContentOrNull(project,virtualFile,document.getText());
      document.putUserData(CACHED_CHARSET_FROM_CONTENT,charset);
    }
  }
);
  return true;
}
