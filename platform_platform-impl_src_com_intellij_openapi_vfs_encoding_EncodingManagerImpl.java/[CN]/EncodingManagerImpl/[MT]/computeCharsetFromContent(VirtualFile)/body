{
  final Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
  if (document == null) {
    return null;
  }
  Charset cached=EncodingManager.getInstance().getCachedCharsetFromContent(document);
  if (cached != null) {
    return cached;
  }
  final Project project=ProjectLocator.getInstance().guessProjectForFile(virtualFile);
  return ApplicationManager.getApplication().runReadAction(new Computable<Charset>(){
    @Override public Charset compute(){
      Charset charsetFromContent=LoadTextUtil.charsetFromContentOrNull(project,virtualFile,document.getImmutableCharSequence());
      if (charsetFromContent != null) {
        setCachedCharsetFromContent(charsetFromContent,null,document);
      }
      return charsetFromContent;
    }
  }
);
}
