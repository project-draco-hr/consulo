{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
      if (virtualFile == null)       return;
      Project project=guessProject(virtualFile);
      if (project != null && project.isDisposed())       return;
      Charset charset=LoadTextUtil.charsetFromContentOrNull(project,virtualFile,document.getText());
      Charset oldCached=getCachedCharsetFromContent(document);
      document.putUserData(CACHED_CHARSET_FROM_CONTENT,charset);
      ((EncodingManagerImpl)EncodingManager.getInstance()).firePropertyChange(PROP_CACHED_ENCODING_CHANGED,oldCached,charset);
    }
  }
);
}
