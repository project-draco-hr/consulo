{
  VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
  if (virtualFile == null)   return;
  Project project=guessProject(virtualFile);
  if (project != null && project.isDisposed())   return;
  Charset charset=LoadTextUtil.charsetFromContentOrNull(project,virtualFile,document.getImmutableCharSequence());
  Charset oldCached=getCachedCharsetFromContent(document);
  if (!Comparing.equal(charset,oldCached)) {
    setCachedCharsetFromContent(charset,oldCached,document);
  }
}
