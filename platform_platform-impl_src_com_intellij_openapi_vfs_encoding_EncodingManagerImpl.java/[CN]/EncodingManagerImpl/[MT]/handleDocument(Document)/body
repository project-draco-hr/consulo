{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override public void run(){
      VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
      if (virtualFile == null)       return;
      Project project=guessProject(virtualFile);
      if (project != null && project.isDisposed())       return;
      Charset charset=LoadTextUtil.charsetFromContentOrNull(project,virtualFile,document.getText());
      Charset oldCached=getCachedCharsetFromContent(document);
      if (!Comparing.equal(charset,oldCached)) {
        document.putUserData(CACHED_CHARSET_FROM_CONTENT,charset);
        firePropertyChange(PROP_CACHED_ENCODING_CHANGED,oldCached,charset);
      }
    }
  }
);
}
