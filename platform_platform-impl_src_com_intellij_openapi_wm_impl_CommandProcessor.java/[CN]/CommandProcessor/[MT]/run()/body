{
synchronized (myLock) {
    final CommandGroup commandGroup=getNextCommandGroup();
    if (commandGroup == null || commandGroup.isEmpty())     return;
    final Condition conditionForGroup=commandGroup.getExpireCondition();
    final FinalizableCommand command=commandGroup.takeNextCommand();
    myCommandCount--;
    final Condition expire=command.getExpireCondition() != null ? command.getExpireCondition() : conditionForGroup;
    if (LOG.isDebugEnabled()) {
      LOG.debug("CommandProcessor.run " + command);
    }
    final boolean queueNext=myCommandCount > 0;
    Application application=ApplicationManager.getApplication();
    ModalityState modalityState=Registry.is("ide.perProjectModality") ? ModalityState.defaultModalityState() : ModalityState.NON_MODAL;
    application.getInvokator().invokeLater(command,modalityState,expire == null ? application.getDisposed() : expire).doWhenDone(new Runnable(){
      public void run(){
        if (queueNext) {
          CommandProcessor.this.run();
        }
      }
    }
);
  }
}
