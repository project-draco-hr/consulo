{
  if (!(target instanceof PsiIdentifier)) {
    return null;
  }
  if (file instanceof PsiCompiledElement) {
    file=(PsiFile)((PsiCompiledElement)file).getMirror();
  }
  if (file instanceof PsiJavaFile) {
    final PsiElement def;
    final PsiElement refElem=target.getParent();
    if (refElem instanceof PsiReference) {
      def=((PsiReference)refElem).resolve();
    }
 else {
      def=refElem;
    }
    if (def instanceof PsiLocalVariable || def instanceof PsiParameter) {
      final PsiVariable var=(PsiVariable)def;
      final PsiMethod method;
      PsiElement p=var;
      while (!(p instanceof PsiMethod)) {
        final PsiElement parent=p.getParent();
        LOG.assertTrue(parent != null);
        p=parent;
      }
      method=(PsiMethod)p;
      final PsiCodeBlock body=method.getBody();
      final PsiElement[] elems=defs ? DefUseUtil.getDefs(body,var,refElem) : DefUseUtil.getRefs(body,var,refElem);
      return elems;
    }
  }
  return null;
}
