{
  final CharTable charTable=SharedImplUtil.findCharTableByTree(leafElement);
  LeafElement whiteSpaceElement=Factory.createSingleLeafElement(whiteSpaceToken,whiteSpace.toCharArray(),0,whiteSpace.length(),charTable,SharedImplUtil.getManagerByTree(leafElement));
  ASTNode treePrev=findPreviousWhiteSpace(leafElement);
  if (treePrev == null) {
    treePrev=getWsCandidate(leafElement);
  }
  if (treePrev == null) {
    if (whiteSpace.length() > 0) {
      final ASTNode treeParent=leafElement.getTreeParent();
      treeParent.addChild(whiteSpaceElement,leafElement);
    }
  }
 else   if (!isSpaceTextElement(treePrev)) {
    final ASTNode treeParent=treePrev.getTreeParent();
    treeParent.addChild(whiteSpaceElement,treePrev);
  }
 else   if (!isWhiteSpaceElement(treePrev)) {
    return getWhiteSpaceBefore(leafElement);
  }
 else {
    final CompositeElement treeParent=(CompositeElement)treePrev.getTreeParent();
    treeParent.replaceChild(treePrev,whiteSpaceElement);
  }
  return getWhiteSpaceBefore(leafElement);
}
