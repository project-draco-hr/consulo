{
  if (LOG.isDebugEnabled()) {
    LOG.debug("Retrieving directory content for " + directory);
  }
  CvsInfo cvsInfo=CvsEntriesManager.getInstance().getCvsInfoFor(directory);
  DirectoryContent result=new DirectoryContent(cvsInfo);
  VirtualFile[] children=CvsVfsUtil.getChildrenOf(directory);
  if (children == null)   children=VirtualFile.EMPTY_ARRAY;
  Collection<Entry> entries=cvsInfo.getEntries();
  HashMap<String,VirtualFile> nameToFileMap=new HashMap<String,VirtualFile>();
  for (  VirtualFile child : children) {
    nameToFileMap.put(child.getName(),child);
  }
  for (  final Entry entry : entries) {
    String fileName=entry.getFileName();
    if (entry.isDirectory()) {
      if (nameToFileMap.containsKey(fileName)) {
        VirtualFile virtualFile=nameToFileMap.get(fileName);
        if (isInContent(virtualFile)) {
          result.addDirectory(new VirtualFileEntry(virtualFile,entry));
        }
      }
 else       if (!entry.isRemoved() && !FileTypeManager.getInstance().isFileIgnored(fileName)) {
        result.addDeletedDirectory(entry);
      }
    }
 else {
      if (nameToFileMap.containsKey(fileName) || entry.isRemoved()) {
        VirtualFile virtualFile=nameToFileMap.get(fileName);
        if (isInContent(virtualFile)) {
          result.addFile(new VirtualFileEntry(virtualFile,entry));
        }
      }
 else       if (!entry.isAddedFile()) {
        result.addDeletedFile(entry);
      }
    }
    nameToFileMap.remove(fileName);
  }
  for (  final String name : nameToFileMap.keySet()) {
    VirtualFile unknown=nameToFileMap.get(name);
    if (unknown.isDirectory()) {
      if (isInContent(unknown)) {
        result.addUnknownDirectory(unknown);
      }
    }
 else {
      if (isInContent(unknown)) {
        boolean isIgnored=result.getCvsInfo().getIgnoreFilter().shouldBeIgnored(unknown.getName());
        if (isIgnored) {
          result.addIgnoredFile(unknown);
        }
 else {
          result.addUnknownFile(unknown);
        }
      }
    }
  }
  return result;
}
