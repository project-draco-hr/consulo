{
  Document document=e.getDocument();
  if (UndoManagerImpl.isCopy(document))   return;
  if (allEditorsAreViewersFor(document))   return;
  if (!shouldRecordActions(document))   return;
  if (ApplicationManager.getApplication().isDisposeInProgress())   return;
  UndoManagerImpl undoManager=getUndoManager();
  if (!undoManager.isActive() || !isUndoable(document)) {
    registerNonUndoableAction(document);
    return;
  }
  if (undoManager.isUndoInProgress() || undoManager.isRedoInProgress()) {
    if (document.getUserData(UNDOING_EDITOR_CHANGE) != Boolean.TRUE) {
      LOG.error("Do not change documents during undo as it will break undo sequence.");
    }
  }
  registerUndoableAction(e);
}
