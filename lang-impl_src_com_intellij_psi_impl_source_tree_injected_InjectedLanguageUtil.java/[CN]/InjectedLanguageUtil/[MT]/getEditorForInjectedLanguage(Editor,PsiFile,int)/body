{
  if (editor == null || file == null || editor instanceof EditorWindow)   return editor;
  PsiFile injectedFile=findInjectedPsiAt(file,offset);
  if (injectedFile == null)   return editor;
  Document document=PsiDocumentManager.getInstance(editor.getProject()).getDocument(injectedFile);
  DocumentWindowImpl documentWindow=(DocumentWindowImpl)document;
  SelectionModel selectionModel=editor.getSelectionModel();
  if (selectionModel.hasSelection()) {
    int selstart=selectionModel.getSelectionStart();
    int selend=selectionModel.getSelectionEnd();
    if (!documentWindow.containsRange(selstart,selend)) {
      return editor;
    }
  }
  return EditorWindow.create(documentWindow,(EditorImpl)editor,injectedFile);
}
