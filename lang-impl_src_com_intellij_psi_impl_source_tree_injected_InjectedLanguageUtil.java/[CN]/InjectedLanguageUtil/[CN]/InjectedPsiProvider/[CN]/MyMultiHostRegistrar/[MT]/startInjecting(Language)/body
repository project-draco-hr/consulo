{
  relevantRangesInHostDocument=new SmartList<TextRange>();
  prefixes=new SmartList<String>();
  suffixes=new SmartList<String>();
  injectionHosts=new SmartList<PsiLanguageInjectionHost>();
  escapers=new SmartList<LiteralTextEscaper<? extends PsiLanguageInjectionHost>>();
  shreds=new SmartList<PsiLanguageInjectionHost.Shred>();
  outChars=new StringBuilder();
  if (!cleared) {
    clear();
    throw new IllegalStateException("Seems you haven't called doneInjecting()");
  }
  if (LanguageParserDefinitions.INSTANCE.forLanguage(language) == null) {
    throw new UnsupportedOperationException("Cannot inject language '" + language + "' since its getParserDefinition() returns null");
  }
  myLanguage=language;
  FileViewProvider viewProvider=myHostPsiFile.getViewProvider();
  myHostVirtualFile=viewProvider.getVirtualFile();
  myHostDocument=(DocumentEx)viewProvider.getDocument();
  return this;
}
