{
  Charset charset=dodetectCharset(virtualFile,content);
  charset=charset == null ? EncodingManager.getInstance().getDefaultCharset() : charset;
  if (virtualFile.getFileType() == StdFileTypes.PROPERTIES && EncodingManager.getInstance().isNative2AsciiForPropertiesFiles(virtualFile)) {
    charset=Native2AsciiCharset.wrap(charset);
  }
  virtualFile.setCharset(charset);
  return charset;
}
