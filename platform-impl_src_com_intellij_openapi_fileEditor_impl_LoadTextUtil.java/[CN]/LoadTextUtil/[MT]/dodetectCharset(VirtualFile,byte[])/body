{
  CharsetSettings settings=CharsetSettings.getInstance();
  boolean shouldGuess=settings != null && settings.isUseUTFGuessing();
  CharsetToolkit toolkit=shouldGuess ? new CharsetToolkit(content,CharsetToolkit.getIDEOptionsCharset()) : null;
  virtualFile.putUserData(UTF_CHARSET_WAS_DETECTED_FROM_BYTES,null);
  if (shouldGuess) {
    toolkit.setEnforce8Bit(true);
    Charset charset=toolkit.guessFromBOM();
    if (charset != null) {
      virtualFile.putUserData(UTF_CHARSET_WAS_DETECTED_FROM_BYTES,Boolean.TRUE);
      return charset;
    }
    CharsetToolkit.GuessedEncoding guessed=toolkit.guessFromContent(content.length);
    if (guessed == CharsetToolkit.GuessedEncoding.VALID_UTF8) {
      virtualFile.putUserData(UTF_CHARSET_WAS_DETECTED_FROM_BYTES,Boolean.TRUE);
      return CharsetToolkit.UTF8_CHARSET;
    }
  }
  FileType fileType=virtualFile.getFileType();
  String charsetName=fileType.getCharset(virtualFile);
  if (charsetName == null) {
    Charset saved=EncodingManager.getInstance().getEncoding(virtualFile,true);
    if (saved != null)     return saved;
  }
  return CharsetToolkit.forName(charsetName);
}
