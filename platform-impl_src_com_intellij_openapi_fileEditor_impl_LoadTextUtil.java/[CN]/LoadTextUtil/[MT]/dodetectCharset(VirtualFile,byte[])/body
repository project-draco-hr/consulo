{
  CharsetSettings settings=CharsetSettings.getInstance();
  boolean shouldGuess=settings != null && settings.isUseUTFGuessing();
  CharsetToolkit toolkit=shouldGuess ? new CharsetToolkit(content,CharsetToolkit.getIDEOptionsCharset()) : null;
  if (shouldGuess) {
    toolkit.setEnforce8Bit(true);
    Charset charset=toolkit.guessFromBOM();
    if (charset != null)     return charset;
    CharsetToolkit.GuessedEncoding guessed=toolkit.guessFromContent(content.length);
    if (guessed == CharsetToolkit.GuessedEncoding.VALID_UTF8)     return CharsetToolkit.UTF8_CHARSET;
  }
  FileType fileType=virtualFile.getFileType();
  String charsetName=fileType.getCharset(virtualFile);
  if (charsetName == null) {
    Charset saved=EncodingManager.getInstance().getEncoding(virtualFile,true);
    if (saved != null)     return saved;
  }
  return CharsetToolkit.forName(charsetName);
}
