{
  final PsiManager manager=testClassFilter.getPsiManager();
  final Project project=manager.getProject();
  GlobalSearchScope projectScopeWithoutLibraries=GlobalSearchScope.projectScope(project);
  final GlobalSearchScope scope=projectScopeWithoutLibraries.intersectWith(testClassFilter.getScope());
  ClassInheritorsSearch.search(testClassFilter.getBase(),scope,true).forEach(new PsiElementProcessorAdapter<PsiClass>(new PsiElementProcessor<PsiClass>(){
    public boolean execute(    final PsiClass aClass){
      if (testClassFilter.isAccepted(aClass))       found.add(aClass);
      return true;
    }
  }
));
  final PsiMethod[] suiteMethods=ApplicationManager.getApplication().runReadAction(new Computable<PsiMethod[]>(){
    public PsiMethod[] compute(){
      return JavaPsiFacade.getInstance(project).getShortNamesCache().getMethodsByName(JUnitUtil.SUITE_METHOD_NAME,scope);
    }
  }
);
  for (  final PsiMethod method : suiteMethods) {
    final PsiClass containingClass=ApplicationManager.getApplication().runReadAction(new Computable<PsiClass>(){
      public PsiClass compute(){
        return method.getContainingClass();
      }
    }
);
    if (containingClass == null)     continue;
    if (containingClass instanceof PsiAnonymousClass)     continue;
    if (containingClass.hasModifierProperty(PsiModifier.ABSTRACT))     continue;
    if (containingClass.getContainingClass() != null && !containingClass.hasModifierProperty(PsiModifier.STATIC))     continue;
    if (ApplicationManager.getApplication().runReadAction(new Computable<Boolean>(){
      public Boolean compute(){
        return JUnitUtil.isSuiteMethod(method,project);
      }
    }
).booleanValue()) {
      found.add(containingClass);
    }
  }
  boolean hasJunit4=addAnnotatedMethodsAnSubclasses(manager,scope,testClassFilter,found,"org.junit.Test",true);
  hasJunit4|=addAnnotatedMethodsAnSubclasses(manager,scope,testClassFilter,found,"org.junit.runner.RunWith",false);
  return hasJunit4;
}
