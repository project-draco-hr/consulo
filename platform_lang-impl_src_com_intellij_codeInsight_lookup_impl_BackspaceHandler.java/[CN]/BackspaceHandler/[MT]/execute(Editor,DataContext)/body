{
  LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(editor);
  if (lookup == null) {
    myOriginalHandler.execute(editor,dataContext);
    return;
  }
  boolean toRestart=false;
  final String prefix=lookup.getAdditionalPrefix();
  if (prefix.length() > 0) {
    lookup.setAdditionalPrefix(prefix.substring(0,prefix.length() - 1));
  }
 else {
    toRestart=lookup.getLookupStart() < editor.getCaretModel().getOffset();
  }
  lookup.performGuardedChange(new Runnable(){
    @Override public void run(){
      myOriginalHandler.execute(editor,dataContext);
    }
  }
);
  if (prefix.length() > 0) {
    return;
  }
  if (toRestart) {
    final CompletionProcess process=CompletionService.getCompletionService().getCurrentCompletion();
    if (process instanceof CompletionProgressIndicator) {
      ((CompletionProgressIndicator)process).restartCompletion();
      return;
    }
  }
  lookup.hide();
}
