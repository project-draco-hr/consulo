{
  if (oldExpr.getParent() == null || oldExpr.getParent().getNode() == null) {
    throw new IncorrectOperationException();
  }
  if (oldExpr.getParent() instanceof GrParenthesizedExpr && newExpr instanceof GrReferenceExpression) {
    return ((GrExpression)oldExpr.getParent()).replaceWithExpression(newExpr);
  }
  GroovyElementFactory factory=GroovyElementFactory.getInstance(oldExpr.getProject());
  if (oldExpr.getParent() instanceof GrExpression) {
    GrExpression parentExpr=(GrExpression)oldExpr.getParent();
    if (getExprPriorityLevel(parentExpr) >= getExprPriorityLevel(newExpr)) {
      newExpr=factory.createParenthesizedExpr(newExpr);
    }
  }
  ASTNode parentNode=oldExpr.getParent().getNode();
  ASTNode newNode=newExpr.getNode();
  parentNode.replaceChild(oldExpr.getNode(),newNode);
  if (!(newNode.getPsi() instanceof GrExpression)) {
    throw new IncorrectOperationException();
  }
  return ((GrExpression)newNode.getPsi());
}
