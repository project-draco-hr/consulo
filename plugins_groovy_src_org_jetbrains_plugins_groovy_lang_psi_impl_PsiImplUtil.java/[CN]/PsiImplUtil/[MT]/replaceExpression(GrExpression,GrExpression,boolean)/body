{
  PsiElement oldParent=oldExpr.getParent();
  if (oldParent == null)   throw new PsiInvalidElementAccessException(oldExpr);
  if (newExpr instanceof GrApplicationStatement && !(oldExpr instanceof GrApplicationStatement)) {
    GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(oldExpr.getProject());
    newExpr=factory.createMethodCallByAppCall(((GrApplicationStatement)newExpr));
  }
  if (removeUnnecessaryParentheses && oldParent instanceof GrParenthesizedExpression && !(oldParent.getParent() instanceof GrArgumentLabel)) {
    return ((GrExpression)oldParent).replaceWithExpression(newExpr,removeUnnecessaryParentheses);
  }
  if (getRegexAtTheBeginning(newExpr) != null && isAfterIdentifier(oldExpr)) {
    final PsiElement copy=newExpr.copy();
    final GrLiteral regex=getRegexAtTheBeginning(copy);
    LOG.assertTrue(regex != null);
    final GrLiteral stringLiteral=GrStringUtil.createStringFromRegex(regex);
    if (regex == copy) {
      return oldExpr.replaceWithExpression(stringLiteral,removeUnnecessaryParentheses);
    }
 else {
      regex.replace(stringLiteral);
      return oldExpr.replaceWithExpression((GrExpression)copy,removeUnnecessaryParentheses);
    }
  }
  GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(oldExpr.getProject());
  if (oldParent instanceof GrStringInjection) {
    if (newExpr instanceof GrString || newExpr instanceof GrLiteral && ((GrLiteral)newExpr).getValue() instanceof String) {
      return GrStringUtil.replaceStringInjectionByLiteral((GrStringInjection)oldParent,(GrLiteral)newExpr);
    }
 else {
      newExpr=factory.createExpressionFromText("{" + newExpr.getText() + "}");
      oldParent.getNode().replaceChild(oldExpr.getNode(),newExpr.getNode());
      return newExpr;
    }
  }
  if (PsiTreeUtil.getParentOfType(oldExpr,GrStringInjection.class,false,GrCodeBlock.class) != null) {
    final PsiElement replaced=oldExpr.replace(newExpr);
    final GrStringInjection stringInjection=PsiTreeUtil.getParentOfType(replaced,GrStringInjection.class);
    GrStringUtil.wrapInjection(stringInjection);
    return stringInjection.getClosableBlock();
  }
  if (oldParent instanceof GrExpression && !(oldParent instanceof GrParenthesizedExpression)) {
    GrExpression addedParenth=addParenthesesIfNeeded(newExpr,oldExpr,(GrExpression)oldParent);
    if (newExpr != addedParenth) {
      return oldExpr.replaceWithExpression(addedParenth,removeUnnecessaryParentheses);
    }
  }
  if (oldExpr instanceof GrClosableBlock && !(newExpr instanceof GrClosableBlock) && oldParent instanceof GrMethodCallExpression&& ArrayUtil.contains(oldExpr,((GrMethodCallExpression)oldParent).getClosureArguments())) {
    return ((GrMethodCallExpression)oldParent).replaceClosureArgument((GrClosableBlock)oldExpr,newExpr);
  }
  newExpr=(GrExpression)oldExpr.replace(newExpr);
  if (newExpr instanceof GrParenthesizedExpression) {
    final GrCommandArgumentList commandArgList=PsiTreeUtil.getParentOfType(oldParent,GrCommandArgumentList.class,true,GrCodeBlock.class,GrParenthesizedExpression.class);
    if (commandArgList != null) {
      final PsiElement[] args=commandArgList.getAllArguments();
      if (PsiTreeUtil.isAncestor(args[0],newExpr,true)) {
        final PsiElement parent=commandArgList.getParent();
        LOG.assertTrue(parent instanceof GrApplicationStatement);
        return (GrExpression)parent.replace(factory.createExpressionFromText(((GrApplicationStatement)parent).getInvokedExpression().getText() + "(" + commandArgList.getText()+ ")"));
      }
    }
  }
  return newExpr;
}
