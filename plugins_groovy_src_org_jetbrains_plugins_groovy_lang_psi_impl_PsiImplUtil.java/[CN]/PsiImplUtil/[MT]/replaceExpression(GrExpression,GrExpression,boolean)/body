{
  ASTNode oldNode=oldExpr.getNode();
  ASTNode parentNode=oldExpr.getParent().getNode();
  if (oldExpr.getParent() == null || parentNode == null) {
    throw new IncorrectOperationException();
  }
  if (removeUnnecessaryParentheses) {
    if (oldExpr.getParent() instanceof GrParenthesizedExpression && getExprPriorityLevel(newExpr) == 0) {
      return ((GrExpression)oldExpr.getParent()).replaceWithExpression(newExpr,removeUnnecessaryParentheses);
    }
  }
  GroovyElementFactory factory=GroovyElementFactory.getInstance(oldExpr.getProject());
  if (oldExpr.getParent() instanceof GrExpression) {
    GrExpression parentExpr=(GrExpression)oldExpr.getParent();
    int parentPriorityLevel=getExprPriorityLevel(parentExpr);
    int newPriorityLevel=getExprPriorityLevel(newExpr);
    if (parentPriorityLevel > newPriorityLevel) {
      newExpr=factory.createParenthesizedExpr(newExpr);
    }
 else     if (parentPriorityLevel == newPriorityLevel && parentPriorityLevel != 0) {
      if (parentExpr instanceof GrBinaryExpression) {
        GrBinaryExpression binaryExpression=(GrBinaryExpression)parentExpr;
        if (isNotAssociative(binaryExpression) && oldExpr.equals(binaryExpression.getRightOperand())) {
          newExpr=factory.createParenthesizedExpr(newExpr);
        }
      }
    }
  }
  ASTNode newNode=newExpr.getNode();
  parentNode.replaceChild(oldNode,newNode);
  if (!(newNode.getPsi() instanceof GrExpression)) {
    throw new IncorrectOperationException();
  }
  return ((GrExpression)newNode.getPsi());
}
