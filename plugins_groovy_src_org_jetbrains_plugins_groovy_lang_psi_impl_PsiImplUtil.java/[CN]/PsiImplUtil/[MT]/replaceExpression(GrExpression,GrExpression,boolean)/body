{
  PsiElement oldParent=oldExpr.getParent();
  if (oldParent == null)   throw new PsiInvalidElementAccessException(oldExpr);
  if (newExpr instanceof GrApplicationStatement && !(oldExpr instanceof GrApplicationStatement)) {
    GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(oldExpr.getProject());
    newExpr=factory.createMethodCallByAppCall(((GrApplicationStatement)newExpr));
  }
  if (removeUnnecessaryParentheses && oldParent instanceof GrParenthesizedExpression && !(oldParent.getParent() instanceof GrArgumentLabel)) {
    return ((GrExpression)oldParent).replaceWithExpression(newExpr,removeUnnecessaryParentheses);
  }
  GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(oldExpr.getProject());
  if (GrStringUtil.isReplacedExpressionInGStringInjection(oldExpr)) {
    if (!(newExpr instanceof GrReferenceExpression)) {
      newExpr=factory.createExpressionFromText("{" + newExpr.getText() + "}");
    }
  }
 else   if (oldParent instanceof GrExpression && !(oldParent instanceof GrParenthesizedExpression)) {
    GrExpression result=addParenthesesIfNeeded(newExpr,oldExpr,(GrExpression)oldParent);
    if (result != null)     return result;
  }
  if (oldExpr instanceof GrClosableBlock && !(newExpr instanceof GrClosableBlock) && oldParent instanceof GrMethodCallExpression&& ArrayUtil.contains(oldExpr,((GrMethodCallExpression)oldParent).getClosureArguments())) {
    return ((GrMethodCallExpression)oldParent).replaceClosureArgument((GrClosableBlock)oldExpr,newExpr);
  }
 else {
    return (GrExpression)oldExpr.replace(newExpr);
  }
}
