{
  final DataContext dataContext=event.getDataContext();
  final Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return;
  }
  final VirtualFile[] virtualFiles=PlatformDataKeys.VIRTUAL_FILE_ARRAY.getData(dataContext);
  if (virtualFiles == null) {
    return;
  }
  final Set<VirtualFile> excludedFiles=ContainerUtilRt.newHashSet();
  final VirtualFile projectVirtualDirectory;
  VirtualFile projectBaseDir=project.getBaseDir();
  if (projectBaseDir != null && projectBaseDir.isDirectory()) {
    projectVirtualDirectory=projectBaseDir.findChild(Project.DIRECTORY_STORE_FOLDER);
  }
 else {
    projectVirtualDirectory=null;
  }
  VirtualFile projectFile=project.getProjectFile();
  if (projectFile != null) {
    excludedFiles.add(projectFile);
  }
  VirtualFile workspaceFile=project.getWorkspaceFile();
  if (workspaceFile != null) {
    excludedFiles.add(workspaceFile);
  }
  for (  Module m : ModuleManager.getInstance(project).getModules()) {
    VirtualFile moduleFile=m.getModuleFile();
    if (moduleFile != null) {
      excludedFiles.add(moduleFile);
    }
  }
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  for (  VirtualFile file : virtualFiles) {
    VfsUtil.processFilesRecursively(file,new Processor<VirtualFile>(){
      @Override public boolean process(      VirtualFile file){
        if (file.isDirectory() || !file.isWritable() || excludedFiles.contains(file)|| fileTypeManager.isFileIgnored(file.getName())) {
          return true;
        }
        if (!file.getFileType().isBinary()) {
          changeLineSeparators(project,file);
        }
        return true;
      }
    }
,new Convertor<VirtualFile,Boolean>(){
      @Override public Boolean convert(      VirtualFile dir){
        return !dir.equals(projectVirtualDirectory) && !fileTypeManager.isFileIgnored(dir.getName());
      }
    }
);
  }
}
