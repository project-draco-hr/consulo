{
  CachedValue<T> value;
  if (dataHolder instanceof UserDataHolderEx) {
    UserDataHolderEx dh=(UserDataHolderEx)dataHolder;
    value=dh.getUserData(key);
    if (value instanceof CachedValueImpl && !((CachedValueImpl)value).isFromMyProject(myManager.getProject())) {
      value=null;
      dataHolder.putUserData(key,null);
    }
    if (value == null) {
      value=createCachedValue(provider,trackValue);
      assert((CachedValueImpl)value).isFromMyProject(myManager.getProject());
      value=dh.putUserDataIfAbsent(key,value);
    }
  }
 else {
synchronized (dataHolder) {
      value=dataHolder.getUserData(key);
      if (value instanceof CachedValueImpl && !((CachedValueImpl)value).isFromMyProject(myManager.getProject())) {
        value=null;
      }
      if (value == null) {
        value=createCachedValue(provider,trackValue);
        dataHolder.putUserData(key,value);
      }
    }
  }
  return value.getValue();
}
