def recordupdates(repo, action, branchmerge):
    'record merge actions to the dirstate'
    for a in action:
        (f, m) = a[:2]
        if (m == 'r'):
            if branchmerge:
                repo.dirstate.remove(f)
            else:
                repo.dirstate.forget(f)
        elif (m == 'a'):
            if (not branchmerge):
                repo.dirstate.add(f)
        elif (m == 'f'):
            repo.dirstate.forget(f)
        elif (m == 'e'):
            repo.dirstate.normallookup(f)
        elif (m == 'g'):
            if branchmerge:
                repo.dirstate.normaldirty(f)
            else:
                repo.dirstate.normal(f)
        elif (m == 'm'):
            (f2, fd, flag, move) = a[2:]
            if branchmerge:
                repo.dirstate.merge(fd)
                if (f != f2):
                    if move:
                        repo.dirstate.remove(f)
                    if (f != fd):
                        repo.dirstate.copy(f, fd)
                    else:
                        repo.dirstate.copy(f2, fd)
            else:
                repo.dirstate.normallookup(fd)
                if move:
                    repo.dirstate.forget(f)
        elif (m == 'd'):
            (f2, fd, flag) = a[2:]
            if ((not f2) and (f not in repo.dirstate)):
                continue
            if branchmerge:
                repo.dirstate.add(fd)
                if f:
                    repo.dirstate.remove(f)
                    repo.dirstate.copy(f, fd)
                if f2:
                    repo.dirstate.copy(f2, fd)
            else:
                repo.dirstate.normal(fd)
                if f:
                    repo.dirstate.forget(f)
