{
  if (name.length() == 0) {
    return null;
  }
  final VirtualFile[] a=asArray();
  if (a != null) {
    for (    VirtualFile file : a) {
      if (namesEqual(name,file.getName()))       return (NewVirtualFile)file;
    }
    return createIfNotFound ? createAndFindChildWithEventFire(name) : null;
  }
  final Map<String,VirtualFile> map;
  final VirtualFile file;
synchronized (this) {
    map=ensureAsMap();
    file=map.get(name);
  }
  if (file == NullVirtualFile.INSTANCE) {
    return createIfNotFound ? createAndFindChildWithEventFire(name) : null;
  }
  if (file != null)   return (NewVirtualFile)file;
  final NewVirtualFileSystem delegate=getFileSystem();
  VirtualFile fake=new FakeVirtualFile(name,this);
  String name1=delegate.getCanonicallyCasedName(fake);
  int id=ourPersistence.getId(this,name1);
  if (id > 0) {
synchronized (this) {
      VirtualFile alreadyCreated=map.get(name1);
      if (alreadyCreated != null) {
        if (alreadyCreated == NullVirtualFile.INSTANCE) {
          return createIfNotFound ? createAndFindChildWithEventFire(name) : null;
        }
        return (NewVirtualFile)alreadyCreated;
      }
      NewVirtualFile child=createChild(name1,id);
      map.put(name1,child);
      return child;
    }
  }
synchronized (this) {
    if (myChildren instanceof Map) {
      ensureAsMap().put(name1,NullVirtualFile.INSTANCE);
    }
  }
  return null;
}
