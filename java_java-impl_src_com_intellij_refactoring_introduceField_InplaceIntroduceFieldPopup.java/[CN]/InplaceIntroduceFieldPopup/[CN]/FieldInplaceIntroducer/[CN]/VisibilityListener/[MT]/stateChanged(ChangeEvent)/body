{
  new WriteCommandAction(myProject){
    @Override protected void run(    Result result) throws Throwable {
      final Document document=myEditor.getDocument();
      PsiDocumentManager.getInstance(getProject()).commitDocument(document);
      final PsiVariable variable=getVariable();
      LOG.assertTrue(variable != null);
      final PsiModifierList modifierList=variable.getModifierList();
      LOG.assertTrue(modifierList != null);
      int textOffset=modifierList.getTextOffset();
      String visibility=myIntroduceFieldPanel.getFieldVisibility();
      if (visibility == PsiModifier.PACKAGE_LOCAL) {
        visibility="";
      }
      final String modifierListText=modifierList.getText();
      int length=PsiModifier.PUBLIC.length();
      int idx=modifierListText.indexOf(PsiModifier.PUBLIC);
      if (idx == -1) {
        idx=modifierListText.indexOf(PsiModifier.PROTECTED);
        length=PsiModifier.PROTECTED.length();
      }
      if (idx == -1) {
        idx=modifierListText.indexOf(PsiModifier.PRIVATE);
        length=PsiModifier.PRIVATE.length();
      }
      final int startOffset=textOffset + idx;
      final int endOffset;
      if (idx == -1) {
        endOffset=startOffset;
      }
 else {
        endOffset=textOffset + length;
      }
      document.replaceString(startOffset,endOffset,visibility);
    }
  }
.execute();
}
