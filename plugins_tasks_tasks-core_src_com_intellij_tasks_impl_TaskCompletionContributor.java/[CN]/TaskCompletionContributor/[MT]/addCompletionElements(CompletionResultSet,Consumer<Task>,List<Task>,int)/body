{
  final AutoCompletionPolicy completionPolicy=ApplicationManager.getApplication().isUnitTestMode() ? AutoCompletionPolicy.ALWAYS_AUTOCOMPLETE : AutoCompletionPolicy.NEVER_AUTOCOMPLETE;
  for (  final Task task : items) {
    LookupElementBuilder builder=LookupElementBuilder.create(task,task.getId()).setIcon(task.getIcon()).addLookupString(task.getSummary()).setTailText(" " + task.getSummary(),true).setInsertHandler(new InsertHandler<LookupElement>(){
      @Override public void handleInsert(      InsertionContext context,      LookupElement item){
        Document document=context.getEditor().getDocument();
        String s=task.getId() + ": " + task.getSummary();
        document.replaceString(context.getStartOffset(),context.getTailOffset(),s);
        context.getEditor().getCaretModel().moveToOffset(context.getStartOffset() + s.length());
        consumer.consume(task);
      }
    }
);
    if (task.isClosed()) {
      builder=builder.setStrikeout();
    }
    result.addElement(PrioritizedLookupElement.withGrouping(builder.withAutoCompletionPolicy(completionPolicy),index--));
  }
}
