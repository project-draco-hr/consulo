{
  PsiFile file=parameters.getOriginalFile();
  final Consumer<Task> consumer=file.getUserData(KEY);
  if (CompletionService.getCompletionService().getAdvertisementText() == null) {
    final String shortcut=getActionShortcut(IdeActions.ACTION_QUICK_JAVADOC);
    if (shortcut != null) {
      CompletionService.getCompletionService().setAdvertisementText("Pressing " + shortcut + " would show task description and comments");
    }
  }
  if (consumer != null) {
    String text=parameters.getOriginalFile().getText();
    int i=text.lastIndexOf(' ',parameters.getOffset() - 1) + 1;
    final String prefix=text.substring(i,parameters.getOffset());
    if (parameters.getInvocationCount() == 0 && !file.getUserData(AUTO_POPUP_KEY)) {
      return;
    }
    result=result.withPrefixMatcher(new PlainPrefixMatcher(prefix));
    final TaskSearchSupport searchSupport=new TaskSearchSupport(file.getProject());
    List<Task> items=searchSupport.getItems(prefix,true);
    addCompletionElements(result,consumer,items,-10000);
    Future<List<Task>> future=ApplicationManager.getApplication().executeOnPooledThread(new Callable<List<Task>>(){
      @Override public List<Task> call(){
        return searchSupport.getItems(prefix,false);
      }
    }
);
    while (true) {
      try {
        List<Task> tasks=future.get(100,TimeUnit.MILLISECONDS);
        if (tasks != null) {
          addCompletionElements(result,consumer,tasks,0);
          return;
        }
      }
 catch (      ProcessCanceledException e) {
        throw e;
      }
catch (      Exception ignore) {
      }
      ProgressManager.checkCanceled();
    }
  }
}
