{
  super.visitForeachStatement(statement);
  final PsiExpression value=statement.getIteratedValue();
  final PsiParameter psiParameter=statement.getIterationParameter();
  if (value != null) {
    final TypeView typeView=new TypeView(value);
    PsiType psiType=typeView.getType();
    if (psiType instanceof PsiArrayType) {
      psiType=((PsiArrayType)psiType).getComponentType();
    }
 else     if (psiType instanceof PsiClassType) {
      final PsiClassType.ClassResolveResult resolveResult=((PsiClassType)psiType).resolveGenerics();
      final PsiClass psiClass=resolveResult.getElement();
      final Project project=statement.getProject();
      final PsiClass iterableClass=JavaPsiFacade.getInstance(project).findClass("java.lang.Iterable",GlobalSearchScope.allScope(project));
      if (iterableClass == null)       return;
      if (!InheritanceUtil.isInheritorOrSelf(psiClass,iterableClass,true)) {
        findConversionOrFail(value,value,typeView.getTypePair());
        return;
      }
      final PsiSubstitutor iterableParamSubstitutor=TypeConversionUtil.getClassSubstitutor(iterableClass,psiClass,PsiSubstitutor.EMPTY);
      LOG.assertTrue(iterableParamSubstitutor != null);
      final PsiTypeParameter[] typeParameters=iterableClass.getTypeParameters();
      LOG.assertTrue(typeParameters.length == 1);
      psiType=resolveResult.getSubstitutor().substitute(iterableParamSubstitutor.substitute(typeParameters[0]));
      if (psiType instanceof PsiWildcardType) {
        psiType=((PsiWildcardType)psiType).getExtendsBound();
      }
    }
 else {
      return;
    }
    final TypeView left=new TypeView(psiParameter,null,null);
    if (TypeInfection.getInfection(left,typeView) == TypeInfection.LEFT_INFECTED) {
      PsiType iterableType;
      final PsiType typeViewType=typeView.getType();
      if (typeViewType instanceof PsiArrayType) {
        iterableType=left.getType().createArrayType();
      }
 else {
        final PsiClass iterableClass=PsiUtil.resolveClassInType(typeViewType);
        LOG.assertTrue(iterableClass != null);
        final PsiTypeParameter[] typeParameters=iterableClass.getTypeParameters();
        LOG.assertTrue(typeParameters.length == 1);
        final Map<PsiTypeParameter,PsiType> substMap=Collections.singletonMap(typeParameters[0],left.getType());
        final PsiElementFactory factory=JavaPsiFacade.getElementFactory(iterableClass.getProject());
        iterableType=factory.createType(iterableClass,factory.createSubstitutor(substMap));
      }
      myLabeler.migrateExpressionType(value,iterableType,myStatement,TypeConversionUtil.isAssignable(iterableType,typeViewType),true);
    }
 else {
      processVariable(psiParameter,value,psiType,null,null,false);
    }
  }
}
