{
  if (expr != null && expr.getParent() instanceof PsiExpressionStatement) {
    FeatureUsageTracker.getInstance().triggerFeatureUsed("refactoring.introduceVariable.incompleteStatement");
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("expression:" + expr);
  }
  if (expr == null) {
    if (ReassignVariableUtil.reassign(editor))     return false;
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("selected.block.should.represent.an.expression"));
    showErrorMessage(project,editor,message);
    return false;
  }
  final PsiType originalType=RefactoringUtil.getTypeByExpressionWithExpectedType(expr);
  if (originalType == null) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("unknown.expression.type"));
    showErrorMessage(project,editor,message);
    return false;
  }
  if (PsiType.VOID.equals(originalType)) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("selected.expression.has.void.type"));
    showErrorMessage(project,editor,message);
    return false;
  }
  final PsiElement physicalElement=expr.getUserData(ElementToWorkOn.PARENT);
  final PsiElement anchorStatement=RefactoringUtil.getParentStatement(physicalElement != null ? physicalElement : expr,false);
  if (anchorStatement == null) {
    return parentStatementNotFound(project,editor);
  }
  if (anchorStatement instanceof PsiExpressionStatement) {
    PsiExpression enclosingExpr=((PsiExpressionStatement)anchorStatement).getExpression();
    if (enclosingExpr instanceof PsiMethodCallExpression) {
      PsiMethod method=((PsiMethodCallExpression)enclosingExpr).resolveMethod();
      if (method != null && method.isConstructor()) {
        String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("invalid.expression.context"));
        showErrorMessage(project,editor,message);
        return false;
      }
    }
  }
  final PsiElement tempContainer=anchorStatement.getParent();
  if (!(tempContainer instanceof PsiCodeBlock) && !isLoopOrIf(tempContainer)) {
    String message=RefactoringBundle.message("refactoring.is.not.supported.in.the.current.context",REFACTORING_NAME);
    showErrorMessage(project,editor,message);
    return false;
  }
  if (!NotInSuperCallOccurenceFilter.INSTANCE.isOK(expr)) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("cannot.introduce.variable.in.super.constructor.call"));
    showErrorMessage(project,editor,message);
    return false;
  }
  final PsiFile file=anchorStatement.getContainingFile();
  LOG.assertTrue(file != null,"expr.getContainingFile() == null");
  if (!CommonRefactoringUtil.checkReadOnlyStatus(project,file))   return false;
  PsiElement containerParent=tempContainer;
  PsiElement lastScope=tempContainer;
  while (true) {
    if (containerParent instanceof PsiFile)     break;
    if (containerParent instanceof PsiMethod)     break;
    containerParent=containerParent.getParent();
    if (containerParent instanceof PsiCodeBlock) {
      lastScope=containerParent;
    }
  }
  final ExpressionOccurenceManager occurenceManager=new ExpressionOccurenceManager(expr,lastScope,NotInSuperCallOccurenceFilter.INSTANCE);
  final PsiExpression[] occurrences=occurenceManager.getOccurences();
  final PsiElement anchorStatementIfAll=occurenceManager.getAnchorStatementForAll();
  final LinkedHashMap<OccurrencesChooser.ReplaceChoice,PsiExpression[]> occurrencesMap=new LinkedHashMap<OccurrencesChooser.ReplaceChoice,PsiExpression[]>();
  final boolean hasWriteAccess=OccurrencesChooser.fillChoices(expr,occurrences,occurrencesMap);
  final PsiElement nameSuggestionContext=editor != null ? file.findElementAt(editor.getCaretModel().getOffset()) : null;
  final RefactoringSupportProvider supportProvider=LanguageRefactoringSupport.INSTANCE.forLanguage(expr.getLanguage());
  final boolean isInplaceAvailableOnDataContext=supportProvider != null && editor.getSettings().isVariableInplaceRenameEnabled() && supportProvider.isInplaceIntroduceAvailable(expr,nameSuggestionContext) && !ApplicationManager.getApplication().isUnitTestMode();
  final boolean inFinalContext=occurenceManager.isInFinalContext();
  final InputValidator validator=new InputValidator(this,project,anchorStatementIfAll,anchorStatement,occurenceManager);
  final TypeSelectorManagerImpl typeSelectorManager=new TypeSelectorManagerImpl(project,originalType,expr,occurrences);
  final Pass<OccurrencesChooser.ReplaceChoice> callback=new Pass<OccurrencesChooser.ReplaceChoice>(){
    @Override public void pass(    final OccurrencesChooser.ReplaceChoice choice){
      final Ref<SmartPsiElementPointer<PsiVariable>> variable=new Ref<SmartPsiElementPointer<PsiVariable>>();
      final IntroduceVariableSettings settings=getSettings(project,editor,expr,occurrences,typeSelectorManager,inFinalContext,hasWriteAccess,validator,choice);
      if (!settings.isOK())       return;
      typeSelectorManager.setAllOccurences(choice != OccurrencesChooser.ReplaceChoice.NO);
      final TypeExpression expression=new TypeExpression(project,typeSelectorManager.getTypesForAll());
      final RangeMarker exprMarker=editor.getDocument().createRangeMarker(expr.getTextRange());
      final SuggestedNameInfo suggestedName=getSuggestedName(settings.getSelectedType(),expr);
      final List<RangeMarker> occurrenceMarkers=new ArrayList<RangeMarker>();
      for (      PsiExpression occurrence : occurrences) {
        occurrenceMarkers.add(editor.getDocument().createRangeMarker(occurrence.getTextRange()));
      }
      final Runnable runnable=introduce(project,expr,editor,anchorStatement,tempContainer,occurrences,anchorStatementIfAll,settings,variable);
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        public void run(){
          ApplicationManager.getApplication().runWriteAction(runnable);
          if (isInplaceAvailableOnDataContext) {
            final PsiVariable elementToRename=variable.get().getElement();
            if (elementToRename != null) {
              editor.getCaretModel().moveToOffset(elementToRename.getTextOffset());
              final PsiDeclarationStatement declarationStatement=PsiTreeUtil.getParentOfType(elementToRename,PsiDeclarationStatement.class);
              final SmartPsiElementPointer<PsiDeclarationStatement> pointer=SmartPointerManager.getInstance(project).createSmartPsiElementPointer(declarationStatement);
              editor.putUserData(ReassignVariableUtil.DECLARATION_KEY,pointer);
              editor.putUserData(ReassignVariableUtil.OCCURRENCES_KEY,occurrenceMarkers.toArray(new RangeMarker[occurrenceMarkers.size()]));
              final boolean cantChangeFinalModifier=hasWriteAccess || (inFinalContext && choice == OccurrencesChooser.ReplaceChoice.ALL);
              final VariableInplaceRenamer renamer=new VariableInplaceRenamer(elementToRename,editor){
                @Override protected void addAdditionalVariables(                TemplateBuilderImpl builder){
                  final PsiTypeElement typeElement=elementToRename.getTypeElement();
                  builder.replaceElement(typeElement,"Variable_Type",ReassignVariableUtil.createExpression(expression,typeElement.getText(),!cantChangeFinalModifier),false,true);
                  if (!cantChangeFinalModifier) {
                    builder.replaceElement(elementToRename.getModifierList(),"_FINAL_",new FinalExpression(project),false,true);
                  }
                }
              }
;
              renamer.setAdvertisementText(ReassignVariableUtil.getAdvertisementText(editor,declarationStatement,elementToRename.getType(),typeSelectorManager.getTypesForAll(),!cantChangeFinalModifier));
              renamer.performInplaceRename(false,new LinkedHashSet<String>(Arrays.asList(suggestedName.names)),new Consumer<Boolean>(){
                @Override public void consume(                Boolean apply){
                  if (apply) {
                    final Document document=editor.getDocument();
                    final PsiDeclarationStatement declarationStatement=pointer.getElement();
                    final PsiVariable psiVariable=declarationStatement != null ? (PsiVariable)declarationStatement.getDeclaredElements()[0] : null;
                    if (psiVariable != null) {
                      JavaRefactoringSettings.getInstance().INTRODUCE_LOCAL_CREATE_FINALS=psiVariable.hasModifierProperty(PsiModifier.FINAL);
                      FinalExpression.adjustLine(psiVariable,document);
                    }
                    int startOffset=exprMarker.getStartOffset();
                    final PsiReference referenceAt=file.findReferenceAt(startOffset);
                    if (referenceAt != null && referenceAt.resolve() instanceof PsiLocalVariable) {
                      startOffset=referenceAt.getElement().getTextRange().getEndOffset();
                    }
 else {
                      startOffset=document.getLineEndOffset(document.getLineNumber(startOffset));
                    }
                    editor.getCaretModel().moveToOffset(startOffset);
                    typeSelectorManager.typeSelected(ReassignVariableUtil.getVariableType(declarationStatement));
                  }
                  editor.putUserData(ReassignVariableUtil.DECLARATION_KEY,null);
                  for (                  RangeMarker occurrenceMarker : occurrenceMarkers) {
                    occurrenceMarker.dispose();
                  }
                  editor.putUserData(ReassignVariableUtil.OCCURRENCES_KEY,null);
                  exprMarker.dispose();
                }
              }
);
            }
          }
        }
      }
,REFACTORING_NAME,null);
    }
  }
;
  if (!isInplaceAvailableOnDataContext) {
    callback.pass(null);
  }
 else {
    new OccurrencesChooser(editor).showChooser(callback,occurrencesMap);
  }
  return true;
}
