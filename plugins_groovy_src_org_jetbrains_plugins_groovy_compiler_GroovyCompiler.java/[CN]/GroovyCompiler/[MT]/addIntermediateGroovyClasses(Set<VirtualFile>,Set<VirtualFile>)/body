{
  final Set<VirtualFile> initialFiles=new THashSet<VirtualFile>(allToCompile);
  final THashSet<VirtualFile> visited=new THashSet<VirtualFile>();
  for (  VirtualFile aClass : initialFiles) {
    if (visited.add(aClass)) {
      goForIntermediateFiles(aClass,allToCompile,new FactoryMap<VirtualFile,Set<VirtualFile>>(){
        @Override protected Set<VirtualFile> create(        final VirtualFile key){
          AccessToken accessToken=ApplicationManager.getApplication().acquireReadActionLock();
          try {
            return calcCodeReferenceDependencies(key,groovyFiles);
          }
  finally {
            accessToken.finish();
          }
        }
      }
,visited);
    }
  }
}
