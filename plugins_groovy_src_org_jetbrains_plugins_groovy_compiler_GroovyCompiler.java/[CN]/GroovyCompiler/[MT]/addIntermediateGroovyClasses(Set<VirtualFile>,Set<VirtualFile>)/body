{
  final Set<VirtualFile> initialFiles=new THashSet<VirtualFile>(allToCompile);
  final THashSet<VirtualFile> visited=new THashSet<VirtualFile>();
  for (  VirtualFile aClass : initialFiles) {
    if (visited.add(aClass)) {
      goForIntermediateFiles(aClass,allToCompile,new FactoryMap<VirtualFile,Set<VirtualFile>>(){
        @Override protected Set<VirtualFile> create(        final VirtualFile key){
          return ApplicationManager.getApplication().runReadAction(new Computable<Set<VirtualFile>>(){
            public Set<VirtualFile> compute(){
              return calcCodeReferenceDependencies(key,groovyFiles);
            }
          }
);
        }
      }
,visited);
    }
  }
}
