{
  final PsiType variableOrMethodType;
  if (variableOrMethod instanceof PsiVariable) {
    final PsiVariable variable=(PsiVariable)variableOrMethod;
    variableOrMethodType=variable.getType();
  }
 else   if (variableOrMethod instanceof PsiMethod) {
    final PsiMethod method=(PsiMethod)variableOrMethod;
    variableOrMethodType=method.getReturnType();
    if (PsiType.VOID.equals(variableOrMethodType)) {
      return Collections.emptyList();
    }
  }
 else {
    throw new IllegalArgumentException("PsiMethod or PsiVariable expected: " + variableOrMethod);
  }
  if (!(variableOrMethodType instanceof PsiClassType)) {
    return Collections.emptyList();
  }
  final PsiClassType variableOrMethodClassType=(PsiClassType)variableOrMethodType;
  final PsiClass variableOrMethodClass=variableOrMethodClassType.resolve();
  if (variableOrMethodClass == null) {
    return Collections.emptyList();
  }
  Set<PsiClass> weakestTypeClasses=new HashSet<PsiClass>();
  final GlobalSearchScope scope=variableOrMethod.getResolveScope();
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(variableOrMethod.getProject());
  final PsiClass lowerBoundClass;
  if (variableOrMethod instanceof PsiResourceVariable) {
    lowerBoundClass=facade.findClass(CommonClassNames.JAVA_LANG_AUTO_CLOSEABLE,scope);
    if (lowerBoundClass == null || variableOrMethodClass.equals(lowerBoundClass)) {
      return Collections.emptyList();
    }
    weakestTypeClasses.add(lowerBoundClass);
    final PsiResourceVariable resourceVariable=(PsiResourceVariable)variableOrMethod;
    @NonNls final String methodCallText=resourceVariable.getName() + ".close()";
    final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)facade.getElementFactory().createExpressionFromText(methodCallText,resourceVariable.getParent());
    if (!findWeakestType(methodCallExpression,weakestTypeClasses)) {
      return Collections.emptyList();
    }
  }
 else {
    lowerBoundClass=facade.findClass(CommonClassNames.JAVA_LANG_OBJECT,scope);
    if (lowerBoundClass == null || variableOrMethodClass.equals(lowerBoundClass)) {
      return Collections.emptyList();
    }
    weakestTypeClasses.add(lowerBoundClass);
  }
  final Query<PsiReference> query=ReferencesSearch.search(variableOrMethod,variableOrMethod.getUseScope());
  boolean hasUsages=false;
  for (  PsiReference reference : query) {
    if (reference == null) {
      continue;
    }
    hasUsages=true;
    PsiElement referenceElement=reference.getElement();
    PsiElement referenceParent=referenceElement.getParent();
    if (referenceParent instanceof PsiMethodCallExpression) {
      referenceElement=referenceParent;
      referenceParent=referenceElement.getParent();
    }
    final PsiElement referenceGrandParent=referenceParent.getParent();
    if (referenceParent instanceof PsiExpressionList) {
      if (!(referenceGrandParent instanceof PsiMethodCallExpression)) {
        return Collections.emptyList();
      }
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)referenceGrandParent;
      if (!findWeakestType(referenceElement,methodCallExpression,useParameterizedTypeForCollectionMethods,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceGrandParent instanceof PsiMethodCallExpression) {
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)referenceGrandParent;
      if (!findWeakestType(methodCallExpression,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiAssignmentExpression) {
      final PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)referenceParent;
      if (!findWeakestType(referenceElement,assignmentExpression,useRighthandTypeAsWeakestTypeInAssignments,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiVariable) {
      final PsiVariable variable=(PsiVariable)referenceParent;
      final PsiType type=variable.getType();
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiForeachStatement) {
      final PsiForeachStatement foreachStatement=(PsiForeachStatement)referenceParent;
      if (!Comparing.equal(foreachStatement.getIteratedValue(),referenceElement)) {
        return Collections.emptyList();
      }
      final PsiClass javaLangIterableClass=facade.findClass(CommonClassNames.JAVA_LANG_ITERABLE,scope);
      if (javaLangIterableClass == null) {
        return Collections.emptyList();
      }
      checkClass(javaLangIterableClass,weakestTypeClasses);
    }
 else     if (referenceParent instanceof PsiReturnStatement) {
      final PsiMethod containingMethod=PsiTreeUtil.getParentOfType(referenceParent,PsiMethod.class);
      if (containingMethod == null) {
        return Collections.emptyList();
      }
      final PsiType type=containingMethod.getReturnType();
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiReferenceExpression) {
      final PsiReferenceExpression referenceExpression=(PsiReferenceExpression)referenceParent;
      final PsiElement target=referenceExpression.resolve();
      if (!(target instanceof PsiField)) {
        return Collections.emptyList();
      }
      final PsiField field=(PsiField)target;
      final PsiClass containingClass=field.getContainingClass();
      checkClass(containingClass,weakestTypeClasses);
    }
 else     if (referenceParent instanceof PsiArrayInitializerExpression) {
      final PsiArrayInitializerExpression arrayInitializerExpression=(PsiArrayInitializerExpression)referenceParent;
      if (!findWeakestType(arrayInitializerExpression,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiThrowStatement) {
      final PsiThrowStatement throwStatement=(PsiThrowStatement)referenceParent;
      if (!findWeakestType(throwStatement,variableOrMethodClass,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiConditionalExpression) {
      final PsiConditionalExpression conditionalExpression=(PsiConditionalExpression)referenceParent;
      final PsiExpression condition=conditionalExpression.getCondition();
      if (referenceElement.equals(condition)) {
        return Collections.emptyList();
      }
      final PsiType type=ExpectedTypeUtils.findExpectedType(conditionalExpression,true);
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.emptyList();
      }
    }
 else     if (referenceParent instanceof PsiBinaryExpression) {
      final PsiBinaryExpression binaryExpression=(PsiBinaryExpression)referenceParent;
      final PsiType type=binaryExpression.getType();
      if (variableOrMethodType.equals(type)) {
        if (!checkType(type,weakestTypeClasses)) {
          return Collections.emptyList();
        }
      }
    }
 else     if (referenceParent instanceof PsiSwitchStatement) {
      return Collections.emptyList();
    }
 else     if (referenceParent instanceof PsiPrefixExpression) {
      return Collections.emptyList();
    }
 else     if (referenceParent instanceof PsiPostfixExpression) {
      return Collections.emptyList();
    }
 else     if (referenceParent instanceof PsiIfStatement) {
      return Collections.emptyList();
    }
 else     if (referenceParent instanceof PsiForStatement) {
      return Collections.emptyList();
    }
 else     if (referenceParent instanceof PsiNewExpression) {
      final PsiNewExpression newExpression=(PsiNewExpression)referenceParent;
      final PsiExpression qualifier=newExpression.getQualifier();
      if (qualifier != null) {
        final PsiType type=newExpression.getType();
        if (!(type instanceof PsiClassType)) {
          return Collections.emptyList();
        }
        final PsiClassType classType=(PsiClassType)type;
        final PsiClass innerClass=classType.resolve();
        if (innerClass == null) {
          return Collections.emptyList();
        }
        final PsiClass outerClass=innerClass.getContainingClass();
        if (outerClass != null) {
          checkClass(outerClass,weakestTypeClasses);
        }
      }
    }
    if (weakestTypeClasses.contains(variableOrMethodClass) || weakestTypeClasses.isEmpty()) {
      return Collections.emptyList();
    }
  }
  if (!hasUsages) {
    return Collections.emptyList();
  }
  weakestTypeClasses=filterAccessibleClasses(weakestTypeClasses,variableOrMethod);
  return weakestTypeClasses;
}
