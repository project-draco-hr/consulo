def write(self):
    if (not self._dirty):
        return
    st = self._opener('dirstate', 'w', atomictemp=True)
    now = int(util.fstat(st).st_mtime)
    cs = cStringIO.StringIO()
    copymap = self._copymap
    pack = struct.pack
    write = cs.write
    write(''.join(self._pl))
    for (f, e) in self._map.iteritems():
        if ((e[0] == 'n') and (e[3] == now)):
            e = (e[0], 0, (-1), (-1))
            self._map[f] = e
        if (f in copymap):
            f = ('%s\x00%s' % (f, copymap[f]))
        e = pack(_format, e[0], e[1], e[2], e[3], len(f))
        write(e)
        write(f)
    st.write(cs.getvalue())
    st.rename()
    self._dirty = self._dirtypl = False
