{
  HashMap<VirtualFile,Set<VirtualFile>> map=new HashMap<VirtualFile,Set<VirtualFile>>();
  for (  VirtualFile aFile : files) {
    VirtualFile directory=aFile.isDirectory() ? aFile : aFile.getParent();
    if (directory == null)     return VirtualFile.EMPTY_ARRAY;
    VirtualFile[] path=getPathComponents(directory);
    Set<VirtualFile> filesSet;
    final VirtualFile firstPart=path[0];
    if (map.containsKey(firstPart)) {
      filesSet=map.get(firstPart);
    }
 else {
      filesSet=new THashSet<VirtualFile>();
      map.put(firstPart,filesSet);
    }
    filesSet.add(directory);
  }
  ArrayList<VirtualFile> ancestorsList=new ArrayList<VirtualFile>();
  for (  Set<VirtualFile> filesSet : map.values()) {
    VirtualFile ancestor=null;
    for (    VirtualFile file : filesSet) {
      if (ancestor == null) {
        ancestor=file;
        continue;
      }
      ancestor=getCommonAncestor(ancestor,file);
    }
    ancestorsList.add(ancestor);
    filesSet.clear();
  }
  return toVirtualFileArray(ancestorsList);
}
