{
  final int startOffset=editor.getSelectionModel().getSelectionStart();
  final int endOffset=editor.getSelectionModel().getSelectionEnd();
  final PsiElement elementAtStart=file.findElementAt(startOffset);
  if (elementAtStart == null)   return null;
  final PsiElement elementAtEnd=file.findElementAt(endOffset == startOffset ? endOffset : endOffset - 1);
  if (elementAtEnd == null)   return null;
  PsiElement elementAt=PsiTreeUtil.findCommonParent(elementAtStart,elementAtEnd);
  if (elementAt instanceof XmlToken)   elementAt=elementAt.getParent();
  if (elementAt instanceof XmlText || elementAt instanceof XmlAttributeValue) {
    TextRange range;
    if (editor.getSelectionModel().hasSelection()) {
      range=new TextRange(startOffset,endOffset);
    }
 else {
      range=elementAt.getTextRange();
    }
    return Pair.create((XmlElement)elementAt,range);
  }
  return null;
}
