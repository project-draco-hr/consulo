{
  if (!(file instanceof PsiJavaFile) || isInJspFile(file))   return;
  PsiDirectory dir=file.getContainingDirectory();
  if (dir == null)   return;
  PsiPackage aPackage=dir.getPackage();
  if (aPackage == null)   return;
  String packageName=aPackage.getQualifiedName();
  PsiPackageStatement statement=((PsiJavaFile)file).getPackageStatement();
  if (statement != null) {
    if (packageName.length() > 0) {
      statement.getPackageReference().bindToElement(aPackage);
    }
 else {
      statement.delete();
    }
  }
 else {
    if (packageName.length() > 0) {
      String text="package " + packageName + ";";
      String ext=StdFileTypes.JAVA.getDefaultExtension();
      PsiJavaFile dummyFile=(PsiJavaFile)PsiFileFactory.getInstance(file.getProject()).createFileFromText("_Dummy_." + ext,text);
      statement=dummyFile.getPackageStatement();
      if (statement == null) {
        throw new IncorrectOperationException();
      }
      file.add(statement);
    }
  }
}
