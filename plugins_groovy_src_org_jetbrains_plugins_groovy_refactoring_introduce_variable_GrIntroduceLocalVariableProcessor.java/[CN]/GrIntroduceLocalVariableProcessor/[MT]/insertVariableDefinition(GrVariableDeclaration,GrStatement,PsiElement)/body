{
  boolean deleteExpression=expression != null && PsiUtil.isExpressionStatement(expression) && !isSingleGStringInjectionExpr(expression);
  boolean anchorEqualsExpression=anchor == expression;
  if (deleteExpression && !anchorEqualsExpression) {
    expression.delete();
  }
  boolean isInsideLoop=isControlStatementBranch(anchor);
  if (isInsideLoop) {
    anchor=insertBraces(anchor);
  }
  LOG.assertTrue(myOccurrences.length > 0);
  declaration=doInsertDefinition(declaration,anchor,deleteExpression,anchorEqualsExpression);
  final GrVariable variable=declaration.getVariables()[0];
  JavaCodeStyleManager.getInstance(declaration.getProject()).shortenClassReferences(declaration);
  PsiElement markerPlace=deleteExpression ? variable : isInsideLoop ? declaration.getParent() : expression;
  refreshPositionMarker(markerPlace);
  return variable;
}
