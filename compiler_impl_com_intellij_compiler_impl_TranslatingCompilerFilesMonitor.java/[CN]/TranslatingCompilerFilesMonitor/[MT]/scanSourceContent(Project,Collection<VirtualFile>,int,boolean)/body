{
  final int projectId=getProjectId(project);
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  int processed=0;
  for (  VirtualFile srcRoot : roots) {
    if (indicator != null) {
      indicator.setText2(srcRoot.getPresentableUrl());
      indicator.setFraction(++processed / (double)totalRootCount);
    }
    if (isNewRoots) {
      fileIndex.iterateContentUnderDirectory(srcRoot,new ContentIterator(){
        public boolean processFile(        final VirtualFile file){
          if (!file.isDirectory()) {
            if (!isMarkedForRecompilation(projectId,getFileId(file))) {
              final SourceFileInfo srcInfo=loadSourceInfo(file);
              if (srcInfo == null || srcInfo.getTimestamp(projectId) != file.getTimeStamp()) {
                addSourceForRecompilation(projectId,file,srcInfo);
              }
            }
          }
          return true;
        }
      }
);
    }
 else {
      final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
      new Object(){
        void processFile(        VirtualFile file){
          if (fileTypeManager.isFileIgnored(file.getName())) {
            return;
          }
          final int fileId=getFileId(file);
          if (fileId > 0) {
            if (file.isDirectory()) {
              for (              VirtualFile child : file.getChildren()) {
                processFile(child);
              }
            }
 else {
              if (!isMarkedForRecompilation(projectId,fileId)) {
                final SourceFileInfo srcInfo=loadSourceInfo(file);
                if (srcInfo != null) {
                  addSourceForRecompilation(projectId,file,srcInfo);
                }
              }
            }
          }
        }
      }
.processFile(srcRoot);
    }
  }
}
