{
  if (findLaf(lookAndFeelInfo.getClassName()) == null) {
    LOG.error("unknown LookAndFeel : " + lookAndFeelInfo);
    return;
  }
  if (IDEA_LAF_CLASSNAME.equals(lookAndFeelInfo.getClassName())) {
    IdeaLaf laf=new IdeaLaf();
    IdeaLaf.setCurrentTheme(new IdeaBlueMetalTheme());
    try {
      UIManager.setLookAndFeel(laf);
    }
 catch (    Exception exc) {
      Messages.showMessageDialog(IdeBundle.message("error.cannot.set.look.and.feel",lookAndFeelInfo.getName()),CommonBundle.getErrorTitle(),Messages.getErrorIcon());
      return;
    }
  }
 else {
    try {
      LookAndFeel laf=((LookAndFeel)Class.forName(lookAndFeelInfo.getClassName()).newInstance());
      if (laf instanceof MetalLookAndFeel) {
        MetalLookAndFeel.setCurrentTheme(new DefaultMetalTheme());
      }
      UIManager.setLookAndFeel(laf);
    }
 catch (    Exception exc) {
      Messages.showMessageDialog(IdeBundle.message("error.cannot.set.look.and.feel",lookAndFeelInfo.getName()),CommonBundle.getErrorTitle(),Messages.getErrorIcon());
      return;
    }
  }
  myCurrentLaf=lookAndFeelInfo;
  checkLookAndFeel(lookAndFeelInfo,false);
  String popupWeight=System.getProperty("idea.popup.weight");
  if (popupWeight == null) {
    if (SystemInfo.isWindows) {
      popupWeight=HEAVY_WEIGHT_POPUP;
    }
 else {
      popupWeight=MEDIUM_WEIGHT_POPUP;
    }
  }
 else   if (!HEAVY_WEIGHT_POPUP.equals(popupWeight) && !MEDIUM_WEIGHT_POPUP.equals(popupWeight)) {
    throw new IllegalStateException("unknown value of property -Didea.popup.weight: " + popupWeight);
  }
  if (SystemInfo.isMacOSLeopard) {
    popupWeight=HEAVY_WEIGHT_POPUP;
  }
  popupWeight=popupWeight.trim();
  PopupFactory popupFactory;
  final PopupFactory oldFactory=PopupFactory.getSharedInstance();
  if (!(oldFactory instanceof OurPopupFactory)) {
    popupFactory=new OurPopupFactory(){
      public Popup getPopup(      Component owner,      Component contents,      int x,      int y) throws IllegalArgumentException {
        final Point point=fixPopupLocation(contents,x,y);
        final int popupType=PopupUtil.getPopupType(this);
        if (popupType >= 0) {
          PopupUtil.setPopupType(oldFactory,popupType);
        }
        return oldFactory.getPopup(owner,contents,point.x,point.y);
      }
    }
;
    PopupUtil.setPopupType(popupFactory,HEAVY_WEIGHT_POPUP.equals(popupWeight) ? 2 : 1);
    PopupFactory.setSharedInstance(popupFactory);
  }
  if (UIUtil.isUnderAquaLookAndFeel()) {
    final UIDefaults uiDefaults=UIManager.getLookAndFeelDefaults();
    uiDefaults.put("PopupMenuUI",MacPopupMenuUI.class.getCanonicalName());
    uiDefaults.put("Menu.invertedArrowIcon",getAquaMenuInvertedIcon());
    uiDefaults.put("Menu.disabledArrowIcon",getAquaMenuDisabledIcon());
  }
}
