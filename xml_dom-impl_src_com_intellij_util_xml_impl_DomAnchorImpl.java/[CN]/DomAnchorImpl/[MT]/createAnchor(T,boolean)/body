{
  if (usePsi) {
    final XmlElement element=t.getXmlElement();
    if (element != null) {
      return new PsiBasedDomAnchor<T>(PsiAnchor.create(element),element.getProject());
    }
  }
  DomInvocationHandler handler=DomManagerImpl.getNotNullHandler(t);
  if (handler.getStub() != null) {
    return new StubAnchor<T>(handler);
  }
  final DomElement parent=t.getParent();
  if (parent == null) {
    LOG.error("Parent null: " + t);
  }
  if (parent instanceof DomFileElementImpl) {
    final DomFileElementImpl fileElement=(DomFileElementImpl)parent;
    return new RootAnchor<T>(fileElement.getFile(),fileElement.getRootElementClass());
  }
  final DomAnchor<DomElement> parentAnchor=createAnchor(parent);
  final String name=t.getGenericInfo().getElementName(t);
  final AbstractDomChildrenDescription description=t.getChildDescription();
  final List<? extends DomElement> values=description.getValues(parent);
  if (name != null) {
    int i=0;
    for (    DomElement value : values) {
      if (value.equals(t)) {
        return new NamedAnchor<T>(parentAnchor,description,name,i);
      }
      if (name.equals(value.getGenericInfo().getElementName(value))) {
        i++;
      }
    }
  }
  final int index=values.indexOf(t);
  if (index < 0) {
    diagnoseNegativeIndex2(t,parent,description,values);
  }
  return new IndexedAnchor<T>(parentAnchor,description,index);
}
