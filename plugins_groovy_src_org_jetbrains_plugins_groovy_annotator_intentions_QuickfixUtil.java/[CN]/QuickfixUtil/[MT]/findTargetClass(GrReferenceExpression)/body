{
  final PsiClass psiClass;
  if (refExpr.isQualified()) {
    GrExpression qualifier=refExpr.getQualifierExpression();
    PsiType type=qualifier.getType();
    if (!(type instanceof PsiClassType))     return null;
    psiClass=((PsiClassType)type).resolve();
  }
 else {
    GroovyPsiElement context=PsiTreeUtil.getParentOfType(refExpr,GrTypeDefinition.class,GroovyFileBase.class);
    if (context instanceof GrTypeDefinition) {
      return (PsiClass)context;
    }
 else     if (context instanceof GroovyFileBase)     return ((GroovyFileBase)context).getScriptClass();
    return null;
  }
  return psiClass;
}
