{
  int limit=3 * (myContext.tokenEndOffset - myContext.lineStartPosition.offset);
  int counter=0;
  int startOffset=myContext.currentPosition.offset;
  while (myContext.currentPosition.offset < myContext.tokenEndOffset) {
    if (counter++ > limit) {
      String editorInfo=myEditor instanceof EditorImpl ? ((EditorImpl)myEditor).dumpState() : myEditor.getClass().toString();
      LogMessageEx.error(LOG,"Cycled soft wraps recalculation detected",String.format("Start recalculation offset: %d, visible area width: %d, calculation context: %s, editor info: %s",startOffset,myVisibleAreaWidth,myContext,editorInfo));
      for (int i=myContext.currentPosition.offset; i < myContext.tokenEndOffset; i++) {
        char c=myContext.text.charAt(i);
        if (c == '\n') {
          myContext.onNewLine();
          if (checkIsDoneAfterNewLine()) {
            return true;
          }
        }
 else {
          myContext.onNonLineFeedSymbol(c);
        }
      }
      return false;
    }
    int offset=myContext.currentPosition.offset;
    if (myContext.delayedSoftWrap != null && myContext.delayedSoftWrap.getStart() == offset) {
      processSoftWrap(myContext.delayedSoftWrap);
      myContext.delayedSoftWrap=null;
      if (checkIsDoneAfterSoftWrap()) {
        return true;
      }
    }
    char c=myContext.text.charAt(offset);
    if (c == '\n') {
      myContext.onNewLine();
      if (checkIsDoneAfterNewLine()) {
        return true;
      }
      continue;
    }
    if (myContext.skipToLineEnd) {
      myContext.skipToLineEnd=false;
      if (createSoftWrapIfPossible()) {
        return true;
      }
      continue;
    }
    int newX=offsetToX(offset,c);
    if (myContext.exceedsVisualEdge(newX) && myContext.delayedSoftWrap == null) {
      if (createSoftWrapIfPossible()) {
        return true;
      }
    }
 else {
      myContext.onNonLineFeedSymbol(c,newX);
    }
  }
  return false;
}
