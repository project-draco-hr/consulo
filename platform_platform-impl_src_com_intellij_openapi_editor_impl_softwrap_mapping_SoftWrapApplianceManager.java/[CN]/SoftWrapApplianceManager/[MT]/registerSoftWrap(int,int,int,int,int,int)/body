{
  Document document=myEditor.getDocument();
  if (myLineWrapPositionStrategy == null) {
    myLineWrapPositionStrategy=LanguageLineWrapPositionStrategy.INSTANCE.forEditor(myEditor);
  }
  int softWrapOffset=myLineWrapPositionStrategy.calculateWrapPosition(document.getCharsSequence(),minOffset,maxOffset,preferredOffset,minOffset != preferredOffset);
  int indent=0;
  if (myCustomIndentUsedLastTime) {
    indent=myCustomIndentValueUsedLastTime;
  }
  SoftWrapImpl softWrap=new SoftWrapImpl(new TextChangeImpl("\n" + StringUtil.repeatSymbol(' ',indentInColumns + indent),softWrapOffset,softWrapOffset),indentInColumns + indent + 1,indentInPixels + (indent * spaceSize) + myPainter.getMinDrawingWidth(SoftWrapDrawingType.AFTER_SOFT_WRAP));
  myStorage.storeOrReplace(softWrap,true);
  return softWrap;
}
