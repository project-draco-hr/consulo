{
  initListenerIfNecessary();
  if (myEventsStorage.getEvents().isEmpty()) {
    return true;
  }
  if (myVisibleAreaWidth <= 0) {
    return false;
  }
  List<IncrementalCacheUpdateEvent> events=new ArrayList<IncrementalCacheUpdateEvent>(myEventsStorage.getEvents());
  myActiveEvents.addAll(events);
  myEventsStorage.release();
  if (myInProgress && !events.isEmpty()) {
    String state="";
    if (myEditor instanceof EditorImpl) {
      state=((EditorImpl)myEditor).dumpState();
    }
    LogMessageEx.error(LOG,"Detected race condition at soft wraps recalculation",String.format("Current events: %s. Concurrent events: %s, event being processed: %s%n%s",events,myActiveEvents,myEventBeingProcessed,state));
  }
  myInProgress=true;
  myHasLinesWithFailedWrap=false;
  try {
    for (    IncrementalCacheUpdateEvent event : events) {
      myEventBeingProcessed=event;
      recalculateSoftWraps(event);
    }
  }
  finally {
    myInProgress=false;
    myActiveEvents.clear();
    myEventBeingProcessed=null;
  }
  updateLastTopLeftCornerOffset();
  return true;
}
