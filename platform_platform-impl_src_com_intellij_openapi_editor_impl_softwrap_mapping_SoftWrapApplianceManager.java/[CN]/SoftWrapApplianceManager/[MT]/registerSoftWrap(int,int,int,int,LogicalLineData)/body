{
  int softWrapOffset=calculateBackwardSpaceOffsetIfPossible(minOffset,preferredOffset);
  if (softWrapOffset < 0) {
    Document document=myEditor.getDocument();
    if (myLineWrapPositionStrategy == null) {
      myLineWrapPositionStrategy=LanguageLineWrapPositionStrategy.INSTANCE.forEditor(myEditor);
    }
    softWrapOffset=myLineWrapPositionStrategy.calculateWrapPosition(document.getCharsSequence(),minOffset,maxOffset,preferredOffset,true);
  }
  if (softWrapOffset >= lineData.endLineOffset) {
    return null;
  }
  int indentInColumns=0;
  int indentInPixels=myPainter.getMinDrawingWidth(SoftWrapDrawingType.AFTER_SOFT_WRAP);
  if (myCustomIndentUsedLastTime) {
    indentInColumns=myCustomIndentValueUsedLastTime + lineData.indentInColumns;
    indentInPixels+=lineData.indentInPixels + (myCustomIndentValueUsedLastTime * spaceSize);
  }
  SoftWrapImpl softWrap=new SoftWrapImpl(new TextChangeImpl("\n" + StringUtil.repeatSymbol(' ',indentInColumns),softWrapOffset,softWrapOffset),indentInColumns + 1,indentInPixels);
  myStorage.storeOrReplace(softWrap,true);
  return softWrap;
}
