{
  if (!myRecalculateEnd) {
    return;
  }
  Document document=myEditor.getDocument();
  int startLine=document.getLineNumber(endRange.getStartOffset());
  int startOffset=document.getLineStartOffset(startLine);
  int endLine=document.getLineNumber(endRange.getEndOffset());
  int endOffset=document.getLineEndOffset(endLine);
  int textLength=document.getTextLength();
  if (textLength > 0 && endOffset >= textLength && endOffset > startOffset) {
    endOffset=textLength - 1;
  }
  endRange=new TextRange(startOffset,endOffset);
}
