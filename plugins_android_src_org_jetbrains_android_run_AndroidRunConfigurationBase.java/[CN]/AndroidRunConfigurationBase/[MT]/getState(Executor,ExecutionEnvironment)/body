{
  final Module module=getConfigurationModule().getModule();
  if (module == null) {
    throw new ExecutionException("Module is not found");
  }
  AndroidFacet facet=AndroidFacet.getInstance(module);
  if (facet == null) {
    throw new ExecutionException(AndroidBundle.message("no.facet.error",module.getName()));
  }
  Project project=env.getProject();
  if (DefaultDebugExecutor.EXECUTOR_ID.equals(executor.getId())) {
    boolean ddmsEnabled=AndroidEnableDdmsAction.isDdmsEnabled();
    if (ddmsEnabled && isDdmsCorrupted(facet)) {
      ddmsEnabled=false;
      AndroidEnableDdmsAction.setDdmsEnabled(project,false);
    }
    if (!ddmsEnabled) {
      int result=Messages.showYesNoDialog(project,AndroidBundle.message("android.ddms.disabled.error"),AndroidBundle.message("android.ddms.disabled.dialog.title"),Messages.getQuestionIcon());
      if (result != 0) {
        return null;
      }
      AndroidEnableDdmsAction.setDdmsEnabled(project,true);
    }
  }
  AndroidFacetConfiguration configuration=facet.getConfiguration();
  AndroidPlatform platform=configuration.getAndroidPlatform();
  if (platform == null) {
    Messages.showErrorDialog(project,AndroidBundle.message("specify.platform.error"),CommonBundle.getErrorTitle());
    ModulesConfigurator.showFacetSettingsDialog(facet,null);
    return null;
  }
 else {
    String aPackage=getPackageName(facet);
    if (aPackage == null)     return null;
    Map<Module,String> depModule2PackageName=new HashMap<Module,String>();
    if (!fillRuntimeAndTestDependencies(module,depModule2PackageName))     return null;
    if (platform.getSdk().getDebugBridge(project) == null)     return null;
    String[] deviceSerialNumbers=ArrayUtil.EMPTY_STRING_ARRAY;
    if (CHOOSE_DEVICE_MANUALLY) {
      deviceSerialNumbers=chooseDevicesManually(facet);
      if (deviceSerialNumbers.length == 0)       return null;
    }
    AndroidApplicationLauncher applicationLauncher=getApplicationLauncher(facet);
    if (applicationLauncher != null) {
      return new AndroidRunningState(env,facet,deviceSerialNumbers,PREFERRED_AVD.length() > 0 ? PREFERRED_AVD : null,computeCommandLine(),aPackage,applicationLauncher,depModule2PackageName){
        @NotNull @Override protected ConsoleView attachConsole() throws ExecutionException {
          return AndroidRunConfigurationBase.this.attachConsole(this,executor);
        }
      }
;
    }
  }
  return null;
}
