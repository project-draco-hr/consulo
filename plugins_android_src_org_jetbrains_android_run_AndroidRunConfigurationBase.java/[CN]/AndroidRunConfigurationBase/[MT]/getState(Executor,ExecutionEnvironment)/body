{
  final Module module=getConfigurationModule().getModule();
  if (module == null) {
    throw new ExecutionException("Module is not found");
  }
  AndroidFacet facet=AndroidFacet.getInstance(module);
  if (facet == null) {
    throw new ExecutionException(AndroidBundle.message("no.facet.error",module.getName()));
  }
  AndroidFacetConfiguration configuration=facet.getConfiguration();
  AndroidPlatform platform=configuration.getAndroidPlatform();
  Project project=module.getProject();
  if (platform == null) {
    Messages.showErrorDialog(project,AndroidBundle.message("specify.platform.error"),CommonBundle.getErrorTitle());
    ModulesConfigurator.showFacetSettingsDialog(facet,null);
    return null;
  }
 else {
    String aPackage=getPackageName(facet);
    if (aPackage == null)     return null;
    Map<Module,String> depModule2PackageName=new HashMap<Module,String>();
    if (!fillRuntimeAndTestDependencies(module,depModule2PackageName))     return null;
    if (platform.getSdk().getDebugBridge(project) == null)     return null;
    String[] deviceSerialNumbers=ArrayUtil.EMPTY_STRING_ARRAY;
    if (CHOOSE_DEVICE_MANUALLY) {
      deviceSerialNumbers=chooseDevicesManually(facet);
      if (deviceSerialNumbers.length == 0)       return null;
    }
    AndroidApplicationLauncher applicationLauncher=getApplicationLauncher(facet);
    if (applicationLauncher != null) {
      return new AndroidRunningState(env,facet,deviceSerialNumbers,PREFERRED_AVD.length() > 0 ? PREFERRED_AVD : null,computeCommandLine(),aPackage,applicationLauncher,depModule2PackageName){
        @NotNull @Override protected ConsoleView attachConsole() throws ExecutionException {
          return AndroidRunConfigurationBase.this.attachConsole(this,executor);
        }
      }
;
    }
  }
  return null;
}
