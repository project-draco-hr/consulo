{
  final PsiFile templateFile=PsiUtilBase.getTemplateLanguageFile(file);
  if (templateFile != null) {
    file=templateFile;
  }
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forContext(file);
  if (builder != null) {
    final CodeStyleSettings settings=getSettings();
    final CodeStyleSettings.IndentOptions indentOptions=settings.getIndentOptions(file.getFileType());
    final FormattingModel model=builder.createModel(file,settings);
    final Document document=PsiDocumentManager.getInstance(getProject()).getDocument(file);
    FormatterEx.getInstanceEx().adjustLineIndentsForRange(new DocumentBasedFormattingModel(model.getRootBlock(),document,getProject(),settings,file.getFileType(),file),settings,indentOptions,rangeToAdjust);
  }
}
