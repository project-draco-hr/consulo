{
  final Change[] changes=getSelectedChanges();
  Collection<VirtualFile> files=new HashSet<VirtualFile>();
  for (  Change change : changes) {
    final ContentRevision afterRevision=change.getAfterRevision();
    if (afterRevision != null) {
      final VirtualFile file=afterRevision.getFile().getVirtualFile();
      if (file != null && file.isValid()) {
        files.add(file);
      }
    }
  }
  files.addAll(getSelectedVirtualFiles(null));
  return files.toArray(new VirtualFile[files.size()]);
}
