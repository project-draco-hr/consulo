{
  for (  Change change : changes) {
    ProgressManager.checkCanceled();
    if (change.getAfterRevision() == null)     continue;
    final VirtualFile afterFile=getFileWithRefresh(change.getAfterRevision().getFile());
    if (afterFile == null || afterFile.isDirectory() || afterFile.getFileType().isBinary())     continue;
    myPsiFile=null;
    if (afterFile.isValid()) {
      myPsiFile=ApplicationManager.getApplication().runReadAction(new Computable<PsiFile>(){
        @Override public PsiFile compute(){
          return myPsiManager.findFile(afterFile);
        }
      }
);
    }
    if (myPsiFile == null) {
      mySkipped.add(Pair.create(change.getAfterRevision().getFile(),ourInvalidFile));
      continue;
    }
    myNewTodoItems=new ArrayList<TodoItem>(Arrays.asList(ApplicationManager.getApplication().runReadAction(new Computable<TodoItem[]>(){
      @Override public TodoItem[] compute(){
        return mySearchHelper.findTodoItems(myPsiFile);
      }
    }
)));
    applyFilterAndRemoveDuplicates(myNewTodoItems,myTodoFilter);
    if (change.getBeforeRevision() == null) {
      if (myNewTodoItems.isEmpty())       continue;
      myAddedOrEditedTodos.addAll(myNewTodoItems);
    }
 else {
      myEditedFileProcessor.process(change,myNewTodoItems);
    }
  }
}
