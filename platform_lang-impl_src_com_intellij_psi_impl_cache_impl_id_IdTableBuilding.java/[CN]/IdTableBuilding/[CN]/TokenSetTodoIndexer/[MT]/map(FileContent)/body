{
  if (CacheUtil.getIndexPatternCount() > 0) {
    final CharSequence chars=inputData.getContentAsText();
    final TodoOccurrenceConsumer occurrenceConsumer=new TodoOccurrenceConsumer();
    EditorHighlighter highlighter;
    final EditorHighlighter editorHighlighter=inputData.getUserData(FileBasedIndex.EDITOR_HIGHLIGHTER);
    if (editorHighlighter != null && checkCanUseCachedEditorHighlighter(chars,editorHighlighter)) {
      highlighter=editorHighlighter;
    }
 else {
      highlighter=HighlighterFactory.createHighlighter(null,myFile);
      highlighter.setText(chars);
    }
    final int documentLength=chars.length();
    BaseFilterLexer.TodoScanningData[] todoScanningDatas=null;
    final HighlighterIterator iterator=highlighter.createIterator(0);
    while (!iterator.atEnd()) {
      final IElementType token=iterator.getTokenType();
      if (CacheUtil.isInComments(token) || myCommentTokens.contains(token)) {
        int start=iterator.getStart();
        int end=iterator.getEnd();
        if (start >= documentLength || end > documentLength) {
          Logger.getInstance(getClass().getName()).error("Lexer editor highlighter produces tokens out of range:" + documentLength + ",("+ start+ ","+ end+ ")");
        }
        todoScanningDatas=BaseFilterLexer.advanceTodoItemsCount(chars.subSequence(start,end),occurrenceConsumer,todoScanningDatas);
      }
      iterator.advance();
    }
    final Map<TodoIndexEntry,Integer> map=new HashMap<TodoIndexEntry,Integer>();
    for (    IndexPattern pattern : CacheUtil.getIndexPatterns()) {
      final int count=occurrenceConsumer.getOccurrenceCount(pattern);
      if (count > 0) {
        map.put(new TodoIndexEntry(pattern.getPatternString(),pattern.isCaseSensitive()),count);
      }
    }
    return map;
  }
  return Collections.emptyMap();
}
