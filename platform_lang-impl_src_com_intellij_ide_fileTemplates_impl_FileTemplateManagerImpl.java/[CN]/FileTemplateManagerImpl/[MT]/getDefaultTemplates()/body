{
  LOG.assertTrue(!StringUtil.isEmpty(myDefaultTemplatesDir),myDefaultTemplatesDir);
  VirtualFile[] topDirs=getTopTemplatesDir();
  if (LOG.isDebugEnabled()) {
    @NonNls String message="Top dirs found: ";
    for (int i=0; i < topDirs.length; i++) {
      VirtualFile topDir=topDirs[i];
      message+=(i > 0 ? ", " : "") + topDir.getPresentableUrl();
    }
    LOG.debug(message);
  }
  Set<VirtualFile> templatesList=new THashSet<VirtualFile>();
  for (  VirtualFile topDir : topDirs) {
    final VirtualFile parentDir;
    if (myDefaultTemplatesDir.equals(".")) {
      parentDir=topDir;
    }
 else {
      final ApplicationEx app=(ApplicationEx)ApplicationManager.getApplication();
      if (topDir instanceof NewVirtualFile && (!app.holdsReadLock() || app.isDispatchThread())) {
        parentDir=((NewVirtualFile)topDir).refreshAndFindChild(myDefaultTemplatesDir);
      }
 else {
        parentDir=topDir.findChild(myDefaultTemplatesDir);
      }
    }
    if (parentDir != null) {
      templatesList.addAll(listDir(parentDir));
    }
  }
  removeDeletedTemplates(templatesList);
  return templatesList;
}
