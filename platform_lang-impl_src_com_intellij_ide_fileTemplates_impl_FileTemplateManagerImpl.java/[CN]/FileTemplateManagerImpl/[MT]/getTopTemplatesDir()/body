{
synchronized (TOP_DIRS_LOCK) {
    if (ourTopDirs != null) {
      return ourTopDirs;
    }
    Set<VirtualFile> dirList=new THashSet<VirtualFile>();
    PluginDescriptor[] plugins=ApplicationManager.getApplication().getPlugins();
    for (    PluginDescriptor plugin : plugins) {
      if (plugin instanceof IdeaPluginDescriptorImpl && ((IdeaPluginDescriptorImpl)plugin).isEnabled()) {
        final ClassLoader loader=plugin.getPluginClassLoader();
        if (loader instanceof PluginClassLoader && ((PluginClassLoader)loader).getUrls().isEmpty()) {
          continue;
        }
        appendDefaultTemplatesDirFromClassloader(loader,dirList);
      }
    }
    ourTopDirs=VfsUtil.toVirtualFileArray(dirList);
    for (    VirtualFile topDir : ourTopDirs) {
      topDir.refresh(true,true);
    }
    return ourTopDirs;
  }
}
