{
  if (!dir.isDirectory()) {
    throw new IllegalArgumentException(VcsBundle.message("exception.text.file.should.be.directory",dir.getPresentableUrl()));
  }
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  VfsUtilCore.visitChildrenRecursively(dir,new VirtualFileVisitor(){
    @Override public boolean visitFile(    @NotNull VirtualFile file){
      if (file.isDirectory()) {
        if (addDirectories) {
          files.add(file);
        }
        if (!recursive && !Comparing.equal(file,dir)) {
          return false;
        }
      }
 else       if (fileTypeManager == null || file.getFileType() != FileTypes.UNKNOWN) {
        files.add(file);
      }
      return true;
    }
  }
);
}
