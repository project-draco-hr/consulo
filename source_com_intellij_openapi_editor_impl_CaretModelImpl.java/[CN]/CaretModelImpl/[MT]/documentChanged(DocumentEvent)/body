{
  myIsInUpdate=false;
  DocumentEventImpl event=(DocumentEventImpl)e;
  if (event.isWholeTextReplaced()) {
    int newLength=myEditor.getDocument().getTextLength();
    if (myOffset == newLength - e.getNewLength() + e.getOldLength()) {
      moveToOffset(newLength);
    }
 else {
      final int line=event.translateLineViaDiff(myLogicalCaret.line);
      moveToLogicalPosition(new LogicalPosition(line,myLogicalCaret.column));
    }
  }
 else {
    int startOffset=e.getOffset();
    int oldEndOffset=startOffset + e.getOldLength();
    int newOffset=myOffset;
    VisualPosition oldPosition=getVisualPosition();
    if (myOffset > oldEndOffset || myOffset == oldEndOffset && needToShiftWhitespaces(e)) {
      newOffset+=e.getNewLength() - e.getOldLength();
    }
 else     if (myOffset >= startOffset && myOffset <= oldEndOffset) {
      newOffset=Math.min(newOffset,startOffset + e.getNewLength());
    }
    newOffset=Math.min(newOffset,myEditor.getDocument().getTextLength());
    if (newOffset != myOffset) {
      moveToOffset(newOffset);
    }
 else {
      moveToVisualPosition(oldPosition);
    }
  }
  myVisualLineStart=myEditor.logicalPositionToOffset(myEditor.visualToLogicalPosition(new VisualPosition(myVisibleCaret.line,0)));
  myVisualLineEnd=myEditor.logicalPositionToOffset(myEditor.visualToLogicalPosition(new VisualPosition(myVisibleCaret.line + 1,0)));
}
