{
  final DefaultListModel model=new DefaultListModel();
  VirtualFile[] selectedFiles=FileEditorManager.getInstance(project).getSelectedFiles();
  VirtualFile[] files=EditorHistoryManager.getInstance(project).getFiles();
  FileEditorProviderManager editorProviderManager=FileEditorProviderManager.getInstance();
  for (int i=files.length - 1; i >= 0; i--) {
    VirtualFile file=files[i];
    if (ArrayUtil.find(selectedFiles,file) != 0 && editorProviderManager.getProviders(project,file).length > 0) {
      model.addElement(file);
    }
  }
  final JList list=new JList(model);
  list.addKeyListener(new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      if (e.getKeyCode() == KeyEvent.VK_DELETE) {
        int index=list.getSelectedIndex();
        if (index == -1 || index >= list.getModel().getSize()) {
          return;
        }
        Object[] values=list.getSelectedValues();
        for (int i=0; i < values.length; i++) {
          VirtualFile file=(VirtualFile)values[i];
          model.removeElement(file);
          if (model.getSize() > 0) {
            if (model.getSize() == index) {
              list.setSelectedIndex(model.getSize() - 1);
            }
 else             if (model.getSize() > index) {
              list.setSelectedIndex(index);
            }
          }
 else {
            list.clearSelection();
          }
          EditorHistoryManager.getInstance(project).removeFile(file);
        }
      }
    }
  }
);
  Runnable runnable=new Runnable(){
    public void run(){
      Object[] values=list.getSelectedValues();
      for (int i=0; i < values.length; i++) {
        VirtualFile file=(VirtualFile)values[i];
        FileEditorManager.getInstance(project).openFile(file,true);
      }
    }
  }
;
  if (list.getModel().getSize() == 0) {
    list.clearSelection();
  }
  new MyListSpeedSearch(list);
  Window window=null;
  Component focusedComponent=WindowManagerEx.getInstanceEx().getFocusedComponent(project);
  if (focusedComponent != null) {
    if (focusedComponent instanceof Window) {
      window=(Window)focusedComponent;
    }
 else {
      window=SwingUtilities.getWindowAncestor(focusedComponent);
    }
  }
  if (window == null) {
    window=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
  }
  Rectangle r;
  if (window != null) {
    r=window.getBounds();
  }
 else {
    r=WindowManagerEx.getInstanceEx().getScreenBounds();
  }
  ListPopup popup=new MyListPopup(list,runnable,project);
  if (model.getSize() > 0) {
    Dimension listPreferredSize=list.getPreferredSize();
    list.setVisibleRowCount(0);
    Dimension viewPreferredSize=new Dimension(listPreferredSize.width,Math.min(listPreferredSize.height,r.height - 20));
    ((JViewport)list.getParent()).setPreferredSize(viewPreferredSize);
  }
  popup.getWindow().pack();
  Dimension popupSize=popup.getSize();
  int x=r.x + r.width / 2 - popupSize.width / 2;
  int y=r.y + r.height / 2 - popupSize.height / 2;
  popup.show(x,y);
}
