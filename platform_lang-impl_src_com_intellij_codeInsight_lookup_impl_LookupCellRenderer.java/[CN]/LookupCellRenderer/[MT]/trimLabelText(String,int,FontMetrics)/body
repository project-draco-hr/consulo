{
  if (text == null || StringUtil.isEmpty(text)) {
    return "";
  }
  final int strWidth=RealLookupElementPresentation.getStringWidth(text,metrics);
  if (strWidth <= maxWidth) {
    return text;
  }
  if (RealLookupElementPresentation.getStringWidth(ELLIPSIS,metrics) > maxWidth) {
    return "";
  }
  int i=0;
  int j=text.length();
  while (i + 1 < j) {
    int mid=(i + j) / 2;
    final String candidate=text.substring(0,mid) + ELLIPSIS;
    final int width=RealLookupElementPresentation.getStringWidth(candidate,metrics);
    if (width <= maxWidth) {
      i=mid;
    }
 else {
      j=mid;
    }
  }
  return text.substring(0,i) + ELLIPSIS;
}
