{
  boolean nonFocusedSelection=isSelected && !myLookup.isFocused() && CompletionPreview.hasPreview(myLookup);
  if (!myLookup.isFocused()) {
    isSelected=false;
  }
  myIsSelected=isSelected;
  final LookupElement item=(LookupElement)value;
  final Color foreground=getForegroundColor(isSelected);
  final Color background=nonFocusedSelection ? SELECTED_NON_FOCUSED_BACKGROUND_COLOR : isSelected ? SELECTED_BACKGROUND_COLOR : BACKGROUND_COLOR;
  int allowedWidth=list.getWidth() - AFTER_TAIL - AFTER_TYPE- getIconIndent();
  final LookupElementPresentation presentation=new RealLookupElementPresentation(isSelected ? getMaxWidth() : allowedWidth,myNormalMetrics,myBoldMetrics,myLookup);
  if (item.isValid()) {
    item.renderElement(presentation);
  }
 else {
    presentation.setItemTextForeground(JBColor.RED);
    presentation.setItemText("Invalid");
  }
  myNameComponent.clear();
  myNameComponent.setIcon(augmentIcon(presentation.getIcon(),myEmptyIcon));
  myNameComponent.setBackground(background);
  allowedWidth-=setItemTextLabel(item,new JBColor(isSelected ? SELECTED_FOREGROUND_COLOR : presentation.getItemTextForeground(),foreground),isSelected,presentation,allowedWidth);
  myTypeLabel.clear();
  if (allowedWidth > 0) {
    allowedWidth-=setTypeTextLabel(item,background,foreground,presentation,isSelected ? getMaxWidth() : allowedWidth,isSelected);
  }
  myTailComponent.clear();
  myTailComponent.setBackground(background);
  if (isSelected || allowedWidth >= 0) {
    setTailTextLabel(isSelected,presentation,foreground,isSelected ? getMaxWidth() : allowedWidth,nonFocusedSelection);
  }
  if (mySelected.containsKey(index)) {
    if (!isSelected && mySelected.get(index)) {
      myPanel.setUpdateExtender(true);
    }
  }
  mySelected.put(index,isSelected);
  final double w=myNameComponent.getPreferredSize().getWidth() + myTailComponent.getPreferredSize().getWidth() + myTypeLabel.getPreferredSize().getWidth();
  myPanel.removeAll();
  if (isSelected && w > list.getWidth()) {
    myPanel.setLayout(new BoxLayout(myPanel,BoxLayout.X_AXIS));
    myPanel.add(myNameComponent);
    myPanel.add(myTailComponent);
    myPanel.add(myTypeLabel);
  }
 else {
    myPanel.setLayout(new BorderLayout());
    myPanel.add(myNameComponent,BorderLayout.WEST);
    myPanel.add(myTailComponent,BorderLayout.CENTER);
    myPanel.add(myTypeLabel,BorderLayout.EAST);
  }
  return myPanel;
}
