{
  JarFileInfo[] infos;
synchronized (LOCK) {
    infos=myPathToFileInfoMap.values().toArray(new JarFileInfo[myPathToFileInfoMap.size()]);
  }
  final ModalityState modalityState=VirtualFileManagerImpl.calcModalityStateForRefreshEventsPosting(asynchronous);
  final VirtualFileManagerEx manager=getManager();
  manager.beforeRefreshStart(asynchronous,modalityState,null);
  final Ref<Integer> joinCount=new Ref<Integer>(infos.length);
  for (  final JarFileInfo info : infos) {
    final VirtualFile localRoot=getVirtualFileForJar(info.getRootFile());
    if (localRoot != null) {
      localRoot.refresh(asynchronous,false,new Runnable(){
        public void run(){
          int cnt=joinCount.get();
          if (--cnt == 0) {
            manager.afterRefreshFinish(asynchronous,modalityState);
          }
          joinCount.set(cnt);
          if (!localRoot.isValid() || localRoot.getTimeStamp() != info.getTimeStamp()) {
            refreshInfo(info,asynchronous,false);
          }
        }
      }
);
    }
 else {
      refreshInfo(info,asynchronous,false);
    }
  }
}
