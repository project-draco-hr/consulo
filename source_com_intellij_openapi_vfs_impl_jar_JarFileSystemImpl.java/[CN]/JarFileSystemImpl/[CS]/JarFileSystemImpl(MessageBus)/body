{
  bus.connect().subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener(){
    public void before(    final List<? extends VFileEvent> events){
    }
    public void after(    final List<? extends VFileEvent> events){
      final List<VirtualFile> rootsToRefresh=new ArrayList<VirtualFile>();
      for (      VFileEvent event : events) {
        if (event.getFileSystem() instanceof LocalFileSystem) {
          final String path=event.getPath();
          List<String> jarPaths=new ArrayList<String>();
synchronized (PersistentFS.LOCK) {
            jarPaths.addAll(myHandlers.keySet());
          }
          for (          String jarPath : jarPaths) {
            if (FileUtil.startsWith(jarPath.substring(0,jarPath.length() - JAR_SEPARATOR.length()),path,SystemInfo.isFileSystemCaseSensitive)) {
              VirtualFile jarRootToRefresh=markDirty(jarPath);
              if (jarRootToRefresh != null) {
                rootsToRefresh.add(jarRootToRefresh);
              }
            }
          }
        }
      }
      if (!rootsToRefresh.isEmpty()) {
        final Application app=ApplicationManager.getApplication();
        app.invokeLater(new Runnable(){
          public void run(){
            final List<VFileEvent> deleteEvents=new ArrayList<VFileEvent>();
            for (            VirtualFile root : rootsToRefresh) {
              if (root.isValid()) {
                for (                VirtualFile child : root.getChildren()) {
                  if (child != null) {
                    deleteEvents.add(new VFileDeleteEvent(this,child,true));
                  }
                }
                ((NewVirtualFile)root).markDirtyRecursively();
              }
            }
            app.runWriteAction(new Runnable(){
              public void run(){
                ManagingFS.getInstance().processEvents(deleteEvents);
              }
            }
);
            VirtualFile[] roots=rootsToRefresh.toArray(new VirtualFile[rootsToRefresh.size()]);
            RefreshQueue.getInstance().refresh(true,true,null,roots);
          }
        }
,ModalityState.NON_MODAL);
      }
    }
  }
);
}
