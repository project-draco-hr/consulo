{
  FileType fileType=virtualFile.getFileType();
  if (fileType instanceof LanguageFileType) {
    Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
    if (document == null)     return null;
    String text=document.getText();
    Charset charset=((LanguageFileType)fileType).extractCharsetFromFileContent(project,virtualFile,text);
    if (charset != null) {
      return charset;
    }
  }
  return null;
}
