{
  myVirtualFile=e.getData(PlatformDataKeys.VIRTUAL_FILE);
  Project project=e.getData(PlatformDataKeys.PROJECT);
  boolean enabled=project != null && (myVirtualFile != null || myWorksForProjectNode);
  if (enabled && myVirtualFile != null) {
    String prefix;
    Charset charset=encodingFromContent(project,myVirtualFile);
    if (charset != null) {
      prefix="Encoding:";
      enabled=false;
    }
 else     if (FileDocumentManager.getInstance().isFileModified(myVirtualFile)) {
      prefix="Save in:";
    }
 else {
      prefix="View in:";
    }
    if (charset == null)     charset=myVirtualFile.getCharset();
    e.getPresentation().setText(prefix + " " + charset.toString());
  }
 else {
    e.getPresentation().setText("Encoding");
  }
  e.getPresentation().setEnabled(enabled);
}
