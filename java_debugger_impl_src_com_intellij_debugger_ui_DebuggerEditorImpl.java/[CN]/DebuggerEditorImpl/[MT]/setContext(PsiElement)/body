{
  TextWithImports text=getText();
  PsiElement oldContext=myContext;
  myContext=context;
  CodeFragmentFactory oldFactory=myFactory;
  List<CodeFragmentFactory> factories=getAllFactories();
  if (myInitialFactory || !factories.contains(myFactory)) {
    setFactory(factories.get(0));
  }
  myChooseFactory.setVisible(factories.size() > 1);
  myInitialFactory=false;
  if (!oldFactory.equals(myFactory) || !Comparing.equal(oldContext,context)) {
    setText(new TextWithImportsImpl(text.getKind(),text.getText(),text.getImports(),myFactory.getFileType()));
  }
  updateEditorUi();
}
