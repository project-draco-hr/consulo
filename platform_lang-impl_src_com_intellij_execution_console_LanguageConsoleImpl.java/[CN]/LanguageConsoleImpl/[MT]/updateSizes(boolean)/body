{
  if (myFullEditor != null)   return;
  final Dimension panelSize=myPanel.getSize();
  if (panelSize.getHeight() <= 0)   return;
  final Dimension historySize=myHistoryViewer.getContentSize();
  final Dimension editorSize=myConsoleEditor.getContentSize();
  final Dimension newEditorSize=new Dimension();
  final int width=Math.max(editorSize.width,historySize.width);
  newEditorSize.width=width + myConsoleEditor.getScrollPane().getHorizontalScrollBar().getHeight();
  myConsoleEditor.getSettings().setAdditionalColumnsCount(2 + (width - editorSize.width) / EditorUtil.getSpaceWidth(Font.PLAIN,myConsoleEditor));
  myHistoryViewer.getSettings().setAdditionalColumnsCount(2 + (width - historySize.width) / EditorUtil.getSpaceWidth(Font.PLAIN,myHistoryViewer));
  if (historySize.width == 0)   historySize.height=0;
  final int minHistorySize=historySize.height > 0 ? 2 * myHistoryViewer.getLineHeight() + SEPARATOR_THICKNESS : 0;
  final int minEditorSize=myConsoleEditor.isViewer() ? 0 : myConsoleEditor.getLineHeight();
  final int editorPreferred=myConsoleEditor.isViewer() ? 0 : Math.max(minEditorSize,editorSize.height);
  final int historyPreferred=Math.max(minHistorySize,historySize.height);
  if (panelSize.height < minEditorSize) {
    newEditorSize.height=panelSize.height;
  }
 else   if (panelSize.height < editorPreferred) {
    newEditorSize.height=panelSize.height - minHistorySize;
  }
 else   if (panelSize.height < editorPreferred + historyPreferred) {
    newEditorSize.height=editorPreferred;
  }
 else {
    newEditorSize.height=editorPreferred == 0 ? 0 : panelSize.height - historyPreferred;
  }
  final Dimension newHistorySize=new Dimension(width,panelSize.height - newEditorSize.height);
  boolean changed=false;
  final Dimension curEditorSize=myConsoleEditor.getComponent().getPreferredSize();
  if (!curEditorSize.equals(newEditorSize)) {
    myConsoleEditor.getComponent().setPreferredSize(newEditorSize);
    changed=true;
  }
  final boolean scrollToEnd;
  final Dimension curHistorySize=myHistoryViewer.getComponent().getPreferredSize();
  if (!curHistorySize.equals(newHistorySize) && (curHistorySize.height != 0 || newHistorySize.height != 0)) {
    scrollToEnd=forceScrollToEnd || shouldScrollHistoryToEnd();
    myHistoryViewer.getComponent().setPreferredSize(newHistorySize);
    changed=true;
  }
 else   scrollToEnd=forceScrollToEnd;
  if (changed) {
    myPanel.doLayout();
  }
  if (scrollToEnd) {
    scrollHistoryToEnd();
  }
}
