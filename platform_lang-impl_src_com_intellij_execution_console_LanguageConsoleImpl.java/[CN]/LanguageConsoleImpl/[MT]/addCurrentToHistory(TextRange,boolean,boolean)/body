{
  final Ref<String> ref=Ref.create("");
  final boolean scrollToEnd=shouldScrollHistoryToEnd();
  final Runnable action=new Runnable(){
    public void run(){
      ref.set(addTextRangeToHistory(textRange,myConsoleEditor,preserveMarkup));
      if (erase) {
        myConsoleEditor.getDocument().deleteString(textRange.getStartOffset(),textRange.getEndOffset());
      }
    }
  }
;
  if (erase) {
    ApplicationManager.getApplication().runWriteAction(action);
  }
 else {
    ApplicationManager.getApplication().runReadAction(action);
  }
  if (scrollToEnd) {
    scrollHistoryToEnd();
  }
  queueUiUpdate(scrollToEnd);
  return ref.get();
}
