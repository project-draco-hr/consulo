{
  final Ref<String> ref=Ref.create("");
  final boolean scrollToEnd=shouldScrollHistoryToEnd();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      ref.set(addTextRangeToHistory(textRange,myConsoleEditor,preserveMarkup));
      if (erase) {
        myConsoleEditor.getDocument().deleteString(textRange.getStartOffset(),textRange.getEndOffset());
      }
    }
  }
);
  queueUiUpdate(scrollToEnd);
  return ref.get();
}
