{
  String result=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
    @Override public String compute(){
      return addTextRangeToHistory(textRange,editor,preserveMarkup);
    }
  }
);
  if (erase) {
    new WriteCommandAction.Simple(myProject,myFile){
      @Override protected void run() throws Throwable {
        editor.getDocument().deleteString(textRange.getStartOffset(),textRange.getEndOffset());
      }
    }
.execute();
  }
  scrollHistoryToEnd();
  queueUiUpdate(true);
  return result;
}
