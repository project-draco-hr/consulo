{
  final Ref<String> ref=Ref.create("");
  final Runnable action=new Runnable(){
    @Override public void run(){
      ref.set(addTextRangeToHistory(textRange,editor,preserveMarkup));
      if (erase) {
        editor.getDocument().deleteString(textRange.getStartOffset(),textRange.getEndOffset());
      }
    }
  }
;
  if (erase) {
    ApplicationManager.getApplication().runWriteAction(action);
  }
 else {
    ApplicationManager.getApplication().runReadAction(action);
  }
  scrollHistoryToEnd();
  queueUiUpdate(true);
  return ref.get();
}
