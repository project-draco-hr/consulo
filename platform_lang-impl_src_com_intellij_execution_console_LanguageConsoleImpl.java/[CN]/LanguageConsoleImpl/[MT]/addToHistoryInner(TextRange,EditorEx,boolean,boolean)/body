{
  ApplicationManager.getApplication().assertIsDispatchThread();
  String result=addTextRangeToHistory(textRange,editor,preserveMarkup);
  if (erase) {
    DocumentUtil.writeInRunUndoTransparentAction(new Runnable(){
      @Override public void run(){
        editor.getDocument().deleteString(textRange.getStartOffset(),textRange.getEndOffset());
      }
    }
);
  }
  scrollHistoryToEnd();
  queueUiUpdate(true);
  return result;
}
