{
  newVFile.setContent(document,document.getText(),false);
  FileDocumentManagerImpl.registerDocument(document,newVFile);
  final PsiFile psiFile=((PsiFileFactoryImpl)PsiFileFactory.getInstance(project)).trySetupPsiForFile(newVFile,newVFile.getLanguage(),true,false);
  if (psiFile == null) {
    throw new AssertionError("PSI=null for light file: name=" + newVFile.getName() + ", language="+ newVFile.getLanguage().getDisplayName());
  }
  PsiDocumentManagerImpl.cachePsi(document,psiFile);
  FileContentUtil.reparseFiles(project,Collections.<VirtualFile>singletonList(newVFile),false);
  return psiFile;
}
