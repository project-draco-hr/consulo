{
  text=StringUtil.convertLineSeparators(text);
  final boolean scrollToEnd=shouldScrollHistoryToEnd();
  final Document history=myHistoryViewer.getDocument();
  final MarkupModel markupModel=DocumentMarkupModel.forDocument(history,myProject,true);
  final int offset=history.getTextLength();
  appendToHistoryDocument(history,text);
  markupModel.addRangeHighlighter(offset,history.getTextLength(),HighlighterLayer.SYNTAX,attributes,HighlighterTargetArea.EXACT_RANGE);
  if (scrollToEnd) {
    scrollHistoryToEnd();
  }
  queueUiUpdate(scrollToEnd);
}
