{
  int offset=getCurrentEditor().getCaretModel().getOffset();
  myVirtualFile.setLanguage(language);
  FileManager fileManager=((PsiManagerEx)PsiManager.getInstance(myProject)).getFileManager();
  fileManager.setViewProvider(myVirtualFile,fileManager.createFileViewProvider(myVirtualFile,true));
  reparsePsiFile();
  if (!isConsoleEditorEnabled()) {
    FileEditorManagerEx editorManagerEx=FileEditorManagerEx.getInstanceEx(myProject);
    for (    EditorWindow window : editorManagerEx.getWindows()) {
      editorManagerEx.closeFile(myVirtualFile,window);
    }
    editorManagerEx.openTextEditor(new OpenFileDescriptor(myProject,myVirtualFile,offset),true);
  }
}
