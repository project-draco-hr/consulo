{
  ProgressIndicatorProvider.checkCanceled();
  boolean oldIsErrorElement=oldNode instanceof PsiErrorElement;
  boolean newIsErrorElement=newNode.getTokenType() == TokenType.ERROR_ELEMENT;
  if (oldIsErrorElement != newIsErrorElement)   return ThreeState.NO;
  if (oldIsErrorElement) {
    final PsiErrorElement e1=(PsiErrorElement)oldNode;
    return Comparing.equal(e1.getErrorDescription(),getErrorMessage(newNode)) ? ThreeState.UNSURE : ThreeState.NO;
  }
  if (newNode instanceof Token) {
    final IElementType type=newNode.getTokenType();
    final Token token=(Token)newNode;
    if (oldNode instanceof ForeignLeafPsiElement) {
      return type instanceof ForeignLeafType && ((ForeignLeafType)type).getValue().equals(oldNode.getText()) ? ThreeState.YES : ThreeState.NO;
    }
    if (oldNode instanceof LeafElement) {
      if (type instanceof ForeignLeafType)       return ThreeState.NO;
      return ((LeafElement)oldNode).textMatches(token.getText()) ? ThreeState.YES : ThreeState.NO;
    }
    if (type instanceof ILightLazyParseableElementType) {
      return ((TreeElement)oldNode).textMatches(token.getText()) ? ThreeState.YES : TreeUtil.isCollapsedChameleon(oldNode) ? ThreeState.NO : ThreeState.UNSURE;
    }
    if (oldNode.getElementType() instanceof ILazyParseableElementType && type instanceof ILazyParseableElementType || oldNode.getElementType() instanceof CustomParsingType && type instanceof CustomParsingType) {
      return ((TreeElement)oldNode).textMatches(token.getText()) ? ThreeState.YES : ThreeState.NO;
    }
  }
  if (custom != null) {
    return custom.fun(oldNode,newNode,myTreeStructure);
  }
  return ThreeState.UNSURE;
}
