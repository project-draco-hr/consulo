{
  DiffLog diffLog=new DiffLog();
  DiffTreeChangeBuilder<ASTNode,LighterASTNode> builder=new ConvertFromTokensToASTBuilder(newRoot,diffLog);
  MyTreeStructure treeStructure=new MyTreeStructure(newRoot,null);
  ShallowNodeComparator<ASTNode,LighterASTNode> comparator=new MyComparator(getUserDataUnprotected(CUSTOM_COMPARATOR),treeStructure);
  ProgressIndicator indicator=ProgressIndicatorProvider.getGlobalProgressIndicator();
  BlockSupportImpl.diffTrees(oldRoot,builder,comparator,treeStructure,indicator == null ? new EmptyProgressIndicator() : indicator,lastCommittedText);
  return diffLog;
}
