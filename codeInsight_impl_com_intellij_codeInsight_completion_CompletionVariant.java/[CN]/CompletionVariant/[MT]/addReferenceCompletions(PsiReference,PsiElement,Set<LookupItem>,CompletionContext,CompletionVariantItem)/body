{
  if (item.myCompletion instanceof ElementFilter) {
    final CompletionProcessor processor=new CompletionProcessor(context,position,(ElementFilter)item.myCompletion);
    if (reference instanceof PsiMultiReference) {
      int javaReferenceStart=-1;
      for (      PsiReference ref : ((PsiMultiReference)reference).getReferences()) {
        if (ref instanceof PsiJavaReference) {
          if (javaReferenceStart == -1) {
            javaReferenceStart=ref.getElement().getTextRange().getStartOffset() + ref.getRangeInElement().getStartOffset();
          }
 else {
            int newStart=ref.getElement().getTextRange().getStartOffset() + ref.getRangeInElement().getStartOffset();
            if (newStart == javaReferenceStart)             continue;
          }
        }
        addReferenceCompletions(ref,position,set,context,item);
      }
    }
 else     if (reference instanceof PsiJavaReference) {
      ((PsiJavaReference)reference).processVariants(processor);
    }
 else {
      final Object[] completions=reference.getVariants();
      if (completions == null)       return;
      for (      Object completion : completions) {
        if (completion instanceof PsiElement) {
          processor.execute((PsiElement)completion,PsiSubstitutor.EMPTY);
        }
 else         if (completion instanceof CandidateInfo) {
          final CandidateInfo info=(CandidateInfo)completion;
          if (info.isValidResult()) {
            processor.execute(info.getElement(),PsiSubstitutor.EMPTY);
          }
        }
 else {
          addLookupItem(set,item,completion,context);
        }
      }
    }
    Collection<CompletionElement> results=processor.getResults();
    if (results != null) {
      for (      CompletionElement element : results) {
        final LookupItem lookupItem=addLookupItem(set,item,element.getElement(),context);
        if (lookupItem != null) {
          lookupItem.setAttribute(LookupItem.SUBSTITUTOR,element.getSubstitutor());
          if (element.getQualifier() != null) {
            CompletionUtil.setQualifierType(lookupItem,element.getQualifier());
          }
        }
      }
    }
  }
}
