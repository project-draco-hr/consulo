{
  if (item.myCompletion instanceof ElementFilter) {
    final CompletionProcessor processor=new CompletionProcessor(prefix,position,(ElementFilter)item.myCompletion);
    if (reference instanceof PsiJavaReference) {
      ((PsiJavaReference)reference).processVariants(processor);
    }
 else {
      Set<Object> variants=new THashSet<Object>();
      filterVariants(reference,prefix,position,variants);
      if (variants.isEmpty())       return;
      for (      Object completion : variants) {
        if (completion instanceof PsiElement) {
          processor.execute((PsiElement)completion,PsiSubstitutor.EMPTY);
        }
 else         if (completion instanceof CandidateInfo) {
          final CandidateInfo info=(CandidateInfo)completion;
          if (info.isValidResult()) {
            processor.execute(info.getElement(),PsiSubstitutor.EMPTY);
          }
        }
 else {
          addLookupItem(set,item,completion,prefix);
        }
      }
    }
    Collection<CompletionElement> results=processor.getResults();
    if (results != null) {
      for (      CompletionElement element : results) {
        final LookupItem lookupItem=addLookupItem(set,item,element.getElement(),prefix);
        lookupItem.setAttribute(LookupItem.SUBSTITUTOR,element.getSubstitutor());
        if (element.getQualifier() != null) {
          CompletionUtil.setQualifierType(lookupItem,element.getQualifier());
        }
      }
    }
  }
}
