{
  int oldSelectionStart=editor.getSelectionModel().getSelectionStart();
  int oldSelectionEnd=editor.getSelectionModel().getSelectionEnd();
  if (!editor.getSelectionModel().hasSelection()) {
    oldSelectionStart=editor.getCaretModel().getOffset();
    oldSelectionEnd=oldSelectionStart;
  }
  Document document=editor.getDocument();
  int startIndex=document.getLineNumber(oldSelectionStart);
  if (startIndex == -1) {
    startIndex=document.getLineCount() - 1;
  }
  int endIndex=document.getLineNumber(oldSelectionEnd);
  if (endIndex > 0 && document.getLineStartOffset(endIndex) == oldSelectionEnd && editor.getSelectionModel().hasSelection()) {
    endIndex--;
  }
  if (endIndex == -1) {
    endIndex=document.getLineCount() - 1;
  }
  VirtualFile vFile=FileDocumentManager.getInstance().getFile(document);
  final FileType fileType=vFile == null ? null : vFile.getFileType();
  int blockIndent=CodeStyleFacade.getInstance(project).getIndentSize(fileType);
  doIndent(endIndex,startIndex,document,project,editor,blockIndent);
}
