def ftp_open(self, req):
    host = req.get_host()
    if (not host):
        raise IOError('ftp error', 'no host given')
    (host, port) = splitport(host)
    if (port is None):
        port = ftplib.FTP_PORT
    else:
        port = int(port)
    (user, host) = splituser(host)
    if user:
        (user, passwd) = splitpasswd(user)
    else:
        passwd = None
    host = unquote(host)
    user = unquote((user or ''))
    passwd = unquote((passwd or ''))
    try:
        host = socket.gethostbyname(host)
    except socket.error as msg:
        raise urllib2.URLError(msg)
    (path, attrs) = splitattr(req.get_selector())
    dirs = path.split('/')
    dirs = map(unquote, dirs)
    (dirs, file) = (dirs[:(-1)], dirs[(-1)])
    if (dirs and (not dirs[0])):
        dirs = dirs[1:]
    try:
        fw = self.connect_ftp(user, passwd, host, port, dirs)
        type = ((file and 'I') or 'D')
        for attr in attrs:
            (attr, value) = splitattr(attr)
            if ((attr.lower() == 'type') and (value in ('a', 'A', 'i', 'I', 'd', 'D'))):
                type = value.upper()
        rest = None
        range_tup = range_header_to_tuple(req.headers.get('Range', None))
        assert (range_tup != ())
        if range_tup:
            (fb, lb) = range_tup
            if (fb > 0):
                rest = fb
        (fp, retrlen) = fw.retrfile(file, type, rest)
        if range_tup:
            (fb, lb) = range_tup
            if (lb == ''):
                if ((retrlen is None) or (retrlen == 0)):
                    raise RangeError('Requested Range Not Satisfiable due to unobtainable file length.')
                lb = retrlen
                retrlen = (lb - fb)
                if (retrlen < 0):
                    raise RangeError('Requested Range Not Satisfiable')
            else:
                retrlen = (lb - fb)
                fp = RangeableFileObject(fp, (0, retrlen))
        headers = ''
        mtype = mimetypes.guess_type(req.get_full_url())[0]
        if mtype:
            headers += ('Content-Type: %s\n' % mtype)
        if ((retrlen is not None) and (retrlen >= 0)):
            headers += ('Content-Length: %d\n' % retrlen)
        headers = email.message_from_string(headers)
        return addinfourl(fp, headers, req.get_full_url())
    except ftplib.all_errors as msg:
        raise IOError('ftp error', msg), sys.exc_info()[2]
