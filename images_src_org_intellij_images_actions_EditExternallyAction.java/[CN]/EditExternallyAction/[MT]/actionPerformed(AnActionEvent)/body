{
  Project project=e.getData(PlatformDataKeys.PROJECT);
  VirtualFile[] files=e.getData(PlatformDataKeys.VIRTUAL_FILE_ARRAY);
  Options options=OptionsManager.getInstance().getOptions();
  String executablePath=options.getExternalEditorOptions().getExecutablePath();
  if (StringUtil.isEmpty(executablePath)) {
    Messages.showErrorDialog(project,ImagesBundle.message("error.empty.external.editor.path"),ImagesBundle.message("error.title.empty.external.editor.path"));
    OptionsConfigurabe.show(project);
  }
 else {
    if (files != null) {
      Map<String,String> env=EnvironmentUtil.getEnviromentProperties();
      Set<String> varNames=env.keySet();
      for (      String varName : varNames) {
        if (SystemInfo.isWindows) {
          executablePath=StringUtil.replace(executablePath,"%" + varName + "%",env.get(varName),true);
        }
 else {
          executablePath=StringUtil.replace(executablePath,"${" + varName + "}",env.get(varName),false);
        }
      }
      executablePath=FileUtil.toSystemDependentName(executablePath);
      File executable=new File(executablePath);
      GeneralCommandLine commandLine=new GeneralCommandLine();
      final String path=executable.exists() ? executable.getAbsolutePath() : executablePath;
      if (SystemInfo.isMac) {
        commandLine.setExePath(ExecUtil.getOpenCommandPath());
        commandLine.addParameter("-a");
        commandLine.addParameter(path);
      }
 else {
        commandLine.setExePath(path);
      }
      ImageFileTypeManager typeManager=ImageFileTypeManager.getInstance();
      for (      VirtualFile file : files) {
        if (file.isInLocalFileSystem() && typeManager.isImage(file)) {
          commandLine.addParameter(VfsUtil.virtualToIoFile(file).getAbsolutePath());
        }
      }
      commandLine.setWorkDirectory(new File(executablePath).getParentFile());
      try {
        commandLine.createProcess();
      }
 catch (      ExecutionException ex) {
        Messages.showErrorDialog(project,ex.getLocalizedMessage(),ImagesBundle.message("error.title.launching.external.editor"));
        OptionsConfigurabe.show(project);
      }
    }
  }
}
