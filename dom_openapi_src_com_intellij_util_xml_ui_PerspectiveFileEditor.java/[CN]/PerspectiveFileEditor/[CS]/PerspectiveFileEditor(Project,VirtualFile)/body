{
  myProject=project;
  myFile=file;
  FileEditorManager.getInstance(myProject).addFileEditorManagerListener(new FileEditorManagerAdapter(){
    public void selectionChanged(    FileEditorManagerEvent event){
      if (PerspectiveFileEditor.this.equals(event.getOldEditor())) {
        deselectNotify();
        if (event.getNewEditor() instanceof TextEditor) {
          setSelectionInTextEditor((TextEditor)event.getNewEditor(),getSelectedDomElement());
        }
      }
 else       if (PerspectiveFileEditor.this.equals(event.getNewEditor())) {
        selectNotify();
        if (event.getOldEditor() instanceof TextEditor) {
          final DomElement element=getSelectedDomElementFromTextEditor((TextEditor)event.getOldEditor());
          if (element != null) {
            setSelectedDomElement(element);
          }
        }
 else         if (event.getOldEditor() instanceof PerspectiveFileEditor) {
          setSelectedDomElement(((PerspectiveFileEditor)event.getOldEditor()).getSelectedDomElement());
        }
      }
    }
  }
,this);
  startListeningDocuments();
  final PsiFile psiFile=getPsiFile();
  if (psiFile != null) {
    final Document document=PsiDocumentManager.getInstance(getProject()).getDocument(psiFile);
    if (document != null) {
      addWatchedDocument(document);
    }
  }
  CommandProcessor.getInstance().addCommandListener(new CommandAdapter(){
    public void commandStarted(    CommandEvent event){
      undoTransparentActionStarted();
    }
    public void undoTransparentActionStarted(){
      myDirty=false;
    }
    public void undoTransparentActionFinished(){
      if (myDirty) {
        SwingUtilities.invokeLater(new Runnable(){
          public void run(){
            PsiDocumentManager.getInstance(project).commitAllDocuments();
            reset();
          }
        }
);
      }
    }
    public void commandFinished(    CommandEvent event){
      undoTransparentActionFinished();
    }
  }
,this);
}
