{
  ProgramParametersUtil.configureConfiguration(parameters,configuration);
  Project project=configuration.getProject();
  Module module=ProgramParametersUtil.getModule(configuration);
  String vmParameters=configuration.getVMParameters();
  if (vmParameters != null) {
    vmParameters=ProgramParametersUtil.expandPath(vmParameters,module,project);
  }
  if (parameters.getEnv() != null) {
    final Map<String,String> envs=new HashMap<String,String>();
    for (    String env : parameters.getEnv().keySet()) {
      final String value=ProgramParametersUtil.expandPath(parameters.getEnv().get(env),module,project);
      envs.put(env,value);
      if (vmParameters != null) {
        vmParameters=StringUtil.replace(vmParameters,"$" + env + "$",value,false);
      }
    }
    parameters.setEnv(envs);
  }
  parameters.getVMParametersList().addParametersString(vmParameters);
}
