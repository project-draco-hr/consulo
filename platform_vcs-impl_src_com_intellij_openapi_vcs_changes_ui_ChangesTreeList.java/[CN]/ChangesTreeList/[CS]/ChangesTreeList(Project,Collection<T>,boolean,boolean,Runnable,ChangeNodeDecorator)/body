{
  myProject=project;
  myShowCheckboxes=showCheckboxes;
  myHighlightProblems=highlightProblems;
  myInclusionListener=inclusionListener;
  myChangeDecorator=decorator;
  myIncludedChanges=new HashSet<T>(initiallyIncluded);
  myAlwaysExpandList=true;
  myCards=new CardLayout();
  setLayout(myCards);
  final int checkboxWidth=new JCheckBox().getPreferredSize().width;
  myTree=new Tree(ChangesBrowserNode.create(myProject,ROOT)){
    @Override public boolean isFileColorsEnabled(){
      final boolean enabled=Registry.is("file.colors.in.commit.dialog") && FileColorManager.getInstance(project).isEnabled() && FileColorManager.getInstance(project).isEnabledForProjectView();
      final boolean opaque=isOpaque();
      if (enabled && opaque) {
        setOpaque(false);
      }
 else       if (!enabled && !opaque) {
        setOpaque(true);
      }
      return enabled;
    }
    @Override public Color getFileColorFor(    Object object){
      VirtualFile file=null;
      if (object instanceof FilePathImpl) {
        file=LocalFileSystem.getInstance().findFileByPath(((FilePathImpl)object).getPath());
      }
 else       if (object instanceof Change) {
        file=((Change)object).getVirtualFile();
      }
      if (file != null) {
        return FileColorManager.getInstance(project).getFileColor(file);
      }
      return super.getFileColorFor(object);
    }
    public Dimension getPreferredScrollableViewportSize(){
      Dimension size=super.getPreferredScrollableViewportSize();
      size=new Dimension(size.width + 10,size.height);
      return size;
    }
    protected void processMouseEvent(    MouseEvent e){
      if (e.getID() == MouseEvent.MOUSE_PRESSED) {
        if (!myTree.isEnabled())         return;
        int row=myTree.getRowForLocation(e.getX(),e.getY());
        if (row >= 0) {
          final Rectangle baseRect=myTree.getRowBounds(row);
          baseRect.setSize(checkboxWidth,baseRect.height);
          if (baseRect.contains(e.getPoint())) {
            myTree.setSelectionRow(row);
            toggleSelection();
          }
        }
      }
      super.processMouseEvent(e);
    }
    public int getToggleClickCount(){
      return -1;
    }
  }
;
  myTree.setRootVisible(false);
  myTree.setShowsRootHandles(true);
  myTree.setOpaque(false);
  myTree.setCellRenderer(new MyTreeCellRenderer());
  new TreeSpeedSearch(myTree,new Convertor<TreePath,String>(){
    public String convert(    TreePath o){
      ChangesBrowserNode node=(ChangesBrowserNode)o.getLastPathComponent();
      return node.getTextPresentation();
    }
  }
);
  myList=new JBList(new DefaultListModel());
  myList.setVisibleRowCount(10);
  add(myListScrollPane=ScrollPaneFactory.createScrollPane(myList),LIST_CARD);
  add(myTreeScrollPane=ScrollPaneFactory.createScrollPane(myTree),TREE_CARD);
  new ListSpeedSearch(myList){
    protected String getElementText(    Object element){
      if (element instanceof Change) {
        return ChangesUtil.getFilePath((Change)element).getName();
      }
      return super.getElementText(element);
    }
  }
;
  myList.setCellRenderer(new MyListCellRenderer());
  new MyToggleSelectionAction().registerCustomShortcutSet(new CustomShortcutSet(KeyStroke.getKeyStroke(KeyEvent.VK_SPACE,0)),this);
  if (myShowCheckboxes) {
    registerKeyboardAction(new ActionListener(){
      public void actionPerformed(      ActionEvent e){
        includeSelection();
      }
    }
,KeyStroke.getKeyStroke(KeyEvent.VK_INSERT,0),JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
    registerKeyboardAction(new ActionListener(){
      public void actionPerformed(      ActionEvent e){
        excludeSelection();
      }
    }
,KeyStroke.getKeyStroke(KeyEvent.VK_DELETE,0),JComponent.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
  }
  myList.addMouseListener(new MouseAdapter(){
    public void mouseClicked(    MouseEvent e){
      final int idx=myList.locationToIndex(e.getPoint());
      if (idx >= 0) {
        final Rectangle baseRect=myList.getCellBounds(idx,idx);
        baseRect.setSize(checkboxWidth,baseRect.height);
        if (baseRect.contains(e.getPoint())) {
          toggleSelection();
          e.consume();
        }
 else         if (e.getClickCount() == 2) {
          myDoubleClickHandler.run();
          e.consume();
        }
      }
    }
  }
);
  myTree.addMouseListener(new MouseAdapter(){
    public void mouseClicked(    MouseEvent e){
      final int row=myTree.getRowForLocation(e.getPoint().x,e.getPoint().y);
      if (row >= 0) {
        final Rectangle baseRect=myTree.getRowBounds(row);
        baseRect.setSize(checkboxWidth,baseRect.height);
        if (!baseRect.contains(e.getPoint()) && e.getClickCount() == 2) {
          myDoubleClickHandler.run();
          e.consume();
        }
      }
    }
  }
);
  setShowFlatten(PropertiesComponent.getInstance(myProject).isTrueValue(FLATTEN_OPTION_KEY));
  String emptyText=StringUtil.capitalize(DiffBundle.message("diff.count.differences.status.text",0));
  setEmptyText(emptyText);
}
