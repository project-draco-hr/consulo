{
  if (patch.isNewFile())   return createForAddition(patch);
  final String beforeVersionId=patch.getBeforeVersionId();
  if (beforeVersionId == null) {
    throw new VcsException(VcsBundle.message("patch.load.base.revision.error",pathBeforeRename,"No revision specified for base version."));
  }
  final DefaultPatchBaseVersionProvider provider=new DefaultPatchBaseVersionProvider(project,file,beforeVersionId);
  if (provider.canProvideContent()) {
    return new ApplyPatchForBaseRevisionTexts(provider,pathBeforeRename,patch,file);
  }
 else {
    if (!provider.hasVcs()) {
      throw new VcsException(VcsBundle.message("patch.load.base.revision.error",pathBeforeRename,"Target file is not under version control."));
    }
 else {
      throw new VcsException(VcsBundle.message("patch.load.base.revision.error",pathBeforeRename,"Can not parse base revision."));
    }
  }
}
