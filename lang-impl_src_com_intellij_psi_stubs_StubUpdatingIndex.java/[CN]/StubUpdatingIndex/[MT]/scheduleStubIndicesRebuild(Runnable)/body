{
  final Runnable rebuildRunnable=new Runnable(){
    public void run(){
      try {
        FileBasedIndex.getInstance().processAllValues(INDEX_ID,new FileBasedIndex.AllValuesProcessor<SerializedStubTree>(){
          public void process(          final int inputId,          final SerializedStubTree value){
            final Map<StubIndexKey,Map<Object,TIntArrayList>> stubTree=new StubTree((PsiFileStub)value.getStub()).indexStubTree();
            updateAffectedStubIndices(inputId,Collections.<StubIndexKey,Map<Object,TIntArrayList>>emptyMap(),stubTree);
          }
        }
);
      }
  finally {
        if (finishCallback != null) {
          finishCallback.run();
        }
      }
    }
  }
;
  final Application application=ApplicationManager.getApplication();
  if (application.isUnitTestMode()) {
    rebuildRunnable.run();
  }
 else {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        new Task.Modal(null,"Updating index",false){
          public void run(          @NotNull final ProgressIndicator indicator){
            rebuildRunnable.run();
          }
        }
.queue();
      }
    }
);
  }
}
