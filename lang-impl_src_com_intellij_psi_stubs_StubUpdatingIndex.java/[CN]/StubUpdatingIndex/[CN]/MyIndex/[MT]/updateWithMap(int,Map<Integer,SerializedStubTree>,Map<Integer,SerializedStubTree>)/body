{
  checkNameStorage();
  final Map<StubIndexKey,Map<Object,TIntArrayList>> oldStubTree=getStubTree(oldData);
  final Map<StubIndexKey,Map<Object,TIntArrayList>> newStubTree=getStubTree(newData);
  final Collection<StubIndexKey> affectedIndices=getAffectedIndices(oldStubTree,newStubTree);
  final StubIndexImpl stubIndex=(StubIndexImpl)StubIndex.getInstance();
  try {
    for (    StubIndexKey key : affectedIndices) {
      stubIndex.getWriteLock(key).lock();
    }
    try {
      getWriteLock().lock();
      super.updateWithMap(inputId,oldData,newData);
      updateStubIndices(affectedIndices,inputId,oldStubTree,newStubTree);
    }
  finally {
      getWriteLock().unlock();
    }
  }
  finally {
    for (    StubIndexKey key : affectedIndices) {
      stubIndex.getWriteLock(key).unlock();
    }
  }
}
