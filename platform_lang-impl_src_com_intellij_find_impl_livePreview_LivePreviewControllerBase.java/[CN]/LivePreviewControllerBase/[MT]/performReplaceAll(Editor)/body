{
  if (!ReadonlyStatusHandler.ensureDocumentWritable(e.getProject(),e.getDocument()))   return;
  if (mySearchResults.getFindModel() != null) {
    final FindModel copy=new FindModel();
    copy.copyFrom(mySearchResults.getFindModel());
    final SelectionModel selectionModel=mySearchResults.getEditor().getSelectionModel();
    final int offset;
    if ((!selectionModel.hasSelection() && !selectionModel.hasBlockSelection()) || copy.isGlobal()) {
      copy.setGlobal(true);
      offset=0;
    }
 else {
      offset=selectionModel.getBlockSelectionStarts()[0];
    }
    FindUtil.replace(e.getProject(),e,offset,copy,this);
    if (myReplaceListener != null) {
      myReplaceListener.replaceAllPerformed(e);
    }
  }
}
