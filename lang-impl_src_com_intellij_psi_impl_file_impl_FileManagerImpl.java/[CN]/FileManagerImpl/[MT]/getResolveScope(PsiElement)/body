{
  final ProgressManager progressManager=ProgressManager.getInstance();
  progressManager.checkCanceled();
  VirtualFile vFile;
  final Project project=myManager.getProject();
  if (element instanceof PsiDirectory) {
    vFile=((PsiDirectory)element).getVirtualFile();
  }
 else {
    final PsiFile containingFile=element.getContainingFile();
    if (containingFile instanceof PsiCodeFragment) {
      final GlobalSearchScope forcedScope=((PsiCodeFragment)containingFile).getForcedResolveScope();
      if (forcedScope != null) {
        return forcedScope;
      }
      final PsiElement context=containingFile.getContext();
      if (context == null) {
        return GlobalSearchScope.allScope(project);
      }
      return getResolveScope(context);
    }
    final PsiFile contextFile=containingFile != null ? FileContextUtil.getContextFile(containingFile) : null;
    if (contextFile == null) {
      return GlobalSearchScope.allScope(project);
    }
 else     if (contextFile instanceof FileResolveScopeProvider) {
      return ((FileResolveScopeProvider)contextFile).getFileResolveScope();
    }
    vFile=contextFile.getVirtualFile();
    if (vFile == null) {
      PsiFile originalFile=contextFile.getOriginalFile();
      if (originalFile != null) {
        vFile=originalFile.getVirtualFile();
      }
    }
  }
  if (vFile == null) {
    return GlobalSearchScope.allScope(project);
  }
  ProjectFileIndex projectFileIndex=myProjectRootManager.getFileIndex();
  Module module=projectFileIndex.getModuleForFile(vFile);
  if (module != null) {
    boolean includeTests=projectFileIndex.isInTestSourceContent(vFile) || !projectFileIndex.isContentJavaSourceFile(vFile);
    return GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(module,includeTests);
  }
 else {
    List<Module> modulesLibraryUsedIn=new ArrayList<Module>();
    List<OrderEntry> orderEntries=projectFileIndex.getOrderEntriesForFile(vFile);
    for (    OrderEntry entry : orderEntries) {
      progressManager.checkCanceled();
      if (entry instanceof JdkOrderEntry) {
        return ((ProjectRootManagerEx)myProjectRootManager).getScopeForJdk((JdkOrderEntry)entry);
      }
      if (entry instanceof LibraryOrderEntry || entry instanceof ModuleOrderEntry) {
        modulesLibraryUsedIn.add(entry.getOwnerModule());
      }
    }
    return ((ProjectRootManagerEx)myProjectRootManager).getScopeForLibraryUsedIn(modulesLibraryUsedIn);
  }
}
