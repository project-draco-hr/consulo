{
  final PsiClass aClass=p.getClassToProcess();
  final PsiManagerImpl psiManager=(PsiManagerImpl)PsiManager.getInstance(aClass.getProject());
  final SearchScope useScope=ApplicationManager.getApplication().runReadAction(new Computable<SearchScope>(){
    @Override public SearchScope compute(){
      return aClass.getUseScope();
    }
  }
);
  final String qualifiedName=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
    @Override public String compute(){
      return aClass.getQualifiedName();
    }
  }
);
  if (CommonClassNames.JAVA_LANG_OBJECT.equals(qualifiedName)) {
    final SearchScope scope=useScope.intersectWith(GlobalSearchScope.notScope(GlobalSearchScope.getScopeRestrictedByFileTypes(GlobalSearchScope.allScope(psiManager.getProject()),StdFileTypes.JSP,StdFileTypes.JSPX)));
    return AllClassesSearch.search(scope,aClass.getProject()).forEach(new Processor<PsiClass>(){
      @Override public boolean process(      final PsiClass psiClass){
        if (psiClass.isInterface()) {
          return consumer.process(psiClass);
        }
        final PsiClass superClass=psiClass.getSuperClass();
        if (superClass != null && CommonClassNames.JAVA_LANG_OBJECT.equals(ApplicationManager.getApplication().runReadAction(new Computable<String>(){
          public String compute(){
            return superClass.getQualifiedName();
          }
        }
))) {
          return consumer.process(psiClass);
        }
        return true;
      }
    }
);
  }
  final GlobalSearchScope scope=useScope instanceof GlobalSearchScope ? (GlobalSearchScope)useScope : new EverythingGlobalScope(psiManager.getProject());
  final String searchKey=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
    @Override public String compute(){
      return aClass.getName();
    }
  }
);
  if (StringUtil.isEmpty(searchKey)) {
    return true;
  }
  Collection<PsiReferenceList> candidates=ApplicationManager.getApplication().runReadAction(new Computable<Collection<PsiReferenceList>>(){
    @Override public Collection<PsiReferenceList> compute(){
      return JavaSuperClassNameOccurenceIndex.getInstance().get(searchKey,psiManager.getProject(),scope);
    }
  }
);
  Map<String,List<PsiClass>> classes=new HashMap<String,List<PsiClass>>();
  for (  PsiReferenceList referenceList : candidates) {
    ProgressManager.checkCanceled();
    final PsiClass candidate=(PsiClass)referenceList.getParent();
    if (!checkInheritance(p,aClass,candidate))     continue;
    String fqn=ApplicationManager.getApplication().runReadAction(new Computable<String>(){
      @Override public String compute(){
        return candidate.getQualifiedName();
      }
    }
);
    List<PsiClass> list=classes.get(fqn);
    if (list == null) {
      list=new ArrayList<PsiClass>();
      classes.put(fqn,list);
    }
    list.add(candidate);
  }
  for (  List<PsiClass> sameNamedClasses : classes.values()) {
    if (!processSameNamedClasses(consumer,aClass,sameNamedClasses))     return false;
  }
  if (p.includeAnonymous()) {
    Collection<PsiAnonymousClass> anonymousCandidates=ApplicationManager.getApplication().runReadAction(new Computable<Collection<PsiAnonymousClass>>(){
      @Override public Collection<PsiAnonymousClass> compute(){
        return JavaAnonymousClassBaseRefOccurenceIndex.getInstance().get(searchKey,psiManager.getProject(),scope);
      }
    }
);
    for (    PsiAnonymousClass candidate : anonymousCandidates) {
      ProgressManager.checkCanceled();
      if (!checkInheritance(p,aClass,candidate))       continue;
      if (!consumer.process(candidate))       return false;
    }
    if (aClass.isEnum()) {
      PsiField[] fields=ApplicationManager.getApplication().runReadAction(new Computable<PsiField[]>(){
        @Override public PsiField[] compute(){
          return aClass.getFields();
        }
      }
);
      for (      final PsiField field : fields) {
        if (field instanceof PsiEnumConstant) {
          PsiEnumConstantInitializer initializingClass=ApplicationManager.getApplication().runReadAction(new Computable<PsiEnumConstantInitializer>(){
            @Override public PsiEnumConstantInitializer compute(){
              return ((PsiEnumConstant)field).getInitializingClass();
            }
          }
);
          if (initializingClass != null) {
            if (!consumer.process(initializingClass))             return false;
          }
        }
      }
    }
  }
  return true;
}
