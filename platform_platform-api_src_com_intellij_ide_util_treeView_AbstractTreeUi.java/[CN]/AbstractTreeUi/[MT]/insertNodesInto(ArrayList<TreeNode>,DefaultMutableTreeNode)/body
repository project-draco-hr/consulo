{
  sortChildren(parentNode,toInsert,false,true);
  final ArrayList<TreeNode> all=new ArrayList<TreeNode>(toInsert.size() + parentNode.getChildCount());
  all.addAll(toInsert);
  all.addAll(TreeUtil.childrenToArray(parentNode));
  if (!toInsert.isEmpty()) {
    sortChildren(parentNode,all,true,true);
    int[] newNodeIndices=new int[toInsert.size()];
    int eachNewNodeIndex=0;
    TreeMap<Integer,TreeNode> insertSet=new TreeMap<Integer,TreeNode>();
    for (int i=0; i < toInsert.size(); i++) {
      TreeNode eachNewNode=toInsert.get(i);
      while (all.get(eachNewNodeIndex) != eachNewNode) {
        eachNewNodeIndex++;
      }
      newNodeIndices[i]=eachNewNodeIndex;
      insertSet.put(eachNewNodeIndex,eachNewNode);
    }
    for (    Integer eachIndex : insertSet.keySet()) {
      TreeNode eachNode=insertSet.get(eachIndex);
      parentNode.insert((MutableTreeNode)eachNode,eachIndex);
    }
    myTreeModel.nodesWereInserted(parentNode,newNodeIndices);
  }
 else {
    ArrayList<TreeNode> before=new ArrayList<TreeNode>();
    before.addAll(all);
    sortChildren(parentNode,all,true,false);
    if (!before.equals(all)) {
      processInnerChange(new Runnable(){
        @Override public void run(){
          Enumeration<TreePath> expanded=getTree().getExpandedDescendants(getPathFor(parentNode));
          TreePath[] selected=getTree().getSelectionModel().getSelectionPaths();
          parentNode.removeAllChildren();
          for (          TreeNode each : all) {
            parentNode.add((MutableTreeNode)each);
          }
          myTreeModel.nodeStructureChanged(parentNode);
          if (expanded != null) {
            while (expanded.hasMoreElements()) {
              expandSilently(expanded.nextElement());
            }
          }
          if (selected != null) {
            for (            TreePath each : selected) {
              if (!getTree().getSelectionModel().isPathSelected(each)) {
                addSelectionSilently(each);
              }
            }
          }
        }
      }
);
    }
  }
}
