{
  LightVirtualFile fileCopy=new LightVirtualFile(getVirtualFile(),getContents(),getModificationStamp());
  fileCopy.putUserData(UndoManager.DONT_RECORD_UNDO,Boolean.TRUE);
  final CompositeLanguageFileViewProvider viewProvider=cloneInner(fileCopy);
  final PsiFileImpl psiFile=(PsiFileImpl)viewProvider.getPsi(getBaseLanguage());
  final FileElement treeClone=(FileElement)psiFile.calcTreeElement().clone();
  psiFile.setTreeElementPointer(treeClone);
  treeClone.setPsi(psiFile);
  for (  Map.Entry<Language,PsiFile> entry : myRoots.entrySet()) {
    final PsiFile root=entry.getValue();
    if (root != psiFile && root != null) {
      if (root instanceof LightPsiFileImpl) {
        final LightPsiFileImpl lightFile=(LightPsiFileImpl)root;
        final LightPsiFileImpl clone=lightFile.copyLight(viewProvider);
        clone.setOriginalFile(root);
        viewProvider.myRoots.put(entry.getKey(),clone);
      }
 else {
        LOG.error("Only light files supported for language extensions, passed: " + root);
      }
    }
  }
  return viewProvider;
}
