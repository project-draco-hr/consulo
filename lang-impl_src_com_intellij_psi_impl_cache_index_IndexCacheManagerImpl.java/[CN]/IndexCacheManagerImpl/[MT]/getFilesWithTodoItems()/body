{
  final FileBasedIndex fileBasedIndex=FileBasedIndex.getInstance();
  final Set<PsiFile> allFiles=new HashSet<PsiFile>();
  for (  IndexPattern indexPattern : IdCacheUtil.getIndexPatterns()) {
    final Collection<VirtualFile> files=fileBasedIndex.getContainingFiles(TodoIndex.NAME,new TodoIndexEntry(indexPattern.getPatternString(),indexPattern.isCaseSensitive()),myProject);
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        for (        VirtualFile file : files) {
          final PsiFile psiFile=myPsiManager.findFile(file);
          if (psiFile != null) {
            allFiles.add(psiFile);
          }
        }
      }
    }
);
  }
  return allFiles.toArray(new PsiFile[allFiles.size()]);
}
