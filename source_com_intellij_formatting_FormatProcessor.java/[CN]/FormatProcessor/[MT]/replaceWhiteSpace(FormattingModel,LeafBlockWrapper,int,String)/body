{
  final WhiteSpace whiteSpace=block.getWhiteSpace();
  final TextRange textRange=whiteSpace.getTextRange();
  final TextRange wsRange=shiftRange(textRange,shift);
  TextRange newWhiteSpaceRange=model.replaceWhiteSpace(wsRange,newWhiteSpace);
  shift+=(newWhiteSpaceRange.getLength() - (textRange.getLength()));
  if (block.isLeaf() && whiteSpace.containsLineFeeds() && block.containsLineFeeds()) {
    final TextRange currentBlockRange=shiftRange(block.getTextRange(),shift);
    IndentInside lastLineIndent=block.getLastLineIndent();
    IndentInside whiteSpaceIndent=IndentInside.createIndentOn(IndentInside.getLastLine(newWhiteSpace));
    final int shiftInside=calcShift(lastLineIndent,whiteSpaceIndent);
    final TextRange newBlockRange=model.shiftIndentInsideRange(currentBlockRange,shiftInside);
    shift+=newBlockRange.getLength() - block.getTextRange().getLength();
  }
  return shift;
}
