{
  List<LeafBlockWrapper> blocksToModify=collectBlocksToModify();
  int shift=0;
  boolean bulkReformat=false;
  DocumentEx updatedDocument=null;
  try {
    final int blocksToModifyCount=blocksToModify.size();
    bulkReformat=blocksToModifyCount > 50;
    if (bulkReformat) {
      updatedDocument=getAffectedDocument(model);
      if (updatedDocument != null)       updatedDocument.setInBulkUpdate(true);
    }
    int index=0;
    for (    LeafBlockWrapper block : blocksToModify) {
      shift=replaceWhiteSpace(model,block,shift,block.getWhiteSpace().generateWhiteSpace(myIndentOption));
      ++index;
      if (index + 1 == blocksToModifyCount) {
        if (updatedDocument != null)         updatedDocument.setInBulkUpdate(false);
        updatedDocument=null;
      }
    }
  }
  finally {
    if (bulkReformat && updatedDocument != null) {
      updatedDocument.setInBulkUpdate(false);
    }
    model.commitChanges();
  }
}
