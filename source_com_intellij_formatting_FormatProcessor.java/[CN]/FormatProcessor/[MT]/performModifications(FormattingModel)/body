{
  List<LeafBlockWrapper> blocksToModify=collectBlocksToModify();
  int shift=0;
  boolean bulkReformat=false;
  List<Editor> editorsWithBulkReformatNotified=null;
  try {
    final int blocksToModifyCount=blocksToModify.size();
    bulkReformat=false && blocksToModifyCount > 50;
    if (bulkReformat) {
      editorsWithBulkReformatNotified=buildOpenEditorsForModel(model,editorsWithBulkReformatNotified);
      notifyBulkReformatStatus(editorsWithBulkReformatNotified,true);
    }
    int index=0;
    for (    LeafBlockWrapper block : blocksToModify) {
      shift=replaceWhiteSpace(model,block,shift,block.getWhiteSpace().generateWhiteSpace(myIndentOption));
      ++index;
      if (index + 1 == blocksToModifyCount) {
        notifyBulkReformatStatus(editorsWithBulkReformatNotified,false);
        editorsWithBulkReformatNotified=null;
      }
    }
  }
  finally {
    if (bulkReformat && editorsWithBulkReformatNotified != null) {
      notifyBulkReformatStatus(editorsWithBulkReformatNotified,false);
    }
    model.commitChanges();
  }
}
