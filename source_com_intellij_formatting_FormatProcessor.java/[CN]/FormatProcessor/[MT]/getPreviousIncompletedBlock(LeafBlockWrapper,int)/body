{
  if (block == null)   return null;
  AbstractBlockWrapper current=block;
  while (current.getParent() != null && current.getParent().getStartOffset() > offset) {
    current=current.getParent();
  }
  if (current.getParent() == null)   return null;
  final List<Block> subBlocks=current.getParent().getBlock().getSubBlocks();
  final int index=subBlocks.indexOf(current.getBlock());
  if (index < 0) {
    LOG.assertTrue(false,current.getParent().getBlock().getClass().getName());
  }
  if (index == 0)   return null;
  Block currentResult=subBlocks.get(index - 1);
  if (!currentResult.isIncomplete())   return null;
  Block lastChild=getLastChildOf(currentResult);
  while (lastChild != null && lastChild.isIncomplete()) {
    currentResult=lastChild;
    lastChild=getLastChildOf(currentResult);
  }
  return currentResult;
}
