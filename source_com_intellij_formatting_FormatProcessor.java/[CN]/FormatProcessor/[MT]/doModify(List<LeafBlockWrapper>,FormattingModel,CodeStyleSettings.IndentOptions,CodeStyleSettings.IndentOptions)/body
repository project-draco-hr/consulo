{
  int shift=0;
  boolean bulkReformat=false;
  boolean bulkReformatFinished=false;
  DocumentEx updatedDocument=null;
  try {
    final int blocksToModifyCount=blocksToModify.size();
    bulkReformat=blocksToModifyCount > 50;
    if (bulkReformat) {
      updatedDocument=getAffectedDocument(model);
      if (updatedDocument != null)       updatedDocument.setInBulkUpdate(true);
    }
    int index=0;
    for (int i=0; i < blocksToModifyCount; ++i) {
      final LeafBlockWrapper block=blocksToModify.get(i);
      shift=replaceWhiteSpace(model,block,shift,block.getWhiteSpace().generateWhiteSpace(indentOption),javaOptions);
      ++index;
      if (index + 1 == blocksToModifyCount) {
        if (updatedDocument != null)         updatedDocument.setInBulkUpdate(false);
        bulkReformatFinished=true;
      }
      block.getParent().dispose();
      block.dispose();
      blocksToModify.set(i,null);
    }
  }
  finally {
    if (bulkReformat && updatedDocument != null) {
      if (!bulkReformatFinished) {
        updatedDocument.setInBulkUpdate(false);
      }
    }
    model.commitChanges();
  }
}
