{
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(editor.getProject());
  documentManager.commitDocument(editor.getDocument());
  final PsiFile file=documentManager.getPsiFile(editor.getDocument());
  if (!CodeInsightUtil.prepareFileForWrite(file))   return;
  final Project project=editor.getProject();
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          try {
            Document document=editor.getDocument();
            documentManager.doPostponedOperationsAndUnblockDocument(document);
            documentManager.commitDocument(document);
            EditorModificationUtil.deleteSelectedText(editor);
            doInsert(fqn,element,editor,project);
          }
 catch (          IncorrectOperationException e1) {
            LOG.error(e1);
          }
        }
      }
);
    }
  }
,IdeBundle.message("command.pasting.reference"),null);
}
