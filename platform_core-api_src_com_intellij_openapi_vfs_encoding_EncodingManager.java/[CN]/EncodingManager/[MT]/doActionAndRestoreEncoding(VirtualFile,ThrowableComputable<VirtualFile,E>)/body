{
  Charset charsetBefore=getInstance().getEncoding(fileBefore,true);
  VirtualFile fileAfter=null;
  try {
    fileAfter=action.compute();
    return fileAfter;
  }
  finally {
    if (fileAfter != null) {
      Charset actual=getInstance().getEncoding(fileAfter,true);
      if (!Comparing.equal(actual,charsetBefore)) {
        getInstance().setEncoding(fileAfter,charsetBefore);
      }
    }
  }
}
