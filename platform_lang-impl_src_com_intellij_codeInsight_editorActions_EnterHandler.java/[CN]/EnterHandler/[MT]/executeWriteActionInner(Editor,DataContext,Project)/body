{
  CodeInsightSettings settings=CodeInsightSettings.getInstance();
  if (project == null) {
    myOriginalHandler.execute(editor,dataContext);
    return;
  }
  final Document document=editor.getDocument();
  final PsiFile file=PsiUtilBase.getPsiFileInEditor(editor,project);
  if (file == null) {
    myOriginalHandler.execute(editor,dataContext);
    return;
  }
  CommandProcessor.getInstance().setCurrentCommandName(CodeInsightBundle.message("command.name.typing"));
  EditorModificationUtil.deleteSelectedText(editor);
  int caretOffset=editor.getCaretModel().getOffset();
  CharSequence text=document.getCharsSequence();
  int length=document.getTextLength();
  if (caretOffset < length && text.charAt(caretOffset) != '\n') {
    int offset1=CharArrayUtil.shiftBackward(text,caretOffset," \t");
    if (offset1 < 0 || text.charAt(offset1) == '\n') {
      int offset2=CharArrayUtil.shiftForward(text,offset1 + 1," \t");
      boolean isEmptyLine=offset2 >= length || text.charAt(offset2) == '\n';
      if (!isEmptyLine) {
        myOriginalHandler.execute(editor,dataContext);
        return;
      }
    }
  }
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  documentManager.commitDocument(document);
  boolean forceIndent=false;
  Ref<Integer> caretOffsetRef=new Ref<Integer>(caretOffset);
  Ref<Integer> caretAdvanceRef=new Ref<Integer>(0);
  final EnterHandlerDelegate[] delegates=Extensions.getExtensions(EnterHandlerDelegate.EP_NAME);
  for (  EnterHandlerDelegate delegate : delegates) {
    EnterHandlerDelegate.Result result=delegate.preprocessEnter(file,editor,caretOffsetRef,caretAdvanceRef,dataContext,myOriginalHandler);
    if (caretOffsetRef.get() > document.getTextLength()) {
      throw new AssertionError("Wrong caret offset change by " + delegate);
    }
    if (result == EnterHandlerDelegate.Result.Stop) {
      return;
    }
    if (result != EnterHandlerDelegate.Result.Continue) {
      if (result == EnterHandlerDelegate.Result.DefaultForceIndent) {
        forceIndent=true;
      }
      break;
    }
  }
  text=document.getCharsSequence();
  caretOffset=caretOffsetRef.get().intValue();
  boolean isFirstColumn=caretOffset == 0 || text.charAt(caretOffset - 1) == '\n';
  final boolean insertSpace=!isFirstColumn && !(caretOffset >= text.length() || text.charAt(caretOffset) == ' ' || text.charAt(caretOffset) == '\t');
  editor.getCaretModel().moveToOffset(caretOffset);
  myOriginalHandler.execute(editor,dataContext);
  if (!editor.isInsertMode()) {
    return;
  }
  if (settings.SMART_INDENT_ON_ENTER || forceIndent) {
    caretOffset+=1;
    caretOffset=CharArrayUtil.shiftForward(editor.getDocument().getCharsSequence(),caretOffset," \t");
  }
 else {
    caretOffset=editor.getCaretModel().getOffset();
  }
  documentManager.commitAllDocuments();
  final DoEnterAction action=new DoEnterAction(file,editor,document,dataContext,caretOffset,!insertSpace,caretAdvanceRef.get(),project);
  action.setForceIndent(forceIndent);
  action.run();
  documentManager.commitDocument(document);
  for (  EnterHandlerDelegate delegate : delegates) {
    if (delegate.postProcessEnter(file,editor,dataContext) == EnterHandlerDelegate.Result.Stop) {
      break;
    }
  }
  documentManager.commitDocument(document);
}
