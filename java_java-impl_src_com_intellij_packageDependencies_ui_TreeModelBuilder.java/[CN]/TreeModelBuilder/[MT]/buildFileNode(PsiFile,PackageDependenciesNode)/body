{
  ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  if (indicator != null) {
    indicator.setIndeterminate(false);
    indicator.setText(AnalysisScopeBundle.message("package.dependencies.build.progress.text"));
    final VirtualFile virtualFile=file.getVirtualFile();
    if (virtualFile != null) {
      indicator.setText2(virtualFile.getPresentableUrl());
    }
    indicator.setFraction(((double)myScannedFileCount++) / myTotalFileCount);
  }
  if (file == null || !file.isValid())   return null;
  boolean isMarked=myMarker != null && myMarker.isMarked(file);
  if (isMarked)   myMarkedFileCount++;
  if (isMarked || myAddUnmarkedFiles) {
    PackageDependenciesNode dirNode=parent != null ? parent : getFileParentNode(file);
    if (dirNode == null)     return null;
    if (myShowFiles) {
      FileNode fileNode=new FileNode(file,isMarked);
      dirNode.add(fileNode);
    }
 else {
      dirNode.addFile(file,isMarked);
    }
    return dirNode;
  }
  return null;
}
