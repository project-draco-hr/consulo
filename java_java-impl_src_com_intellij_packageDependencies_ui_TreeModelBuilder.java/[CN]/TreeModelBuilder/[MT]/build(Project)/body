{
  Runnable buildingRunnable=new Runnable(){
    public void run(){
      countFiles(project);
      myFileIndex.iterateContent(new ContentIterator(){
        PackageDependenciesNode lastParent=null;
        VirtualFile dir=null;
        public boolean processFile(        VirtualFile fileOrDir){
          if (!fileOrDir.isDirectory()) {
            if (lastParent != null && !Comparing.equal(dir,fileOrDir.getParent())) {
              lastParent=null;
            }
            lastParent=buildFileNode(fileOrDir,lastParent);
            dir=fileOrDir.getParent();
          }
 else {
            lastParent=null;
          }
          return true;
        }
      }
);
      for (      VirtualFile root : LibraryUtil.getLibraryRoots(project)) {
        processFilesRecursively(root,null);
      }
    }
  }
;
  buildingRunnable.run();
  return new TreeModel(myRoot,myTotalFileCount,myMarkedFileCount);
}
