{
  Runnable buildingRunnable=new Runnable(){
    public void run(){
      countFiles(project);
      final PsiManager psiManager=PsiManager.getInstance(project);
      myFileIndex.iterateContent(new ContentIterator(){
        PackageDependenciesNode lastParent=null;
        public boolean processFile(        VirtualFile fileOrDir){
          if (!fileOrDir.isDirectory()) {
            lastParent=buildFileNode(fileOrDir,lastParent);
          }
 else {
            lastParent=null;
          }
          return true;
        }
      }
);
      for (      VirtualFile root : LibraryUtil.getLibraryRoots(project)) {
        processFilesRecursively(root,null,psiManager);
      }
    }
  }
;
  if (showProgress) {
    ProgressManager.getInstance().runProcessWithProgressSynchronously(buildingRunnable,AnalysisScopeBundle.message("package.dependencies.build.process.title"),true,project);
  }
 else {
    buildingRunnable.run();
  }
  TreeUtil.sort(myRoot,new DependencyNodeComparator(sortByType));
  return new TreeModel(myRoot,myTotalFileCount,myMarkedFileCount);
}
