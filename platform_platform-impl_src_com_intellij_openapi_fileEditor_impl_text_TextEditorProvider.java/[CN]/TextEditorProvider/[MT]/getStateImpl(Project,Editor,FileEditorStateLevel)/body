{
  TextEditorState state=new TextEditorState();
  if (!Registry.is("editor.new.rendering") && editor instanceof EditorImpl && ((EditorImpl)editor).myUseNewRendering)   return state;
  CaretModel caretModel=editor.getCaretModel();
  if (caretModel.supportsMultipleCarets()) {
    List<CaretState> caretsAndSelections=caretModel.getCaretsAndSelections();
    state.CARETS=new TextEditorState.CaretState[caretsAndSelections.size()];
    for (int i=0; i < caretsAndSelections.size(); i++) {
      CaretState caretState=caretsAndSelections.get(i);
      LogicalPosition caretPosition=caretState.getCaretPosition();
      LogicalPosition selectionStartPosition=caretState.getSelectionStart();
      LogicalPosition selectionEndPosition=caretState.getSelectionEnd();
      state.CARETS[i]=createCaretState(caretPosition,selectionStartPosition,selectionEndPosition);
    }
  }
 else {
    LogicalPosition caretPosition=caretModel.getLogicalPosition();
    LogicalPosition selectionStartPosition=editor.offsetToLogicalPosition(editor.getSelectionModel().getSelectionStart());
    LogicalPosition selectionEndPosition=editor.offsetToLogicalPosition(editor.getSelectionModel().getSelectionEnd());
    state.CARETS=new TextEditorState.CaretState[1];
    state.CARETS[0]=createCaretState(caretPosition,selectionStartPosition,selectionEndPosition);
  }
  state.RELATIVE_CARET_POSITION=level == FileEditorStateLevel.UNDO ? Integer.MAX_VALUE : EditorUtil.calcRelativeCaretPosition(editor);
  return state;
}
