{
  TextEditorState state=new TextEditorState();
  CaretModel caretModel=editor.getCaretModel();
  Collection<Caret> allCarets=caretModel.getAllCarets();
  state.CARETS=new TextEditorState.CaretState[allCarets.size()];
  int i=0;
  for (  Caret caret : allCarets) {
    state.CARETS[i]=new TextEditorState.CaretState();
    state.CARETS[i].LINE=caret.getLogicalPosition().line;
    state.CARETS[i].COLUMN=caret.getLogicalPosition().column;
    LogicalPosition selectionStartPosition=editor.visualToLogicalPosition(caret.getSelectionStartPosition());
    LogicalPosition selectionEndPosition=editor.visualToLogicalPosition(caret.getSelectionEndPosition());
    state.CARETS[i].SELECTION_START_LINE=selectionStartPosition.line;
    state.CARETS[i].SELECTION_START_COLUMN=selectionStartPosition.column;
    state.CARETS[i].SELECTION_END_LINE=selectionEndPosition.line;
    state.CARETS[i++].SELECTION_END_COLUMN=selectionEndPosition.column;
  }
  state.VERTICAL_SCROLL_PROPORTION=level == FileEditorStateLevel.UNDO ? -1 : EditorUtil.calcVerticalScrollProportion(editor);
  if (editor instanceof EditorEx) {
    state.VERTICAL_SCROLL_OFFSET=editor.getScrollingModel().getVerticalScrollOffset();
    JScrollBar scrollBar=((EditorEx)editor).getScrollPane().getVerticalScrollBar();
    state.MAX_VERTICAL_SCROLL_OFFSET=scrollBar == null ? 0 : scrollBar.getMaximum();
  }
  return state;
}
