{
  byte[] buffer=new byte[8192];
  OutputStream os=new BufferedOutputStream(sess.getStdin(),512);
  InputStream is=new BufferedInputStream(sess.getStdout(),40000);
  os.write(0x0);
  os.flush();
  for (int i=0; i < targets.length; i++) {
    LenNamePair lnp=null;
    while (true) {
      int c=is.read();
      if (c < 0)       throw new IOException("Remote scp terminated unexpectedly.");
      String line=receiveLine(is);
      if (c == 'T') {
        continue;
      }
      if ((c == 1) || (c == 2))       throw new IOException("Remote SCP error: " + line);
      if (c == 'C') {
        lnp=parseCLine(line);
        break;
      }
      throw new IOException("Remote SCP error: " + ((char)c) + line);
    }
    os.write(0x0);
    os.flush();
    long remain=lnp.length;
    while (remain > 0) {
      int trans;
      if (remain > buffer.length)       trans=buffer.length;
 else       trans=(int)remain;
      int this_time_received=is.read(buffer,0,trans);
      if (this_time_received < 0) {
        throw new IOException("Remote scp terminated connection unexpectedly");
      }
      targets[i].write(buffer,0,this_time_received);
      remain-=this_time_received;
    }
    readResponse(is);
    os.write(0x0);
    os.flush();
  }
}
