{
  if (isLayerActive()) {
    IElementType layerTokenType=myCurrentLayerLexer.getTokenType();
    if (!isStopToken(myCurrentLayerLexer,layerTokenType)) {
      myCurrentLayerLexer.advance();
      layerTokenType=myCurrentLayerLexer.getTokenType();
    }
 else {
      layerTokenType=null;
    }
    if (layerTokenType == null) {
      int tokenEnd=myCurrentLayerLexer.getTokenEnd();
      if (!mySelfStoppingLexers.contains(myCurrentLayerLexer)) {
        myCurrentLayerLexer=null;
        super.advance();
        activateLayerIfNecessary();
      }
 else {
        myCurrentLayerLexer=null;
      }
    }
  }
 else {
    super.advance();
    activateLayerIfNecessary();
  }
  myState=isLayerActive() ? IN_LAYER_STATE : super.getState();
}
