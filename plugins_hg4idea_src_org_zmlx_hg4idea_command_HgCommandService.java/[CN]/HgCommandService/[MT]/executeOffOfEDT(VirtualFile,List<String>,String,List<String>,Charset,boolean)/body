{
  if (myProject.isDisposed()) {
    return null;
  }
  final List<String> cmdLine=new LinkedList<String>();
  cmdLine.add(myVcs.getHgExecutable());
  if (repo != null) {
    cmdLine.add("--repository");
    cmdLine.add(repo.getPath());
  }
  WarningReceiver warningReceiver=new WarningReceiver();
  PassReceiver passReceiver=new PassReceiver(myProject);
  SocketServer promptServer=new SocketServer(new PromptReceiver());
  SocketServer warningServer=new SocketServer(warningReceiver);
  SocketServer passServer=new SocketServer(passReceiver);
  if (myPromptHooksExtensionFile == null) {
    throw new RuntimeException("Could not hook into the prompt mechanism of Mercurial");
  }
  try {
    int promptPort=promptServer.start();
    int warningPort=warningServer.start();
    int passPort=passServer.start();
    cmdLine.add("--config");
    cmdLine.add("extensions.hg4ideapromptextension=" + myPromptHooksExtensionFile.getAbsolutePath());
    cmdLine.add("--config");
    cmdLine.add("hg4ideaprompt.port=" + promptPort);
    cmdLine.add("--config");
    cmdLine.add("hg4ideawarn.port=" + warningPort);
    cmdLine.add("--config");
    cmdLine.add("hg4ideapass.port=" + passPort);
    cmdLine.add("--config");
    cmdLine.add("extensions.mq=");
  }
 catch (  IOException e) {
    showError(e);
    LOG.info("IOException during preparing command",e);
    return null;
  }
  cmdLine.addAll(hgOptions);
  cmdLine.add(operation);
  if (arguments != null && arguments.size() != 0) {
    cmdLine.addAll(arguments);
  }
  ShellCommand shellCommand=new ShellCommand(mySettings.isRunViaBash());
  HgCommandResult result;
  try {
    String workingDir=repo != null ? repo.getPath() : null;
    result=shellCommand.execute(cmdLine,workingDir,charset);
    if (!HgErrorUtil.isAuthorizationError(result)) {
      passReceiver.saveCredentials();
    }
  }
 catch (  ShellCommandException e) {
    if (!silent) {
      if (myValidator.checkExecutableAndNotifyIfNeeded()) {
        showError(e);
        LOG.info(e.getMessage(),e);
      }
    }
 else {
      LOG.info(e.getMessage(),e);
    }
    return null;
  }
catch (  InterruptedException e) {
    LOG.info(e.getMessage(),e);
    return null;
  }
 finally {
    promptServer.stop();
    warningServer.stop();
    passServer.stop();
  }
  String warnings=warningReceiver.getWarnings();
  result.setWarnings(warnings);
  final String cmdString=String.format("%s %s %s",mySettings.isRunViaBash() ? "bash -c " + HgVcs.HG_EXECUTABLE_FILE_NAME : HgVcs.HG_EXECUTABLE_FILE_NAME,operation,StringUtils.join(maskAuthInfoFromUrl(arguments)," "));
  myVcs.showMessageInConsole(cmdString,ConsoleViewContentType.NORMAL_OUTPUT.getAttributes());
  LOG.info(cmdString);
  if (!silent) {
    myVcs.showMessageInConsole(result.getRawOutput(),ConsoleViewContentType.SYSTEM_OUTPUT.getAttributes());
    LOG.info(result.getRawOutput());
  }
  myVcs.showMessageInConsole(result.getRawError(),ConsoleViewContentType.ERROR_OUTPUT.getAttributes());
  LOG.info(result.getRawError());
  return result;
}
