{
  final TreeUtil.CommonParentState commonParents=new TreeUtil.CommonParentState();
  while (leaf != null) {
    commonParents.strongWhiteSpaceHolder=null;
    final IElementType tokenType=lexer.getTokenType();
    final TreeElement next;
    if (tokenType instanceof IChameleonElementType) {
      next=TreeUtil.nextLeaf(leaf,commonParents,tokenType,false);
    }
 else {
      next=TreeUtil.nextLeaf(leaf,commonParents,null,false);
    }
    if (next == null || tokenType == null || next == endToken)     break;
    if (tokenType != next.getElementType() && processor.isTokenValid(tokenType)) {
      final TreeElement firstMissing=processor.process(lexer,context);
      final CompositeElement unclosedElement=commonParents.strongWhiteSpaceHolder;
      if (unclosedElement != null) {
        if (commonParents.isStrongElementOnRisingSlope || unclosedElement.getFirstChildNode() == null) {
          unclosedElement.rawAddChildren(firstMissing);
        }
 else {
          unclosedElement.getFirstChildNode().rawInsertBeforeMe(firstMissing);
        }
      }
 else {
        final ASTNode insertBefore=commonParents.nextLeafBranchStart;
        TreeElement insertAfter=commonParents.startLeafBranchStart;
        TreeElement current=commonParents.startLeafBranchStart;
        while (current != insertBefore) {
          final TreeElement treeNext=current.getTreeNext();
          if (treeNext == insertBefore) {
            insertAfter=current;
            break;
          }
          if (treeNext.getUserData(TreeUtil.UNCLOSED_ELEMENT_PROPERTY) != null) {
            insertAfter=null;
            ((CompositeElement)treeNext).rawAddChildren(firstMissing);
            break;
          }
          current=treeNext;
        }
        if (insertAfter != null)         insertAfter.rawInsertAfterMe(firstMissing);
      }
    }
    passTokenOrChameleon(next,lexer);
    leaf=next;
  }
}
