{
  Pair<LogicalPosition,LogicalPosition> lines=EditorUtil.calcCaretLinesRange(editor,rangeStart,rangeEnd);
  int offset=editor.getCaretModel().getOffset();
  LogicalPosition lineStart=lines.first;
  LogicalPosition nextLineStart=lines.second;
  int start=editor.logicalPositionToOffset(lineStart);
  int end=editor.logicalPositionToOffset(nextLineStart);
  String s=document.getCharsSequence().subSequence(start,end).toString();
  final int lineToCheck=nextLineStart.line - 1;
  int newOffset=end + offset - start;
  if (lineToCheck == document.getLineCount() || document.getLineSeparatorLength(lineToCheck) == 0) {
    s="\n" + s;
    newOffset++;
  }
  document.insertString(end,s);
  editor.getCaretModel().moveToOffset(newOffset);
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  return new Pair<Integer,Integer>(end,end + s.length());
}
