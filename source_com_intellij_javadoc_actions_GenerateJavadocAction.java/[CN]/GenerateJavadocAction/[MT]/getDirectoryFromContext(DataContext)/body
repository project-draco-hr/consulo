{
  final Project project=DataKeys.PROJECT.getData(dataContext);
  if (project == null)   return null;
  final Editor editor=DataKeys.EDITOR.getData(dataContext);
  if (editor != null) {
    PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (psiFile != null)     return psiFile.getContainingDirectory();
  }
 else {
    PsiElement element=DataKeys.PSI_ELEMENT.getData(dataContext);
    if (element != null) {
      if (element instanceof PsiDirectory)       return (PsiDirectory)element;
 else {
        PsiFile psiFile=element.getContainingFile();
        if (psiFile != null)         return psiFile.getContainingDirectory();
      }
    }
 else {
      VirtualFile virtualFile=DataKeys.VIRTUAL_FILE.getData(dataContext);
      if (virtualFile != null && virtualFile.isValid()) {
        PsiFile psiFile=PsiManager.getInstance(project).findFile(virtualFile);
        if (psiFile != null)         return psiFile.getContainingDirectory();
      }
    }
  }
  return null;
}
