{
  if (progress != null)   progress.checkCanceled();
  PsiFile file=scope.getContainingFile();
  final CharSequence buffer=file.getViewProvider().getContents();
  TextRange range=scope.getTextRange();
  if (range == null) {
    throw new AssertionError("Element " + scope + " of class "+ scope.getClass()+ " has null range");
  }
  int scopeStart=range.getStartOffset();
  int startOffset=scopeStart;
  int endOffset=range.getEndOffset();
  if (endOffset > buffer.length()) {
    LOG.error("Range for element: '" + scope + "' = "+ range+ " is out of file '"+ file+ "' range: "+ file.getTextLength());
  }
  final char[] bufferArray=CharArrayUtil.fromSequenceWithoutCopying(buffer);
  do {
    if (progress != null)     progress.checkCanceled();
    startOffset=searchWord(buffer,bufferArray,startOffset,endOffset,searcher,progress);
    if (startOffset < 0) {
      return true;
    }
    if (!processTreeUp(processor,scope,searcher,startOffset - scopeStart,processInjectedPsi,progress))     return false;
    startOffset++;
  }
 while (startOffset < endOffset);
  return true;
}
