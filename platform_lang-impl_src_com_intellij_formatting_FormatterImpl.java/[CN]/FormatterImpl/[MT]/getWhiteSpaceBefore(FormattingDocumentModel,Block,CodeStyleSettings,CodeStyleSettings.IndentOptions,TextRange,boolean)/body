{
  disableFormatting();
  try {
    final FormatProcessor processor=new FormatProcessor(model,block,settings,indentOptions,new FormatTextRanges(affectedRange,true));
    final LeafBlockWrapper blockBefore=processor.getBlockAfter(affectedRange.getStartOffset());
    LOG.assertTrue(blockBefore != null);
    WhiteSpace whiteSpace=blockBefore.getWhiteSpace();
    LOG.assertTrue(whiteSpace != null);
    if (!mayChangeLineFeeds) {
      whiteSpace.setLineFeedsAreReadOnly();
    }
    processor.setAllWhiteSpacesAreReadOnly();
    whiteSpace.setReadOnly(false);
    processor.formatWithoutRealModifications();
    return new IndentInfo(whiteSpace.getLineFeeds(),whiteSpace.getIndentOffset(),whiteSpace.getSpaces());
  }
  finally {
    enableFormatting();
  }
}
