{
  disableFormatting(Source.FORMAT_AROUND_RANGE);
  try {
    final FormattingDocumentModel documentModel=model.getDocumentModel();
    final Block block=model.getRootBlock();
    final FormatProcessor processor=buildProcessorAndWrapBlocks(documentModel,block,settings,settings.getIndentOptions(fileType),null);
    LeafBlockWrapper tokenBlock=processor.getFirstTokenBlock();
    while (tokenBlock != null) {
      final WhiteSpace whiteSpace=tokenBlock.getWhiteSpace();
      if (whiteSpace.getEndOffset() < textRange.getStartOffset() || whiteSpace.getEndOffset() > textRange.getEndOffset() + 1) {
        whiteSpace.setIsReadOnly(true);
      }
 else       if (whiteSpace.getStartOffset() > textRange.getStartOffset() && whiteSpace.getEndOffset() < textRange.getEndOffset()) {
        if (whiteSpace.containsLineFeeds()) {
          whiteSpace.setLineFeedsAreReadOnly(true);
        }
 else {
          whiteSpace.setIsReadOnly(true);
        }
      }
      tokenBlock=tokenBlock.getNextBlock();
    }
    processor.formatWithoutRealModifications();
    processor.performModifications(model);
  }
  finally {
    enableFormatting(Source.FORMAT_AROUND_RANGE);
  }
}
