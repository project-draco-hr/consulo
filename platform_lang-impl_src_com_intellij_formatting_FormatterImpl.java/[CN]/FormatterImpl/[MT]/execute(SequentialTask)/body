{
  disableFormatting(Source.EXECUTE_SEQUENTIAL_TASK);
  Application application=ApplicationManager.getApplication();
  if (myProgressIndicator == null || !application.isDispatchThread() || application.isUnitTestMode()) {
    try {
      task.prepare();
      while (!task.isDone()) {
        task.iteration();
      }
    }
  finally {
      enableFormatting(Source.EXECUTE_SEQUENTIAL_TASK);
      myProgressIndicator=null;
    }
  }
 else {
    myProgressIndicator.setTask(task);
    myProgressIndicator.addCallback(FormattingProgressIndicator.EventType.SUCCESS,new Runnable(){
      @Override public void run(){
        UIUtil.invokeLaterIfNeeded(new Runnable(){
          @Override public void run(){
            myProgressIndicator=null;
            enableFormatting(Source.EXECUTE_SEQUENTIAL_TASK);
          }
        }
);
      }
    }
);
    ProgressManager.getInstance().run(myProgressIndicator);
  }
}
