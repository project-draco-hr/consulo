{
  disableFormatting();
  Application application=ApplicationManager.getApplication();
  FormattingProgressTask progressTask=myProgressTask.getAndSet(null);
  if (progressTask == null || !application.isDispatchThread() || application.isUnitTestMode()) {
    try {
      task.prepare();
      while (!task.isDone()) {
        task.iteration();
      }
    }
  finally {
      enableFormatting();
    }
  }
 else {
    progressTask.setTask(task);
    Runnable callback=new Runnable(){
      @Override public void run(){
        enableFormatting();
      }
    }
;
    for (    FormattingProgressCallback.EventType eventType : FormattingProgressCallback.EventType.values()) {
      progressTask.addCallback(eventType,callback);
    }
    ProgressManager.getInstance().run(progressTask);
  }
}
