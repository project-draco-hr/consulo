{
  disableFormatting();
  try {
    final FormattingDocumentModel documentModel=model.getDocumentModel();
    final Block block=model.getRootBlock();
    final FormatProcessor processor=new FormatProcessor(documentModel,block,settings,indentOptions,new FormatTextRanges(rangeToAdjust,true));
    LeafBlockWrapper tokenBlock=processor.getFirstTokenBlock();
    while (tokenBlock != null) {
      final WhiteSpace whiteSpace=tokenBlock.getWhiteSpace();
      whiteSpace.setLineFeedsAreReadOnly(true);
      if (!whiteSpace.containsLineFeeds()) {
        whiteSpace.setIsReadOnly(true);
      }
      tokenBlock=tokenBlock.getNextBlock();
    }
    processor.formatWithoutRealModifications();
    processor.performModifications(model);
  }
  finally {
    enableFormatting();
  }
}
