{
  disableFormatting();
  if (model instanceof PsiBasedFormattingModel) {
    ((PsiBasedFormattingModel)model).canModifyAllWhiteSpaces();
  }
  try {
    final FormattingDocumentModel documentModel=model.getDocumentModel();
    final Block block=model.getRootBlock();
    final FormatProcessor processor=new FormatProcessor(documentModel,block,settings,indentOptions,new FormatTextRanges(affectedRange,true),offset);
    final LeafBlockWrapper blockAfterOffset=processor.getBlockAfter(offset);
    if (blockAfterOffset != null && blockAfterOffset.contains(offset)) {
      return offset;
    }
    if (blockAfterOffset != null) {
      return adjustLineIndent(offset,documentModel,processor,indentOptions,model,blockAfterOffset.getWhiteSpace());
    }
 else {
      return adjustLineIndent(offset,documentModel,processor,indentOptions,model,processor.getLastWhiteSpace());
    }
  }
  finally {
    enableFormatting();
  }
}
