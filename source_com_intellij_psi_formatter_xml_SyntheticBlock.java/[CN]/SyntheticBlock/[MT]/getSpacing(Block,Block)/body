{
  if (child1 instanceof ReadOnlyBlock || child2 instanceof ReadOnlyBlock) {
    return Spacing.getReadOnlySpacing();
  }
  if (!(child1 instanceof AbstractXmlBlock) || !(child2 instanceof AbstractXmlBlock)) {
    return null;
  }
  final ASTNode node1=((AbstractBlock)child1).getNode();
  final ASTNode node2=((AbstractBlock)child2).getNode();
  final IElementType type1=node1.getElementType();
  final IElementType type2=node2.getElementType();
  boolean firstIsText=isTextFragment(node1);
  boolean secondIsText=isTextFragment(node2);
  boolean firstIsTag=node1.getPsi() instanceof XmlTag && !firstIsText;
  boolean secondIsTag=node2.getPsi() instanceof XmlTag && !secondIsText;
  if (isSpaceInText(firstIsTag,secondIsTag,firstIsText,secondIsText) && keepWhiteSpaces()) {
    return Spacing.getReadOnlySpacing();
  }
  if (type2 == ElementType.XML_EMPTY_ELEMENT_END && myXmlFormattingPolicy.addSpaceIntoEmptyTag()) {
    return Spacing.createSpacing(1,1,0,myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
  }
  if (isXmlTagName(type1,type2)) {
    final int spaces=shouldAddSpaceAroundTagName(node1,node2) ? 1 : 0;
    return Spacing.createSpacing(spaces,spaces,0,myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
  }
  if (type2 == ElementType.XML_ATTRIBUTE) {
    return Spacing.createSpacing(1,1,0,myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
  }
  if (((AbstractXmlBlock)child1).isTextElement() && ((AbstractXmlBlock)child2).isTextElement()) {
    return Spacing.createSafeSpacing(myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
  }
  if ((firstIsText || firstIsTag) && secondIsTag) {
    if (((AbstractXmlBlock)child2).insertLineBreakBeforeTag()) {
      return Spacing.createSpacing(0,Integer.MAX_VALUE,2,myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
    }
 else     if (((AbstractXmlBlock)child2).removeLineBreakBeforeTag()) {
      return Spacing.createSpacing(0,Integer.MAX_VALUE,0,myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
    }
  }
  if (firstIsTag && secondIsText) {
    if (((AbstractXmlBlock)child1).isTextElement()) {
      return Spacing.createSafeSpacing(myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
    }
 else {
      return Spacing.createSpacing(0,0,0,true,myXmlFormattingPolicy.getKeepBlankLines());
    }
  }
  if (firstIsText && secondIsTag) {
    if (((AbstractXmlBlock)child2).isTextElement()) {
      return Spacing.createSafeSpacing(true,myXmlFormattingPolicy.getKeepBlankLines());
    }
 else {
      return Spacing.createSpacing(0,0,0,true,myXmlFormattingPolicy.getKeepBlankLines());
    }
  }
  if (firstIsTag && secondIsTag) {
    return Spacing.createSpacing(0,Integer.MAX_VALUE,0,true,myXmlFormattingPolicy.getKeepBlankLines());
  }
  return Spacing.createSpacing(0,Integer.MAX_VALUE,0,myXmlFormattingPolicy.getShouldKeepLineBreaks(),myXmlFormattingPolicy.getKeepBlankLines());
}
