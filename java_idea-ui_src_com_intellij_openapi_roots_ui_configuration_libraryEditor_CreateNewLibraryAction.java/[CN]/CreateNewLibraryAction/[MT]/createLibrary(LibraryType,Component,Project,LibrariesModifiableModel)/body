{
  LibraryRootsComponentDescriptor componentDescriptor=null;
  if (type != null) {
    componentDescriptor=type.createLibraryRootsComponentDescriptor();
  }
  if (componentDescriptor == null) {
    componentDescriptor=new DefaultLibraryRootsComponentDescriptor();
  }
  final List<? extends RootDetector> rootDetectors=componentDescriptor.getRootDetectors();
  final List<OrderRoot> roots;
  if (!rootDetectors.isEmpty()) {
    final FileChooserDescriptor chooserDescriptor=componentDescriptor.createAttachFilesChooserDescriptor();
    chooserDescriptor.setTitle("Select Library Files");
    final VirtualFile[] rootCandidates=FileChooser.chooseFiles(parentComponent,chooserDescriptor,project.getBaseDir());
    if (rootCandidates.length == 0) {
      return null;
    }
    roots=RootDetectionUtil.detectRoots(Arrays.asList(rootCandidates),parentComponent,project,rootDetectors,true);
    if (roots.isEmpty())     return null;
  }
 else {
    roots=Collections.emptyList();
  }
  final Library library=modifiableModel.createLibrary(LibraryEditingUtil.suggestNewLibraryName(modifiableModel,roots),type);
  final NewLibraryEditor editor=new NewLibraryEditor(((LibraryEx)library).getType(),((LibraryEx)library).getProperties());
  editor.addRoots(roots);
  final Library.ModifiableModel model=library.getModifiableModel();
  editor.applyTo((LibraryEx.ModifiableModelEx)model);
  AccessToken token=WriteAction.start();
  try {
    model.commit();
  }
  finally {
    token.finish();
  }
  return library;
}
