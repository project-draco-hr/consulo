{
  final Map<JpsModule,Set<String>> map=new THashMap<JpsModule,Set<String>>();
  final Iterable<JavaBuilderExtension> builderExtensions=JpsServiceManager.getInstance().getExtensions(JavaBuilderExtension.class);
  for (  Map.Entry<String,String> entry : myUrlToCharset.entrySet()) {
    final String fileUrl=entry.getKey();
    final String charset=entry.getValue();
    File file=JpsPathUtil.urlToFile(fileUrl);
    if (charset == null || (!file.isDirectory() && !shouldHonorEncodingForCompilation(builderExtensions,file)))     continue;
    final JavaSourceRootDescriptor rootDescriptor=myRootsIndex.findJavaRootDescriptor(null,file);
    if (rootDescriptor == null)     continue;
    final JpsModule module=rootDescriptor.target.getModule();
    Set<String> set=map.get(module);
    if (set == null) {
      set=new LinkedHashSet<String>();
      map.put(module,set);
      final File sourceRoot=rootDescriptor.root;
      File current=FileUtilRt.getParentFile(file);
      String parentCharset=null;
      while (current != null) {
        final String currentCharset=myUrlToCharset.get(FileUtil.toSystemIndependentName(current.getAbsolutePath()));
        if (currentCharset != null) {
          parentCharset=currentCharset;
        }
        if (FileUtil.filesEqual(current,sourceRoot)) {
          break;
        }
        current=FileUtilRt.getParentFile(current);
      }
      if (parentCharset != null) {
        set.add(parentCharset);
      }
    }
    set.add(charset);
  }
  return map;
}
