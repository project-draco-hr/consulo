{
  final Map<String,Set<String>> map=new THashMap<String,Set<String>>();
  final List<ModuleLevelBuilder> builders=BuilderRegistry.getInstance().getModuleLevelBuilders();
  for (  Map.Entry<String,String> entry : myFilePathToCharset.entrySet()) {
    final String filePath=entry.getKey();
    final String charset=entry.getValue();
    File file=new File(FileUtil.toSystemDependentName(filePath));
    if (charset == null || (!file.isDirectory() && !shouldHonorEncodingForCompilation(builders,file)))     continue;
    final RootDescriptor rootDescriptor=myRootsIndex.getModuleAndRoot(file);
    if (rootDescriptor == null)     continue;
    final String module=rootDescriptor.module;
    Set<String> set=map.get(module);
    if (set == null) {
      set=new LinkedHashSet<String>();
      map.put(module,set);
      final File sourceRoot=rootDescriptor.root;
      File current=FileUtil.getParentFile(file);
      String parentCharset=null;
      while (current != null) {
        final String currentCharset=myFilePathToCharset.get(FileUtil.toSystemIndependentName(current.getAbsolutePath()));
        if (currentCharset != null) {
          parentCharset=currentCharset;
        }
        if (FileUtil.filesEqual(current,sourceRoot)) {
          break;
        }
        current=FileUtil.getParentFile(current);
      }
      if (parentCharset != null) {
        set.add(parentCharset);
      }
    }
    set.add(charset);
  }
  return map;
}
