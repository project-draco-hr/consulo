{
  final Runnable antAwareRunnable=new Runnable(){
    public void run(){
      if (configuration instanceof RunConfiguration) {
        final RunConfiguration runConfiguration=(RunConfiguration)configuration;
        final RunManagerImpl runManager=RunManagerImpl.getInstanceImpl(myProject);
        final Map<String,Boolean> beforeRun=runManager.getStepsBeforeLaunch(runConfiguration);
        final Collection<StepsBeforeRunProvider> activeProviders=new ArrayList<StepsBeforeRunProvider>();
        for (        final StepsBeforeRunProvider provider : Extensions.getExtensions(StepsBeforeRunProvider.EXTENSION_POINT_NAME,myProject)) {
          final Boolean enabled=beforeRun.get(provider.getStepName());
          if (enabled != null && enabled.booleanValue() && provider.hasTask(runConfiguration)) {
            activeProviders.add(provider);
          }
        }
        if (!activeProviders.isEmpty()) {
          ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
            public void run(){
              final DataContext dataContext=SimpleDataContext.getProjectContext(myProject);
              for (              StepsBeforeRunProvider provider : activeProviders) {
                if (!provider.executeTask(dataContext,runConfiguration)) {
                  return;
                }
              }
              ApplicationManager.getApplication().invokeLater(startRunnable);
            }
          }
);
        }
 else {
          startRunnable.run();
        }
      }
 else {
        startRunnable.run();
      }
    }
  }
;
  antAwareRunnable.run();
}
