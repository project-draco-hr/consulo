{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      if (replaceContext.getExcludedSet().contains(usage)) {
        return;
      }
      List<RangeMarker> markers=((UsageInfo2UsageAdapter)usage).getRangeMarkers();
      for (      RangeMarker marker : markers) {
        Document document=marker.getDocument();
        if (!document.isWritable())         return;
        final int textOffset=marker.getStartOffset();
        if (textOffset < 0 || textOffset >= document.getTextLength()) {
          return;
        }
        final int textEndOffset=marker.getEndOffset();
        if (textEndOffset < 0 || textOffset > document.getTextLength()) {
          return;
        }
        FindManager findManager=FindManager.getInstance(myProject);
        final CharSequence foundString=document.getCharsSequence().subSequence(textOffset,textEndOffset);
        FindResult findResult=findManager.findString(document.getCharsSequence(),textOffset,replaceContext.getFindModel());
        if (!findResult.isStringFound()) {
          return;
        }
        String stringToReplace=findManager.getStringToReplace(foundString.toString(),replaceContext.getFindModel());
        if (stringToReplace != null) {
          document.replaceString(textOffset,textEndOffset,stringToReplace);
        }
      }
    }
  }
);
}
