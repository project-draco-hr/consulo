{
  if (zipFile.exists() || zipFile.createNewFile()) {
    ZipOutputStream zos=null;
    try {
      zos=new ZipOutputStream(new BufferedOutputStream(new FileOutputStream(zipFile)));
      addStructure(pluginName,zos);
      addStructure(pluginName + "/" + MIDDLE_LIB_DIR,zos);
      final String entryName=pluginName + JAR_EXTENSION;
      ZipUtil.addFileToZip(zos,jarFile,getZipPath(pluginName,entryName),new HashSet<String>(),createFilter(progressIndicator,myFileTypeManager));
      Set<String> usedJarNames=new HashSet<String>();
      usedJarNames.add(entryName);
      Set<VirtualFile> jarredVirtualFiles=new HashSet<VirtualFile>();
      for (      Library library : libs) {
        final VirtualFile[] files=library.getFiles(OrderRootType.CLASSES);
        for (        VirtualFile virtualFile : files) {
          if (jarredVirtualFiles.add(virtualFile)) {
            if (virtualFile.getFileSystem() instanceof JarFileSystem) {
              addLibraryJar(virtualFile,zipFile,pluginName,zos,usedJarNames,progressIndicator);
            }
 else {
              makeAndAddLibraryJar(virtualFile,zipFile,pluginName,zos,usedJarNames,progressIndicator,library.getName());
            }
          }
        }
      }
    }
  finally {
      if (zos != null)       zos.close();
    }
  }
}
