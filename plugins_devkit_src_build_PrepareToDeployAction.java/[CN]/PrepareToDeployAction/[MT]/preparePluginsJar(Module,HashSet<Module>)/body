{
  final PluginModuleBuildProperties pluginModuleBuildProperties=((PluginModuleBuildProperties)ModuleBuildProperties.getInstance(module));
  File jarFile=FileUtil.createTempFile(TEMP_PREFIX,JAR_EXTENSION);
  jarFile.deleteOnExit();
  final Manifest manifest=new Manifest();
  if (pluginModuleBuildProperties.isUseUserManifest() && pluginModuleBuildProperties.getManifestPath() != null) {
    InputStream in=new BufferedInputStream(new FileInputStream(new File(pluginModuleBuildProperties.getManifestPath())));
    manifest.read(in);
    in.close();
  }
 else {
    Attributes mainAttributes=manifest.getMainAttributes();
    ManifestBuilder.setGlobalAttributes(mainAttributes);
  }
  ZipOutputStream jarPlugin=new JarOutputStream(new BufferedOutputStream(new FileOutputStream(jarFile)),manifest);
  final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
  final HashSet<String> writtenItemRelativePaths=new HashSet<String>();
  for (  Module module1 : modules) {
    final VirtualFile compilerOutputPath=ModuleRootManager.getInstance(module1).getCompilerOutputPath();
    if (compilerOutputPath == null)     continue;
    ZipUtil.addDirToZipRecursively(jarPlugin,jarFile,new File(compilerOutputPath.getPath()),"",new FileFilter(){
      public boolean accept(      File pathname){
        if (progressIndicator != null) {
          progressIndicator.setText2("");
        }
        return true;
      }
    }
,writtenItemRelativePaths);
  }
  final String pluginXmlPath=pluginModuleBuildProperties.getPluginXmlPath();
  @NonNls final String metaInfDir="/META-INF/plugin.xml";
  ZipUtil.addFileToZip(jarPlugin,new File(pluginXmlPath),metaInfDir,writtenItemRelativePaths,new FileFilter(){
    public boolean accept(    File pathname){
      if (progressIndicator != null) {
        progressIndicator.setText2("");
      }
      return true;
    }
  }
);
  jarPlugin.close();
  return jarFile;
}
