{
  File jarFile=FileUtil.createTempFile("temp","jar");
  jarFile.deleteOnExit();
  final Manifest manifest=new Manifest();
  Attributes mainAttributes=manifest.getMainAttributes();
  ManifestBuilder.setGlobalAttributes(mainAttributes);
  ZipOutputStream jarPlugin=new JarOutputStream(new FileOutputStream(jarFile),manifest);
  final HashSet<String> writtenItemRelativePaths=new HashSet<String>();
  for (  Module module1 : modules) {
    ZipUtil.addDirToZipRecursively(jarPlugin,jarFile,new File(ModuleRootManager.getInstance(module1).getCompilerOutputPath().getPath()),"",new FileFilter(){
      public boolean accept(      File pathname){
        return true;
      }
    }
,writtenItemRelativePaths);
  }
  final String pluginXmlPath=((PluginModuleBuildProperties)ModuleBuildProperties.getInstance(module)).getPluginXmlPath();
  ZipUtil.addFileToZip(jarPlugin,new File(pluginXmlPath),"/META-INF/plugin.xml",writtenItemRelativePaths,new FileFilter(){
    public boolean accept(    File pathname){
      return true;
    }
  }
);
  jarPlugin.close();
  return jarFile;
}
