{
  File libraryJar=FileUtil.createTempFile(TEMP_PREFIX,JAR_EXTENSION);
  libraryJar.deleteOnExit();
  ZipOutputStream jar=null;
  try {
    jar=new JarOutputStream(new BufferedOutputStream(new FileOutputStream(libraryJar)));
    ZipUtil.addFileOrDirRecursively(jar,libraryJar,VfsUtil.virtualToIoFile(virtualFile),"",createFilter(progressIndicator,myFileTypeManager),null);
  }
  finally {
    if (jar != null)     jar.close();
  }
  final String jarName=getLibraryJarName(virtualFile.getName() + JAR_EXTENSION,usedJarNames,preferredName == null ? null : preferredName + JAR_EXTENSION);
  ZipUtil.addFileOrDirRecursively(zos,zipFile,libraryJar,"/" + pluginName + MIDDLE_LIB_DIR+ jarName,createFilter(progressIndicator,null),null);
}
