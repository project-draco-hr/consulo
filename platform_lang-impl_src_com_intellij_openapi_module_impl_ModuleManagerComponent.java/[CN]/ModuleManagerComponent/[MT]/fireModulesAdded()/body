{
  if (ApplicationManager.getApplication().isCompilerServerMode()) {
    for (    final Module module : myModuleModel.myPathToModule.values()) {
      fireModuleAdded(module);
    }
    return;
  }
  Runnable runnableWithProgress=new Runnable(){
    @Override public void run(){
      for (      final Module module : myModuleModel.myPathToModule.values()) {
        final Application app=ApplicationManager.getApplication();
        final Runnable swingRunnable=new Runnable(){
          @Override public void run(){
            fireModuleAddedInWriteAction(module);
          }
        }
;
        if (app.isDispatchThread() || app.isHeadlessEnvironment()) {
          swingRunnable.run();
        }
 else {
          ProgressIndicator pi=ProgressManager.getInstance().getProgressIndicator();
          app.invokeAndWait(swingRunnable,pi.getModalityState());
        }
      }
    }
  }
;
  ProgressIndicator progressIndicator=myProgressManager.getProgressIndicator();
  if (progressIndicator == null) {
    myProgressManager.runProcessWithProgressSynchronously(runnableWithProgress,"Loading modules",false,myProject);
  }
 else {
    runnableWithProgress.run();
  }
}
