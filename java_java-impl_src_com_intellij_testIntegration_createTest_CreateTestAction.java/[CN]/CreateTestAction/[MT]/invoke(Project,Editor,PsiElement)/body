{
  if (!FileModificationService.getInstance().preparePsiElementForWrite(element))   return;
  final Module srcModule=ModuleUtilCore.findModuleForPsiElement(element);
  final PsiClass srcClass=getContainingClass(element);
  if (srcClass == null)   return;
  PsiDirectory srcDir=element.getContainingFile().getContainingDirectory();
  PsiPackage srcPackage=JavaDirectoryService.getInstance().getPackage(srcDir);
  final PropertiesComponent propertiesComponent=PropertiesComponent.getInstance();
  final HashSet<VirtualFile> testFolders=new HashSet<VirtualFile>();
  checkForTestRoots(srcModule,testFolders);
  if (testFolders.isEmpty() && !propertiesComponent.getBoolean(CREATE_TEST_IN_THE_SAME_ROOT,false)) {
    if (Messages.showOkCancelDialog(project,"Create test in the same source root?","No Test Roots Found",Messages.getQuestionIcon()) != DialogWrapper.OK_EXIT_CODE) {
      return;
    }
    propertiesComponent.setValue(CREATE_TEST_IN_THE_SAME_ROOT,String.valueOf(true));
  }
  final CreateTestDialog d=new CreateTestDialog(project,getText(),srcClass,srcPackage,srcModule);
  d.show();
  if (!d.isOK())   return;
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    @Override public void run(){
      TestFramework framework=d.getSelectedTestFrameworkDescriptor();
      TestGenerator generator=TestGenerators.INSTANCE.forLanguage(framework.getLanguage());
      generator.generateTest(project,d);
    }
  }
,CodeInsightBundle.message("intention.create.test"),this);
}
