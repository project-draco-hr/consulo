{
  myEditor=editor;
  final Project project=getProject(file);
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final PsiExpressionList list=ParameterInfoController.findArgumentList(file,editor.getCaretModel().getOffset(),-1);
  if (list != null) {
    myParameterInfoController=ParameterInfoController.getControllerAtOffset(editor,list.getTextRange().getStartOffset());
  }
  PsiElement element=TargetElementUtil.findTargetElement(editor,TargetElementUtil.ELEMENT_NAME_ACCEPTED | TargetElementUtil.REFERENCED_ELEMENT_ACCEPTED | TargetElementUtil.LOOKUP_ITEM_ACCEPTED| TargetElementUtil.NEW_AS_CONSTRUCTOR| TargetElementUtil.THIS_ACCEPTED| TargetElementUtil.SUPER_ACCEPTED);
  PsiElement originalElement=(file != null) ? file.findElementAt(editor.getCaretModel().getOffset()) : null;
  if (element == null && editor != null) {
    final PsiReference ref=TargetElementUtil.findReference(editor,editor.getCaretModel().getOffset());
    if (ref != null) {
      final PsiElement parent=ref.getElement().getParent();
      if (parent instanceof PsiMethodCallExpression) {
        element=parent;
      }
    }
    Lookup activeLookup=LookupManager.getInstance(project).getActiveLookup();
    if (activeLookup != null) {
      LookupItem item=activeLookup.getCurrentItem();
      if (item == null)       return null;
      if (file != null) {
        DocumentationProvider documentationProvider=getProviderFromElement(file);
        if (documentationProvider != null) {
          if (ref != null)           originalElement=ref.getElement();
          element=documentationProvider.getDocumentationElementForLookupItem(file.getManager(),item.getObject(),originalElement);
        }
      }
 else {
        return null;
      }
    }
  }
  if (element instanceof PsiAnonymousClass) {
    element=((PsiAnonymousClass)element).getBaseClassType().resolve();
  }
  if (element == null && myParameterInfoController != null) {
    final Object[] objects=myParameterInfoController.getSelectedElements();
    if (objects != null && objects.length > 0) {
      element=getPsiElementFromParameterInfoObject(objects[0],element);
    }
  }
  if (element == null && file != null) {
    element=originalElement;
    if (element == null)     return null;
    PsiDocComment comment=PsiTreeUtil.getParentOfType(element,PsiDocComment.class);
    if (comment == null)     return null;
    element=comment.getParent();
    if (!(element instanceof PsiDocCommentOwner))     return null;
  }
  JBPopupImpl oldHint=(JBPopupImpl)getDocInfoHint();
  if (oldHint != null) {
    JavaDocInfoComponent component=(JavaDocInfoComponent)oldHint.getComponent();
    PsiElement element1=component.getElement();
    if (element != null && Comparing.equal(element,element1)) {
      if (requestFocus) {
        component.getComponent().requestFocus();
      }
      return oldHint;
    }
    oldHint.cancel();
  }
  final JavaDocInfoComponent component=new JavaDocInfoComponent(this);
  try {
    element.putUserData(ORIGINAL_ELEMENT_KEY,SmartPointerManager.getInstance(project).createSmartPsiElementPointer(originalElement));
  }
 catch (  RuntimeException ex) {
  }
  final String title=SymbolPresentationUtil.getSymbolPresentableText(element);
  final JBPopup hint=JBPopupFactory.getInstance().createComponentPopupBuilder(component,component).setRequestFocusIfNotLookupOrSearch(project).setLookupAndSearchUpdater(new Condition<PsiElement>(){
    public boolean value(    final PsiElement element){
      if (myEditor != null) {
        final PsiFile file=element.getContainingFile();
        if (file != null) {
          Editor editor=myEditor;
          showJavaDocInfo(myEditor,file,false);
          myEditor=editor;
        }
      }
 else {
        showJavaDocInfo(element);
      }
      return false;
    }
  }
,project).setForceHeavyweight(false).setDimensionServiceKey(JAVADOC_LOCATION_AND_SIZE,false).setResizable(true).setMovable(true).setTitle(CodeInsightBundle.message("javadoc.info.title",title != null ? title : element.getText())).setCancelCallback(new Computable<Boolean>(){
    public Boolean compute(){
      if (fromQuickSearch()) {
        ((ChooseByNameBase.JPanelProvider)myPreviouslyFocused.getParent()).unregisterHint();
      }
      Disposer.dispose(component);
      myEditor=null;
      myPreviouslyFocused=null;
      myParameterInfoController=null;
      return Boolean.TRUE;
    }
  }
).createPopup();
  component.setHint(hint);
  fetchDocInfo(getDefaultProvider(element),component);
  myDocInfoHintRef=new WeakReference<JBPopup>(hint);
  myPreviouslyFocused=WindowManagerEx.getInstanceEx().getFocusedComponent(project);
  return hint;
}
