{
  final JBPopupImpl popup=(JBPopupImpl)hint;
  final Lookup activeLookup=LookupManager.getInstance(myProject).getActiveLookup();
  if (activeLookup != null && myEditor != null) {
    popup.setRequestFocus(false);
    activeLookup.removeLookupListener(myActiveLookupListener);
    activeLookup.addLookupListener(myActiveLookupListener);
    final JLayeredPane layeredPane=myEditor.getContentComponent().getRootPane().getLayeredPane();
    final Point layeredPanePoint=new Point(activeLookup.getBounds().x,activeLookup.getBounds().y);
    Dimension preferredTextFieldPanelSize=popup.getComponent().getPreferredSize();
    final RelativePoint relativePoint=new RelativePoint(layeredPane,new Point(layeredPanePoint.x,layeredPanePoint.y - preferredTextFieldPanelSize.height - myEditor.getLineHeight()- 2));
    cropToFitBounds(layeredPane,relativePoint,layeredPanePoint,popup);
    popup.show(relativePoint);
    return;
  }
  if (fromQuickSearch() && myPreviouslyFocused != null) {
    popup.setRequestFocus(false);
    Window window=SwingUtilities.windowForComponent(myPreviouslyFocused);
    JLayeredPane layeredPane;
    if (window instanceof JFrame) {
      layeredPane=((JFrame)window).getLayeredPane();
    }
 else     if (window instanceof JDialog) {
      layeredPane=((JDialog)window).getLayeredPane();
    }
 else {
      throw new IllegalStateException("cannot find parent window: project=" + myProject + "; window="+ window);
    }
    final Point layeredPanePoint=SwingUtilities.convertPoint(myPreviouslyFocused.getParent(),0,0,layeredPane);
    Dimension preferredTextFieldPanelSize=popup.getComponent().getPreferredSize();
    final RelativePoint relativePoint=new RelativePoint(layeredPane,new Point(layeredPanePoint.x,layeredPanePoint.y - preferredTextFieldPanelSize.height - myPreviouslyFocused.getHeight()- 2));
    cropToFitBounds(layeredPane,relativePoint,layeredPanePoint,popup);
    popup.show(relativePoint);
    return;
  }
  if (myEditor != null) {
    popup.showInBestPositionFor(myEditor);
  }
 else   if (myPreviouslyFocused != null) {
    popup.showInCenterOf(myPreviouslyFocused);
  }
}
