def unbundle(self, cg, heads, source):
    type = ''
    types = self.capable('unbundle')
    try:
        types = types.split(',')
    except AttributeError:
        types = ['']
    if types:
        for x in types:
            if (x in changegroup.bundletypes):
                type = x
                break
    tempname = changegroup.writebundle(cg, None, type)
    fp = url.httpsendfile(tempname, 'rb')
    try:
        try:
            resp = self.do_read('unbundle', data=fp, headers={'Content-Type': 'application/mercurial-0.1', }, heads=' '.join(map(hex, heads)))
            (resp_code, output) = resp.split('\n', 1)
            try:
                ret = int(resp_code)
            except ValueError as err:
                raise error.ResponseError(_('push failed (unexpected response):'), resp)
            for l in output.splitlines(True):
                self.ui.status(_('remote: '), l)
            return ret
        except socket.error as err:
            if (err[0] in (errno.ECONNRESET, errno.EPIPE)):
                raise util.Abort((_('push failed: %s') % err[1]))
            raise util.Abort(err[1])
    finally:
        fp.close()
        os.unlink(tempname)
