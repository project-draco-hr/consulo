{
  final ArrayList<Debugger.Variable> variables=new ArrayList<Debugger.Variable>();
  final HashMap<StructuredQName,GlobalVariable> globalVariables=myXPathContext.getController().getExecutable().getCompiledGlobalVariables();
  if (globalVariables != null) {
    for (    StructuredQName name : globalVariables.keySet()) {
      final GlobalVariable globalVariable=globalVariables.get(name);
      final Value value=createVariableValue(new GlobalVariableFacade(globalVariable));
      final int lineNumber=globalVariable.getLineNumber();
      final String systemId=globalVariable.getSourceLocator().getSystemId();
      variables.add(new VariableImpl(globalVariable.getVariableQName().getDisplayName(),value,true,Debugger.Variable.Kind.VARIABLE,systemId,lineNumber));
    }
  }
  XPathContext context=myXPathContext;
  while (context != null) {
    final StackFrame frame=context.getStackFrame();
    final SlotManager map=frame.getStackFrameMap();
    final ValueRepresentation[] values=frame.getStackFrameValues();
    outer:     for (int i=0, valuesLength=values.length; i < valuesLength; i++) {
      final ValueRepresentation value=values[i];
      if (value != null) {
        final String name=map.getVariableMap().get(i).getDisplayName();
        for (        Debugger.Variable variable : variables) {
          if (name.equals(variable.getName())) {
            continue outer;
          }
        }
        final Value localValue=createVariableValue(new LocalVariableFacade(value));
        variables.add(new VariableImpl(name,localValue,false,Debugger.Variable.Kind.VARIABLE,"",-1));
      }
    }
    context=context.getCaller();
  }
  return variables;
}
