{
  final Project project=ProjectManagerEx.getInstanceEx().getDefaultProject();
  final PsiManager manager=PsiManager.getInstance(project);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      PsiElementFactory factory=manager.getElementFactory();
      try {
        PsiFile psiFile=factory.createFileFromText("a.java",text);
        CodeStyleSettings savedCodeStyleSettings=mySettings;
        mySettings=(CodeStyleSettings)mySettings.clone();
        apply();
        mySettings.KEEP_LINE_BREAKS=true;
        CodeStyleSettingsManager.getInstance(project).setTemporarySettings(mySettings);
        CodeStyleManager.getInstance(project).reformat(psiFile);
        CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
        myEditor.getSettings().setTabSize(mySettings.getTabSize(StdFileTypes.JAVA));
        mySettings=savedCodeStyleSettings;
        Document document=myEditor.getDocument();
        document.replaceString(0,document.getTextLength(),psiFile.getText());
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
);
}
