{
  JavaDirectoryService directoryService=JavaDirectoryService.getInstance();
  while (true) {
    PsiDirectory parent=dir.getParentDirectory();
    if (parent == null)     throw new IncorrectOperationException("No parent directory found for " + dir.getVirtualFile().getPresentableUrl());
    PsiPackage parentPackage=directoryService.getPackage(parent);
    if (parentPackage == null)     break;
    dir=parent;
  }
  return dir;
}
