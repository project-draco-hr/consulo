{
  myInsideSave=true;
  try {
    ApplicationManager.getApplication().runWriteAction(new DocumentRunnable.IgnoreDocumentRunnable(){
      public void run(){
        ((NewVirtualFile)myVFSBaseDir).markDirtyRecursively();
        myVFSBaseDir.refresh(false,true);
      }
    }
);
    final Collection<T> schemes=getAllSchemes();
    myBaseDir.mkdirs();
    final UniqueFileNamesProvider fileNameProvider=new UniqueFileNamesProvider();
    reserveUsingFileNames(schemes,fileNameProvider);
    final WriteExternalException[] ex=new WriteExternalException[1];
    ApplicationManager.getApplication().runWriteAction(new DocumentRunnable.IgnoreDocumentRunnable(){
      public void run(){
        deleteFilesFromDeletedSchemes();
        try {
          saveSchemes(schemes,fileNameProvider);
        }
 catch (        WriteExternalException e) {
          ex[0]=e;
        }
      }
    }
);
    if (ex[0] != null)     throw ex[0];
    if (myDeletedNames.isEmpty()) {
      deleteServerFiles(DELETED_XML);
    }
 else {
      for (      StreamProvider provider : getEnabledProviders()) {
        try {
          StorageUtil.sendContent(provider,getFileFullPath(DELETED_XML),createDeletedDocument(),myRoamingType,true);
        }
 catch (        IOException e) {
          LOG.debug(e);
        }
      }
    }
  }
  finally {
    myInsideSave=false;
  }
}
