{
  final PsiElement parent=element.getParent();
  if (!(parent instanceof PsiJavaCodeReferenceElement)) {
    return;
  }
  final PsiJavaCodeReferenceElement javaCodeReferenceElement=(PsiJavaCodeReferenceElement)parent;
  final PsiReferenceParameterList referenceParameterList=(PsiReferenceParameterList)element;
  final StringBuilder text=new StringBuilder();
  text.append(javaCodeReferenceElement.getQualifiedName());
  text.append('<');
  final PsiTypeElement[] typeElements=referenceParameterList.getTypeParameterElements();
  final PsiNewExpression newExpression=PsiTreeUtil.getParentOfType(typeElements[0],PsiNewExpression.class);
  final PsiDiamondType.DiamondInferenceResult result=PsiDiamondType.resolveInferredTypesNoCheck(newExpression,newExpression);
  boolean first=true;
  for (  PsiType typeArgument : result.getInferredTypes()) {
    if (first) {
      first=false;
    }
 else {
      text.append(',');
    }
    text.append(typeArgument.getCanonicalText());
  }
  text.append('>');
  final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(element.getProject());
  final PsiJavaCodeReferenceElement newReference=elementFactory.createReferenceFromText(text.toString(),element);
  javaCodeReferenceElement.replace(newReference);
}
