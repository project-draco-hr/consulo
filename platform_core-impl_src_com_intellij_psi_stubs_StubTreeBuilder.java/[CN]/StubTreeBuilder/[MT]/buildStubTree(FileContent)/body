{
  Stub data=inputData.getUserData(stubElementKey);
  if (data != null)   return data;
synchronized (inputData) {
    data=inputData.getUserData(stubElementKey);
    if (data != null)     return data;
    final FileType fileType=inputData.getFileType();
    final BinaryFileStubBuilder builder=BinaryFileStubBuilders.INSTANCE.forFileType(fileType);
    if (builder != null) {
      data=builder.buildStubTree(inputData);
    }
    if (data == null && !fileType.isBinary()) {
      final LanguageFileType languageFileType=(LanguageFileType)fileType;
      Language l=languageFileType.getLanguage();
      final IFileElementType type=LanguageParserDefinitions.INSTANCE.forLanguage(l).getFileNodeType();
      PsiFile psi=null;
      CharSequence contentAsText=null;
      Document document=FileDocumentManager.getInstance().getCachedDocument(inputData.getFile());
      if (document != null) {
        PsiFile existingPsi=PsiDocumentManager.getInstance(inputData.getProject()).getPsiFile(document);
        if (existingPsi != null) {
          contentAsText=existingPsi.getText();
          psi=existingPsi;
        }
      }
      if (contentAsText == null) {
        contentAsText=inputData.getContentAsText();
        psi=inputData.getPsiFile();
      }
      psi=psi.getViewProvider().getStubBindingRoot();
      psi.putUserData(IndexingDataKeys.FILE_TEXT_CONTENT_KEY,contentAsText);
      psi.getManager().startBatchFilesProcessingMode();
      try {
        IStubFileElementType stubFileElementType;
        if (type instanceof IStubFileElementType) {
          stubFileElementType=(IStubFileElementType)type;
        }
 else         if (languageFileType instanceof SubstitutedFileType) {
          SubstitutedFileType substituted=(SubstitutedFileType)languageFileType;
          LanguageFileType original=(LanguageFileType)substituted.getOriginalFileType();
          final IFileElementType originalType=LanguageParserDefinitions.INSTANCE.forLanguage(original.getLanguage()).getFileNodeType();
          stubFileElementType=originalType instanceof IStubFileElementType ? (IStubFileElementType)originalType : null;
        }
 else {
          stubFileElementType=null;
        }
        if (stubFileElementType != null) {
          data=stubFileElementType.getBuilder().buildStubTree(psi);
        }
      }
  finally {
        psi.putUserData(IndexingDataKeys.FILE_TEXT_CONTENT_KEY,null);
        psi.getManager().finishBatchFilesProcessingMode();
      }
    }
    inputData.putUserData(stubElementKey,data);
    return data;
  }
}
