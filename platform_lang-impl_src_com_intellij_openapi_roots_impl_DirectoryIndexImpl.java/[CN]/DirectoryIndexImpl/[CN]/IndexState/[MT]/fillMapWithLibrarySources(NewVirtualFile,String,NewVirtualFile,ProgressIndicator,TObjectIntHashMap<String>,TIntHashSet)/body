{
  assertWritable();
  if (!isValid(dir))   return;
  VfsUtilCore.visitChildrenRecursively(dir,new VirtualFileVisitor<String>(){
{
      setValueForChildren(packageName);
    }
    @Override public boolean visitFile(    @NotNull VirtualFile file){
      if (progress != null)       progress.checkCanceled();
      int dirId=((NewVirtualFile)file).getId();
      if (!file.isDirectory() && dirId != dir.getId() || isIgnored(file))       return false;
      if (excludedRoots != null && excludedRoots.contains(dirId))       return false;
      DirectoryInfo info=getOrCreateDirInfo(dirId);
      if (info.isInLibrarySource()) {
        if (isAnotherRoot(dirId))         return false;
      }
      int data=DirectoryInfo.createSourceRootTypeData(info.isInModuleSource(),true,info.getSourceRootTypeId());
      with(dirId,info,null,null,sourceRoot,null,data,null);
      final String packageName=getCurrentValue();
      final String newPackageName=Comparing.equal(file,dir) ? packageName : getPackageNameForSubdir(packageName,file.getName());
      setPackageName(dirId,internPackageName(newPackageName,interned));
      setValueForChildren(newPackageName);
      return true;
    }
  }
);
}
