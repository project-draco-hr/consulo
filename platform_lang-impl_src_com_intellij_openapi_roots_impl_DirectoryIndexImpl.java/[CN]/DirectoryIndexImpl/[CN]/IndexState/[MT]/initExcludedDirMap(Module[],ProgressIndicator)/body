{
  assertWritable();
  progress.checkCanceled();
  progress.setText2(ProjectBundle.message("project.index.building.exclude.roots.progress"));
  for (  Module module : modules) {
    for (    ContentEntry contentEntry : getContentEntries(module)) {
      VirtualFile contentRoot=contentEntry.getFile();
      if (!(contentRoot instanceof NewVirtualFile))       continue;
      for (      VirtualFile excludeRoot : contentEntry.getFolderFiles(ContentFolderScopes.excluded())) {
        if (excludeRoot instanceof NewVirtualFile) {
          if (!FileUtil.startsWith(contentRoot.getUrl(),excludeRoot.getUrl())) {
            if (isExcludeRootForModule(module,excludeRoot)) {
              putForFileAndAllAncestors((NewVirtualFile)excludeRoot,excludeRoot.getUrl());
            }
            myProjectExcludeRoots.add(((NewVirtualFile)excludeRoot).getId());
          }
        }
      }
      for (      String url : contentEntry.getFolderUrls(ContentFolderScopes.excluded())) {
        putForFileAndAllAncestors((NewVirtualFile)contentRoot,url);
      }
    }
  }
  for (  DirectoryIndexExcludePolicy policy : myExcludePolicies) {
    for (    VirtualFile file : policy.getExcludeRootsForProject()) {
      if (file instanceof NewVirtualFile) {
        putForFileAndAllAncestors((NewVirtualFile)file,file.getUrl());
        myProjectExcludeRoots.add(((NewVirtualFile)file).getId());
      }
    }
  }
}
