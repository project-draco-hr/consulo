{
  assertWritable();
  progress.checkCanceled();
  progress.setText2(ProjectBundle.message("project.index.building.exclude.roots.progress"));
  for (  Module module : modules) {
    for (    ContentEntry contentEntry : getContentEntries(module)) {
      VirtualFile contentRoot=contentEntry.getFile();
      if (!(contentRoot instanceof NewVirtualFile))       continue;
      ExcludeFolder[] excludeRoots=contentEntry.getExcludeFolders();
      for (      ExcludeFolder excludeRoot : excludeRoots) {
        VirtualFile excludeRootFile=excludeRoot.getFile();
        if (excludeRootFile instanceof NewVirtualFile) {
          if (!FileUtil.startsWith(contentRoot.getUrl(),excludeRoot.getUrl())) {
            if (isExcludeRootForModule(module,excludeRootFile)) {
              putForFileAndAllAncestors((NewVirtualFile)excludeRootFile,excludeRoot.getUrl());
            }
            myProjectExcludeRoots.add(((NewVirtualFile)excludeRootFile).getId());
          }
        }
        putForFileAndAllAncestors((NewVirtualFile)contentRoot,excludeRoot.getUrl());
      }
    }
  }
  for (  DirectoryIndexExcludePolicy policy : myExcludePolicies) {
    for (    VirtualFile file : policy.getExcludeRootsForProject()) {
      if (file instanceof NewVirtualFile) {
        putForFileAndAllAncestors((NewVirtualFile)file,file.getUrl());
        myProjectExcludeRoots.add(((NewVirtualFile)file).getId());
      }
    }
  }
}
