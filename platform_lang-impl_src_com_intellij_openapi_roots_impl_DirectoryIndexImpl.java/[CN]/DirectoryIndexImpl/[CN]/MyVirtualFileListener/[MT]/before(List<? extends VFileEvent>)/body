{
  myBatchChangePlanned=false;
  int directoriesRemoved=0;
  int directoriesCreated=0;
  for (  VFileEvent event : events) {
    if (event instanceof VFileDeleteEvent) {
      VirtualFile file=event.getFile();
      if (file != null && file.isDirectory()) {
        directoriesRemoved+=1 + countDirectories(file,MAX_DEPTH_TO_COUNT);
      }
    }
 else     if (event instanceof VFileCreateEvent) {
      VirtualFile file=event.getFile();
      if (file != null && file.isDirectory() || file == null && ((VFileCreateEvent)event).isDirectory()) {
        directoriesCreated+=1 + countDirectories(file,MAX_DEPTH_TO_COUNT);
      }
    }
  }
  final boolean willDoBatchUpdate=directoriesCreated + directoriesRemoved > DIRECTORIES_CHANGED_THRESHOLD;
  if (willDoBatchUpdate && ourCanHaveBatchUpdate) {
    myBatchChangePlanned=true;
    LOG.info("Too many directories created / deleted: " + directoriesCreated + ","+ directoriesRemoved+ ", will rebuild indexstate");
  }
 else {
    for (    VFileEvent event : events) {
      BulkVirtualFileListenerAdapter.fireBefore(this,event);
    }
  }
}
