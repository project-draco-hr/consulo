{
  progress.checkCanceled();
  progress.setText2(ProjectBundle.message("project.index.building.exclude.roots.progress"));
  Map<VirtualFile,Set<String>> result=new THashMap<VirtualFile,Set<String>>();
  Set<VirtualFile> projectExcludeRoots=new HashSet<VirtualFile>();
  for (  Module module : modules) {
    for (    ContentEntry contentEntry : getContentEntries(module)) {
      VirtualFile contentRoot=contentEntry.getFile();
      if (contentRoot == null)       continue;
      ExcludeFolder[] excludeRoots=contentEntry.getExcludeFolders();
      for (      ExcludeFolder excludeRoot : excludeRoots) {
        if (excludeRoot.getFile() != null) {
          if (!contentRoot.getUrl().startsWith(excludeRoot.getUrl())) {
            if (isExcludeRootForModule(module,excludeRoot.getFile())) {
              putForFileAndAllAncestors(result,excludeRoot.getFile(),excludeRoot.getUrl());
            }
          }
        }
        putForFileAndAllAncestors(result,contentRoot,excludeRoot.getUrl());
      }
    }
  }
  for (  DirectoryIndexExcludePolicy policy : myExcludePolicies) {
    for (    VirtualFile file : policy.getExcludeRootsForProject()) {
      putForFileAndAllAncestors(result,file,file.getUrl());
      projectExcludeRoots.add(file);
    }
  }
  myExcludeRootsMap=result;
  myProjectExcludeRoots=projectExcludeRoots;
}
