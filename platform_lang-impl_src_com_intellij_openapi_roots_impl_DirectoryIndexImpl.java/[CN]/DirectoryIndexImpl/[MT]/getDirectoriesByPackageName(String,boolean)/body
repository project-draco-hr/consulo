{
  RootIndex rootIndex=getRootIndex();
  if (rootIndex != null) {
    Collection<VirtualFile> riResult=rootIndex.getDirectoriesByPackageName(packageName,includeLibrarySources);
    if (ourUseRootIndexOnly) {
      return new CollectionQuery<VirtualFile>(riResult);
    }
    Query<VirtualFile> standardResult=mySink.search(packageName,includeLibrarySources);
    Collection<VirtualFile> standard=standardResult.findAll();
    if (!new HashSet<VirtualFile>(riResult).equals(new HashSet<VirtualFile>(standard))) {
      for (      VirtualFile file : standard) {
        String path=file.getPath();
        if (path.substring(path.length() - packageName.length()).contains(".")) {
          return standardResult;
        }
      }
      assertConsistentResult(packageName,riResult,standard);
    }
  }
  return mySink.search(packageName,includeLibrarySources);
}
