{
  if (actual.startsWith("\n")) {
    actual=actual.substring(1);
  }
  if (actual.startsWith("\n")) {
    actual=actual.substring(1);
  }
  final Document doc=EditorFactory.getInstance().createDocument(actual);
  CommandProcessor.getInstance().executeCommand(getProject(),new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          ((DocumentEx)doc).stripTrailingSpaces(false);
        }
      }
);
    }
  }
,"formatting",null);
  return doc.getText();
}
