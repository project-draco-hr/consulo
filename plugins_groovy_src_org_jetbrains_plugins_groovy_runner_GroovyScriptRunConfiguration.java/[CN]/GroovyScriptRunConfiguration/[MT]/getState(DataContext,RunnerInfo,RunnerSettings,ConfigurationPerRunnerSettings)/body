{
  GroovyGrailsConfiguration groovyConfig=GroovyGrailsConfiguration.getInstance();
  if (!groovyConfig.isGroovyConfigured(null)) {
    throw new ExecutionException("Groovy is not configured");
  }
  final Module module=getModule();
  if (module == null) {
    throw new ExecutionException("Module is not specified");
  }
  final ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
  final ProjectJdk jdk=rootManager.getJdk();
  if (jdk == null) {
    throw CantRunException.noJdkForModule(getModule());
  }
  final JavaCommandLineState state=new JavaCommandLineState(runnerSettings,configurationSettings){
    protected JavaParameters createJavaParameters() throws ExecutionException {
      JavaParameters params=new JavaParameters();
      params.configureByModule(module,JavaParameters.JDK_AND_CLASSES);
      params.setWorkingDirectory(getAbsoluteWorkDir());
      params.getVMParametersList().addParametersString(vmParams);
      params.getProgramParametersList().add(scriptPath);
      params.getProgramParametersList().addParametersString(scriptParams);
      params.setMainClass("groovy.lang.GroovyShell");
      return params;
    }
  }
;
  state.setConsoleBuilder(TextConsoleBuilderFactory.getInstance().createBuilder(getProject()));
  state.setModulesToCompile(getModules());
  return state;
}
