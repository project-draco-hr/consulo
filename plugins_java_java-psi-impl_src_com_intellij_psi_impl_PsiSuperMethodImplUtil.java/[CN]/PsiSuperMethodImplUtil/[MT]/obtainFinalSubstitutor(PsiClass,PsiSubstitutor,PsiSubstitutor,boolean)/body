{
  if (inRawContext) {
    Set<PsiTypeParameter> typeParams=superSubstitutor.getSubstitutionMap().keySet();
    PsiElementFactory factory=JavaPsiFacade.getElementFactory(superClass.getProject());
    superSubstitutor=factory.createRawSubstitutor(derivedSubstitutor,typeParams.toArray(new PsiTypeParameter[typeParams.size()]));
  }
  Map<PsiTypeParameter,PsiType> map=null;
  for (  PsiTypeParameter typeParameter : PsiUtil.typeParametersIterable(superClass)) {
    PsiType type=superSubstitutor.substitute(typeParameter);
    final PsiType t=derivedSubstitutor.substitute(type);
    if (map == null) {
      map=new THashMap<PsiTypeParameter,PsiType>();
    }
    map.put(typeParameter,t);
  }
  return map == null ? PsiSubstitutor.EMPTY : JavaPsiFacade.getInstance(superClass.getProject()).getElementFactory().createSubstitutor(map);
}
