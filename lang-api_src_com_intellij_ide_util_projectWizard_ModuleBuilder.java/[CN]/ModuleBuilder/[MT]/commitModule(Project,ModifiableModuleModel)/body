{
  final Ref<Module> result=new Ref<Module>();
  if (canCreateModule()) {
    if (myName == null) {
      myName=project.getName();
    }
    if (myModuleFilePath == null) {
      myModuleFilePath=project.getBaseDir().getPath() + File.separator + myName+ ModuleFileType.DOT_DEFAULT_EXTENSION;
    }
    Exception ex=ApplicationManager.getApplication().runWriteAction(new Computable<Exception>(){
      public Exception compute(){
        try {
          result.set(createAndCommitIfNeeded(project,model,true));
          return null;
        }
 catch (        Exception e) {
          return e;
        }
      }
    }
);
    if (ex != null) {
      Messages.showErrorDialog(IdeBundle.message("error.adding.module.to.project",ex.getMessage()),IdeBundle.message("title.add.module"));
    }
  }
  return result.get();
}
