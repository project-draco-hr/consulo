{
  final Application application=ApplicationManager.getApplication();
  if (application.isDispatchThread()) {
    command.run();
  }
 else {
    final ProgressIndicator pi=ProgressManager.getInstance().getProgressIndicator();
    if (pi != null) {
      execute(pi);
      application.invokeAndWait(command,pi.getModalityState());
    }
 else {
      application.invokeAndWait(command,ModalityState.defaultModalityState());
    }
  }
}
