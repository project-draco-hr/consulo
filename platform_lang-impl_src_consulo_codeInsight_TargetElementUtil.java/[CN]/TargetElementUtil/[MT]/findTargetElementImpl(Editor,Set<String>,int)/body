{
  Project project=editor.getProject();
  if (project == null)   return null;
  if (flags.contains(TargetElementUtilEx.LOOKUP_ITEM_ACCEPTED)) {
    PsiElement element=getTargetElementFromLookup(project);
    if (element != null) {
      return element;
    }
  }
  Document document=editor.getDocument();
  if (ApplicationManager.getApplication().isDispatchThread()) {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
  }
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
  if (file == null)   return null;
  offset=adjustOffset(file,document,offset);
  if (file instanceof PsiCompiledFile) {
    file=((PsiCompiledFile)file).getDecompiledPsiFile();
  }
  PsiElement element=file.findElementAt(offset);
  if (flags.contains(TargetElementUtilEx.REFERENCED_ELEMENT_ACCEPTED)) {
    final PsiElement referenceOrReferencedElement=getReferenceOrReferencedElement(file,editor,flags,offset);
    if (isAcceptableReferencedElement(element,referenceOrReferencedElement)) {
      return referenceOrReferencedElement;
    }
  }
  if (element == null)   return null;
  if (flags.contains(TargetElementUtilEx.ELEMENT_NAME_ACCEPTED)) {
    if (element instanceof PsiNamedElement)     return element;
    return getNamedElement(element,offset - element.getTextRange().getStartOffset());
  }
  return null;
}
