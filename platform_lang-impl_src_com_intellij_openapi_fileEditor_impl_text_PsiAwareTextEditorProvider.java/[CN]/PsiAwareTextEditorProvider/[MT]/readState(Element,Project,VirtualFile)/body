{
  final TextEditorState state=(TextEditorState)super.readState(element,project,file);
  Element child=element.getChild(FOLDING_ELEMENT);
  Document document=FileDocumentManager.getInstance().getCachedDocument(file);
  if (child != null) {
    if (document == null) {
      final Element detachedStateCopy=(Element)child.clone();
      state.setDelayedFoldState(new Producer<CodeFoldingState>(){
        @Override public CodeFoldingState produce(){
          Document document=FileDocumentManager.getInstance().getCachedDocument(file);
          return document == null ? null : CodeFoldingManager.getInstance(project).readFoldingState(detachedStateCopy,document);
        }
      }
);
    }
 else {
      state.setFoldingState(CodeFoldingManager.getInstance(project).readFoldingState(child,document));
    }
  }
  return state;
}
