{
  super.setStateImpl(project,editor,state);
  final CodeFoldingState foldState=state.getFoldingState();
  if (project != null && foldState != null) {
    UIUtil.invokeAndWaitIfNeeded(new Runnable(){
      @Override public void run(){
        PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
        editor.getFoldingModel().runBatchFoldingOperation(new Runnable(){
          @Override public void run(){
            CodeFoldingManager.getInstance(project).restoreFoldingState(editor,foldState);
          }
        }
);
      }
    }
);
  }
}
