{
  super.setStateImpl(project,editor,state);
  final CodeFoldingState foldState=state.getFoldingState();
  if (project != null && foldState != null) {
    PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
    editor.getFoldingModel().runBatchFoldingOperation(new Runnable(){
      public void run(){
        CodeFoldingManager.getInstance(project).restoreFoldingState(editor,foldState);
      }
    }
);
  }
}
