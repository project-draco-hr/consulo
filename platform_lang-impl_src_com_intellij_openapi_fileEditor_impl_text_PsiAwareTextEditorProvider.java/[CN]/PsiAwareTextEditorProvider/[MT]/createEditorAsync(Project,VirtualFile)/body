{
  if (!accept(project,file)) {
    LOG.error("Cannot open text editor for " + file);
  }
  CodeFoldingState state=null;
  try {
    Document document=FileDocumentManager.getInstance().getDocument(file);
    if (document != null) {
      state=CodeFoldingManager.getInstance(project).buildInitialFoldings(document);
    }
  }
 catch (  Exception e) {
    LOG.error("Error building initial foldings",e);
  }
  final CodeFoldingState finalState=state;
  return new Builder(){
    @Override public FileEditor build(){
      final PsiAwareTextEditorImpl editor=new PsiAwareTextEditorImpl(project,file,PsiAwareTextEditorProvider.this);
      if (finalState != null) {
        finalState.setToEditor(editor.getEditor());
      }
      return editor;
    }
  }
;
}
