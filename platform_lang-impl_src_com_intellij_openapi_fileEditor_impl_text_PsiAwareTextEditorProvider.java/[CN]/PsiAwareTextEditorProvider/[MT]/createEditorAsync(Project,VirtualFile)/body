{
  if (!accept(project,file)) {
    LOG.error("Cannot open text editor for " + file);
  }
  CodeFoldingState state=null;
  if (!project.isDefault()) {
    try {
      Document document=FileDocumentManager.getInstance().getDocument(file);
      if (document != null) {
        state=CodeFoldingManager.getInstance(project).buildInitialFoldings(document);
      }
    }
 catch (    ProcessCanceledException e) {
      throw e;
    }
catch (    Exception e) {
      LOG.error("Error building initial foldings",e);
    }
  }
  final CodeFoldingState finalState=state;
  return new Builder(){
    @Override public FileEditor build(){
      final PsiAwareTextEditorImpl editor=new PsiAwareTextEditorImpl(project,file,PsiAwareTextEditorProvider.this);
      if (finalState != null) {
        finalState.setToEditor(editor.getEditor());
      }
      return editor;
    }
  }
;
}
