{
  VirtualFile vFile=file.getViewProvider().getVirtualFile();
  PsiManagerImpl manager=(PsiManagerImpl)file.getManager();
  try {
    final FileType newFileType=FileTypeManager.getInstance().getFileTypeByFileName(newName);
    if (FileTypes.UNKNOWN.equals(newFileType) || newFileType.isBinary()) {
      final FileDocumentManager fdm=FileDocumentManager.getInstance();
      final Document doc=fdm.getCachedDocument(vFile);
      if (doc != null) {
        EditorSettingsExternalizable editorSettings=EditorSettingsExternalizable.getInstance();
        String trailer=editorSettings.getStripTrailingSpaces();
        boolean ensureEOLonEOF=editorSettings.isEnsureNewLineAtEOF();
        editorSettings.setStripTrailingSpaces(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_NONE);
        editorSettings.setEnsureNewLineAtEOF(false);
        try {
          fdm.saveDocument(doc);
        }
  finally {
          editorSettings.setStripTrailingSpaces(trailer);
          editorSettings.setEnsureNewLineAtEOF(ensureEOLonEOF);
        }
      }
    }
    vFile.rename(manager,newName);
  }
 catch (  IOException e) {
    throw new IncorrectOperationException(e.toString(),e);
  }
  return file.getViewProvider().isPhysical() ? manager.findFile(vFile) : file;
}
