{
  initMnemonics();
  initTree(myPsiTree);
  final TreeCellRenderer renderer=myPsiTree.getCellRenderer();
  myPsiTree.setCellRenderer(new TreeCellRenderer(){
    @Override public Component getTreeCellRendererComponent(    JTree tree,    Object value,    boolean selected,    boolean expanded,    boolean leaf,    int row,    boolean hasFocus){
      final Component c=renderer.getTreeCellRendererComponent(tree,value,selected,expanded,leaf,row,hasFocus);
      if (value instanceof DefaultMutableTreeNode) {
        final Object userObject=((DefaultMutableTreeNode)value).getUserObject();
        if (userObject instanceof ViewerNodeDescriptor) {
          final Object element=((ViewerNodeDescriptor)userObject).getElement();
          if ((element instanceof PsiElement && FileContextUtil.getFileContext(((PsiElement)element).getContainingFile()) != null) || element instanceof ViewerTreeStructure.Inject) {
            final TextAttributes attr=EditorColorsManager.getInstance().getGlobalScheme().getAttributes(EditorColors.INJECTED_LANGUAGE_FRAGMENT);
            c.setBackground(attr.getBackgroundColor());
          }
        }
      }
      return c;
    }
  }
);
  myPsiTreeBuilder=new ViewerTreeBuilder(myProject,myPsiTree);
  Disposer.register(getDisposable(),myPsiTreeBuilder);
  myPsiTree.addTreeSelectionListener(new MyPsiTreeSelectionListener());
  final GoToListener listener=new GoToListener();
  myRefs.addKeyListener(listener);
  myRefs.addMouseListener(listener);
  myRefs.getSelectionModel().addListSelectionListener(listener);
  myRefs.setCellRenderer(new DefaultListCellRenderer(){
    @Override public Component getListCellRendererComponent(    JList list,    Object value,    int index,    boolean isSelected,    boolean cellHasFocus){
      final Component comp=super.getListCellRendererComponent(list,value,index,isSelected,cellHasFocus);
      if (resolve(index) == null) {
        comp.setForeground(Color.red);
      }
      return comp;
    }
  }
);
  initTree(myBlockTree);
  myEditor.getSettings().setFoldingOutlineShown(false);
  myEditor.getDocument().addDocumentListener(myEditorListener);
  myEditor.getSelectionModel().addSelectionListener(myEditorListener);
  myEditor.getCaretModel().addCaretListener(myEditorListener);
  getPeer().getWindow().setFocusTraversalPolicy(new LayoutFocusTraversalPolicy(){
    @Override public Component getInitialComponent(    Window window){
      return myEditor.getComponent();
    }
  }
);
  final PsiViewerSettings settings=PsiViewerSettings.getSettings();
  final String type=myFileType != null ? myFileType : settings.type;
  SourceWrapper lastUsed=null;
  for (  PsiViewerExtension extension : Extensions.getExtensions(PsiViewerExtension.EP_NAME)) {
    final SourceWrapper wrapper=new SourceWrapper(extension);
    mySourceWrappers.add(wrapper);
  }
  final Set<FileType> allFileTypes=Sets.newHashSet();
  Collections.addAll(allFileTypes,FileTypeManager.getInstance().getRegisteredFileTypes());
  for (  Language language : Language.getRegisteredLanguages()) {
    final FileType fileType=language.getAssociatedFileType();
    if (fileType != null) {
      allFileTypes.add(fileType);
    }
  }
  Language curLanguage=myCurrentFile != null ? myCurrentFile.getLanguage() : null;
  for (  FileType fileType : allFileTypes) {
    if (fileType != StdFileTypes.GUI_DESIGNER_FORM && fileType != StdFileTypes.IDEA_MODULE && fileType != StdFileTypes.IDEA_PROJECT && fileType != StdFileTypes.IDEA_WORKSPACE && fileType != FileTypes.ARCHIVE && fileType != FileTypes.UNKNOWN && fileType != FileTypes.PLAIN_TEXT && !(fileType instanceof AbstractFileType) && !fileType.isBinary() && !fileType.isReadOnly()) {
      final SourceWrapper wrapper=new SourceWrapper(fileType);
      mySourceWrappers.add(wrapper);
      if (lastUsed == null && wrapper.getText().equals(type))       lastUsed=wrapper;
      if (myCurrentFile != null && wrapper.myFileType instanceof LanguageFileType && ((LanguageFileType)wrapper.myFileType).getLanguage().is(curLanguage)) {
        lastUsed=wrapper;
      }
    }
  }
  myFileTypeComboBox.setModel(new CollectionComboBoxModel(Lists.newArrayList(mySourceWrappers),lastUsed));
  myFileTypeComboBox.setRenderer(new ListCellRendererWrapper<SourceWrapper>(myFileTypeComboBox.getRenderer()){
    @Override public void customize(    JList list,    SourceWrapper value,    int index,    boolean selected,    boolean hasFocus){
      if (value != null) {
        setText(value.getText());
        setIcon(value.getIcon());
      }
    }
  }
);
  myFileTypeComboBox.setKeySelectionManager(new JComboBox.KeySelectionManager(){
    private static final int TIMEOUT=1000;
    private final StringBuilder myPrefix=new StringBuilder();
    private long myTimeStamp=0;
    @Override public int selectionForKey(    char ch,    ComboBoxModel model){
      final long now=System.currentTimeMillis();
      if (now - myTimeStamp > TIMEOUT) {
        myPrefix.delete(0,myPrefix.length());
      }
      myTimeStamp=now;
      if (Character.isLetterOrDigit(ch)) {
        myPrefix.append(ch);
      }
 else       if (ch == '\b') {
        myPrefix.delete(0,myPrefix.length());
        return 0;
      }
      final String prefix=myPrefix.toString().toLowerCase();
      for (int i=0, size=model.getSize(); i < size; i++) {
        final SourceWrapper item=(SourceWrapper)model.getElementAt(i);
        if (item.getText().toLowerCase().startsWith(prefix)) {
          return i;
        }
      }
      return -1;
    }
  }
);
  myFileTypeComboBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      updateDialectsCombo(null);
      updateExtensionsCombo();
      updateEditor();
    }
  }
);
  myDialectComboBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      updateEditor();
    }
  }
);
  myFileTypeComboBox.addFocusListener(new AutoExpandFocusListener(myFileTypeComboBox));
  if (myCurrentFile == null && lastUsed == null && mySourceWrappers.size() > 0) {
    myFileTypeComboBox.setSelectedIndex(0);
  }
  myDialectComboBox.setRenderer(new ListCellRendererWrapper<Language>(myDialectComboBox.getRenderer()){
    @Override public void customize(    final JList list,    final Language value,    final int index,    final boolean selected,    final boolean hasFocus){
      setText(value != null ? value.getDisplayName() : "<default>");
    }
  }
);
  myDialectComboBox.addFocusListener(new AutoExpandFocusListener(myDialectComboBox));
  myExtensionComboBox.setRenderer(new ListCellRendererWrapper<String>(myExtensionComboBox.getRenderer()){
    @Override public void customize(    JList list,    String value,    int index,    boolean selected,    boolean hasFocus){
      if (value != null)       setText("." + value);
    }
  }
);
  myExtensionComboBox.addFocusListener(new AutoExpandFocusListener(myExtensionComboBox));
  final ViewerTreeStructure psiTreeStructure=(ViewerTreeStructure)myPsiTreeBuilder.getTreeStructure();
  myShowWhiteSpacesBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      psiTreeStructure.setShowWhiteSpaces(myShowWhiteSpacesBox.isSelected());
      myPsiTreeBuilder.queueUpdate();
    }
  }
);
  myShowTreeNodesCheckBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      psiTreeStructure.setShowTreeNodes(myShowTreeNodesCheckBox.isSelected());
      myPsiTreeBuilder.queueUpdate();
    }
  }
);
  myShowWhiteSpacesBox.setSelected(settings.showWhiteSpaces);
  psiTreeStructure.setShowWhiteSpaces(settings.showWhiteSpaces);
  myShowTreeNodesCheckBox.setSelected(settings.showTreeNodes);
  psiTreeStructure.setShowTreeNodes(settings.showTreeNodes);
  myShowBlocksCheckBox.setSelected(settings.showBlocks);
  myBlockStructurePanel.setVisible(settings.showBlocks);
  myShowBlocksCheckBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      if (!myShowBlocksCheckBox.isSelected()) {
        settings.blockRefDividerLocation=myBlockRefSplitPane.getDividerLocation();
      }
 else {
        myBlockRefSplitPane.setDividerLocation(settings.blockRefDividerLocation);
      }
      myBlockStructurePanel.setVisible(myShowBlocksCheckBox.isSelected());
      myBlockStructurePanel.repaint();
    }
  }
);
  myTextPanel.setLayout(new BorderLayout());
  myTextPanel.add(myEditor.getComponent(),BorderLayout.CENTER);
  final AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(getClass());
  String text=myCurrentFile == null ? settings.text : myInitText;
  try {
    myEditor.getDocument().setText(text);
    myEditor.getSelectionModel().setSelection(0,text.length());
  }
  finally {
    token.finish();
  }
  updateDialectsCombo(settings.dialect);
  updateExtensionsCombo();
  registerCustomKeyboardActions();
  final Dimension size=DimensionService.getInstance().getSize(getDimensionServiceKey(),myProject);
  if (size == null) {
    DimensionService.getInstance().setSize(getDimensionServiceKey(),new Dimension(800,600));
  }
  myTextSplit.setDividerLocation(settings.textDividerLocation);
  myTreeSplit.setDividerLocation(settings.treeDividerLocation);
  myBlockRefSplitPane.setDividerLocation(settings.blockRefDividerLocation);
  updateEditor();
  super.init();
}
