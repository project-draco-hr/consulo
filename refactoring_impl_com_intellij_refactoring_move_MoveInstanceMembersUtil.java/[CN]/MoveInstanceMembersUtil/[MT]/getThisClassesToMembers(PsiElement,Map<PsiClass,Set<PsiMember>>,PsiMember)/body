{
  if (scope instanceof PsiExpression) {
    final PsiExpression expression=(PsiExpression)scope;
    if (!(scope instanceof PsiReferenceExpression) || !((PsiReferenceExpression)scope).isReferenceTo(refMember)) {
      final PsiMember member=getMemberReferencedByThis(expression);
      if (member != null && member.getContainingClass() != null && !PsiTreeUtil.isAncestor(refMember,member,false)) {
        addReferencedMember(map,member.getContainingClass(),member);
      }
      if (expression instanceof PsiThisExpression) {
        final PsiJavaCodeReferenceElement thisQualifier=((PsiThisExpression)expression).getQualifier();
        PsiClass thisClass=thisQualifier == null ? PsiTreeUtil.getParentOfType(expression,PsiClass.class,true) : ((PsiClass)thisQualifier.resolve());
        if (thisClass != null) {
          addReferencedMember(map,thisClass,null);
        }
      }
    }
  }
  final PsiElement[] children=scope.getChildren();
  for (  PsiElement child : children) {
    getThisClassesToMembers(child,map,refMember);
  }
}
