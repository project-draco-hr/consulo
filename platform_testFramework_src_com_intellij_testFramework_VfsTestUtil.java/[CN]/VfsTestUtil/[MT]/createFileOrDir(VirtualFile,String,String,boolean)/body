{
  try {
    AccessToken token=WriteAction.start();
    try {
      VirtualFile parent=root;
      Assert.assertNotNull(parent);
      StringTokenizer parents=new StringTokenizer(PathUtil.getParentPath(relativePath),"/");
      while (parents.hasMoreTokens()) {
        final String name=parents.nextToken();
        VirtualFile child=parent.findChild(name);
        if (child == null || !child.isValid()) {
          child=parent.createChildDirectory(VfsTestUtil.class,name);
        }
        parent=child;
      }
      final VirtualFile file;
      if (dir) {
        file=parent.createChildDirectory(VfsTestUtil.class,PathUtil.getFileName(relativePath));
      }
 else {
        file=parent.createChildData(VfsTestUtil.class,PathUtil.getFileName(relativePath));
        if (!text.isEmpty()) {
          VfsUtil.saveText(file,text);
        }
      }
      return file;
    }
  finally {
      token.finish();
    }
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
