{
  final Charset old=getUserData(CHARSET_KEY);
  putUserData(CHARSET_KEY,charset);
  if (Comparing.equal(charset,old))   return;
  byte[] bom=charset == null ? null : CharsetToolkit.getBom(charset);
  byte[] existingBOM=getBOM();
  if (bom == null && charset != null && existingBOM != null) {
    bom=CharsetToolkit.canHaveBom(charset,existingBOM) ? existingBOM : null;
  }
  setBOM(bom);
  if (old != null) {
    if (whenChanged != null)     whenChanged.run();
    VirtualFileManager.getInstance().notifyPropertyChanged(this,PROP_ENCODING,old,charset);
  }
}
