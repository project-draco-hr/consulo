{
  UsageView usageView=e.getData(UsageView.USAGE_VIEW_KEY);
  Project project=e.getData(CommonDataKeys.PROJECT);
  final FindUsagesManager findUsagesManager=((FindManagerImpl)FindManager.getInstance(project)).getFindUsagesManager();
  List<FindUsagesManager.SearchData> history=new ArrayList<FindUsagesManager.SearchData>(findUsagesManager.getFindUsageHistory());
  if (!history.isEmpty()) {
    history.remove(history.size() - 1);
    Collections.reverse(history);
  }
  if (history.isEmpty()) {
    history.add(new FindUsagesManager.SearchData());
  }
  BaseListPopupStep<FindUsagesManager.SearchData> step=new BaseListPopupStep<FindUsagesManager.SearchData>(FindBundle.message("recent.find.usages.action.title"),history){
    @Override public Icon getIconFor(    final FindUsagesManager.SearchData data){
      if (data.myElements == null) {
        return null;
      }
      PsiElement psiElement=data.myElements[0].getElement();
      if (psiElement == null)       return null;
      return IconDescriptorUpdaters.getIcon(psiElement,0);
    }
    @Override @NotNull public String getTextFor(    final FindUsagesManager.SearchData data){
      if (data.myElements == null) {
        return FindBundle.message("recent.find.usages.action.nothing");
      }
      PsiElement psiElement=data.myElements[0].getElement();
      if (psiElement == null)       return UsageViewBundle.message("node.invalid");
      String scopeString=data.myOptions.searchScope == null ? null : data.myOptions.searchScope.getDisplayName();
      return FindBundle.message("recent.find.usages.action.description",StringUtil.capitalize(UsageViewUtil.getType(psiElement)),DescriptiveNameUtil.getDescriptiveName(psiElement),scopeString == null ? ProjectScope.getAllScope(psiElement.getProject()).getDisplayName() : scopeString);
    }
    @Override public PopupStep onChosen(    final FindUsagesManager.SearchData selectedValue,    final boolean finalChoice){
      return doFinalStep(new Runnable(){
        @Override public void run(){
          if (selectedValue.myElements != null) {
            findUsagesManager.rerunAndRecallFromHistory(selectedValue);
          }
        }
      }
);
    }
  }
;
  RelativePoint point;
  if (e.getInputEvent() instanceof MouseEvent) {
    point=new RelativePoint((MouseEvent)e.getInputEvent());
  }
 else {
    point=new RelativePoint(usageView.getComponent(),new Point(4,4));
  }
  JBPopupFactory.getInstance().createListPopup(step).show(point);
}
