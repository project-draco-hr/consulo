{
  final StateWorker stateWorker=new StateWorker(node,myNodeConvertor);
  final VirtualFile vf=stateWorker.getVf();
  if (vf == null)   return;
  final TreeNodeState state=getStateImpl(stateWorker);
  if (TreeNodeState.HAVE_SELECTED_ABOVE.equals(state))   return;
  if (TreeNodeState.CLEAR.equals(state) && (!myState.canAddSelection()))   return;
  final HashSet<VirtualFile> old=new HashSet<VirtualFile>(myState.getSelected());
  final TreeNodeState futureState=myState.putAndPass(vf,TreeNodeState.SELECTED.equals(state) ? TreeNodeState.CLEAR : TreeNodeState.SELECTED);
  if (!TreeNodeState.SELECTED.equals(futureState)) {
    myState.clearAllCachedMatching(new Processor<VirtualFile>(){
      @Override public boolean process(      VirtualFile virtualFile){
        return VfsUtil.isAncestor(virtualFile,vf,false);
      }
    }
);
  }
  stateWorker.iterateParents(myState,new PairProcessor<VirtualFile,TreeNodeState>(){
    @Override public boolean process(    VirtualFile virtualFile,    TreeNodeState state){
      if (TreeNodeState.SELECTED.equals(futureState)) {
        myState.putAndPass(virtualFile,TreeNodeState.HAVE_SELECTED_BELOW);
      }
 else {
        myState.remove(virtualFile);
      }
      return true;
    }
  }
);
  myState.clearAllCachedMatching(new Processor<VirtualFile>(){
    @Override public boolean process(    VirtualFile vf){
      return VfsUtil.isAncestor(stateWorker.getVf(),vf,false);
    }
  }
);
  for (  VirtualFile selected : myState.getSelected()) {
    if (VfsUtil.isAncestor(stateWorker.getVf(),selected,true)) {
      myState.remove(selected);
    }
  }
  final Set<VirtualFile> selectedAfter=myState.getSelected();
  if (mySelectionChangeListener != null && !old.equals(selectedAfter)) {
    final Set<VirtualFile> removed=CollectionsDelta.notInSecond(old,selectedAfter);
    final Set<VirtualFile> newlyAdded=CollectionsDelta.notInSecond(selectedAfter,old);
    if (newlyAdded != null) {
      for (      VirtualFile file : newlyAdded) {
        if (mySelectionChangeListener != null) {
          mySelectionChangeListener.plus(file);
        }
      }
    }
    if (removed != null) {
      for (      VirtualFile file : removed) {
        if (mySelectionChangeListener != null) {
          mySelectionChangeListener.minus(file);
        }
      }
    }
  }
}
