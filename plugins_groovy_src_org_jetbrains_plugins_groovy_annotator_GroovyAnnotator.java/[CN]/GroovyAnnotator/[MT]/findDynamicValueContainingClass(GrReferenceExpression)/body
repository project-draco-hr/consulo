{
  final PsiClass psiClass;
  if (refExpr.isQualified()) {
    GrExpression qualifier=refExpr.getQualifierExpression();
    PsiType type=qualifier.getType();
    if (!(type instanceof PsiClassType))     return null;
    psiClass=((PsiClassType)type).resolve();
  }
 else {
    PsiElement refParent=refExpr.getParent();
    while (refParent != null && !(refParent instanceof GroovyFileBase)) {
      refParent=refParent.getParent();
    }
    if (refParent == null)     return null;
    psiClass=((GroovyFileBase)refParent).getScriptClass();
  }
  return psiClass;
}
