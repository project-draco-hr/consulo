{
  Set<PsiType> expectedTypes;
  if (closure.getParent() instanceof GrSafeCastExpression) {
    GrSafeCastExpression safeCastExpression=(GrSafeCastExpression)closure.getParent();
    GrTypeElement typeElement=safeCastExpression.getCastTypeElement();
    if (typeElement != null) {
      PsiType castType=typeElement.getType();
      expectedTypes=ContainerUtil.newHashSet(GroovyExpectedTypesProvider.getDefaultExpectedTypes(safeCastExpression));
      for (Iterator<PsiType> iterator=expectedTypes.iterator(); iterator.hasNext(); ) {
        if (!TypesUtil.isAssignable(iterator.next(),castType,closure,true)) {
          iterator.remove();
        }
      }
      if (expectedTypes.isEmpty())       expectedTypes.add(castType);
    }
 else {
      expectedTypes=GroovyExpectedTypesProvider.getDefaultExpectedTypes(closure);
    }
  }
 else {
    expectedTypes=GroovyExpectedTypesProvider.getDefaultExpectedTypes(closure);
  }
  for (  PsiType constraint : expectedTypes) {
    final PsiType suggestion=GppClosureParameterTypeProvider.getSingleMethodParameterType(constraint,index,closure);
    if (suggestion != null) {
      return suggestion;
    }
  }
  return null;
}
