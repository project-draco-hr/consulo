{
  VirtualFile file=getFile(document);
  if (file == null || file instanceof LightVirtualFile || file.isValid() && !isFileModified(file)) {
    removeFromUnsaved(document);
    return;
  }
  if (file.isValid() && needsRefresh(file)) {
    file.refresh(false,false);
    if (!myUnsavedDocuments.contains(document))     return;
  }
  if (!file.isValid() && !ApplicationManager.getApplication().isUnitTestMode() && false) {
    file=handleExternalDeletion(file);
    if (!myUnsavedDocuments.contains(document))     return;
  }
  final AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(getClass());
  try {
    doSaveDocumentInWriteAction(document,file);
  }
  finally {
    token.finish();
  }
}
