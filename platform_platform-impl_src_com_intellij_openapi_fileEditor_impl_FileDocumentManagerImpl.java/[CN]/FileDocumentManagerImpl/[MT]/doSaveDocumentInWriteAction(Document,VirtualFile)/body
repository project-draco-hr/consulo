{
  if (!file.isValid()) {
    removeFromUnsaved(document);
    return;
  }
  if (!file.equals(getFile(document))) {
    registerDocument(document,file);
  }
  if (!isSaveNeeded(document,file)) {
    if (document instanceof DocumentEx) {
      ((DocumentEx)document).setModificationStamp(file.getModificationStamp());
    }
    removeFromUnsaved(document);
    updateModifiedProperty(file);
    return;
  }
  myMultiCaster.beforeDocumentSaving(document);
  LOG.assertTrue(file.isValid());
  String text=document.getText();
  String lineSeparator=getLineSeparator(document,file);
  if (!lineSeparator.equals("\n")) {
    text=StringUtil.convertLineSeparators(text,lineSeparator);
  }
  Project project=ProjectLocator.getInstance().guessProjectForFile(file);
  LoadTextUtil.write(project,file,this,text,document.getModificationStamp());
  myUnsavedDocuments.remove(document);
  LOG.assertTrue(!myUnsavedDocuments.contains(document));
  myTrailingSpacesStripper.clearLineModificationFlags(document);
}
