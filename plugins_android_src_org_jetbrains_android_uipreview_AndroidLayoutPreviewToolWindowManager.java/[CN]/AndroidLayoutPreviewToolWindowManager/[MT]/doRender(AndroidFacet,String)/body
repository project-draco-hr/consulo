{
  BufferedImage image=null;
  RenderingErrorMessage errorMessage=null;
  final String imgPath=FileUtil.getTempDirectory() + "/androidLayoutPreview.png";
  try {
    final LayoutDeviceConfiguration deviceConfiguration=myToolWindowForm.getSelectedDeviceConfiguration();
    if (deviceConfiguration == null) {
      throw new RenderingException("Device is not specified");
    }
    final FolderConfiguration config=new FolderConfiguration();
    config.set(deviceConfiguration.getConfiguration());
    config.setDockModeQualifier(new DockModeQualifier(myToolWindowForm.getSelectedDockMode()));
    config.setNightModeQualifier(new NightModeQualifier(myToolWindowForm.getSelectedNightMode()));
    final LocaleData localeData=myToolWindowForm.getSelectedLocaleData();
    config.setLanguageQualifier(new LanguageQualifier(localeData.getLanguage()));
    config.setRegionQualifier(new RegionQualifier(localeData.getRegion()));
    final IAndroidTarget target=myToolWindowForm.getSelectedTarget();
    final ThemeData theme=myToolWindowForm.getSelectedTheme();
synchronized (RENDERING_LOCK) {
      if (target != null && theme != null && RenderUtil.renderLayout(myProject,layoutXmlText,imgPath,target,facet,config,theme)) {
        final File input=new File(imgPath);
        image=ImageIO.read(input);
      }
    }
  }
 catch (  RenderingException e) {
    LOG.debug(e);
    final String message=e.getPresentableMessage();
    errorMessage=new RenderingErrorMessage(message != null ? message : AndroidBundle.message("android.layout.preview.default.error.message"));
  }
catch (  IOException e) {
    LOG.info(e);
    final String message=e.getMessage();
    errorMessage=new RenderingErrorMessage("I/O error" + (message != null ? ": " + message : ""));
  }
catch (  AndroidSdkNotConfiguredException e) {
    LOG.debug(e);
    errorMessage=new RenderingErrorMessage("Please ","configure"," Android SDK",new Runnable(){
      @Override public void run(){
        AndroidSdkUtils.openModuleDependenciesConfigurable(facet.getModule());
      }
    }
);
  }
  final RenderingErrorMessage finalErrorMessage=errorMessage;
  final BufferedImage finalImage=image;
  if (!myRenderingQueue.isEmpty()) {
    return;
  }
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    @Override public void run(){
      if (!myToolWindowReady || myToolWindowDisposed) {
        return;
      }
      myToolWindowForm.setErrorMessage(finalErrorMessage);
      if (finalErrorMessage == null) {
        myToolWindowForm.setImage(finalImage);
      }
      myToolWindowForm.updatePreviewPanel();
    }
  }
);
}
