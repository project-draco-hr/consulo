{
  myProject=project;
  myFileEditorManager=fileEditorManager;
  myToolWindowUpdateQueue=new MergingUpdateQueue("android.layout.preview",300,true,null,project);
  myRenderingQueue=new MergingUpdateQueue("android.layout.rendering",300,true,null,project,null,false);
  final MessageBusConnection connection=project.getMessageBus().connect(project);
  connection.subscribe(FileEditorManagerListener.FILE_EDITOR_MANAGER,new MyFileEditorManagerListener());
  connection.subscribe(ProjectTopics.PROJECT_ROOTS,new MyAndroidPlatformListener(project));
  LocalFileSystem.getInstance().addVirtualFileListener(myListener);
  Disposer.register(project,new Disposable(){
    public void dispose(){
      LocalFileSystem.getInstance().removeVirtualFileListener(myListener);
    }
  }
);
  PsiManager.getInstance(project).addPsiTreeChangeListener(new PsiTreeChangeAdapter(){
    public void childrenChanged(    @NotNull PsiTreeChangeEvent event){
      update(event);
    }
    public void childRemoved(    @NotNull PsiTreeChangeEvent event){
      update(event);
    }
    public void childAdded(    @NotNull PsiTreeChangeEvent event){
      update(event);
    }
    public void childReplaced(    @NotNull PsiTreeChangeEvent event){
      update(event);
    }
  }
,project);
  CompilerManager.getInstance(project).addAfterTask(new CompileTask(){
    @Override public boolean execute(    CompileContext context){
      if (myToolWindowForm != null && myToolWindowReady && !myToolWindowDisposed) {
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          @Override public void run(){
            render();
          }
        }
);
      }
      return true;
    }
  }
);
}
