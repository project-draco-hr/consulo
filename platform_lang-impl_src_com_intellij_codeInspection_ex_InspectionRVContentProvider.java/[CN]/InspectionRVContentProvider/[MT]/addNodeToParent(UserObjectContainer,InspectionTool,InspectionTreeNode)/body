{
  final Set<InspectionTreeNode> children=new THashSet<InspectionTreeNode>(1000);
  TreeUtil.traverseDepth(parentNode,new TreeUtil.Traverse(){
    public boolean accept(    Object node){
      children.add((InspectionTreeNode)node);
      return true;
    }
  }
);
  final RefElementNode nodeToBeAdded=container.createNode(tool);
  boolean firstLevel=true;
  RefElementNode prevNode=null;
  while (true) {
    final RefElementNode currentNode=firstLevel ? nodeToBeAdded : container.createNode(tool);
    for (    InspectionTreeNode node : children) {
      if (node instanceof RefElementNode) {
        final RefElementNode refElementNode=(RefElementNode)node;
        if (container.areEqual(refElementNode.getUserObject(),container.getUserObject())) {
          if (firstLevel) {
            return refElementNode;
          }
 else {
            insertByIndex(prevNode,refElementNode);
            return nodeToBeAdded;
          }
        }
      }
    }
    if (!firstLevel) {
      insertByIndex(prevNode,currentNode);
    }
    final UserObjectContainer owner=container.getOwner();
    if (owner == null) {
      insertByIndex(currentNode,parentNode);
      return nodeToBeAdded;
    }
    container=owner;
    prevNode=currentNode;
    firstLevel=false;
  }
}
