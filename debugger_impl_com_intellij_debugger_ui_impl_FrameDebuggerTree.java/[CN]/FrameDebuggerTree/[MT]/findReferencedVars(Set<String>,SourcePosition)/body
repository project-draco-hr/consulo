{
  final int line=position.getLine();
  if (line < 0) {
    return new Pair<Set<String>,Set<TextWithImports>>(Collections.<String>emptySet(),Collections.<TextWithImports>emptySet());
  }
  final VirtualFile vFile=position.getFile().getVirtualFile();
  final Document doc=vFile != null ? FileDocumentManager.getInstance().getDocument(vFile) : null;
  if (doc == null || doc.getLineCount() == 0) {
    return new Pair<Set<String>,Set<TextWithImports>>(Collections.<String>emptySet(),Collections.<TextWithImports>emptySet());
  }
  final int lastLine=doc.getLineCount() - 1;
  int startLine=Math.max(0,line - 1);
  startLine=Math.min(startLine,lastLine);
  while (startLine > 0 && isLineEmpty(doc,startLine))   startLine--;
  final int startOffset=doc.getLineStartOffset(startLine);
  int endLine=Math.min(line + 2,lastLine);
  while (endLine < lastLine && isLineEmpty(doc,endLine))   endLine++;
  final int endOffset=doc.getLineEndOffset(endLine);
  final TextRange lineRange=new TextRange(startOffset,endOffset);
  if (!lineRange.isEmpty()) {
    final int offset=CharArrayUtil.shiftForward(doc.getCharsSequence(),doc.getLineStartOffset(line)," \t");
    PsiElement element=position.getFile().findElementAt(offset);
    if (element != null) {
      PsiMethod method=PsiTreeUtil.getNonStrictParentOfType(element,PsiMethod.class);
      if (method != null) {
        element=method;
      }
 else {
        PsiField field=PsiTreeUtil.getNonStrictParentOfType(element,PsiField.class);
        if (field != null) {
          element=field;
        }
 else {
          final PsiClassInitializer initializer=PsiTreeUtil.getNonStrictParentOfType(element,PsiClassInitializer.class);
          if (initializer != null) {
            element=initializer;
          }
        }
      }
      final Set<String> vars=new HashSet<String>();
      final Set<TextWithImports> expressions=new HashSet<TextWithImports>();
      final PsiRecursiveElementVisitor variablesCollector=new VariablesCollector(visibleVars,lineRange,expressions,vars);
      element.accept(variablesCollector);
      return new Pair<Set<String>,Set<TextWithImports>>(vars,expressions);
    }
  }
  return new Pair<Set<String>,Set<TextWithImports>>(Collections.<String>emptySet(),Collections.<TextWithImports>emptySet());
}
