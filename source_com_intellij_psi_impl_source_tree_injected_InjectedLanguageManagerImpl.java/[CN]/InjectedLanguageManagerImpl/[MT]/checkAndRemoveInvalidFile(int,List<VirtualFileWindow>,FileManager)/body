{
  VirtualFileWindow oldFile=cachedList.get(index);
  boolean isValid=oldFile.isValid();
  if (isValid) {
    PsiFile cached=fileManager.getCachedPsiFile(oldFile);
    PsiElement context;
    if (cached == null || (context=cached.getContext()) == null || !cached.isValid() || !context.isValid()) {
      isValid=false;
    }
 else     if (index < cachedList.size() - 1) {
      VirtualFileWindow nextFile=cachedList.get(index + 1);
      if (oldFile.getDocumentWindow().areRangesEqual(nextFile.getDocumentWindow())) {
        PsiFile nextCached=fileManager.getCachedPsiFile(nextFile);
        if (nextCached != null && nextCached.isValid()) {
          isValid=false;
        }
      }
    }
  }
  if (isValid) {
    return oldFile;
  }
  cachedList.remove(index);
  fileManager.setViewProvider(oldFile,null);
  return null;
}
