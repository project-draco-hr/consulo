{
  if (template == null) {
    throw new IllegalArgumentException("template cannot be null");
  }
  FileTemplateManager.getInstance().addRecentName(template.getName());
  String mergedText;
  String[] dummyRefs=calculateAttributes(template.getText(),props,true);
  for (int i=0; i < dummyRefs.length; i++) {
    String dummyRef=dummyRefs[i];
    props.setProperty(dummyRef,"");
  }
  try {
    if (template.isJavaClassTemplate()) {
      String packageName=props.getProperty(PACKAGE_ATTR);
      if (packageName == null || packageName.length() == 0) {
        props=new Properties(props);
        props.setProperty(PACKAGE_ATTR,PACKAGE_ATTR);
      }
    }
    mergedText=template.getText(props);
  }
 catch (  Exception e) {
    throw e;
  }
  final String templateText=StringUtil.convertLineSeparators(mergedText);
  final Exception[] commandException=new Exception[1];
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      final Runnable run=new Runnable(){
        public void run(){
          try {
            FileType fileType=FileTypeManagerEx.getInstanceEx().getFileTypeByExtension(template.getExtension());
            if (fileType.equals(StdFileTypes.JAVA)) {
              String extension=template.getExtension();
              myCreatedElement[0]=createClassOrInterface(project,directory,templateText,template.isAdjust(),extension);
            }
 else             if (fileType.equals(StdFileTypes.ASPECT)) {
              myCreatedElement[0]=createAspect(project,directory,templateText,template.isAdjust());
            }
 else {
              myCreatedElement[0]=createPsiFile(project,directory,templateText,fileName,template.getExtension());
            }
          }
 catch (          Exception ex) {
            commandException[0]=ex;
          }
        }
      }
;
      ApplicationManager.getApplication().runWriteAction(run);
    }
  }
,"Create " + (template.isJavaClassTemplate() ? "Class" : "File") + " From Template",null);
  if (commandException[0] != null) {
    throw commandException[0];
  }
  return true;
}
