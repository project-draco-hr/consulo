{
  final PsiPackage selectedPackage=getTreeSelection();
  if (selectedPackage == null)   return;
  final String newPackageName=Messages.showInputDialog(myProject,"Enter a new package name:","New Package",Messages.getQuestionIcon());
  if (newPackageName == null)   return;
  CommandProcessor.getInstance().executeCommand(myProject,new Runnable(){
    public void run(){
      final Runnable action=new Runnable(){
        public void run(){
          try {
            String newQualifiedName=selectedPackage.getQualifiedName();
            if (!Comparing.strEqual(newQualifiedName,""))             newQualifiedName+=".";
            newQualifiedName+=newPackageName;
            final PsiDirectory dir=PackageUtil.findOrCreateDirectoryForPackage(myProject,newQualifiedName,null,false);
            if (dir == null)             return;
            final PsiPackage newPackage=dir.getPackage();
            DefaultMutableTreeNode node=(DefaultMutableTreeNode)myTree.getSelectionPath().getLastPathComponent();
            final DefaultMutableTreeNode newChild=new DefaultMutableTreeNode();
            newChild.setUserObject(newPackage);
            node.add(newChild);
            final DefaultTreeModel model=(DefaultTreeModel)myTree.getModel();
            model.nodeStructureChanged(node);
            final TreePath selectionPath=myTree.getSelectionPath();
            TreePath path;
            if (selectionPath == null) {
              path=new TreePath(newChild.getPath());
            }
 else {
              path=selectionPath.pathByAddingChild(newChild);
            }
            myTree.setSelectionPath(path);
            myTree.scrollPathToVisible(path);
            myTree.expandPath(path);
          }
 catch (          IncorrectOperationException e) {
            Messages.showMessageDialog(getContentPane(),e.getMessage(),"Error",Messages.getErrorIcon());
            if (LOG.isDebugEnabled()) {
              LOG.debug(e);
            }
          }
        }
      }
;
      ApplicationManager.getApplication().runReadAction(action);
    }
  }
,"Create new package",null);
}
