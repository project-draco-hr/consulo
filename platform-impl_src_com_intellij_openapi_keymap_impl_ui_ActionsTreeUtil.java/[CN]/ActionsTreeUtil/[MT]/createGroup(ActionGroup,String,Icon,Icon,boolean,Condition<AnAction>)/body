{
  ActionManager actionManager=ActionManager.getInstance();
  Group group=new Group(groupName,actionManager.getId(actionGroup),icon,openIcon);
  AnAction[] children=actionGroup instanceof DefaultActionGroup ? ((DefaultActionGroup)actionGroup).getChildActionsOrStubs(null) : actionGroup.getChildren(null);
  for (int i=0; i < children.length; i++) {
    AnAction action=children[i];
    if (action instanceof ActionGroup) {
      Group subGroup=createGroup((ActionGroup)action,ignore,filtered);
      if (subGroup.getSize() > 0) {
        if (!ignore && !((ActionGroup)action).isPopup()) {
          group.addAll(subGroup);
        }
 else {
          group.addGroup(subGroup);
        }
      }
 else       if (filtered == null || filtered.value(actionGroup)) {
        group.addGroup(subGroup);
      }
    }
 else     if (action instanceof Separator) {
      if (group.getSize() > 0 && i < children.length - 1 && !(group.getChildren().get(group.getSize() - 1) instanceof Separator)) {
        group.addSeparator();
      }
    }
 else {
      String id=action instanceof ActionStub ? ((ActionStub)action).getId() : actionManager.getId(action);
      if (id != null) {
        if (id.startsWith(TOOL_ACTION_PREFIX))         continue;
        if (filtered == null || filtered.value(action)) {
          group.addActionId(id);
        }
      }
    }
  }
  group.normalizeSeparators();
  return group;
}
