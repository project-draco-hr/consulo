{
  if (length > COMPRESSION_THRESHOLD && canUseSnappy) {
    SoftReference<byte[]> reference=spareBufferLocal.get();
    byte[] compressedOutputBuffer=reference != null ? reference.get() : null;
    int maxCompressedSize=32 + length + length / 6;
    if (compressedOutputBuffer == null || compressedOutputBuffer.length < maxCompressedSize) {
      compressedOutputBuffer=new byte[maxCompressedSize];
      spareBufferLocal.set(new SoftReference<byte[]>(compressedOutputBuffer));
    }
    int compressedSize=Snappy.rawCompress(bytes,0,length,compressedOutputBuffer,0);
    DataInputOutputUtil.writeINT(out,-compressedSize);
    out.write(compressedOutputBuffer,0,compressedSize);
    return compressedSize;
  }
 else {
    DataInputOutputUtil.writeINT(out,length);
    out.write(bytes,0,length);
    return length;
  }
}
