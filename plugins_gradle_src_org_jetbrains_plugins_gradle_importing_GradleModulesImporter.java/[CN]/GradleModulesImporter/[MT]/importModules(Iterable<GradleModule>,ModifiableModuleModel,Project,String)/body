{
  final Map<GradleModule,Module> result=new HashMap<GradleModule,Module>();
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      Application application=ApplicationManager.getApplication();
      AccessToken writeLock=application.acquireWriteActionLock(getClass());
      try {
        final List<ModifiableRootModel> rootModels=new ArrayList<ModifiableRootModel>();
        final GradleProjectEntityImportListener publisher=intellijProject.getMessageBus().syncPublisher(GradleProjectEntityImportListener.TOPIC);
        for (        GradleModule module : modules) {
          publisher.onImportStart(module);
        }
        try {
          Map<GradleModule,Module> moduleMappings=doImportModules(modules,model,rootModels);
          result.putAll(moduleMappings);
          myAlarm.cancelAllRequests();
          myAlarm.addRequest(new SetupExternalLibrariesTask(moduleMappings,gradleProjectPath,intellijProject),PROJECT_INITIALISATION_DELAY_MS);
        }
  finally {
          ProjectRootManager projectRootManager=ProjectRootManager.getInstance(intellijProject);
          ModifiableRootModel[] modelsAsArray=rootModels.toArray(new ModifiableRootModel[rootModels.size()]);
          projectRootManager.multiCommit(model,modelsAsArray);
          for (          GradleModule module : modules) {
            publisher.onImportEnd(module);
          }
        }
      }
  finally {
        writeLock.finish();
      }
    }
  }
);
  return result;
}
