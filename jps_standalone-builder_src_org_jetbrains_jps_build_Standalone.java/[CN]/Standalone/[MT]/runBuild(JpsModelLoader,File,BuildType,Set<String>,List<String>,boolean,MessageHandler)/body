{
  List<TargetTypeBuildScope> scopes=new ArrayList<TargetTypeBuildScope>();
  if (modulesSet.isEmpty()) {
    scopes.addAll(CmdlineProtoUtil.createAllModulesScopes());
  }
 else {
    for (    JavaModuleBuildTargetType type : JavaModuleBuildTargetType.ALL_TYPES) {
      if (includeTests || !type.isTests()) {
        scopes.add(TargetTypeBuildScope.newBuilder().setTypeId(type.getTypeId()).addAllTargetId(modulesSet).build());
      }
    }
  }
  if (artifactsList.isEmpty()) {
    scopes.add(TargetTypeBuildScope.newBuilder().setTypeId(ArtifactBuildTargetType.INSTANCE.getTypeId()).addAllTargetId(artifactsList).build());
  }
  final BuildRunner buildRunner=new BuildRunner(loader,scopes,Collections.<String>emptyList(),Collections.<String,String>emptyMap());
  ProjectDescriptor descriptor=buildRunner.load(messageHandler,dataStorageRoot,new BuildFSState(true));
  try {
    buildRunner.runBuild(descriptor,CanceledStatus.NULL,null,messageHandler,includeTests,buildType);
  }
  finally {
    descriptor.release();
  }
}
