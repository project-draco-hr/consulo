{
  List<TargetTypeBuildScope> scopes=new ArrayList<TargetTypeBuildScope>();
  for (  JavaModuleBuildTargetType type : JavaModuleBuildTargetType.ALL_TYPES) {
    if (includeTests || !type.isTests()) {
      TargetTypeBuildScope.Builder builder=TargetTypeBuildScope.newBuilder().setTypeId(type.getTypeId()).setForceBuild(forceBuild);
      if (allModules) {
        scopes.add(builder.setAllTargets(true).build());
      }
 else       if (!modulesSet.isEmpty()) {
        scopes.add(builder.addAllTargetId(modulesSet).build());
      }
    }
  }
  if (!artifactsList.isEmpty()) {
    scopes.add(TargetTypeBuildScope.newBuilder().setTypeId(ArtifactBuildTargetType.INSTANCE.getTypeId()).setForceBuild(forceBuild).addAllTargetId(artifactsList).build());
  }
  final BuildRunner buildRunner=new BuildRunner(loader,Collections.<String>emptyList(),Collections.<String,String>emptyMap());
  ProjectDescriptor descriptor=buildRunner.load(messageHandler,dataStorageRoot,new BuildFSState(true));
  try {
    buildRunner.runBuild(descriptor,CanceledStatus.NULL,null,messageHandler,BuildType.BUILD,scopes,true);
  }
  finally {
    descriptor.release();
  }
}
