{
  myWarningLabel.setIcon(IconLoader.getIcon("/runConfigurations/configurationWarning.png"));
  myBuildJarsOnMake.setSelected(BuildJarProjectSettings.getInstance(myProject).isBuildJarOnMake());
  myJarPath=myJarFilePathComponent.getComponent();
  myMainClass=myMainClassComponent.getComponent();
  myElementsChooser=new ElementsChooser<Module>(true){
    @Override protected String getItemText(    final Module value){
      return value.getName();
    }
  }
;
  myElementsChooser.setColorUnmarkedElements(false);
  myModulesPanel.setLayout(new BorderLayout());
  myModulesPanel.add(myElementsChooser,BorderLayout.CENTER);
  final Collection<Module> modules=getModulesToJar(myProject);
  for (  final Module module : modules) {
    BuildJarSettings buildJarSettings=BuildJarSettings.getInstance(module);
    myElementsChooser.addElement(module,buildJarSettings.isBuildJar(),new ChooserElementProperties(module));
  }
  myElementsChooser.addListSelectionListener(new ListSelectionListener(){
    public void valueChanged(    ListSelectionEvent e){
      if (myCurrentModule != null) {
        saveEditor(myCurrentModule);
      }
      Module selectedModule=myElementsChooser.getSelectedElement();
      myCurrentModule=selectedModule;
      if (selectedModule != null) {
        BuildJarSettings buildJarSettings=BuildJarSettings.getInstance(selectedModule);
        SettingsEditor settingsEditor=mySettings.get(selectedModule);
        if (settingsEditor == null) {
          settingsEditor=new SettingsEditor(selectedModule,buildJarSettings);
          mySettings.put(selectedModule,settingsEditor);
        }
        settingsEditor.refreshControls();
        boolean isBuildJar=myElementsChooser.getMarkedElements().contains(selectedModule);
        GuiUtils.enableChildren(myModuleSettingsPanel,isBuildJar);
        settingsEditor.rebuildTree();
        TitledBorder titledBorder=(TitledBorder)myModuleSettingsPanel.getBorder();
        titledBorder.setTitle(IdeBundle.message("jar.build.module.0.jar.settings",selectedModule.getName()));
        myModuleSettingsPanel.repaint();
      }
    }
  }
);
  myElementsChooser.addElementsMarkListener(new ElementsChooser.ElementsMarkListener<Module>(){
    public void elementMarkChanged(    final Module element,    final boolean isMarked){
      GuiUtils.enableChildren(myModuleSettingsPanel,isMarked);
      SettingsEditor settingsEditor=mySettings.get(element);
      if (isMarked) {
        setDefaultJarPath();
        if (settingsEditor != null) {
          PackagingConfiguration configuration=settingsEditor.getEditor().getModifiedConfiguration();
          if (configuration.getElements().length == 0) {
            ModuleLink moduleLink=DeploymentUtil.getInstance().createModuleLink(element,element);
            moduleLink.setPackagingMethod(PackagingMethod.COPY_FILES);
            moduleLink.setURI("/");
            configuration.addOrReplaceElement(moduleLink);
          }
        }
      }
      if (settingsEditor != null) {
        settingsEditor.rebuildTree();
      }
    }
  }
);
  myJarPath.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String lastFilePath=myJarPath.getText();
      String path=lastFilePath == null ? RecentProjectsManager.getInstance().getLastProjectPath() : lastFilePath;
      File file=new File(path);
      if (!file.exists()) {
        path=file.getParent();
      }
      JFileChooser fileChooser=new JFileChooser(path);
      FileView fileView=new FileView(){
        public Icon getIcon(        File f){
          if (f.isDirectory())           return super.getIcon(f);
          FileType fileType=FileTypeManager.getInstance().getFileTypeByFileName(f.getName());
          return fileType.getIcon();
        }
      }
;
      fileChooser.setFileView(fileView);
      fileChooser.setMultiSelectionEnabled(false);
      fileChooser.setAcceptAllFileFilterUsed(false);
      fileChooser.setDialogTitle(IdeBundle.message("jar.build.save.title"));
      fileChooser.addChoosableFileFilter(new FileTypeFilter(FileTypes.ARCHIVE));
      if (fileChooser.showSaveDialog(WindowManager.getInstance().suggestParentWindow(myProject)) != JFileChooser.APPROVE_OPTION) {
        return;
      }
      file=fileChooser.getSelectedFile();
      if (file == null)       return;
      myJarPath.setText(file.getPath());
    }
  }
);
  myMainClass.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      String mainClass=myMainClass.getText();
      GlobalSearchScope scope=createMainClassScope();
      PsiClass aClass=JavaPsiFacade.getInstance(myProject).findClass(mainClass,scope);
      TreeClassChooserFactory factory=TreeClassChooserFactory.getInstance(myProject);
      final TreeClassChooser dialog=factory.createNoInnerClassesScopeChooser(IdeBundle.message("jar.build.main.class.title"),scope,null,aClass);
      dialog.showDialog();
      final PsiClass psiClass=dialog.getSelectedClass();
      if (psiClass != null && psiClass.getQualifiedName() != null) {
        myMainClass.setText(psiClass.getQualifiedName());
      }
      updateWarning();
    }
  }
);
  myMainClass.getTextField().getDocument().addDocumentListener(new DocumentAdapter(){
    protected void textChanged(    DocumentEvent e){
      updateWarning();
    }
  }
);
  SwingUtilities.invokeLater(new Runnable(){
    public void run(){
      Module element=myElementsChooser.getElementAt(0);
      myElementsChooser.selectElements(Collections.singletonList(element));
    }
  }
);
  GuiUtils.replaceJSplitPaneWithIDEASplitter(myPanel);
}
