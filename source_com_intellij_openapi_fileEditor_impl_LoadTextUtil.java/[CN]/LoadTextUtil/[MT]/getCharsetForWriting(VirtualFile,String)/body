{
  FileType fileType=virtualFile.getFileType();
  Charset charset=virtualFile.getCharset();
  if (fileType instanceof XmlFileType) {
    charset=CharsetToolkit.UTF8_CHARSET;
    String name=XmlUtil.extractXmlEncodingFromProlog(text);
    if (name != null) {
      try {
        charset=Charset.forName(name);
      }
 catch (      IllegalCharsetNameException e) {
      }
catch (      UnsupportedCharsetException e) {
      }
    }
  }
  return charset;
}
