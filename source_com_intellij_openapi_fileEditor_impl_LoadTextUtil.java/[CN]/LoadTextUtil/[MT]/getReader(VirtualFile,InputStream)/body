{
  if (virtualFile instanceof MockVirtualFile) {
    return new CharSequenceReader(((MockVirtualFile)virtualFile).getContent());
  }
  final Reader reader;
  FileType fileType=FileTypeManager.getInstance().getFileTypeByFile(virtualFile);
  String charsetName=fileType.getCharset(virtualFile);
  if (charsetName != null) {
    virtualFile.setCharset(Charset.forName(charsetName));
    reader=new BufferedReader(new InputStreamReader(stream,virtualFile.getCharset()));
    skipUTF8BOM(virtualFile,reader);
    return reader;
  }
  CharsetSettings settings=CharsetSettings.getInstance();
  if (settings != null && settings.isUseUTFGuessing()) {
    SmartEncodingInputStream seis=new SmartEncodingInputStream(stream,SmartEncodingInputStream.BUFFER_LENGTH_4KB,CharsetToolkit.getIDEOptionsCharset(),true);
    virtualFile.setCharset(seis.getEncoding());
    reader=seis.getReader();
    if (Patches.SUN_BUG_ID_4508058) {
      virtualFile.setBOM(seis.detectUTF8_BOM());
    }
  }
 else {
    virtualFile.setCharset(CharsetToolkit.getIDEOptionsCharset());
    if (virtualFile.getCharset() != null) {
      reader=new BufferedReader(new InputStreamReader(stream,virtualFile.getCharset()));
      skipUTF8BOM(virtualFile,reader);
    }
 else {
      reader=new InputStreamReader(stream);
    }
  }
  return reader;
}
