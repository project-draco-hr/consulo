{
  CharsetSettings settings=CharsetSettings.getInstance();
  boolean shouldGuess=settings != null && settings.isUseUTFGuessing();
  CharsetToolkit toolkit=shouldGuess ? new CharsetToolkit(content,CharsetToolkit.getIDEOptionsCharset()) : null;
  if (shouldGuess) {
    toolkit.setEnforce8Bit(true);
    Charset charset=toolkit.guessFromBOM();
    if (charset != null)     return charset;
  }
  FileType fileType=virtualFile.getFileType();
  String charsetName=fileType.getCharset(virtualFile);
  if (charsetName != null) {
    return CharsetToolkit.forName(charsetName);
  }
  if (shouldGuess) {
    Charset charset=toolkit.guessEncoding(content.length);
    if (charset != null)     return charset;
  }
  return null;
}
