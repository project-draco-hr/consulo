{
  CharBuffer charBuffer;
  if (virtualFile instanceof MockVirtualFile) {
    CharSequence content=((MockVirtualFile)virtualFile).getContent();
    charBuffer=CharBuffer.allocate(content.length());
    charBuffer.append(content);
    charBuffer.flip();
  }
 else {
    int offset=detectCharsetAndSkipBOM(virtualFile,bytes);
    ByteBuffer byteBuffer=ByteBuffer.wrap(bytes,offset,bytes.length - offset);
    Charset charset=virtualFile.getCharset();
    if (charset == null) {
      charset=CharsetToolkit.getDefaultSystemCharset();
    }
    if (charset == null) {
      charset=Charset.forName("ISO-8859-1");
    }
    charBuffer=charset.decode(byteBuffer);
  }
  Pair<CharSequence,String> result=convertLineSeparators(charBuffer);
  virtualFile.putUserData(DETECTED_LINE_SEPARATOR_KEY,result.getSecond());
  return result.getFirst();
}
