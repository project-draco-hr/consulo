{
  FileType fileType=FileTypeManager.getInstance().getFileTypeByFile(virtualFile);
  String charsetName=fileType.getCharset(virtualFile);
  if (charsetName != null) {
    Charset charset=null;
    try {
      charset=Charset.forName(charsetName);
    }
 catch (    IllegalCharsetNameException e) {
    }
catch (    UnsupportedCharsetException e) {
    }
    virtualFile.setCharset(charset);
    return skipUTF8BOM(virtualFile,content);
  }
  CharsetSettings settings=CharsetSettings.getInstance();
  if (settings != null && settings.isUseUTFGuessing()) {
    CharsetToolkit toolkit=new CharsetToolkit(content,CharsetToolkit.getIDEOptionsCharset());
    toolkit.setEnforce8Bit(true);
    Charset charset=toolkit.guessEncoding(SmartEncodingInputStream.BUFFER_LENGTH_4KB);
    virtualFile.setCharset(charset);
    return skipUTF8BOM(virtualFile,content);
  }
 else {
    virtualFile.setCharset(CharsetToolkit.getIDEOptionsCharset());
    return skipUTF8BOM(virtualFile,content);
  }
}
