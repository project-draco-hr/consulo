{
  ArrayList<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  if (myToDoSettings.getIsPackagesShown()) {
    TodoTreeHelper.getInstance(getProject()).addPackagesToChildren(children,getValue(),myBuilder);
  }
 else {
    for (Iterator i=myBuilder.getAllFiles(); i.hasNext(); ) {
      final PsiFile psiFile=(PsiFile)i.next();
      if (psiFile == null) {
        continue;
      }
      final VirtualFile virtualFile=psiFile.getVirtualFile();
      final boolean isInContent=ModuleRootManager.getInstance(getValue()).getFileIndex().isInContent(virtualFile);
      if (!isInContent)       continue;
      TodoFileNode fileNode=new TodoFileNode(getProject(),psiFile,myBuilder,false);
      if (getTreeStructure().accept(psiFile) && !children.contains(fileNode)) {
        children.add(fileNode);
      }
    }
  }
  return children;
}
