{
  final Set<Chunk<Node>> chunks=new HashSet<Chunk<Node>>();
  final Map<Node,Chunk<Node>> nodeToChunkMap=new HashMap<Node,Chunk<Node>>();
  for (Iterator<Node> it=graph.getNodes().iterator(); it.hasNext(); ) {
    final Chunk<Node> chunk=buildChunk(graph,it.next());
    chunks.add(chunk);
    for (Iterator<Node> nodeIterator=chunk.getNodes().iterator(); nodeIterator.hasNext(); ) {
      nodeToChunkMap.put(nodeIterator.next(),chunk);
    }
  }
  return GraphGenerator.create(CachingSemiGraph.create(new GraphGenerator.SemiGraph<Chunk<Node>>(){
    public Collection<Chunk<Node>> getNodes(){
      return chunks;
    }
    public Iterator<Chunk<Node>> getIn(    Chunk<Node> chunk){
      final Set<Node> chunkNodes=chunk.getNodes();
      final Set<Chunk<Node>> ins=new HashSet<Chunk<Node>>();
      for (Iterator<Node> chunkNodesIterator=chunkNodes.iterator(); chunkNodesIterator.hasNext(); ) {
        final Node node=chunkNodesIterator.next();
        for (Iterator<Node> nodeIns=graph.getIn(node); nodeIns.hasNext(); ) {
          final Node in=nodeIns.next();
          if (!chunk.containsNode(in)) {
            ins.add(nodeToChunkMap.get(in));
          }
        }
      }
      return ins.iterator();
    }
  }
));
}
