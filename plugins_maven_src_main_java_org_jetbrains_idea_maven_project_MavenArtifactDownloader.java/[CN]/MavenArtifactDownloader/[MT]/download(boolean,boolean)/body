{
  List<File> downloadedFiles=new ArrayList<File>();
  try {
    List<MavenExtraArtifactType> types=new ArrayList<MavenExtraArtifactType>(2);
    if (downloadSources)     types.add(MavenExtraArtifactType.SOURCES);
    if (downloadDocs)     types.add(MavenExtraArtifactType.DOCS);
    String caption=downloadSources && downloadDocs ? ProjectBundle.message("maven.downloading") : (downloadSources ? ProjectBundle.message("maven.downloading.sources") : ProjectBundle.message("maven.downloading.docs"));
    myProgress.setText(caption);
    Map<MavenId,DownloadData> artifacts=collectArtifactsToDownload(types);
    return download(artifacts,downloadedFiles);
  }
  finally {
    boolean isAsync=!ApplicationManager.getApplication().isUnitTestMode();
    Set<File> parentsToRefresh=new HashSet<File>();
    for (    File file : downloadedFiles) {
      parentsToRefresh.add(file.getParentFile());
    }
    LocalFileSystem.getInstance().refreshIoFiles(parentsToRefresh,isAsync,false,null);
  }
}
