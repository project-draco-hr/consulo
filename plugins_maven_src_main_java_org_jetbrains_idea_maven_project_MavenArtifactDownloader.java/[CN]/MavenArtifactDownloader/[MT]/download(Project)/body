{
  final MavenProjectsManager manager=MavenProjectsManager.getInstance(project);
  final Map<MavenProject,Collection<String>> mavenProjects=new HashMap<MavenProject,Collection<String>>();
  final Map<VirtualFile,MavenProject> fileToProject=new HashMap<VirtualFile,MavenProject>();
  final MavenEmbedder e=MavenFactory.createEmbedderForRead(MavenCore.getInstance(project).getState());
  try {
    for (    VirtualFile file : manager.getFiles()) {
      if (!manager.isIgnored(file)) {
        MavenProject p=manager.getResolvedProject(file);
        if (p == null)         continue;
        mavenProjects.put(p,manager.getActiveProfiles(file));
        fileToProject.put(file,p);
      }
    }
    final Map<MavenProject,Module> projectsToModules=new HashMap<MavenProject,Module>();
    for (    Module module : ModuleManager.getInstance(project).getModules()) {
      VirtualFile pomFile=manager.findPomForModule(module);
      if (pomFile != null && !manager.isIgnored(pomFile)) {
        MavenProject mavenProject=fileToProject.get(pomFile);
        if (mavenProject != null) {
          projectsToModules.put(mavenProject,module);
        }
      }
    }
    Progress.run(project,ProjectBundle.message("maven.downloading"),new Progress.Process(){
      public void run(      Progress p) throws MavenException, CanceledException {
        Collection<ProjectId> projectIds=new ArrayList<ProjectId>();
        for (        MavenProject mavenProject : projectsToModules.keySet()) {
          projectIds.add(new ProjectId(mavenProject.getArtifact()));
        }
        new MavenArtifactDownloader(manager.getArtifactSettings(),e,p).download(project,mavenProjects,fileToProject,projectIds,true);
      }
    }
);
  }
  finally {
    MavenFactory.releaseEmbedder(e);
  }
  VirtualFileManager.getInstance().refresh(false);
}
