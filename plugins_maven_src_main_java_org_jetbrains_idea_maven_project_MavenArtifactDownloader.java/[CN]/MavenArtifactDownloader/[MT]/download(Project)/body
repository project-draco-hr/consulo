{
  final MavenProjectsManager projectsManager=MavenProjectsManager.getInstance(project);
  final MavenImporter importer=MavenImporter.getInstance(project);
  final Map<MavenProject,Collection<String>> mavenProjects=new HashMap<MavenProject,Collection<String>>();
  Map<MavenId,VirtualFile> projectMapping=projectsManager.getProjectMapping();
  final Map<VirtualFile,MavenProject> fileToProject=new HashMap<VirtualFile,MavenProject>();
  final MavenEmbedder e=MavenFactory.createEmbedderForResolve(MavenCore.getInstance(project).getState(),projectMapping);
  final MavenProjectReader reader=new MavenProjectReader(e);
  try {
    Progress.run(project,ProjectBundle.message("maven.reading"),new Progress.Process(){
      public void run(      Progress p) throws MavenException, CanceledException {
        for (        VirtualFile file : projectsManager.getFiles()) {
          if (!projectsManager.isIgnored(file)) {
            MavenProject project=reader.readBare(file.getPath());
            mavenProjects.put(project,projectsManager.getProfiles(file));
            fileToProject.put(file,project);
            p.checkCanceled();
          }
        }
      }
    }
);
    final Map<MavenProject,Module> projectsToModules=new HashMap<MavenProject,Module>();
    for (    Module module : ModuleManager.getInstance(project).getModules()) {
      VirtualFile pomFile=importer.findPomForModule(module);
      if (pomFile != null && !projectsManager.isIgnored(pomFile)) {
        MavenProject mavenProject=fileToProject.get(pomFile);
        if (mavenProject != null) {
          projectsToModules.put(mavenProject,module);
        }
      }
    }
    Progress.run(project,ProjectBundle.message("maven.downloading"),new Progress.Process(){
      public void run(      Progress p) throws MavenException, CanceledException {
        Collection<MavenId> moduleIds=new ArrayList<MavenId>();
        for (        MavenProject mavenProject : projectsToModules.keySet()) {
          moduleIds.add(new MavenId(mavenProject.getArtifact()));
        }
        new MavenArtifactDownloader(importer.getArtifactSettings(),e,p).download(project,mavenProjects,fileToProject,moduleIds,true);
      }
    }
);
  }
  finally {
    MavenFactory.releaseEmbedder(e);
  }
  VirtualFileManager.getInstance().refresh(false);
}
