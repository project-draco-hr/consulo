{
  final MavenProjectsState projectsState=MavenProjectsState.getInstance(project);
  final Map<MavenId,Set<ArtifactRepository>> libraryArtifacts=collectLibraryArtifacts(projectsState,projectsWithProfiles.keySet(),mappedToModules);
  myProgress.checkCanceled();
  if (isEnabled(mySettings.getDownloadSources(),demand)) {
    download(libraryArtifacts,Constants.SOURCES_CLASSIFIER);
  }
  myProgress.checkCanceled();
  if (isEnabled(mySettings.getDownloadJavadoc(),demand)) {
    download(libraryArtifacts,Constants.JAVADOC_CLASSIFIER);
  }
  myProgress.checkCanceled();
  if (isEnabled(mySettings.getDownloadPlugins(),demand)) {
    final Map<Plugin,MavenProject> plugins=ProjectUtil.collectPlugins(projectsWithProfiles);
    collectAttachedPlugins(projectsState,projectToFile,plugins);
    downloadPlugins(plugins);
    projectsState.updateAllFiles();
  }
  myProgress.checkCanceled();
  if (isEnabled(mySettings.getGenerateSources(),demand)) {
    generateSources(project,createGenerateCommand(projectsWithProfiles));
  }
}
