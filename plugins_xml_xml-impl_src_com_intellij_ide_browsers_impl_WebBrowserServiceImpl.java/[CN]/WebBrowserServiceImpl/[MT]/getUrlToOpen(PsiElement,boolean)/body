{
  final PsiFile psiFile=psiElement instanceof PsiFile ? (PsiFile)psiElement : psiElement.getContainingFile();
  if (psiFile == null) {
    return null;
  }
  VirtualFile virtualFile=psiFile.getVirtualFile();
  if (virtualFile == null) {
    return null;
  }
  if (virtualFile instanceof HttpVirtualFile) {
    return Urls.newFromVirtualFile(virtualFile);
  }
  if (!(preferLocalUrl && HtmlUtil.isHtmlFile(psiFile))) {
    WebBrowserUrlProvider provider=getProvider(psiElement);
    if (provider != null) {
      try {
        return Urls.newFromIdea(provider.getUrl(psiElement,psiFile,virtualFile));
      }
 catch (      WebBrowserUrlProvider.BrowserException e) {
        if (!HtmlUtil.isHtmlFile(psiFile)) {
          throw e;
        }
      }
    }
  }
  return Urls.newFromVirtualFile(virtualFile);
}
