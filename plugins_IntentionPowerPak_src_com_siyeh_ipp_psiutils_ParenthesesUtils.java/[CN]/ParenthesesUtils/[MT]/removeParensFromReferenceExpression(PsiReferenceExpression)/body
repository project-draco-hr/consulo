{
  final PsiExpression qualifier=referenceExpression.getQualifierExpression();
  if (qualifier != null) {
    final PsiType[] typeParameters=referenceExpression.getTypeParameters();
    if (typeParameters.length > 0) {
      final StringBuilder out=new StringBuilder();
      out.append(removeParentheses(qualifier));
      out.append(".<");
      out.append(typeParameters[0].getCanonicalText());
      for (int i=1; i < typeParameters.length; i++) {
        final PsiType typeParameter=typeParameters[i];
        out.append(',');
        out.append(typeParameter.getCanonicalText());
      }
      out.append('>');
      out.append(referenceExpression.getReferenceName());
      return out.toString();
    }
 else {
      return removeParentheses(qualifier) + '.' + referenceExpression.getReferenceName();
    }
  }
 else {
    return referenceExpression.getText();
  }
}
