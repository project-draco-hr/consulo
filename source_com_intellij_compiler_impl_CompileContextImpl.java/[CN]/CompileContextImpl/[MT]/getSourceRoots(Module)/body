{
  VirtualFile[] cachedRoots=myModuleToRootsCache.get(module);
  if (cachedRoots != null) {
    if (areFilesValid(cachedRoots)) {
      return cachedRoots;
    }
 else {
      myModuleToRootsCache.remove(module);
    }
  }
  Set<VirtualFile> additionalRoots=myModuleToRootsMap.get(module);
  VirtualFile[] moduleRoots=ModuleRootManager.getInstance(module).getSourceRoots();
  if (additionalRoots == null || additionalRoots.size() == 0) {
    myModuleToRootsCache.put(module,moduleRoots);
    return moduleRoots;
  }
  final VirtualFile[] allRoots=new VirtualFile[additionalRoots.size() + moduleRoots.length];
  System.arraycopy(moduleRoots,0,allRoots,0,moduleRoots.length);
  int index=moduleRoots.length;
  for (Iterator<VirtualFile> it=additionalRoots.iterator(); it.hasNext(); ) {
    allRoots[index++]=it.next();
  }
  myModuleToRootsCache.put(module,allRoots);
  return allRoots;
}
