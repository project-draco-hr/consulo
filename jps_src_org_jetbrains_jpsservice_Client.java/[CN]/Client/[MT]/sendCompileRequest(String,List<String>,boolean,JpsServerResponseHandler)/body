{
  if (myState.get() != State.CONNECTED) {
    return false;
  }
  final UUID uuid=UUID.randomUUID();
  final JpsRemoteProto.Message.Request request=rebuild ? ProtoUtil.createRebuildRequest(projectId,modules) : ProtoUtil.createMakeRequest(projectId,modules);
  myHandlers.put(uuid,handler);
  boolean success=false;
  try {
    final ChannelFuture future=Channels.write(myConnectFuture.getChannel(),ProtoUtil.toMessage(uuid,request));
    future.awaitUninterruptibly();
    success=future.isSuccess();
    return success;
  }
  finally {
    if (!success) {
      myHandlers.remove(uuid);
      handler.sessionTerminated();
    }
  }
}
