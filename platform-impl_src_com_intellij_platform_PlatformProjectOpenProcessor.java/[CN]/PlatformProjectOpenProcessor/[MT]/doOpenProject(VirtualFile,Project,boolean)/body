{
  VirtualFile baseDir=virtualFile.isDirectory() ? virtualFile : virtualFile.getParent();
  final File projectDir=new File(baseDir.getPath(),".idea");
  final ProjectManagerEx projectManager=ProjectManagerEx.getInstanceEx();
  Project project=null;
  if (projectDir.exists()) {
    try {
      project=projectManager.loadProject(projectDir.getPath());
    }
 catch (    Exception e) {
    }
  }
 else {
    projectDir.mkdirs();
  }
  if (project == null) {
    project=projectManager.newProject(projectDir.getParent(),true,false);
  }
  if (project == null)   return null;
  ProjectBaseDirectory.getInstance(project).setBaseDir(baseDir);
  for (  DirectoryProjectConfigurator configurator : Extensions.getExtensions(DirectoryProjectConfigurator.EP_NAME)) {
    configurator.configureProject(project,baseDir);
  }
  openFileFromCommandLine(project,virtualFile);
  projectManager.openProject(project);
  return project;
}
