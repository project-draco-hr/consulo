{
  Set<VirtualFile> readOnlyFiles=getReadOnlyFiles(refElements);
  if (!readOnlyFiles.isEmpty()) {
    final Project project=refElements[0].getRefManager().getProject();
    final ReadonlyStatusHandler.OperationStatus operationStatus=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(readOnlyFiles.toArray(new VirtualFile[readOnlyFiles.size()]));
    if (operationStatus.hasReadonlyFiles())     return;
  }
  if (refElements.length > 0) {
    final Project project=refElements[0].getRefManager().getProject();
    final boolean[] refreshNeeded=new boolean[1];
    CommandProcessor.getInstance().executeCommand(project,new Runnable(){
      public void run(){
        CommandProcessor.getInstance().markCurrentCommandAsComplex(project);
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            refreshNeeded[0]=applyFix(refElements);
          }
        }
);
      }
    }
,getTemplatePresentation().getText(),null);
    if (refreshNeeded[0]) {
      ((InspectionManagerEx)InspectionManager.getInstance(project)).refreshViews();
    }
  }
}
