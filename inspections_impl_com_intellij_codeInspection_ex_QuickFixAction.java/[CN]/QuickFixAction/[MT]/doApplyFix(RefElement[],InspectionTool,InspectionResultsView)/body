{
  final RefManagerImpl refManager=((RefManagerImpl)tool.getContext().getRefManager());
  final boolean initial=refManager.isInProcess();
  refManager.inspectionReadActionFinished();
  try {
    final boolean[] refreshNeeded=new boolean[]{false};
    if (refElements.length > 0) {
      final Project project=refElements[0].getRefManager().getProject();
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        public void run(){
          CommandProcessor.getInstance().markCurrentCommandAsComplex(project);
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            public void run(){
              refreshNeeded[0]=applyFix(refElements);
            }
          }
);
        }
      }
,getTemplatePresentation().getText(),null);
    }
    if (refreshNeeded[0]) {
      refreshViews(view.getProject(),refElements,myTool);
    }
  }
  finally {
    if (initial)     refManager.inspectionReadActionStarted();
  }
}
