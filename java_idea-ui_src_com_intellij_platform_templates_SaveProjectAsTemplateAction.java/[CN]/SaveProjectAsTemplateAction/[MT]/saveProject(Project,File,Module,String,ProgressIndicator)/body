{
  indicator.setText("Saving project...");
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          project.save();
        }
      }
);
    }
  }
);
  indicator.setText("Processing project files...");
  ZipOutputStream stream=null;
  try {
    FileUtil.ensureExists(zipFile.getParentFile());
    stream=new ZipOutputStream(new FileOutputStream(zipFile));
    final VirtualFile dir=getDirectoryToSave(project,moduleToSave);
    final VirtualFile descriptionFile=getDescriptionFile(project);
    if (descriptionFile == null) {
      stream.putNextEntry(new ZipEntry(dir.getName() + "/" + ArchivedProjectTemplate.DESCRIPTION_PATH));
      stream.write(description.getBytes());
      stream.closeEntry();
    }
 else {
      UIUtil.invokeAndWaitIfNeeded(new Runnable(){
        public void run(){
          try {
            VfsUtil.saveText(descriptionFile,description);
          }
 catch (          IOException e) {
            LOG.error(e);
          }
        }
      }
);
    }
    FileIndex index=moduleToSave == null ? ProjectRootManager.getInstance(project).getFileIndex() : ModuleRootManager.getInstance(moduleToSave).getFileIndex();
    final ZipOutputStream finalStream=stream;
    index.iterateContent(new ContentIterator(){
      @Override public boolean processFile(      VirtualFile file){
        if (!file.isDirectory()) {
          indicator.setText2(file.getName());
          try {
            String relativePath=VfsUtilCore.getRelativePath(file,dir,'/');
            if (relativePath == null) {
              throw new RuntimeException("Can't find relative path for " + file);
            }
            ZipUtil.addFileToZip(finalStream,new File(file.getPath()),dir.getName() + "/" + relativePath,null,null);
          }
 catch (          IOException e) {
            throw new RuntimeException(e);
          }
        }
        indicator.checkCanceled();
        return true;
      }
    }
);
  }
 catch (  Exception ex) {
    LOG.error(ex);
    UIUtil.invokeLaterIfNeeded(new Runnable(){
      public void run(){
        Messages.showErrorDialog(project,"Can't save project as template","Internal Error");
      }
    }
);
  }
 finally {
    StreamUtil.closeStream(stream);
  }
}
