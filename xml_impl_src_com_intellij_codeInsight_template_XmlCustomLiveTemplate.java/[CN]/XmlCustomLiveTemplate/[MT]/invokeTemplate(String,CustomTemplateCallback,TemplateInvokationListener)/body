{
  String templateKey=null;
  String id=null;
  final List<String> classes=new ArrayList<String>();
  StringBuilder builder=new StringBuilder();
  char lastDelim=0;
  key+=MARKER;
  for (int i=0, n=key.length(); i < n; i++) {
    char c=key.charAt(i);
    if (c == '#' || c == '.' || i == n - 1) {
switch (lastDelim) {
case 0:
        templateKey=builder.toString();
      break;
case '#':
    id=builder.toString();
  break;
case '.':
if (builder.length() > 0) {
  classes.add(builder.toString());
}
break;
}
lastDelim=c;
builder=new StringBuilder();
}
 else {
builder.append(c);
}
}
String attributes=buildAttributesString(id,classes);
return startTemplate(templateKey,callback,listener,attributes.length() > 0 ? ' ' + attributes : null);
}
