{
  int startOfTemplate=myCallback.getStartOfTemplate(templateBoundsKey);
  int endOfTemplate=myCallback.getEndOfTemplate(templateBoundsKey);
  Editor editor=myCallback.getEditor();
  int offset=myCallback.getOffset();
  Document document=myCallback.getEditor().getDocument();
  CharSequence text=document.getCharsSequence();
  CharSequence tagName=getPrecedingTagName(text,offset,startOfTemplate);
  if (tagName != null) {
    if (!hasClosingTag(text,tagName,offset,endOfTemplate)) {
      document.insertString(offset,"</" + tagName + '>');
    }
  }
 else   if (offset != endOfTemplate) {
    tagName=getPrecedingTagName(text,endOfTemplate,startOfTemplate);
    if (tagName != null) {
      fixEndOffset();
      document.insertString(endOfTemplate,"</" + tagName + '>');
      editor.getCaretModel().moveToOffset(endOfTemplate);
    }
  }
}
