{
  Map<Integer,DisplayedFoldingAnchor> result=new HashMap<Integer,DisplayedFoldingAnchor>();
  FoldRegion[] visibleFoldRegions=myEditor.getFoldingModel().fetchVisible();
  for (  FoldRegion region : visibleFoldRegions) {
    if (!region.isValid())     continue;
    final int startOffset=region.getStartOffset();
    if (startOffset > lastVisibleOffset)     continue;
    final int endOffset=getEndOffset(region);
    if (endOffset < firstVisibleOffset)     continue;
    if (!isFoldingPossible(startOffset,endOffset))     continue;
    final FoldingGroup group=region.getGroup();
    if (group != null && myEditor.getFoldingModel().getFirstRegion(group,region) != region)     continue;
    int foldStart=myEditor.offsetToVisualLine(startOffset);
    if (!region.isExpanded()) {
      tryAdding(result,region,foldStart,0,DisplayedFoldingAnchor.Type.COLLAPSED,activeFoldRegion);
    }
 else {
      int foldEnd=myEditor.offsetToVisualLine(endOffset);
      tryAdding(result,region,foldStart,foldEnd - foldStart,DisplayedFoldingAnchor.Type.EXPANDED_TOP,activeFoldRegion);
      tryAdding(result,region,foldEnd,foldEnd - foldStart,DisplayedFoldingAnchor.Type.EXPANDED_BOTTOM,activeFoldRegion);
    }
  }
  return result.values();
}
