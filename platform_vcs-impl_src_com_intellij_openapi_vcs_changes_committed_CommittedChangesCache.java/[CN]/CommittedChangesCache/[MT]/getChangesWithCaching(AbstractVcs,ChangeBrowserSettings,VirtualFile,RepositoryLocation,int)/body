{
  ChangesCacheFile cacheFile=myCachesHolder.getCacheFile(vcs,root,location);
  if (cacheFile.isEmpty()) {
    List<CommittedChangeList> changes=initCache(cacheFile);
    if (canGetFromCache(vcs,settings,root,location,maxCount)) {
      settings.filterChanges(changes);
      return trimToSize(changes,maxCount);
    }
    return cacheFile.getProvider().getCommittedChanges(settings,location,maxCount);
  }
 else {
    final RepositoryLocation fileLocation=cacheFile.getLocation();
    fileLocation.onBeforeBatch();
    final List<CommittedChangeList> changes=cacheFile.readChanges(settings,maxCount);
    fileLocation.onAfterBatch();
    List<CommittedChangeList> newChanges=refreshCache(cacheFile);
    settings.filterChanges(newChanges);
    changes.addAll(newChanges);
    return trimToSize(changes,maxCount);
  }
}
