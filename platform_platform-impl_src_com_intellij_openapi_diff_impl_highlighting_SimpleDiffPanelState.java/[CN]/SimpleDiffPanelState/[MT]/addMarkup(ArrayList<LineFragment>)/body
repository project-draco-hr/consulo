{
  resetMarkup();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      for (Iterator<LineFragment> iterator=lines.iterator(); iterator.hasNext(); ) {
        LineFragment line=iterator.next();
        final FragmentHighlighterImpl fragmentHighlighter=new FragmentHighlighterImpl(myAppender1,myAppender2,!iterator.hasNext());
        line.highlight(fragmentHighlighter);
      }
    }
  }
);
  ArrayList<LineFragment> allLineFragments=new ArrayList<LineFragment>();
  for (Iterator<LineFragment> iterator=lines.iterator(); iterator.hasNext(); ) {
    LineFragment lineFragment=iterator.next();
    allLineFragments.add(lineFragment);
    lineFragment.addAllDescendantsTo(allLineFragments);
  }
  myFragmentList=FragmentListImpl.fromList(allLineFragments);
  return LineBlocks.fromLineFragments(allLineFragments);
}
