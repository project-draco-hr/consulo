{
synchronized (lock) {
    if (page.isDirty()) {
      final long curFinalizationId=++finalizationId;
      page.setFinalizationId(curFinalizationId);
      myFinalizationQueue.put(keyForPage(page),page);
      myFinalizer.submit(new Runnable(){
        public void run(){
          if (page.flushIfFinalizationIdIsEqualTo(curFinalizationId)) {
synchronized (lock) {
              myFinalizationQueue.remove(keyForPage(page));
              page.recycleIfFinalizationIdIsEqualTo(curFinalizationId);
            }
          }
synchronized (finalizationLock) {
            lastFinalizationPerformed=curFinalizationId;
            finalizationLock.notifyAll();
          }
        }
      }
);
    }
 else {
      page.recycle();
    }
  }
}
