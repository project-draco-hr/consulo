{
  int offset=editor.getCaretModel().getOffset();
  int startOffset=offset;
  if (selection && editor.getSelectionModel().hasSelection()) {
    final int selStart=editor.getSelectionModel().getSelectionStart();
    final int selEnd=editor.getSelectionModel().getSelectionEnd();
    startOffset=(offset == selStart) ? selEnd : selStart;
  }
  Set<TemplateImpl> array=new LinkedHashSet<TemplateImpl>();
  for (  TemplateImpl template : TemplateSettings.getInstance().getTemplates()) {
    if (!template.isDeactivated() && template.isSelectionTemplate() == selection && (TemplateManagerImpl.isApplicable(file,offset,template) || (selection && TemplateManagerImpl.isApplicable(file,startOffset,template)))) {
      array.add(template);
    }
  }
  final ArrayList<TemplateImpl> list=new ArrayList<TemplateImpl>(array);
  Collections.sort(list,new Comparator<TemplateImpl>(){
    public int compare(    TemplateImpl o1,    TemplateImpl o2){
      return o1.getKey().compareTo(o2.getKey());
    }
  }
);
  return list;
}
