{
  if (myOriginalFile instanceof PsiJavaFile)   return ((PsiJavaFile)myOriginalFile).getLanguageLevel();
  final LanguageLevel forcedLanguageLevel=getUserData(PsiUtil.FILE_LANGUAGE_LEVEL_KEY);
  if (forcedLanguageLevel != null)   return forcedLanguageLevel;
  VirtualFile virtualFile=getVirtualFile();
  if (virtualFile == null) {
    virtualFile=getUserData(FileBasedIndex.VIRTUAL_FILE);
  }
  if (virtualFile == null) {
    final PsiFile originalFile=getOriginalFile();
    if (originalFile instanceof PsiJavaFile && originalFile != this)     return ((PsiJavaFile)originalFile).getLanguageLevel();
    return LanguageLevelProjectExtension.getInstance(getProject()).getLanguageLevel();
  }
  final VirtualFile folder=virtualFile.getParent();
  if (folder != null) {
    final LanguageLevel level=folder.getUserData(LanguageLevel.KEY);
    if (level != null)     return level;
  }
  final Project project=getProject();
  final ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
  final VirtualFile sourceRoot=index.getSourceRootForFile(virtualFile);
  if (sourceRoot != null) {
    String relativePath=VfsUtil.getRelativePath(folder,sourceRoot,'/');
    LOG.assertTrue(relativePath != null);
    List<OrderEntry> orderEntries=index.getOrderEntriesForFile(virtualFile);
    if (orderEntries.isEmpty()) {
      LOG.error("Inconsistent: " + DirectoryIndex.getInstance(project).getInfoForDirectory(folder).toString());
    }
    final VirtualFile[] files=orderEntries.get(0).getFiles(OrderRootType.CLASSES);
    for (    VirtualFile rootFile : files) {
      final VirtualFile classFile=rootFile.findFileByRelativePath(relativePath);
      if (classFile != null) {
        return getLanguageLevel(classFile);
      }
    }
  }
  return LanguageLevelProjectExtension.getInstance(project).getLanguageLevel();
}
