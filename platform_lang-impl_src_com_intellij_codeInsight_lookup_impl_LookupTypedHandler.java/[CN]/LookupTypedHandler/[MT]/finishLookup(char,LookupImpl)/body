{
  final Editor editor=lookup.getEditor();
  FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_FINISH_BY_DOT_ETC);
  CompletionProcess process=CompletionService.getCompletionService().getCurrentCompletion();
  SelectionModel sm=editor.getSelectionModel();
  final boolean smartUndo=!sm.hasSelection() && !sm.hasBlockSelection() && process != null && process.isAutopopupCompletion();
  final ScrollingModelEx scrollingModel=(ScrollingModelEx)editor.getScrollingModel();
  scrollingModel.accumulateViewportChanges();
  try {
    final LinkedList<EditorChangeAction> events=smartUndo ? justTypeChar(charTyped,lookup,editor) : null;
    if (lookup.isLookupDisposed()) {
      return;
    }
    CommandProcessor.getInstance().executeCommand(editor.getProject(),new Runnable(){
      @Override public void run(){
        if (smartUndo && !undoEvents(lookup,events)) {
          return;
        }
        lookup.finishLookup(charTyped);
      }
    }
,null,"Undo inserting the completion char and select the item");
  }
  finally {
    scrollingModel.flushViewportChanges();
  }
}
