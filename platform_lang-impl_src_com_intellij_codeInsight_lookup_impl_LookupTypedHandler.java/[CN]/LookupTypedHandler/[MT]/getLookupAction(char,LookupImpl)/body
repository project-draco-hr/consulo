{
  final CharFilter.Result filtersDecision=getFiltersDecision(charTyped,lookup);
  if (!Registry.is("ide.completion.allow.finishing.by.chars") && filtersDecision == CharFilter.Result.SELECT_ITEM_AND_FINISH_LOOKUP) {
    return CharFilter.Result.HIDE_LOOKUP;
  }
  final LookupElement currentItem=lookup.getCurrentItem();
  if (currentItem != null && charTyped != ' ') {
    String postfix=lookup.getAdditionalPrefix() + charTyped;
    final PrefixMatcher matcher=lookup.itemMatcher(currentItem);
    for (    String lookupString : currentItem.getAllLookupStrings()) {
      if (lookupString.startsWith(matcher.getPrefix() + postfix)) {
        return CharFilter.Result.ADD_TO_PREFIX;
      }
    }
  }
  if (filtersDecision != null) {
    return filtersDecision;
  }
  throw new AssertionError("Typed char not handler by char filter: c=" + charTyped + "; prefix="+ currentItem+ "; filters="+ Arrays.toString(getFilters()));
}
