{
  final CharFilter.Result filtersDecision=getFiltersDecision(charTyped,lookup);
  final LookupElement currentItem=lookup.getCurrentItem();
  if (currentItem != null && charTyped != ' ') {
    if (charTyped != '*' || filtersDecision != CharFilter.Result.SELECT_ITEM_AND_FINISH_LOOKUP) {
      if (charTyped == '*') {
        return CharFilter.Result.ADD_TO_PREFIX;
      }
      String postfix=lookup.getAdditionalPrefix() + charTyped;
      final PrefixMatcher matcher=lookup.itemMatcher(currentItem);
      for (      String lookupString : currentItem.getAllLookupStrings()) {
        if (lookupString.startsWith(matcher.getPrefix() + postfix)) {
          return CharFilter.Result.ADD_TO_PREFIX;
        }
      }
    }
  }
  if (filtersDecision != null)   return filtersDecision;
  throw new AssertionError("Typed char not handler by char filter: c=" + charTyped + "; prefix="+ currentItem+ "; filters="+ Arrays.toString(getFilters()));
}
