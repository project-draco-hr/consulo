{
  final CharFilter.Result filtersDecision=getFiltersDecision(charTyped,lookup);
  final LookupElement currentItem=lookup.getCurrentItem();
  if (currentItem != null && charTyped != ' ') {
    if (charTyped != '*' || filtersDecision != CharFilter.Result.SELECT_ITEM_AND_FINISH_LOOKUP) {
      String postfix=lookup.getAdditionalPrefix() + charTyped;
      final PrefixMatcher matcher=lookup.itemMatcher(currentItem);
      if (matcher.cloneWithPrefix(matcher.getPrefix() + postfix).prefixMatches(currentItem)) {
        return CharFilter.Result.ADD_TO_PREFIX;
      }
      for (      final LookupElement element : lookup.getItems()) {
        PrefixMatcher elementMatcher=lookup.itemMatcher(element);
        if (elementMatcher.cloneWithPrefix(elementMatcher.getPrefix() + postfix).prefixMatches(element)) {
          return CharFilter.Result.ADD_TO_PREFIX;
        }
      }
    }
  }
  if (filtersDecision != null)   return filtersDecision;
  throw new AssertionError("Typed char not handler by char filter: c=" + charTyped + "; prefix="+ currentItem+ "; filters="+ Arrays.toString(getFilters()));
}
