def abort(repo, originalwd, target, state):
    'Restore the repository to its original state'
    if (set(repo.changelog.descendants(target)) - set(state.values())):
        repo.ui.warn(_('warning: new changesets detected on target branch, not stripping\n'))
    else:
        merge.update(repo, repo[originalwd].rev(), False, True, False)
        rebased = filter((lambda x: (x > (-1))), state.values())
        if rebased:
            strippoint = min(rebased)
            repair.strip(repo.ui, repo, repo[strippoint].node(), 'strip')
        clearstatus(repo)
        repo.ui.status(_('rebase aborted\n'))
