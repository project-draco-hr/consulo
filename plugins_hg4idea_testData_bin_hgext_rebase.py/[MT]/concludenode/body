def concludenode(repo, rev, p1, p2, commitmsg=None, extrafn=None):
    'Commit the changes and store useful information in extra'
    try:
        repo.dirstate.setparents(repo[p1].node(), repo[p2].node())
        if (commitmsg is None):
            commitmsg = repo[rev].description()
        ctx = repo[rev]
        extra = {'rebase_source': ctx.hex(), }
        if extrafn:
            extrafn(ctx, extra)
        newrev = repo.commit(text=commitmsg, user=ctx.user(), date=ctx.date(), extra=extra)
        repo.dirstate.setbranch(repo[newrev].branch())
        return newrev
    except util.Abort:
        repo.dirstate.invalidate()
        raise
