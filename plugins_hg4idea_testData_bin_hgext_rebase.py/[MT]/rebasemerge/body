def rebasemerge(repo, rev, first=False):
    'return the correct ancestor'
    oldancestor = ancestor.ancestor

    def newancestor(a, b, pfunc):
        if (b == rev):
            return repo[rev].parents()[0].rev()
        return oldancestor(a, b, pfunc)
    if (not first):
        ancestor.ancestor = newancestor
    else:
        repo.ui.debug('first revision, do not change ancestor\n')
    try:
        stats = merge.update(repo, rev, True, True, False)
        return stats
    finally:
        ancestor.ancestor = oldancestor
