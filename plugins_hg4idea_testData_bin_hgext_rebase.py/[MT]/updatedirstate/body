def updatedirstate(repo, rev, p1, p2):
    'Keep track of renamed files in the revision that is going to be rebased\n    '
    (cop, diver) = copies.copies(repo, repo[rev], repo[p1], repo[p2], True)
    m1 = repo[rev].manifest()
    m2 = repo[p1].manifest()
    for (k, v) in cop.iteritems():
        if (k in m1):
            if ((v in m1) or (v in m2)):
                repo.dirstate.copy(v, k)
                if ((v in m2) and (v not in m1)):
                    repo.dirstate.remove(v)
