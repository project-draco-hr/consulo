{
  final Qualifier qualifier=ref.getQualifier();
  if (qualifier == null || qualifier instanceof GrSuperReferenceExpression || cannotShortenInContext(ref)) {
    return false;
  }
  if (ref instanceof GrReferenceExpression) {
    final GrTypeArgumentList typeArgs=((GrReferenceExpression)ref).getTypeArgumentList();
    if (typeArgs != null && typeArgs.getTypeArgumentElements().length > 0) {
      return false;
    }
  }
  if (!shorteningIsMeaningfully(ref))   return false;
  final PsiElement resolved=resolveRef(ref,uncomplete);
  if (resolved == null)   return false;
  if (!CodeStyleSettingsManager.getSettings(ref.getProject()).INSERT_INNER_CLASS_IMPORTS && resolved instanceof PsiClass && ((PsiClass)resolved).getContainingClass() != null) {
    return false;
  }
  final GrQualifiedReference<Qualifier> copy=getCopy(ref);
  copy.setQualifier(null);
  if (!copy.isReferenceTo(resolved)) {
    if (resolved instanceof PsiClass) {
      final GroovyFileBase file=(GroovyFileBase)ref.getContainingFile();
      final PsiClass clazz=(PsiClass)resolved;
      final String qName=clazz.getQualifiedName();
      if (qName != null) {
        if (addImports && mayInsertImport(ref)) {
          final GrImportStatement added=file.addImportForClass(clazz);
          if (!copy.isReferenceTo(resolved)) {
            file.removeImport(added);
            return false;
          }
        }
      }
    }
 else {
      return false;
    }
  }
  ref.setQualifier(null);
  return true;
}
