{
  final Project project=directory.getProject();
  final Module module=getModule(directory);
  if (module != null) {
    if (ModuleType.get(module) == PluginModuleType.getInstance()) {
      addPluginModule(module);
    }
 else {
      final List<Module> candidateModules=PluginModuleType.getCandidateModules(module);
      final Iterator<Module> it=candidateModules.iterator();
      while (it.hasNext()) {
        Module m=it.next();
        if (PluginModuleType.getPluginXml(m) == null)         it.remove();
      }
      if (candidateModules.size() == 1) {
        addPluginModule(candidateModules.get(0));
      }
 else {
        final ChooseModulesDialog dialog=new ChooseModulesDialog(project,candidateModules,getTemplatePresentation().getDescription());
        dialog.show();
        if (!dialog.isOK()) {
          return CANCELED;
        }
 else {
          final List<Module> modules=dialog.getSelectedModules();
          for (          Module m : modules) {
            addPluginModule(m);
          }
        }
      }
    }
  }
  if (myFilesToPatch.size() == 0) {
    throw new IncorrectOperationException(DevKitBundle.message("error.no.plugin.xml"));
  }
  if (myFilesToPatch.size() == 0) {
    return CANCELED;
  }
  final PsiClass klass=JavaDirectoryService.getInstance().createClass(directory,newName,getClassTemplateName());
  DescriptorUtil.patchPluginXml(this,klass,myFilesToPatch.toArray(new XmlFile[myFilesToPatch.size()]));
  return new PsiElement[]{klass};
}
