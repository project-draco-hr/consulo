{
  final PsiClass klass=directory.createClass(newName,getClassTemplateName());
  final XmlFile pluginXml=getPluginXml(getModule(directory));
  final ReadonlyStatusHandler readonlyStatusHandler=ReadonlyStatusHandler.getInstance(directory.getProject());
  final ReadonlyStatusHandler.OperationStatus status=readonlyStatusHandler.ensureFilesWritable(new VirtualFile[]{pluginXml.getVirtualFile()});
  if (status.hasReadonlyFiles()) {
    throw new IncorrectOperationException("The plugin.xml file is read-only");
  }
  patchPluginXml(pluginXml,klass);
  return new PsiElement[]{klass};
}
