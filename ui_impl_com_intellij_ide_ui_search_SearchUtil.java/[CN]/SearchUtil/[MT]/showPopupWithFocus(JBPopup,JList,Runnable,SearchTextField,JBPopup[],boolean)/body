{
  if (popup != null) {
    popup.cancel();
  }
  final JBPopup popupWithFocus=JBPopupFactory.getInstance().createListPopupBuilder(list).setItemChoosenCallback(onChosen).setRequestFocus(true).createPopup();
  if (down) {
    if (list.getSelectedIndex() < list.getModel().getSize() - 1) {
      list.setSelectedIndex(list.getSelectedIndex() + 1);
    }
  }
 else {
    if (list.getSelectedIndex() > 0) {
      list.setSelectedIndex(list.getSelectedIndex() - 1);
    }
  }
  list.addKeyListener(new KeyListener(){
    public void keyTyped(    KeyEvent e){
      if (e.getKeyCode() != KeyEvent.VK_UP || e.getKeyCode() != KeyEvent.VK_DOWN || e.getKeyCode() != KeyEvent.VK_PAGE_UP || e.getKeyCode() != KeyEvent.VK_PAGE_DOWN) {
        if (popupWithFocus != null) {
          popupWithFocus.cancel();
        }
        searchField.processKeyEvent(e);
      }
    }
    public void keyPressed(    KeyEvent e){
    }
    public void keyReleased(    KeyEvent e){
    }
  }
);
  popupWithFocus.showUnderneathOf(searchField);
  activePopup[0]=popupWithFocus;
}
