{
  final List<PsiElement> result=new ArrayList<PsiElement>();
  final int currentOffset=commonParent.getTextRange().getStartOffset();
  final Condition<PsiElement>[] filters=Extensions.getExtensions(EP_NAME);
  final PsiElementVisitor visitor=new PsiRecursiveElementVisitor(){
    int offset=currentOffset;
    @Override public void visitElement(    PsiElement element){
      for (      Condition<PsiElement> filter : filters) {
        if (!filter.value(element))         return;
      }
      PsiElement child=element.getFirstChild();
      if (child != null) {
        ProgressManager.getInstance().checkCanceled();
        while (child != null) {
          if (offset > endOffset)           break;
          int start=offset;
          child.accept(this);
          if (startOffset <= start && offset <= endOffset)           result.add(child);
          child=child.getNextSibling();
        }
      }
 else {
        offset+=element.getTextLength();
      }
    }
  }
;
  commonParent.accept(visitor);
  return result;
}
