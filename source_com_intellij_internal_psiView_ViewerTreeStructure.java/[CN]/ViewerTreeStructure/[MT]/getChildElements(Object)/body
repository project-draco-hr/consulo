{
  if (myRootElement == element) {
    if (myRootPsiElement == null) {
      return ArrayUtil.EMPTY_OBJECT_ARRAY;
    }
    return myRootPsiElement instanceof PsiFile ? ((PsiFile)myRootPsiElement).getPsiRoots() : new Object[]{myRootPsiElement};
  }
  final Object[][] children=new Object[1][];
  children[0]=ArrayUtil.EMPTY_OBJECT_ARRAY;
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      final Object[] result;
      if (myShowTreeNodes) {
        final ArrayList<Object> list=new ArrayList<Object>();
        final ASTNode root=element instanceof PsiElement ? SourceTreeToPsiMap.psiElementToTree((PsiElement)element) : element instanceof ASTNode ? (ASTNode)element : null;
        if (root instanceof CompositeElement) {
          ChameleonTransforming.transformChildren(root);
          ASTNode child=root.getFirstChildNode();
          while (child != null) {
            if (myShowWhiteSpaces || child.getElementType() != TokenType.WHITE_SPACE) {
              final PsiElement childElement=child.getPsi();
              list.add(childElement == null ? child : childElement);
            }
            child=child.getTreeNext();
          }
        }
        result=ArrayUtil.toObjectArray(list);
      }
 else {
        final PsiElement[] elementChildren=((PsiElement)element).getChildren();
        if (!myShowWhiteSpaces) {
          final List<PsiElement> childrenList=new ArrayList<PsiElement>(elementChildren.length);
          for (          PsiElement psiElement : elementChildren) {
            if (!myShowWhiteSpaces && psiElement instanceof PsiWhiteSpace) {
              continue;
            }
            childrenList.add(psiElement);
          }
          result=childrenList.toArray(new PsiElement[childrenList.size()]);
        }
 else {
          result=elementChildren;
        }
      }
      children[0]=result;
    }
  }
);
  return children[0];
}
