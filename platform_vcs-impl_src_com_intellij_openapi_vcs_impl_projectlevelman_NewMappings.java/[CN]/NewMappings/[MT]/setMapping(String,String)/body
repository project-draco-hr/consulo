{
  LOG.debug("setMapping path = '" + path + "' vcs = "+ activeVcsName);
  final VcsDirectoryMapping newMapping=new VcsDirectoryMapping(path,activeVcsName);
synchronized (myLock) {
    if (myVcsToPaths.containsKey(activeVcsName)) {
      final List<VcsDirectoryMapping> vcsDirectoryMappings=myVcsToPaths.get(activeVcsName);
      if ((vcsDirectoryMappings != null) && (vcsDirectoryMappings.contains(newMapping))) {
        return;
      }
    }
  }
  final Ref<Boolean> switched=new Ref<Boolean>(Boolean.FALSE);
  keepActiveVcs(new Runnable(){
    public void run(){
      switched.set(trySwitchVcs(path,activeVcsName));
      if (!switched.get().booleanValue()) {
        final List<VcsDirectoryMapping> newList=listForVcsFromMap(newMapping.getVcs());
        newList.add(newMapping);
        sortedMappingsByMap();
      }
    }
  }
);
  mappingsChanged();
}
