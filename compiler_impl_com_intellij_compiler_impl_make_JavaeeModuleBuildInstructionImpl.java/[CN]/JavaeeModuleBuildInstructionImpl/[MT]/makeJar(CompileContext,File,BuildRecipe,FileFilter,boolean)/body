{
  final BuildRecipe buildRecipe=getChildInstructions(context);
  final Manifest manifest=DeploymentUtil.getInstance().createManifest(buildRecipe);
  if (manifest == null) {
    File file=DeploymentUtil.getInstance().findUserSuppliedManifestFile(buildRecipe);
    LOG.assertTrue(file != null);
    context.addMessage(CompilerMessageCategory.WARNING,CompilerBundle.message("message.text.using.user.supplied.manifest",file.getAbsolutePath()),null,-1,-1);
  }
  FileUtil.createParentDirs(jarFile);
  final BufferedOutputStream out=new BufferedOutputStream(new FileOutputStream(jarFile));
  final JarOutputStream jarOutputStream=manifest == null ? new JarOutputStream(out) : new JarOutputStream(out,manifest);
  final Set<String> tempWrittenRelativePaths=new THashSet<String>();
  if (manifest != null) {
    tempWrittenRelativePaths.add(JarFile.MANIFEST_NAME);
  }
  try {
    buildRecipe.visitInstructionsWithExceptions(new BuildInstructionVisitor(){
      public boolean visitInstruction(      BuildInstruction instruction) throws IOException {
        if (processExternalDependencies || !instruction.isExternalDependencyInstruction()) {
          instruction.addFilesToJar(context,jarFile,jarOutputStream,dependencies,tempWrittenRelativePaths,fileFilter);
        }
        return true;
      }
    }
,false);
  }
 catch (  IOException e) {
    throw e;
  }
catch (  RuntimeException e) {
    throw e;
  }
catch (  Exception e) {
  }
 finally {
    jarOutputStream.close();
  }
}
