{
  enableSilentOperation(VcsConfiguration.StandardConfirmation.ADD);
  final VirtualFile child=createDirInCommand(myWorkingCopyDir,"child");
  createFileInCommand(child,"a.txt","a");
  checkin();
  disableSilentOperation(VcsConfiguration.StandardConfirmation.ADD);
  final VirtualFile unversioned=createFileInCommand(child,"u.txt","u");
  final ChangeListManager changeListManager=ChangeListManager.getInstance(myProject);
  changeListManager.ensureUpToDate(false);
  Assert.assertEquals(FileStatus.UNKNOWN,changeListManager.getStatus(unversioned));
  renameFileInCommand(child,"newchild");
  File childPath=new File(myWorkingCopyDir.getPath(),"child");
  File newChildPath=new File(myWorkingCopyDir.getPath(),"newchild");
  Assert.assertTrue(new File(newChildPath,"a.txt").exists());
  Assert.assertTrue(new File(newChildPath,"u.txt").exists());
  Assert.assertFalse(new File(childPath,"u.txt").exists());
  LocalFileSystem.getInstance().refresh(false);
  changeListManager.ensureUpToDate(false);
  final List<Change> changes=new ArrayList<Change>(changeListManager.getDefaultChangeList().getChanges());
  Assert.assertEquals(2,changes.size());
  SvnVcs.getInstance(myProject).getRollbackEnvironment().rollbackChanges(changes);
  Assert.assertTrue(new File(childPath,"a.txt").exists());
  Assert.assertTrue(new File(childPath,"u.txt").exists());
}
