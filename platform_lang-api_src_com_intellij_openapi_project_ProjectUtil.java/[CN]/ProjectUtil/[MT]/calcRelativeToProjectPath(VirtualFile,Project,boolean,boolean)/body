{
  if (file instanceof VirtualFilePathWrapper) {
    return includeFilePath ? ((VirtualFilePathWrapper)file).getPresentablePath() : file.getName();
  }
  String url=includeFilePath ? file.getPresentableUrl() : file.getName();
  if (project == null) {
    return url;
  }
 else {
    final VirtualFile baseDir=project.getBaseDir();
    if (baseDir != null && includeFilePath) {
      final String projectHomeUrl=baseDir.getPresentableUrl();
      if (url.startsWith(projectHomeUrl)) {
        url="..." + url.substring(projectHomeUrl.length());
      }
    }
    if (SystemInfo.isMac && file.getFileSystem() instanceof JarFileSystem) {
      final VirtualFile fileForJar=((JarFileSystem)file.getFileSystem()).getVirtualFileForJar(file);
      if (fileForJar != null) {
        final OrderEntry libraryEntry=LibraryUtil.findLibraryEntry(file,project);
        if (libraryEntry != null) {
          if (libraryEntry instanceof JdkOrderEntry) {
            url=new StringBuilder(url).append(" - [").append(((JdkOrderEntry)libraryEntry).getJdkName()).append("]").toString();
          }
 else {
            url=new StringBuilder(url).append(" - [").append(libraryEntry.getPresentableName()).append("]").toString();
          }
        }
 else {
          url=new StringBuilder(url).append(" - [").append(fileForJar.getName()).append("]").toString();
        }
      }
    }
    final Module module=ModuleUtil.findModuleForFile(file,project);
    if (module == null)     return url;
    return !keepModuleAlwaysOnTheLeft && SystemInfo.isMac ? new StringBuffer().append(url).append(" - [").append(module.getName()).append("]").toString() : new StringBuffer().append("[").append(module.getName()).append("] - ").append(url).toString();
  }
}
