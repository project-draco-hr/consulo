{
  setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);
  addWindowListener(new WindowAdapter(){
    public void windowClosing(    final WindowEvent e){
      final Application app=ApplicationManager.getApplication();
      app.invokeLater(new DumbAwareRunnable(){
        public void run(){
          if (app.isDisposed()) {
            ApplicationManagerEx.getApplicationEx().exit();
            return;
          }
          final Project[] openProjects=ProjectManager.getInstance().getOpenProjects();
          if (openProjects.length > 1 || (openProjects.length == 1 && SystemInfo.isMacSystemMenu)) {
            if (myProject != null && myProject.isOpen()) {
              ProjectUtil.closeAndDispose(myProject);
            }
            app.getMessageBus().syncPublisher(AppLifecycleListener.TOPIC).projectFrameClosed();
          }
 else {
            ApplicationManagerEx.getApplicationEx().exit();
          }
        }
      }
,ModalityState.NON_MODAL);
    }
  }
);
}
