{
  LOG.assertTrue(isPopupActive());
  if (e.getID() == WindowEvent.WINDOW_LOST_FOCUS) {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        if (!isPopupActive())         return;
        Window focused=((WindowEvent)e).getOppositeWindow();
        if (focused == null) {
          focused=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
        }
        if (focused == null) {
          closeAllPopups();
        }
      }
    }
);
  }
  if (e instanceof KeyEvent || e instanceof MouseEvent) {
    for (int i=myDispatchStack.size() - 1; (i >= 0 && i < myDispatchStack.size()); i--) {
      final boolean dispatched=myDispatchStack.get(i).dispatch(e);
      if (dispatched)       return true;
    }
  }
  return false;
}
