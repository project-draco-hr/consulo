{
  if (variable instanceof ImplicitVariable)   return null;
  if (!PsiUtil.isAccessedForReading(expression))   return null;
  final int startOffset=expression.getTextRange().getStartOffset();
  final PsiElement topBlock;
  if (variable.hasInitializer()) {
    topBlock=PsiUtil.getVariableCodeBlock(variable,variable);
    if (topBlock == null)     return null;
  }
 else {
    PsiElement scope=variable instanceof PsiField ? variable.getContainingFile() : variable.getParent() != null ? variable.getParent().getParent() : null;
    if (scope instanceof PsiCodeBlock && scope.getParent() instanceof PsiSwitchStatement) {
      scope=PsiTreeUtil.getParentOfType(scope,PsiCodeBlock.class);
    }
    topBlock=JspPsiUtil.isInJspFile(scope) && scope instanceof PsiFile ? scope : PsiUtil.getTopLevelEnclosingCodeBlock(expression,scope);
    if (variable instanceof PsiField) {
      if (!variable.hasModifierProperty(PsiModifier.FINAL))       return null;
      if (PsiUtil.findEnclosingConstructorOrInitializer(expression) == null && HighlightUtil.findEnclosingFieldInitializer(expression) == null) {
        return null;
      }
      if (inInnerClass(expression,((PsiField)variable).getContainingClass()))       return null;
      if (topBlock == null)       return null;
      final PsiElement parent=topBlock.getParent();
      final PsiCodeBlock block;
      final PsiClass aClass;
      if (parent instanceof PsiMethod) {
        PsiMethod constructor=(PsiMethod)parent;
        if (!parent.getManager().areElementsEquivalent(constructor.getContainingClass(),((PsiField)variable).getContainingClass()))         return null;
        if (variable.hasModifierProperty(PsiModifier.STATIC))         return null;
        final List<PsiMethod> redirectedConstructors=getChainedConstructors(constructor);
        for (int j=0; redirectedConstructors != null && j < redirectedConstructors.size(); j++) {
          PsiMethod redirectedConstructor=redirectedConstructors.get(j);
          if (redirectedConstructor.getBody() != null && variableDefinitelyAssignedIn(variable,redirectedConstructor.getBody())) {
            return null;
          }
        }
        block=constructor.getBody();
        aClass=constructor.getContainingClass();
      }
 else       if (parent instanceof PsiClassInitializer) {
        final PsiClassInitializer classInitializer=(PsiClassInitializer)parent;
        if (!parent.getManager().areElementsEquivalent(classInitializer.getContainingClass(),((PsiField)variable).getContainingClass()))         return null;
        block=classInitializer.getBody();
        aClass=classInitializer.getContainingClass();
      }
 else {
        final PsiField field=(PsiField)variable;
        aClass=field.getContainingClass();
        if (aClass == null || isFieldInitializedInOtherFieldInitializer(aClass,field,field.hasModifierProperty(PsiModifier.STATIC))) {
          return null;
        }
        block=null;
        final PsiMethod[] constructors=aClass.getConstructors();
        for (        PsiMethod constructor : constructors) {
          if (startOffset < constructor.getTextRange().getStartOffset())           continue;
          if (constructor.getBody() != null && variableDefinitelyAssignedIn(variable,constructor.getBody())) {
            return null;
          }
          final List<PsiMethod> redirectedConstructors=getChainedConstructors(constructor);
          for (int j=0; redirectedConstructors != null && j < redirectedConstructors.size(); j++) {
            PsiMethod redirectedConstructor=redirectedConstructors.get(j);
            if (startOffset < redirectedConstructor.getTextRange().getStartOffset())             continue;
            if (redirectedConstructor.getBody() != null && variableDefinitelyAssignedIn(variable,redirectedConstructor.getBody())) {
              return null;
            }
          }
        }
      }
      if (aClass != null) {
        final PsiClassInitializer[] initializers=aClass.getInitializers();
        for (        PsiClassInitializer initializer : initializers) {
          PsiCodeBlock body=initializer.getBody();
          if (body == block)           break;
          boolean shouldCheckInitializerOrder=block == null || block.getParent() instanceof PsiClassInitializer;
          if (shouldCheckInitializerOrder && startOffset < initializer.getTextRange().getStartOffset())           continue;
          if (initializer.hasModifierProperty(PsiModifier.STATIC) == variable.hasModifierProperty(PsiModifier.STATIC)) {
            if (variableDefinitelyAssignedIn(variable,body))             return null;
          }
        }
      }
    }
  }
  if (topBlock == null)   return null;
  Collection<PsiReferenceExpression> codeBlockProblems=uninitializedVarProblems.get(topBlock);
  if (codeBlockProblems == null) {
    try {
      final ControlFlow controlFlow=getControlFlow(topBlock);
      codeBlockProblems=ControlFlowUtil.getReadBeforeWriteLocals(controlFlow);
    }
 catch (    AnalysisCanceledException e) {
      codeBlockProblems=Collections.emptyList();
    }
catch (    IndexNotReadyException e) {
      codeBlockProblems=Collections.emptyList();
    }
    uninitializedVarProblems.put(topBlock,codeBlockProblems);
  }
  if (codeBlockProblems.contains(expression)) {
    final String name=expression.getElement().getText();
    String description=JavaErrorMessages.message("variable.not.initialized",name);
    HighlightInfo highlightInfo=HighlightInfo.createHighlightInfo(HighlightInfoType.ERROR,expression,description);
    QuickFixAction.registerQuickFixAction(highlightInfo,new AddVariableInitializerFix(variable));
    return highlightInfo;
  }
  return null;
}
