{
  if (!CodeInsightUtilBase.prepareFileForWrite(file))   return;
  int offset=editor.getCaretModel().getOffset();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiElement element=findElement(file,offset);
  PsiTryStatement tryStatement=(PsiTryStatement)element.getParent();
  List<PsiClassType> unhandledExceptions=new ArrayList<PsiClassType>(ExceptionUtil.collectUnhandledExceptions(element,null));
  ExceptionUtil.sortExceptionsByHierarchy(unhandledExceptions);
  IdeDocumentHistory.getInstance(project).includeCurrentPlaceAsChangePlace();
  PsiCodeBlock catchBlockToSelect=null;
  try {
    if (tryStatement.getFinallyBlock() == null && tryStatement.getCatchBlocks().length == 0) {
      for (      PsiClassType unhandledException : unhandledExceptions) {
        addCatchStatement(tryStatement,unhandledException,file);
      }
      catchBlockToSelect=tryStatement.getCatchBlocks()[0];
    }
 else {
      for (      PsiClassType unhandledException : unhandledExceptions) {
        PsiCodeBlock codeBlock=addCatchStatement(tryStatement,unhandledException,file);
        if (catchBlockToSelect == null)         catchBlockToSelect=codeBlock;
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
  if (catchBlockToSelect != null) {
    TextRange range=SurroundWithUtil.getRangeToSelect(catchBlockToSelect);
    editor.getCaretModel().moveToOffset(range.getStartOffset());
    editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    editor.getSelectionModel().setSelection(range.getStartOffset(),range.getEndOffset());
  }
}
