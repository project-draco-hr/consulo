{
  try {
    boolean restored=false;
    for (Iterator iterator=myDeletedFilesPaths.iterator(); iterator.hasNext(); ) {
      restored|=myDeletedStorage.restore((String)iterator.next());
    }
    myDeletedStorage.purgeDirsWithNoEntries();
    final boolean showWarning=restored;
    if (CvsVcs2.getInstance(myProject).getRemoveConfirmation().getValue() != VcsShowConfirmationOption.Value.DO_NOTHING_SILENTLY) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          if (!myCvsStorageComponent.getIsActive())           return;
          removeFiles();
        }
      }
,ModalityState.NON_MMODAL);
    }
    final int[] myRefreshedParents=new int[]{myDeletedFilesParents.size()};
    for (Iterator iterator=myDeletedFilesParents.iterator(); iterator.hasNext(); ) {
      ((VirtualFile)iterator.next()).refresh(true,true,new Runnable(){
        public void run(){
          myRefreshedParents[0]++;
          if (myRefreshedParents[0] == myDeletedFilesParents.size()) {
            if (showWarning) {
              ApplicationManager.getApplication().invokeLater(new Runnable(){
                public void run(){
                  if (!myCvsStorageComponent.getIsActive())                   return;
                  if (CvsApplicationLevelConfiguration.getInstance().SHOW_RESTORE_DIRECTORIES_CONFIRMATION) {
                    new RestoreDirectoriesConfirmationDialog().show();
                  }
                }
              }
);
            }
          }
        }
      }
);
    }
  }
 catch (  final IOException e) {
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        Messages.showMessageDialog("Cannot restore CVS admin directory: " + e.getLocalizedMessage(),"Restore CVS Admin Directory",Messages.getErrorIcon());
      }
    }
);
  }
}
