{
  final PsiElement element=usage.getElement();
  if (!(element instanceof PsiReferenceExpression))   return false;
  final FieldDescriptor fieldDescriptor=usage.getFieldDescriptor();
  PsiField field=fieldDescriptor.getField();
  boolean processGet=descriptor.isToEncapsulateGet();
  boolean processSet=descriptor.isToEncapsulateSet() && !field.hasModifierProperty(PsiModifier.FINAL);
  if (!processGet && !processSet)   return true;
  PsiElementFactory factory=JavaPsiFacade.getInstance(descriptor.getTargetClass().getProject()).getElementFactory();
  try {
    final PsiReferenceExpression expr=(PsiReferenceExpression)element;
    final PsiElement parent=expr.getParent();
    if (parent instanceof PsiAssignmentExpression && expr.equals(((PsiAssignmentExpression)parent).getLExpression())) {
      PsiAssignmentExpression assignment=(PsiAssignmentExpression)parent;
      if (assignment.getRExpression() == null)       return true;
      PsiJavaToken opSign=assignment.getOperationSign();
      IElementType opType=opSign.getTokenType();
      if (opType == JavaTokenType.EQ) {
{
          if (!processSet)           return true;
          final PsiExpression setterArgument=assignment.getRExpression();
          PsiMethodCallExpression methodCall=createSetterCall(fieldDescriptor,setterArgument,expr,descriptor.getTargetClass(),setter);
          if (methodCall != null) {
            assignment.replace(methodCall);
          }
        }
      }
 else       if (opType == JavaTokenType.ASTERISKEQ || opType == JavaTokenType.DIVEQ || opType == JavaTokenType.PERCEQ || opType == JavaTokenType.PLUSEQ || opType == JavaTokenType.MINUSEQ || opType == JavaTokenType.LTLTEQ || opType == JavaTokenType.GTGTEQ || opType == JavaTokenType.GTGTGTEQ || opType == JavaTokenType.ANDEQ || opType == JavaTokenType.OREQ || opType == JavaTokenType.XOREQ) {
{
          String opName=opSign.getText();
          LOG.assertTrue(StringUtil.endsWithChar(opName,'='));
          opName=opName.substring(0,opName.length() - 1);
          PsiExpression getExpr=expr;
          if (processGet) {
            final PsiMethodCallExpression getterCall=createGetterCall(fieldDescriptor,expr,descriptor.getTargetClass(),getter);
            if (getterCall != null) {
              getExpr=getterCall;
            }
          }
          @NonNls String text="a" + opName + "b";
          PsiBinaryExpression binExpr=(PsiBinaryExpression)factory.createExpressionFromText(text,expr);
          binExpr.getLOperand().replace(getExpr);
          binExpr.getROperand().replace(assignment.getRExpression());
          PsiExpression setExpr;
          if (processSet) {
            setExpr=createSetterCall(fieldDescriptor,binExpr,expr,descriptor.getTargetClass(),setter);
          }
 else {
            text="a = b";
            PsiAssignmentExpression assignment1=(PsiAssignmentExpression)factory.createExpressionFromText(text,null);
            assignment1.getLExpression().replace(expr);
            assignment1.getRExpression().replace(binExpr);
            setExpr=assignment1;
          }
          assignment.replace(setExpr);
        }
      }
    }
 else     if (RefactoringUtil.isPlusPlusOrMinusMinus(parent)) {
      IElementType sign;
      if (parent instanceof PsiPrefixExpression) {
        sign=((PsiPrefixExpression)parent).getOperationTokenType();
      }
 else {
        sign=((PsiPostfixExpression)parent).getOperationTokenType();
      }
      PsiExpression getExpr=expr;
      if (processGet) {
        final PsiMethodCallExpression getterCall=createGetterCall(fieldDescriptor,expr,descriptor.getTargetClass(),getter);
        if (getterCall != null) {
          getExpr=getterCall;
        }
      }
      @NonNls String text;
      if (sign == JavaTokenType.PLUSPLUS) {
        text="a+1";
      }
 else {
        text="a-1";
      }
      PsiBinaryExpression binExpr=(PsiBinaryExpression)factory.createExpressionFromText(text,null);
      binExpr.getLOperand().replace(getExpr);
      PsiExpression setExpr;
      if (processSet) {
        setExpr=createSetterCall(fieldDescriptor,binExpr,expr,descriptor.getTargetClass(),setter);
      }
 else {
        text="a = b";
        PsiAssignmentExpression assignment=(PsiAssignmentExpression)factory.createExpressionFromText(text,null);
        assignment.getLExpression().replace(expr);
        assignment.getRExpression().replace(binExpr);
        setExpr=assignment;
      }
      parent.replace(setExpr);
    }
 else {
      if (!processGet)       return true;
      PsiMethodCallExpression methodCall=createGetterCall(fieldDescriptor,expr,descriptor.getTargetClass(),getter);
      if (methodCall != null) {
        expr.replace(methodCall);
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
  return true;
}
