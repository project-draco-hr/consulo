{
  if (ProjectLevelVcsManager.getInstance(project).getAllActiveVcss().length == 0) {
    return null;
  }
  final ChangeListManager changeListManager=ChangeListManager.getInstance(project);
  VirtualFile[] virtualFiles=e.getData(CommonDataKeys.VIRTUAL_FILE_ARRAY);
  if (virtualFiles != null) {
    List<Change> changesInFiles=new ArrayList<Change>();
    for (    VirtualFile vFile : virtualFiles) {
      Change change=changeListManager.getChange(vFile);
      if (change == null) {
        final FileStatus status=changeListManager.getStatus(vFile);
        if (FileStatus.UNKNOWN.equals(status)) {
          unversionedFiles.add(vFile);
          if (changedFiles != null)           changedFiles.add(vFile);
        }
 else         if (FileStatus.NOT_CHANGED.equals(status) && vFile.isDirectory()) {
          addAllChangesUnderPath(changedFiles,changeListManager,changesInFiles,VcsUtil.getFilePath(vFile));
        }
        continue;
      }
      if (change.getAfterRevision() != null && change.getAfterRevision().getFile() != null && change.getAfterRevision().getFile().isDirectory()) {
        final FilePath file=change.getAfterRevision().getFile();
        addAllChangesUnderPath(changedFiles,changeListManager,changesInFiles,file);
      }
 else {
        changesInFiles.add(change);
        if (changedFiles != null) {
          changedFiles.add(vFile);
        }
      }
    }
    return changesInFiles;
  }
  return Collections.emptyList();
}
