{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      ourProject=ProjectManagerEx.getInstanceEx().newProject("",false,false);
      ourPsiManager=null;
      ourModule=createMainModule();
      ourSourceRoot=DummyFileSystem.getInstance().createRoot("src");
      final ModuleRootManager rootManager=ModuleRootManager.getInstance(ourModule);
      final ModifiableRootModel rootModel=rootManager.getModifiableModel();
      ProjectJdk projectJDK=getProjectJDK();
      if (projectJDK != null) {
        ourJDK=projectJDK;
        rootModel.setJdk(projectJDK);
      }
      final ContentEntry contentEntry=rootModel.addContentEntry(ourSourceRoot);
      contentEntry.addSourceFolder(ourSourceRoot,false);
      rootModel.commit();
      ProjectRootManager.getInstance(ourProject).addModuleRootListener(new ModuleRootListener(){
        public void beforeRootsChange(        ModuleRootEvent event){
          if (!event.isCausedByFileTypesChange()) {
            fail("Root modification in LightIdeaTestCase is not allowed.");
          }
        }
        public void rootsChanged(        ModuleRootEvent event){
        }
      }
);
      ModuleManager.getInstance(ourProject).addModuleListener(new ModuleListener(){
        public void moduleAdded(        Project project,        Module module){
          fail("Adding modules is not permitted in LightIdeaTestCase.");
        }
        public void beforeModuleRemoved(        Project project,        Module module){
        }
        public void moduleRemoved(        Project project,        Module module){
        }
        public void modulesRenamed(        Project project,        List<Module> modules){
        }
      }
);
      ((StartupManagerImpl)StartupManager.getInstance(getProject())).runStartupActivities();
    }
  }
);
}
