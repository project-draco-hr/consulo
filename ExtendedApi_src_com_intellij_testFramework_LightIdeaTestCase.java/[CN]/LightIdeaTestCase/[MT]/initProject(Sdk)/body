{
  final File projectFile=File.createTempFile("temp",".ipr");
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @SuppressWarnings({"AssignmentToStaticFieldFromInstanceMethod"}) public void run(){
      if (ourProject != null) {
        ProjectUtil.closeProject(ourProject);
      }
 else {
        cleanPersistedVFSContent();
      }
      LocalFileSystem.getInstance().refreshAndFindFileByIoFile(projectFile);
      ourProject=ProjectManagerEx.getInstanceEx().newProject(projectFile.getPath(),false,false);
      ourPsiManager=null;
      ourModule=createMainModule();
      ourSourceRoot=DummyFileSystem.getInstance().createRoot("src");
      final ModuleRootManager rootManager=ModuleRootManager.getInstance(ourModule);
      final ModifiableRootModel rootModel=rootManager.getModifiableModel();
      if (projectJDK != null) {
        ourJDK=projectJDK;
        ModuleJdkUtil.setJdk(rootModel,projectJDK);
      }
      final ContentEntry contentEntry=rootModel.addContentEntry(ourSourceRoot);
      contentEntry.addSourceFolder(ourSourceRoot,false);
      rootModel.commit();
      final MessageBusConnection connection=ourProject.getMessageBus().connect();
      connection.subscribe(ProjectTopics.PROJECT_ROOTS,new ModuleRootListener(){
        public void beforeRootsChange(        ModuleRootEvent event){
          if (!event.isCausedByFileTypesChange()) {
            fail("Root modification in LightIdeaTestCase is not allowed.");
          }
        }
        public void rootsChanged(        ModuleRootEvent event){
        }
      }
);
      connection.subscribe(ProjectTopics.MODULES,new ModuleListener(){
        public void moduleAdded(        Project project,        Module module){
          fail("Adding modules is not permitted in LightIdeaTestCase.");
        }
        public void beforeModuleRemoved(        Project project,        Module module){
        }
        public void moduleRemoved(        Project project,        Module module){
        }
        public void modulesRenamed(        Project project,        List<Module> modules){
        }
      }
);
      ((StartupManagerImpl)StartupManager.getInstance(getProject())).runStartupActivities();
    }
  }
);
}
