{
  final Project project=file.getProject();
  final JspContextManager manager=JspContextManager.getInstance(project);
  if (manager != null) {
    final PsiFileSystemItem item=manager.getContextFolder(file);
    if (item != null) {
      return item;
    }
    if (useIncludingFileAsContext()) {
      final JspFile contextFile=manager.getContextFile(file);
      if (contextFile != null) {
        return contextFile.getParent();
      }
    }
  }
  final VirtualFile virtualFile=file.getVirtualFile();
  if (virtualFile != null) {
    final PsiFileSystemItem item=FileReferenceHelperRegistrar.getNotNullHelper(file).getPsiFileSystemItem(project,virtualFile);
    if (item != null) {
      return item.getParent();
    }
  }
  return file.getParent();
}
