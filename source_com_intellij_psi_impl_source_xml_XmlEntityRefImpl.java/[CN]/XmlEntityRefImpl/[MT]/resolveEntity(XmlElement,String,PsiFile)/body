{
  final String entityName=text.substring(1,text.length() - 1);
  if (targetFile instanceof JspFile) {
    targetFile=((JspFile)targetFile).getBaseLanguageRoot();
  }
  final PsiElement targetElement=targetFile != null ? (PsiElement)targetFile : element;
  Map<String,CachedValue<XmlEntityDecl>> map=targetElement.getUserData(XML_ENTITY_DECL_MAP);
  if (map == null) {
    map=new HashMap<String,CachedValue<XmlEntityDecl>>();
    targetElement.putUserData(XML_ENTITY_DECL_MAP,map);
  }
  CachedValue<XmlEntityDecl> value=map.get(entityName);
  if (value == null) {
    final PsiManager manager=element.getManager();
    if (manager == null) {
      return resolveEntity(targetElement,entityName).getValue();
    }
    value=manager.getCachedValuesManager().createCachedValue(new CachedValueProvider<XmlEntityDecl>(){
      public Result<XmlEntityDecl> compute(){
        return resolveEntity(targetElement,entityName);
      }
    }
);
    map.put(entityName,value);
  }
  return value.getValue();
}
