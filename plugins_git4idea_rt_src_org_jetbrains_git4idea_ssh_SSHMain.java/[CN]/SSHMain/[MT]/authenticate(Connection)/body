{
  LinkedList<String> methods=new LinkedList<String>(myHost.getPreferredMethods());
  String lastSuccessfulMethod=myXmlRpcClient.getLastSuccessful(myHandlerNo,getUserHostString());
  if (lastSuccessfulMethod != null && lastSuccessfulMethod.length() > 0 && methods.remove(lastSuccessfulMethod)) {
    methods.addFirst(lastSuccessfulMethod);
  }
  for (  String method : methods) {
    if (c.isAuthenticationComplete()) {
      return;
    }
    if (PUBLIC_KEY_METHOD.equals(method)) {
      if (!myHost.supportsPubkeyAuthentication()) {
        continue;
      }
      if (!c.isAuthMethodAvailable(myHost.getUser(),PUBLIC_KEY_METHOD)) {
        continue;
      }
      File key=myHost.getIdentityFile();
      if (key == null) {
        for (        String a : myHost.getHostKeyAlgorithms()) {
          if (SSH_RSA_ALGORITHM.equals(a)) {
            if (tryPublicKey(c,idRSAPath)) {
              return;
            }
          }
 else           if (SSH_DSS_ALGORITHM.equals(a)) {
            if (tryPublicKey(c,idDSAPath)) {
              return;
            }
          }
        }
      }
 else {
        if (tryPublicKey(c,key.getPath())) {
          return;
        }
      }
    }
 else     if (KEYBOARD_INTERACTIVE_METHOD.equals(method)) {
      if (!c.isAuthMethodAvailable(myHost.getUser(),KEYBOARD_INTERACTIVE_METHOD)) {
        continue;
      }
      InteractiveSupport interactiveSupport=new InteractiveSupport();
      for (int i=myHost.getNumberOfPasswordPrompts(); i > 0; i--) {
        if (c.isAuthenticationComplete()) {
          return;
        }
        if (c.authenticateWithKeyboardInteractive(myHost.getUser(),interactiveSupport)) {
          myLastError="";
          myXmlRpcClient.setLastSuccessful(myHandlerNo,getUserHostString(),KEYBOARD_INTERACTIVE_METHOD,"");
          return;
        }
 else {
          myLastError=SSHMainBundle.getString("sshmain.keyboard.interactive.failed");
        }
        if (interactiveSupport.myPromptCount == 0 || interactiveSupport.myCancelled) {
          myLastError="";
          break;
        }
      }
    }
 else     if (PASSWORD_METHOD.equals(method)) {
      if (!myHost.supportsPasswordAuthentication()) {
        continue;
      }
      if (!c.isAuthMethodAvailable(myHost.getUser(),PASSWORD_METHOD)) {
        continue;
      }
      for (int i=0; i < myHost.getNumberOfPasswordPrompts(); i++) {
        String password=myXmlRpcClient.askPassword(myHandlerNo,getUserHostString(),i != 0,myLastError);
        if (password == null) {
          break;
        }
 else {
          if (c.authenticateWithPassword(myHost.getUser(),password)) {
            myLastError="";
            myXmlRpcClient.setLastSuccessful(myHandlerNo,getUserHostString(),PASSWORD_METHOD,"");
            return;
          }
 else {
            myLastError=SSHMainBundle.getString("sshmain.password.failed");
          }
        }
      }
    }
  }
  myXmlRpcClient.setLastSuccessful(myHandlerNo,getUserHostString(),"",myLastError);
  throw new IOException("Authentication failed: " + myLastError,myErrorCause);
}
