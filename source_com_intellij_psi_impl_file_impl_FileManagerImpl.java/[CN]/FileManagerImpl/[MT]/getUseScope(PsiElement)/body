{
  VirtualFile vFile;
  if (element instanceof PsiDirectory) {
    vFile=((PsiDirectory)element).getVirtualFile();
  }
 else {
    final PsiFile containingFile=element.getContainingFile();
    if (containingFile == null)     return GlobalSearchScope.allScope(myManager.getProject());
    final VirtualFile virtualFile=containingFile.getVirtualFile();
    if (virtualFile == null)     return GlobalSearchScope.allScope(myManager.getProject());
    vFile=virtualFile.getParent();
  }
  if (vFile == null)   return null;
  ProjectFileIndex projectFileIndex=myProjectRootManager.getFileIndex();
  Module module=projectFileIndex.getModuleForFile(vFile);
  if (module != null) {
    boolean isTest=projectFileIndex.isInTestSourceContent(vFile);
    return isTest ? GlobalSearchScope.moduleTestsWithDependentsScope(module) : GlobalSearchScope.moduleWithDependentsScope(module);
  }
 else {
    return GlobalSearchScope.allScope(myManager.getProject());
  }
}
