{
  ConcurrentHashMap<VirtualFile,PsiDirectory> fileToPsiDirMap=new ConcurrentHashMap<VirtualFile,PsiDirectory>((Map<? extends VirtualFile,? extends PsiDirectory>)myVFileToPsiDirMap);
  if (useFind) {
    myVFileToPsiDirMap.clear();
  }
  for (Iterator<VirtualFile> iterator=fileToPsiDirMap.keySet().iterator(); iterator.hasNext(); ) {
    VirtualFile vFile=iterator.next();
    if (!vFile.isValid()) {
      iterator.remove();
    }
 else {
      PsiDirectory psiDir=findDirectory(vFile);
      if (psiDir == null) {
        iterator.remove();
      }
    }
  }
  myVFileToPsiDirMap.clear();
  myVFileToPsiDirMap.putAll(fileToPsiDirMap);
  ConcurrentWeakValueHashMap<VirtualFile,FileViewProvider> fileToPsiFileMap=new ConcurrentWeakValueHashMap<VirtualFile,FileViewProvider>(myVFileToViewProviderMap);
  if (useFind) {
    myVFileToViewProviderMap.clear();
  }
  for (Iterator<VirtualFile> iterator=fileToPsiFileMap.keySet().iterator(); iterator.hasNext(); ) {
    VirtualFile vFile=iterator.next();
    if (!vFile.isValid()) {
      iterator.remove();
      continue;
    }
    if (useFind) {
      FileViewProvider view=fileToPsiFileMap.get(vFile);
      if (view == null) {
        iterator.remove();
        continue;
      }
      PsiFile psiFile1=findFile(vFile);
      if (psiFile1 == null) {
        iterator.remove();
        continue;
      }
      PsiFile psi=view.getPsi(view.getBaseLanguage());
      if (psi == null || !psiFile1.getClass().equals(psi.getClass()) || psiFile1.getViewProvider().getBaseLanguage() != view.getBaseLanguage()) {
        iterator.remove();
      }
    }
  }
  myVFileToViewProviderMap.clear();
  myVFileToViewProviderMap.putAll(fileToPsiFileMap);
}
