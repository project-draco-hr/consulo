{
  HashMap<VirtualFile,PsiDirectory> fileToPsiDirMap=myVFileToPsiDirMap;
  if (useFind) {
    myVFileToPsiDirMap=new HashMap<VirtualFile,PsiDirectory>();
  }
  for (Iterator<VirtualFile> iterator=fileToPsiDirMap.keySet().iterator(); iterator.hasNext(); ) {
    VirtualFile vFile=iterator.next();
    if (!vFile.isValid()) {
      iterator.remove();
    }
 else {
      PsiDirectory psiDir=findDirectory(vFile);
      if (psiDir == null) {
        iterator.remove();
      }
    }
  }
  myVFileToPsiDirMap=fileToPsiDirMap;
  WeakValueHashMap<VirtualFile,FileViewProvider> fileToPsiFileMap=myVFileToPsiFileMap;
  if (useFind) {
    myVFileToPsiFileMap=new WeakValueHashMap<VirtualFile,FileViewProvider>();
  }
  for (Iterator<VirtualFile> iterator=fileToPsiFileMap.keySet().iterator(); iterator.hasNext(); ) {
    VirtualFile vFile=iterator.next();
    if (!vFile.isValid()) {
      iterator.remove();
      continue;
    }
    if (useFind) {
      FileViewProvider view=fileToPsiFileMap.get(vFile);
      if (view == null) {
        iterator.remove();
        continue;
      }
      PsiFile psiFile1=findFile(vFile);
      if (psiFile1 == null) {
        iterator.remove();
        continue;
      }
      if (!psiFile1.getClass().equals(view.getPsi(view.getBaseLanguage()).getClass()))       iterator.remove();
    }
  }
  myVFileToPsiFileMap=fileToPsiFileMap;
}
