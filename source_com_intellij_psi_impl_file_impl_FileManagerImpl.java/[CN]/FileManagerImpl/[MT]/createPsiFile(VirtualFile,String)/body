{
  if (vFile.isDirectory())   return null;
  if (myFileTypeManager.isFileIgnored(name))   return null;
  VirtualFile parent=vFile.getParent();
  if (parent == null)   return null;
  PsiDirectory psiDir=findDirectory(parent);
  if (psiDir == null)   return null;
  FileType fileType=myFileTypeManager.getFileTypeByFileName(name);
  final Project project=myManager.getProject();
  if (fileType instanceof LanguageFileType) {
    final Language language=((LanguageFileType)fileType).getLanguage();
    return language.getParserDefinition().createFile(project,vFile);
  }
  if (fileType instanceof JavaClassFileType) {
    ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
    if (fileIndex.isInLibraryClasses(vFile)) {
      int dotIndex=name.lastIndexOf('.');
      if (dotIndex < 0)       dotIndex=name.length();
      int index=name.lastIndexOf('$',dotIndex);
      if (index >= 0)       return null;
      return new ClsFileImpl((PsiManagerImpl)PsiManager.getInstance(project),vFile);
    }
    return null;
  }
  if (fileType.isBinary()) {
    return new PsiBinaryFileImpl(myManager,vFile);
  }
  return new PsiPlainTextFileImpl(project,vFile);
}
