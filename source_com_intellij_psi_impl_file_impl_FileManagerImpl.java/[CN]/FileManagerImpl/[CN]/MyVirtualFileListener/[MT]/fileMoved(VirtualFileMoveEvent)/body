{
  if (!myUseRepository) {
    clearNonRepositoryMaps();
  }
  final VirtualFile vFile=event.getFile();
  final PsiDirectory oldParentDir=findDirectory(event.getOldParent());
  final PsiDirectory newParentDir=findDirectory(event.getNewParent());
  if (oldParentDir == null && newParentDir == null)   return;
  final PsiElement oldElement=vFile.isDirectory() ? (PsiElement)myVFileToPsiDirMap.get(vFile) : myVFileToPsiFileMap.get(vFile);
  removeInvalidFilesAndDirs(true);
  final PsiElement newElement=vFile.isDirectory() ? (PsiElement)findDirectory(vFile) : findFile(vFile);
  if (oldElement == null && newElement == null)   return;
  if (oldElement != null && newElement != null) {
    if (oldElement != newElement) {
      ApplicationManager.getApplication().runWriteAction(new PsiExternalChangeAction(){
        public void run(){
          PsiTreeChangeEventImpl treeRemoveEvent=new PsiTreeChangeEventImpl(myManager);
          treeRemoveEvent.setParent(oldParentDir);
          treeRemoveEvent.setChild(oldElement);
          myManager.childRemoved(treeRemoveEvent);
          PsiTreeChangeEventImpl treeAddEvent=new PsiTreeChangeEventImpl(myManager);
          treeAddEvent.setParent(newParentDir);
          treeAddEvent.setChild(newElement);
          myManager.childAdded(treeAddEvent);
        }
      }
);
      return;
    }
  }
  ApplicationManager.getApplication().runWriteAction(new PsiExternalChangeAction(){
    public void run(){
      PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
      if (oldElement != null) {
        if (newElement != null) {
          treeEvent.setOldParent(oldParentDir);
          treeEvent.setNewParent(newParentDir);
          treeEvent.setChild(newElement);
          myManager.childMoved(treeEvent);
        }
 else {
          treeEvent.setParent(oldParentDir);
          treeEvent.setChild(oldElement);
          myManager.childRemoved(treeEvent);
        }
      }
 else {
        LOG.assertTrue(newElement != null);
        treeEvent.setParent(newParentDir);
        treeEvent.setChild(newElement);
        myManager.childAdded(treeEvent);
      }
    }
  }
);
}
