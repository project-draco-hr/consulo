{
  if (!myUseRepository) {
    clearNonRepositoryMaps();
  }
  final VirtualFile vFile=event.getFile();
  VirtualFile parent=event.getParent();
  final PsiDirectory parentDir=parent == null ? null : myVFileToPsiDirMap.get(parent);
  final PsiFile psiFile=getCachedPsiFileInner(vFile);
  if (psiFile != null) {
    myVFileToViewProviderMap.remove(vFile);
    if (parentDir != null) {
      ApplicationManager.getApplication().runWriteAction(new ExternalChangeAction(){
        public void run(){
          PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
          treeEvent.setParent(parentDir);
          treeEvent.setChild(psiFile);
          myManager.childRemoved(treeEvent);
        }
      }
);
    }
  }
 else {
    final PsiDirectory psiDir=myVFileToPsiDirMap.get(vFile);
    if (psiDir != null) {
      removeInvalidFilesAndDirs(false);
      if (parentDir != null) {
        ApplicationManager.getApplication().runWriteAction(new ExternalChangeAction(){
          public void run(){
            PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
            treeEvent.setParent(parentDir);
            treeEvent.setChild(psiDir);
            myManager.childRemoved(treeEvent);
          }
        }
);
      }
    }
  }
}
