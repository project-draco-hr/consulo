{
  if (!myUseRepository) {
    clearNonRepositoryMaps();
  }
  final String propertyName=event.getPropertyName();
  final VirtualFile vFile=event.getFile();
  final PsiDirectory parentDir=myVFileToPsiDirMap.get(vFile.getParent());
  if (parentDir == null) {
    boolean fire=VirtualFile.PROP_NAME.equals(propertyName) && vFile.isDirectory();
    if (fire) {
      PsiDirectory psiDir=myVFileToPsiDirMap.get(vFile);
      fire=psiDir != null;
    }
    if (!fire)     return;
  }
  ApplicationManager.getApplication().runWriteAction(new PsiExternalChangeAction(){
    public void run(){
      PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
      treeEvent.setParent(parentDir);
      if (VirtualFile.PROP_NAME.equals(propertyName)) {
        if (vFile.isDirectory()) {
          PsiDirectory psiDir=myVFileToPsiDirMap.get(vFile);
          if (psiDir != null) {
            if (myFileTypeManager.isFileIgnored(vFile.getName())) {
              removeFilesAndDirsRecursively(vFile);
              treeEvent.setChild(psiDir);
              myManager.childRemoved(treeEvent);
            }
 else {
              treeEvent.setElement(psiDir);
              treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_DIRECTORY_NAME);
              treeEvent.setOldValue(event.getOldValue());
              treeEvent.setNewValue(event.getNewValue());
              myManager.propertyChanged(treeEvent);
            }
          }
 else {
            PsiDirectory psiDir1=findDirectory(vFile);
            if (psiDir1 != null) {
              treeEvent.setChild(psiDir1);
              myManager.childAdded(treeEvent);
            }
          }
        }
 else {
          PsiFile psiFile=getCachedPsiFileInner(vFile);
          if (psiFile != null) {
            PsiFile psiFile1=createPsiFile(vFile,vFile.getName());
            if (psiFile1 == null) {
              cachePsiFile(vFile,null);
              treeEvent.setChild(psiFile);
              myManager.childRemoved(treeEvent);
            }
 else             if (!psiFile1.getClass().equals(psiFile.getClass()) || psiFile1.getFileType() != myFileTypeManager.getFileTypeByFileName((String)event.getOldValue())) {
              cachePsiFile(vFile,null);
              treeEvent.setOldChild(psiFile);
              treeEvent.setNewChild(psiFile1);
              myManager.childReplaced(treeEvent);
            }
 else {
              treeEvent.setElement(psiFile);
              treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_FILE_NAME);
              treeEvent.setOldValue(event.getOldValue());
              treeEvent.setNewValue(event.getNewValue());
              myManager.propertyChanged(treeEvent);
            }
          }
 else {
            PsiFile psiFile1=findFile(vFile);
            if (psiFile1 != null) {
              treeEvent.setChild(psiFile1);
              myManager.childAdded(treeEvent);
            }
          }
        }
      }
 else       if (VirtualFile.PROP_WRITABLE.equals(propertyName)) {
        PsiFile psiFile=getCachedPsiFileInner(vFile);
        if (psiFile == null)         return;
        treeEvent.setElement(psiFile);
        treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_WRITABLE);
        treeEvent.setOldValue(event.getOldValue());
        treeEvent.setNewValue(event.getNewValue());
        myManager.propertyChanged(treeEvent);
      }
    }
  }
);
}
