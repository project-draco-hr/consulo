{
  dispatchPendingEvents();
  myNontrivialPackagePrefixes=null;
  if (!myInitialized)   return;
  if (!myUseRepository) {
    clearNonRepositoryMaps();
  }
  if (event.isCausedByFileTypesChange())   return;
  ApplicationManager.getApplication().runWriteAction(new PsiExternalChangeAction(){
    public void run(){
      RepositoryManager repositoryManager=myManager.getRepositoryManager();
      removeInvalidFilesAndDirs(true);
      if (repositoryManager != null) {
        repositoryManager.updateByRootsChange();
      }
      PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
      treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_ROOTS);
      final VirtualFile[] contentRoots=myProjectRootManager.getContentRoots();
      treeEvent.setNewValue(contentRoots);
      LOG.assertTrue(myOldContentRoots != null);
      treeEvent.setOldValue(myOldContentRoots);
      myOldContentRoots=null;
      myManager.propertyChanged(treeEvent);
    }
  }
);
}
