{
  LOG.assertTrue(!isDispatchThread());
  final Semaphore semaphore=new Semaphore();
  semaphore.down();
  final Ref<Throwable> exception=Ref.create();
  Runnable runnable1=new Runnable(){
    @Override public void run(){
      try {
        runnable.run();
      }
 catch (      Throwable e) {
        exception.set(e);
      }
 finally {
        semaphore.up();
      }
    }
    @Override @NonNls public String toString(){
      return "InvokeAndWait[" + runnable + "]";
    }
  }
;
  invokeLater(runnable1,modalityState);
  semaphore.waitFor();
  if (!exception.isNull()) {
    Throwable cause=exception.get();
    if (SystemProperties.getBooleanProperty("invoke.later.wrap.error",true)) {
      throw new RuntimeException(cause);
    }
 else {
      ExceptionUtil.rethrow(cause);
    }
  }
}
