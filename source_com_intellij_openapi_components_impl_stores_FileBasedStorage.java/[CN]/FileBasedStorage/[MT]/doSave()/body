{
  try {
    final Ref<IOException> refIOException=Ref.create(null);
    final byte[] text=printDocument();
    if (myFile.exists()) {
      final byte[] bytes=myFile.loadBytes();
      if (Arrays.equals(bytes,text))       return;
      IFile backupFile=deleteBackup(myFilePath);
      myFile.renameTo(backupFile);
    }
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        if (!myFile.exists()) {
          myFile.createParentDirs();
        }
        try {
          getOrCreateVirtualFile(myFile).setBinaryContent(text);
        }
 catch (        IOException e) {
          refIOException.set(e);
        }
        deleteBackup(myFilePath);
      }
    }
);
    if (refIOException.get() != null) {
      throw new StateStorage.StateStorageException(refIOException.get());
    }
  }
 catch (  StateStorage.StateStorageException e) {
    throw new StateStorage.StateStorageException(e);
  }
catch (  IOException e) {
    throw new StateStorage.StateStorageException(e);
  }
}
