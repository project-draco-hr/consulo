{
  if (!needsSave())   return;
  try {
    final Ref<IOException> refIOException=Ref.create(null);
    try {
      final byte[] text=printDocument();
      final IFile ioFile=FILE_SYSTEM.createFile(myFilePath);
      if (ioFile.exists()) {
        final byte[] bytes=ioFile.loadBytes();
        if (Arrays.equals(bytes,text))         return;
        IFile backupFile=deleteBackup(myFilePath);
        ioFile.renameTo(backupFile);
      }
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          if (!ioFile.exists()) {
            ioFile.createParentDirs();
          }
          try {
            getOrCreateVirtualFile(ioFile).setBinaryContent(text);
          }
 catch (          IOException e) {
            refIOException.set(e);
          }
          deleteBackup(myFilePath);
        }
      }
);
    }
  finally {
      if (refIOException.get() != null) {
        throw refIOException.get();
      }
    }
  }
 catch (  StateStorageException e) {
    throw new StateStorageException(e);
  }
catch (  IOException e) {
    throw new StateStorageException(e);
  }
}
