{
  if (element instanceof ForeignLeafPsiElement || skipTypes != null && skipTypes.contains(element.getElementType()))   return offset;
  if (element instanceof LeafElement) {
    return ((LeafElement)element).copyTo(buffer,offset);
  }
  int curOffset=offset;
  for (TreeElement child=(TreeElement)element.getFirstChildNode(); child != null; child=child.next) {
    curOffset=toBuffer(child,buffer,curOffset,skipTypes);
  }
  return curOffset;
}
