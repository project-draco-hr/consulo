{
  if (element instanceof ForeignLeafPsiElement || skipTypes != null && skipTypes.contains(element.getElementType()))   return offset;
  if (element instanceof LeafElement) {
    return ((LeafElement)element).copyTo(buffer,offset);
  }
  if (element instanceof LazyParseableElement) {
    LazyParseableElement lpe=(LazyParseableElement)element;
    int lpeResult=lpe.copyTo(buffer,offset);
    if (lpeResult > 0)     return lpeResult;
  }
  int curOffset=offset;
  for (TreeElement child=(TreeElement)element.getFirstChildNode(); child != null; child=child.getTreeNext()) {
    curOffset=toBuffer(child,buffer,curOffset,skipTypes);
  }
  return curOffset;
}
