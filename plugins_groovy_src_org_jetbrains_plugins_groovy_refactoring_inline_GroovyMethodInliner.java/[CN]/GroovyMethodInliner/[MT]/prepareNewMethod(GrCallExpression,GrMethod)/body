{
  GroovyInlineMethodUtil.collectReferenceInfo(call,method);
  GroovyElementFactory factory=GroovyElementFactory.getInstance(method.getProject());
  GrMethod newMethod=factory.createMethodFromText(method.getText());
  ArrayList<GrVariable> innerVariables=new ArrayList<GrVariable>();
  collectInnerVariables(newMethod.getBlock(),innerVariables);
  for (  GrVariable variable : innerVariables) {
    String name=variable.getName();
    if (name != null) {
      String newName=InlineMethodConflictSolver.suggestNewName(name,method,call);
      if (!newName.equals(variable.getName())) {
        final Collection<PsiReference> refs=ReferencesSearch.search(variable,GlobalSearchScope.projectScope(variable.getProject()),false).findAll();
        for (        PsiReference ref : refs) {
          PsiElement element=ref.getElement();
          if (element instanceof GrReferenceExpression) {
            GrExpression newExpr=factory.createExpressionFromText(newName);
            ((GrReferenceExpression)element).replaceWithExpression(newExpr,false);
          }
        }
        variable.setName(newName);
      }
    }
  }
  GroovyRefactoringUtil.replaceParamatersWithArguments(call,newMethod);
  return newMethod;
}
