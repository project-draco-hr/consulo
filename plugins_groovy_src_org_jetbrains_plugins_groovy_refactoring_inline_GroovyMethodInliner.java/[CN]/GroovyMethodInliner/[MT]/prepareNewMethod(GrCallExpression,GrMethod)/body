{
  GroovyElementFactory factory=GroovyElementFactory.getInstance(method.getProject());
  GrMethod newMethod=factory.createMethodFromText(method.getText());
  Collection<GroovyInlineMethodUtil.ReferenceExpressionInfo> infos=GroovyInlineMethodUtil.collectReferenceInfo(method);
  ArrayList<PsiNamedElement> innerDefinitions=new ArrayList<PsiNamedElement>();
  collectInnerDefinitions(newMethod.getBlock(),innerDefinitions);
  for (  PsiNamedElement namedElement : innerDefinitions) {
    String name=namedElement.getName();
    if (name != null) {
      String newName=InlineMethodConflictSolver.suggestNewName(name,method,call);
      if (!newName.equals(namedElement.getName())) {
        final Collection<PsiReference> refs=ReferencesSearch.search(namedElement,GlobalSearchScope.projectScope(namedElement.getProject()),false).findAll();
        for (        PsiReference ref : refs) {
          PsiElement element=ref.getElement();
          if (element instanceof GrReferenceExpression) {
            GrExpression newExpr=factory.createExpressionFromText(newName);
            ((GrReferenceExpression)element).replaceWithExpression(newExpr,false);
          }
        }
        namedElement.setName(newName);
      }
    }
  }
  GroovyRefactoringUtil.replaceParamatersWithArguments(call,newMethod);
  return newMethod;
}
