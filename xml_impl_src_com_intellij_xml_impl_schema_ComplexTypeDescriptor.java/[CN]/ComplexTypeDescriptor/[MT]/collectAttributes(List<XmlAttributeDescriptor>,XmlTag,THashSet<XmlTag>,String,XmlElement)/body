{
  if (visited.contains(tag))   return;
  visited.add(tag);
  if (XmlNSDescriptorImpl.equalsToSchemaName(tag,ELEMENT_TAG_NAME)) {
    return;
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,ATTRIBUTE_TAG_NAME)) {
    String use=tag.getAttributeValue("use");
    String name=tag.getAttributeValue(NAME_ATTR_NAME);
    if (name != null) {
      if (PROHIBITED_ATTR_VALUE.equals(use)) {
        removeAttributeDescriptor(result,name);
      }
 else {
        addAttributeDescriptor(result,myDocumentDescriptor.createAttributeDescriptor(tag));
      }
    }
 else {
      String ref=tag.getAttributeValue(REF_ATTR_NAME);
      if (ref != null) {
        if (PROHIBITED_ATTR_VALUE.equals(use)) {
          removeAttributeDescriptor(result,ref);
        }
 else {
          final String local=XmlUtil.findLocalNameByQualifiedName(ref);
          final String namespace=getNamespace(tag,nsPrefixFromContext,ref);
          final XmlAttributeDescriptor attributeDescriptor=myDocumentDescriptor.getAttribute(local,namespace,tag);
          if (attributeDescriptor instanceof XmlAttributeDescriptorImpl) {
            if (use != null) {
              ((XmlAttributeDescriptorImpl)attributeDescriptor).myUse=use;
            }
            addAttributeDescriptor(result,attributeDescriptor);
          }
        }
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"attributeGroup")) {
    String ref=tag.getAttributeValue(REF_ATTR_NAME);
    if (ref != null) {
      XmlTag groupTag=null;
      final XmlTag parentTag=tag.getParentTag();
      if (parentTag != null && context instanceof XmlTag) {
        String parentGroupName;
        if (XmlNSDescriptorImpl.equalsToSchemaName(parentTag,"attributeGroup") && (parentGroupName=parentTag.getAttributeValue("name")) != null && ref.equals(parentGroupName)) {
          final PsiElement element=tag.getAttribute(REF_ATTR_NAME).getValueElement().getReferences()[0].resolve();
          if (element instanceof XmlTag)           groupTag=(XmlTag)element;
        }
 else {
          final XmlNSDescriptor descriptor=((XmlTag)context).getNSDescriptor(getNamespace(tag,nsPrefixFromContext,ref),true);
          if (descriptor instanceof XmlNSDescriptorImpl && descriptor != myDocumentDescriptor) {
            final XmlTag group=((XmlNSDescriptorImpl)descriptor).findAttributeGroup(ref);
            if (group != null)             groupTag=group;
          }
        }
      }
      if (groupTag == null)       groupTag=myDocumentDescriptor.findAttributeGroup(ref);
      if (groupTag != null) {
        XmlTag[] tags=groupTag.getSubTags();
        String nsPrefixFromRef=XmlUtil.findPrefixByQualifiedName(ref);
        if (nsPrefixFromRef.length() == 0)         nsPrefixFromRef=nsPrefixFromContext;
        for (        XmlTag subTag : tags) {
          collectAttributes(result,subTag,visited,nsPrefixFromRef,context);
        }
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,RESTRICTION_TAG_NAME) || XmlNSDescriptorImpl.equalsToSchemaName(tag,EXTENSION_TAG_NAME)) {
    String base=tag.getAttributeValue(BASE_ATTR_NAME);
    if (base != null) {
      if (base.equals(myTag.getAttributeValue(NAME_ATTR_NAME))) {
        final PsiElement element=tag.getAttribute(BASE_ATTR_NAME).getValueElement().getReferences()[0].resolve();
        if (element instanceof XmlTag) {
          for (          XmlTag subTag : ((XmlTag)element).getSubTags()) {
            collectAttributes(result,subTag,visited,nsPrefixFromContext,context);
          }
        }
      }
 else {
        TypeDescriptor descriptor=myDocumentDescriptor.findTypeDescriptor(myDocumentDescriptor.getTag(),base);
        if (descriptor instanceof ComplexTypeDescriptor) {
          ComplexTypeDescriptor complexTypeDescriptor=(ComplexTypeDescriptor)descriptor;
          complexTypeDescriptor.collectAttributes(result,complexTypeDescriptor.myTag,visited,nsPrefixFromContext,context);
        }
      }
      XmlTag[] tags=tag.getSubTags();
      for (      XmlTag subTag : tags) {
        collectAttributes(result,subTag,visited,nsPrefixFromContext,context);
      }
    }
  }
 else {
    XmlTag[] tags=tag.getSubTags();
    for (    XmlTag subTag : tags) {
      collectAttributes(result,subTag,visited,nsPrefixFromContext,context);
    }
  }
}
