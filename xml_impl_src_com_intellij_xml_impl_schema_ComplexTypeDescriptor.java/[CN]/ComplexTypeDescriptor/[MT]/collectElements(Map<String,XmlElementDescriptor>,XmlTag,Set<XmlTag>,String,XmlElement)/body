{
  if (visited.contains(tag))   return;
  visited.add(tag);
  if (XmlNSDescriptorImpl.equalsToSchemaName(tag,ELEMENT_TAG_NAME)) {
    String nameAttr=tag.getAttributeValue(NAME_ATTR_NAME);
    if (nameAttr != null) {
      addElementDescriptor(result,myDocumentDescriptor.createElementDescriptor(tag));
    }
 else {
      String ref=tag.getAttributeValue(REF_ATTR_NAME);
      if (ref != null) {
        final String local=XmlUtil.findLocalNameByQualifiedName(ref);
        String namespace=getNamespace(tag,nsPrefixFromContext,ref);
        XmlNSDescriptorImpl nsDescriptor=myDocumentDescriptor;
        if (!namespace.equals(myDocumentDescriptor.getDefaultNamespace())) {
          final XmlNSDescriptor namespaceDescriptor=tag.getNSDescriptor(namespace,true);
          if (namespaceDescriptor instanceof XmlNSDescriptorImpl)           nsDescriptor=(XmlNSDescriptorImpl)namespaceDescriptor;
        }
        final XmlElementDescriptor element=nsDescriptor.getElementDescriptor(local,namespace,new THashSet<XmlNSDescriptorImpl>(),true);
        if (element != null) {
          addElementDescriptor(result,element);
        }
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,"group")) {
    String ref=tag.getAttributeValue(REF_ATTR_NAME);
    if (ref != null) {
      XmlTag groupTag=myDocumentDescriptor.findGroup(ref);
      if (groupTag == null && context instanceof XmlTag) {
        final XmlNSDescriptor descriptor=((XmlTag)context).getNSDescriptor(getNamespace(tag,nsPrefixFromContext,ref),true);
        if (descriptor instanceof XmlNSDescriptorImpl && descriptor != myDocumentDescriptor) {
          groupTag=((XmlNSDescriptorImpl)descriptor).findGroup(ref);
        }
      }
      if (groupTag != null) {
        XmlTag[] tags=groupTag.getSubTags();
        String nsPrefixFromRef=XmlUtil.findPrefixByQualifiedName(ref);
        if (nsPrefixFromRef.length() == 0)         nsPrefixFromRef=nsPrefixFromContext;
        for (        XmlTag subTag : tags) {
          collectElements(result,subTag,visited,nsPrefixFromRef,context);
        }
      }
    }
  }
 else   if (XmlNSDescriptorImpl.equalsToSchemaName(tag,RESTRICTION_TAG_NAME) || XmlNSDescriptorImpl.equalsToSchemaName(tag,EXTENSION_TAG_NAME)) {
    String base=tag.getAttributeValue(BASE_ATTR_NAME);
    if (base != null) {
      TypeDescriptor descriptor=myDocumentDescriptor.findTypeDescriptor(myDocumentDescriptor.getTag(),base);
      if (descriptor == this) {
        final XmlNSDescriptorImpl nsDescriptor=SchemaReferencesProvider.findRedefinedDescriptor(tag,base);
        if (nsDescriptor != null) {
          descriptor=nsDescriptor.findTypeDescriptor(nsDescriptor.getTag(),base);
        }
      }
      if (descriptor instanceof ComplexTypeDescriptor) {
        ComplexTypeDescriptor complexTypeDescriptor=(ComplexTypeDescriptor)descriptor;
        complexTypeDescriptor.collectElements(result,complexTypeDescriptor.myTag,visited,base,context);
      }
      XmlTag[] tags=tag.getSubTags();
      for (      XmlTag subTag : tags) {
        collectElements(result,subTag,visited,nsPrefixFromContext,context);
      }
    }
  }
 else {
    XmlTag[] tags=tag.getSubTags();
    for (    XmlTag subTag : tags) {
      collectElements(result,subTag,visited,nsPrefixFromContext,context);
    }
  }
}
