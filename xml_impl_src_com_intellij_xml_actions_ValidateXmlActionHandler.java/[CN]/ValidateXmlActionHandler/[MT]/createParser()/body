{
  try {
    if (!needsDtdChecking() && !needsSchemaChecking() && !myForceChecking) {
      return null;
    }
    SAXParserFactory factory=new SAXParserFactoryImpl();
    boolean schemaChecking=false;
    if (hasDtdDeclaration()) {
      factory.setValidating(true);
    }
    if (needsSchemaChecking()) {
      factory.setValidating(true);
      factory.setNamespaceAware(true);
      try {
        factory.setXIncludeAware(true);
      }
 catch (      NoSuchMethodError e) {
      }
      schemaChecking=true;
    }
    SAXParser parser=factory.newSAXParser();
    parser.setProperty(ENTITY_RESOLVER_PROPERTY_NAME,myXmlResourceResolver);
    if (schemaChecking) {
      final XMLGrammarPoolImpl previousGrammarPool=myFile.getUserData(GRAMMAR_POOL_KEY);
      XMLGrammarPoolImpl grammarPool=null;
      if (!myForceChecking && !isValidationDependentFilesOutOfDate(myFile)) {
        grammarPool=previousGrammarPool;
      }
      if (grammarPool == null) {
        grammarPool=new XMLGrammarPoolImpl();
        myFile.putUserData(GRAMMAR_POOL_KEY,grammarPool);
      }
      parser.getXMLReader().setProperty(GRAMMAR_FEATURE_ID,grammarPool);
    }
    try {
      if (schemaChecking) {
        parser.setProperty(JAXPConstants.JAXP_SCHEMA_LANGUAGE,JAXPConstants.W3C_XML_SCHEMA);
        parser.getXMLReader().setFeature(SCHEMA_FULL_CHECKING_FEATURE_ID,true);
        parser.getXMLReader().setFeature("http://apache.org/xml/features/honour-all-schemaLocations",true);
        parser.getXMLReader().setFeature("http://apache.org/xml/features/validation/warn-on-undeclared-elemdef",Boolean.TRUE);
        parser.getXMLReader().setFeature("http://apache.org/xml/features/validation/warn-on-duplicate-attdef",Boolean.TRUE);
      }
      parser.getXMLReader().setFeature("http://apache.org/xml/features/warn-on-duplicate-entitydef",Boolean.TRUE);
      parser.getXMLReader().setFeature("http://apache.org/xml/features/validation/unparsed-entity-checking",Boolean.FALSE);
    }
 catch (    SAXNotRecognizedException ex) {
      LOG.info("Xml parser installation seems screwed",ex);
    }
    return parser;
  }
 catch (  Exception e) {
    filterAppException(e);
  }
  return null;
}
