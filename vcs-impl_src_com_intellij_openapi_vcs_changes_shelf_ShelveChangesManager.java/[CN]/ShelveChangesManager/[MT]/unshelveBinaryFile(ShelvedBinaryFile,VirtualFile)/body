{
  final Ref<FilePath> result=new Ref<FilePath>();
  final Ref<IOException> ex=new Ref<IOException>();
  final Ref<VirtualFile> patchedFileRef=new Ref<VirtualFile>();
  final File shelvedFile=file.SHELVED_PATH == null ? null : new File(file.SHELVED_PATH);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        result.set(new FilePathImpl(patchTarget));
        if (shelvedFile == null) {
          patchTarget.delete(this);
        }
 else {
          patchTarget.setBinaryContent(FileUtil.loadFileBytes(shelvedFile));
          patchedFileRef.set(patchTarget);
        }
      }
 catch (      IOException e) {
        ex.set(e);
      }
    }
  }
);
  if (!ex.isNull()) {
    throw ex.get();
  }
  if (shelvedFile != null) {
    FileUtil.delete(shelvedFile);
  }
  return result.get();
}
