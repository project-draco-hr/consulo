{
  final CompletionLocation location=new CompletionLocation(parameters);
  CompletionSorterImpl sorter=emptySorter();
  final String prefix=matcher.getPrefix();
  if (!prefix.isEmpty()) {
    final String prefixHumps=StringUtil.capitalsOnly(prefix);
    if (prefixHumps.length() > 0) {
      sorter=sorter.weigh(new LookupElementWeigher("prefixHumps"){
        @NotNull @Override public Comparable weigh(        @NotNull LookupElement element){
          for (          String itemString : element.getAllLookupStrings()) {
            if (StringUtil.capitalsOnly(itemString).startsWith(prefixHumps) && StringUtil.isCapitalized(itemString)) {
              return false;
            }
          }
          return true;
        }
      }
);
    }
  }
  for (  final Weigher weigher : WeighingService.getWeighers(CompletionService.RELEVANCE_KEY)) {
    final String id=weigher.toString();
    if ("prefix".equals(id)) {
      sorter=sorter.withClassifier(new ClassifierFactory<LookupElement>(id){
        @Override public Classifier<LookupElement> createClassifier(        Classifier<LookupElement> next){
          return new ComparingClassifier<LookupElement>(next,id){
            @NotNull @Override public Comparable getWeight(            LookupElement element){
              return -PrefixMatchingWeigher.getPrefixMatchingDegree(element,location);
            }
          }
;
        }
      }
);
    }
 else {
      sorter=sorter.weigh(new LookupElementWeigher(id){
        @NotNull @Override public Comparable weigh(        @NotNull LookupElement element){
          return new NegatingComparable(weigher.weigh(element,location));
        }
      }
);
    }
  }
  if (parameters.getCompletionType() == CompletionType.SMART) {
    return sorter;
  }
  return sorter.withClassifier("priority",true,new ClassifierFactory<LookupElement>("liftShorter"){
    @Override public Classifier<LookupElement> createClassifier(    final Classifier<LookupElement> next){
      return new LiftShorterItemsClassifier(next,new LiftShorterItemsClassifier.LiftingCondition());
    }
  }
);
}
