{
  final CompletionLocation location=new CompletionLocation(parameters);
  CompletionSorterImpl sorter=emptySorter();
  sorter=sorter.withClassifier(CompletionSorterImpl.weighingFactory(new DispreferLiveTemplates()));
  sorter=sorter.withClassifier(CompletionSorterImpl.weighingFactory(new PreferStartMatching(location)));
  for (  final Weigher weigher : WeighingService.getWeighers(CompletionService.RELEVANCE_KEY)) {
    final String id=weigher.toString();
    if ("prefix".equals(id)) {
      sorter=sorter.withClassifier(CompletionSorterImpl.weighingFactory(new RealPrefixMatchingWeigher(location)));
    }
 else     if ("stats".equals(id)) {
      sorter=sorter.withClassifier(new ClassifierFactory<LookupElement>("stats"){
        @Override public Classifier<LookupElement> createClassifier(        Classifier<LookupElement> next){
          return new StatisticsWeigher.LookupStatisticsWeigher(location,next);
        }
      }
);
    }
 else {
      sorter=sorter.weigh(new LookupElementWeigher(id,true,false){
        @Override public Comparable weigh(        @NotNull LookupElement element){
          return weigher.weigh(element,location);
        }
      }
);
    }
  }
  return sorter.withClassifier("priority",true,new ClassifierFactory<LookupElement>("liftShorter"){
    @Override public Classifier<LookupElement> createClassifier(    final Classifier<LookupElement> next){
      return new LiftShorterItemsClassifier("liftShorter",next,new LiftShorterItemsClassifier.LiftingCondition(),false);
    }
  }
);
}
