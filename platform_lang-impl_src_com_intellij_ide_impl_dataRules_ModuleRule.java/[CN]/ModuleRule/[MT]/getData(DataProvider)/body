{
  Object moduleContext=LangDataKeys.MODULE_CONTEXT.getData(dataProvider);
  if (moduleContext != null) {
    return moduleContext;
  }
  Project project=PlatformDataKeys.PROJECT.getData(dataProvider);
  if (project == null) {
    PsiElement element=LangDataKeys.PSI_ELEMENT.getData(dataProvider);
    if (element == null || !element.isValid())     return null;
    project=element.getProject();
  }
  VirtualFile virtualFile=PlatformDataKeys.VIRTUAL_FILE.getData(dataProvider);
  if (virtualFile == null) {
    GetDataRule dataRule=((DataManagerImpl)DataManager.getInstance()).getDataRule(PlatformDataKeys.VIRTUAL_FILE.getName());
    if (dataRule != null) {
      virtualFile=(VirtualFile)dataRule.getData(dataProvider);
    }
  }
  if (virtualFile == null) {
    return null;
  }
  return ModuleUtil.findModuleForFile(virtualFile,project);
}
