{
  ModuleContainer moduleContainer=buildJarSettings.getModuleContainer();
  String jarPath=buildJarSettings.getJarPath();
  final File jarFile=new File(jarPath);
  jarFile.delete();
  FileUtil.createParentDirs(jarFile);
  BuildRecipe buildRecipe=MakeUtil.getInstance().createBuildRecipe();
  LibraryLink[] libraries=moduleContainer.getContainingLibraries();
  final DummyCompileContext compileContext=DummyCompileContext.getInstance();
  for (  LibraryLink libraryLink : libraries) {
    MakeUtil.getInstance().addLibraryLink(compileContext,buildRecipe,libraryLink,module,null);
  }
  ModuleLink[] modules=moduleContainer.getContainingModules();
  MakeUtil.getInstance().addJavaModuleOutputs(module,modules,buildRecipe,compileContext,null);
  Manifest manifest=MakeUtil.getInstance().createManifest(buildRecipe);
  String mainClass=buildJarSettings.getMainClass();
  if (manifest != null && !Comparing.strEqual(mainClass,null)) {
    manifest.getMainAttributes().putValue(MAIN_CLASS,mainClass);
  }
  final File tempFile=File.createTempFile("___" + FileUtil.getNameWithoutExtension(jarFile),JAR_EXTENSION,jarFile.getParentFile());
  final JarOutputStream jarOutputStream=manifest == null ? new JarOutputStream(new BufferedOutputStream(new FileOutputStream(tempFile))) : new JarOutputStream(new BufferedOutputStream(new FileOutputStream(tempFile)),manifest);
  final Set<String> tempWrittenRelativePaths=new THashSet<String>();
  final BuildRecipe dependencies=MakeUtil.getInstance().createBuildRecipe();
  final FileFilter allFilesFilter=new FileFilter(){
    public boolean accept(    File f){
      return true;
    }
    public String getDescription(){
      return IdeBundle.message("filter.all.file.types");
    }
  }
;
  try {
    buildRecipe.visitInstructionsWithExceptions(new BuildInstructionVisitor(){
      public boolean visitInstruction(      BuildInstruction instruction) throws IOException {
        ProgressManager.getInstance().checkCanceled();
        if (instruction instanceof FileCopyInstruction) {
          FileCopyInstruction fileCopyInstruction=(FileCopyInstruction)instruction;
          File file=fileCopyInstruction.getFile();
          if (file == null || !file.exists())           return true;
          String presentablePath=FileUtil.toSystemDependentName(file.getPath());
          ProgressManager.getInstance().getProgressIndicator().setText2(IdeBundle.message("jar.build.processing.file.progress",presentablePath));
        }
        instruction.addFilesToJar(compileContext,tempFile,jarOutputStream,dependencies,tempWrittenRelativePaths,allFilesFilter);
        return true;
      }
    }
,false);
  }
 catch (  ProcessCanceledException e) {
    throw e;
  }
catch (  Exception e) {
    LOG.error(e);
  }
 finally {
    jarOutputStream.close();
    try {
      FileUtil.rename(tempFile,jarFile);
    }
 catch (    IOException e) {
      String message=IdeBundle.message("jar.build.cannot.overwrite.error",FileUtil.toSystemDependentName(jarFile.getPath()),FileUtil.toSystemDependentName(tempFile.getPath()));
      Messages.showErrorDialog(module.getProject(),message,IdeBundle.message("jar.build.error.title"));
    }
  }
}
