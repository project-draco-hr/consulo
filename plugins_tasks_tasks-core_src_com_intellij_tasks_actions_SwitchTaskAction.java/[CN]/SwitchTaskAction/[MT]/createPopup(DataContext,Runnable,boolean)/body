{
  final Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  final Ref<Boolean> shiftPressed=Ref.create(false);
  final DefaultActionGroup group=project == null ? new DefaultActionGroup() : createPopupActionGroup(project,shiftPressed);
  final String title=withTitle ? "Switch to Task" : null;
  final ListPopupImpl popup=(ListPopupImpl)JBPopupFactory.getInstance().createActionGroupPopup(title,group,dataContext,JBPopupFactory.ActionSelectionAid.SPEEDSEARCH,false,onDispose,MAX_ROW_COUNT);
  if (group.getChildrenCount() <= 2) {
    return popup;
  }
  popup.setAdText("Press SHIFT to merge with current context");
  popup.registerAction("shiftPressed",KeyStroke.getKeyStroke("shift pressed SHIFT"),new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      shiftPressed.set(true);
      popup.setCaption("Merge with Current Context");
    }
  }
);
  popup.registerAction("shiftReleased",KeyStroke.getKeyStroke("released SHIFT"),new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      shiftPressed.set(false);
      popup.setCaption("Switch to Task");
    }
  }
);
  popup.registerAction("invoke",KeyStroke.getKeyStroke("shift ENTER"),new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      popup.handleSelect(true);
    }
  }
);
  return popup;
}
