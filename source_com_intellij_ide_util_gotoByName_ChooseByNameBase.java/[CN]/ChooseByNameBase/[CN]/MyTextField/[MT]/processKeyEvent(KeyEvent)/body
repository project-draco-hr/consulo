{
  final int caretPosition=getCaretPosition();
  if (getCaretPosition() < myExactPrefixLen) {
    myExactPrefixLen=caretPosition;
  }
  final KeyStroke keyStroke=KeyStroke.getKeyStrokeForEvent(e);
  if (myCompletionKeyStroke != null && keyStroke.equals(myCompletionKeyStroke)) {
    e.consume();
    final String pattern=myTextField.getText();
    final String oldText=myTextField.getText();
    final int oldPos=myList.getSelectedIndex();
    myHistory.add(Pair.create(oldText,oldPos));
    final Runnable postRunnable=new Runnable(){
      public void run(){
        fillInCommonPrefix(pattern);
      }
    }
;
    rebuildList(0,0,postRunnable,ModalityState.current());
    return;
  }
  if (backStroke != null && keyStroke.equals(backStroke)) {
    e.consume();
    if (myHistory.size() != 0) {
      final String oldText=myTextField.getText();
      final int oldPos=myList.getSelectedIndex();
      final Pair<String,Integer> last=myHistory.remove(myHistory.size() - 1);
      myTextField.setText(last.first);
      myFuture.add(Pair.create(oldText,oldPos));
      rebuildList(0,0,null,ModalityState.current());
    }
    return;
  }
  if (forwardStroke != null && keyStroke.equals(forwardStroke)) {
    e.consume();
    if (myFuture.size() != 0) {
      final String oldText=myTextField.getText();
      final int oldPos=myList.getSelectedIndex();
      final Pair<String,Integer> next=myFuture.remove(myFuture.size() - 1);
      myTextField.setText(next.first);
      myHistory.add(Pair.create(oldText,oldPos));
      rebuildList(0,0,null,ModalityState.current());
    }
    return;
  }
  super.processKeyEvent(e);
}
