{
  int selected=getSelectedIndex();
  if (selected < 0)   return;
  TemplateImpl template=getTemplate(selected);
  DefaultMutableTreeNode oldTemplateNode=getNode(selected);
  if (template == null)   return;
  String oldGroupName=template.getGroupName();
  EditTemplateDialog dialog=new EditTemplateDialog(this,CodeInsightBundle.message("dialog.edit.live.template.title"),template,getTemplateGroups(),(String)myExpandByCombo.getSelectedItem(),myTemplateOptions.get(template),myTemplateContext.get(template));
  dialog.show();
  if (!dialog.isOK())   return;
  TemplateGroup group=getTemplateGroup(template.getGroupName());
  LOG.assertTrue(group != null,template.getGroupName());
  dialog.apply();
  DefaultTreeModel model=(DefaultTreeModel)myTree.getModel();
  if (!oldGroupName.equals(template.getGroupName())) {
    TemplateGroup oldGroup=getTemplateGroup(oldGroupName);
    oldGroup.removeElement(template);
    template.setId(null);
    JTree tree=myTree;
    DefaultMutableTreeNode parent=(DefaultMutableTreeNode)oldTemplateNode.getParent();
    removeNodeFromParent(oldTemplateNode);
    if (parent.getChildCount() == 0)     removeNodeFromParent(parent);
    DefaultMutableTreeNode templateNode=addTemplate(template);
    TreePath newTemplatePath=new TreePath(templateNode.getPath());
    tree.expandPath(newTemplatePath);
    selected=tree.getRowForPath(newTemplatePath);
    ((DefaultTreeModel)myTree.getModel()).nodeStructureChanged(myTreeRoot);
  }
  myTree.setSelectionInterval(selected,selected);
  updateTemplateTextArea();
  isModified=true;
}
