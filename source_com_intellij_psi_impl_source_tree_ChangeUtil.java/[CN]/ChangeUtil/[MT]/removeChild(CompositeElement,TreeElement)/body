{
  LOG.assertTrue(child.getTreeParent() == parent);
  int offset=child.getStartOffset();
  int childLength=child.getTextLength();
  PsiTreeChangeEventImpl event=null;
  PsiElement parentPsiElement=SourceTreeToPsiMap.treeElementToPsi(parent);
  PsiFile file=parentPsiElement.getContainingFile();
  boolean physical=parentPsiElement.isPhysical();
  if (physical) {
    PsiManagerImpl manager=(PsiManagerImpl)parent.getManager();
    if (file != null) {
      manager.invalidateFile(file);
    }
    event=new PsiTreeChangeEventImpl(manager);
    event.setParent(parentPsiElement);
    event.setChild(SourceTreeToPsiMap.treeElementToPsi(child));
    event.setFile(file);
    event.setOffset(offset);
    event.setOldLength(childLength);
    manager.beforeChildRemoval(event);
    RepositoryManager repositoryManager=manager.getRepositoryManager();
    if (repositoryManager != null) {
      repositoryManager.beforeChildAddedOrRemoved(file,parent,child);
    }
  }
  child.putUserData(CharTable.CHAR_TABLE_KEY,SharedImplUtil.findCharTableByTree(child));
  TreeUtil.remove(child);
  parent.subtreeChanged();
  PsiManagerImpl manager=(PsiManagerImpl)parent.getManager();
  if (physical) {
    manager.childRemoved(event);
  }
 else   if (manager != null) {
    manager.nonPhysicalChange();
  }
  checkConsistency(file);
}
