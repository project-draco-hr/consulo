{
  extend(CompletionType.BASIC,XmlPatterns.psiElement().inside(XmlPatterns.xmlAttributeValue()),new CompletionProvider<CompletionParameters>(false){
    @Override protected void addCompletions(    @NotNull CompletionParameters parameters,    ProcessingContext context,    @NotNull final CompletionResultSet result){
      final XmlAttributeValue attributeValue=PsiTreeUtil.getParentOfType(parameters.getPosition(),XmlAttributeValue.class,false);
      if (attributeValue == null) {
        return;
      }
      final Set<String> usedWords=new THashSet<String>();
      final Ref<Boolean> addWordVariants=Ref.create(true);
      result.runRemainingContributors(parameters,new Consumer<LookupElement>(){
        public void consume(        LookupElement element){
          if (element.getUserData(WORD_COMPLETION_COMPATIBLE) == null) {
            addWordVariants.set(false);
          }
          usedWords.add(element.getLookupString());
          result.addElement(LookupElementDecorator.withInsertHandler(element,QUOTE_EATER));
        }
      }
);
      if (addWordVariants.get().booleanValue()) {
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            addWordVariants.set(attributeValue.getReferences().length == 0);
          }
        }
);
      }
      if (addWordVariants.get().booleanValue()) {
        WordCompletionContributor.addWordCompletionVariants(result,parameters,usedWords);
      }
    }
  }
);
}
