{
  PsiElement element=parameters.getPosition();
  if (!isXmlNameCompletion(parameters))   return;
  result.stopHere();
  PsiElement parent=element.getParent();
  if (!(parent instanceof XmlTag) || !(parameters.getOriginalFile() instanceof XmlFile)) {
    return;
  }
  final XmlTag tag=(XmlTag)parent;
  final String namespace=tag.getNamespace();
  final String prefix=result.getPrefixMatcher().getPrefix();
  final int pos=prefix.indexOf(':');
  final PsiReference reference=tag.getReference();
  String namespacePrefix=tag.getNamespacePrefix();
  if (reference != null && !namespace.isEmpty() && !namespacePrefix.isEmpty()) {
    final Set<LookupElement> set=new HashSet<LookupElement>();
    new XmlCompletionData().completeReference(reference,set,element,parameters.getOriginalFile(),parameters.getOffset());
    for (    final LookupElement item : set) {
      result.addElement(item);
    }
  }
 else {
    final CompletionResultSet newResult=result.withPrefixMatcher(pos >= 0 ? prefix.substring(pos + 1) : prefix);
    final XmlFile file=(XmlFile)parameters.getOriginalFile();
    final List<Pair<String,String>> names=XmlExtension.getExtension(file).getAvailableTagNames(file,tag);
    for (    Pair<String,String> pair : names) {
      final String name=pair.getFirst();
      final String ns=pair.getSecond();
      final LookupElement item=createLookupElement(name,ns,ns,namespacePrefix.isEmpty() ? null : namespacePrefix);
      newResult.addElement(item);
    }
  }
}
