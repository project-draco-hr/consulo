{
  final PsiDirectory[] directories=new PsiDirectory[elements.length];
  System.arraycopy(elements,0,directories,0,directories.length);
  final String prompt=getPromptToMoveDirectoryLibrariesSafe(elements);
  if (prompt != null) {
    moveDirectoriesLibrariesSafe(project,targetContainer,callback,directories,prompt);
    return;
  }
  if (canMoveOrRearrangePackages(elements)) {
    SelectMoveOrRearrangePackageDialog dialog=new SelectMoveOrRearrangePackageDialog(project,directories,targetContainer == null);
    dialog.show();
    if (!dialog.isOK())     return;
    if (dialog.isPackageRearrageSelected()) {
      MoveClassesOrPackagesImpl.doRearrangePackage(project,directories);
      return;
    }
    if (dialog.isMoveDirectory()) {
      moveAsDirectory(project,targetContainer,callback,directories);
      return;
    }
  }
  if (tryDirectoryMove(project,elements,targetContainer,callback)) {
    return;
  }
  MoveClassesOrPackagesImpl.doMove(project,elements,targetContainer,callback);
}
