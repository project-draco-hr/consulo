{
  PsiDirectory psiDirectory=(PsiDirectory)element;
  PsiPackage aPackage=JavaDirectoryService.getInstance().getPackage(psiDirectory);
  final String qualifiedName=aPackage != null ? aPackage.getQualifiedName() : "";
  if (aPackage == null || qualifiedName.length() == 0 || !JavaPsiFacade.getInstance(project).getNameHelper().isIdentifier(psiDirectory.getName())) {
    PsiElementRenameHandler.rename(element,project,nameSuggestionContext,editor);
  }
 else {
    PsiDirectory[] directories=aPackage.getDirectories();
    final VirtualFile[] virtualFiles=aPackage.occursInPackagePrefixes();
    if (virtualFiles.length == 0 && directories.length == 1) {
      PsiElementRenameHandler.rename(aPackage,project,nameSuggestionContext,editor);
    }
 else {
      StringBuffer message=new StringBuffer();
      RenameUtil.buildPackagePrefixChangedMessage(virtualFiles,message,qualifiedName);
      buildMultipleDirectoriesInPackageMessage(message,aPackage,directories);
      message.append(RefactoringBundle.message("directories.and.all.references.to.package.will.be.renamed",qualifiedName));
      int ret=Messages.showYesNoDialog(project,message.toString(),RefactoringBundle.message("warning.title"),Messages.getWarningIcon());
      if (ret != 0) {
        return;
      }
      PsiElementRenameHandler.rename(aPackage,project,nameSuggestionContext,editor);
    }
  }
}
