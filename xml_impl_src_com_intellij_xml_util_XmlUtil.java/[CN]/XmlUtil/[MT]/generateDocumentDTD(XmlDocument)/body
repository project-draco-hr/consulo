{
  final Map<String,List<String>> tags=new LinkedHashMap<String,List<String>>();
  final Map<String,List<MyAttributeInfo>> attributes=new LinkedHashMap<String,List<MyAttributeInfo>>();
  try {
    XmlEntityRefImpl.setNoEntityExpandOutOfDocument(doc,true);
    final XmlTag rootTag=doc.getRootTag();
    computeTag(rootTag,tags,attributes);
    for (PsiElement element=rootTag != null ? rootTag.getNextSibling() : null; element != null; element=element.getNextSibling()) {
      if (element instanceof XmlTag) {
        computeTag((XmlTag)element,tags,attributes);
      }
    }
  }
  finally {
    XmlEntityRefImpl.setNoEntityExpandOutOfDocument(doc,false);
  }
  final StringBuilder buffer=new StringBuilder();
  for (  final String tagName : tags.keySet()) {
    buffer.append(generateElementDTD(tagName,tags.get(tagName),attributes.get(tagName)));
  }
  return buffer.toString();
}
