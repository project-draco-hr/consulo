{
  PsiFile result=null;
  final JspFile jspFile=PsiUtil.getJspFile(base);
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    String data=jspFile != null ? jspFile.getUserData(TEST_PATH) : base.getUserData(TEST_PATH);
    if (data == null) {
      PsiFile originalFile=base.getOriginalFile();
      if (originalFile != null) {
        data=originalFile.getUserData(TEST_PATH);
      }
    }
    if (data != null) {
      String filePath=data + "/" + uri;
      final VirtualFile path=LocalFileSystem.getInstance().findFileByPath(filePath.replace(File.separatorChar,'/'));
      if (path != null) {
        result=base.getManager().findFile(path);
      }
    }
  }
  if (result == null) {
    result=PsiUtil.findRelativeFile(uri,base);
  }
  if (result == null || !(result instanceof XmlFile)) {
    final JspManager jspManager=JspManager.getInstance(base.getProject());
    if (jspManager != null) {
      if (jspFile != null) {
        result=jspManager.getTldFileByUri(uri,jspFile);
        if (result == null && JSTL_CORE_URI2.equals(uri)) {
          result=jspManager.getTldFileByUri(JSTL_CORE_URI,jspFile);
        }
      }
 else {
        if (base instanceof XmlFile && base.getUserData(findXmlFileInProgressKey) == null) {
          base.putUserData(findXmlFileInProgressKey,"");
          try {
            final XmlDocument document=((XmlFile)base).getDocument();
            final XmlTag rootTag=document != null ? document.getRootTag() : null;
            if (rootTag != null && rootTag.getPrefixByNamespace(FACELETS_URI) != null) {
              result=jspManager.getTldFileByUri(uri,ModuleUtil.findModuleForPsiElement(base),null);
            }
          }
  finally {
            base.putUserData(findXmlFileInProgressKey,null);
          }
        }
      }
    }
  }
  if (result instanceof XmlFile) {
    return (XmlFile)result;
  }
  return null;
}
