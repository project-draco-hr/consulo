{
  getTreeStructure().commit();
  final boolean wasExpanded=myTree.isExpanded(new TreePath(node.getPath()));
  final boolean wasLeaf=node.getChildCount() == 0;
  final NodeDescriptor descriptor=(NodeDescriptor)node.getUserObject();
  if (descriptor == null)   return;
  if (myUnbuiltNodes.contains(node)) {
    processUnbuilt(node,descriptor);
    processNodeActionsIfReady(node);
    return;
  }
  if (getTreeStructure().isToBuildChildrenInBackground(getBuilder().getTreeStructureElement(descriptor))) {
    if (queueBackgroundUpdate(node,descriptor))     return;
  }
  final Map<Object,Integer> elementToIndexMap=collectElementToIndexMap(descriptor);
  myUpdatingChildren.add(node);
  processAllChildren(node,elementToIndexMap).doWhenDone(new Runnable(){
    public void run(){
      ArrayList<TreeNode> nodesToInsert=collectNodesToInsert(descriptor,elementToIndexMap);
      insertNodesInto(nodesToInsert,node);
      updateNodesToInsert(nodesToInsert);
      if (wasExpanded) {
        expand(node);
      }
      if (wasExpanded || wasLeaf) {
        expand(node,descriptor,wasLeaf);
      }
      myUpdatingChildren.remove(node);
      processNodeActionsIfReady(node);
    }
  }
);
}
