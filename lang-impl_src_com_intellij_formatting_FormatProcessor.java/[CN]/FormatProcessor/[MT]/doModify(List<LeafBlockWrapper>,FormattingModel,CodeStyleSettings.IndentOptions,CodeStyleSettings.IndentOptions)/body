{
  final int blocksToModifyCount=blocksToModify.size();
  final boolean bulkReformat=blocksToModifyCount > 50;
  final DocumentEx updatedDocument=bulkReformat ? getAffectedDocument(model) : null;
  if (updatedDocument != null) {
    updatedDocument.setInBulkUpdate(true);
  }
  try {
    int shift=0;
    for (int i=0; i < blocksToModifyCount; ++i) {
      final LeafBlockWrapper block=blocksToModify.get(i);
      shift=replaceWhiteSpace(model,block,shift,block.getWhiteSpace().generateWhiteSpace(indentOption),javaOptions);
      block.getParent().dispose();
      block.dispose();
      blocksToModify.set(i,null);
    }
  }
  finally {
    if (updatedDocument != null) {
      updatedDocument.setInBulkUpdate(false);
    }
    model.commitChanges();
  }
}
