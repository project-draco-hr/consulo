{
  if (myOnValidateAttempt) {
    myOnValidateAttempt=false;
    return;
  }
  myCards.clear();
  mySettingsPanel.removeAll();
  mySettingsPanel.add(new JPanel(),EMPTY_CARD_NAME);
  GradleProject project=getBuilder().getGradleProject();
  if (project == null) {
    throw new IllegalStateException(String.format("Can't init 'adjust importing settings' step. Reason: no project is defined. Context: '%s', builder: '%s'",getContext(),getBuilder()));
  }
  Map<GradleEntity,Pair<String,Collection<GradleProjectStructureNode>>> entity2nodes=new HashMap<GradleEntity,Pair<String,Collection<GradleProjectStructureNode>>>();
  int counter=0;
  DefaultMutableTreeNode root=buildNode(project,entity2nodes,counter++);
  List<GradleModule> modules=new ArrayList<GradleModule>(project.getModules());
  Collections.sort(modules,Named.COMPARATOR);
  List<MutableTreeNode> moduleNodes=new ArrayList<MutableTreeNode>();
  for (  GradleModule module : modules) {
    DefaultMutableTreeNode moduleNode=buildNode(module,entity2nodes,counter++);
    moduleNodes.add(moduleNode);
    Collection<GradleDependency> dependencies=module.getDependencies();
    if (!dependencies.isEmpty()) {
      DefaultMutableTreeNode dependenciesNode=new DefaultMutableTreeNode(GradleBundle.message("gradle.import.structure.tree.node.dependencies"));
      final List<GradleModuleDependency> moduleDependencies=new ArrayList<GradleModuleDependency>();
      final List<GradleLibrary> libraryDependencies=new ArrayList<GradleLibrary>();
      GradleEntityVisitor visitor=new GradleEntityVisitorAdapter(){
        @Override public void visit(        @NotNull GradleModuleDependency dependency){
          moduleDependencies.add(dependency);
        }
        @Override public void visit(        @NotNull GradleLibraryDependency dependency){
          libraryDependencies.add(dependency.getLibrary());
        }
      }
;
      for (      GradleDependency dependency : dependencies) {
        dependency.invite(visitor);
      }
      Collections.sort(moduleDependencies,GradleModuleDependency.COMPARATOR);
      Collections.sort(libraryDependencies,Named.COMPARATOR);
      for (      GradleModuleDependency dependency : moduleDependencies) {
        dependenciesNode.add(buildNode(dependency,entity2nodes,counter++));
      }
      for (      GradleLibrary dependency : libraryDependencies) {
        dependenciesNode.add(buildNode(dependency,entity2nodes,counter++));
      }
      moduleNode.add(dependenciesNode);
    }
  }
  myTreeModel.setRoot(root);
  myTree.setSelectionPath(new TreePath(root));
  Collection<? extends GradleLibrary> libraries=project.getLibraries();
  if (libraries.isEmpty()) {
    for (    MutableTreeNode node : moduleNodes) {
      root.add(node);
    }
  }
 else {
    DefaultMutableTreeNode modulesNode=new DefaultMutableTreeNode(GradleBundle.message("gradle.import.structure.tree.node.modules"));
    for (    MutableTreeNode node : moduleNodes) {
      modulesNode.add(node);
    }
    root.add(modulesNode);
    List<GradleLibrary> sortedLibraries=new ArrayList<GradleLibrary>(libraries);
    Collections.sort(sortedLibraries,Named.COMPARATOR);
    DefaultMutableTreeNode librariesNode=new DefaultMutableTreeNode(GradleBundle.message("gradle.import.structure.tree.node.libraries"));
    for (    GradleLibrary library : sortedLibraries) {
      librariesNode.add(buildNode(library,entity2nodes,counter++));
    }
    root.add(librariesNode);
    myTree.expandPath(new TreePath(modulesNode.getPath()));
    myTree.expandPath(new TreePath(librariesNode.getPath()));
  }
}
