{
  try {
    final Collection<DfaMemoryState> initialStates=createInitialStates(psiBlock,visitor);
    if (initialStates == null)     return RunnerResult.NOT_APPLICABLE;
    final ControlFlow flow=createControlFlowAnalyzer().buildControlFlow(psiBlock);
    if (flow == null)     return RunnerResult.NOT_APPLICABLE;
    int endOffset=flow.getInstructionCount();
    myInstructions=flow.getInstructions();
    myFields=flow.getFields();
    if (LOG.isDebugEnabled()) {
      LOG.debug("Analyzing code block: " + psiBlock.getText());
      for (int i=0; i < myInstructions.length; i++) {
        Instruction instruction=myInstructions[i];
        LOG.debug(i + ": " + instruction.toString());
      }
    }
    Integer tooExpensiveSize=psiBlock.getUserData(TOO_EXPENSIVE_SIZE);
    if (tooExpensiveSize != null && tooExpensiveSize == psiBlock.getText().hashCode()) {
      LOG.debug("Too complex because hasn't changed since being too complex already");
      return RunnerResult.TOO_COMPLEX;
    }
    final ArrayList<DfaInstructionState> queue=new ArrayList<DfaInstructionState>();
    for (    final DfaMemoryState initialState : initialStates) {
      queue.add(new DfaInstructionState(myInstructions[0],initialState));
    }
    long timeLimit=ourTimeLimit;
    final boolean unitTestMode=ApplicationManager.getApplication().isUnitTestMode();
    WorkingTimeMeasurer measurer=new WorkingTimeMeasurer(timeLimit);
    int count=0;
    while (!queue.isEmpty()) {
      if (count % 50 == 0 && !unitTestMode && measurer.isTimeOver()) {
        LOG.debug("Too complex because the analysis took too long");
        psiBlock.putUserData(TOO_EXPENSIVE_SIZE,psiBlock.getText().hashCode());
        return RunnerResult.TOO_COMPLEX;
      }
      ProgressManager.checkCanceled();
      DfaInstructionState instructionState=queue.remove(0);
      if (LOG.isDebugEnabled()) {
        LOG.debug(instructionState.toString());
      }
      Instruction instruction=instructionState.getInstruction();
      long distance=instructionState.getDistanceFromStart();
      if (instruction instanceof BranchingInstruction) {
        if (!instruction.setMemoryStateProcessed(instructionState.getMemoryState().createCopy())) {
          LOG.debug("Too complex because too many different possible states");
          return RunnerResult.TOO_COMPLEX;
        }
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug(instructionState.toString());
      }
      DfaInstructionState[] after=instruction.accept(this,instructionState.getMemoryState(),visitor);
      if (after != null) {
        for (        DfaInstructionState state : after) {
          Instruction nextInstruction=state.getInstruction();
          if ((!(nextInstruction instanceof BranchingInstruction) || !nextInstruction.isMemoryStateProcessed(state.getMemoryState())) && instruction.getIndex() < endOffset) {
            state.setDistanceFromStart(distance + 1);
            queue.add(state);
          }
        }
      }
      count++;
    }
    psiBlock.putUserData(TOO_EXPENSIVE_SIZE,null);
    LOG.debug("Analysis ok");
    return RunnerResult.OK;
  }
 catch (  ArrayIndexOutOfBoundsException e) {
    LOG.error(psiBlock.getText(),e);
    return RunnerResult.ABORTED;
  }
catch (  EmptyStackException e) {
    if (LOG.isDebugEnabled()) {
      LOG.error(e);
    }
    return RunnerResult.ABORTED;
  }
}
