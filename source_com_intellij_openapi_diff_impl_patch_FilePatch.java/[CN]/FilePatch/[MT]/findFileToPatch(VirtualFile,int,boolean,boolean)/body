{
  VirtualFile file=findFileToPatchByName(patchedDir,skipTopDirs,myBeforeName,createDirectories);
  if (file == null) {
    file=findFileToPatchByName(patchedDir,skipTopDirs,myAfterName,createDirectories);
  }
 else   if (allowRename && !myBeforeName.equals(myAfterName)) {
    String[] beforeNameComponents=myBeforeName.split("/");
    String[] afterNameComponents=myAfterName.split("/");
    if (!beforeNameComponents[beforeNameComponents.length - 1].equals(afterNameComponents[afterNameComponents.length - 1])) {
      file.rename(this,afterNameComponents[afterNameComponents.length - 1]);
    }
    boolean pathChanged=(beforeNameComponents.length != afterNameComponents.length);
    if (!pathChanged) {
      for (int i=skipTopDirs; i < afterNameComponents.length - 1; i++) {
        if (!beforeNameComponents[i].equals(afterNameComponents[i])) {
          pathChanged=true;
          break;
        }
      }
    }
    if (pathChanged) {
      VirtualFile moveTarget=findFileToPatchByComponents(patchedDir,skipTopDirs,afterNameComponents,afterNameComponents.length - 1,createDirectories);
      if (moveTarget == null) {
        return null;
      }
      file.move(this,moveTarget);
    }
  }
  return file;
}
