{
  context.addAffectedFile(getTarget(fileToPatch));
  if (isNewFile()) {
    if (fileToPatch.findChild(getBeforeFileName()) != null) {
      throw new ApplyPatchException("File " + getBeforeFileName() + " already exists");
    }
    VirtualFile newFile=fileToPatch.createChildData(this,getBeforeFileName());
    final Document document=FileDocumentManager.getInstance().getDocument(newFile);
    document.setText(getNewFileText());
    FileDocumentManager.getInstance().saveDocument(document);
  }
 else   if (isDeletedFile()) {
    fileToPatch.delete(this);
  }
 else {
    byte[] fileContents=fileToPatch.contentsToByteArray();
    CharSequence text=LoadTextUtil.getTextByBinaryPresentation(fileContents,fileToPatch);
    StringBuilder newText=new StringBuilder();
    ApplyPatchStatus status=applyModifications(text,newText);
    if (status != ApplyPatchStatus.ALREADY_APPLIED) {
      final Document document=FileDocumentManager.getInstance().getDocument(fileToPatch);
      document.setText(newText.toString());
      FileDocumentManager.getInstance().saveDocument(document);
    }
    return status;
  }
  return ApplyPatchStatus.SUCCESS;
}
