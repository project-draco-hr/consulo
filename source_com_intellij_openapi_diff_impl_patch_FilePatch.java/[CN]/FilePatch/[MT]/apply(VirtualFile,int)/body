{
  String[] pathNameComponents=myBeforeName.split("/");
  VirtualFile fileToPatch=patchedDir;
  int lastComponentToFind=isNewFile() ? pathNameComponents.length - 1 : pathNameComponents.length;
  for (int i=skipTopDirs; i < lastComponentToFind; i++) {
    fileToPatch=fileToPatch.findChild(pathNameComponents[i]);
    if (fileToPatch == null) {
      break;
    }
  }
  if (fileToPatch == null) {
    throw new ApplyPatchException("Cannot find file to patch: " + myBeforeName);
  }
  if (isNewFile()) {
    VirtualFile newFile=fileToPatch.createChildData(this,pathNameComponents[pathNameComponents.length - 1]);
    final Document document=FileDocumentManager.getInstance().getDocument(newFile);
    document.setText(myHunks.get(0).getText());
    FileDocumentManager.getInstance().saveDocument(document);
  }
 else   if (isDeletedFile()) {
    fileToPatch.delete(this);
  }
 else {
    CharSequence text=LoadTextUtil.loadText(fileToPatch);
    List<String> lines=new ArrayList<String>();
    Collections.addAll(lines,LineTokenizer.tokenize(text,false));
    for (    PatchHunk hunk : myHunks) {
      hunk.apply(lines);
    }
    final Document document=FileDocumentManager.getInstance().getDocument(fileToPatch);
    StringBuilder docText=new StringBuilder();
    for (    String line : lines) {
      docText.append(line).append("\n");
    }
    document.setText(docText.toString());
    FileDocumentManager.getInstance().saveDocument(document);
  }
}
