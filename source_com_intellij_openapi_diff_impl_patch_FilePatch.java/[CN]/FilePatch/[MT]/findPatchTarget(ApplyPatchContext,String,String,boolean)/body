{
  VirtualFile file=null;
  if (beforeName != null) {
    file=findFileToPatchByName(context,beforeName,isNewFile);
  }
  if (file == null) {
    file=findFileToPatchByName(context,afterName,isNewFile);
  }
 else   if (context.isAllowRename() && beforeName != null && afterName != null && !beforeName.equals(afterName)) {
    String[] beforeNameComponents=beforeName.split("/");
    String[] afterNameComponents=afterName.split("/");
    if (!beforeNameComponents[beforeNameComponents.length - 1].equals(afterNameComponents[afterNameComponents.length - 1])) {
      file.rename(FilePatch.class,afterNameComponents[afterNameComponents.length - 1]);
    }
    boolean pathChanged=(beforeNameComponents.length != afterNameComponents.length);
    if (!pathChanged) {
      for (int i=context.getSkipTopDirs(); i < afterNameComponents.length - 1; i++) {
        if (!beforeNameComponents[i].equals(afterNameComponents[i])) {
          pathChanged=true;
          break;
        }
      }
    }
    if (pathChanged) {
      VirtualFile moveTarget=findFileToPatchByComponents(context,afterNameComponents,afterNameComponents.length - 1);
      if (moveTarget == null) {
        return null;
      }
      file.move(null,moveTarget);
    }
  }
  return file;
}
