{
  VirtualFile file=null;
  if (beforeName != null) {
    file=findFileToPatchByName(baseDir,skipTopDirs,beforeName,isNewFile,createDirectories);
  }
  if (file == null) {
    file=findFileToPatchByName(baseDir,skipTopDirs,afterName,isNewFile,createDirectories);
  }
 else   if (allowRename && !beforeName.equals(afterName)) {
    String[] beforeNameComponents=beforeName.split("/");
    String[] afterNameComponents=afterName.split("/");
    if (!beforeNameComponents[beforeNameComponents.length - 1].equals(afterNameComponents[afterNameComponents.length - 1])) {
      file.rename(null,afterNameComponents[afterNameComponents.length - 1]);
    }
    boolean pathChanged=(beforeNameComponents.length != afterNameComponents.length);
    if (!pathChanged) {
      for (int i=skipTopDirs; i < afterNameComponents.length - 1; i++) {
        if (!beforeNameComponents[i].equals(afterNameComponents[i])) {
          pathChanged=true;
          break;
        }
      }
    }
    if (pathChanged) {
      VirtualFile moveTarget=findFileToPatchByComponents(baseDir,skipTopDirs,afterNameComponents,afterNameComponents.length - 1,createDirectories);
      if (moveTarget == null) {
        return null;
      }
      file.move(null,moveTarget);
    }
  }
  return file;
}
