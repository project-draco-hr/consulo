{
  Configuration configuration=new DefaultConfiguration();
  configuration.setLocalRepository(localRepo);
  MavenEmbedderConsoleLogger l=new MavenEmbedderConsoleLogger();
  l.setThreshold(MavenEmbedderLogger.LEVEL_WARN);
  configuration.setMavenEmbedderLogger(l);
  final File userSettingsFile=resolveUserSettingsFile(userSettings);
  if (userSettingsFile != null) {
    configuration.setUserSettingsFile(userSettingsFile);
  }
  final File globalSettingsFile=resolveGlobalSettingsFile(mavenHome);
  if (globalSettingsFile != null) {
    configuration.setGlobalSettingsFile(globalSettingsFile);
  }
  configuration.setClassLoader(classLoader);
  ConfigurationValidationResult result=MavenEmbedder.validateConfiguration(configuration);
  if (!result.isValid()) {
    throw new MavenException(Arrays.asList(result.getGlobalSettingsException(),result.getUserSettingsException()));
  }
  System.setProperty(PROP_MAVEN_HOME,mavenHome);
  try {
    return new MavenEmbedder(configuration);
  }
 catch (  MavenEmbedderException e) {
    LOG.info(e);
    throw new MavenException(e);
  }
}
