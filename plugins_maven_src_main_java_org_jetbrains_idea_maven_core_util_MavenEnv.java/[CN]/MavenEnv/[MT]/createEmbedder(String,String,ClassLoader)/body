{
  Configuration configuration=new DefaultConfiguration();
  final File userSettingsFile=resolveUserSettingsFile(userSettings);
  if (userSettingsFile != null) {
    configuration.setUserSettingsFile(userSettingsFile);
  }
  final File globalSettingsFile=resolveGlobalSettingsFile(mavenHome);
  if (globalSettingsFile != null) {
    configuration.setGlobalSettingsFile(globalSettingsFile);
  }
  configuration.setClassLoader(classLoader);
  ConfigurationValidationResult validationResult=MavenEmbedder.validateConfiguration(configuration);
  if (!validationResult.isValid()) {
    throw new MavenEmbedderException(getErrorString(validationResult,globalSettingsFile,userSettingsFile));
  }
  System.setProperty(PROP_MAVEN_HOME,mavenHome);
  return new MavenEmbedder(configuration);
}
