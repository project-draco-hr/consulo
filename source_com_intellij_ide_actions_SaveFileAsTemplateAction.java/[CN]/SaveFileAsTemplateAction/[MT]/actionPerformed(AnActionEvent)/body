{
  DataContext dataContext=e.getDataContext();
  Project project=(Project)dataContext.getData(DataConstants.PROJECT);
  String fileText=(String)dataContext.getData(DataConstants.FILE_TEXT);
  VirtualFile file=(VirtualFile)dataContext.getData(DataConstants.VIRTUAL_FILE);
  String extension=file.getExtension();
  String nameWithoutExtension=file.getNameWithoutExtension();
  AllFileTemplatesConfigurable fileTemplateOptions=new AllFileTemplatesConfigurable();
  ConfigureTemplatesDialog dialog=new ConfigureTemplatesDialog(project,fileTemplateOptions);
  PsiFile psiFile=(PsiFile)dataContext.getData(DataConstants.PSI_FILE);
  if (psiFile instanceof PsiJavaFile) {
    PsiJavaFile javaFile=(PsiJavaFile)psiFile;
    String packageName=javaFile.getPackageName();
    if ((packageName != null) && (packageName.length() > 0)) {
      fileText=StringUtil.replace(fileText,packageName,"${PACKAGE_NAME}");
    }
    PsiClass[] classes=javaFile.getClasses();
    PsiClass psiClass=null;
    if ((classes != null) && (classes.length > 0)) {
      for (int i=0; i < classes.length; i++) {
        PsiClass aClass=classes[i];
        if (nameWithoutExtension.equals(aClass.getName())) {
          psiClass=aClass;
          break;
        }
      }
    }
    if (psiClass != null) {
      fileText=StringUtil.replace(fileText,nameWithoutExtension,"${NAME}");
    }
  }
 else   if (StdFileTypes.GUI_DESIGNER_FORM.equals(FileTypeManager.getInstance().getFileTypeByFile(file))) {
    LwRootContainer rootContainer=null;
    try {
      rootContainer=Utils.getRootContainer(fileText,null);
    }
 catch (    Exception ignored) {
    }
    if (rootContainer != null && rootContainer.getClassToBind() != null) {
      try {
        Document document=JDOMUtil.loadDocument(new StringInputStream(fileText));
        Attribute attribute=document.getRootElement().getAttribute("bind-to-class");
        attribute.detach();
        CharArrayWriter writer=new CharArrayWriter();
        JDOMUtil.writeDocument(document,writer,CodeStyleSettingsManager.getSettings(project).getLineSeparator());
        fileText=writer.toString();
      }
 catch (      Exception ignored) {
      }
    }
  }
  fileTemplateOptions.createNewTemplate(nameWithoutExtension,extension,fileText);
  dialog.show();
}
