{
  CreateFromTemplateDialog dialog;
  try {
    dialog=new CreateFromTemplateDialog(project,directory,template);
  }
 catch (  ParseException ex) {
    String message="Unable to parse template \"" + template.getName() + "\"";
    message+="\nError message: " + ex.getMessage();
    Messages.showMessageDialog(project,message,"Invalid Template",Messages.getErrorIcon());
    LOG.debug(message);
    LOG.debug(ex);
    return null;
  }
  if (needToShowDialog(template)) {
    dialog.show();
    return dialog.getCreatedElement();
  }
 else {
    Properties defaultProperties=FileTemplateManager.getInstance().getDefaultProperties();
    Properties properties=new Properties(defaultProperties);
    String fileName=null;
    LOG.assertTrue(template.isJavaClassTemplate());
    if (template.isJavaClassTemplate()) {
      String packageName=directory.getPackage().getQualifiedName();
      properties.setProperty(FileTemplateUtil.PACKAGE_ATTR,packageName);
    }
    PsiElement[] element=new PsiElement[1];
    try {
      FileTemplateUtil.createFromTemplate(element,template,fileName,properties,project,directory);
    }
 catch (    Exception e) {
      Messages.showMessageDialog(project,e.getMessage(),"Cannot Create " + (template.isJavaClassTemplate() ? "Class" : "File"),Messages.getErrorIcon());
    }
    return element[0];
  }
}
