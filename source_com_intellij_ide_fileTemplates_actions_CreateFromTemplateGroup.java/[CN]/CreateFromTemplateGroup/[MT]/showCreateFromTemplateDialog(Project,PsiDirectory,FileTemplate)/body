{
  CreateFromTemplateDialog dialog;
  try {
    dialog=new CreateFromTemplateDialog(project,directory,template);
  }
 catch (  ParseException ex) {
    String message=IdeBundle.message("error.unable.to.parse.template.message",template.getName(),ex.getMessage());
    Messages.showMessageDialog(project,message,IdeBundle.message("error.invalid.template"),Messages.getErrorIcon());
    LOG.debug(message);
    LOG.debug(ex);
    return null;
  }
  if (needToShowDialog(template)) {
    dialog.show();
    return dialog.getCreatedElement();
  }
 else {
    Properties defaultProperties=FileTemplateManager.getInstance().getDefaultProperties();
    Properties properties=new Properties(defaultProperties);
    LOG.assertTrue(template.isJavaClassTemplate());
    if (template.isJavaClassTemplate()) {
      String packageName=directory.getPackage().getQualifiedName();
      properties.setProperty(FileTemplateUtil.PACKAGE_ATTR,packageName);
    }
    PsiElement[] element=new PsiElement[1];
    try {
      String fileName=null;
      FileTemplateUtil.createFromTemplate(element,template,fileName,properties,project,directory);
    }
 catch (    Exception e) {
      Messages.showMessageDialog(project,e.getMessage(),template.isJavaClassTemplate() ? IdeBundle.message("title.cannot.create.class") : IdeBundle.message("title.cannot.create.file"),Messages.getErrorIcon());
    }
    return element[0];
  }
}
