{
  if (showFlatten) {
    return rootNode;
  }
  final FilePath path=getPathForObject(node.getUserObject());
  if (policy != null) {
    ChangesBrowserNode nodeFromPolicy=policy.getParentNodeFor(node,rootNode);
    if (nodeFromPolicy != null) {
      return nodeFromPolicy;
    }
  }
  FilePath parentPath=path.getParentPath();
  if (parentPath == null) {
    return rootNode;
  }
  ChangesBrowserNode parentNode=folderNodesCache.get(parentPath.getIOFile().getAbsolutePath());
  if (parentNode == null) {
    parentNode=ChangesBrowserNode.create(myProject,parentPath);
    ChangesBrowserNode grandPa=getParentNodeFor(parentNode,folderNodesCache,policy,rootNode);
    model.insertNodeInto(parentNode,grandPa,grandPa.getChildCount());
    folderNodesCache.put(parentPath.getIOFile().getAbsolutePath(),parentNode);
  }
  return parentNode;
}
