{
  final String path=getProject().getBaseDir().getPath() + "/test";
  final Element classpathElement=JDOMUtil.loadDocument(new File(path,EclipseXml.DOT_CLASSPATH_EXT)).getRootElement();
  final Module module=ApplicationManager.getApplication().runWriteAction(new Computable<Module>(){
    public Module compute(){
      return ModuleManager.getInstance(getProject()).newModule(new File(path).getParent() + File.separator + EclipseProjectFinder.findProjectName(path)+ File.separator+ EclipseProjectFinder.findProjectName(path)+ IdeaXml.IML_EXT,StdModuleTypes.JAVA);
    }
  }
);
  final ModifiableRootModel rootModel=ModuleRootManager.getInstance(module).getModifiableModel();
  new EclipseClasspathReader(path,getProject()).readClasspath(rootModel,new ArrayList<String>(),new HashSet<String>(),null,classpathElement);
  rootModel.commit();
  final RootModelImpl model=(RootModelImpl)ModuleRootManager.getInstance(module).getModifiableModel();
  final Element actualImlElement=new Element("root");
  model.writeExternal(actualImlElement);
  model.dispose();
  PathMacroManager.getInstance(module).collapsePaths(actualImlElement);
  PathMacroManager.getInstance(getProject()).collapsePaths(actualImlElement);
  final Element expectedIml=JDOMUtil.loadDocument(new File(getProject().getBaseDir().getPath() + "/expected","expected.iml")).getRootElement();
  Assert.assertTrue(new String(JDOMUtil.printDocument(new Document(actualImlElement),"\n")),JDOMUtil.areElementsEqual(expectedIml,actualImlElement));
}
