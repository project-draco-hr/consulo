{
  ApplicationManager.getApplication().assertIsDispatchThread();
  List<LineMarkerInfo> oldMarkers=DaemonCodeAnalyzerImpl.getLineMarkers(document,project);
  List<LineMarkerInfo> array=new ArrayList<LineMarkerInfo>(Math.max(markers.size(),oldMarkers.size()));
  MarkupModel markupModel=DocumentMarkupModel.forDocument(document,project,true);
  HighlightersRecycler toReuse=new HighlightersRecycler();
  for (  LineMarkerInfo info : oldMarkers) {
    RangeHighlighter highlighter=info.highlighter;
    boolean toRemove=!highlighter.isValid() || info.updatePass == group && TextRange.containsRange(bounds,highlighter);
    if (toRemove) {
      toReuse.recycleHighlighter(highlighter);
    }
 else {
      array.add(info);
    }
  }
  for (  LineMarkerInfo info : markers) {
    PsiElement element=info.getElement();
    if (element == null) {
      continue;
    }
    TextRange textRange=element.getTextRange();
    if (textRange == null)     continue;
    TextRange elementRange=InjectedLanguageManager.getInstance(project).injectedToHost(element,textRange);
    if (!TextRange.containsRange(bounds,elementRange)) {
      continue;
    }
    RangeHighlighter marker=toReuse.pickupHighlighterFromGarbageBin(info.startOffset,info.endOffset,HighlighterLayer.ADDITIONAL_SYNTAX);
    if (marker == null) {
      marker=markupModel.addRangeHighlighter(info.startOffset,info.endOffset,HighlighterLayer.ADDITIONAL_SYNTAX,null,HighlighterTargetArea.LINES_IN_RANGE);
    }
    LineMarkerInfo.LineMarkerGutterIconRenderer renderer=(LineMarkerInfo.LineMarkerGutterIconRenderer)info.createGutterRenderer();
    LineMarkerInfo.LineMarkerGutterIconRenderer oldRenderer=marker.getGutterIconRenderer() instanceof LineMarkerInfo.LineMarkerGutterIconRenderer ? (LineMarkerInfo.LineMarkerGutterIconRenderer)marker.getGutterIconRenderer() : null;
    if (oldRenderer == null || renderer == null || !renderer.equals(oldRenderer)) {
      marker.setGutterIconRenderer(renderer);
    }
    if (!Comparing.equal(marker.getLineSeparatorColor(),info.separatorColor)) {
      marker.setLineSeparatorColor(info.separatorColor);
    }
    if (!Comparing.equal(marker.getLineSeparatorPlacement(),info.separatorPlacement)) {
      marker.setLineSeparatorPlacement(info.separatorPlacement);
    }
    info.highlighter=marker;
    array.add(info);
  }
  for (  RangeHighlighter highlighter : toReuse.forAllInGarbageBin()) {
    highlighter.dispose();
  }
  DaemonCodeAnalyzerImpl.setLineMarkers(document,array,project);
}
