{
  final ActionCallback result=new ActionCallback();
  Object selectedObject=getSelected();
  final Ref<Object> toSelect=new Ref<Object>(isSelectable(selectedObject) ? selectedObject : null);
  if (preferredSelection != null) {
    toSelect.set(preferredSelection);
  }
  ((FilteringTreeStructure)getTreeStructure()).refilter();
  updateFromRoot();
  result.setDone();
  if (adjustSelection) {
    boolean wasSelected=false;
    if (toSelect.get() != null && isSelectable(toSelect.get()) && isSimpleTree()) {
      wasSelected=((SimpleTree)myTree).select(this,new SimpleNodeVisitor(){
        public boolean accept(        SimpleNode simpleNode){
          if (simpleNode instanceof FilteringTreeStructure.Node) {
            FilteringTreeStructure.Node node=(FilteringTreeStructure.Node)simpleNode;
            return node.getDelegate().equals(toSelect.get());
          }
 else {
            return false;
          }
        }
      }
,true);
    }
    if (!wasSelected && isSimpleTree()) {
      ((SimpleTree)myTree).select(this,new SimpleNodeVisitor(){
        public boolean accept(        SimpleNode simpleNode){
          if (simpleNode instanceof FilteringTreeStructure.Node) {
            final boolean isRoot=getTreeStructure().getRootElement() == simpleNode;
            if (isRoot && !myTree.isRootVisible())             return false;
            FilteringTreeStructure.Node node=(FilteringTreeStructure.Node)simpleNode;
            if (isSelectable(node.getDelegate())) {
              return true;
            }
          }
 else {
            return false;
          }
          return false;
        }
      }
,true);
    }
    if (!wasSelected && myLastSuccessfulSelect != null && isSimpleTree()) {
      wasSelected=((SimpleTree)myTree).select(this,new SimpleNodeVisitor(){
        public boolean accept(        SimpleNode simpleNode){
          if (simpleNode instanceof FilteringTreeStructure.Node) {
            Object object=((FilteringTreeStructure.Node)simpleNode).getDelegate();
            return myLastSuccessfulSelect.equals(object);
          }
          return false;
        }
      }
,true);
      if (wasSelected) {
        myLastSuccessfulSelect=getSelected();
      }
    }
 else     if (wasSelected) {
      myLastSuccessfulSelect=getSelected();
    }
  }
  return result;
}
