{
  if (myRefilterQueue != null) {
    myRefilterQueue.cancelAllUpdates();
  }
  final ActionCallback callback=new ActionCallback();
  final Runnable afterCancelUpdate=new Runnable(){
    @Override public void run(){
      if (myRefilterQueue == null || now) {
        refilterNow(preferredSelection,adjustSelection).doWhenDone(new Runnable(){
          @Override public void run(){
            callback.setDone();
          }
        }
);
      }
 else {
        myRefilterQueue.queue(new Update(this){
          public void run(){
            refilterNow(preferredSelection,adjustSelection).notifyWhenDone(callback);
          }
          @Override public void setRejected(){
            super.setRejected();
            callback.setDone();
          }
        }
);
      }
    }
  }
;
  if (!isDisposed()) {
    if (!ApplicationManager.getApplication().isUnitTestMode()) {
      getUi().cancelUpdate().doWhenProcessed(afterCancelUpdate);
    }
 else {
      afterCancelUpdate.run();
    }
  }
  return callback;
}
