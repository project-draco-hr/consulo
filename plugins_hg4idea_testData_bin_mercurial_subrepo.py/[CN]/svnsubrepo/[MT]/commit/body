def commit(self, text, user, date):
    (changed, extchanged) = self._wcchanged()
    if (not changed):
        return self._wcrev()
    if extchanged:
        raise util.Abort(_('cannot commit svn externals'))
    commitinfo = self._svncommand(['commit', '-m', text])
    self._ui.status(commitinfo)
    newrev = re.search('Committed revision ([\\d]+).', commitinfo)
    if (not newrev):
        raise util.Abort(commitinfo.splitlines()[(-1)])
    newrev = newrev.groups()[0]
    self._ui.status(self._svncommand(['update', '-r', newrev]))
    return newrev
