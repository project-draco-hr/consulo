{
  if (files == null || files.length == 0) {
    return VirtualFile.EMPTY_ARRAY;
  }
  final PsiManager psiManager=PsiManager.getInstance(project);
  final CompilerConfiguration compilerConfiguration=CompilerConfiguration.getInstance(project);
  final FileTypeManager typeManager=FileTypeManager.getInstance();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final List<VirtualFile> filesToCompile=new ArrayList<VirtualFile>();
  for (int idx=0; idx < files.length; idx++) {
    final VirtualFile file=files[idx];
    if (!fileIndex.isInSourceContent(file)) {
      continue;
    }
    if (!(file.getFileSystem() instanceof LocalFileSystem)) {
      continue;
    }
    if (file.isDirectory()) {
      final PsiDirectory directory=psiManager.findDirectory(file);
      if (directory == null || directory.getPackage() == null) {
        continue;
      }
    }
 else {
      FileType fileType=typeManager.getFileTypeByFile(file);
      if (!(StdFileTypes.JAVA.equals(fileType) || compilerConfiguration.isResourceFile(file.getName()))) {
        continue;
      }
    }
    filesToCompile.add(file);
  }
  return filesToCompile.size() > 0 ? filesToCompile.toArray(new VirtualFile[filesToCompile.size()]) : VirtualFile.EMPTY_ARRAY;
}
