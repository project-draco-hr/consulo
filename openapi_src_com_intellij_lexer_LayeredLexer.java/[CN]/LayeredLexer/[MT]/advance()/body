{
  if (isLayerActive()) {
    IElementType layerTokenType=myCurrentLayerLexer.getTokenType();
    if (!isStopToken(myCurrentLayerLexer,layerTokenType)) {
      myCurrentLayerLexer.advance();
      layerTokenType=myCurrentLayerLexer.getTokenType();
    }
 else {
      layerTokenType=null;
    }
    if (layerTokenType == null) {
      int tokenEnd=myCurrentLayerLexer.getTokenEnd();
      if (!mySelfStoppingLexers.contains(myCurrentLayerLexer)) {
        myCurrentLayerLexer=null;
        myBaseLexer.advance();
        activateLayerIfNecessary();
      }
 else {
        myCurrentLayerLexer=null;
        myBaseLexer.start(myBuffer,tokenEnd,getBufferEnd());
      }
    }
  }
 else {
    myBaseLexer.advance();
    activateLayerIfNecessary();
  }
  myStateToReturn=calcState();
}
