{
  PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  int[] toIgnore=doFolding() ? ArrayUtil.EMPTY_INT_ARRAY : new int[]{Pass.UPDATE_FOLDING};
  Editor editor=getEditor();
  PsiFile file=getFile();
  if (editor instanceof EditorWindow) {
    editor=((EditorWindow)editor).getDelegate();
    file=InjectedLanguageUtil.getTopLevelFile(file);
  }
  return CodeInsightTestFixtureImpl.instantiateAndRun(file,editor,toIgnore,false);
}
