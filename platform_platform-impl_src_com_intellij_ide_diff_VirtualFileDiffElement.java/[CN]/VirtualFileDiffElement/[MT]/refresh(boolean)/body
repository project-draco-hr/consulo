{
  if (userInitiated) {
    final List<Document> docsToSave=new ArrayList<Document>();
    final FileDocumentManager manager=FileDocumentManager.getInstance();
    for (    Document document : manager.getUnsavedDocuments()) {
      VirtualFile file=manager.getFile(document);
      if (file != null && VfsUtilCore.isAncestor(myFile,file,false)) {
        docsToSave.add(document);
      }
    }
    if (!docsToSave.isEmpty()) {
      ApplicationManager.getApplication().invokeAndWait(new Runnable(){
        @Override public void run(){
          AccessToken token=WriteAction.start();
          try {
            for (            Document document : docsToSave) {
              manager.saveDocument(document);
            }
          }
  finally {
            token.finish();
          }
        }
      }
,ModalityState.defaultModalityState());
    }
  }
  if (!FileWatcher.getInstance().isWatched(myFile)) {
    ((NewVirtualFile)myFile).markDirtyRecursively();
  }
  myFile.refresh(false,true);
}
