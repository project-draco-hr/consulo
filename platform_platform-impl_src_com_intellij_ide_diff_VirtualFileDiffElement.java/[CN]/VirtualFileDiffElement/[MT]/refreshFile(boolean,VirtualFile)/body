{
  if (userInitiated) {
    final List<Document> docsToSave=new ArrayList<Document>();
    final FileDocumentManager manager=FileDocumentManager.getInstance();
    for (    Document document : manager.getUnsavedDocuments()) {
      VirtualFile file=manager.getFile(document);
      if (file != null && VfsUtilCore.isAncestor(virtualFile,file,false)) {
        docsToSave.add(document);
      }
    }
    if (!docsToSave.isEmpty()) {
      AccessToken token=WriteAction.start();
      try {
        for (        Document document : docsToSave) {
          manager.saveDocument(document);
        }
      }
  finally {
        token.finish();
      }
    }
    if (!FileWatcher.getInstance().isWatched(virtualFile)) {
      ((NewVirtualFile)virtualFile).markDirtyRecursively();
    }
    virtualFile.refresh(true,true);
  }
}
