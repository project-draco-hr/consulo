{
  XDebuggerEditorsProvider editorsProvider=session.getDebugProcess().getEditorsProvider();
  XStackFrame stackFrame=session.getCurrentStackFrame();
  if (stackFrame == null || editorsProvider == null)   return;
  final XDebuggerEvaluator evaluator=stackFrame.getEvaluator();
  if (evaluator == null)   return;
  Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  String expression=editor != null ? editor.getSelectionModel().getSelectedText() : null;
  if (expression == null) {
    XValue value=XDebuggerTreeActionBase.getSelectedValue(dataContext);
    if (value != null) {
      expression=value.getEvaluationExpression();
    }
  }
  if (expression == null) {
    expression="";
  }
  final EvaluationDialogMode mode=expression.indexOf('\n') == -1 ? EvaluationDialogMode.EXPRESSION : EvaluationDialogMode.CODE_FRAGMENT;
  final XDebuggerEvaluationDialog dialog=new XDebuggerEvaluationDialog(session,editorsProvider,evaluator,expression,mode,stackFrame.getSourcePosition());
  dialog.show();
}
