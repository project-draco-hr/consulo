{
  String lineSeparator=file.getUserData(DETECTED_LINE_SEPARATOR_KEY);
  if (lineSeparator != null && lineSeparator.equals(newLineSeparator)) {
    return;
  }
  CharSequence cs=getTextByBinaryPresentation(file.contentsToByteArray(),file);
  lineSeparator=file.getUserData(DETECTED_LINE_SEPARATOR_KEY);
  if (lineSeparator == null || lineSeparator.equals(newLineSeparator)) {
    return;
  }
  if (!newLineSeparator.equals("\n")) {
    cs=StringUtil.convertLineSeparators(cs.toString(),newLineSeparator);
  }
  String text=cs.toString();
  file.putUserData(DETECTED_LINE_SEPARATOR_KEY,newLineSeparator);
  Writer w=getWriter(project,file,requestor,text,System.currentTimeMillis());
  try {
    w.write(text);
  }
  finally {
    w.close();
  }
}
