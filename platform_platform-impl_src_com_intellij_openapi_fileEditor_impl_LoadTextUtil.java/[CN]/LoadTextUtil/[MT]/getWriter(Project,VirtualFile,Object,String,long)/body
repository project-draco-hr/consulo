{
  Charset existing=virtualFile.getCharset();
  Charset specified=extractCharsetFromFileContent(project,virtualFile,text);
  Charset charset=chooseMostlyHarmlessCharset(existing,specified,text);
  if (charset != null && !charset.equals(existing)) {
    virtualFile.setCharset(charset);
    if (virtualFile.getBOM() != null) {
      setUtfCharsetWasDetectedFromBytes(virtualFile,true);
    }
  }
  OutputStream outputStream=virtualFile.getOutputStream(requestor,newModificationStamp,-1);
  return new BufferedWriter(charset == null ? new OutputStreamWriter(outputStream) : new OutputStreamWriter(outputStream,charset));
}
