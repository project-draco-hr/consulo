{
  threadFinished=false;
  while (!isDisposed) {
    try {
      boolean success=false;
      Document document=null;
      Project project=null;
      ProgressIndicator indicator=null;
      try {
synchronized (documentsToCommit) {
          if (!myEnabled || documentsToCommit.isEmpty()) {
            documentsToCommit.wait();
            continue;
          }
          CommitTask task=documentsToCommit.pullFirst();
          document=task.document;
          indicator=task.indicator;
          project=task.project;
          log("Pulled",document,false,indicator);
          if (getCommitStage(document) != CommitStage.QUEUED_TO_COMMIT || project.isDisposed() || !ArrayUtil.contains(document,PsiDocumentManager.getInstance(project).getUncommittedDocuments())) {
            continue;
          }
          if (indicator.isRunning()) {
            useIndicator(indicator);
            document.putUserData(COMMIT_PROGRESS,indicator);
          }
 else {
            success=true;
          }
        }
        Runnable finishRunnable=null;
        if (!success && !indicator.isCanceled()) {
          try {
            finishRunnable=commit(document,project,null,indicator,false);
            success=finishRunnable != null;
            log("Committed",document,false,finishRunnable,indicator);
          }
  finally {
            document.putUserData(COMMIT_PROGRESS,null);
          }
        }
synchronized (documentsToCommit) {
          if (indicator.isCanceled()) {
            success=false;
          }
          if (success) {
            UIUtil.invokeLaterIfNeeded(finishRunnable);
          }
          log("Invoked later",document,false,success,finishRunnable,indicator);
        }
      }
 catch (      ProcessCanceledException ignored) {
        int i=0;
        cancel(ignored);
        log("PCE",document,false,ignored);
        success=false;
      }
catch (      InterruptedException ignored) {
        int i=0;
        log("IE",document,false,ignored);
        cancel(ignored);
      }
catch (      Throwable e) {
        LOG.error(e);
        cancel(e);
      }
      if (!success && indicator.isRunning()) {
        doQueue(document,project,CommitStage.QUEUED_TO_COMMIT,"re-added on failure");
      }
    }
 catch (    Throwable e) {
      e.printStackTrace();
    }
  }
  threadFinished=true;
  wakeUpQueue();
  log("Good bye",null,false);
}
