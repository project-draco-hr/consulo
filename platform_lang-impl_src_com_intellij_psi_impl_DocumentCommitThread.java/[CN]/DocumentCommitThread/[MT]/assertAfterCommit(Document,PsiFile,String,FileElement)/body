{
  if (myTreeElementBeingReparsedSoItWontBeCollected.getTextLength() != document.getTextLength()) {
    final String documentText=document.getText();
    if (ApplicationManagerEx.getApplicationEx().isInternal()) {
      String fileText=file.getText();
      LOG.error("commitDocument left PSI inconsistent; file len=" + myTreeElementBeingReparsedSoItWontBeCollected.getTextLength() + "; doc len="+ document.getTextLength()+ "; doc.getText() == file.getText(): "+ Comparing.equal(fileText,documentText)+ ";\n file psi text="+ fileText+ ";\n doc text="+ documentText+ ";\n old psi file text="+ oldPsiText);
    }
 else {
      LOG.error("commitDocument left PSI inconsistent: " + file);
    }
    file.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,Boolean.TRUE);
    try {
      BlockSupport blockSupport=BlockSupport.getInstance(file.getProject());
      final DiffLog diffLog=blockSupport.reparseRange(file,0,documentText.length(),0,documentText,new ProgressIndicatorBase());
      file.getManager().performActionWithFormatterDisabled(new Runnable(){
        @Override public void run(){
synchronized (PsiLock.LOCK) {
            diffLog.doActualPsiChange(file);
          }
        }
      }
);
      if (myTreeElementBeingReparsedSoItWontBeCollected.getTextLength() != document.getTextLength()) {
        LOG.error("PSI is broken beyond repair in: " + file);
      }
    }
  finally {
      file.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,null);
    }
  }
}
