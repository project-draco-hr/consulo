{
  first=((TreeElement)first).getTransformedFirstOrSelf();
  final PsiFile file=first.getPsi().getContainingFile();
  final Language language=file.getLanguage();
  final FormattingModelBuilder builder=language.getFormattingModelBuilder();
  if (builder != null) {
    final CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(file.getProject());
    final FormattingModel model=builder.createModel(file,settings);
    ASTNode current=first;
    while (current != lastChild) {
      final IElementType elementType=current.getElementType();
      if (elementType != ElementType.WHITE_SPACE && elementType != ElementType.DOC_COMMENT_LEADING_ASTERISKS && elementType != ElementType.DOC_TAG && current.getTextLength() > 0) {
        FormatterEx.getInstanceEx().saveIndents(model,current.getTextRange(),new MyIndentInfoStorage(file,dirtyElements),settings,settings.getIndentOptions(file.getFileType()));
      }
      current=current.getTreeNext();
    }
  }
}
