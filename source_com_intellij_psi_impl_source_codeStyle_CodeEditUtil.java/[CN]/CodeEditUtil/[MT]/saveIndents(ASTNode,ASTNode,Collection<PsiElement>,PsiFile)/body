{
  first=transform(first);
  final PsiFile newElementFile=transformToPsiElement(first).getContainingFile();
  final Language language=newElementFile.getLanguage();
  final FormattingModelBuilder builder=language.getFormattingModelBuilder();
  if (builder != null) {
    final CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(file.getProject());
    final FormattingModel model=builder.createModel(newElementFile,settings);
    ASTNode current=first;
    while (current != null && current != lastChild) {
      final IElementType elementType=current.getElementType();
      if (elementType != ElementType.WHITE_SPACE && elementType != ElementType.DOC_COMMENT_LEADING_ASTERISKS && elementType != ElementType.DOC_TAG && current.getTextLength() > 0) {
        FormatterEx.getInstanceEx().saveIndents(model,current.getTextRange(),new MyIndentInfoStorage(newElementFile,dirtyElements),settings,settings.getIndentOptions(file.getFileType()));
      }
      current=current.getTreeNext();
    }
  }
}
