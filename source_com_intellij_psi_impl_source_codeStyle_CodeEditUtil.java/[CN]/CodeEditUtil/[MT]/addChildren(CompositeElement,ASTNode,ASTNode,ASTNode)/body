{
  LOG.assertTrue(first != null);
  checkAllWhiteSpaces(parent);
  ASTNode lastChild=last != null ? last.getTreeNext() : null;
  final ArrayList<PsiElement> dirtyElements=new ArrayList<PsiElement>();
  final List<ASTNode> treePrev;
  try {
    ASTNode nextElement=saveIndentsBeforeAdd(first,lastChild,anchorBefore,parent,dirtyElements);
    first=trimWhiteSpaces(first,lastChild);
    if (first == null) {
      return null;
    }
    boolean keepFirstIndent=keepFirstIndent(parent,anchorBefore,first,lastChild);
    parent.addChildren(first,lastChild,anchorBefore);
    treePrev=getPreviousElements(first);
    if (!FormatterUtil.join(TreeUtil.prevLeaf(first),first)) {
      adjustWhiteSpaces(first,anchorBefore,keepFirstIndent);
    }
    if (nextElement != null) {
      if (!FormatterUtil.join(TreeUtil.prevLeaf(nextElement),nextElement)) {
        adjustWhiteSpaces(nextElement,nextElement.getTreeNext(),false);
      }
    }
  }
  finally {
    clearIndentInfo(dirtyElements);
  }
  checkAllWhiteSpaces(parent);
  return returnFirstChangedNode(treePrev,parent);
}
