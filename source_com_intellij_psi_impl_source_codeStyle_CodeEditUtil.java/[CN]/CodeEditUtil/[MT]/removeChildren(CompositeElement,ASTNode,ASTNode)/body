{
  final CharTable charTableByTree=SharedImplUtil.findCharTableByTree(parent);
  final PsiManager manager=parent.getManager();
  final Project project=manager.getProject();
  CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(project);
  final PsiFile file=SourceTreeToPsiMap.treeElementToPsi(parent).getContainingFile();
  FileType fileType=file.getFileType();
  Helper helper=new Helper(fileType,project);
  CodeFormatterFacade codeLayouter=new CodeFormatterFacade(settings,helper);
  IndentAdjusterFacade indentAdjuster=new IndentAdjusterFacade(settings,helper);
  ASTNode prev=first.getTreePrev();
  ASTNode next=last.getTreeNext();
  ASTNode prevNonSpace=Helper.shiftBackwardToNonSpace(prev);
  ASTNode nextNonSpace=Helper.shiftForwardToNonSpace(next);
  ASTNode spaceBefore=Helper.getSpaceElement(parent,prevNonSpace,first);
  ASTNode spaceAfter=Helper.getSpaceElement(parent,last,nextNonSpace);
  ASTNode childNext;
  for (ASTNode child=first; child != next; child=childNext) {
    childNext=child.getTreeNext();
    parent.removeChild(child);
  }
  if (fileType == StdFileTypes.XHTML)   return;
  if (prevNonSpace == null && nextNonSpace == null) {
    if (spaceBefore != null) {
      parent.removeChild(spaceBefore);
    }
    if (spaceAfter != null) {
      parent.removeChild(spaceAfter);
    }
    LOG.assertTrue(parent.getTextLength() == 0);
    ASTNode elementBefore=Helper.shiftBackwardToNonSpace(parent.getTreePrev());
    ASTNode elementAfter=Helper.shiftForwardToNonSpace(parent.getTreeNext());
    normalizeSpace(helper,parent.getTreeParent(),elementBefore,elementAfter,charTableByTree);
    elementAfter=codeLayouter.processSpace(elementBefore,elementAfter);
    if (elementAfter != null) {
      elementAfter=indentAdjuster.adjustFirstLineIndent(elementAfter);
    }
    return;
  }
  int breaksBefore=spaceBefore != null ? StringUtil.getLineBreakCount(spaceBefore.getText()) : 0;
  int breaksAfter=spaceAfter != null ? StringUtil.getLineBreakCount(spaceAfter.getText()) : 0;
  normalizeSpace(helper,parent,prevNonSpace,nextNonSpace,charTableByTree);
  int newBreaks=Math.max(breaksBefore,breaksAfter);
  if (newBreaks != breaksBefore + breaksAfter) {
    helper.makeLineBreaks(parent,prevNonSpace,nextNonSpace,newBreaks);
  }
  nextNonSpace=codeLayouter.processSpace(prevNonSpace,nextNonSpace);
  if (nextNonSpace != null) {
    nextNonSpace=indentAdjuster.adjustFirstLineIndent(nextNonSpace);
  }
}
