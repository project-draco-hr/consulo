{
  final FormattingModelBuilder builder=language.getFormattingModelBuilder();
  final PsiElement element=file.findElementAt(tokenStartOffset);
  if (builder != null && element.getLanguage().getFormattingModelBuilder() != null) {
    final TextRange textRange=element.getTextRange();
    final FormattingModel model=builder.createModel(file,settings);
    return Formatter.getInstance().getWhiteSpaceBefore(model.getDocumentModel(),model.getRootBlock(),settings,settings.getIndentOptions(file.getFileType()),textRange,mayChangeLineFeeds);
  }
 else {
    final PseudoTextBuilder pseudoTextBuilder=language.getFormatter();
    LOG.assertTrue(pseudoTextBuilder != null);
    final PseudoText pseudoText=pseudoTextBuilder.build(project,settings,file);
    return GeneralCodeFormatter.getWhiteSpaceBetweenTokens(pseudoText,settings,file.getFileType(),tokenStartOffset,mayChangeLineFeeds);
  }
}
