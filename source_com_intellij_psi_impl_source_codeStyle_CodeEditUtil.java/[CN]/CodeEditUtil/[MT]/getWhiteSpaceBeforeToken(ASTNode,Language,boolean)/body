{
  LOG.assertTrue(tokenNode != null);
  final PsiElement secondAsPsiElement=SourceTreeToPsiMap.treeElementToPsi(tokenNode);
  LOG.assertTrue(secondAsPsiElement != null);
  final PsiFile file=secondAsPsiElement.getContainingFile();
  final PseudoTextBuilder pseudoTextBuilder=language.getFormatter();
  LOG.assertTrue(pseudoTextBuilder != null);
  final Project project=secondAsPsiElement.getProject();
  final CodeStyleSettings settings=CodeStyleSettingsManager.getInstance(project).getCurrentSettings();
  final int endOffset=tokenNode.getStartOffset();
  final boolean oldValue=settings.XML_KEEP_LINE_BREAKS;
  settings.XML_KEEP_LINE_BREAKS=false;
  try {
    final PseudoText pseudoText=pseudoTextBuilder.build(project,settings,file);
    return GeneralCodeFormatter.getWhiteSpaceBetweenTokens(pseudoText,settings,file.getFileType(),endOffset,ignoreAlignment);
  }
  finally {
    settings.XML_KEEP_LINE_BREAKS=oldValue;
  }
}
