{
  LOG.assertTrue(tokenNode != null);
  Language language=file.getLanguage();
  final Project project=file.getProject();
  final CodeStyleSettings settings=CodeStyleSettingsManager.getInstance(project).getCurrentSettings();
  final int tokenStartOffset=tokenNode.getStartOffset();
  final boolean oldValue=settings.XML_KEEP_LINE_BREAKS;
  final int oldKeepBlankLines=settings.XML_KEEP_BLANK_LINES;
  settings.XML_KEEP_BLANK_LINES=0;
  try {
    final FormattingModelBuilder builder=language.getEffectiveFormattingModelBuilder(file);
    final PsiElement element=file.findElementAt(tokenStartOffset);
    if (builder != null && element.getLanguage().getEffectiveFormattingModelBuilder(element) != null) {
      final TextRange textRange=element.getTextRange();
      final FormattingModel model=builder.createModel(file,settings);
      return FormatterEx.getInstanceEx().getWhiteSpaceBefore(model.getDocumentModel(),model.getRootBlock(),settings,settings.getIndentOptions(file.getFileType()),textRange,mayChangeLineFeeds);
    }
 else {
      return new IndentInfo(0,0,0);
    }
  }
  finally {
    settings.XML_KEEP_LINE_BREAKS=oldValue;
    settings.XML_KEEP_BLANK_LINES=oldKeepBlankLines;
  }
}
