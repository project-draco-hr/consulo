{
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  final ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(module);
  VfsUtilCore.visitChildrenRecursively(dir,new VirtualFileVisitor(){
    @Override public boolean visitFile(    @NotNull VirtualFile dir){
      if (!dir.isDirectory() || fileTypeManager.isFileIgnored(dir)) {
        return false;
      }
      final boolean isIncluded=moduleRootManager.getFileIndex().isInContent(dir);
      if (isIncluded != parentIncluded) {
        final String relativePath=VfsUtilCore.getRelativePath(dir,root,'/');
        if (isIncluded) {
          generator.add(new Include(relativePath + "/**"));
        }
 else {
          if (!isExcludedByDefault(dir.getName())) {
            generator.add(new Exclude(relativePath + "/**"));
          }
        }
      }
      return true;
    }
  }
);
}
