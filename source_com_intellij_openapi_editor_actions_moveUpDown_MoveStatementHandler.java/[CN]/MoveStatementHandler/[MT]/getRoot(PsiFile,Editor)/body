{
  if (file == null || editor == null)   return null;
  int offset=editor.getCaretModel().getOffset();
  if (offset == editor.getDocument().getTextLength())   offset--;
  if (offset < 0)   return null;
  PsiElement leafElement=file.findElementAt(offset);
  if (leafElement == null)   return null;
  ASTNode node=leafElement.getNode();
  if (node == null)   return null;
  return (PsiFile)PsiUtil.getRoot(node).getPsi();
}
