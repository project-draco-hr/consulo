{
  final PsiElement element=location.getPsiElement();
  final PsiFile file=element.getContainingFile();
  if (!(file instanceof GroovyFile)) {
    return null;
  }
  GroovyFile groovyFile=(GroovyFile)file;
  if (groovyFile.isScript()) {
    mySourceElement=element;
    final PsiClass scriptClass=getScriptClass(location.getPsiElement());
    if (scriptClass == null)     return null;
    final RunnerAndConfigurationSettings settings=createConfiguration(scriptClass);
    if (settings != null) {
      final GroovyScriptRunConfiguration configuration=(GroovyScriptRunConfiguration)settings.getConfiguration();
      GroovyScriptTypeDetector.getScriptType(groovyFile).tuneConfiguration(groovyFile,configuration,location);
      return settings;
    }
  }
  if (!file.getText().contains("@Grab"))   return null;
  ApplicationConfigurationProducer producer=new ApplicationConfigurationProducer();
  RunnerAndConfigurationSettings settings=producer.createConfigurationByElement(location,context);
  if (settings != null) {
    PsiElement src=producer.getSourceElement();
    mySourceElement=src;
    return createConfiguration(src instanceof PsiMethod ? ((PsiMethod)src).getContainingClass() : (PsiClass)src);
  }
  return null;
}
