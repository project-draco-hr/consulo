{
  ArrayList<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  if (!isFlatten || !skipDirectory(psiDirectory)) {
    final Iterator<PsiFile> iterator=builder.getFiles(psiDirectory);
    while (iterator.hasNext()) {
      final PsiFile psiFile=iterator.next();
      final PsiDirectory containingDirectory=psiFile.getContainingDirectory();
      TodoFileNode todoFileNode=new TodoFileNode(getProject(),psiFile,builder,false);
      if (psiDirectory.equals(containingDirectory) && !children.contains(todoFileNode)) {
        children.add(todoFileNode);
        continue;
      }
      PsiDirectory _dir=psiFile.getContainingDirectory();
      while (_dir != null) {
        if (skipDirectory(_dir)) {
          break;
        }
        final PsiDirectory parentDirectory=_dir.getParentDirectory();
        TodoDirNode todoDirNode=new TodoDirNode(getProject(),_dir,builder);
        if (parentDirectory != null && psiDirectory.equals(parentDirectory) && !children.contains(todoDirNode)) {
          children.add(todoDirNode);
          break;
        }
        _dir=parentDirectory;
      }
    }
  }
 else {
    final PsiDirectory parentDirectory=psiDirectory.getParentDirectory();
    if (parentDirectory == null || !skipDirectory(parentDirectory) || !ProjectRootManager.getInstance(getProject()).getFileIndex().isInContent(parentDirectory.getVirtualFile())) {
      final Iterator<PsiFile> iterator=builder.getFiles(psiDirectory);
      while (iterator.hasNext()) {
        final PsiFile psiFile=iterator.next();
        TodoFileNode todoFileNode=new TodoFileNode(getProject(),psiFile,builder,false);
        if (psiDirectory.equals(psiFile.getContainingDirectory()) && !children.contains(todoFileNode)) {
          children.add(todoFileNode);
          continue;
        }
        final PsiDirectory _dir=psiFile.getContainingDirectory();
        if (skipDirectory(_dir)) {
          continue;
        }
        TodoDirNode todoDirNode=new TodoDirNode(getProject(),_dir,builder);
        if (PsiTreeUtil.isAncestor(psiDirectory,_dir,true) && !children.contains(todoDirNode) && !builder.isDirectoryEmpty(_dir)) {
          children.add(todoDirNode);
        }
      }
    }
 else {
      final Iterator<PsiFile> iterator=builder.getFiles(psiDirectory);
      while (iterator.hasNext()) {
        final PsiFile psiFile=iterator.next();
        final PsiDirectory containingDirectory=psiFile.getContainingDirectory();
        TodoFileNode todoFileNode=new TodoFileNode(getProject(),psiFile,builder,false);
        if (psiDirectory.equals(containingDirectory) && !children.contains(todoFileNode)) {
          children.add(todoFileNode);
        }
      }
    }
  }
  Collections.sort(children,TodoFileDirAndModuleComparator.INSTANCE);
  return children;
}
