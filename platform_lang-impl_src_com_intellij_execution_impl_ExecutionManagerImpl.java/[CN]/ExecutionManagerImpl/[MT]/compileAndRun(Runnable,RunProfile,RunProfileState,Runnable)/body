{
  if (configuration instanceof RunConfiguration) {
    final RunConfiguration runConfiguration=(RunConfiguration)configuration;
    final RunManagerImpl runManager=RunManagerImpl.getInstanceImpl(myProject);
    final List<BeforeRunTask> activeTasks=new ArrayList<BeforeRunTask>();
    final List<BeforeRunTask> tasks=runManager.getBeforeRunTasks(runConfiguration);
    for (    BeforeRunTask task : tasks) {
      if (task != null && task.isEnabled()) {
        activeTasks.add(task);
      }
    }
    ConfigurationPerRunnerSettings configurationSettings=state != null ? state.getConfigurationSettings() : null;
    final DataContext projectContext=SimpleDataContext.getProjectContext(myProject);
    final DataContext dataContext=configurationSettings != null ? SimpleDataContext.getSimpleContext(BeforeRunTaskProvider.RUNNER_ID,configurationSettings.getRunnerId(),projectContext) : projectContext;
    if (!activeTasks.isEmpty()) {
      ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
        public void run(){
          for (          BeforeRunTask task : activeTasks) {
            BeforeRunTaskProvider<BeforeRunTask> provider=BeforeRunTaskProvider.getProvider(myProject,task.getProviderId());
            if (provider != null && !provider.executeTask(dataContext,runConfiguration,task)) {
              if (onCancelRunnable != null) {
                SwingUtilities.invokeLater(onCancelRunnable);
              }
              return;
            }
          }
          DumbService.getInstance(myProject).smartInvokeLater(startRunnable);
        }
      }
);
    }
 else {
      startRunnable.run();
    }
  }
 else {
    startRunnable.run();
  }
}
