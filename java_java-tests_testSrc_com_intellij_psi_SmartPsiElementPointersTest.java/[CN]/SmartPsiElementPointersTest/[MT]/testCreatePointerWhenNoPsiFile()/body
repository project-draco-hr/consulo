{
  myPsiManager.startBatchFilesProcessingMode();
  try {
    final PsiClass aClass=myJavaFacade.findClass("AClass",GlobalSearchScope.allScope(getProject()));
    assertNotNull(aClass);
    VirtualFile vFile=myRoot.findChild("AClass.java");
    assertNotNull(vFile);
    PsiDocumentManager psiDocumentManager=PsiDocumentManager.getInstance(myProject);
    Document document=FileDocumentManager.getInstance().getDocument(vFile);
    final SmartPsiElementPointer pointer=SmartPointerManager.getInstance(myProject).createSmartPsiElementPointer(aClass);
    System.gc();
    document.insertString(0,"class Foo{}\n");
    PsiElement element=pointer.getElement();
    assertEquals(aClass,element);
    document.insertString(0,"/**/");
    psiDocumentManager.commitAllDocuments();
    if (aClass.isValid()) {
      aClass.getChildren();
    }
    element=pointer.getElement();
    assertNotNull(element);
    assertTrue(element instanceof PsiClass);
    assertTrue(element.isValid());
  }
  finally {
    myPsiManager.finishBatchFilesProcessingMode();
  }
}
