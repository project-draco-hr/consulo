{
  MavenCustomRepositoryTestFixture fixture;
  fixture=new MavenCustomRepositoryTestFixture(myDir);
  fixture.setUp();
  fixture.copy("plugins","local1");
  fixture.copy("local2","local1");
  MavenEmbedder embedder=MavenEmbedderFactory.createEmbedderForExecute(getMavenCoreSettings()).getEmbedder();
  File indicesDir=new File(myDir,"indices");
  final MavenIndices indices=new MavenIndices(embedder,indicesDir,this);
  final MavenIndex index=indices.add(getRepositoryPath(),MavenIndex.Kind.LOCAL);
  final AtomicBoolean isFinished=new AtomicBoolean(false);
  Thread t1=new Thread(new Runnable(){
    public void run(){
      try {
        for (int i=0; i < 3; i++) {
          System.out.println("INDEXING #" + i);
          indices.updateOrRepair(index,true,new EmptyProgressIndicator());
        }
      }
 catch (      ProcessCanceledException e) {
        throw new RuntimeException(e);
      }
 finally {
        isFinished.set(true);
      }
    }
  }
);
  Thread t2=new Thread(new Runnable(){
    public void run(){
      Random random=new Random();
      while (!isFinished.get()) {
        int i=random.nextInt(100);
        System.out.println("Adding artifact #" + i);
        index.addArtifact(new MavenId("group" + i,"artifact" + i,"" + i));
      }
    }
  }
);
  t1.start();
  t2.start();
  do {
    t1.join(100);
    t2.join(100);
  }
 while (!isFinished.get());
  t1.join(100);
  t2.join(100);
  indices.close();
}
