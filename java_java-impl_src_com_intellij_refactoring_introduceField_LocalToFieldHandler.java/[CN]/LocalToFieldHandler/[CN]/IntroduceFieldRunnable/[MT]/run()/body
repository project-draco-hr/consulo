{
  try {
    final boolean rebindNeeded2=!myVariableName.equals(myFieldName) || myRebindNeeded;
    final PsiReference[] refs;
    if (rebindNeeded2) {
      refs=ReferencesSearch.search(myLocal,GlobalSearchScope.projectScope(myProject),false).toArray(new PsiReference[0]);
    }
 else {
      refs=null;
    }
    final PsiMethod enclosingConstructor=BaseExpressionToFieldHandler.getEnclosingConstructor(myDestinationClass,myLocal);
    myField=mySettings.isIntroduceEnumConstant() ? EnumConstantsUtil.createEnumConstant(myDestinationClass,myLocal,myFieldName) : createField(myLocal,mySettings.getForcedType(),myFieldName,myInitializerPlace == IN_FIELD_DECLARATION);
    myField=(PsiField)myDestinationClass.add(myField);
    BaseExpressionToFieldHandler.setModifiers(myField,mySettings);
    if (!mySettings.isIntroduceEnumConstant()) {
      VisibilityUtil.fixVisibility(myOccurences,myField,mySettings.getFieldVisibility());
    }
    myLocal.normalizeDeclaration();
    PsiDeclarationStatement declarationStatement=(PsiDeclarationStatement)myLocal.getParent();
    final BaseExpressionToFieldHandler.InitializationPlace finalInitializerPlace;
    if (myLocal.getInitializer() == null) {
      finalInitializerPlace=IN_FIELD_DECLARATION;
    }
 else {
      finalInitializerPlace=myInitializerPlace;
    }
    final PsiElementFactory factory=JavaPsiFacade.getInstance(myProject).getElementFactory();
switch (finalInitializerPlace) {
case IN_FIELD_DECLARATION:
      declarationStatement.delete();
    break;
case IN_CURRENT_METHOD:
  PsiStatement statement=createAssignment(myLocal,myFieldName,factory);
myAssignmentStatement=(PsiStatement)declarationStatement.replace(statement);
break;
case IN_CONSTRUCTOR:
myAssignmentStatement=addInitializationToConstructors(myLocal,myField,enclosingConstructor,factory);
break;
case IN_SETUP_METHOD:
myAssignmentStatement=addInitializationToSetUp(myLocal,myField,factory);
}
if (enclosingConstructor != null && myInitializerPlace == IN_CONSTRUCTOR) {
PsiStatement statement=createAssignment(myLocal,myFieldName,factory);
myAssignmentStatement=(PsiStatement)declarationStatement.replace(statement);
}
if (rebindNeeded2) {
for (final PsiReference reference : refs) {
if (reference != null) {
RefactoringUtil.replaceOccurenceWithFieldRef((PsiExpression)reference,myField,myDestinationClass);
}
}
}
}
 catch (IncorrectOperationException e) {
LOG.error(e);
}
}
