{
  FilesToRefreshCollector callback=new FilesToRefreshCollector();
  UpdateFilesHelper.iterateFileGroupFilesDeletedOnServerFirst(updatedFiles,callback);
  for (  File file : callback.getToRefreshDeletedOrReplaced()) {
    refreshDeletedOrReplaced(file);
  }
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    LocalFileSystem.getInstance().refreshIoFiles(callback.getToRefresh(),false,false,null);
    return;
  }
  final Semaphore semaphore=new Semaphore();
  semaphore.down();
  try {
    LocalFileSystem.getInstance().refreshIoFiles(callback.getToRefresh(),true,false,new Runnable(){
      @Override public void run(){
        semaphore.up();
      }
    }
);
  }
 catch (  Throwable t) {
    semaphore.up();
    throw new RuntimeException(t);
  }
  semaphore.waitFor();
}
