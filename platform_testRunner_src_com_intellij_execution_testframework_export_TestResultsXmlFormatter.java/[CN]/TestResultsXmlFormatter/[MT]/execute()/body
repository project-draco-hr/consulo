{
  final Ref<Integer> maxDepth=new Ref<Integer>(0);
  AbstractTestProxy testRoot=myTestRoot;
  visit(testRoot,0,false,new PairProcessor<AbstractTestProxy,Integer>(){
    @Override public boolean process(    AbstractTestProxy node,    Integer depth){
      maxDepth.set(Math.max(maxDepth.get(),depth));
      return true;
    }
  }
);
  if (maxDepth.get() > 1 && testRoot.getChildren().size() == 1) {
    testRoot=testRoot.getChildren().get(0);
    maxDepth.set(maxDepth.get() - 1);
  }
  myResultHandler.startDocument();
  startElement(TESTSUITES,new LinkedHashMap<String,String>());
  final Ref<SAXException> error=Ref.create(null);
  visit(testRoot,0,true,new PairProcessor<AbstractTestProxy,Integer>(){
    @Override public boolean process(    AbstractTestProxy node,    Integer depth){
      if (depth == maxDepth.get() - 1) {
        try {
          processSuite(node);
        }
 catch (        SAXException e) {
          error.set(e);
          return false;
        }
      }
      return true;
    }
  }
);
  if (!error.isNull()) {
    throw error.get();
  }
  endElement(TESTSUITES);
  myResultHandler.endDocument();
}
