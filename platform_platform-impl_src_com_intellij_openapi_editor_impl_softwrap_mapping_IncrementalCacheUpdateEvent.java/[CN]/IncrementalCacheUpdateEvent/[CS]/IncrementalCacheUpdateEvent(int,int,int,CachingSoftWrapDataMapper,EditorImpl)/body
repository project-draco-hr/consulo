{
  if (editor.myUseNewRendering) {
    VisualLineInfo info=getVisualLineInfo(editor,startOffset,false);
    if (info.startsWithSoftWrap) {
      info=getVisualLineInfo(editor,info.startOffset,true);
    }
    myStartOffset=info.startOffset;
    myStartLogicalPosition=editor.offsetToLogicalPosition(myStartOffset);
    myStartVisualPosition=new VisualPosition(info.visualLine,0);
  }
 else {
    myStartOffset=mapper.getPreviousVisualLineStartOffset(startOffset);
    myStartLogicalPosition=mapper.offsetToLogicalPosition(myStartOffset);
    LOG.assertTrue(myStartLogicalPosition.visualPositionAware);
    myStartVisualPosition=myStartLogicalPosition.toVisualPosition();
  }
  myMandatoryEndOffset=newEndOffset;
  myLengthDiff=newEndOffset - oldEndOffset;
  myOldEndLogicalLine=editor.getDocument().getLineNumber(oldEndOffset);
}
