{
  Document document=editor.getDocument();
  int textLength=document.getTextLength();
  if (offset <= 0 || textLength == 0)   return new VisualLineInfo(0,0,false);
  offset=Math.min(offset,textLength);
  int startOffset=EditorUtil.getNotFoldedLineStartOffset(editor,offset);
  SoftWrapModelImpl softWrapModel=editor.getSoftWrapModel();
  int wrapIndex=softWrapModel.getSoftWrapIndex(offset);
  int prevSoftWrapIndex=wrapIndex < 0 ? (-wrapIndex - 2) : wrapIndex - (beforeSoftWrap ? 1 : 0);
  SoftWrap prevSoftWrap=prevSoftWrapIndex < 0 ? null : softWrapModel.getRegisteredSoftWraps().get(prevSoftWrapIndex);
  int visualLine=document.getLineNumber(offset) - editor.getFoldingModel().getFoldedLinesCountBefore(offset) + (prevSoftWrapIndex + 1);
  int visualLineStartOffset=prevSoftWrap == null ? startOffset : Math.max(startOffset,prevSoftWrap.getStart());
  return new VisualLineInfo(visualLine,visualLineStartOffset,prevSoftWrap != null && prevSoftWrap.getStart() == visualLineStartOffset);
}
