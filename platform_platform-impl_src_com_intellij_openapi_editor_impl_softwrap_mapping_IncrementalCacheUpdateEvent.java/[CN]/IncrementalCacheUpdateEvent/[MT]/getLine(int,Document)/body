{
  if (offset >= document.getTextLength()) {
    int result=document.getLineCount();
    return result > 0 ? result - 1 : 0;
  }
  return document.getLineNumber(offset);
}
