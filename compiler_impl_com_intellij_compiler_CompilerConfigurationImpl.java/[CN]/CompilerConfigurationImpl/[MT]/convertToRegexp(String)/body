{
  if (isPatternNegated(wildcardPattern)) {
    wildcardPattern=wildcardPattern.substring(1);
  }
  wildcardPattern=FileUtil.toSystemIndependentName(wildcardPattern);
  String dirPattern=null;
  int slash=wildcardPattern.lastIndexOf('/');
  if (slash >= 0) {
    dirPattern=wildcardPattern.substring(0,slash + 1);
    wildcardPattern=wildcardPattern.substring(slash + 1);
    if (!dirPattern.startsWith("/")) {
      dirPattern="/" + dirPattern;
    }
    dirPattern=normalizeWildcards(dirPattern);
    dirPattern=StringUtil.replace(dirPattern,"/.*.*/","(/.*)?/");
    dirPattern=StringUtil.trimEnd(dirPattern,"/");
    dirPattern=optimize(dirPattern);
    dirPattern=".*" + dirPattern;
  }
  wildcardPattern=normalizeWildcards(wildcardPattern);
  wildcardPattern=optimize(wildcardPattern);
  final Pattern dirCompiled=dirPattern == null ? null : compilePattern(dirPattern);
  return Pair.create(compilePattern(wildcardPattern),dirCompiled);
}
