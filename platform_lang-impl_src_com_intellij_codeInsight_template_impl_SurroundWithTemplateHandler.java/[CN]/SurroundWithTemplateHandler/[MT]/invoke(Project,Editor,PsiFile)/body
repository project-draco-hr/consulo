{
  if (!editor.getSelectionModel().hasSelection()) {
    editor.getSelectionModel().selectLineAtCaret();
    if (!editor.getSelectionModel().hasSelection())     return;
  }
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  List<CustomLiveTemplate> customTemplates=getApplicableCustomTemplates(editor,file);
  ArrayList<TemplateImpl> templates=getApplicableTemplates(editor,file,true);
  if (templates.isEmpty() && customTemplates.isEmpty()) {
    HintManager.getInstance().showErrorHint(editor,CodeInsightBundle.message("templates.surround.no.defined"));
    return;
  }
  if (!CodeInsightUtilBase.preparePsiElementForWrite(file))   return;
  Set<Character> usedMnemonicsSet=new HashSet<Character>();
  DefaultActionGroup group=new DefaultActionGroup();
  for (  CustomLiveTemplate customTemplate : customTemplates) {
    group.add(new WrapWithCustomTemplateAction(customTemplate,editor,file,usedMnemonicsSet));
  }
  for (  TemplateImpl template : templates) {
    group.add(new InvokeTemplateAction(template,editor,project,usedMnemonicsSet));
  }
  final ListPopup popup=JBPopupFactory.getInstance().createActionGroupPopup(CodeInsightBundle.message("templates.select.template.chooser.title"),group,DataManager.getInstance().getDataContext(editor.getContentComponent()),JBPopupFactory.ActionSelectionAid.MNEMONICS,false);
  popup.showInBestPositionFor(editor);
}
