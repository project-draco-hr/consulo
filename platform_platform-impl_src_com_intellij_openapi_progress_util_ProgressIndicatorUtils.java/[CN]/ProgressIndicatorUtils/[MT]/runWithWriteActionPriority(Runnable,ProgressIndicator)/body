{
  final ApplicationEx application=(ApplicationEx)ApplicationManager.getApplication();
  if (application.isWriteActionPending()) {
    if (!progressIndicator.isCanceled())     progressIndicator.cancel();
    return false;
  }
  final ApplicationAdapter listener=new ApplicationAdapter(){
    @Override public void beforeWriteActionStart(    Object action){
      if (!progressIndicator.isCanceled())       progressIndicator.cancel();
    }
  }
;
  boolean succeededWithAddingListener=application.tryRunReadAction(new Runnable(){
    @Override public void run(){
      application.addApplicationListener(listener);
    }
  }
);
  if (!succeededWithAddingListener) {
    if (!progressIndicator.isCanceled())     progressIndicator.cancel();
    return false;
  }
  final Ref<Boolean> wasCancelled=new Ref<Boolean>();
  try {
    ProgressManager.getInstance().runProcess(new Runnable(){
      @Override public void run(){
        try {
          action.run();
        }
 catch (        ProcessCanceledException ignore) {
          wasCancelled.set(Boolean.TRUE);
        }
      }
    }
,progressIndicator);
  }
  finally {
    application.removeApplicationListener(listener);
  }
  return wasCancelled.get() != Boolean.TRUE;
}
