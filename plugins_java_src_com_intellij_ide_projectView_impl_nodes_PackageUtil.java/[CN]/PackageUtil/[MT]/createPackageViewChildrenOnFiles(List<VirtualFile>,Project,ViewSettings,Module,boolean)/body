{
  final PsiManager psiManager=PsiManager.getInstance(project);
  final List<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  final Set<PsiJavaPackage> topLevelPackages=new HashSet<PsiJavaPackage>();
  for (  final VirtualFile root : sourceRoots) {
    final PsiDirectory directory=psiManager.findDirectory(root);
    if (directory == null) {
      continue;
    }
    final PsiJavaPackage directoryPackage=JavaDirectoryService.getInstance().getPackage(directory);
    if (directoryPackage == null || isPackageDefault(directoryPackage)) {
      final PsiDirectory[] subdirectories=directory.getSubdirectories();
      for (      PsiDirectory subdirectory : subdirectories) {
        final PsiJavaPackage aPackage=JavaDirectoryService.getInstance().getPackage(subdirectory);
        if (aPackage != null && !isPackageDefault(aPackage)) {
          topLevelPackages.add(aPackage);
        }
      }
      children.addAll(ProjectViewDirectoryHelper.getInstance(project).getDirectoryChildren(directory,settings,false));
    }
 else {
      topLevelPackages.add(directoryPackage);
    }
  }
  for (  final PsiJavaPackage topLevelPackage : topLevelPackages) {
    addPackageAsChild(children,topLevelPackage,module,settings,inLibrary);
  }
  return children;
}
