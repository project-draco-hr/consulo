{
  if (insertedElement == null)   return "";
  int offsetInElement=offset - insertedElement.getTextRange().getStartOffset();
  final PsiReference ref=insertedElement.findReferenceAt(offsetInElement);
  final String text=insertedElement.getText();
  if (ref == null && (StringUtil.endsWithChar(text,'#') || (StringUtil.endsWithChar(text,'.') && !(insertedElement instanceof Property)))) {
    return "";
  }
  if (ref instanceof PsiJavaCodeReferenceElement) {
    final PsiElement name=((PsiJavaCodeReferenceElement)ref).getReferenceNameElement();
    if (name != null) {
      offsetInElement=offset - name.getTextRange().getStartOffset();
      return name.getText().substring(0,offsetInElement);
    }
    return "";
  }
 else   if (ref != null) {
    offsetInElement=offset - ref.getElement().getTextRange().getStartOffset();
    String result=ref.getElement().getText().substring(ref.getRangeInElement().getStartOffset(),offsetInElement);
    if (result.indexOf('(') > 0) {
      result=result.substring(0,result.indexOf('('));
    }
    if (ref.getElement() instanceof PsiNameValuePair && result.startsWith("{")) {
      result="";
    }
    return result;
  }
  if (insertedElement instanceof PsiIdentifier || insertedElement instanceof PsiKeyword || PsiKeyword.NULL.equals(text)|| PsiKeyword.TRUE.equals(text)|| PsiKeyword.FALSE.equals(text)|| (insertedElement instanceof XmlToken && (((XmlToken)insertedElement).getTokenType() == XmlTokenType.XML_ATTRIBUTE_VALUE_TOKEN || ((XmlToken)insertedElement).getTokenType() == XmlTokenType.XML_DATA_CHARACTERS || ((XmlToken)insertedElement).getTokenType() == XmlTokenType.XML_NAME))) {
    return text.substring(0,offsetInElement).trim();
  }
  if (insertedElement instanceof PsiDocToken) {
    final PsiDocToken token=(PsiDocToken)insertedElement;
    if (token.getTokenType() == JavaDocTokenType.DOC_TAG_VALUE_TOKEN) {
      return text.substring(0,offsetInElement).trim();
    }
 else     if (token.getTokenType() == JavaDocTokenType.DOC_TAG_NAME) {
      return text.substring(1,offsetInElement).trim();
    }
  }
  return "";
}
