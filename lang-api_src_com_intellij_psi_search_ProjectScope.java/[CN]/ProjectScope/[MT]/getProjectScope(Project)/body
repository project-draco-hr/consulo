{
  GlobalSearchScope projectScope=project.getUserData(PROJECT_SCOPE_KEY);
  if (projectScope == null) {
    final ProjectRootManager projectRootManager=ProjectRootManager.getInstance(project);
    if (projectRootManager == null) {
      projectScope=new EverythingGlobalScope(){
        public boolean isSearchInLibraries(){
          return false;
        }
      }
;
    }
 else {
      projectScope=new GlobalSearchScope(){
        private final ProjectFileIndex myFileIndex=projectRootManager.getFileIndex();
        public boolean contains(        VirtualFile file){
          return file instanceof VirtualFileWindow || myFileIndex.isInContent(file);
        }
        public int compare(        VirtualFile file1,        VirtualFile file2){
          return 0;
        }
        public boolean isSearchInModuleContent(        @NotNull Module aModule){
          return true;
        }
        public boolean isSearchInLibraries(){
          return false;
        }
        public String getDisplayName(){
          return PsiBundle.message("psi.search.scope.project");
        }
        public String toString(){
          return getDisplayName();
        }
      }
;
    }
    project.putUserData(PROJECT_SCOPE_KEY,projectScope);
  }
  return projectScope;
}
