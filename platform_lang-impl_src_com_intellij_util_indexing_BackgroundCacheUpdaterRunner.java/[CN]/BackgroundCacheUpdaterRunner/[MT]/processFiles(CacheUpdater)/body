{
  for (  Map.Entry<Project,Collection<VirtualFile>> entry : myProjectToFileMap.entrySet()) {
    final Project project=entry.getKey();
    final Collection<VirtualFile> files=entry.getValue();
    final Consumer<ProgressIndicator> action=new Consumer<ProgressIndicator>(){
      public void consume(      final ProgressIndicator indicator){
        final MyFileContentQueue queue=new MyFileContentQueue();
        try {
          final double total=files.size();
          queue.queue(files,indicator);
          final Consumer<VirtualFile> uiUpdater=new Consumer<VirtualFile>(){
            final Set<VirtualFile> processed=new THashSet<VirtualFile>();
            public void consume(            VirtualFile virtualFile){
              indicator.checkCanceled();
              indicator.setFraction(processed.size() / total);
              processed.add(virtualFile);
              indicator.setText2(virtualFile.getPresentableUrl());
            }
          }
;
          while (project == null || !project.isDisposed()) {
            indicator.checkCanceled();
            if (runWhileUserInactive(project,queue,uiUpdater,updater)) {
              break;
            }
          }
          if (project != null && project.isDisposed()) {
            indicator.cancel();
          }
        }
  finally {
          queue.clear();
          updater.updatingDone();
        }
      }
    }
;
    if (project != null) {
      DumbServiceImpl.getInstance(project).queueIndexUpdate(action,files.size());
    }
 else {
      final ProgressIndicator currentIndicator=ProgressManager.getInstance().getProgressIndicator();
      action.consume(currentIndicator != null ? currentIndicator : new EmptyProgressIndicator());
    }
  }
}
