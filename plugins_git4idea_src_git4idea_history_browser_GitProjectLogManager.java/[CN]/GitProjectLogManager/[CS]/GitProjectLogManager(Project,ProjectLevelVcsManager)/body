{
  myProject=project;
  myVcsManager=vcsManager;
  myComponentsMap=new AtomicReference<Map<VirtualFile,Content>>(new HashMap<VirtualFile,Content>());
  myListener=new VcsListener(){
    public void directoryMappingChanged(){
      new AbstractCalledLater(myProject,ModalityState.NON_MODAL){
        public void run(){
          recalculateWindows();
        }
      }
.callMe();
    }
  }
;
  myProject.getMessageBus().connect(myProject).subscribe(CHECK_CURRENT_BRANCH,new CurrentBranchListener(){
    public void consume(    VirtualFile file){
      final VirtualFile baseDir=myProject.getBaseDir();
      if (baseDir == null)       return;
      final Map<VirtualFile,Content> currentState=myComponentsMap.get();
      for (      VirtualFile virtualFile : currentState.keySet()) {
        if (Comparing.equal(virtualFile,file)) {
          final String title=getCaption(baseDir,virtualFile);
          final Content content=currentState.get(virtualFile);
          if (!Comparing.equal(title,content.getDisplayName())) {
            new AbstractCalledLater(myProject,ModalityState.NON_MODAL){
              public void run(){
                content.setDisplayName(title);
              }
            }
.callMe();
          }
          return;
        }
      }
    }
  }
);
}
