{
  final Document document=editor.getDocument();
  PsiDocumentManager.getInstance(project).commitDocument(document);
  int caretOffset=editor.getCaretModel().getOffset();
  PsiElement element=file.findElementAt(caretOffset);
  if (element != null && element.getLanguage() instanceof XMLLanguage) {
    if (!(element instanceof XmlAttributeValue) && (text.indexOf('>') >= 0 || text.indexOf('<') >= 0)) {
      return text;
    }
    ASTNode cdata=TreeUtil.findParent(element.getNode(),XmlElementType.XML_CDATA);
    if (cdata == null) {
      ASTNode astNode=ENCODE_EACH_SYMBOL_POLICY.encodeXmlTextContents(text,element);
      return astNode.getTreeParent().getText();
    }
  }
  return text;
}
