{
  final Document document=editor.getDocument();
  PsiDocumentManager.getInstance(project).commitDocument(document);
  int caretOffset=editor.getCaretModel().getOffset();
  PsiElement element=PsiUtilBase.getElementAtOffset(file,caretOffset);
  if (element != null && element instanceof XmlElement) {
    boolean hasMarkup=text.indexOf('>') >= 0 || text.indexOf('<') >= 0;
    if (hasMarkup) {
      if (!(element instanceof XmlAttributeValue)) {
        return text;
      }
    }
    if (TreeUtil.findParent(element.getNode(),XmlElementType.XML_CDATA) == null && TreeUtil.findParent(element.getNode(),XmlElementType.XML_COMMENT) == null) {
      ASTNode astNode=ENCODE_EACH_SYMBOL_POLICY.encodeXmlTextContents(text,element);
      return astNode.getTreeParent().getText();
    }
  }
  return text;
}
