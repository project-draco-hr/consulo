{
  try {
    clientEnvironment.getConnection().open(streamLogger);
  }
 catch (  AuthenticationException ex) {
    throw new CommandException(ex,"Could not establish connection!");
  }
  ConnectionStreams connectionStreams=new ConnectionStreams(clientEnvironment.getConnection(),streamLogger,clientEnvironment.isUtf8TextFileTransmission());
  boolean exception=true;
  try {
    updateValidRequests(connectionStreams);
    sendRequest(new RootRequest(clientEnvironment.getConnection().getRepository()),connectionStreams);
    if (passEnvVariablesToServer()) {
      sendSetRequests(globalOptions,connectionStreams);
    }
    if (globalOptions.isUseGzip() && isValidRequest(GzipStreamRequest.REQUEST)) {
      sendRequest(new GzipStreamRequest(),connectionStreams);
      connectionStreams.setGzipped();
    }
    sendRequest(new ValidResponsesRequest(),connectionStreams);
    sendRequest(new UseUnchangedRequest(),connectionStreams);
    sendGlobalOptionRequests(globalOptions,connectionStreams);
    if (System.getProperty("os.name").startsWith("Windows") && isValidRequest("Case")) {
      sendRequest(new CaseRequest(),connectionStreams);
    }
    if (clientEnvironment.isUtf8TextFileTransmission()) {
      connectionStreams.setUtf8();
    }
    exception=false;
    return connectionStreams;
  }
 catch (  IOException ex) {
    throw new IOCommandException(ex);
  }
 finally {
    if (exception) {
      connectionStreams.close();
    }
  }
}
