{
  final MockVirtualFile virtualFile=new MockVirtualFile(name,fileType,text,modificationStamp);
  if (fileType instanceof LanguageFileType) {
    final Language language=((LanguageFileType)fileType).getLanguage();
    final ParserDefinition parserDefinition=language.getParserDefinition();
    FileViewProvider viewProvider=language.createViewProvider(virtualFile,myManager,physical);
    if (viewProvider == null)     viewProvider=new SingleRootFileViewProvider(myManager,virtualFile,physical);
    if (parserDefinition != null) {
      final PsiFile psiFile=viewProvider.getPsi(language);
      if (markAsCopy)       ((TreeElement)psiFile.getNode()).acceptTree(new GeneratedMarkerVisitor());
      return psiFile;
    }
  }
  final SingleRootFileViewProvider singleRootFileViewProvider=new SingleRootFileViewProvider(myManager,virtualFile,physical);
  final PsiPlainTextFileImpl plainTextFile=new PsiPlainTextFileImpl(singleRootFileViewProvider);
  if (markAsCopy)   CodeEditUtil.setNodeGenerated(plainTextFile.getNode(),true);
  return plainTextFile;
}
