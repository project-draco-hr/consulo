{
  final PsiManager mgr=reference.getManager();
  if (mgr instanceof PsiManagerEx) {
    if (reference.getUserData(RESOLVING) != Boolean.TRUE) {
      reference.putUserData(RESOLVING,Boolean.TRUE);
      try {
        return (XPathVariable)((PsiManagerEx)mgr).getResolveCache().resolveWithCaching(reference,RESOLVER,true,false);
      }
  finally {
        reference.putUserData(RESOLVING,null);
      }
    }
  }
  return resolveInner(reference);
}
