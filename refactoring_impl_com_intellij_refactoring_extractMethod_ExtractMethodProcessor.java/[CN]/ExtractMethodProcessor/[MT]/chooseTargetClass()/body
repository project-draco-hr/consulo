{
  myNeedChangeContext=false;
  myTargetClass=myCodeFragmentMember instanceof PsiMember ? ((PsiMember)myCodeFragmentMember).getContainingClass() : (PsiClass)myCodeFragmentMember.getParent();
  if (myTargetClass instanceof PsiAnonymousClass) {
    PsiElement target=myTargetClass.getParent();
    PsiElement targetMember=myTargetClass;
    while (true) {
      if (target instanceof PsiFile)       break;
      if (target instanceof PsiClass && !(target instanceof PsiAnonymousClass))       break;
      targetMember=target;
      target=target.getParent();
    }
    if (target instanceof PsiClass) {
      PsiClass newTargetClass=(PsiClass)target;
      List<PsiVariable> array=new ArrayList<PsiVariable>();
      boolean success=true;
      for (      PsiElement element : myElements) {
        if (!ControlFlowUtil.collectOuterLocals(array,element,myCodeFragmentMember,targetMember)) {
          success=false;
          break;
        }
      }
      if (success) {
        myTargetClass=newTargetClass;
        PsiVariable[] newInputVariables=new PsiVariable[myInputVariables.length + array.size()];
        System.arraycopy(myInputVariables,0,newInputVariables,0,myInputVariables.length);
        for (int i=0; i < array.size(); i++) {
          newInputVariables[myInputVariables.length + i]=array.get(i);
        }
        myInputVariables=newInputVariables;
        myNeedChangeContext=true;
      }
    }
  }
}
