{
  myNeedChangeContext=false;
  myTargetClass=myCodeFragmentMember instanceof PsiMember ? ((PsiMember)myCodeFragmentMember).getContainingClass() : (PsiClass)myCodeFragmentMember.getParent();
  if (myTargetClass instanceof PsiAnonymousClass) {
    PsiElement target=myTargetClass.getParent();
    PsiElement targetMember=myTargetClass;
    while (true) {
      if (target instanceof PsiFile)       break;
      if (target instanceof PsiClass && !(target instanceof PsiAnonymousClass))       break;
      targetMember=target;
      target=target.getParent();
    }
    if (target instanceof PsiClass) {
      PsiClass newTargetClass=(PsiClass)target;
      List<PsiVariable> array=new ArrayList<PsiVariable>();
      boolean success=true;
      for (      PsiElement element : myElements) {
        if (!ControlFlowUtil.collectOuterLocals(array,element,myCodeFragmentMember,targetMember)) {
          success=false;
          break;
        }
      }
      if (success) {
        myTargetClass=newTargetClass;
        myInputVariables=new ArrayList<PsiVariable>(ContainerUtil.concat(myInputVariables,array));
        myNeedChangeContext=true;
      }
    }
  }
}
