{
  myElementUpdate.clear();
  final Ref<Thread> thread=new Ref<Thread>();
  final boolean[] wasInterrupted=new boolean[]{false};
  myElementUpdateHook=new ElementUpdateHook(){
    @Override public void onElementAction(    String action,    Object element){
      if (thread.get() == null) {
        thread.set(Thread.currentThread());
      }
      boolean toInterrupt=element.equals(interruptElement) && action.equals(interruptAction);
      if (wasInterrupted[0]) {
        if (myCancelRequest == null) {
          String status=getBuilder().getUi().getStatus();
          myCancelRequest=new AssertionError("Not supposed to be update after interruption request: action=" + action + " element="+ element+ " interruptAction="+ interruptAction+ " interruptElement="+ interruptElement);
        }
      }
 else {
        if (toInterrupt) {
          wasInterrupted[0]=true;
switch (interruption) {
case throwProcessCancelled:
            throw new ProcessCanceledException();
case invokeCancel:
          getBuilder().cancelUpdate();
        break;
    }
  }
}
}
}
;
action.run();
myCancelRequest=null;
myElementUpdateHook=null;
}
