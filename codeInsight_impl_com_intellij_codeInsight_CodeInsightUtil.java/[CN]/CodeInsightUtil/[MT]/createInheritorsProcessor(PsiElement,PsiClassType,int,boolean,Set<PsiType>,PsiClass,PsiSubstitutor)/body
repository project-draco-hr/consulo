{
  final PsiManager manager=context.getManager();
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(manager.getProject());
  final PsiResolveHelper resolveHelper=facade.getResolveHelper();
  return new Processor<PsiClass>(){
    public boolean process(    PsiClass inheritor){
      ProgressManager.getInstance().checkCanceled();
      if (!facade.getResolveHelper().isAccessible(inheritor,context,null))       return true;
      if (inheritor.getQualifiedName() == null && !manager.areElementsEquivalent(inheritor.getContainingFile(),context.getContainingFile())) {
        return true;
      }
      if (JavaCompletionUtil.isInExcludedPackage(inheritor))       return true;
      PsiSubstitutor superSubstitutor=TypeConversionUtil.getClassSubstitutor(baseClass,inheritor,PsiSubstitutor.EMPTY);
      if (superSubstitutor == null)       return true;
      if (getRawSubtypes) {
        result.add(createType(inheritor,facade.getElementFactory().createRawSubstitutor(inheritor),arrayDim));
        return true;
      }
      PsiSubstitutor inheritorSubstitutor=PsiSubstitutor.EMPTY;
      final Iterator<PsiTypeParameter> inheritorParamIter=PsiUtil.typeParametersIterator(inheritor);
      while (inheritorParamIter.hasNext()) {
        PsiTypeParameter inheritorParameter=inheritorParamIter.next();
        final Iterator<PsiTypeParameter> baseParamIter=PsiUtil.typeParametersIterator(baseClass);
        while (baseParamIter.hasNext()) {
          PsiTypeParameter baseParameter=baseParamIter.next();
          final PsiType substituted=superSubstitutor.substitute(baseParameter);
          PsiType arg=baseSubstitutor.substitute(baseParameter);
          if (arg instanceof PsiWildcardType)           arg=((PsiWildcardType)arg).getBound();
          PsiType substitution=resolveHelper.getSubstitutionForTypeParameter(inheritorParameter,substituted,arg,true,PsiUtil.getLanguageLevel(context));
          if (substitution == PsiType.NULL || substitution instanceof PsiWildcardType)           continue;
          if (substitution == null) {
            result.add(createType(inheritor,facade.getElementFactory().createRawSubstitutor(inheritor),arrayDim));
            return true;
          }
          inheritorSubstitutor=inheritorSubstitutor.put(inheritorParameter,substitution);
          break;
        }
      }
      PsiType toAdd=createType(inheritor,inheritorSubstitutor,arrayDim);
      if (baseType.isAssignableFrom(toAdd)) {
        result.add(toAdd);
      }
      return true;
    }
  }
;
}
