{
  final ASTNode leafElementAt1=root.getNode().findLeafElementAt(startOffset);
  if (leafElementAt1 == null)   return null;
  ASTNode leafElementAt2=root.getNode().findLeafElementAt(endOffset);
  if (leafElementAt2 == null && endOffset == root.getTextLength())   leafElementAt2=root.getNode().findLeafElementAt(endOffset - 1);
  if (leafElementAt2 == null)   return null;
  ASTNode prev=leafElementAt2.getTreePrev();
  if (prev != null && prev.getTextRange().getEndOffset() == endOffset) {
    leafElementAt2=prev;
  }
  TreeElement commonParent=(TreeElement)TreeUtil.findCommonParent(leafElementAt1,leafElementAt2);
  LOG.assertTrue(commonParent != null);
  LOG.assertTrue(commonParent.getTextRange() != null);
  while (commonParent.getTreeParent() != null && commonParent.getTextRange().equals(commonParent.getTreeParent().getTextRange())) {
    commonParent=commonParent.getTreeParent();
  }
  return commonParent.getPsi();
}
