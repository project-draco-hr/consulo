{
  ContentManager contentManager=myToolWindow.getContentManager();
  Content selectedContent=contentManager.getSelectedContent();
  JComponent contentComponent=selectedContent != null ? selectedContent.getComponent() : null;
  if (contentComponent == null)   return EMPTY_ARRAY;
  List<AnAction> result=ContainerUtil.newSmartList();
  for (  final ActionToolbar toolbar : iterateToolbars(contentComponent)) {
    JComponent c=toolbar.getComponent();
    if (c.isVisible() || !c.isValid())     continue;
    if (!result.isEmpty() && !(ContainerUtil.getLastItem(result) instanceof AnSeparator)) {
      result.add(AnSeparator.getInstance());
    }
    List<AnAction> actions=toolbar.getActions(false);
    for (    AnAction action : actions) {
      if (action instanceof ToggleAction && !result.contains(action)) {
        result.add(action);
      }
 else       if (action instanceof AnSeparator) {
        if (!result.isEmpty() && !(ContainerUtil.getLastItem(result) instanceof AnSeparator)) {
          result.add(AnSeparator.getInstance());
        }
      }
    }
  }
  boolean popup=result.size() > 3;
  setPopup(popup);
  if (!popup && !result.isEmpty())   result.add(AnSeparator.getInstance());
  return result.toArray(new AnAction[result.size()]);
}
