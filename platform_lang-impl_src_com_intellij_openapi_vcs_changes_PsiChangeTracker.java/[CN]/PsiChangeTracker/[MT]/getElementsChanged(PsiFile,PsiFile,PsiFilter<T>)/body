{
  final HashMap<T,FileStatus> result=new HashMap<T,FileStatus>();
  final List<T> oldElements=new ArrayList<T>();
  final List<T> elements=new ArrayList<T>();
  if (file == null) {
    oldFile.accept(new MyVisitor<T>(filter,oldElements));
    calculateStatuses(elements,oldElements,result);
    return result;
  }
  final Project project=file.getProject();
  file.accept(new MyVisitor<T>(filter,elements));
  final VirtualFile vf=file.getVirtualFile();
  FileStatus status=vf == null ? null : FileStatusManager.getInstance(project).getStatus(vf);
  if (status == null && oldFile == null) {
    status=FileStatus.ADDED;
  }
  if (status == FileStatus.ADDED || status == FileStatus.DELETED || status == FileStatus.DELETED_FROM_FS || status == FileStatus.UNKNOWN) {
    for (    T element : elements) {
      result.put(element,status);
    }
    return result;
  }
  if (oldFile == null)   return result;
  oldFile.accept(new MyVisitor<T>(filter,oldElements));
  calculateStatuses(elements,oldElements,result);
  return result;
}
