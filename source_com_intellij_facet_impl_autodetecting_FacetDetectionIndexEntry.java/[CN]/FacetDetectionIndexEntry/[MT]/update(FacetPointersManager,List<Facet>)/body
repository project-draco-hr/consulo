{
  if (facets == null || facets.isEmpty()) {
    SmartList<FacetPointer> old=myDetectedFacets;
    myDetectedFacets=null;
    return old;
  }
  if (myDetectedFacets == null) {
    myDetectedFacets=new SmartList<FacetPointer>();
  }
  List<Facet> removeFacets=null;
  Set<FacetPointer> toRemove=new THashSet<FacetPointer>(myDetectedFacets);
  for (  Facet facet : facets) {
    FacetPointer<Facet> pointer=facetPointersManager.create(facet);
    toRemove.remove(pointer);
    if (!myDetectedFacets.contains(pointer)) {
      if (removeFacets == null) {
        removeFacets=new SmartList<Facet>();
      }
      removeFacets.add(facet);
      myDetectedFacets.add(pointer);
    }
  }
  for (  FacetPointer pointer : toRemove) {
    myDetectedFacets.remove(pointer);
  }
  return toRemove;
}
