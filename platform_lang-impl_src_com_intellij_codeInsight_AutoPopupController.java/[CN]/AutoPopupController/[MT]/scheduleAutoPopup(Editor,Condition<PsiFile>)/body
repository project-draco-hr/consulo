{
  if (ApplicationManager.getApplication().isUnitTestMode() && !CompletionAutoPopupHandler.ourTestingAutopopup) {
    return;
  }
  if (!CodeInsightSettings.getInstance().AUTO_POPUP_COMPLETION_LOOKUP) {
    return;
  }
  LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(editor);
  boolean shouldBeFast=lookup != null && lookup.isShown();
  final CompletionProgressIndicator currentCompletion=CompletionServiceImpl.getCompletionService().getCurrentCompletion();
  if (currentCompletion != null) {
    currentCompletion.closeAndFinish(!shouldBeFast);
  }
  final CompletionPhase.CommittingDocuments phase=new CompletionPhase.CommittingDocuments(false,editor);
  CompletionServiceImpl.setCompletionPhase(phase);
  Runnable request=new Runnable(){
    @Override public void run(){
      CompletionAutoPopupHandler.runLaterWithCommitted(myProject,editor.getDocument(),new Runnable(){
        @Override public void run(){
          if (phase.isExpired())           return;
          PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(editor.getDocument());
          if (file != null && condition != null && !condition.value(file))           return;
          CompletionAutoPopupHandler.invokeCompletion(CompletionType.BASIC,true,myProject,editor,0);
        }
      }
);
    }
  }
;
  if (shouldBeFast) {
    request.run();
  }
 else {
    addRequest(request,CodeInsightSettings.getInstance().AUTO_LOOKUP_DELAY);
  }
}
