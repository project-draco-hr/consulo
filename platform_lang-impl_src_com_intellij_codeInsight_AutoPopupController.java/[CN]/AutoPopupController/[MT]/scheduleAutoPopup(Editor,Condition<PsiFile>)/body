{
  if (ApplicationManager.getApplication().isUnitTestMode() && !CompletionAutoPopupHandler.ourTestingAutopopup) {
    return;
  }
  if (!CodeInsightSettings.getInstance().AUTO_POPUP_COMPLETION_LOOKUP) {
    return;
  }
  final CompletionProgressIndicator currentCompletion=CompletionServiceImpl.getCompletionService().getCurrentCompletion();
  if (currentCompletion != null) {
    currentCompletion.closeAndFinish(true);
  }
  final CompletionPhase.AutoPopupAlarm phase=new CompletionPhase.AutoPopupAlarm(false,editor);
  CompletionServiceImpl.setCompletionPhase(phase);
  addRequest(new Runnable(){
    @Override public void run(){
      CompletionAutoPopupHandler.runLaterWithCommitted(myProject,editor.getDocument(),new Runnable(){
        @Override public void run(){
          if (phase.isExpired())           return;
          PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(editor.getDocument());
          if (file != null && condition != null && !condition.value(file))           return;
          CompletionAutoPopupHandler.invokeCompletion(CompletionType.BASIC,true,myProject,editor,0);
        }
      }
);
    }
  }
,CodeInsightSettings.getInstance().AUTO_LOOKUP_DELAY);
}
