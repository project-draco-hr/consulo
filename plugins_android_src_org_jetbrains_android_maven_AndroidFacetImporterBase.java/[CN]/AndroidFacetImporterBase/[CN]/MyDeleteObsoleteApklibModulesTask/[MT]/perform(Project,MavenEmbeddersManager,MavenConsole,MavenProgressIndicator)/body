{
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    @Override public void run(){
      final ModifiableModuleModel moduleModel=ModuleManager.getInstance(project).getModifiableModel();
      final Set<Module> referredModules=new HashSet<Module>();
      for (      Module module : moduleModel.getModules()) {
        if (!AndroidMavenUtil.isExtApklibModule(module) && !AndroidCompileUtil.isGenModule(module)) {
          collectDependenciesRecursively(module,referredModules);
        }
      }
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          for (          final Module module : moduleModel.getModules()) {
            if (AndroidMavenUtil.isExtApklibModule(module) && !referredModules.contains(module)) {
              final VirtualFile[] contentRoots=ModuleRootManager.getInstance(module).getContentRoots();
              if (contentRoots.length > 0) {
                final VirtualFile contentRoot=contentRoots[0];
                try {
                  contentRoot.delete(myProject);
                }
 catch (                IOException e) {
                  LOG.error(e);
                }
              }
              final Module genModule=AndroidCompileUtil.getGenModule(module);
              if (genModule != null) {
                moduleModel.disposeModule(genModule);
              }
              moduleModel.disposeModule(module);
            }
          }
          moduleModel.commit();
        }
      }
);
    }
  }
);
}
