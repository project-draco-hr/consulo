{
  if (!shouldWatch())   return null;
  String suffix=millis ? "-" + System.currentTimeMillis() : "";
  File file=new File(myCurHangLogDir,pathPrefix + "threadDump-" + myDateFormat.format(new Date())+ suffix+ ".txt");
  File dir=file.getParentFile();
  if (!(dir.isDirectory() || dir.mkdirs())) {
    return null;
  }
  try {
    OutputStreamWriter writer=new OutputStreamWriter(new FileOutputStream(file));
    try {
      StackTraceElement[] edtStack=ThreadDumper.dumpThreadsToFile(myThreadMXBean,writer);
      if (edtStack != null) {
        if (myStacktraceCommonPart == null) {
          myStacktraceCommonPart=ContainerUtil.newArrayList(edtStack);
        }
 else {
          updateStacktraceCommonPart(edtStack);
        }
      }
    }
  finally {
      writer.close();
    }
  }
 catch (  IOException ignored) {
  }
  return file;
}
