{
  final VirtualFile[] filesToAttach=filterAlreadyAdded(library,files,rootType);
  if (filesToAttach.length > 0) {
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        final LibraryEditor libraryEditor=getLibraryEditor(library);
        for (        VirtualFile file : filesToAttach) {
          if (isJarDirectories) {
            libraryEditor.addJarDirectory(file,false);
          }
 else {
            libraryEditor.addRoot(file,rootType);
          }
        }
        if (myEditingModuleLibraries) {
          commitChanges();
        }
      }
    }
);
    myTreeBuilder.updateFromRoot();
  }
  return filesToAttach;
}
