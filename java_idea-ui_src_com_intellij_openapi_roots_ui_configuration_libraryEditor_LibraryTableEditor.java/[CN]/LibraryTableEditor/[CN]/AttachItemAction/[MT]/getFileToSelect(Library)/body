{
  VirtualFile toSelect=myLastChosen;
  if (toSelect == null) {
    for (    OrderRootType orderRootType : OrderRootType.getAllPersistentTypes()) {
      final VirtualFile[] existingRoots=library.getFiles(orderRootType);
      if (existingRoots.length > 0) {
        VirtualFile existingRoot=existingRoots[0];
        if (existingRoot.getFileSystem() instanceof JarFileSystem) {
          existingRoot=JarFileSystem.getInstance().getVirtualFileForJar(existingRoot);
        }
        if (existingRoot != null) {
          if (existingRoot.isDirectory()) {
            toSelect=existingRoot;
          }
 else {
            toSelect=existingRoot.getParent();
          }
        }
        break;
      }
    }
  }
  if (toSelect == null && Comparing.strEqual(myLibraryTableProvider.getTableLevel(),LibraryTablesRegistrar.PROJECT_LEVEL)) {
    final Project project=myProject;
    if (project != null) {
      toSelect=project.getBaseDir();
    }
  }
  return toSelect;
}
