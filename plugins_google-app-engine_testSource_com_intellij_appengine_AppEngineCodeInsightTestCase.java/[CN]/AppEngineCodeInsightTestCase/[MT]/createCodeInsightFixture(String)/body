{
  final String testDataPath=getTestDataPath() + relativeTestDataPath;
  final CodeInsightTestFixture codeInsightFixture=JavaTestFixtureFactory.getFixtureFactory().createCodeInsightFixture(myProjectFixture);
  codeInsightFixture.setTestDataPath(testDataPath);
  final TempDirTestFixture tempDir=codeInsightFixture.getTempDirFixture();
  myModuleBuilder.addSourceContentRoot(tempDir.getTempDirPath());
  codeInsightFixture.setUp();
  final VirtualFile dir=LocalFileSystem.getInstance().refreshAndFindFileByPath(testDataPath);
  Assert.assertNotNull("Test data directory not found: " + testDataPath,dir);
  VfsUtil.processFilesRecursively(dir,new CommonProcessors.CollectProcessor<VirtualFile>());
  dir.refresh(false,true);
  tempDir.copyAll(testDataPath,"",new VirtualFileFilter(){
    @Override public boolean accept(    VirtualFile file){
      return !file.getName().contains("_after");
    }
  }
);
  return codeInsightFixture;
}
