{
  return ApplicationManager.getApplication().runReadAction(new Computable<CompletionVariant[]>(){
    public CompletionVariant[] compute(){
      final List<CompletionVariant> variants=new ArrayList<CompletionVariant>();
      PsiElement scope=position;
      if (scope == null) {
        scope=file;
      }
      while (scope != null) {
        boolean breakFlag=false;
        if (isScopeAcceptable(scope)) {
          for (          final CompletionVariant variant : myCompletionVariants) {
            if (variant.isVariantApplicable(position,scope) && !variants.contains(variant)) {
              variants.add(variant);
              if (variant.isScopeFinal(scope)) {
                breakFlag=true;
              }
            }
          }
        }
        if (breakFlag || isScopeFinal(scope.getClass()))         break;
        scope=scope.getContext();
        if (scope instanceof PsiDirectory)         break;
      }
      return variants.toArray(new CompletionVariant[variants.size()]);
    }
  }
);
}
