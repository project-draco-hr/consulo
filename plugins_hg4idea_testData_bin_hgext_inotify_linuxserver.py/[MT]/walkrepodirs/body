def walkrepodirs(dirstate, absroot):
    'Iterate over all subdirectories of this repo.\n    Exclude the .hg directory, any nested repos, and ignored dirs.'

    def walkit(dirname, top):
        fullpath = server.join(absroot, dirname)
        try:
            for (name, kind) in osutil.listdir(fullpath):
                if (kind == stat.S_IFDIR):
                    if (name == '.hg'):
                        if (not top):
                            return
                    else:
                        d = server.join(dirname, name)
                        if dirstate._ignore(d):
                            continue
                        for subdir in walkit(d, False):
                            yield subdir
        except OSError as err:
            if (err.errno not in server.walk_ignored_errors):
                raise
        yield fullpath
    return walkit('', True)
