def _explain_watch_limit(ui, dirstate, rootabs):
    path = '/proc/sys/fs/inotify/max_user_watches'
    try:
        limit = int(file(path).read())
    except IOError as err:
        if (err.errno != errno.ENOENT):
            raise
        raise util.Abort(_('this system does not seem to support inotify'))
    ui.warn((_('*** the current per-user limit on the number of inotify watches is %s\n') % limit))
    ui.warn(_('*** this limit is too low to watch every directory in this repository\n'))
    ui.warn(_('*** counting directories: '))
    ndirs = len(list(walkrepodirs(dirstate, rootabs)))
    ui.warn((_('found %d\n') % ndirs))
    newlimit = min(limit, 1024)
    while (newlimit < ((limit + ndirs) * 1.1)):
        newlimit *= 2
    ui.warn((_('*** to raise the limit from %d to %d (run as root):\n') % (limit, newlimit)))
    ui.warn((_('***  echo %d > %s\n') % (newlimit, path)))
    raise util.Abort((_('cannot watch %s until inotify watch limit is raised') % rootabs))
