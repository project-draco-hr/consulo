def __init__(self, ui, dirstate, root):
    server.repowatcher.__init__(self, ui, dirstate, root)
    self.lastevent = {}
    self.dirty = False
    try:
        self.watcher = watcher.watcher()
    except OSError as err:
        raise util.Abort((_('inotify service not available: %s') % err.strerror))
    self.threshold = watcher.threshold(self.watcher)
    self.fileno = self.watcher.fileno
    self.register(timeout=None)
    self.handle_timeout()
    self.scan()
