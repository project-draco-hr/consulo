def scan(self, topdir=''):
    ds = self.dirstate._map.copy()
    self.add_watch(server.join(self.wprefix, topdir), self.mask)
    for (root, dirs, files) in server.walk(self.dirstate, self.wprefix, topdir):
        for d in dirs:
            self.add_watch(server.join(root, d), self.mask)
        wroot = root[self.prefixlen:]
        for fn in files:
            wfn = server.join(wroot, fn)
            self.updatefile(wfn, self.getstat(wfn))
            ds.pop(wfn, None)
    wtopdir = topdir
    if (wtopdir and (wtopdir[(-1)] != '/')):
        wtopdir += '/'
    for (wfn, state) in ds.iteritems():
        if (not wfn.startswith(wtopdir)):
            continue
        try:
            st = self.stat(wfn)
        except OSError:
            status = state[0]
            self.deletefile(wfn, status)
        else:
            self.updatefile(wfn, st)
    self.check_deleted('!')
    self.check_deleted('r')
