{
  PsiElement element=null;
  final Editor editor=DataKeys.EDITOR.getData(dataContext);
  if (editor != null) {
    final PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (psiFile != null) {
      element=psiFile.findElementAt(editor.getCaretModel().getOffset());
    }
  }
  if (element == null) {
    element=DataKeys.PSI_ELEMENT.getData(dataContext);
  }
  if (element == null) {
    final VirtualFile file=DataKeys.VIRTUAL_FILE.getData(dataContext);
    if (file != null) {
      element=PsiManager.getInstance(project).findFile(file);
    }
  }
  return element;
}
