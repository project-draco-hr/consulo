{
  PsiElement element=null;
  final Editor editor=(Editor)dataContext.getData(DataConstants.EDITOR);
  if (editor != null) {
    final PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (psiFile != null) {
      element=psiFile.findElementAt(editor.getCaretModel().getOffset());
    }
  }
  if (element == null) {
    element=(PsiElement)dataContext.getData(DataConstants.PSI_ELEMENT);
  }
  if (element == null) {
    final VirtualFile file=(VirtualFile)dataContext.getData(DataConstants.VIRTUAL_FILE);
    if (file != null) {
      element=PsiManager.getInstance(project).findFile(file);
    }
  }
  return element;
}
