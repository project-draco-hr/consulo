{
  List<Variable> oldVariables=getCurrentVariables();
  Set<String> oldVariableNames=ContainerUtil.map2Set(oldVariables,new Function<Variable,String>(){
    @Override public String fun(    Variable variable){
      return variable.getName();
    }
  }
);
  ArrayList<Variable> parsedVariables=parseVariables(myTemplateEditor.getDocument().getCharsSequence());
  Map<String,String> newVariableNames=new HashMap<String,String>();
  for (  Object parsedVariable : parsedVariables) {
    Variable newVariable=(Variable)parsedVariable;
    String name=newVariable.getName();
    newVariableNames.put(name,name);
  }
  int oldVariableNumber=0;
  for (int i=0; i < parsedVariables.size(); i++) {
    Variable variable=parsedVariables.get(i);
    if (oldVariableNames.contains(variable.getName())) {
      Variable oldVariable=null;
      for (; oldVariableNumber < oldVariables.size(); oldVariableNumber++) {
        oldVariable=oldVariables.get(oldVariableNumber);
        if (newVariableNames.get(oldVariable.getName()) != null) {
          break;
        }
        oldVariable=null;
      }
      oldVariableNumber++;
      if (oldVariable != null) {
        parsedVariables.set(i,oldVariable);
      }
    }
  }
  return parsedVariables;
}
