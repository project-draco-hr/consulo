{
  FileElement treeElement=(FileElement)_getTreeElement();
  if (treeElement != null)   return treeElement;
  if (getViewProvider().isPhysical() && myManager.isAssertOnFileLoading(getViewProvider().getVirtualFile())) {
    LOG.error("Access to tree elements not allowed in tests." + getViewProvider().getVirtualFile().getPresentableUrl());
  }
  final FileViewProvider viewProvider=getViewProvider();
  final Document document=viewProvider.isEventSystemEnabled() ? viewProvider.getDocument() : null;
synchronized (PsiLock.LOCK) {
    treeElement=createFileElement(viewProvider.getContents());
    if (document != null) {
      treeElement.putUserData(new Key<Document>("HARD_REFERENCE_TO_DOCUMENT"),document);
    }
    setTreeElement(treeElement);
    treeElement.setPsiElement(this);
  }
  if (getViewProvider().isEventSystemEnabled()) {
    ((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(myManager.getProject())).contentsLoaded(this);
  }
  if (LOG.isDebugEnabled() && getViewProvider().isPhysical()) {
    LOG.debug("Loaded text for file " + getViewProvider().getVirtualFile().getPresentableUrl());
  }
  return treeElement;
}
