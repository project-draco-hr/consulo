{
  myBuffer=new StringBuffer();
  myIsFirstParameterStack=new Stack<Boolean>();
  final HashMap<LwComponent,String> component2variable=new HashMap<LwComponent,String>();
  final TObjectIntHashMap<String> class2variableIndex=new TObjectIntHashMap<String>();
  final HashMap<String,LwComponent> id2component=new HashMap<String,LwComponent>();
  if (rootContainer.getComponentCount() != 1) {
    throw new CodeGenerationException(null,UIDesignerBundle.message("error.one.toplevel.component.required"));
  }
  final LwComponent topComponent=(LwComponent)rootContainer.getComponent(0);
  String id=Utils.findNotEmptyPanelWithXYLayout(topComponent);
  if (id != null) {
    throw new CodeGenerationException(id,UIDesignerBundle.message("error.nonempty.xy.panels.found"));
  }
  final PsiClass aClass=FormEditingUtil.findClassToBind(module,rootContainer.getClassToBind());
  if (aClass == null) {
    throw new ClassToBindNotFoundException(UIDesignerBundle.message("error.class.to.bind.not.found",rootContainer.getClassToBind()));
  }
  if (Utils.getCustomCreateComponentCount(rootContainer) > 0) {
    if (FormEditingUtil.findCreateComponentsMethod(aClass) == null) {
      throw new CodeGenerationException(null,UIDesignerBundle.message("error.no.custom.create.method"));
    }
    myBuffer.append(AsmCodeGenerator.CREATE_COMPONENTS_METHOD_NAME).append("();");
  }
  generateSetupCodeForComponent(topComponent,component2variable,class2variableIndex,id2component,module,aClass);
  generateComponentReferenceProperties(topComponent,component2variable,class2variableIndex,id2component,aClass);
  generateButtonGroups(rootContainer,component2variable,class2variableIndex,id2component,aClass);
  final String methodText=myBuffer.toString();
  final PsiManager psiManager=PsiManager.getInstance(module.getProject());
  final PsiElementFactory elementFactory=psiManager.getElementFactory();
  cleanup(aClass);
  final PsiClass fakeClass=elementFactory.createClassFromText("{\n" + "// GUI initializer generated by " + ApplicationNamesInfo.getInstance().getFullProductName() + " GUI Designer \n"+ "// >>> IMPORTANT!! <<<\n"+ "// DO NOT EDIT OR ADD ANY CODE HERE!\n"+ ""+ AsmCodeGenerator.SETUP_METHOD_NAME+ "();\n"+ "}\n"+ "\n"+ "/** Method generated by "+ ApplicationNamesInfo.getInstance().getFullProductName()+ " GUI Designer\n"+ " * >>> IMPORTANT!! <<<\n"+ " * DO NOT edit this method OR call it in your code!\t"+ " */\n"+ "private void "+ AsmCodeGenerator.SETUP_METHOD_NAME+ "()\n"+ "{\n"+ methodText+ "}\n",null);
  final PsiMethod method=(PsiMethod)aClass.add(fakeClass.getMethods()[0]);
  PsiElement initializer=null;
  boolean needInitializer=true;
  for (  PsiMethod constructor : aClass.getConstructors()) {
    if (containsMethodIdentifier(constructor,method)) {
      needInitializer=false;
      break;
    }
  }
  if (needInitializer) {
    initializer=aClass.addBefore(fakeClass.getInitializers()[0],method);
  }
  final String grcMethodText="public javax.swing.JComponent " + AsmCodeGenerator.GET_ROOT_COMPONENT_METHOD_NAME + "() { return "+ topComponent.getBinding()+ "; }";
  generateMethodIfRequired(aClass,method,AsmCodeGenerator.GET_ROOT_COMPONENT_METHOD_NAME,grcMethodText,topComponent.getBinding() != null);
  final String loadButtonTextMethodText=getLoadMethodText(AsmCodeGenerator.LOAD_BUTTON_TEXT_METHOD,AbstractButton.class,module);
  generateMethodIfRequired(aClass,method,AsmCodeGenerator.LOAD_BUTTON_TEXT_METHOD,loadButtonTextMethodText,myNeedLoadButtonText);
  final String loadLabelTextMethodText=getLoadMethodText(AsmCodeGenerator.LOAD_LABEL_TEXT_METHOD,JLabel.class,module);
  generateMethodIfRequired(aClass,method,AsmCodeGenerator.LOAD_LABEL_TEXT_METHOD,loadLabelTextMethodText,myNeedLoadLabelText);
  final CodeStyleManager codeStyleManager=CodeStyleManager.getInstance(module.getProject());
  codeStyleManager.shortenClassReferences(method);
  if (initializer != null) {
    codeStyleManager.shortenClassReferences(initializer);
  }
}
