{
  final PsiElement qualifier=ref.getQualifier();
  final PsiElement classNameElement=ref.getReferenceNameElement();
  if (classNameElement == null)   return true;
  if (qualifier != null) {
    final PsiElementFactory factory=ref.getManager().getElementFactory();
    PsiElement target=null;
    PsiSubstitutor substitutor=PsiSubstitutor.EMPTY;
    PsiType type=null;
    if (qualifier instanceof PsiExpression || qualifier instanceof PsiJavaCodeReferenceElement) {
      if (qualifier instanceof PsiExpression) {
        type=((PsiExpression)qualifier).getType();
        final ResolveResult result=PsiUtil.resolveGenericsClassInType(type);
        target=result.getElement();
        substitutor=result.getSubstitutor();
      }
      if (type == null && qualifier instanceof PsiJavaCodeReferenceElement) {
        final PsiJavaCodeReferenceElement referenceElement=(PsiJavaCodeReferenceElement)qualifier;
        final ResolveResult result=referenceElement.advancedResolve(incompleteCode);
        target=result.getElement();
        substitutor=result.getSubstitutor();
        if (target instanceof PsiVariable) {
          type=substitutor.substitute(((PsiVariable)target).getType());
          if (type instanceof PsiClassType) {
            final ResolveResult typeResult=((PsiClassType)type).resolveGenerics();
            target=typeResult.getElement();
            substitutor=substitutor.merge(typeResult.getSubstitutor());
          }
 else           target=null;
        }
 else         if (target instanceof PsiMethod) {
          type=substitutor.substitute(((PsiMethod)target).getReturnType());
          if (type instanceof PsiClassType) {
            final ResolveResult typeResult=((PsiClassType)type).resolveGenerics();
            target=typeResult.getElement();
            substitutor=substitutor.merge(typeResult.getSubstitutor());
          }
 else           target=null;
        }
 else         if (target instanceof PsiClass) {
          type=factory.createType((PsiClass)target);
          processor.handleEvent(PsiScopeProcessor.Event.START_STATIC,null);
        }
        final PsiType[] types=referenceElement.getTypeParameters();
        if (target instanceof PsiClass) {
          substitutor=((PsiSubstitutorEx)substitutor).inplacePutAll((PsiClass)target,types);
        }
      }
      if (type instanceof PsiArrayType) {
        target=factory.getArrayClass();
      }
    }
    if (target != null)     return processScope(target,processor,substitutor,target,ref);
  }
 else {
    return treeWalkUp(processor,ref,maxScope);
  }
  return true;
}
