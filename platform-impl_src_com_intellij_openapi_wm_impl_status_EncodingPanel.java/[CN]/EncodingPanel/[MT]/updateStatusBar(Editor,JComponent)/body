{
  boolean enabled;
  String text;
  if (selected != null) {
    VirtualFile file=getSelectedFile(selected);
    Pair<String,Boolean> result=ChangeEncodingUpdateGroup.update(file,getProject());
    text=result.getFirst();
    enabled=result.getSecond();
    if (file != null) {
      Charset charset=ChooseFileEncodingAction.encodingFromContent(getProject(),file);
      if (charset == null)       charset=file.getCharset();
      setText(charset.displayName());
    }
  }
 else {
    text="";
    enabled=false;
    setText("");
  }
  setEnabled(enabled);
  return text;
}
