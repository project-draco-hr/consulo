{
  VirtualFile virtualFile=getSelectedFile(getEditor());
  if (virtualFile == null)   return;
  if (!isEnabled())   return;
  ChooseFileEncodingAction changeAction=new ChooseFileEncodingAction(virtualFile,getProject()){
    protected void chosen(    final VirtualFile virtualFile,    final Charset charset){
      EncodingManager.getInstance().setEncoding(virtualFile,charset);
    }
  }
;
  DataContext dataContext=SimpleDataContext.getSimpleContext(DataConstants.VIRTUAL_FILE,virtualFile,SimpleDataContext.getSimpleContext(DataConstants.PROJECT,getProject(),DataManager.getInstance().getDataContext(statusBar)));
  Presentation presentation=changeAction.getTemplatePresentation();
  AnActionEvent event=new AnActionEvent(null,dataContext,ActionPlaces.UNKNOWN,presentation,ActionManager.getInstance(),0);
  changeAction.update(event);
  DefaultActionGroup group=changeAction.createGroup(false);
  final ListPopup popup=JBPopupFactory.getInstance().createActionGroupPopup(null,group,dataContext,JBPopupFactory.ActionSelectionAid.SPEEDSEARCH,false,null,30);
  popup.showUnderneathOf(this);
}
