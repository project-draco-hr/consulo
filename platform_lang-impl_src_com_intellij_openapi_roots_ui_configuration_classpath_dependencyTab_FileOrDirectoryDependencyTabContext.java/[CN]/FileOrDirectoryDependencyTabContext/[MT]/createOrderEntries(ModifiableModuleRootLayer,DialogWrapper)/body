{
  List<VirtualFile> chosenFiles=FileChooserUtil.getChosenFiles(myFileChooserDescriptor,Arrays.asList(myFileSystemTree.getSelectedFiles()));
  if (chosenFiles.isEmpty()) {
    return Collections.emptyList();
  }
  final List<Pair<LibraryRootsComponentDescriptor,FileChooserDescriptor>> descriptors=new ArrayList<Pair<LibraryRootsComponentDescriptor,FileChooserDescriptor>>();
  for (  LibraryRootsComponentDescriptor componentDescriptor : myLibraryTypes.keySet()) {
    descriptors.add(Pair.create(componentDescriptor,componentDescriptor.createAttachFilesChooserDescriptor(null)));
  }
  List<LibraryRootsComponentDescriptor> suitableDescriptors=new ArrayList<LibraryRootsComponentDescriptor>();
  for (  Pair<LibraryRootsComponentDescriptor,FileChooserDescriptor> pair : descriptors) {
    if (acceptAll(pair.getSecond(),chosenFiles)) {
      suitableDescriptors.add(pair.getFirst());
    }
  }
  final LibraryRootsComponentDescriptor rootsComponentDescriptor;
  LibraryType libraryType=null;
  if (suitableDescriptors.size() == 1) {
    rootsComponentDescriptor=suitableDescriptors.get(0);
    libraryType=myLibraryTypes.get(rootsComponentDescriptor);
  }
 else {
    rootsComponentDescriptor=myDefaultDescriptor;
  }
  List<OrderRoot> chosenRoots=RootDetectionUtil.detectRoots(chosenFiles,dialogWrapper.getRootPane(),layer.getProject(),rootsComponentDescriptor);
  final List<OrderRoot> roots=filterAlreadyAdded(layer,chosenRoots);
  if (roots.isEmpty()) {
    return Collections.emptyList();
  }
  final List<Library> addedLibraries=new ArrayList<Library>();
  boolean onlyClasses=true;
  for (  OrderRoot root : roots) {
    onlyClasses&=root.getType() == BinariesOrderRootType.getInstance();
  }
  if (onlyClasses) {
    for (    OrderRoot root : roots) {
      addedLibraries.add(createLibraryFromRoots(layer,Collections.singletonList(root),libraryType));
    }
  }
 else {
    addedLibraries.add(createLibraryFromRoots(layer,roots,libraryType));
  }
  List<OrderEntry> orderEntries=new ArrayList<OrderEntry>(addedLibraries.size());
  for (  Library addedLibrary : addedLibraries) {
    LibraryOrderEntry libraryOrderEntry=layer.findLibraryOrderEntry(addedLibrary);
    if (libraryOrderEntry != null) {
      orderEntries.add(libraryOrderEntry);
    }
  }
  return orderEntries;
}
