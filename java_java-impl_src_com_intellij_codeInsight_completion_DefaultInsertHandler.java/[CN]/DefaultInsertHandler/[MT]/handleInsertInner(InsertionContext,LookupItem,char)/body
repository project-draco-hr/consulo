{
  final Project project=context.getProject();
  final Editor editor=context.getEditor();
  final Document document=editor.getDocument();
  PsiDocumentManager.getInstance(project).commitDocument(document);
  final PsiFile file=context.getFile();
  TailType tailType=getTailType(completionChar,item);
  InsertHandlerState state=new InsertHandlerState(context.getSelectionEndOffset(),context.getSelectionEndOffset());
  if (CompletionUtil.isOverwrite(item,completionChar)) {
    removeEndOfIdentifier(context);
  }
 else   if (context.getOffsetMap().getOffset(CompletionInitializationContext.IDENTIFIER_END_OFFSET) != context.getSelectionEndOffset()) {
    JavaCompletionUtil.resetParensInfo(context.getOffsetMap());
  }
  handleParentheses(false,false,tailType,context,state);
  handleBrackets(item,document,state);
  if (item.getObject() instanceof PsiVariable) {
    if (completionChar == '!' && PsiType.BOOLEAN.isAssignableFrom(((PsiVariable)item.getObject()).getType())) {
      PsiDocumentManager.getInstance(project).commitDocument(document);
      final PsiReferenceExpression ref=PsiTreeUtil.findElementOfClassAtOffset(file,state.tailOffset - 1,PsiReferenceExpression.class,false);
      if (ref != null) {
        FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EXCLAMATION_FINISH);
        document.insertString(ref.getTextRange().getStartOffset(),"!");
        state.caretOffset++;
        state.tailOffset++;
      }
    }
  }
  context.setTailOffset(state.tailOffset);
  state.caretOffset=processTail(tailType,state.caretOffset,state.tailOffset,editor);
  editor.getSelectionModel().removeSelection();
  qualifyIfNeeded(context,item);
  if (tailType == TailType.DOT || context.getCompletionChar() == '.') {
    AutoPopupController.getInstance(project).autoPopupMemberLookup(editor,null);
  }
}
