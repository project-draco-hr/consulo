{
  FileHolderComposite composite;
  ChangeListWorker changeListWorker;
  final VcsDirtyScopeManagerImpl dirtyScopeManager;
  try {
    dirtyScopeManager=((VcsDirtyScopeManagerImpl)VcsDirtyScopeManager.getInstanceChecked(myProject));
  }
 catch (  ProcessCanceledException ex) {
    return;
  }
catch (  Exception ex) {
    LOG.error(ex);
    return;
  }
  final VcsInvalidated invalidated=dirtyScopeManager.retrieveScopes();
  if (invalidated == null || invalidated.isEmpty()) {
    return;
  }
  final boolean wasEverythingDirty=invalidated.isEverythingDirty();
  final List<VcsDirtyScope> scopes=invalidated.getScopes();
  try {
    checkIfDisposed();
synchronized (myDataLock) {
      changeListWorker=myWorker.copy();
      composite=updateUnversionedFiles ? (FileHolderComposite)myComposite.copy() : myComposite;
      myModifier.enterUpdate();
      if (wasEverythingDirty) {
        myUpdateException=null;
      }
      if (updateUnversionedFiles && wasEverythingDirty) {
        composite.cleanAll();
      }
      if (wasEverythingDirty) {
        changeListWorker.notifyStartProcessingChanges(null);
      }
      myChangesViewManager.scheduleRefresh();
    }
    final ChangeListManagerGate gate=changeListWorker.createSelfGate();
    final UpdatingChangeListBuilder builder=new UpdatingChangeListBuilder(changeListWorker,composite,new Getter<Boolean>(){
      public Boolean get(){
        return myUpdater.isStopped();
      }
    }
,updateUnversionedFiles,myIgnoredIdeaLevel,gate);
    for (    final VcsDirtyScope scope : scopes) {
      final AbstractVcs vcs=scope.getVcs();
      if (vcs == null)       continue;
      myChangesViewManager.updateProgressText(VcsBundle.message("changes.update.progress.message",vcs.getDisplayName()),false);
      if (!wasEverythingDirty) {
        changeListWorker.notifyStartProcessingChanges(scope);
      }
      if (updateUnversionedFiles && !wasEverythingDirty) {
        composite.cleanScope(scope);
      }
      actualUpdate(wasEverythingDirty,composite,builder,scope,vcs,changeListWorker,gate);
    }
synchronized (myDataLock) {
      if (wasEverythingDirty) {
        changeListWorker.notifyDoneProcessingChanges(myDelayedNotificator.getProxyDispatcher());
      }
      myModifier.exitUpdate();
      myModifier.apply(changeListWorker);
      myModifier.clearQueue();
      myWorker.takeData(changeListWorker);
      if (updateUnversionedFiles) {
        boolean statusChanged=!myComposite.equals(composite);
        myComposite=composite;
        if (statusChanged) {
          myDelayedNotificator.getProxyDispatcher().unchangedFileStatusChanged();
        }
      }
      updateIgnoredFiles(false);
      myShowLocalChangesInvalidated=false;
    }
    myChangesViewManager.scheduleRefresh();
  }
 catch (  DisposedException e) {
  }
catch (  ProcessCanceledException e) {
  }
catch (  Exception ex) {
    LOG.error(ex);
  }
catch (  AssertionError ex) {
    LOG.error(ex);
  }
 finally {
synchronized (myDataLock) {
      myDelayedNotificator.getProxyDispatcher().changeListUpdateDone();
      myChangesViewManager.scheduleRefresh();
    }
  }
}
