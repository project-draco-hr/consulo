{
  final WhiteSpace whiteSpace=wrapper.getWhiteSpace();
  final TextRange textRange=wrapper.getBlock().getTextRange();
  boolean wrapIsPresent=whiteSpace.containsLineFeeds();
  final Wrap wrap=wrapper.getWrap();
  if (shouldUseWrap(wrap) || wrapIsPresent) {
    whiteSpace.ensureLineFeed();
    if (wrapCanBeUsedInTheFuture(wrap)) {
      wrap.markAsUsed();
    }
    if (wrap != null && wrap.getFirstEntry() >= 0) {
      myReparseFromOffset=wrap.getFirstEntry();
      wrap.markAsUsed();
      shiftToOffset(myReparseFromOffset);
      myReparseFromOffset=-1;
      return true;
    }
  }
 else   if (isCandidateToBeWrapped(wrap)) {
    myWrapCandidates.clear();
    myWrapCandidates.add(myCurrentBlock);
  }
 else   if (wrapCanBeUsedInTheFuture(wrap) && !wrapIsPresent) {
    wrap.saveFirstEntry(textRange.getStartOffset());
  }
  if (!whiteSpace.containsLineFeeds() && lineOver() && !myWrapCandidates.isEmpty()) {
    myCurrentBlock=myWrapCandidates.get(myWrapCandidates.size() - 1);
    return true;
  }
  return false;
}
