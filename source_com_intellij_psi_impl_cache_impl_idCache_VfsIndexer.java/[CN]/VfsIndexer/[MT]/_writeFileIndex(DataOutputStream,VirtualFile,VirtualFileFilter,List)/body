{
  ProgressManager.getInstance().checkCanceled();
  result.add(file);
  if (out != null) {
    out.writeUTF(file.getName());
  }
  VirtualFile[] children=file.getChildren();
  if (children == null) {
    if (out != null) {
      out.writeInt(0);
    }
    return;
  }
  int childrenCount=0;
  for (int i=0; i < children.length; i++) {
    VirtualFile child=children[i];
    if (filter.accept(child))     childrenCount++;
  }
  if (out != null) {
    out.writeInt(childrenCount);
  }
  for (int i=0; i < children.length; i++) {
    VirtualFile child=children[i];
    if (filter.accept(child)) {
      _writeFileIndex(out,child,filter,result);
    }
  }
}
