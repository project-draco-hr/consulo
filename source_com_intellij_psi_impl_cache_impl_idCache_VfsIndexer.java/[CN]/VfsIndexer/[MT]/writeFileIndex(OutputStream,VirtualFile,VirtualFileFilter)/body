{
  List<VirtualFile> result=new ArrayList<VirtualFile>();
  ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.setText2("Scanning files in " + root.getPresentableUrl() + "...");
  }
  DataOutputStream out=stream == null ? null : new DataOutputStream(stream);
  _writeFileIndex(out,root,filter,result);
  if (out != null) {
    out.flush();
  }
  return result.toArray(new VirtualFile[result.size()]);
}
