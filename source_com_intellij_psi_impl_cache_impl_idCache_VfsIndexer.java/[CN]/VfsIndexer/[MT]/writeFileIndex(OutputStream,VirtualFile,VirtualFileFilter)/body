{
  List result=new ArrayList();
  ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.setText2("Scanning files in " + root.getPresentableUrl() + "...");
  }
  DataOutputStream out=stream != null ? new DataOutputStream(stream) : null;
  _writeFileIndex(out,root,filter,result);
  if (out != null) {
    out.flush();
  }
  return (VirtualFile[])result.toArray(new VirtualFile[result.size()]);
}
