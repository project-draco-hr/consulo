{
  if (!HighlightUtil.shouldInspect(myFile))   return;
  final InspectionManagerEx iManager=(InspectionManagerEx)InspectionManager.getInstance(myProject);
  final InspectionProfileWrapper profile=InspectionProjectProfileManager.getInstance(myProject).getProfileWrapper(myFile);
  final LocalInspectionTool[] tools=profile.getHighlightingLocalInspectionTools();
  final PsiElement[] elements=getElementsIntersectingRange(myFile,myStartOffset,myEndOffset);
  final ProgressManager progressManager=ProgressManager.getInstance();
  final int chunkSize=Math.max(10,tools.length / Runtime.getRuntime().availableProcessors() / 10);
  List<Runnable> inspectionChunks=new ArrayList<Runnable>();
  final ProgressIndicator daemonIndicator=progressManager.getProgressIndicator();
  for (int v=0; v < tools.length; v+=chunkSize) {
    final int index=v;
    Runnable chunk=new Runnable(){
      public void run(){
        if (daemonIndicator != null) {
          ((ProgressManagerImpl)progressManager).progressMe(daemonIndicator);
        }
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            ProblemsHolder holder=new ProblemsHolder(iManager);
            try {
              for (int i=index; i < index + chunkSize && i < tools.length; i++) {
                LocalInspectionTool tool=tools[i];
                PsiElementVisitor elementVisitor=tool.buildVisitor(holder,true);
                for (                PsiElement element : elements) {
                  progressManager.checkCanceled();
                  element.accept(elementVisitor);
                }
                if (holder.hasResults()) {
                  appendDescriptors(holder.getResults(),tool);
                }
              }
            }
 catch (            ProcessCanceledException e) {
            }
          }
        }
);
      }
    }
;
    inspectionChunks.add(chunk);
  }
  try {
    invokeAll(inspectionChunks);
  }
 catch (  ProcessCanceledException e) {
  }
catch (  Throwable e) {
    LOG.error(e);
  }
  inspectInjectedPsi(elements);
}
