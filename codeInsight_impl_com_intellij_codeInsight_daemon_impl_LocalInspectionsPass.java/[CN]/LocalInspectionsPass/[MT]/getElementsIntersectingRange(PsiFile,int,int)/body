{
  final FileViewProvider viewProvider=file.getViewProvider();
  final Set<PsiElement> result=new THashSet<PsiElement>();
  for (  Language language : viewProvider.getPrimaryLanguages()) {
    final PsiFile psiRoot=viewProvider.getPsi(language);
    if (HighlightUtil.shouldInspect(psiRoot)) {
      result.addAll(CodeInsightUtil.getElementsInRange(psiRoot,startOffset,endOffset,true));
    }
  }
  return result.toArray(new PsiElement[result.size()]);
}
