{
  boolean modal=progress != null && progress.isModal();
  if (modal)   myCurrentModalProgressCount.incrementAndGet();
  if (progress == null || progress instanceof ProgressWindow)   myCurrentUnsafeProgressCount.incrementAndGet();
  try {
    ProgressIndicator oldIndicator=null;
    boolean set=progress != null && progress != (oldIndicator=getProgressIndicator());
    if (set) {
      Thread currentThread=Thread.currentThread();
      setCurrentIndicator(currentThread,progress);
      try {
        registerIndicatorAndRun(progress,currentThread,oldIndicator,process);
      }
  finally {
        setCurrentIndicator(currentThread,oldIndicator);
      }
    }
 else {
      process.run();
    }
  }
  finally {
    if (progress == null || progress instanceof ProgressWindow)     myCurrentUnsafeProgressCount.decrementAndGet();
    if (modal)     myCurrentModalProgressCount.decrementAndGet();
  }
}
