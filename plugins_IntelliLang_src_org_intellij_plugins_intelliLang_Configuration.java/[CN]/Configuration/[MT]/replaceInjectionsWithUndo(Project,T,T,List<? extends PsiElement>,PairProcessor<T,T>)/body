{
  final UndoableAction action=new GlobalUndoableAction(){
    public void undo(){
      actualProcessor.process(remove,add);
    }
    public void redo(){
      actualProcessor.process(add,remove);
    }
  }
;
  final List<PsiFile> psiFiles=ContainerUtil.mapNotNull(psiElementsToRemove,new NullableFunction<PsiElement,PsiFile>(){
    public PsiFile fun(    final PsiElement psiAnnotation){
      return psiAnnotation instanceof PsiCompiledElement ? null : psiAnnotation.getContainingFile();
    }
  }
);
  new WriteCommandAction.Simple(project,"Language Injection Configuration Update",PsiUtilCore.toPsiFileArray(psiFiles)){
    public void run(){
      for (      PsiElement annotation : psiElementsToRemove) {
        annotation.delete();
      }
      actualProcessor.process(add,remove);
      UndoManager.getInstance(project).undoableActionPerformed(action);
    }
    @Override protected UndoConfirmationPolicy getUndoConfirmationPolicy(){
      return UndoConfirmationPolicy.REQUEST_CONFIRMATION;
    }
  }
.execute();
}
