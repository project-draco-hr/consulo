{
  PsiType[] substitutions=new PsiType[typeParameters.length];
  Pair<PsiType,ConstraintType>[] constraints=new Pair[typeParameters.length];
  for (int i=0; i < typeParameters.length; i++) {
    final Pair<PsiType,ConstraintType> constraint=inferTypeForMethodTypeParameterInner(typeParameters[i],parameters,arguments,partialSubstitutor,null,forCompletion);
    constraints[i]=constraint;
    if (constraint != null && constraint.getSecond() != ConstraintType.SUBTYPE) {
      substitutions[i]=constraint.getFirst();
    }
  }
  final LanguageLevel languageLevel=PsiUtil.getLanguageLevel(parent);
  final PsiManager manager=parent.getManager();
  for (int i=0; i < typeParameters.length; i++) {
    PsiTypeParameter typeParameter=typeParameters[i];
    if (substitutions[i] == null) {
      PsiType substitutionFromBounds=PsiType.NULL;
      OtherParameters:       for (int j=0; j < typeParameters.length; j++) {
        if (i != j) {
          PsiTypeParameter other=typeParameters[j];
          final PsiType otherSubstitution=substitutions[j];
          if (otherSubstitution == null)           continue;
          final PsiClassType[] bounds=other.getExtendsListTypes();
          for (          PsiClassType bound : bounds) {
            final PsiType substitutedBound=partialSubstitutor.substitute(bound);
            final Pair<PsiType,ConstraintType> currentConstraint=getSubstitutionForTypeParameterConstraint(typeParameter,substitutedBound,otherSubstitution,true,languageLevel);
            if (currentConstraint == null)             continue;
            final PsiType currentSubstitution=currentConstraint.getFirst();
            final ConstraintType currentConstraintType=currentConstraint.getSecond();
            if (currentConstraintType == ConstraintType.EQUALS) {
              substitutionFromBounds=currentSubstitution;
              break OtherParameters;
            }
 else             if (currentConstraintType == ConstraintType.SUPERTYPE) {
              if (PsiType.NULL.equals(substitutionFromBounds)) {
                substitutionFromBounds=currentSubstitution;
              }
 else {
                substitutionFromBounds=GenericsUtil.getLeastUpperBound(substitutionFromBounds,currentSubstitution,manager);
              }
            }
          }
        }
      }
      if (substitutionFromBounds != PsiType.NULL)       substitutions[i]=substitutionFromBounds;
    }
  }
  for (int i=0; i < typeParameters.length; i++) {
    PsiTypeParameter typeParameter=typeParameters[i];
    PsiType substitution=substitutions[i];
    Pair<PsiType,ConstraintType> constraint=constraints[i];
    if (substitution == null) {
      if (constraint == null) {
        constraint=inferMethodTypeParameterFromParent(typeParameter,partialSubstitutor,parent,forCompletion);
      }
 else       if (constraint.getSecond() == ConstraintType.SUBTYPE) {
        Pair<PsiType,ConstraintType> otherConstraint=inferMethodTypeParameterFromParent(typeParameter,partialSubstitutor,parent,forCompletion);
        if (otherConstraint != null) {
          if (otherConstraint.getSecond() == ConstraintType.EQUALS || otherConstraint.getSecond() == ConstraintType.SUPERTYPE)           constraint=otherConstraint;
        }
      }
      if (constraint != null) {
        substitution=constraint.getFirst();
      }
    }
    if (substitution == null) {
      PsiElementFactory factory=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory();
      return factory.createRawSubstitutor(partialSubstitutor,typeParameters);
    }
 else     if (substitution != PsiType.NULL) {
      partialSubstitutor=partialSubstitutor.put(typeParameter,substitution);
    }
  }
  return partialSubstitutor;
}
