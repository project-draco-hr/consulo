{
  final boolean addLvcsLabel=LvcsConfiguration.getInstance().ADD_LABEL_ON_RUNNING;
  final LocalVcs localVcs=LocalVcs.getInstance(project);
  RunContentDescriptor contentDescriptor=null;
  final DebuggerPanelsManager manager=DebuggerPanelsManager.getInstance(project);
  if (state instanceof JavaCommandLine) {
    FileDocumentManager.getInstance().saveAllDocuments();
    final JavaCommandLine javaCommandLine=(JavaCommandLine)state;
    if (addLvcsLabel) {
      localVcs.addLabel("Debugging " + runProfile.getName(),"");
    }
    RemoteConnection connection=DebuggerManagerImpl.createDebugParameters(javaCommandLine.getJavaParameters(),true,DebuggerSettings.getInstance().DEBUGGER_TRANSPORT,"",false);
    contentDescriptor=manager.attachVirtualMachine(runProfile,this,javaCommandLine,reuseContent,connection,true,originContext);
  }
 else   if (state instanceof PatchedRunnableState) {
    FileDocumentManager.getInstance().saveAllDocuments();
    if (addLvcsLabel) {
      localVcs.addLabel("Debugging " + runProfile.getName(),"");
    }
    final RemoteConnection connection=doPatch(new JavaParameters(),state.getRunnerSettings());
    contentDescriptor=manager.attachVirtualMachine(runProfile,this,state,reuseContent,connection,true,originContext);
  }
 else   if (state instanceof RemoteState) {
    FileDocumentManager.getInstance().saveAllDocuments();
    if (addLvcsLabel)     localVcs.addLabel("Starting remote debugging " + runProfile.getName(),"");
    RemoteState remoteState=(RemoteState)state;
    contentDescriptor=manager.attachVirtualMachine(runProfile,this,remoteState,reuseContent,createRemoteDebugConnection(remoteState,state.getRunnerSettings()),false,originContext);
  }
  return contentDescriptor != null ? contentDescriptor : null;
}
