{
  final LayoutData data=new LayoutData();
  data.eachY=0;
  data.size=new Dimension();
  data.gap=1;
  data.horizontal=isHorizontal();
  data.dragInsertPosition=-1;
  if (data.horizontal) {
    data.eachX=myManager.getToolWindowsPane().getHorizontalInsetX();
  }
 else {
    data.eachX=0;
  }
  data.fitSize=toFitWith != null ? toFitWith : new Dimension();
  final Rectangle stripeSensetiveRec=new Rectangle(-DROP_DISTANCE_SENSIVITY,-DROP_DISTANCE_SENSIVITY,getWidth() + DROP_DISTANCE_SENSIVITY * 2,getHeight() + DROP_DISTANCE_SENSIVITY * 2);
  boolean processDrop=isDroppingButton() && stripeSensetiveRec.intersects(myDropRectangle);
  if (toFitWith == null) {
    for (    StripeButton eachButton : myButtons) {
      if (!isConsideredInLayout(eachButton))       continue;
      final Dimension eachSize=eachButton.getPreferredSize();
      data.fitSize.width=Math.max(eachSize.width,data.fitSize.width);
      data.fitSize.height=Math.max(eachSize.height,data.fitSize.height);
    }
  }
  int insertOrder=-1;
  for (  StripeButton eachButton : myButtons) {
    insertOrder=eachButton.getDecorator().getWindowInfo().getOrder();
    if (!isConsideredInLayout(eachButton))     continue;
    final Dimension eachSize=eachButton.getPreferredSize();
    if (processDrop && data.dragInsertPosition == -1) {
      if (data.horizontal) {
        int distance=myDropRectangle.x - data.eachX;
        if (distance < eachSize.width / 2 || (myDropRectangle.x + myDropRectangle.width) < eachSize.width / 2) {
          layoutButton(data,myDragButtonImage,false);
          data.dragInsertPosition=insertOrder;
        }
      }
 else {
        int distance=myDropRectangle.y - data.eachY;
        if (distance < eachSize.height / 2 || (myDropRectangle.y + myDropRectangle.height) < eachSize.height / 2) {
          layoutButton(data,myDragButtonImage,false);
          data.dragInsertPosition=insertOrder;
        }
      }
    }
    layoutButton(data,eachButton,setBounds);
  }
  if (isDroppingButton()) {
    final Dimension dragSize=myDragButton.getPreferredSize();
    if (getAnchor().isHorizontal() == myDragButton.getWindowInfo().getAnchor().isHorizontal()) {
      data.size.width=Math.max(data.size.width,dragSize.width);
      data.size.height=Math.max(data.size.height,dragSize.height);
    }
 else {
      data.size.width=Math.max(data.size.width,dragSize.height);
      data.size.height=Math.max(data.size.height,dragSize.width);
    }
  }
  return data;
}
