{
  final PsiFile file;
  try {
    file=child.getContainingFile();
  }
 catch (  PsiInvalidElementAccessException e) {
    myFileStatusMap.markAllFilesDirty(e);
    return;
  }
  if (file == null || file instanceof PsiCompiledElement) {
    myFileStatusMap.markAllFilesDirty(child);
    return;
  }
  VirtualFile virtualFile=file.getVirtualFile();
  if (virtualFile != null && shouldBeIgnored(virtualFile)) {
    return;
  }
  int fileLength=file.getTextLength();
  if (!file.getViewProvider().isPhysical()) {
    myFileStatusMap.markFileScopeDirty(document,new TextRange(0,fileLength),fileLength,"Non-physical file update: " + file);
    return;
  }
  PsiElement element=whitespaceOptimizationAllowed && UpdateHighlightersUtil.isWhitespaceOptimizationAllowed(document) ? child : child.getParent();
  while (true) {
    if (element == null || element instanceof PsiFile || element instanceof PsiDirectory) {
      myFileStatusMap.markAllFilesDirty("Top element: " + element);
      return;
    }
    final PsiElement scope=getChangeHighlightingScope(element);
    if (scope != null) {
      myFileStatusMap.markFileScopeDirty(document,scope.getTextRange(),fileLength,"Scope: " + scope);
      return;
    }
    element=element.getParent();
  }
}
