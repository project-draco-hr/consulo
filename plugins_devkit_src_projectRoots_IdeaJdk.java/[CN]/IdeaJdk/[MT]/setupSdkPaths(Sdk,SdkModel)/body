{
  final Sandbox additionalData=(Sandbox)sdk.getSdkAdditionalData();
  if (additionalData != null) {
    additionalData.cleanupWatchedRoots();
  }
  final SdkModificator sdkModificator=sdk.getSdkModificator();
  final List<String> javaSdks=new ArrayList<String>();
  final Sdk[] sdks=sdkModel.getSdks();
  for (  Sdk jdk : sdks) {
    if (isValidInternalJdk(sdk,jdk)) {
      javaSdks.add(jdk.getName());
    }
  }
  if (javaSdks.isEmpty()) {
    JavaSdkVersion requiredVersion=getRequiredJdkVersion(sdk);
    if (requiredVersion != null) {
      Messages.showErrorDialog(DevKitBundle.message("no.java.sdk.for.idea.sdk.found",requiredVersion),"No Java SDK Found");
    }
 else {
      Messages.showErrorDialog(DevKitBundle.message("no.idea.sdk.version.found"),"No Java SDK Found");
    }
    return false;
  }
  final int choice=Messages.showChooseDialog("Select Java SDK to be used as IDEA internal platform","Select Internal Java Platform",ArrayUtil.toStringArray(javaSdks),javaSdks.get(0),Messages.getQuestionIcon());
  if (choice != -1) {
    final String name=javaSdks.get(choice);
    final Sdk jdk=sdkModel.findSdk(name);
    LOG.assertTrue(jdk != null);
    setupSdkPaths(sdkModificator,sdk.getHomePath(),jdk);
    sdkModificator.setSdkAdditionalData(new Sandbox(getDefaultSandbox(),jdk,sdk));
    sdkModificator.setVersionString(jdk.getVersionString());
    sdkModificator.commitChanges();
    return true;
  }
  return false;
}
