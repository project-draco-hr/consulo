{
  if (myStubRoots != null)   return myStubRoots;
  final T psi=getPsi();
  if (psi == null) {
    return new PsiFileStub[]{this};
  }
  final FileViewProvider viewProvider=psi.getViewProvider();
  final PsiFile stubBindingRoot=viewProvider.getStubBindingRoot();
  StubTree baseTree=getOrCalcStubTree(stubBindingRoot);
  if (baseTree != null) {
    final List<PsiFileStub> roots=new SmartList<PsiFileStub>(baseTree.getRoot());
    final List<Pair<IStubFileElementType,PsiFile>> stubbedRoots=StubTreeBuilder.getStubbedRoots(viewProvider);
    for (    Pair<IStubFileElementType,PsiFile> stubbedRoot : stubbedRoots) {
      if (stubbedRoot.second == stubBindingRoot)       continue;
      final StubTree secondaryStubTree=getOrCalcStubTree(stubbedRoot.second);
      if (secondaryStubTree != null) {
        final PsiFileStub root=secondaryStubTree.getRoot();
        roots.add(root);
      }
    }
    final PsiFileStub[] rootsArray=roots.toArray(new PsiFileStub[roots.size()]);
    for (    PsiFileStub root : rootsArray) {
      if (root instanceof PsiFileStubImpl) {
        ((PsiFileStubImpl)root).setStubRoots(rootsArray);
      }
    }
    myStubRoots=rootsArray;
    return rootsArray;
  }
  return PsiFileStub.EMPTY_ARRAY;
}
