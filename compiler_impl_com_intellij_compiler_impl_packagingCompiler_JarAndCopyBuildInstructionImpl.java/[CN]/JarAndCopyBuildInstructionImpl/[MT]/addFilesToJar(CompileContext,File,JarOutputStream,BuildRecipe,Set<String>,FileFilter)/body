{
  @NonNls final String moduleName=getModule() == null ? "jar" : ModuleUtil.getModuleNameInReadAction(getModule());
  final File tempFile=File.createTempFile(moduleName + "___",TMP_FILE_SUFFIX);
  myTempJars.add(tempFile);
  makeJar(context,tempFile,fileFilter);
  final String outputRelativePath=getOutputRelativePath();
  File file=getJarFile();
  if (isExternalDependencyInstruction()) {
    final File toFile=DeploymentUtil.canonicalRelativePath(jarFile,outputRelativePath);
    DeploymentUtil.getInstance().copyFile(file,toFile,context,null,fileFilter);
    dependencies.addInstruction(this);
  }
 else {
    ZipUtil.addFileToZip(outputStream,file,outputRelativePath,writtenRelativePaths,fileFilter);
  }
}
