{
  try {
    PsiElementFactory factory=myManager.getElementFactory();
    PsiType initializerType=getInitializerType(myForcedType,myParameterInitializer,myLocalVariable);
    if (myParameterInitializer == null) {
      LOG.assertTrue(myLocalVariable != null);
      myParameterInitializer=factory.createExpressionFromText(myLocalVariable.getName(),myLocalVariable);
    }
 else {
      myParameterInitializer=RefactoringUtil.convertInitializerToNormalExpression(myParameterInitializer,initializerType);
    }
    ChangeContextUtil.encodeContextInfo(myParameterInitializer,true);
    for (    UsageInfo usage : usages) {
      if (!(usage instanceof InternalUsageInfo)) {
        if (usage instanceof DefaultConstructorImplicitUsageInfo) {
          addSuperCall(((DefaultConstructorImplicitUsageInfo)usage).getConstructor());
        }
 else         if (usage instanceof NoConstructorClassUsageInfo) {
          addDefaultConstructor(((NoConstructorClassUsageInfo)usage).getPsiClass());
        }
 else {
          PsiElement element=usage.getElement();
          if (element instanceof PsiMethod) {
            if (!myManager.areElementsEquivalent(element,myMethodToReplaceIn)) {
              changeMethodSignatureAndResolveFieldConflicts((PsiMethod)element,initializerType);
            }
          }
 else           if (!myGenerateDelegate) {
            changeExternalUsage(usage);
          }
        }
      }
    }
    if (myGenerateDelegate) {
      generateDelegate();
    }
    LOG.assertTrue(initializerType.isValid());
    final FieldConflictsResolver fieldConflictsResolver=new FieldConflictsResolver(myParameterName,myMethodToReplaceIn.getBody());
    changeMethodSignature(myMethodToReplaceIn,initializerType);
    if (myMethodToSearchFor != myMethodToReplaceIn) {
      changeMethodSignatureAndResolveFieldConflicts(myMethodToSearchFor,initializerType);
    }
    ChangeContextUtil.clearContextInfo(myParameterInitializer);
    for (    UsageInfo usage : usages) {
      if (usage instanceof ChangedMethodCallInfo) {
        PsiElement element=usage.getElement();
        processChangedMethodCall(element);
      }
 else       if (usage instanceof InternalUsageInfo) {
        PsiElement element=usage.getElement();
        if (element instanceof PsiExpression) {
          element=RefactoringUtil.outermostParenthesizedExpression((PsiExpression)element);
        }
        if (element.getParent() instanceof PsiExpressionStatement) {
          element.getParent().delete();
        }
 else {
          PsiElement newExpr=factory.createExpressionFromText(myParameterName,element);
          element.replace(newExpr);
        }
      }
    }
    if (myLocalVariable != null && myRemoveLocalVariable) {
      myLocalVariable.normalizeDeclaration();
      myLocalVariable.getParent().delete();
    }
    fieldConflictsResolver.fix();
  }
 catch (  IncorrectOperationException ex) {
    LOG.error(ex);
  }
}
