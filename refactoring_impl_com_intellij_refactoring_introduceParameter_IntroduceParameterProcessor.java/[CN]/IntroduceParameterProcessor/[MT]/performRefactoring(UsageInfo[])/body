{
  try {
    PsiElementFactory factory=JavaPsiFacade.getInstance(myManager.getProject()).getElementFactory();
    PsiType initializerType=getInitializerType(myForcedType,myParameterInitializer,myLocalVariable);
    setForcedType(initializerType);
    if (myParameterInitializer == null) {
      LOG.assertTrue(myLocalVariable != null);
      myParameterInitializer=factory.createExpressionFromText(myLocalVariable.getName(),myLocalVariable);
    }
 else {
      myParameterInitializer=RefactoringUtil.convertInitializerToNormalExpression(myParameterInitializer,initializerType);
    }
    for (    UsageInfo usage : usages) {
      if (!(usage instanceof InternalUsageInfo)) {
        if (usage instanceof DefaultConstructorImplicitUsageInfo) {
          addSuperCall(usage,usages);
        }
 else         if (usage instanceof NoConstructorClassUsageInfo) {
          addDefaultConstructor(usage,usages);
        }
 else {
          PsiElement element=usage.getElement();
          if (element instanceof PsiMethod) {
            if (!myManager.areElementsEquivalent(element,myMethodToReplaceIn)) {
              changeMethodSignatureAndResolveFieldConflicts(usage,usages);
            }
          }
 else           if (!myGenerateDelegate) {
            changeExternalUsage(usage,usages);
          }
        }
      }
    }
    if (myGenerateDelegate) {
      generateDelegate();
    }
    LOG.assertTrue(initializerType.isValid());
    final FieldConflictsResolver fieldConflictsResolver=new FieldConflictsResolver(myParameterName,myMethodToReplaceIn.getBody());
    changeMethodSignatureAndResolveFieldConflicts(new UsageInfo(myMethodToReplaceIn),usages);
    if (myMethodToSearchFor != myMethodToReplaceIn) {
      changeMethodSignatureAndResolveFieldConflicts(new UsageInfo(myMethodToSearchFor),usages);
    }
    ChangeContextUtil.clearContextInfo(myParameterInitializer);
    for (    UsageInfo usage : usages) {
      if (usage instanceof ChangedMethodCallInfo) {
        PsiElement element=usage.getElement();
        processChangedMethodCall(element);
      }
 else       if (usage instanceof InternalUsageInfo) {
        PsiElement element=usage.getElement();
        if (element instanceof PsiExpression) {
          element=RefactoringUtil.outermostParenthesizedExpression((PsiExpression)element);
        }
        if (element.getParent() instanceof PsiExpressionStatement) {
          element.getParent().delete();
        }
 else {
          PsiExpression newExpr=factory.createExpressionFromText(myParameterName,element);
          IntroduceVariableBase.replace((PsiExpression)element,newExpr,myProject);
        }
      }
    }
    if (myLocalVariable != null && myRemoveLocalVariable) {
      myLocalVariable.normalizeDeclaration();
      myLocalVariable.getParent().delete();
    }
    fieldConflictsResolver.fix();
  }
 catch (  IncorrectOperationException ex) {
    LOG.error(ex);
  }
}
