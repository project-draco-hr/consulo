{
  myEditor=editor;
  final Project project=getProject(file);
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final PsiElement list=ParameterInfoController.findArgumentList(file,editor.getCaretModel().getOffset(),-1);
  if (list != null) {
    myParameterInfoController=ParameterInfoController.findControllerAtOffset(editor,list.getTextRange().getStartOffset());
  }
  PsiElement originalElement=file != null ? file.findElementAt(editor.getCaretModel().getOffset()) : null;
  PsiElement element=findTargetElement(editor,file,originalElement);
  if (element == null && myParameterInfoController != null) {
    final Object[] objects=myParameterInfoController.getSelectedElements();
    if (objects != null && objects.length > 0) {
      if (objects[0] instanceof PsiElement) {
        element=(PsiElement)objects[0];
      }
    }
  }
  if (element == null && file == null)   return null;
  if (element == null) {
    element=originalElement;
    if (element == null)     return null;
    PsiComment comment=PsiTreeUtil.getParentOfType(element,PsiComment.class);
    if (comment == null)     return null;
    element=comment.getParent();
  }
  JBPopupImpl oldHint=(JBPopupImpl)getDocInfoHint();
  if (oldHint != null) {
    DocumentationComponent component=(DocumentationComponent)oldHint.getComponent();
    PsiElement element1=component.getElement();
    if (Comparing.equal(element,element1)) {
      if (requestFocus) {
        component.getComponent().requestFocus();
      }
      return oldHint;
    }
    oldHint.cancel();
  }
  final DocumentationComponent component=new DocumentationComponent(this);
  storeOriginalElement(project,originalElement,element);
  final PopupUpdateProcessor updateProcessor=new PopupUpdateProcessor(new Condition<PsiElement>(){
    public boolean value(    final PsiElement element){
      if (myEditor != null) {
        final PsiFile file=element.getContainingFile();
        if (file != null) {
          Editor editor=myEditor;
          showJavaDocInfo(myEditor,file,false);
          myEditor=editor;
        }
      }
 else {
        showJavaDocInfo(element);
      }
      return false;
    }
  }
);
  final JBPopup hint=JBPopupFactory.getInstance().createComponentPopupBuilder(component,component).setRequestFocusCondition(project,NotLookupOrSearchCondition.INSTANCE).setProject(project).addListener(updateProcessor).addUserData(updateProcessor).setForceHeavyweight(false).setDimensionServiceKey(project,JAVADOC_LOCATION_AND_SIZE,false).setResizable(true).setMovable(true).setTitle(getTitle(element)).setCancelCallback(new Computable<Boolean>(){
    public Boolean compute(){
      if (fromQuickSearch()) {
        ((ChooseByNameBase.JPanelProvider)myPreviouslyFocused.getParent()).unregisterHint();
      }
      Disposer.dispose(component);
      myEditor=null;
      myPreviouslyFocused=null;
      myParameterInfoController=null;
      return Boolean.TRUE;
    }
  }
).createPopup();
  component.setHint(hint);
  fetchDocInfo(getDefaultCollector(element),component);
  myDocInfoHintRef=new WeakReference<JBPopup>(hint);
  myPreviouslyFocused=WindowManagerEx.getInstanceEx().getFocusedComponent(project);
  return hint;
}
