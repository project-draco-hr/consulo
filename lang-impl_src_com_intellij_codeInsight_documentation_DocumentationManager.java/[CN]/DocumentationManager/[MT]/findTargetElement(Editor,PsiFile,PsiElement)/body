{
  PsiElement element=editor != null ? TargetElementUtilBase.findTargetElement(editor,ourFlagsForTargetElements) : null;
  if (element != null || contextElement != null) {
    final PsiElement adjusted=TargetElementUtilBase.getInstance().adjustElement(editor,ourFlagsForTargetElements,element,contextElement);
    if (adjusted != null) {
      element=adjusted;
    }
  }
  if (element == null && editor != null) {
    final PsiReference ref=TargetElementUtilBase.findReference(editor,editor.getCaretModel().getOffset());
    if (ref != null) {
      element=TargetElementUtilBase.getInstance().adjustReference(ref);
      if (element == null && ref instanceof PsiPolyVariantReference) {
        element=ref.getElement();
      }
    }
    final Lookup activeLookup=LookupManager.getInstance(myProject).getActiveLookup();
    if (activeLookup != null) {
      LookupElement item=activeLookup.getCurrentItem();
      if (item == null)       return null;
      final DocumentationProvider documentationProvider=getProviderFromElement(file);
      if (documentationProvider != null) {
        element=documentationProvider.getDocumentationElementForLookupItem(PsiManager.getInstance(myProject),item.getObject(),ref != null ? ref.getElement() : contextElement);
      }
    }
  }
  storeOriginalElement(myProject,contextElement,element);
  return element;
}
