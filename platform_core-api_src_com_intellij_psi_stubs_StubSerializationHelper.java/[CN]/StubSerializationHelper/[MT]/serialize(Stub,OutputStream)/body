{
  BufferExposingByteArrayOutputStream out=new BufferExposingByteArrayOutputStream();
  FileLocalStringEnumerator storage=new FileLocalStringEnumerator(true);
  StubOutputStream stubOutputStream=new StubOutputStream(out,storage);
  if (rootStub instanceof PsiFileStub) {
    final PsiFileStub[] roots=((PsiFileStub)rootStub).getStubRoots();
    DataInputOutputUtil.writeINT(stubOutputStream,roots.length);
    for (    PsiFileStub root : roots) {
      doSerialize(root,stubOutputStream);
    }
  }
 else {
    DataInputOutputUtil.writeINT(stubOutputStream,1);
    doSerialize(rootStub,stubOutputStream);
  }
  DataOutputStream resultStream=new DataOutputStream(stream);
  DataInputOutputUtil.writeINT(resultStream,storage.myStrings.size());
  byte[] buffer=IOUtil.allocReadWriteUTFBuffer();
  for (  String s : storage.myStrings) {
    IOUtil.writeUTFFast(buffer,resultStream,s);
  }
  resultStream.write(out.getInternalBuffer(),0,out.size());
}
