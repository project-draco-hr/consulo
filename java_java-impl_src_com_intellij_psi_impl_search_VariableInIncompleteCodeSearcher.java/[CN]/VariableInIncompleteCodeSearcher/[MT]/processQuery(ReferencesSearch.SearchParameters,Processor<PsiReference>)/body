{
  final PsiElement refElement=p.getElementToSearch();
  if (!(refElement instanceof PsiLocalVariable || refElement instanceof PsiParameter))   return;
  final String name=((PsiVariable)refElement).getName();
  if (name == null)   return;
  final SearchScope scope=refElement.getUseScope();
  if (!(scope instanceof LocalSearchScope))   return;
  final PsiElement[] scopeElements=((LocalSearchScope)scope).getScope();
  for (  PsiElement scopeElement : scopeElements) {
    PsiTreeUtil.processElements(scopeElement,new PsiElementProcessor(){
      @Override public boolean execute(      final PsiElement element){
        if (element instanceof PsiJavaCodeReferenceElement) {
          final PsiJavaCodeReferenceElement ref=(PsiJavaCodeReferenceElement)element;
          if (name.equals(ref.getCanonicalText()) && ref.resolve() == null && ref.advancedResolve(true).getElement() == refElement) {
            consumer.process(ref);
          }
        }
        return true;
      }
    }
);
  }
}
