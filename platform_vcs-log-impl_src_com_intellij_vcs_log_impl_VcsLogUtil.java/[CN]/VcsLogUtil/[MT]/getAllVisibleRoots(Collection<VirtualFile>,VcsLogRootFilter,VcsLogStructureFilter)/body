{
  if (rootFilter == null && structureFilter == null)   return new HashSet<VirtualFile>(roots);
  Collection<VirtualFile> fromRootFilter;
  if (rootFilter != null) {
    fromRootFilter=rootFilter.getRoots();
  }
 else {
    fromRootFilter=roots;
  }
  Collection<VirtualFile> fromStructureFilter;
  if (structureFilter != null) {
    Pair<Set<VirtualFile>,MultiMap<VirtualFile,VirtualFile>> rootsAndFiles=collectRoots(structureFilter.getFiles(),new HashSet<VirtualFile>(roots));
    fromStructureFilter=ContainerUtil.union(rootsAndFiles.first,rootsAndFiles.second.keySet());
  }
 else {
    fromStructureFilter=roots;
  }
  return new HashSet<VirtualFile>(ContainerUtil.intersection(fromRootFilter,fromStructureFilter));
}
