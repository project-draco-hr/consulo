{
  if (file instanceof PsiCompiledElement)   file=(PsiFile)((PsiCompiledElement)file).getMirror();
  PsiElement target=targets[0];
  HighlightManager highlightManager=HighlightManager.getInstance(project);
  boolean clearHighlights=isClearHighlights(editor,highlightManager);
  PsiFile context=InjectedLanguageUtil.getTopLevelFile(file);
  SearchScope searchScope=new LocalSearchScope(context);
  final FindUsagesManager findUsagesManager=((FindManagerImpl)FindManager.getInstance(project)).getFindUsagesManager();
  final FindUsagesHandler handler=findUsagesManager.getFindUsagesHandler(target,true);
  Collection<PsiReference> refs;
  if (handler != null) {
    refs=handler.findReferencesToHighlight(target,searchScope);
  }
 else {
    refs=ReferencesSearch.search(target,searchScope,false).findAll();
  }
  return new DoHighlightRunnable(new ArrayList<PsiReference>(refs),project,target,editor,context,clearHighlights);
}
