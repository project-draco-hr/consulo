{
  if (!CodeInsightUtil.prepareFileForWrite(file))   return;
  PsiReferenceExpression[] refs=CreateFromUsageUtils.collectExpressions(myRefExpr,PsiMember.class,PsiFile.class);
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    PsiElement element=PsiTreeUtil.getParentOfType(myRefExpr,PsiMember.class,PsiFile.class);
    LookupItem[] items=collectItems();
    ReferenceNameExpression refExpr=new ReferenceNameExpression(items,myRefExpr.getReferenceName());
    TemplateBuilder builder=new TemplateBuilder(element);
    for (    PsiReferenceExpression expr : refs) {
      if (!expr.equals(myRefExpr)) {
        builder.replaceElement(expr.getReferenceNameElement(),OTHER_VARIABLE_NAME,INPUT_VARIABLE_NAME,false);
      }
 else {
        builder.replaceElement(expr.getReferenceNameElement(),INPUT_VARIABLE_NAME,refExpr,true);
      }
    }
    final float proportion=EditorUtil.calcVerticalScrollProportion(editor);
    editor.getCaretModel().moveToOffset(element.getTextRange().getStartOffset());
    Template template=builder.buildInlineTemplate();
    editor.getCaretModel().moveToOffset(element.getTextRange().getStartOffset());
    TemplateManager.getInstance(project).startTemplate(editor,template);
    EditorUtil.setVerticalScrollProportion(editor,proportion);
  }
}
