{
  checkForReachables();
  final RefFilter filter=myPhase == 1 ? new StrictUnreferencedFilter(this) : new RefUnreachableFilter(this);
  final boolean[] requestAdded=new boolean[]{false};
  final ImplicitUsageProvider[] implicitUsageProviders=ApplicationManager.getApplication().getComponents(ImplicitUsageProvider.class);
  getRefManager().iterate(new RefVisitor(){
    public void visitElement(    RefEntity refEntity){
      if (!(refEntity instanceof RefElement))       return;
      if (refEntity instanceof RefClass && ((RefClass)refEntity).isAnonymous())       return;
      RefElement refElement=(RefElement)refEntity;
      if (filter.accepts(refElement) && !myProcessedSuspicious.contains(refElement)) {
        refEntity.accept(new RefVisitor(){
          public void visitField(          final RefField refField){
            myProcessedSuspicious.add(refField);
            PsiField psiField=refField.getElement();
            if (isSerializationImplicitlyUsedField(psiField)) {
              getEntryPointsManager().addEntryPoint(refField,false);
              return;
            }
            getContext().enqueueFieldUsagesProcessor(refField,new GlobalInspectionContextImpl.UsagesProcessor(){
              public boolean process(              PsiReference psiReference){
                getEntryPointsManager().addEntryPoint(refField,false);
                return false;
              }
            }
);
            requestAdded[0]=true;
          }
          public void visitMethod(          final RefMethod refMethod){
            myProcessedSuspicious.add(refMethod);
            if (refMethod instanceof RefImplicitConstructor) {
              visitClass(refMethod.getOwnerClass());
            }
 else {
              PsiMethod psiMethod=(PsiMethod)refMethod.getElement();
              if (isSerializablePatternMethod(psiMethod)) {
                getEntryPointsManager().addEntryPoint(refMethod,false);
                return;
              }
              for (              ImplicitUsageProvider provider : implicitUsageProviders) {
                if (provider.isImplicitUsage(psiMethod)) {
                  getEntryPointsManager().addEntryPoint(refMethod,false);
                  return;
                }
              }
              if (!refMethod.isExternalOverride() && refMethod.getAccessModifier() != PsiModifier.PRIVATE) {
                for (                final RefMethod derivedMethod : refMethod.getDerivedMethods()) {
                  myProcessedSuspicious.add(derivedMethod);
                }
                if (isAddEjbInterfaceMethodsEnabled()) {
                  if (refMethod.isEjbDeclaration() || refMethod.isEjbImplementation()) {
                    addEjbMethodToEntries(refMethod);
                    return;
                  }
                }
                enqueueMethodUsages(refMethod);
                requestAdded[0]=true;
              }
            }
          }
          public void visitClass(          final RefClass refClass){
            myProcessedSuspicious.add(refClass);
            if (refClass.isEjb()) {
              getEntryPointsManager().addEntryPoint(refClass,false);
            }
 else             if (!refClass.isAnonymous()) {
              getContext().enqueueDerivedClassesProcessor(refClass,new GlobalInspectionContextImpl.DerivedClassesProcessor(){
                public boolean process(                PsiClass inheritor){
                  getEntryPointsManager().addEntryPoint(refClass,false);
                  return false;
                }
              }
);
              getContext().enqueueClassUsagesProcessor(refClass,new GlobalInspectionContextImpl.UsagesProcessor(){
                public boolean process(                PsiReference psiReference){
                  getEntryPointsManager().addEntryPoint(refClass,false);
                  return false;
                }
              }
);
              requestAdded[0]=true;
            }
          }
        }
);
      }
    }
  }
);
  if (!requestAdded[0]) {
    if (myPhase == 2) {
      myProcessedSuspicious=null;
      return false;
    }
 else {
      myPhase=2;
    }
  }
  return true;
}
