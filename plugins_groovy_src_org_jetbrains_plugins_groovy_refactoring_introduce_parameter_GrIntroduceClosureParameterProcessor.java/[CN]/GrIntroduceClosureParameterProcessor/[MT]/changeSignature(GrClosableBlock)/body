{
  final String name=mySettings.getName();
  final FieldConflictsResolver fieldConflictsResolver=new FieldConflictsResolver(name,block);
  final GrParameter[] parameters=block.getParameters();
  mySettings.parametersToRemove().forEachDescending(new TIntProcedure(){
    public boolean execute(    final int paramNum){
      try {
        PsiParameter param=parameters[paramNum];
        param.delete();
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
      return true;
    }
  }
);
  final PsiType type=mySettings.getSelectedType();
  final String typeText=type == null ? null : type.getCanonicalText();
  GrParameter parameter=myFactory.createParameter(name,typeText,block);
  parameter.getModifierList().setModifierProperty(PsiModifier.FINAL,mySettings.declareFinal());
  final GrParameterList parameterList=block.getParameterList();
  final PsiParameter anchorParameter=GroovyIntroduceParameterUtil.getAnchorParameter(parameterList,block.isVarArgs());
  parameter=(GrParameter)parameterList.addAfter(parameter,anchorParameter);
  if (block.getArrow() == null) {
    final PsiElement arrow=block.addAfter(myFactory.createClosureFromText("{->}").getArrow().copy(),parameterList);
    final PsiElement child=block.getFirstChild().getNextSibling();
    if (TokenSets.WHITE_SPACES_SET.contains(child.getNode().getElementType())) {
      block.addAfter(child,arrow);
      child.delete();
    }
  }
  GrReferenceAdjuster.shortenReferences(parameter);
  fieldConflictsResolver.fix();
}
