{
  ArrayList<UsageInfo> result=new ArrayList<UsageInfo>();
  if (!mySettings.generateDelegate() && toSearchFor != null) {
    Collection<PsiReference> refs;
    if (toSearchFor instanceof GrField) {
      refs=ReferencesSearch.search(toSearchFor,toSearchFor.getResolveScope(),true).findAll();
      final GrAccessorMethod[] getters=((GrField)toSearchFor).getGetters();
      for (      GrAccessorMethod getter : getters) {
        refs.addAll(MethodReferencesSearch.search(getter,getter.getResolveScope(),true).findAll());
      }
    }
 else     if (toSearchFor instanceof GrVariable) {
      refs=findUsagesForLocal(toReplaceIn,((GrVariable)toSearchFor));
    }
 else {
      refs=ReferencesSearch.search(toSearchFor,toSearchFor.getResolveScope(),true).findAll();
    }
    for (    PsiReference ref1 : refs) {
      PsiElement ref=ref1.getElement();
      if (!PsiTreeUtil.isAncestor(toReplaceIn,ref,false)) {
        result.add(new ExternalUsageInfo(ref));
      }
 else {
        result.add(new ChangedMethodCallInfo(ref));
      }
    }
    if (toSearchFor instanceof GrVariable && !((GrVariable)toSearchFor).hasModifierProperty(PsiModifier.FINAL)) {
      setPreviewUsages(true);
    }
  }
  if (mySettings.replaceAllOccurrences()) {
    PsiElement[] exprs=myContext.getOccurrences();
    for (    PsiElement expr : exprs) {
      result.add(new InternalUsageInfo(expr));
    }
  }
 else {
    if (myContext.getExpression() != null) {
      result.add(new InternalUsageInfo(myContext.getExpression()));
    }
  }
  final UsageInfo[] usageInfos=result.toArray(new UsageInfo[result.size()]);
  return UsageViewUtil.removeDuplicatedUsages(usageInfos);
}
