{
  GrClosableBlock toReplaceIn=this.toReplaceIn;
  if (mySettings.generateDelegate()) {
    LOG.assertTrue(toSearchFor instanceof GrVariable);
    toReplaceIn=generateDelegate(this.toReplaceIn,(GrVariable)toSearchFor);
  }
 else {
    processExternalUsages(usages);
  }
  changeSignature(toReplaceIn);
  if (myContext.var != null)   myContext.var.delete();
  for (  UsageInfo usage : usages) {
    if (usage instanceof ChangedMethodCallInfo) {
      PsiElement element=usage.getElement();
      processChangedMethodCall(element);
    }
 else     if (usage instanceof InternalUsageInfo) {
      PsiElement element=usage.getElement();
      if (element == null)       continue;
      GrExpression newExpr=myFactory.createExpressionFromText(mySettings.getName());
      if (element instanceof GrExpression) {
        ((GrExpression)element).replaceWithExpression(newExpr,true);
      }
 else {
        element.replace(newExpr);
      }
    }
  }
  if (myContext.var != null && mySettings.removeLocalVariable()) {
    myContext.var.delete();
  }
}
