{
  HashMap<VirtualFile,Set<VirtualFile>> map=new HashMap<VirtualFile,Set<VirtualFile>>();
  for (  VirtualFile aFile : files) {
    VirtualFile file=aFile.isDirectory() ? aFile : aFile.getParent();
    VirtualFile[] path=getPathComponents(file);
    Set<VirtualFile> filesSet;
    if (map.containsKey(path[0])) {
      filesSet=map.get(path[0]);
    }
 else {
      map.put(path[0],filesSet=new HashSet<VirtualFile>());
    }
    filesSet.add(file);
  }
  ArrayList<VirtualFile> ancestorsList=new ArrayList<VirtualFile>();
  for (  Set<VirtualFile> filesSet : map.values()) {
    VirtualFile ancestor=null;
    for (    VirtualFile file : filesSet) {
      if (ancestor == null) {
        ancestor=file;
        continue;
      }
      ancestor=getCommonAncestor(ancestor,file);
    }
    ancestorsList.add(ancestor);
    filesSet.clear();
  }
  return ancestorsList.toArray(new VirtualFile[ancestorsList.size()]);
}
