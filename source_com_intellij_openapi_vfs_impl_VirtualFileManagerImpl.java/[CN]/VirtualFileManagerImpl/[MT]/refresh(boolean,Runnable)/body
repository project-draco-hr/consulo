{
  final ModalityState modalityState=calcModalityStateForRefreshEventsPosting(asynchronous);
  beforeRefreshStart(asynchronous,modalityState,postAction);
  try {
    if (!asynchronous) {
      ApplicationManager.getApplication().assertIsDispatchThread();
    }
    final VirtualFile[] managedRoots=ManagingFS.getInstance().getRoots();
    for (int i=0; i < managedRoots.length; i++) {
      VirtualFile root=managedRoots[i];
      boolean last=i + 1 == managedRoots.length;
      RefreshQueue.getInstance().refresh(asynchronous,true,last ? postAction : null,root);
    }
    for (    VirtualFileSystem fileSystem : myFileSystems) {
      if (!(fileSystem instanceof NewVirtualFileSystem)) {
        fileSystem.refresh(asynchronous);
      }
    }
  }
  finally {
    afterRefreshFinish(asynchronous,modalityState);
  }
}
