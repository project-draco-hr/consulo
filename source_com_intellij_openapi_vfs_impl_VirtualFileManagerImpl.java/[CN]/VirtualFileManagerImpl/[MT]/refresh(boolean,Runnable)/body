{
  final ModalityState modalityState;
  if (EventQueue.isDispatchThread()) {
    modalityState=ModalityState.current();
  }
 else {
    final ProgressIndicator progressIndicator=myProgressManager.getProgressIndicator();
    modalityState=(progressIndicator != null) ? progressIndicator.getModalityState() : ModalityState.NON_MMODAL;
  }
  beforeRefreshStart(asynchronous,modalityState,postAction);
  try {
    if (!asynchronous) {
      LOG.assertTrue(ApplicationManager.getApplication().isDispatchThread(),"Synchronous refresh can be performed in AWT-thread only!");
    }
    LOG.info("refresh(), modalityState=" + modalityState);
    for (int i=0; i < myFileSystems.size(); i++) {
      VirtualFileSystem fileSystem=myFileSystems.get(i);
      fileSystem.refresh(asynchronous);
    }
  }
  finally {
    afterRefreshFinish(asynchronous,modalityState);
  }
}
