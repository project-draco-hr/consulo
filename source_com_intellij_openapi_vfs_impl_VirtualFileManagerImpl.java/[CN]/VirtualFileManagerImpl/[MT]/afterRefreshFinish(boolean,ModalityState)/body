{
  Runnable action=new Runnable(){
    public void run(){
      ApplicationManager.getApplication().assertIsDispatchThread();
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          for (int i=0; i < myRefreshEventsToFire.size(); i++) {
            Runnable runnable=myRefreshEventsToFire.get(i);
            try {
              runnable.run();
            }
 catch (            Exception e) {
              LOG.error(e);
            }
          }
          if (myRefreshCount > 1) {
            myRefreshCount--;
            myRefreshEventsToFire.clear();
          }
 else {
            final FileSystemSynchronizer synchronizer;
            if (asynchronous) {
              synchronizer=new FileSystemSynchronizer();
              for (int i=0; i < myRefreshParticipants.size(); i++) {
                CacheUpdater participant=myRefreshParticipants.get(i);
                synchronizer.registerCacheUpdater(participant);
              }
            }
 else {
              synchronizer=null;
            }
            myVirtualFileManagerListenerMulticaster.getMulticaster().afterRefreshFinish(asynchronous);
            myRefreshCount--;
            myRefreshEventsToFire=null;
            if (asynchronous) {
              int filesCount=synchronizer.collectFilesToUpdate();
              if (filesCount > 0) {
                boolean runWithProgress=!ApplicationManager.getApplication().isUnitTestMode() && filesCount > 5;
                if (runWithProgress) {
                  Runnable process=new Runnable(){
                    public void run(){
                      synchronizer.execute();
                    }
                  }
;
                  ProgressManager.getInstance().runProcessWithProgressSynchronously(process,VfsBundle.message("file.update.modified.progress"),false,null);
                }
 else {
                  synchronizer.execute();
                }
              }
            }
            for (            final Runnable runnable : myPostRefreshRunnables) {
              runnable.run();
            }
            myPostRefreshRunnables.clear();
          }
        }
      }
);
    }
  }
;
  if (asynchronous) {
    ApplicationManager.getApplication().invokeLater(action,modalityState);
  }
 else {
    action.run();
  }
}
