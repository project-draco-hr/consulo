{
  refElement.setFlag(true,CAN_BE_FINAL_MASK);
  if (refElement instanceof RefClass) {
    final RefClass refClass=((RefClass)refElement);
    final PsiClass psiClass=(PsiClass)refClass.getElement();
    EjbClassRole role=EjbRolesUtil.getEjbRole(psiClass);
    if (role != null) {
      refClass.setFlag(false,CAN_BE_FINAL_MASK);
      return;
    }
    if (refClass.isAbstract() || refClass.isAnonymous() || refClass.isInterface()) {
      refClass.setFlag(false,CAN_BE_FINAL_MASK);
      return;
    }
    if (!refClass.isSelfInheritor(psiClass)) {
      for (      PsiClass psiSuperClass : psiClass.getSupers()) {
        if (RefUtil.getInstance().belongsToScope(psiSuperClass,myManager)) {
          RefClass refSuperClass=(RefClass)myManager.getReference(psiSuperClass);
          if (refSuperClass != null) {
            refSuperClass.setFlag(false,CAN_BE_FINAL_MASK);
          }
        }
      }
    }
  }
 else   if (refElement instanceof RefMethodImpl) {
    final RefMethodImpl refMethod=(RefMethodImpl)refElement;
    PsiMethod psiMethod=(PsiMethod)refMethod.getElement();
    if (refMethod.isConstructor() || refMethod.isAbstract() || refMethod.isStatic()|| PsiModifier.PRIVATE.equals(refMethod.getAccessModifier())|| refMethod.getOwnerClass().isAnonymous()|| refMethod.getOwnerClass().isInterface()) {
      refMethod.setFlag(false,CAN_BE_FINAL_MASK);
    }
    if (PsiModifier.PRIVATE.equals(refMethod.getAccessModifier()) && refMethod.getOwner() != null && !(refMethod.getOwnerClass().getOwner() instanceof RefElement)) {
      refMethod.setFlag(false,CAN_BE_FINAL_MASK);
    }
    for (    PsiMethod psiSuperMethod : psiMethod.findSuperMethods()) {
      if (RefUtil.getInstance().belongsToScope(psiSuperMethod,myManager)) {
        RefMethodImpl refSuperMethod=(RefMethodImpl)myManager.getReference(psiSuperMethod);
        if (refSuperMethod != null) {
          refSuperMethod.setFlag(false,CAN_BE_FINAL_MASK);
        }
      }
    }
  }
}
