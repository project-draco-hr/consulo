{
  if (refElement instanceof RefClass) {
    final PsiClass psiClass=(PsiClass)refElement.getElement();
    if (psiClass != null) {
      EjbClassRole role=EjbRolesUtil.getEjbRolesUtil().getEjbRole(psiClass);
      if (role != null) {
        ((RefClassImpl)refElement).setFlag(false,CAN_BE_FINAL_MASK);
      }
      PsiMethod[] psiMethods=psiClass.getMethods();
      PsiField[] psiFields=psiClass.getFields();
      HashSet<PsiVariable> allFields=new HashSet<PsiVariable>();
      allFields.addAll(Arrays.asList(psiFields));
      ArrayList<PsiVariable> instanceInitializerInitializedFields=new ArrayList<PsiVariable>();
      boolean hasInitializers=false;
      for (      PsiClassInitializer initializer : psiClass.getInitializers()) {
        PsiCodeBlock body=initializer.getBody();
        hasInitializers=true;
        ControlFlow flow;
        try {
          flow=ControlFlowFactory.getControlFlow(body,LocalsOrMyInstanceFieldsControlFlowPolicy.getInstance(),false);
        }
 catch (        AnalysisCanceledException e) {
          flow=ControlFlow.EMPTY;
        }
        PsiVariable[] ssaVariables=ControlFlowUtil.getSSAVariables(flow,false);
        PsiVariable[] writtenVariables=ControlFlowUtil.getWrittenVariables(flow,0,flow.getSize(),false);
        for (int j=0; j < ssaVariables.length; j++) {
          PsiVariable psiVariable=writtenVariables[j];
          if (allFields.contains(psiVariable)) {
            if (instanceInitializerInitializedFields.contains(psiVariable)) {
              allFields.remove(psiVariable);
              instanceInitializerInitializedFields.remove(psiVariable);
            }
 else {
              instanceInitializerInitializedFields.add(psiVariable);
            }
          }
        }
        for (        PsiVariable psiVariable : writtenVariables) {
          if (!instanceInitializerInitializedFields.contains(psiVariable)) {
            allFields.remove(psiVariable);
          }
        }
      }
      for (      PsiMethod psiMethod : psiMethods) {
        if (psiMethod.isConstructor()) {
          PsiCodeBlock body=psiMethod.getBody();
          if (body != null) {
            hasInitializers=true;
            ControlFlow flow;
            try {
              flow=ControlFlowFactory.getControlFlow(body,LocalsOrMyInstanceFieldsControlFlowPolicy.getInstance(),false);
            }
 catch (            AnalysisCanceledException e) {
              flow=ControlFlow.EMPTY;
            }
            PsiVariable[] writtenVariables=ControlFlowUtil.getWrittenVariables(flow,0,flow.getSize(),false);
            for (            PsiVariable psiVariable : writtenVariables) {
              if (instanceInitializerInitializedFields.contains(psiVariable)) {
                allFields.remove(psiVariable);
                instanceInitializerInitializedFields.remove(psiVariable);
              }
            }
            List<PsiMethod> redirectedConstructors=HighlightControlFlowUtil.getChainedConstructors(psiMethod);
            if (redirectedConstructors == null || redirectedConstructors.isEmpty()) {
              PsiVariable[] ssaVariables=ControlFlowUtil.getSSAVariables(flow,false);
              ArrayList<PsiVariable> good=new ArrayList<PsiVariable>(Arrays.asList(ssaVariables));
              good.addAll(instanceInitializerInitializedFields);
              allFields.retainAll(good);
            }
 else {
              allFields.removeAll(Arrays.asList(writtenVariables));
            }
          }
        }
      }
      for (      PsiField psiField : psiFields) {
        if ((!hasInitializers || !allFields.contains(psiField)) && psiField.getInitializer() == null) {
          ((RefFieldImpl)myManager.getReference(psiField)).setFlag(false,CAN_BE_FINAL_MASK);
        }
      }
    }
  }
 else   if (refElement instanceof RefMethod) {
    final RefMethod refMethod=(RefMethod)refElement;
    final PsiElement element=refMethod.getElement();
    if (element instanceof PsiMethod) {
      PsiMethod method=(PsiMethod)element;
      final EjbHelper helper=EjbHelper.getEjbHelper();
      EjbClassRole classRole=helper.getEjbRole(method.getContainingClass());
      if (classRole != null) {
        if (!refMethod.hasSuperMethods()) {
          ((RefMethodImpl)refMethod).setFlag(false,CAN_BE_FINAL_MASK);
        }
        EjbMethodRole role=helper.getEjbRole(method);
        if (role instanceof EjbDeclMethodRole || role instanceof EjbImplMethodRole) {
          ((RefMethodImpl)refMethod).setFlag(false,CAN_BE_FINAL_MASK);
        }
      }
    }
  }
}
