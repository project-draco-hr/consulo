{
  Map<VirtualFile,List<FilePath>> rc=new HashMap<VirtualFile,List<FilePath>>();
  for (  FilePath p : files) {
    VirtualFile root=getGitRootOrNull(p);
    if (root == null) {
      if (ignoreNonGit) {
        continue;
      }
 else {
        throw new VcsException("The file " + p.getPath() + " is not under Git");
      }
    }
    List<FilePath> l=rc.get(root);
    if (l == null) {
      l=new ArrayList<FilePath>();
      rc.put(root,l);
    }
    l.add(p);
  }
  return rc;
}
