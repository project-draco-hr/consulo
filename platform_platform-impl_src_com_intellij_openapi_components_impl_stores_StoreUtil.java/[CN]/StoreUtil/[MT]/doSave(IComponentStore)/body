{
  ComponentSaveSession session=stateStore.startSave();
  if (session == null) {
    return;
  }
  ShutDownTracker.getInstance().registerStopperThread(Thread.currentThread());
  try {
    List<Pair<SaveSession,VirtualFile>> readonlyFiles=new SmartList<Pair<SaveSession,VirtualFile>>();
    session.save(readonlyFiles);
  }
 catch (  Throwable e) {
    PluginId pluginId=IdeErrorsDialog.findPluginId(e);
    if (pluginId == null) {
      if (e instanceof RuntimeException) {
        throw ((RuntimeException)e);
      }
 else {
        throw new StateStorageException(e);
      }
    }
 else {
      throw new PluginException(e,pluginId);
    }
  }
 finally {
    try {
      session.finishSave();
    }
  finally {
      ShutDownTracker.getInstance().unregisterStopperThread(Thread.currentThread());
    }
  }
}
