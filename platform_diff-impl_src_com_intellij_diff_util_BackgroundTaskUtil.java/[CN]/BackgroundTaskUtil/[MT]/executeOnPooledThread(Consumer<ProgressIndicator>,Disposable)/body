{
  final ModalityState modalityState=ModalityState.current();
  final ProgressIndicator indicator=new EmptyProgressIndicator(){
    @NotNull @Override public ModalityState getModalityState(){
      return modalityState;
    }
  }
;
  indicator.start();
  final Disposable disposable=new Disposable(){
    @Override public void dispose(){
      if (indicator.isRunning())       indicator.cancel();
    }
  }
;
  Disposer.register(parent,disposable);
  ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
    @Override public void run(){
      ProgressManager.getInstance().executeProcessUnderProgress(new Runnable(){
        @Override public void run(){
          try {
            task.consume(indicator);
          }
  finally {
            indicator.stop();
            Disposer.dispose(disposable);
          }
        }
      }
,indicator);
    }
  }
);
  return indicator;
}
