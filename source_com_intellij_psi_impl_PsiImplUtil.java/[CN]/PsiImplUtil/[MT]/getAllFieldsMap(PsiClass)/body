{
  if (!psiClass.isPhysical()) {
    return _getAllFieldsMap(psiClass);
  }
  final Pair<Map<String,List<CandidateInfo>>,Runnable> value=psiClass.getUserData(FIELDS_MAP_IN_CLASS_KEY);
  if (value == null) {
    final Map<String,List<CandidateInfo>> allFields=_getAllFieldsMap(psiClass);
    final Runnable cleaner=new Runnable(){
      public void run(){
        psiClass.putUserData(FIELDS_MAP_IN_CLASS_KEY,null);
      }
    }
;
    psiClass.putUserData(FIELDS_MAP_IN_CLASS_KEY,new Pair<Map<String,List<CandidateInfo>>,Runnable>(allFields,cleaner));
    PsiManagerImpl manager=(PsiManagerImpl)psiClass.getManager();
    manager.registerWeakRunnableToRunOnChange(cleaner);
    return allFields;
  }
  return value.first;
}
