{
  if (type instanceof PsiCapturedWildcardType) {
    return normalizeWildcardTypeByPosition(((PsiCapturedWildcardType)type).getWildcard(),expression);
  }
  PsiExpression toplevel=expression;
  while (toplevel.getParent() instanceof PsiArrayAccessExpression && ((PsiArrayAccessExpression)toplevel.getParent()).getArrayExpression() == toplevel) {
    toplevel=(PsiExpression)toplevel.getParent();
  }
  if (type instanceof PsiWildcardType) {
    return notmalizeWildcardByPositionImpl(expression,toplevel,(PsiWildcardType)type);
  }
 else   if (type instanceof PsiArrayType) {
    PsiType componentType=((PsiArrayType)type).getComponentType();
    if (componentType instanceof PsiCapturedWildcardType)     componentType=((PsiCapturedWildcardType)componentType).getWildcard();
    if (componentType instanceof PsiWildcardType) {
      final PsiType normalizedComponentType=notmalizeWildcardByPositionImpl(expression,toplevel,(PsiWildcardType)componentType);
      return normalizedComponentType.createArrayType();
    }
  }
 else   if (type instanceof PsiClassType && !PsiUtil.isAccessedForWriting(toplevel)) {
    return PsiUtil.captureToplevelWildcards(type,expression);
  }
  return type;
}
