{
  if (type instanceof PsiCapturedWildcardType) {
    return normalizeWildcardTypeByPosition(((PsiCapturedWildcardType)type).getWildcard(),expression);
  }
  PsiExpression toplevel=expression;
  while (toplevel.getParent() instanceof PsiArrayAccessExpression && ((PsiArrayAccessExpression)toplevel.getParent()).getArrayExpression() == toplevel) {
    toplevel=(PsiExpression)toplevel.getParent();
  }
  if (type instanceof PsiWildcardType) {
    final PsiWildcardType wildcardType=(PsiWildcardType)type;
    if (PsiUtil.isAccessedForWriting(toplevel)) {
      return wildcardType.isSuper() ? wildcardType.getBound() : PsiCapturedWildcardType.create(wildcardType);
    }
 else {
      if (wildcardType.isExtends()) {
        return wildcardType.getBound();
      }
 else {
        return PsiType.getJavaLangObject(expression.getManager(),expression.getResolveScope());
      }
    }
  }
 else   if (type instanceof PsiArrayType) {
    final PsiType componentType=((PsiArrayType)type).getComponentType();
    final PsiType normalizedComponentType=normalizeWildcardTypeByPosition(componentType,expression);
    if (normalizedComponentType != componentType) {
      return normalizedComponentType.createArrayType();
    }
  }
 else   if (type instanceof PsiClassType && !PsiUtil.isAccessedForWriting(toplevel)) {
    return PsiUtil.captureToplevelWildcards(type);
  }
  return type;
}
