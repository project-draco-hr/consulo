{
  if (type instanceof PsiCapturedWildcardType) {
    return normalizeWildcardTypeByPosition(((PsiCapturedWildcardType)type).getWildcard(),expression);
  }
  if (type instanceof PsiWildcardType) {
    final PsiWildcardType wildcardType=(PsiWildcardType)type;
    if (PsiUtil.isInCovariantPosition(expression)) {
      return wildcardType.isSuper() ? wildcardType.getBound() : PsiCapturedWildcardType.create(wildcardType);
    }
 else {
      if (wildcardType.isExtends()) {
        return wildcardType.getBound();
      }
 else {
        return PsiType.getJavaLangObject(expression.getManager(),expression.getResolveScope());
      }
    }
  }
 else   if (type instanceof PsiArrayType) {
    final PsiType componentType=((PsiArrayType)type).getComponentType();
    final PsiType normalizedComponentType=normalizeWildcardTypeByPosition(componentType,expression);
    if (normalizedComponentType != componentType) {
      return normalizedComponentType.createArrayType();
    }
 else {
      return type;
    }
  }
 else {
    return type;
  }
}
