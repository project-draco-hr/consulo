{
  ShutDownTracker.getInstance().registerStopperThread(Thread.currentThread());
  try {
    if (!ourSaveSettingsInProgress) {
      try {
        ourSaveSettingsInProgress=true;
        startLoggingUsedMacros();
        saveSettingsSavingComponents();
        final Module[] modules=ModuleManager.getInstance(this).getModules();
        final ReadonlyStatusHandler.OperationStatus operationStatus=ensureConfigFilesWritable(modules);
        if (operationStatus.hasReadonlyFiles()) {
          MessagesEx.error(this,ProjectBundle.message("project.save.error",operationStatus.getReadonlyFilesMessage())).showLater();
          return;
        }
        final Exception[] exception=new Exception[]{null};
        CommandProcessor.getInstance().executeCommand(this,new Runnable(){
          public void run(){
            for (            Module module1 : modules) {
              ModuleImpl module=(ModuleImpl)module1;
              try {
                module._save();
              }
 catch (              Exception e) {
                exception[0]=e;
                return;
              }
            }
            try {
              _save();
            }
 catch (            Exception e) {
              exception[0]=e;
            }
          }
        }
,ProjectBundle.message("project.save.settings.command"),null);
        if (exception[0] != null) {
          LOG.info(exception[0]);
          MessagesEx.error(this,ProjectBundle.message("project.save.error",exception[0].getMessage())).showLater();
        }
      }
  finally {
        endLoggingUsedMacros();
        ourSaveSettingsInProgress=false;
      }
    }
  }
  finally {
    ShutDownTracker.getInstance().unregisterStopperThread(Thread.currentThread());
  }
}
