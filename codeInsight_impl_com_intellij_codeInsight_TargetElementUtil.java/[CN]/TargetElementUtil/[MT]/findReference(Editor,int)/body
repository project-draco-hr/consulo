{
  ApplicationManager.getApplication().assertIsDispatchThread();
  Project project=editor.getProject();
  if (project == null)   return null;
  Document document=editor.getDocument();
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
  if (file == null)   return null;
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  offset=adjustOffset(document,offset);
  if (file instanceof PsiCompiledElement) {
    return ((PsiCompiledElement)file).getMirror().findReferenceAt(offset);
  }
  return file.findReferenceAt(offset);
}
