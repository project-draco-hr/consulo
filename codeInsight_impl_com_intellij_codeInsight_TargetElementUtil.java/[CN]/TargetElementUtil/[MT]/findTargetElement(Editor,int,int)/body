{
  ApplicationManager.getApplication().assertIsDispatchThread();
  Project project=editor.getProject();
  if (project == null)   return null;
  Lookup activeLookup=LookupManager.getInstance(project).getActiveLookup();
  if (activeLookup != null && (flags & LOOKUP_ITEM_ACCEPTED) != 0) {
    final PsiElement lookupItem=getLookupItem(activeLookup);
    return lookupItem != null && lookupItem.isValid() ? lookupItem : null;
  }
  Document document=editor.getDocument();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
  if (file == null)   return null;
  offset=adjustOffset(document,offset);
  if ((flags & REFERENCED_ELEMENT_ACCEPTED) != 0) {
    final PsiElement referenceOrReferencedElement=getReferenceOrReferencedElement(file,editor,flags,offset);
    if (referenceOrReferencedElement != null && referenceOrReferencedElement.isValid())     return referenceOrReferencedElement;
  }
  PsiElement element=file.findElementAt(offset);
  if (element == null)   return null;
  if ((flags & ELEMENT_NAME_ACCEPTED) != 0) {
    if (element instanceof PsiNamedElement)     return element;
    PsiElement parent=element.getParent();
    if (element instanceof PsiIdentifier) {
      if (parent instanceof PsiClass && element.equals(((PsiClass)parent).getNameIdentifier())) {
        return parent;
      }
 else       if (parent instanceof PsiVariable && element.equals(((PsiVariable)parent).getNameIdentifier())) {
        return parent;
      }
 else       if (parent instanceof PsiMethod && element.equals(((PsiMethod)parent).getNameIdentifier())) {
        return parent;
      }
 else       if (parent instanceof PsiLabeledStatement && element.equals(((PsiLabeledStatement)parent).getLabelIdentifier())) {
        return parent;
      }
    }
 else     if (parent instanceof PsiNamedElement) {
      if (parent.getTextOffset() == element.getTextRange().getStartOffset() && !(parent instanceof XmlAttribute)) {
        return parent;
      }
    }
  }
  if (element instanceof PsiKeyword) {
    if (element.getParent() instanceof PsiThisExpression) {
      if ((flags & THIS_ACCEPTED) == 0)       return null;
      PsiType type=((PsiThisExpression)element.getParent()).getType();
      if (!(type instanceof PsiClassType))       return null;
      return ((PsiClassType)type).resolve();
    }
    if (element.getParent() instanceof PsiSuperExpression) {
      if ((flags & SUPER_ACCEPTED) == 0)       return null;
      PsiType type=((PsiSuperExpression)element.getParent()).getType();
      if (!(type instanceof PsiClassType))       return null;
      return ((PsiClassType)type).resolve();
    }
    if (PsiKeyword.TRY.equals(element.getText())) {
      if ((flags & TRY_ACCEPTED) == 0)       return null;
      return element;
    }
    if (PsiKeyword.CATCH.equals(element.getText())) {
      if ((flags & CATCH_ACCEPTED) == 0)       return null;
      return element;
    }
    if (PsiKeyword.THROWS.equals(element.getText())) {
      if ((flags & THROWS_ACCEPTED) == 0)       return null;
      return element;
    }
    if (PsiKeyword.THROW.equals(element.getText())) {
      if ((flags & THROW_ACCEPTED) != 0)       return element;
      if ((flags & THROW_STATEMENT_ACCEPTED) != 0) {
        final PsiElement parent=element.getParent();
        if (parent instanceof PsiThrowStatement) {
          return parent;
        }
      }
      return null;
    }
    if (PsiKeyword.RETURN.equals(element.getText())) {
      if ((flags & RETURN_ACCEPTED) == 0)       return null;
      return element;
    }
  }
  return null;
}
