{
  try {
    markDirty(true);
    final int dataOff=myKeyStorage != null ? myKeyStoreBufferPosition + myKeyStoreFileLength : ((InlineKeyDescriptor<Data>)myDataDescriptor).toInt(value);
    if (myKeyStorage != null) {
      final BufferExposingByteArrayOutputStream bos=new BufferExposingByteArrayOutputStream();
      DataOutput out=new DataOutputStream(bos);
      myDataDescriptor.save(out,value);
      final int size=bos.size();
      final byte[] buffer=bos.getInternalBuffer();
      if (size > myKeyStoreFileBuffer.length) {
        flushKeyStoreBuffer();
        myKeyStorage.put(dataOff,buffer,0,size);
        myKeyStoreFileLength+=size;
      }
 else {
        if (size > myKeyStoreFileBuffer.length - myKeyStoreBufferPosition) {
          flushKeyStoreBuffer();
        }
        System.arraycopy(buffer,0,myKeyStoreFileBuffer,myKeyStoreBufferPosition,size);
        myKeyStoreBufferPosition+=size;
      }
    }
    return setupValueId(hashCode,dataOff);
  }
 catch (  IOException e) {
    throw new RuntimeException(e);
  }
}
