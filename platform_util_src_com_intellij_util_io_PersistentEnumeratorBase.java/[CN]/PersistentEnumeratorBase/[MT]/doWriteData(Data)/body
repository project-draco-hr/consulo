{
  final int dataOff=myKeyStorage != null ? myKeyStoreBufferPosition + myKeyStoreFileLength : ((InlineKeyDescriptor<Data>)myDataDescriptor).toInt(value);
  if (myKeyStorage != null) {
    final BufferExposingByteArrayOutputStream bos=new BufferExposingByteArrayOutputStream();
    DataOutput out=new DataOutputStream(bos);
    myDataDescriptor.save(out,value);
    final int size=bos.size();
    final byte[] buffer=bos.getInternalBuffer();
    if (size > myInitialSize) {
      flushKeyStoreBuffer();
      myKeyStorage.put(dataOff,buffer,0,size);
      myKeyStoreFileLength+=size;
    }
 else {
      if (size > myInitialSize - myKeyStoreBufferPosition) {
        flushKeyStoreBuffer();
      }
      if (myKeyStoreFileBuffer == null) {
        myKeyStoreFileBuffer=new byte[myInitialSize];
      }
      System.arraycopy(buffer,0,myKeyStoreFileBuffer,myKeyStoreBufferPosition,size);
      myKeyStoreBufferPosition+=size;
    }
  }
  return dataOff;
}
