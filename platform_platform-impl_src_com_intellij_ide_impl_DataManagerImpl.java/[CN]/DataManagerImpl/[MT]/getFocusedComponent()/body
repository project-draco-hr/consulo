{
  if (myWindowManager == null) {
    return null;
  }
  Window activeWindow=myWindowManager.getMostRecentFocusedWindow();
  if (activeWindow == null) {
    activeWindow=KeyboardFocusManager.getCurrentKeyboardFocusManager().getActiveWindow();
    if (activeWindow == null) {
      activeWindow=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
      if (activeWindow == null)       return null;
    }
  }
  if (Registry.is("actionSystem.noContextComponentWhileFocusTransfer")) {
    IdeFocusManager fm=IdeFocusManager.findInstanceByComponent(activeWindow);
    if (fm.isFocusBeingTransferred()) {
      return null;
    }
  }
  Window window=activeWindow;
  Component focusedComponent=null;
  while (window != null) {
    focusedComponent=myWindowManager.getFocusedComponent(window);
    if (focusedComponent != null) {
      break;
    }
    window=window.getOwner();
  }
  if (focusedComponent == null) {
    focusedComponent=activeWindow;
  }
  return focusedComponent;
}
