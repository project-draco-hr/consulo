{
  if (myWindowManager == null) {
    return null;
  }
  Window activeWindow=myWindowManager.getMostRecentFocusedWindow();
  if (activeWindow == null) {
    activeWindow=KeyboardFocusManager.getCurrentKeyboardFocusManager().getActiveWindow();
    if (activeWindow == null) {
      activeWindow=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
      if (activeWindow == null)       return null;
    }
  }
  if (Registry.is("actionSystem.noContextComponentWhileFocusTransfer")) {
    IdeFocusManager fm=IdeFocusManager.findInstanceByComponent(activeWindow);
    if (fm.isFocusBeingTransferred()) {
      return null;
    }
  }
  if (activeWindow instanceof FloatingDecorator) {
    IdeFocusManager ideFocusManager=IdeFocusManager.findInstanceByComponent(activeWindow);
    IdeFrame lastFocusedFrame=ideFocusManager.getLastFocusedFrame();
    JComponent frameComponent=lastFocusedFrame != null ? lastFocusedFrame.getComponent() : null;
    Window lastFocusedWindow=frameComponent != null ? SwingUtilities.getWindowAncestor(frameComponent) : null;
    boolean toolWindowIsNotFocused=myWindowManager.getFocusedComponent(activeWindow) == null;
    if (toolWindowIsNotFocused && lastFocusedWindow != null) {
      activeWindow=lastFocusedWindow;
    }
  }
  Window window=activeWindow;
  Component focusedComponent=null;
  while (window != null) {
    focusedComponent=myWindowManager.getFocusedComponent(window);
    if (focusedComponent != null) {
      break;
    }
    window=window.getOwner();
  }
  if (focusedComponent == null) {
    focusedComponent=activeWindow;
  }
  return focusedComponent;
}
