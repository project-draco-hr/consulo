{
  final ProgressManager manager=ProgressManager.getInstance();
  final VcsException[] ex=new VcsException[1];
  handler.addLineListener(new GitLineHandlerListenerProgress(manager,handler,""){
    @Override public void processTerminted(    final int exitCode){
      if (exitCode != 0) {
        String text=getErrorText();
        if (text == null || text.length() == 0) {
          text=GitBundle.message("git.error.exit",exitCode);
        }
        ex[0]=new VcsException(text);
      }
    }
    @Override public void startFailed(    final Throwable exception){
      ex[0]=new VcsException("Git start failed: " + exception.toString(),exception);
    }
  }
);
  runInCurrentThread(handler,manager,false);
  if (ex[0] != null) {
    throw ex[0];
  }
}
