{
  final PsiElementFactory factory=myClass.getManager().getElementFactory();
  final Map<PsiReferenceExpression,PsiExpression> referencesToReplace=new HashMap<PsiReferenceExpression,PsiExpression>();
  final Map<PsiTypeElement,PsiTypeElement> typesToReplace=new HashMap<PsiTypeElement,PsiTypeElement>();
  method.accept(new PsiRecursiveElementVisitor(){
    public void visitReferenceExpression(    final PsiReferenceExpression expression){
      super.visitReferenceExpression(expression);
      final PsiElement element=expression.resolve();
      if (element instanceof PsiField) {
        try {
          PsiField field=(PsiField)element;
          if (field.getContainingClass() == method.getContainingClass()) {
            FieldInfo info=fieldMap.get(field.getName());
            if (info != null && info.replaceWithLocal) {
              final PsiExpression localRefExpr=factory.createExpressionFromText(info.localVar.getName(),method);
              referencesToReplace.put(expression,localRefExpr);
            }
          }
 else           if (myClass.getContainingClass() != null && field.getContainingClass() == myClass.getContainingClass() && outerClassLocal != null) {
            PsiReferenceExpression expr=(PsiReferenceExpression)expression.copy();
            PsiExpression qualifier=factory.createExpressionFromText(outerClassLocal.getName(),field.getContainingClass());
            expr.setQualifierExpression(qualifier);
            referencesToReplace.put(expression,expr);
          }
        }
 catch (        IncorrectOperationException e) {
          LOG.error(e);
        }
      }
    }
    public void visitTypeElement(    final PsiTypeElement typeElement){
      super.visitTypeElement(typeElement);
      if (typeElement.getType() instanceof PsiClassType) {
        PsiClassType classType=(PsiClassType)typeElement.getType();
        PsiClass psiClass=classType.resolve();
        if (psiClass instanceof PsiTypeParameter) {
          PsiClass containingClass=method.getContainingClass();
          PsiTypeParameter[] psiTypeParameters=containingClass.getTypeParameters();
          for (int i=0; i < psiTypeParameters.length; i++) {
            if (psiTypeParameters[i] == psiClass) {
              typesToReplace.put(typeElement,factory.createTypeElement(substitutedParameters[i]));
            }
          }
        }
      }
    }
  }
);
  for (  Map.Entry<PsiReferenceExpression,PsiExpression> e : referencesToReplace.entrySet()) {
    e.getKey().replace(e.getValue());
  }
  for (  Map.Entry<PsiTypeElement,PsiTypeElement> e : typesToReplace.entrySet()) {
    e.getKey().replace(e.getValue());
  }
}
