{
  String filePath=expandMacros(fileSpec);
  if (!ourHeadlessEnvironment && PathUtilRt.getFileName(filePath).lastIndexOf('.') < 0) {
    throw new IllegalArgumentException("Extension is missing for storage file: " + filePath);
  }
  if (roamingType == RoamingType.PER_USER && fileSpec.equals(StoragePathMacros.WORKSPACE_FILE)) {
    roamingType=RoamingType.DISABLED;
  }
  beforeFileBasedStorageCreate();
  return new FileBasedStorage(filePath,fileSpec,roamingType,getMacroSubstitutor(fileSpec),myRootTagName,StateStorageManagerImpl.this,createStorageTopicListener(),myStreamProvider){
    @Override @NotNull protected StorageData createStorageData(){
      return StateStorageManagerImpl.this.createStorageData(myFileSpec,getFilePath());
    }
    @Override protected boolean isUseXmlProlog(){
      return StateStorageManagerImpl.this.isUseXmlProlog();
    }
  }
;
}
