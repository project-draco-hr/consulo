{
  String expandedFile=expandMacros(fileSpec);
  if (expandedFile == null) {
    myStorages.put(fileSpec,null);
    return null;
  }
  String extension=FileUtilRt.getExtension(new File(expandedFile).getName());
  if (!ourHeadlessEnvironment && extension.isEmpty()) {
    throw new IllegalArgumentException("Extension is missing for storage file: " + expandedFile);
  }
  return new FileBasedStorage(getMacroSubstitutor(fileSpec),getStreamProvider(),expandedFile,fileSpec,myRootTagName,this,myPicoContainer,ComponentRoamingManager.getInstance(),this){
    @Override @NotNull protected StorageData createStorageData(){
      return StateStorageManagerImpl.this.createStorageData(fileSpec);
    }
  }
;
}
