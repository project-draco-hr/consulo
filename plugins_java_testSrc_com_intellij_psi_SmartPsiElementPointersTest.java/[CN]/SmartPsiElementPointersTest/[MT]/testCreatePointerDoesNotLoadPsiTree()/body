{
  VirtualFile vfile=myRoot.createChildData(this,"X.java");
  VfsUtil.saveText(vfile,"public class X { public int X; }");
  PsiClass aClass=myJavaFacade.findClass("X",GlobalSearchScope.allScope(getProject()));
  assertNotNull(aClass);
  assertTrue(aClass.isValid());
  PsiFileImpl file=(PsiFileImpl)aClass.getContainingFile();
  assertTreeLoaded(file,false);
  SmartPsiElementPointer p=SmartPointerManager.getInstance(myProject).createSmartPsiElementPointer(aClass);
  assertNotNull(p);
  assertTreeLoaded(file,false);
  assertInstanceOf(p.getElement(),PsiClass.class);
  assertTreeLoaded(file,false);
  PsiDocumentManager documentManager=PsiDocumentManager.getInstance(myProject);
  Document document=documentManager.getDocument(file);
  document.insertString(0,"/** asdasd */");
  documentManager.commitAllDocuments();
  assertTreeLoaded(file,true);
  assertInstanceOf(p.getElement(),PsiClass.class);
  assertTreeLoaded(file,true);
}
