{
  if (injection.getInjectionPlaces().isEmpty() || injection.getInjectionPlaces().size() > 1)   return null;
  AbstractTagInjection result;
  final InjectionPlace place=injection.getInjectionPlaces().get(0);
  final ElementPattern<PsiElement> rootPattern=place.getElementPattern();
  final ElementPatternCondition<PsiElement> rootCondition=rootPattern.getCondition();
  final Class<PsiElement> elementClass=rootCondition.getInitialCondition().getAcceptedClass();
  if (XmlAttribute.class.equals(elementClass)) {
    result=new XmlAttributeInjection().copyFrom(injection);
  }
 else   if (XmlTag.class.equals(elementClass)) {
    result=new XmlTagInjection().copyFrom(injection);
  }
 else   return null;
  result.getInjectionPlaces().clear();
  for (  PatternCondition<? super PsiElement> condition : rootCondition.getConditions()) {
    final String value=extractValue(condition);
    if (condition.getDebugMethodName().equals("withLocalName")) {
      if (value == null)       return null;
      if (result instanceof XmlAttributeInjection) {
        ((XmlAttributeInjection)result).setAttributeName(value);
      }
 else {
        result.setTagName(value);
      }
    }
 else     if (condition.getDebugMethodName().equals("withNamespace")) {
      if (value == null)       return null;
      if (result instanceof XmlAttributeInjection) {
        ((XmlAttributeInjection)result).setAttributeNamespace(value);
      }
 else {
        result.setTagNamespace(value);
      }
    }
 else     if (result instanceof XmlAttributeInjection && condition.getDebugMethodName().equals("inside") && condition instanceof PatternConditionPlus) {
      final ElementPattern<?> insidePattern=((PatternConditionPlus)condition).getValuePattern();
      if (!XmlTag.class.equals(insidePattern.getCondition().getInitialCondition().getAcceptedClass()))       return null;
      for (      PatternCondition<?> insideCondition : insidePattern.getCondition().getConditions()) {
        final String tagValue=extractValue(insideCondition);
        if (tagValue == null)         return null;
        if (insideCondition.getDebugMethodName().equals("withLocalName")) {
          result.setTagName(tagValue);
        }
 else         if (insideCondition.getDebugMethodName().equals("withNamespace")) {
          result.setTagNamespace(tagValue);
        }
      }
    }
 else     return null;
  }
  result.generatePlaces();
  return result;
}
