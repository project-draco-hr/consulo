{
  Configuration configuration=new DefaultConfiguration();
  configuration.setConfigurationCustomizer(customizer);
  configuration.setClassLoader(classLoader);
  configuration.setLocalRepository(localRepo);
  if (logger == null) {
    logger=new MavenEmbedderConsoleLogger();
    logger.setThreshold(MavenEmbedderLogger.LEVEL_WARN);
  }
  configuration.setMavenEmbedderLogger(logger);
  File userSettingsFile=resolveUserSettingsFile(userSettings);
  if (userSettingsFile != null) {
    configuration.setUserSettingsFile(userSettingsFile);
  }
  File globalSettingsFile=resolveGlobalSettingsFile(mavenHome);
  if (globalSettingsFile != null) {
    configuration.setGlobalSettingsFile(globalSettingsFile);
  }
  configuration.setSystemProperties(collectSystemProperties());
  validate(configuration);
  System.setProperty(PROP_MAVEN_HOME,mavenHome);
  try {
    return new MavenEmbedderWrapper(new MavenEmbedder(configuration));
  }
 catch (  MavenEmbedderException e) {
    MavenLog.LOG.info(e);
    throw new RuntimeException(e);
  }
}
