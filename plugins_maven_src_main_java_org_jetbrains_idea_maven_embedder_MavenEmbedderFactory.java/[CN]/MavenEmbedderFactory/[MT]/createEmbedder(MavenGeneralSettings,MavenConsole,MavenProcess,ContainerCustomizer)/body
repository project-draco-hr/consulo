{
  Configuration configuration=new DefaultConfiguration();
  configuration.setConfigurationCustomizer(customizer);
  configuration.setClassLoader(settings.getClass().getClassLoader());
  configuration.setLocalRepository(settings.getEffectiveLocalRepository());
  MavenEmbedderLogger logger=new MavenConsoleLogger(console);
  logger.setThreshold(settings.getOutputLevel());
  configuration.setMavenEmbedderLogger(logger);
  File userSettingsFile=resolveUserSettingsFile(settings.getMavenSettingsFile());
  if (userSettingsFile != null) {
    configuration.setUserSettingsFile(userSettingsFile);
  }
  File globalSettingsFile=resolveGlobalSettingsFile(settings.getMavenHome());
  if (globalSettingsFile != null) {
    configuration.setGlobalSettingsFile(globalSettingsFile);
  }
  configuration.setSystemProperties(collectSystemProperties());
  validate(configuration);
  System.setProperty(PROP_MAVEN_HOME,settings.getMavenHome());
  try {
    MavenEmbedder e=new MavenEmbedder(configuration);
    e.getSettings().setUsePluginRegistry(settings.isUsePluginRegistry());
    return new MavenEmbedderWrapper(e,process);
  }
 catch (  MavenEmbedderException e) {
    MavenLog.LOG.info(e);
    throw new RuntimeException(e);
  }
}
