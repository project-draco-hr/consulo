{
  if (modules.isEmpty()) {
    return new AnalysisScope(defaultProject);
  }
  final Module[] allModules=ModuleManager.getInstance(defaultProject).getModules();
  Set<Module> modulesToAnalyze=new HashSet<Module>();
  for (  final Module module : modules) {
    modulesToAnalyze.addAll(getDirectBackwardDependencies(module,allModules));
    modulesToAnalyze.addAll(getExportBackwardDependencies(module,allModules));
    modulesToAnalyze.add(module);
  }
  return new AnalysisScope(modulesToAnalyze.toArray(new Module[modulesToAnalyze.size()]));
}
