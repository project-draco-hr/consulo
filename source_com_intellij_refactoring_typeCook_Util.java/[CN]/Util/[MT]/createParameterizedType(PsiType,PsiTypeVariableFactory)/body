{
  if (t == null) {
    return factory.create();
  }
  if (t instanceof PsiClassType) {
    final PsiClassType.ClassResolveResult result=resolveType(t);
    final PsiSubstitutor aSubst=result.getSubstitutor();
    final PsiClass aClass=result.getElement();
    PsiSubstitutor theSubst=PsiSubstitutor.EMPTY;
    final HashSet<PsiTypeVariable> cluster=new HashSet<PsiTypeVariable>();
    for (Iterator<PsiTypeParameter> i=aSubst.getSubstitutionMap().keySet().iterator(); i.hasNext(); ) {
      final PsiTypeParameter parm=i.next();
      final PsiType type=createParameterizedType(aSubst.substitute(parm),factory);
      if (type instanceof PsiTypeVariable) {
        cluster.add((PsiTypeVariable)type);
      }
      theSubst=theSubst.put(parm,type);
    }
    if (cluster.size() > 1) {
      factory.registerCluster(cluster);
    }
    return aClass.getManager().getElementFactory().createType(aClass,theSubst);
  }
 else   if (t instanceof PsiArrayType) {
    return createParameterizedType(((PsiArrayType)t).getComponentType(),factory).createArrayType();
  }
  return t;
}
