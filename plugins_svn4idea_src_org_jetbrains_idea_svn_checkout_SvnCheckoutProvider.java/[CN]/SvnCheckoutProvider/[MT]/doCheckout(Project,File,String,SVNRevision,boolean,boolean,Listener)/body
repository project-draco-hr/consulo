{
  final Ref<Boolean> checkoutSuccessful=new Ref<Boolean>();
  final SVNException[] exception=new SVNException[1];
  @NonNls String fileURL="file://" + target.getAbsolutePath().replace(File.separatorChar,'/');
  final VirtualFile vf=VirtualFileManager.getInstance().findFileByUrl(fileURL);
  final Ref<Boolean> actionStarted=new Ref<Boolean>(Boolean.TRUE);
  final Task.Backgroundable checkoutBackgroundTask=new Task.Backgroundable(project,SvnBundle.message("message.title.check.out"),true,VcsConfiguration.getInstance(project).getCheckoutOption()){
    public void run(    @NotNull final ProgressIndicator indicator){
      if (!promptForWCopyFormat(target,project)) {
        actionStarted.set(Boolean.FALSE);
        return;
      }
      final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
      final SVNUpdateClient client=SvnVcs.getInstance(project).createUpdateClient();
      client.setEventHandler(new CheckoutEventHandler(SvnVcs.getInstance(project),false,progressIndicator));
      client.setIgnoreExternals(ignoreExternals);
      try {
        progressIndicator.setText(SvnBundle.message("progress.text.checking.out",target.getAbsolutePath()));
        client.doCheckout(SVNURL.parseURIEncoded(url),target,SVNRevision.UNDEFINED,revision,recursive ? SVNDepth.INFINITY : SVNDepth.FILES,true);
        progressIndicator.checkCanceled();
        checkoutSuccessful.set(Boolean.TRUE);
      }
 catch (      SVNCancelException ignore) {
      }
catch (      SVNException e) {
        exception[0]=e;
      }
 finally {
        client.setIgnoreExternals(false);
        client.setEventHandler(null);
        SvnWorkingCopyFormatHolder.setPresetFormat(null);
      }
    }
    public void onCancel(){
      onSuccess();
    }
    public void onSuccess(){
      if (!Boolean.TRUE.equals(actionStarted.get())) {
        return;
      }
      if (exception[0] != null) {
        Messages.showErrorDialog(SvnBundle.message("message.text.cannot.checkout",exception[0].getMessage()),SvnBundle.message("message.title.check.out"));
      }
      if (vf != null) {
        vf.refresh(true,true,new Runnable(){
          public void run(){
            ApplicationManager.getApplication().invokeLater(new Runnable(){
              public void run(){
                notifyListener();
              }
            }
);
          }
        }
);
      }
 else {
        notifyListener();
      }
    }
    private void notifyListener(){
      if (listener != null) {
        if (!checkoutSuccessful.isNull()) {
          listener.directoryCheckedOut(target);
        }
        listener.checkoutCompleted();
      }
    }
  }
;
  ProgressManager.getInstance().run(checkoutBackgroundTask);
}
