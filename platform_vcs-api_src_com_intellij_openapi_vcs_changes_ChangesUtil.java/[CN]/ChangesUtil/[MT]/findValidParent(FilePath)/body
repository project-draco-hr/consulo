{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  VirtualFile parent=file.getVirtualFile();
  if (parent == null) {
    parent=file.getVirtualFileParent();
  }
  if (parent == null) {
    File ioFile=file.getIOFile();
    final LocalFileSystem lfs=LocalFileSystem.getInstance();
    do {
      parent=lfs.findFileByIoFile(ioFile);
      if (parent != null)       break;
      parent=lfs.refreshAndFindFileByIoFile(ioFile);
      if (parent != null)       break;
      ioFile=ioFile.getParentFile();
      if (ioFile == null)       return null;
    }
 while (true);
  }
  return parent;
}
