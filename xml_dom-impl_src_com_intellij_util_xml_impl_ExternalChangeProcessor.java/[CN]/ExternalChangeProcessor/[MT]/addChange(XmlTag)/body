{
  final PsiFile file=tag.getContainingFile();
  DomInvocationHandler handler=myChangeSets.get(tag);
  if (handler != null)   return;
  while (tag != null) {
    final DomInvocationHandler data=tag.getUserData(DomManagerImpl.CACHED_DOM_HANDLER);
    if (data != null) {
      if (handler == null) {
        handler=data;
      }
      final Type chosenType=data.getDomElementType();
      final Type abstractType=data.getAbstractType();
      if (!chosenType.equals(abstractType) && !chosenType.equals(myDomManager.getTypeChooserManager().getTypeChooser(chosenType).chooseType(tag))) {
        handler=data;
      }
    }
    tag=tag.getParentTag();
  }
  if (handler == null && file instanceof XmlFile) {
    final DomFileElementImpl<DomElement> element=DomManagerImpl.getCachedFileElement((XmlFile)file);
    if (element != null) {
      handler=element.getRootHandler();
    }
  }
  if (handler != null) {
    myChangeSets.put(tag,handler);
  }
}
