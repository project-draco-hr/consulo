{
  if (entry instanceof ModuleSourceOrderEntry) {
    final ModuleRootModel rootModel=((ModuleSourceOrderEntry)entry).getRootModel();
    final ContentEntry[] entries=rootModel.getContentEntries();
    for (    final ContentEntry contentEntry : entries) {
      final VirtualFile contentRoot=contentEntry.getFile();
      for (      SourceFolder sourceFolder : contentEntry.getSourceFolders()) {
        String relativePath=EPathUtil.collapse2EclipsePath(sourceFolder.getUrl(),myModel);
        if (contentRoot != EPathUtil.getContentRoot(rootModel)) {
          final String linkedPath=EclipseModuleManager.getInstance(entry.getOwnerModule()).getEclipseLinkedSrcVariablePath(sourceFolder.getUrl());
          if (linkedPath != null) {
            relativePath=linkedPath;
          }
        }
        addOrderEntry(EclipseXml.SRC_KIND,relativePath,classpathRoot);
      }
    }
  }
 else   if (entry instanceof ModuleOrderEntry) {
    Element orderEntry=addOrderEntry(EclipseXml.SRC_KIND,"/" + ((ModuleOrderEntry)entry).getModuleName(),classpathRoot);
    setAttributeIfAbsent(orderEntry,EclipseXml.COMBINEACCESSRULES_ATTR,EclipseXml.FALSE_VALUE);
    setExported(orderEntry,((ExportableOrderEntry)entry));
  }
 else   if (entry instanceof LibraryOrderEntry) {
    final LibraryOrderEntry libraryOrderEntry=(LibraryOrderEntry)entry;
    final String libraryName=libraryOrderEntry.getLibraryName();
    final EclipseModuleManager eclipseModuleManager=EclipseModuleManager.getInstance(libraryOrderEntry.getOwnerModule());
    if (libraryOrderEntry.isModuleLevel()) {
      final String[] files=libraryOrderEntry.getRootUrls(OrderRootType.CLASSES);
      if (files.length > 0) {
        if (libraryName != null && libraryName.contains(IdeaXml.JUNIT) && Comparing.strEqual(files[0],EclipseClasspathReader.getJunitClsUrl(libraryName.contains("4")))) {
          final Element orderEntry=addOrderEntry(EclipseXml.CON_KIND,EclipseXml.JUNIT_CONTAINER + "/" + libraryName.substring(IdeaXml.JUNIT.length()),classpathRoot);
          setExported(orderEntry,libraryOrderEntry);
        }
 else {
          boolean newVarLibrary=false;
          String eclipseVariablePath=eclipseModuleManager.getEclipseVariablePath(files[0]);
          if (eclipseVariablePath == null && !eclipseModuleManager.isEclipseLibUrl(files[0])) {
            newVarLibrary=true;
            eclipseVariablePath=EPathUtil.collapse2EclipseVariabledPath(libraryOrderEntry,OrderRootType.CLASSES);
          }
          Element orderEntry;
          if (eclipseVariablePath != null) {
            orderEntry=addOrderEntry(EclipseXml.VAR_KIND,eclipseVariablePath,classpathRoot);
          }
 else {
            orderEntry=addOrderEntry(EclipseXml.LIB_KIND,EPathUtil.collapse2EclipsePath(files[0],myModel),classpathRoot);
          }
          final String srcRelativePath;
          String eclipseSrcVariablePath=null;
          boolean addSrcRoots=true;
          final String[] srcFiles=libraryOrderEntry.getRootUrls(OrderRootType.SOURCES);
          if (srcFiles.length == 0) {
            srcRelativePath=null;
          }
 else {
            final String srcFile=srcFiles[0];
            srcRelativePath=EPathUtil.collapse2EclipsePath(srcFile,myModel);
            if (eclipseVariablePath != null) {
              eclipseSrcVariablePath=eclipseModuleManager.getEclipseSrcVariablePath(srcFile);
              if (eclipseSrcVariablePath == null) {
                eclipseSrcVariablePath=EPathUtil.collapse2EclipseVariabledPath(libraryOrderEntry,OrderRootType.SOURCES);
                if (eclipseSrcVariablePath != null) {
                  eclipseSrcVariablePath="/" + eclipseSrcVariablePath;
                }
 else {
                  if (newVarLibrary) {
                    orderEntry.detach();
                    orderEntry=addOrderEntry(EclipseXml.LIB_KIND,EPathUtil.collapse2EclipsePath(files[0],myModel),classpathRoot);
                  }
 else {
                    LOG.info("Added root " + srcRelativePath + " (in existing var library) can't be replaced with any variable; src roots placed in .eml only");
                    addSrcRoots=false;
                  }
                }
              }
            }
          }
          setOrRemoveAttribute(orderEntry,EclipseXml.SOURCEPATH_ATTR,addSrcRoots ? (eclipseSrcVariablePath != null ? eclipseSrcVariablePath : srcRelativePath) : null);
          EJavadocUtil.setupJavadocAttributes(orderEntry,libraryOrderEntry,myModel);
          setExported(orderEntry,libraryOrderEntry);
        }
      }
    }
 else {
      final Element orderEntry;
      if (eclipseModuleManager.getUnknownCons().contains(libraryName)) {
        orderEntry=addOrderEntry(EclipseXml.CON_KIND,libraryName,classpathRoot);
      }
 else       if (Comparing.strEqual(libraryName,IdeaXml.ECLIPSE_LIBRARY)) {
        orderEntry=addOrderEntry(EclipseXml.CON_KIND,EclipseXml.ECLIPSE_PLATFORM,classpathRoot);
      }
 else {
        orderEntry=addOrderEntry(EclipseXml.CON_KIND,EclipseXml.USER_LIBRARY + "/" + libraryName,classpathRoot);
      }
      setExported(orderEntry,libraryOrderEntry);
    }
  }
 else   if (entry instanceof JdkOrderEntry) {
    if (entry instanceof InheritedJdkOrderEntry) {
      if (!EclipseModuleManager.getInstance(entry.getOwnerModule()).isForceConfigureJDK()) {
        addOrderEntry(EclipseXml.CON_KIND,EclipseXml.JRE_CONTAINER,classpathRoot);
      }
    }
 else {
      final Sdk jdk=((JdkOrderEntry)entry).getJdk();
      String jdkLink;
      if (jdk == null) {
        jdkLink=EclipseXml.JRE_CONTAINER;
      }
 else {
        jdkLink=EclipseXml.JRE_CONTAINER;
        if (jdk.getSdkType() instanceof JavaSdkType) {
          jdkLink+=EclipseXml.JAVA_SDK_TYPE;
        }
        jdkLink+="/" + jdk.getName();
      }
      addOrderEntry(EclipseXml.CON_KIND,jdkLink,classpathRoot);
    }
  }
 else {
    throw new ConversionException("Unknown EclipseProjectModel.ClasspathEntry: " + entry.getClass());
  }
}
