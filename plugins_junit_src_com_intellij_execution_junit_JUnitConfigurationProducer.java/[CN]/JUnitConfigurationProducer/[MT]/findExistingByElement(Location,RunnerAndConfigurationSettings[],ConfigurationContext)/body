{
  final PsiElement[] elements=LangDataKeys.PSI_ELEMENT_ARRAY.getData(context.getDataContext());
  if (elements != null && PatternConfigurationProducer.collectTestClasses(elements).size() > 1) {
    return null;
  }
  final Module predefinedModule=((JUnitConfiguration)((RunManagerImpl)RunManagerEx.getInstanceEx(location.getProject())).getConfigurationTemplate(getConfigurationFactory()).getConfiguration()).getConfigurationModule().getModule();
  location=JavaExecutionUtil.stepIntoSingleClass(location);
  final PsiElement element=location.getPsiElement();
  final PsiClass testClass=JUnitUtil.getTestClass(element);
  final PsiMethod testMethod=JUnitUtil.getTestMethod(element,false);
  final PsiPackage testPackage;
  if (element instanceof PsiPackage) {
    testPackage=(PsiPackage)element;
  }
 else   if (element instanceof PsiDirectory) {
    testPackage=JavaDirectoryService.getInstance().getPackage(((PsiDirectory)element));
  }
 else {
    testPackage=null;
  }
  for (  RunnerAndConfigurationSettings existingConfiguration : existingConfigurations) {
    final JUnitConfiguration unitConfiguration=(JUnitConfiguration)existingConfiguration.getConfiguration();
    final TestObject testobject=unitConfiguration.getTestObject();
    if (testobject != null) {
      if (testobject.isConfiguredByElement(unitConfiguration,testClass,testMethod,testPackage)) {
        final Module configurationModule=unitConfiguration.getConfigurationModule().getModule();
        if (Comparing.equal(location.getModule(),configurationModule))         return existingConfiguration;
        if (Comparing.equal(predefinedModule,configurationModule)) {
          return existingConfiguration;
        }
      }
    }
  }
  return null;
}
