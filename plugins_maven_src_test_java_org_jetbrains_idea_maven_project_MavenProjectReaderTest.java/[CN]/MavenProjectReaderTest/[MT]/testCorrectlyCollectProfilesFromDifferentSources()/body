{
  createProjectPom("<groupId>test</groupId>" + "<artifactId>parent</artifactId>" + "<version>1</version>"+ "<profiles>"+ "  <profile>"+ "    <id>profile</id>"+ "    <modules><module>parent</module></modules>"+ "  </profile>"+ "</profiles>");
  final VirtualFile parentProfiles=createProfilesXml("<profile>" + "  <id>profile</id>" + "  <modules><module>parentProfiles</module></modules>"+ "</profile>");
  VirtualFile module=createModulePom("module","<groupId>test</groupId>" + "<artifactId>module</artifactId>" + "<version>1</version>"+ "<parent>"+ "  <groupId>test</groupId>"+ "  <artifactId>parent</artifactId>"+ "  <version>1</version>"+ "</parent>"+ "<profiles>"+ "  <profile>"+ "    <id>profile</id>"+ "    <modules><module>pom</module></modules>"+ "  </profile>"+ "</profiles>");
  updateSettingsXml("<profiles>" + "  <profile>" + "    <id>profile</id>"+ "    <modules><module>settings</module></modules>"+ "  </profile>"+ "</profiles>");
  final VirtualFile profiles=createProfilesXml("module","<profile>" + "  <id>profile</id>" + "  <modules><module>profiles</module></modules>"+ "</profile>");
  MavenModel p=readProject(module);
  assertEquals(1,p.getProfiles().size());
  assertEquals("pom",p.getProfiles().get(0).getModules().get(0));
  assertEquals("pom",p.getProfiles().get(0).getSource());
  createModulePom("module","<groupId>test</groupId>" + "<artifactId>module</artifactId>" + "<version>1</version>"+ "<parent>"+ "  <groupId>test</groupId>"+ "  <artifactId>parent</artifactId>"+ "  <version>1</version>"+ "</parent>");
  p=readProject(module);
  assertEquals(1,p.getProfiles().size());
  assertEquals("profiles",p.getProfiles().get(0).getModules().get(0));
  assertEquals("profiles.xml",p.getProfiles().get(0).getSource());
  new WriteCommandAction.Simple(myProject){
    @Override protected void run() throws Throwable {
      profiles.delete(this);
    }
  }
.execute().throwException();
  p=readProject(module);
  assertEquals(1,p.getProfiles().size());
  assertEmpty("parent",p.getProfiles().get(0).getModules());
  assertEquals("pom",p.getProfiles().get(0).getSource());
  createProjectPom("<groupId>test</groupId>" + "<artifactId>parent</artifactId>" + "<version>1</version>");
  p=readProject(module);
  assertEquals(1,p.getProfiles().size());
  assertEmpty("parentProfiles",p.getProfiles().get(0).getModules());
  assertEquals("profiles.xml",p.getProfiles().get(0).getSource());
  new WriteCommandAction.Simple(myProject){
    @Override protected void run() throws Throwable {
      parentProfiles.delete(null);
    }
  }
.execute().throwException();
  p=readProject(module);
  assertEquals(1,p.getProfiles().size());
  assertEmpty("settings",p.getProfiles().get(0).getModules());
  assertEquals("settings.xml",p.getProfiles().get(0).getSource());
}
