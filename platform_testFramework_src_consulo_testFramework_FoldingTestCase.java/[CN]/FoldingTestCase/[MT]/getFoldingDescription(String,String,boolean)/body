{
  FileType fileTypeByFileName=FileTypeManager.getInstance().getFileTypeByFileName(fileName);
  PsiFile file=createFile(fileName,fileTypeByFileName,content);
  final FileEditorManager fileEditorManager=FileEditorManager.getInstance(myProject);
  Editor editor=fileEditorManager.openTextEditor(new OpenFileDescriptor(myProject,file.getVirtualFile()),false);
  CodeFoldingManager.getInstance(myProject).buildInitialFoldings(editor);
  final FoldingModel model=editor.getFoldingModel();
  final FoldRegion[] foldingRegions=model.getAllFoldRegions();
  final List<Border> borders=new LinkedList<Border>();
  for (  FoldRegion region : foldingRegions) {
    borders.add(new Border(Border.LEFT,region.getStartOffset(),region.getPlaceholderText(),region.isExpanded()));
    borders.add(new Border(Border.RIGHT,region.getEndOffset(),"",region.isExpanded()));
  }
  Collections.sort(borders);
  StringBuilder result=new StringBuilder(editor.getDocument().getText());
  for (  Border border : borders) {
    result.insert(border.getOffset(),border.isSide() == Border.LEFT ? "<fold text=\'" + border.getText() + "\'"+ (doCheckCollapseStatus ? " expand=\'" + border.isExpanded() + "\'" : "")+ ">" : END_FOLD);
  }
  return result.toString();
}
