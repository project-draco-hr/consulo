{
  @NotNull final Project project=directory.getProject();
  if (props == null) {
    props=FileTemplateManager.getInstance().getDefaultProperties();
  }
  FileTemplateManager.getInstance().addRecentName(template.getName());
  fillDefaultProperties(props,directory);
  if (fileName != null && props.getProperty(FileTemplate.ATTRIBUTE_NAME) == null) {
    props.setProperty(FileTemplate.ATTRIBUTE_NAME,fileName);
  }
  String[] dummyRefs=calculateAttributes(template.getText(),props,true);
  for (  String dummyRef : dummyRefs) {
    props.setProperty(dummyRef,"");
  }
  String mergedText;
  try {
    if (template.isJavaClassTemplate()) {
      String packageName=props.getProperty(FileTemplate.ATTRIBUTE_PACKAGE_NAME);
      if (packageName == null || packageName.length() == 0) {
        props=new Properties(props);
        props.setProperty(FileTemplate.ATTRIBUTE_PACKAGE_NAME,FileTemplate.ATTRIBUTE_PACKAGE_NAME);
      }
    }
    mergedText=template.getText(props);
  }
 catch (  Exception e) {
    throw e;
  }
  final String templateText=StringUtil.convertLineSeparators(mergedText);
  final Exception[] commandException=new Exception[1];
  final PsiElement[] result=new PsiElement[1];
  final Properties finalProps=props;
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      final Runnable run=new Runnable(){
        public void run(){
          try {
            boolean handled=false;
            for (            CreateFromTemplateHandler handler : Extensions.getExtensions(CreateFromTemplateHandler.EP_NAME)) {
              if (handler.handlesTemplate(template)) {
                result[0]=handler.createFromTemplate(project,directory,template,templateText,finalProps);
                handled=true;
              }
            }
            if (!handled) {
              result[0]=createPsiFile(project,directory,templateText,fileName,template.getExtension());
            }
          }
 catch (          Exception ex) {
            commandException[0]=ex;
          }
        }
      }
;
      ApplicationManager.getApplication().runWriteAction(run);
    }
  }
,template.isJavaClassTemplate() ? IdeBundle.message("command.create.class.from.template") : IdeBundle.message("command.create.file.from.template"),null);
  if (commandException[0] != null) {
    throw commandException[0];
  }
  return result[0];
}
