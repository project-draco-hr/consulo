def diffs(repo, tmpl, ctx, files, parity, style):

    def countgen():
        start = 1
        while True:
            yield start
            start += 1
    blockcount = countgen()

    def prettyprintlines(diff):
        blockno = blockcount.next()
        for (lineno, l) in enumerate(diff.splitlines(True)):
            lineno = ('%d.%d' % (blockno, (lineno + 1)))
            if l.startswith('+'):
                ltype = 'difflineplus'
            elif l.startswith('-'):
                ltype = 'difflineminus'
            elif l.startswith('@'):
                ltype = 'difflineat'
            else:
                ltype = 'diffline'
            yield tmpl(ltype, line=l, lineid=('l%s' % lineno), linenumber=('% 8s' % lineno))
    if files:
        m = match.exact(repo.root, repo.getcwd(), files)
    else:
        m = match.always(repo.root, repo.getcwd())
    diffopts = patch.diffopts(repo.ui, untrusted=True)
    parents = ctx.parents()
    node1 = ((parents and parents[0].node()) or nullid)
    node2 = ctx.node()
    block = []
    for chunk in patch.diff(repo, node1, node2, m, opts=diffopts):
        if (chunk.startswith('diff') and block):
            yield tmpl('diffblock', parity=parity.next(), lines=prettyprintlines(''.join(block)))
            block = []
        if (chunk.startswith('diff') and (style != 'raw')):
            chunk = ''.join(chunk.splitlines(True)[1:])
        block.append(chunk)
    yield tmpl('diffblock', parity=parity.next(), lines=prettyprintlines(''.join(block)))
