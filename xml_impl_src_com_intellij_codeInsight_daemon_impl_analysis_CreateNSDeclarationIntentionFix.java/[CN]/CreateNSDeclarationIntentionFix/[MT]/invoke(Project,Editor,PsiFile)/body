{
  if (!CodeInsightUtilBase.prepareFileForWrite(file))   return;
  final PsiElement element=myElement.retrieve();
  if (element == null)   return;
  final Set<String> set=getXmlExtension().guessUnboundNamespaces(element,getFile());
  final String[] namespaces=ArrayUtil.toStringArray(set);
  Arrays.sort(namespaces);
  runActionOverSeveralAttributeValuesAfterLettingUserSelectTheNeededOne(namespaces,project,new StringToAttributeProcessor(){
    @Override public void doSomethingWithGivenStringToProduceXmlAttributeNowPlease(    @NotNull final String namespace) throws IncorrectOperationException {
      String prefix=myNamespacePrefix;
      if (StringUtil.isEmpty(prefix)) {
        final XmlExtension extension=getXmlExtension();
        final XmlFile xmlFile=extension.getContainingFile(element);
        prefix=ExtendedTagInsertHandler.getPrefixByNamespace(xmlFile,namespace);
        if (StringUtil.isNotEmpty(prefix)) {
          ExtendedTagInsertHandler.qualifyWithPrefix(prefix,element);
          return;
        }
 else {
          prefix=ExtendedTagInsertHandler.suggestPrefix(xmlFile,namespace);
          if (!StringUtil.isEmpty(prefix)) {
            ExtendedTagInsertHandler.qualifyWithPrefix(prefix,element);
            PsiDocumentManager.getInstance(project).doPostponedOperationsAndUnblockDocument(editor.getDocument());
          }
        }
      }
      final int offset=editor.getCaretModel().getOffset();
      final RangeMarker marker=editor.getDocument().createRangeMarker(offset,offset);
      final XmlExtension extension=XmlExtension.getExtension(file);
      extension.insertNamespaceDeclaration((XmlFile)file,editor,Collections.singleton(namespace),prefix,new XmlExtension.Runner<String,IncorrectOperationException>(){
        @Override public void run(        final String param) throws IncorrectOperationException {
          if (!namespace.isEmpty()) {
            editor.getCaretModel().moveToOffset(marker.getStartOffset());
          }
        }
      }
);
    }
  }
,getTitle(),this,editor);
}
