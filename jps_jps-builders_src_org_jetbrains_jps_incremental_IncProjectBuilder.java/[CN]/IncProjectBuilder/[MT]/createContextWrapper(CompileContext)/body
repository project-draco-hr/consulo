{
  final ClassLoader loader=delegate.getClass().getClassLoader();
  final UserDataHolderBase localDataHolder=new UserDataHolderBase();
  final Set<Object> deletedKeysSet=new ConcurrentHashSet<Object>();
  final Class<UserDataHolder> dataHolderInterface=UserDataHolder.class;
  final Class<MessageHandler> messageHandlerInterface=MessageHandler.class;
  return (CompileContext)Proxy.newProxyInstance(loader,new Class[]{CompileContext.class},new InvocationHandler(){
    @Override public Object invoke(    Object proxy,    Method method,    Object[] args) throws Throwable {
      final Class<?> declaringClass=method.getDeclaringClass();
      if (dataHolderInterface.equals(declaringClass)) {
        final Object firstArgument=args[0];
        final boolean isGlobalContextKey=firstArgument instanceof Key && GLOBAL_CONTEXT_KEYS.contains((Key)firstArgument);
        if (!isGlobalContextKey) {
          final boolean isWriteOperation=args.length == 2;
          if (isWriteOperation) {
            if (args[1] == null) {
              deletedKeysSet.add(firstArgument);
            }
 else {
              deletedKeysSet.remove(firstArgument);
            }
          }
 else {
            if (deletedKeysSet.contains(firstArgument)) {
              return null;
            }
          }
          final Object result=method.invoke(localDataHolder,args);
          if (isWriteOperation || result != null) {
            return result;
          }
        }
      }
 else       if (messageHandlerInterface.equals(declaringClass)) {
        final BuildMessage msg=(BuildMessage)args[0];
        if (msg.getKind() == BuildMessage.Kind.ERROR) {
          Utils.ERRORS_DETECTED_KEY.set(localDataHolder,Boolean.TRUE);
        }
      }
      try {
        return method.invoke(delegate,args);
      }
 catch (      InvocationTargetException e) {
        final Throwable targetEx=e.getTargetException();
        if (targetEx instanceof ProjectBuildException) {
          throw targetEx;
        }
        throw e;
      }
    }
  }
);
}
