{
  final ProjectDescriptor pd=context.getProjectDescriptor();
  final Timestamps timestamps=pd.timestamps.getStorage();
  final THashSet<File> currentFiles=new THashSet<File>(FileUtil.FILE_HASHING_STRATEGY);
  FSOperations.markDirtyFiles(context,target,timestamps,forceMarkDirty,target.isTests() ? FSOperations.DirtyMarkScope.TESTS : FSOperations.DirtyMarkScope.PRODUCTION,currentFiles);
  final BuildFSState fsState=pd.fsState;
  fsState.clearDeletedPaths(target);
  final SourceToOutputMapping sourceToOutputMap=pd.dataManager.getSourceToOutputMap(target);
  for (final Iterator<String> it=sourceToOutputMap.getKeysIterator(); it.hasNext(); ) {
    final String path=it.next();
    final File file=new File(path);
    if (!currentFiles.contains(file)) {
      fsState.registerDeleted(target,file,timestamps);
    }
  }
  updateOutputRootsLayout(context,target);
}
