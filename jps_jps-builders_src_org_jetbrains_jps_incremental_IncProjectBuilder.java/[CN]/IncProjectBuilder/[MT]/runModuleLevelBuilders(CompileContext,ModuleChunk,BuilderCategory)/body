{
  final List<ModuleLevelBuilder> builders=myBuilderRegistry.getBuilders(category);
  if (builders.isEmpty()) {
    return;
  }
  boolean rebuildFromScratchRequested=false;
  float stageCount=myTotalModuleLevelBuilderCount;
  int stagesPassed=0;
  final int modulesInChunk=chunk.getModules().size();
  boolean nextPassRequired;
  do {
    nextPassRequired=false;
    context.beforeNextCompileRound(chunk);
    if (!context.isProjectRebuild()) {
      syncOutputFiles(context,chunk);
    }
    for (    ModuleLevelBuilder builder : builders) {
      final ModuleLevelBuilder.ExitCode buildResult=builder.build(context,chunk);
      if (buildResult == ModuleLevelBuilder.ExitCode.ABORT) {
        throw new ProjectBuildException("Builder " + builder.getDescription() + " requested build stop");
      }
      if (myCancelStatus.isCanceled()) {
        throw new ProjectBuildException(CANCELED_MESSAGE);
      }
      if (buildResult == ModuleLevelBuilder.ExitCode.ADDITIONAL_PASS_REQUIRED) {
        if (!nextPassRequired) {
          myModulesProcessed-=(stagesPassed * modulesInChunk) / stageCount;
          stageCount+=myTotalModuleLevelBuilderCount;
          myModulesProcessed+=(stagesPassed * modulesInChunk) / stageCount;
        }
        nextPassRequired=true;
      }
 else       if (buildResult == ModuleLevelBuilder.ExitCode.CHUNK_REBUILD_REQUIRED) {
        if (!rebuildFromScratchRequested && !context.isProjectRebuild()) {
          rebuildFromScratchRequested=true;
          try {
            context.markDirty(chunk);
            myModulesProcessed-=(stagesPassed * modulesInChunk) / stageCount;
            stagesPassed=0;
            nextPassRequired=true;
            break;
          }
 catch (          Exception e) {
            throw new ProjectBuildException(e);
          }
        }
 else {
          LOG.info("Builder " + builder.getDescription() + " requested second chunk rebuild");
        }
      }
      stagesPassed++;
      final float fraction=updateFractionBuilderFinished(modulesInChunk / (stageCount));
      context.setDone(fraction);
    }
  }
 while (nextPassRequired);
  context.clearContextRoundData();
}
