{
  try {
    myProjectDescriptor.timestamps.clean();
  }
 catch (  IOException e) {
    throw new ProjectBuildException("Error cleaning timestamps storage",e);
  }
  try {
    context.getDataManager().clean();
  }
 catch (  IOException e) {
    throw new ProjectBuildException("Error cleaning compiler storages",e);
  }
  myProjectDescriptor.fsState.onRebuild();
  final Collection<Module> modulesToClean=context.getProject().getModules().values();
  final Set<File> toDelete=new HashSet<File>();
  final Set<File> allSourceRoots=new HashSet<File>();
  for (  Module module : modulesToClean) {
    final File out=context.getProjectPaths().getModuleOutputDir(module,false);
    if (out != null) {
      toDelete.add(out);
    }
    final File testOut=context.getProjectPaths().getModuleOutputDir(module,true);
    if (testOut != null) {
      toDelete.add(testOut);
    }
    final List<RootDescriptor> moduleRoots=context.getModuleRoots(module);
    for (    RootDescriptor d : moduleRoots) {
      allSourceRoots.add(d.root);
    }
  }
  for (  File outputRoot : toDelete) {
    boolean okToDelete=true;
    if (PathUtil.isUnder(allSourceRoots,outputRoot)) {
      okToDelete=false;
    }
 else {
      final Set<File> _outRoot=Collections.singleton(outputRoot);
      for (      File srcRoot : allSourceRoots) {
        if (PathUtil.isUnder(_outRoot,srcRoot)) {
          okToDelete=false;
          break;
        }
      }
    }
    if (okToDelete) {
      context.processMessage(new ProgressMessage("Cleaning " + outputRoot.getPath()));
      final File[] children=outputRoot.listFiles();
      if (children != null) {
        for (        File child : children) {
          if (myCancelStatus.isCanceled()) {
            throw new ProjectBuildException(CANCELED_MESSAGE);
          }
          FileUtil.delete(child);
        }
      }
    }
 else {
      context.processMessage(new CompilerMessage(JPS_SERVER_NAME,BuildMessage.Kind.WARNING,"Output path " + outputRoot.getPath() + " intersects with a source root. The output cannot be cleaned."));
    }
  }
}
