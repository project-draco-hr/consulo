{
  boolean needRebuild=false;
  final StubIndexKey<K,?> indexKey=extension.getKey();
  final int version=extension.getVersion();
  myIndexIdToVersionMap.put(indexKey,version);
  final File versionFile=IndexInfrastructure.getVersionFile(indexKey);
  if (IndexInfrastructure.versionDiffers(versionFile,version)) {
    needRebuild=true;
    FileUtil.delete(IndexInfrastructure.getIndexRootDir(indexKey));
    IndexInfrastructure.rewriteVersion(versionFile,version);
  }
  for (int attempt=0; attempt < 2; attempt++) {
    try {
      final MapIndexStorage<K,TIntArrayList> storage=new MapIndexStorage<K,TIntArrayList>(IndexInfrastructure.getStorageFile(indexKey),extension.getKeyDescriptor(),new StubIdExternalizer());
      final MemoryIndexStorage<K,TIntArrayList> memStorage=new MemoryIndexStorage<K,TIntArrayList>(storage);
      myIndices.put(indexKey,new MyIndex<K>(memStorage));
      break;
    }
 catch (    IOException e) {
      needRebuild=true;
      FileUtil.delete(IndexInfrastructure.getIndexRootDir(indexKey));
      IndexInfrastructure.rewriteVersion(versionFile,version);
    }
  }
  return needRebuild;
}
