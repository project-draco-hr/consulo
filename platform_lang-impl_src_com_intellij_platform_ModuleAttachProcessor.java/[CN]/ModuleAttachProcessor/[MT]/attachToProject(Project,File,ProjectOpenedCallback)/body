{
  if (!projectDir.exists()) {
    Project newProject=((ProjectManagerEx)ProjectManager.getInstance()).newProject(projectDir.getParentFile().getName(),projectDir.getParent(),true,false);
    if (newProject == null) {
      return false;
    }
    final VirtualFile baseDir=LocalFileSystem.getInstance().refreshAndFindFileByPath(projectDir.getParent());
    PlatformProjectOpenProcessor.runDirectoryProjectConfigurators(baseDir,newProject);
    newProject.save();
    AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(null);
    try {
      Disposer.dispose(newProject);
    }
  finally {
      token.finish();
    }
  }
  final String[] files=projectDir.list();
  if (files != null) {
    for (    String file : files) {
      if (FileUtilRt.extensionEquals(file,ModuleFileType.DEFAULT_EXTENSION)) {
        VirtualFile imlFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(new File(projectDir,file));
        if (imlFile != null) {
          attachModule(project,imlFile,callback);
          return true;
        }
      }
    }
  }
  int rc=Messages.showYesNoDialog(project,"The project at " + FileUtil.toSystemDependentName(projectDir.getPath()) + " uses a non-standard layout and cannot be attached to this project. Would you like to open it in a new window?","Open Project",Messages.getQuestionIcon());
  return rc != Messages.YES;
}
