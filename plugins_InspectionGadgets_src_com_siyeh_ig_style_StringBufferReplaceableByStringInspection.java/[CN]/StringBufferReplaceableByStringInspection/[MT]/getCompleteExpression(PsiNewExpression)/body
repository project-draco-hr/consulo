{
  PsiElement completeExpression=expression;
  boolean found=false;
  while (true) {
    final PsiElement parent=completeExpression.getParent();
    if (!(parent instanceof PsiReferenceExpression)) {
      break;
    }
    final PsiReferenceExpression referenceExpression=(PsiReferenceExpression)parent;
    final PsiElement grandParent=parent.getParent();
    if (!(grandParent instanceof PsiMethodCallExpression)) {
      break;
    }
    final String name=referenceExpression.getReferenceName();
    if ("append".equals(name)) {
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)grandParent;
      final PsiExpressionList argumentList=methodCallExpression.getArgumentList();
      final PsiExpression[] arguments=argumentList.getExpressions();
      if (arguments.length != 1) {
        return null;
      }
    }
 else {
      if (!"toString".equals(name)) {
        return null;
      }
      found=true;
    }
    completeExpression=grandParent;
    if (found) {
      return (PsiExpression)completeExpression;
    }
  }
  return null;
}
