{
  if (!(expression instanceof GrReferenceExpression))   return false;
  GrReferenceExpression ref=(GrReferenceExpression)expression;
  PsiElement nameElement=ref.getReferenceNameElement();
  if (nameElement == null)   return false;
  IElementType type=nameElement.getNode().getElementType();
  if (type != GroovyTokenTypes.kTHIS)   return false;
  GrExpression qualifier=ref.getQualifier();
  if (qualifier == null) {
    return true;
  }
 else {
    PsiElement resolved=ref.resolve();
    return resolved instanceof PsiClass && hasEnclosingInstanceInScope((PsiClass)resolved,ref,false);
  }
}
