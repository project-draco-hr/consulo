{
  try {
    if (isCreateInnerClass()) {
      final PsiClass innerClass=(PsiClass)getMethod().getContainingClass().add(myElementFactory.createClass(getInnerClassName()));
      final boolean isStatic=copyMethodModifiers(innerClass);
      for (      UsageInfo usage : usages) {
        final PsiMethodCallExpression methodCallExpression=PsiTreeUtil.getParentOfType(usage.getElement(),PsiMethodCallExpression.class);
        if (methodCallExpression != null) {
          replaceMethodCallExpression(inferTypeArguments(methodCallExpression),methodCallExpression);
        }
      }
      final PsiParameter[] parameters=getMethod().getParameterList().getParameters();
      if (parameters.length > 0) {
        createInnerClassConstructor(innerClass,parameters);
      }
 else       if (isStatic) {
        final PsiMethod copy=(PsiMethod)getMethod().copy();
        copy.setName("invoke");
        innerClass.add(copy);
        return;
      }
      copyMethodWithoutParameters(innerClass);
      copyMethodTypeParameters(innerClass);
    }
 else {
      for (      UsageInfo usage : usages) {
        final PsiMethodCallExpression methodCallExpression=PsiTreeUtil.getParentOfType(usage.getElement(),PsiMethodCallExpression.class);
        if (methodCallExpression != null) {
          methodCallExpression.replace(processMethodDeclaration(methodCallExpression.getArgumentList()));
        }
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
