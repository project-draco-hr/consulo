{
  ProgressIndicatorProvider.checkCanceled();
  if (isPhysical) {
    ApplicationManager.getApplication().assertReadAccessAllowed();
  }
  int index=getIndex(isPhysical,incompleteCode,isPoly);
  ConcurrentMap<TRef,TResult> map=getMap(index);
  TResult result=map.get(ref);
  if (result != null) {
    return result;
  }
  RecursionGuard.StackStamp stamp=myGuard.markStack();
  result=needToPreventRecursion ? myGuard.doPreventingRecursion(Trinity.create(ref,incompleteCode,isPoly),true,new Computable<TResult>(){
    @Override public TResult compute(){
      return resolver.resolve(ref,incompleteCode);
    }
  }
) : resolver.resolve(ref,incompleteCode);
  PsiElement element=result instanceof ResolveResult ? ((ResolveResult)result).getElement() : null;
  LOG.assertTrue(element == null || element.isValid(),result);
  if (stamp.mayCacheNow()) {
    cache(ref,map,result);
  }
  return result;
}
