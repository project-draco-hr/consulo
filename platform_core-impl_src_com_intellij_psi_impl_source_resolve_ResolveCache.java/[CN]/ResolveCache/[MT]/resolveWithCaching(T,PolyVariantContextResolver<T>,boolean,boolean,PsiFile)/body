{
  ProgressIndicatorProvider.checkCanceled();
  ApplicationManager.getApplication().assertReadAccessAllowed();
  int index=getIndex(containingFile.isPhysical(),incompleteCode,true);
  ConcurrentMap<T,ResolveResult[]> map=getMap(index);
  ResolveResult[] result=map.get(ref);
  if (result != null) {
    return result;
  }
  RecursionGuard.StackStamp stamp=myGuard.markStack();
  result=needToPreventRecursion ? myGuard.doPreventingRecursion(Pair.create(ref,incompleteCode),true,new Computable<ResolveResult[]>(){
    @Override public ResolveResult[] compute(){
      return resolver.resolve(ref,containingFile,incompleteCode);
    }
  }
) : resolver.resolve(ref,containingFile,incompleteCode);
  if (stamp.mayCacheNow()) {
    cache(ref,map,result);
  }
  return result == null ? ResolveResult.EMPTY_ARRAY : result;
}
