{
  if (getSettings().isShowModules()) {
    final List<Module> allModules=new ArrayList<Module>(Arrays.asList(ModuleManager.getInstance(getProject()).getModules()));
    for (Iterator<Module> it=allModules.iterator(); it.hasNext(); ) {
      final Module module=it.next();
      final VirtualFile[] sourceRoots=ModuleRootManager.getInstance(module).getSourceRoots();
      if (sourceRoots.length == 0) {
        it.remove();
      }
    }
    return modulesAndGroups(allModules.toArray(new Module[allModules.size()]));
  }
 else {
    final List<VirtualFile> sourceRoots=new ArrayList<VirtualFile>();
    final ProjectRootManager projectRootManager=ProjectRootManager.getInstance(myProject);
    sourceRoots.addAll(Arrays.asList(projectRootManager.getContentSourceRoots()));
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    final List<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
    final Set<PsiPackage> topLevelPackages=new HashSet<PsiPackage>();
    for (    final VirtualFile root : sourceRoots) {
      final PsiDirectory directory=psiManager.findDirectory(root);
      if (directory == null) {
        continue;
      }
      final PsiPackage directoryPackage=directory.getPackage();
      if (directoryPackage == null || PackageUtil.isPackageDefault(directoryPackage)) {
        final PsiDirectory[] subdirectories=directory.getSubdirectories();
        for (int i=0; i < subdirectories.length; i++) {
          final PsiPackage aPackage=subdirectories[i].getPackage();
          if (aPackage != null && !PackageUtil.isPackageDefault(aPackage)) {
            topLevelPackages.add(aPackage);
          }
        }
        children.addAll(PackageUtil.getDirectoryChildren(directory,getSettings(),false));
      }
 else {
        topLevelPackages.add(directoryPackage);
      }
    }
    for (Iterator<PsiPackage> it=topLevelPackages.iterator(); it.hasNext(); ) {
      final PsiPackage psiPackage=it.next();
      PackageUtil.addPackageAsChild(children,psiPackage,null,getSettings(),false);
    }
    if (getSettings().isShowLibraryContents()) {
      children.add(new PackageViewLibrariesNode(getProject(),null,getSettings()));
    }
    return children;
  }
}
