{
  final Charset old=getUserData(CHARSET_KEY);
  putUserData(CHARSET_KEY,charset);
  setBOM(charset == null ? null : CharsetToolkit.getBom(charset));
  if (old != null && !old.equals(charset)) {
    final Application application=ApplicationManager.getApplication();
    application.invokeLater(new Runnable(){
      public void run(){
        application.runWriteAction(new Runnable(){
          public void run(){
            application.getMessageBus().syncPublisher(VirtualFileManager.VFS_CHANGES).after(Collections.singletonList(new VFilePropertyChangeEvent(this,VirtualFile.this,PROP_ENCODING,old,charset,false)));
          }
        }
);
      }
    }
);
  }
}
