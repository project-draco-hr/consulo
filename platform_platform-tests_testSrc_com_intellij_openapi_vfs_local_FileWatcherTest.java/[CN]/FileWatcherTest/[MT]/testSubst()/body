{
  if (!SystemInfo.isWindows) {
    System.err.println("Ignored: Windows required");
    return;
  }
  File targetDir=createTestDir("top");
  File subDir=createTestDir(targetDir,"sub");
  File file=createTestFile(subDir,"test.txt");
  File rootFile=createSubst(targetDir.getPath());
  VfsRootAccess.allowRootAccess(rootFile.getPath());
  VirtualFile vfsRoot=myFileSystem.findFileByIoFile(rootFile);
  try {
    assertNotNull(rootFile.getPath(),vfsRoot);
    File substDir=new File(rootFile,subDir.getName());
    File substFile=new File(substDir,file.getName());
    refresh(targetDir);
    refresh(substDir);
    myAcceptedDirectories.add(substDir.getPath());
    LocalFileSystem.WatchRequest request=watch(substDir);
    try {
      myAccept=true;
      FileUtil.writeToFile(file,"new content");
      assertEvent(VFileContentChangeEvent.class,substFile.getPath());
      LocalFileSystem.WatchRequest request2=watch(targetDir);
      try {
        myAccept=true;
        FileUtil.delete(file);
        assertEvent(VFileDeleteEvent.class,file.getPath(),substFile.getPath());
      }
  finally {
        unwatch(request2);
      }
      myAccept=true;
      FileUtil.writeToFile(file,"re-creation");
      assertEvent(VFileCreateEvent.class,substFile.getPath());
    }
  finally {
      unwatch(request);
    }
  }
  finally {
    delete(targetDir);
    deleteSubst(rootFile.getPath());
    if (vfsRoot != null) {
      ((NewVirtualFile)vfsRoot).markDirty();
      myFileSystem.refresh(false);
    }
    VfsRootAccess.disallowRootAccess(rootFile.getPath());
  }
}
