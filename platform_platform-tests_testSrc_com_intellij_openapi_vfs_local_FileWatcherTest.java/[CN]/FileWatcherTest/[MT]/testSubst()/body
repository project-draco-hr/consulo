{
  if (!SystemInfo.isWindows) {
    System.err.println("Ignored: Windows required");
    return;
  }
  final File targetDir=FileUtil.createTempDirectory("top.",null);
  final File subDir=FileUtil.createTempDirectory(targetDir,"sub.",null);
  final File file=FileUtil.createTempFile(subDir,"test.",".txt");
  final File rootFile=IoTestUtil.createSubst(targetDir.getAbsolutePath());
  VirtualDirectoryImpl.allowRootAccess(rootFile.getPath());
  final VirtualFile vfsRoot=myFileSystem.findFileByIoFile(rootFile);
  try {
    assertNotNull(rootFile.getPath(),vfsRoot);
    final File substDir=new File(rootFile,subDir.getName());
    final File substFile=new File(substDir,file.getName());
    refresh(targetDir);
    refresh(substDir);
    final LocalFileSystem.WatchRequest request=watch(substDir);
    try {
      myAccept=true;
      FileUtil.writeToFile(file,"new content");
      assertEvent(VFileContentChangeEvent.class,substFile.getAbsolutePath());
      final LocalFileSystem.WatchRequest request2=watch(targetDir);
      try {
        myAccept=true;
        FileUtil.delete(file);
        assertEvent(VFileDeleteEvent.class,file.getAbsolutePath(),substFile.getAbsolutePath());
      }
  finally {
        unwatch(request2);
      }
      myAccept=true;
      FileUtil.writeToFile(file,"re-creation");
      assertEvent(VFileCreateEvent.class,substFile.getAbsolutePath());
    }
  finally {
      unwatch(request);
    }
  }
  finally {
    delete(targetDir);
    IoTestUtil.deleteSubst(rootFile.getPath());
    if (vfsRoot != null) {
      ((NewVirtualFile)vfsRoot).markDirty();
      myFileSystem.refresh(false);
    }
    VirtualDirectoryImpl.disallowRootAccess(rootFile.getPath());
  }
}
