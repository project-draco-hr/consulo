{
  new WriteCommandAction.Simple(null){
    @Override protected void run() throws Throwable {
      File projectFile=FileUtil.createTempFile(myName + "_",PROJECT_FILE_SUFFIX);
      FileUtil.delete(projectFile);
      myFilesToDelete.add(projectFile);
      LocalFileSystem.getInstance().refreshAndFindFileByIoFile(projectFile);
      ByteArrayOutputStream buffer=new ByteArrayOutputStream();
      new Throwable(projectFile.getPath()).printStackTrace(new PrintStream(buffer));
      myProject=PlatformTestCase.createProject(projectFile,buffer.toString());
      for (      ModuleFixtureBuilder moduleFixtureBuilder : myModuleFixtureBuilders) {
        moduleFixtureBuilder.getFixture().setUp();
      }
      StartupManagerImpl sm=(StartupManagerImpl)StartupManager.getInstance(myProject);
      sm.runStartupActivities();
      sm.startCacheUpdate();
      sm.runPostStartupActivities();
      ProjectManagerEx.getInstanceEx().setCurrentTestProject(myProject);
      ((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(myProject)).clearUncommitedDocuments();
    }
  }
.execute().throwException();
}
