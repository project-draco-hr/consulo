{
  HolderReference ref=file.getUserData(REF_COUNT_HOLDER_IN_FILE_KEY);
  RefCountHolder holder=ref == null ? null : ref.get();
  if (holder == null && acquire) {
    holder=new RefCountHolder(file);
    HolderReference newRef=new HolderReference(holder);
    while (true) {
      boolean replaced=((UserDataHolderEx)file).replace(REF_COUNT_HOLDER_IN_FILE_KEY,ref,newRef);
      if (replaced) {
        ref=newRef;
        break;
      }
      ref=file.getUserData(REF_COUNT_HOLDER_IN_FILE_KEY);
      RefCountHolder newHolder=ref == null ? null : ref.get();
      if (newHolder != null) {
        holder=newHolder;
        break;
      }
    }
  }
  if (ref != null) {
    if (acquire) {
      ref.acquire(indicator);
    }
 else {
      ref.release(indicator);
    }
  }
  return holder;
}
