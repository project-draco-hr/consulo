{
  PsiManager psiManager=PsiManager.getInstance(myProject);
  final PsiMigration psiMigration=JavaPsiFacade.getInstance(psiManager.getProject()).startMigration();
  LocalHistoryAction a=LocalHistory.startAction(myProject,getCommandName());
  try {
    for (int i=0; i < myMigrationMap.getEntryCount(); i++) {
      MigrationMapEntry entry=myMigrationMap.getEntryAt(i);
      if (entry.getType() == MigrationMapEntry.PACKAGE) {
        MigrationUtil.doPackageMigration(psiManager,psiMigration,entry.getNewName(),usages);
      }
      if (entry.getType() == MigrationMapEntry.CLASS) {
        MigrationUtil.doClassMigration(psiManager,psiMigration,entry.getNewName(),usages);
      }
    }
    for (    RefactoringHelper helper : Extensions.getExtensions(RefactoringHelper.EP_NAME)) {
      Object preparedData=helper.prepareOperation(usages);
      helper.performOperation(myProject,preparedData);
    }
  }
  finally {
    a.finish();
    psiMigration.finish();
  }
}
