{
  CompositeElement treeElement=calcTreeElement();
  TreeElement childNode=treeElement.getFirstChildNode();
  TreeElement prevSibling=null;
  while (childNode != null) {
    if (childNode instanceof ChameleonElement) {
      TreeElement newChild=(TreeElement)childNode.getTransformedFirstOrSelf();
      if (newChild == null) {
        childNode=prevSibling == null ? treeElement.getFirstChildNode() : prevSibling.getTreeNext();
        continue;
      }
      childNode=newChild;
    }
    final PsiElement psi;
    if (childNode instanceof PsiElement) {
      psi=(PsiElement)childNode;
    }
 else {
      psi=childNode.getPsi();
    }
    psi.accept(visitor);
    prevSibling=childNode;
    childNode=childNode.getTreeNext();
  }
}
