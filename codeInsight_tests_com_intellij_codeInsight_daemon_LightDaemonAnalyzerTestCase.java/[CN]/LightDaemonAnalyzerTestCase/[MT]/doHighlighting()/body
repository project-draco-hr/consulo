{
  PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  Document document=getEditor().getDocument();
  if (doFolding()) {
    final CodeFoldingPassFactory factory=getProject().getComponent(CodeFoldingPassFactory.class);
    final TextEditorHighlightingPass highlightingPass=factory.createHighlightingPass(myFile,myEditor);
    highlightingPass.collectInformation(new MockProgressIndicator());
    highlightingPass.doApplyInformationToEditor();
  }
  GeneralHighlightingPass action1=new GeneralHighlightingPass(getProject(),getFile(),document,0,getFile().getTextLength(),true);
  action1.collectInformation(new MockProgressIndicator());
  action1.applyInformationToEditor();
  Collection<HighlightInfo> highlights1=action1.getHighlights();
  PostHighlightingPass action2=new PostHighlightingPass(getProject(),getFile(),getEditor(),0,getFile().getTextLength());
  action2.doCollectInformation(new MockProgressIndicator());
  Collection<HighlightInfo> highlights2=action2.getHighlights();
  LocalInspectionsPass action3=new LocalInspectionsPass(getFile(),document,0,getFile().getTextLength());
  action3.doCollectInformation(new MockProgressIndicator());
  Collection<HighlightInfo> highlights3=action3.getHighlights();
  HashSet<HighlightInfo> result=new HashSet<HighlightInfo>(highlights1);
  result.addAll(highlights2);
  result.addAll(highlights3);
  return result;
}
