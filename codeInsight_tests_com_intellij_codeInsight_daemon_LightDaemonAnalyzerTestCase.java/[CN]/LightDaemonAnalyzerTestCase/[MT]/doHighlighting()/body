{
  PsiDocumentManager.getInstance(getProject()).commitAllDocuments();
  Document document=getEditor().getDocument();
  MockProgressIndicator progress=new MockProgressIndicator();
  if (doFolding()) {
    final CodeFoldingPassFactory factory=getProject().getComponent(CodeFoldingPassFactory.class);
    final TextEditorHighlightingPass highlightingPass=factory.createHighlightingPass(myFile,myEditor);
    highlightingPass.collectInformation(progress);
    highlightingPass.doApplyInformationToEditor();
  }
  GeneralHighlightingPass action1=new GeneralHighlightingPass(getProject(),getFile(),document,0,getFile().getTextLength(),true);
  action1.collectInformation(progress);
  action1.applyInformationToEditor();
  Set<HighlightInfo> result=new HashSet<HighlightInfo>(action1.getHighlights());
  PostHighlightingPassFactory phpFactory=getProject().getComponent(PostHighlightingPassFactory.class);
  if (phpFactory != null) {
    PostHighlightingPass action2=new PostHighlightingPass(getProject(),getFile(),getEditor(),0,getFile().getTextLength());
    action2.doCollectInformation(progress);
    result.addAll(action2.getHighlights());
  }
  LocalInspectionsPass action3=new LocalInspectionsPass(getFile(),document,0,getFile().getTextLength());
  action3.doCollectInformation(progress);
  result.addAll(action3.getHighlights());
  LineMarkersPass markersPass=new LineMarkersPass(getProject(),getFile(),document,0,document.getTextLength(),true);
  markersPass.collectInformation(progress);
  markersPass.applyInformationToEditor();
  SlowLineMarkersPass slowPass=new SlowLineMarkersPass(getProject(),getFile(),document,0,document.getTextLength());
  slowPass.collectInformation(progress);
  slowPass.applyInformationToEditor();
  return result;
}
