{
  final ElementClassHint classHint=processor.getHint(ElementClassHint.KEY);
  PsiElementFactory factory=JavaPsiFacade.getInstance(aClass.getProject()).getElementFactory();
  if (classHint == null || classHint.shouldProcess(ElementClassHint.DeclarationKind.FIELD)) {
    final PsiField fieldByName=aClass.findFieldByName(nameHint.getName(state),false);
    if (fieldByName != null) {
      processor.handleEvent(PsiScopeProcessor.Event.SET_DECLARATION_HOLDER,aClass);
      if (!processor.execute(fieldByName,state))       return false;
    }
 else {
      final Map<String,List<Pair<PsiField,PsiSubstitutor>>> allFieldsMap=getCachedMembers(cache,PsiField.class);
      final List<Pair<PsiField,PsiSubstitutor>> list=allFieldsMap.get(nameHint.getName(state));
      if (list != null) {
        for (        final Pair<PsiField,PsiSubstitutor> candidate : list) {
          PsiField candidateField=candidate.getFirst();
          PsiSubstitutor finalSubstitutor=obtainFinalSubstitutor(candidateField.getContainingClass(),candidate.getSecond(),aClass,substitutor,place,factory);
          processor.handleEvent(PsiScopeProcessor.Event.SET_DECLARATION_HOLDER,candidateField.getContainingClass());
          if (!processor.execute(candidateField,state.put(PsiSubstitutor.KEY,finalSubstitutor)))           return false;
        }
      }
    }
  }
  if (classHint == null || classHint.shouldProcess(ElementClassHint.DeclarationKind.CLASS)) {
    if (last != null && last.getParent() == aClass) {
      if (last instanceof PsiClass) {
        if (!processor.execute(last,state))         return false;
      }
      final PsiTypeParameterList list=aClass.getTypeParameterList();
      if (list != null && !list.processDeclarations(processor,state,last,place))       return false;
    }
    if (!(last instanceof PsiReferenceList)) {
      final PsiClass classByName=aClass.findInnerClassByName(nameHint.getName(state),false);
      if (classByName != null) {
        processor.handleEvent(PsiScopeProcessor.Event.SET_DECLARATION_HOLDER,aClass);
        if (!processor.execute(classByName,state))         return false;
      }
 else {
        final Map<String,List<Pair<PsiClass,PsiSubstitutor>>> allClassesMap=getCachedMembers(cache,PsiClass.class);
        final List<Pair<PsiClass,PsiSubstitutor>> list=allClassesMap.get(nameHint.getName(state));
        if (list != null) {
          for (          final Pair<PsiClass,PsiSubstitutor> candidate : list) {
            final PsiClass inner=candidate.getFirst();
            final PsiClass containingClass=inner.getContainingClass();
            if (containingClass != null) {
              PsiSubstitutor finalSubstitutor=obtainFinalSubstitutor(containingClass,candidate.getSecond(),aClass,substitutor,place,factory);
              processor.handleEvent(PsiScopeProcessor.Event.SET_DECLARATION_HOLDER,containingClass);
              if (!processor.execute(inner,state.put(PsiSubstitutor.KEY,finalSubstitutor)))               return false;
            }
          }
        }
      }
    }
  }
  if (classHint == null || classHint.shouldProcess(ElementClassHint.DeclarationKind.METHOD)) {
    if (processor instanceof MethodResolverProcessor) {
      final MethodResolverProcessor methodResolverProcessor=(MethodResolverProcessor)processor;
      if (methodResolverProcessor.isConstructor()) {
        final PsiMethod[] constructors=aClass.getConstructors();
        methodResolverProcessor.handleEvent(PsiScopeProcessor.Event.SET_DECLARATION_HOLDER,aClass);
        for (        PsiMethod constructor : constructors) {
          if (!methodResolverProcessor.execute(constructor,state))           return false;
        }
        return true;
      }
    }
    final Map<String,List<Pair<PsiMethod,PsiSubstitutor>>> allMethodsMap=getCachedMembers(cache,PsiMethod.class);
    final List<Pair<PsiMethod,PsiSubstitutor>> list=allMethodsMap.get(nameHint.getName(state));
    if (list != null) {
      for (      final Pair<PsiMethod,PsiSubstitutor> candidate : list) {
        ProgressIndicatorProvider.checkCanceled();
        PsiMethod candidateMethod=candidate.getFirst();
        if (processor instanceof MethodResolverProcessor) {
          if (candidateMethod.isConstructor() != ((MethodResolverProcessor)processor).isConstructor())           continue;
        }
        final PsiClass containingClass=candidateMethod.getContainingClass();
        if (visited != null && visited.contains(candidateMethod.getContainingClass())) {
          continue;
        }
        PsiSubstitutor finalSubstitutor=obtainFinalSubstitutor(containingClass,candidate.getSecond(),aClass,substitutor,place,factory);
        finalSubstitutor=checkRaw(isRaw,factory,candidateMethod,finalSubstitutor);
        processor.handleEvent(PsiScopeProcessor.Event.SET_DECLARATION_HOLDER,containingClass);
        if (!processor.execute(candidateMethod,state.put(PsiSubstitutor.KEY,finalSubstitutor)))         return false;
      }
      if (visited != null) {
        for (        Pair<PsiMethod,PsiSubstitutor> aList : list) {
          visited.add(aList.getFirst().getContainingClass());
        }
      }
    }
  }
  return true;
}
