{
  final Document document=getDocument();
  if (document instanceof DocumentEx && ((DocumentEx)document).isInBulkUpdate()) {
    ((DocumentEx)document).setInBulkUpdate(false);
  }
  if (mySegments.getSegmentCount() == 0 && document != null && document.getTextLength() > 0) {
    doSetText(document.getCharsSequence());
  }
  final int latestValidOffset=mySegments.getLastValidOffset();
  return new HighlighterIteratorImpl(startOffset <= latestValidOffset ? startOffset : latestValidOffset);
}
