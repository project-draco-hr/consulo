{
  boolean error=true;
  try {
    createSocket();
    this.socketOutputStream=new BufferedOutputStream(socket.getOutputStream());
    this.socketInputStream=new BufferedInputStream(socket.getInputStream());
    final OutputStream loggingOutputStream=streamLogger.createLoggingOutputStream(this.socketOutputStream);
    final InputStream loggingInputStream=streamLogger.createLoggingInputStream(this.socketInputStream);
    final AsciiOutputStreamWriter loggedWriter=new AsciiOutputStreamWriter(loggingOutputStream);
    println(loggedWriter,preamble);
    println(loggedWriter,repository);
    println(loggedWriter,userName);
    final AsciiOutputStreamWriter writer=new AsciiOutputStreamWriter(socketOutputStream);
    println(writer,encodedPassword);
    println(new AsciiOutputStreamWriter(streamLogger.getOutputLogStream()),"@encodedPassword@");
    println(loggedWriter,postamble);
    loggedWriter.flush();
    String response=new StreamUtilities(null).readLine(loggingInputStream);
    if (response.equals("I LOVE YOU")) {
      error=false;
      return;
    }
    if (response.length() == 0) {
      throw new AuthenticationException("No response from server.");
    }
    if (response.equals("I HATE YOU")) {
      throw new UnknownUserException("Wrong password or unknown user.");
    }
    response=removePrefix(response,"error ");
    response=removePrefix(response,"E ");
    throw new UnknownUserException(getMessage("Authentication failed. Response from server was:\n{0}.",response));
  }
 catch (  ConnectException ex) {
    throw new AuthenticationException(getMessage("Cannot connect to host {0}.",connectionSettings.getHostName()),ex);
  }
catch (  NoRouteToHostException ex) {
    throw new AuthenticationException(getMessage("No route to host {0}.",connectionSettings.getHostName()),ex);
  }
catch (  IOException ex) {
    throw new AuthenticationException(getMessage("I/O error while connecting to host {0}.",connectionSettings.getHostName()),ex);
  }
 finally {
    if (error) {
      close();
    }
  }
}
