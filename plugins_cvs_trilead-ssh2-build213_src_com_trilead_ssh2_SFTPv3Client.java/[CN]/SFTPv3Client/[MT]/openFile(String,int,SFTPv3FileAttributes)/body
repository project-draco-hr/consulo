{
  int req_id=generateNextRequestID();
  TypesWriter tw=new TypesWriter();
  tw.writeString(fileName,charsetName);
  tw.writeUINT32(flags);
  tw.writeBytes(createAttrs(attr));
  if (debug != null) {
    debug.println("Sending SSH_FXP_OPEN...");
    debug.flush();
  }
  sendMessage(Packet.SSH_FXP_OPEN,req_id,tw.getBytes());
  byte[] resp=receiveMessage(34000);
  TypesReader tr=new TypesReader(resp);
  int t=tr.readByte();
  int rep_id=tr.readUINT32();
  if (rep_id != req_id)   throw new IOException("The server sent an invalid id field.");
  if (t == Packet.SSH_FXP_HANDLE) {
    if (debug != null) {
      debug.println("Got SSH_FXP_HANDLE.");
      debug.flush();
    }
    return new SFTPv3FileHandle(this,tr.readByteString());
  }
  if (t != Packet.SSH_FXP_STATUS)   throw new IOException("The SFTP server sent an unexpected packet type (" + t + ")");
  int errorCode=tr.readUINT32();
  String errorMessage=tr.readString();
  throw new SFTPException(errorMessage,errorCode);
}
