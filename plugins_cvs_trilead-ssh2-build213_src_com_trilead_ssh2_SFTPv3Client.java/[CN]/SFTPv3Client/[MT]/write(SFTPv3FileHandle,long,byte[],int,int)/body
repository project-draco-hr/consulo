{
  checkHandleValidAndOpen(handle);
  while (len > 0) {
    int writeRequestLen=len;
    if (writeRequestLen > 32768)     writeRequestLen=32768;
    int req_id=generateNextRequestID();
    TypesWriter tw=new TypesWriter();
    tw.writeString(handle.fileHandle,0,handle.fileHandle.length);
    tw.writeUINT64(fileOffset);
    tw.writeString(src,srcoff,writeRequestLen);
    if (debug != null) {
      debug.println("Sending SSH_FXP_WRITE...");
      debug.flush();
    }
    sendMessage(Packet.SSH_FXP_WRITE,req_id,tw.getBytes());
    fileOffset+=writeRequestLen;
    srcoff+=writeRequestLen;
    len-=writeRequestLen;
    byte[] resp=receiveMessage(34000);
    TypesReader tr=new TypesReader(resp);
    int t=tr.readByte();
    int rep_id=tr.readUINT32();
    if (rep_id != req_id)     throw new IOException("The server sent an invalid id field.");
    if (t != Packet.SSH_FXP_STATUS)     throw new IOException("The SFTP server sent an unexpected packet type (" + t + ")");
    int errorCode=tr.readUINT32();
    if (errorCode == ErrorCodes.SSH_FX_OK)     continue;
    String errorMessage=tr.readString();
    throw new SFTPException(errorMessage,errorCode);
  }
}
