{
  if (myStopFormatting) {
    return true;
  }
  if (!myFilesCountingFinished) {
    updateIndicatorText(ApplicationBundle.message("bulk.reformat.prepare.progress.text"),"");
    countingIteration();
    return true;
  }
  updateIndicatorFraction(myFilesProcessed);
  if (myFileTreeIterator.hasNext()) {
    final PsiFile file=myFileTreeIterator.next();
    myFilesProcessed++;
    if (file.isWritable() && canBeFormatted(file) && acceptedByFilters(file)) {
      updateIndicatorText(ApplicationBundle.message("bulk.reformat.process.progress.text"),getPresentablePath(file));
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          DumbService.getInstance(myProject).withAlternativeResolveEnabled(new Runnable(){
            @Override public void run(){
              performFileProcessing(file);
            }
          }
);
        }
      }
);
    }
  }
  return true;
}
