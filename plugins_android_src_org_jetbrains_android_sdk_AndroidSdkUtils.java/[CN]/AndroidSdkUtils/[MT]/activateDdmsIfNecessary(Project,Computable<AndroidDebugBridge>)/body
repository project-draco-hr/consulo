{
  if (AndroidEnableAdbServiceAction.isAdbServiceEnabled()) {
    final AndroidDebugBridge bridge=bridgeProvider.compute();
    if (bridge != null && isDdmsCorrupted(bridge)) {
      LOG.info("DDMLIB is corrupted and will be restarted");
      restartDdmlib(project);
    }
  }
 else {
    final OSProcessHandler ddmsProcessHandler=AndroidRunDdmsAction.getDdmsProcessHandler();
    if (ddmsProcessHandler != null) {
      final int r=Messages.showYesNoDialog(project,"DDMS will be closed to activate ADB service. Continue?","ADB activation",Messages.getQuestionIcon());
      if (r != Messages.YES) {
        return false;
      }
      final Runnable destroyingRunnable=new Runnable(){
        @Override public void run(){
          if (!ddmsProcessHandler.isProcessTerminated()) {
            OSProcessManager.getInstance().killProcessTree(ddmsProcessHandler.getProcess());
            ddmsProcessHandler.waitFor();
          }
        }
      }
;
      if (!ProgressManager.getInstance().runProcessWithProgressSynchronously(destroyingRunnable,"Closing DDMS",true,project)) {
        return false;
      }
      AndroidEnableAdbServiceAction.setAdbServiceEnabled(project,true);
      return true;
    }
    int result=Messages.showYesNoDialog(project,AndroidBundle.message("android.ddms.disabled.error"),AndroidBundle.message("android.ddms.disabled.dialog.title"),Messages.getQuestionIcon());
    if (result != 0) {
      return false;
    }
    AndroidEnableAdbServiceAction.setAdbServiceEnabled(project,true);
  }
  return true;
}
