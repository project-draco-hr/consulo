{
  TreeMap<PsiElement,TextRange> map=new TreeMap<PsiElement,TextRange>(new Comparator<PsiElement>(){
    public int compare(    PsiElement element,    PsiElement element1){
      int startOffsetDiff=element.getTextRange().getStartOffset() - element1.getTextRange().getStartOffset();
      return startOffsetDiff == 0 ? element.getTextRange().getEndOffset() - element1.getTextRange().getEndOffset() : startOffsetDiff;
    }
  }
);
  final Language lang=file.getLanguage();
  final FoldingBuilder foldingBuilder=LanguageFolding.INSTANCE.forLanguage(lang);
  if (foldingBuilder != null) {
    final FoldingDescriptor[] foldingDescriptors=foldingBuilder.buildFoldRegions(file.getNode(),document);
    for (    FoldingDescriptor descriptor : foldingDescriptors) {
      map.put(SourceTreeToPsiMap.treeElementToPsi(descriptor.getElement()),descriptor.getRange());
    }
  }
  return map;
}
