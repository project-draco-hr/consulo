{
  TreeMap<PsiElement,TextRange> map=new TreeMap<PsiElement,TextRange>(new Comparator<PsiElement>(){
    public int compare(    PsiElement element,    PsiElement element1){
      int startOffsetDiff=element.getTextRange().getStartOffset() - element1.getTextRange().getStartOffset();
      return startOffsetDiff == 0 ? element.getTextRange().getEndOffset() - element1.getTextRange().getEndOffset() : startOffsetDiff;
    }
  }
);
  final Language lang=file.getLanguage();
  final FoldingBuilder foldingBuilder=LanguageFolding.INSTANCE.forLanguage(lang);
  if (foldingBuilder != null) {
    final FoldingDescriptor[] foldingDescriptors=foldingBuilder.buildFoldRegions(file.getNode(),document);
    for (    FoldingDescriptor descriptor : foldingDescriptors) {
      map.put(SourceTreeToPsiMap.treeElementToPsi(descriptor.getElement()),descriptor.getRange());
    }
    return map;
  }
  if (file instanceof PsiJavaFile) {
    PsiImportList importList=((PsiJavaFile)file).getImportList();
    if (importList != null) {
      PsiImportStatementBase[] statements=importList.getAllImportStatements();
      if (statements.length > 1) {
        final TextRange rangeToFold=getRangeToFold(importList);
        if (rangeToFold != null) {
          map.put(importList,rangeToFold);
        }
      }
    }
    PsiClass[] classes=((PsiJavaFile)file).getClasses();
    for (    PsiClass aClass : classes) {
      ProgressManager.getInstance().checkCanceled();
      addElementsToFold(map,aClass,document,true);
    }
    TextRange range=getFileHeader((PsiJavaFile)file);
    if (range != null && document.getLineNumber(range.getEndOffset()) > document.getLineNumber(range.getStartOffset())) {
      map.put(file,range);
    }
  }
  return map;
}
