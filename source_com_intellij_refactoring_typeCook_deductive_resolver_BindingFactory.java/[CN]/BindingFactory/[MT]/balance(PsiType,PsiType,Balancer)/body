{
  final int indicator=(x instanceof PsiTypeVariable ? 1 : 0) + (y instanceof PsiTypeVariable ? 2 : 0);
switch (indicator) {
case 0:
    if (x instanceof PsiArrayType && y instanceof PsiArrayType) {
      return balance(((PsiArrayType)x).getComponentType(),((PsiArrayType)y).getComponentType(),balancer);
    }
 else     if (x instanceof PsiClassType && y instanceof PsiClassType) {
      final PsiClassType.ClassResolveResult resultX=Util.resolveType(x);
      final PsiClassType.ClassResolveResult resultY=Util.resolveType(y);
      final PsiClass xClass=resultX.getElement();
      final PsiClass yClass=resultY.getElement();
      if (xClass != null && yClass != null) {
        final PsiSubstitutor xSubst=resultX.getSubstitutor();
        PsiSubstitutor ySubst=resultY.getSubstitutor();
        if (!xClass.equals(yClass)) {
          if (InheritanceUtil.isCorrectDescendant(yClass,xClass,true)) {
            ySubst=Util.composeSubstitutors(ySubst,TypeConversionUtil.getSuperClassSubstitutor(xClass,yClass,PsiSubstitutor.EMPTY));
          }
          return null;
        }
        Binding b=create();
        for (Iterator<PsiTypeParameter> p=xSubst.getSubstitutionMap().keySet().iterator(); p.hasNext(); ) {
          final PsiTypeParameter aParm=p.next();
          final PsiType xType=xSubst.substitute(aParm);
          final PsiType yType=ySubst.substitute(aParm);
          final Binding b1=balance(xType,yType,balancer);
          if (b1 == null) {
            return null;
          }
          b=b.compose(b1);
        }
        return b;
      }
    }
 else {
      return null;
    }
case 1:
  return balancer.varType((PsiTypeVariable)x,y);
case 2:
return balancer.typeVar(x,(PsiTypeVariable)y);
case 3:
return balancer.varVar((PsiTypeVariable)x,(PsiTypeVariable)y);
}
return null;
}
