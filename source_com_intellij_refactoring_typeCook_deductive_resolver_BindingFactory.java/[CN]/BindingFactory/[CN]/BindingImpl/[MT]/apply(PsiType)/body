{
  if (type instanceof PsiTypeVariable) {
    final PsiType t=myBindings[((PsiTypeVariable)type).getIndex()];
    return t == null ? type : t;
  }
 else   if (type instanceof PsiArrayType) {
    return apply(((PsiArrayType)type).getComponentType()).createArrayType();
  }
 else   if (type instanceof PsiClassType) {
    final PsiClassType.ClassResolveResult result=Util.resolveType(type);
    final PsiClass theClass=result.getElement();
    final PsiSubstitutor aSubst=result.getSubstitutor();
    PsiSubstitutor theSubst=PsiSubstitutor.EMPTY;
    if (theClass != null) {
      for (Iterator<PsiTypeParameter> p=aSubst.getSubstitutionMap().keySet().iterator(); p.hasNext(); ) {
        final PsiTypeParameter aParm=p.next();
        final PsiType aType=aSubst.substitute(aParm);
        theSubst=theSubst.put(aParm,apply(aType));
      }
      return theClass.getManager().getElementFactory().createType(theClass,theSubst);
    }
 else {
      return null;
    }
  }
 else {
    return type;
  }
}
