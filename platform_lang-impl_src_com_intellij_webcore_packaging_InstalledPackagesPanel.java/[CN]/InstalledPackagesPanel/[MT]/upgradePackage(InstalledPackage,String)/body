{
  final PackageManagementService selPackageManagementService=myPackageManagementService;
  myPackageManagementService.fetchPackageVersions(pkg.getName(),new CatchingConsumer<List<String>,Exception>(){
    @Override public void consume(    List<String> releases){
      if (!releases.isEmpty() && PackageVersionComparator.VERSION_COMPARATOR.compare(pkg.getVersion(),releases.get(0)) >= 0) {
        return;
      }
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          final PackageManagementService.Listener listener=new PackageManagementService.Listener(){
            @Override public void operationStarted(            String packageName){
              myPackagesTable.setPaintBusy(true);
              myCurrentlyInstalling.add(packageName);
            }
            @Override public void operationFinished(            String packageName,            @Nullable String errorDescription){
              myPackagesTable.clearSelection();
              updatePackages(selPackageManagementService);
              myPackagesTable.setPaintBusy(false);
              myCurrentlyInstalling.remove(packageName);
              if (errorDescription == null) {
                myNotificationArea.showSuccess("Package " + packageName + " successfully upgraded");
              }
 else {
                myNotificationArea.showError("Upgrade packages failed. <a href=\"xxx\">Details...</a>","Upgrade Packages Failed","Upgrade packages failed.\n" + errorDescription);
              }
              if (myCurrentlyInstalling.isEmpty() && !myWaitingToUpgrade.isEmpty()) {
                upgradePostponedPackages();
              }
            }
          }
;
          PackageManagementServiceEx serviceEx=getServiceEx();
          if (serviceEx != null) {
            serviceEx.updatePackage(pkg,toVersion,listener);
          }
 else {
            myPackageManagementService.installPackage(new RepoPackage(pkg.getName(),null),null,true,null,listener,false);
          }
          myUpgradeButton.setEnabled(false);
        }
      }
,ModalityState.any());
    }
    @Override public void consume(    Exception e){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          Messages.showErrorDialog("Error occurred. Please, check your internet connection.","Upgrade Package Failed.");
        }
      }
,ModalityState.any());
    }
  }
);
}
