{
  final VirtualFile file=fileContent.getVirtualFile();
  if (!file.isValid() || file.isDirectory() || myProject.isDisposed()|| !file.exists()|| !myFileIndex.getProjectFileIndex().isInContent(file))   return;
  FileType fileType=file.getFileType();
  Collection<FacetDetectorWrapper> detectors=myDetectors.get(fileType);
  if (detectors == null)   return;
synchronized (myLock) {
    List<FacetInfo2<Module>> facets=null;
    for (    FacetDetectorWrapper<?,?,?,?> detector : detectors) {
      facets=process(file,fileContent,detector,facets);
    }
    String url=file.getUrl();
    FacetDetectionIndexEntry indexEntry=myFileIndex.getIndexEntry(url);
    if (indexEntry == null) {
      indexEntry=new FacetDetectionIndexEntry(file.getTimeStamp());
    }
    Collection<Integer> removed=indexEntry.update(myFacetPointersManager,facets);
    myFileIndex.putIndexEntry(url,indexEntry);
    if (removed != null) {
      removeObsoleteFacets(removed);
    }
  }
}
