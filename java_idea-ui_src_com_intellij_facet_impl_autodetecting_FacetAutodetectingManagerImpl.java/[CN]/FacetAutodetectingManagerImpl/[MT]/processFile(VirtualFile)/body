{
  if (!virtualFile.isValid() || virtualFile.isDirectory() || myProject.isDisposed()|| !virtualFile.exists()|| !myFileIndex.getProjectFileIndex().isInContent(virtualFile))   return;
  FileType fileType=virtualFile.getFileType();
  Collection<FacetDetectorWrapper> detectors=myDetectors.get(fileType);
  if (detectors == null)   return;
  List<FacetInfo2<Module>> facets=null;
  for (  FacetDetectorWrapper<?,?,?,?> detector : detectors) {
    facets=process(virtualFile,detector,facets);
  }
  String url=virtualFile.getUrl();
  FacetDetectionIndexEntry indexEntry=myFileIndex.getIndexEntry(url);
  if (indexEntry == null) {
    indexEntry=new FacetDetectionIndexEntry(virtualFile.getTimeStamp());
  }
  Collection<Integer> removed=indexEntry.update(myFacetPointersManager,facets);
  myFileIndex.putIndexEntry(url,indexEntry);
  if (removed != null) {
    removeObsoleteFacets(removed);
  }
}
