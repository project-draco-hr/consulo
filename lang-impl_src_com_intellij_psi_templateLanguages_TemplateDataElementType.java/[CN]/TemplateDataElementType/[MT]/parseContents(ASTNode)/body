{
  final CharTable table=SharedImplUtil.findCharTableByTree(chameleon);
  final FileElement treeElement=new DummyHolder(((TreeElement)chameleon).getManager(),null,table).getTreeElement();
  final PsiFile file=(PsiFile)TreeUtil.getFileElement((TreeElement)chameleon).getPsi();
  PsiFile originalFile=file.getOriginalFile();
  if (originalFile == null)   originalFile=file;
  final TemplateLanguageFileViewProvider viewProvider=(TemplateLanguageFileViewProvider)originalFile.getViewProvider();
  final Language language=viewProvider.getTemplateDataLanguage();
  final CharSequence chars=((LeafElement)chameleon).getInternedText();
  final Lexer baseLexer=createBaseLexer(viewProvider);
  final CharSequence templateText=createTemplateText(chars,baseLexer);
  final PsiFile templateFile=createFromText(language,templateText,file.getManager());
  final TreeElement parsed=((PsiFileImpl)templateFile).calcTreeElement();
  ChameleonTransforming.transformChildren(parsed,false);
  Lexer langLexer=LanguageParserDefinitions.INSTANCE.forLanguage(language).createLexer(file.getProject());
  final Lexer lexer=new MergingLexerAdapter(new TemplateBlackAndWhiteLexer(createBaseLexer(viewProvider),langLexer,myTemplateElementType,myOuterElementType),TokenSet.create(myTemplateElementType,myOuterElementType));
  lexer.start(chars,0,chars.length(),0);
  insertOuters(parsed,lexer,table);
  if (parsed != null) {
    final TreeElement element=parsed.getFirstChildNode();
    if (element != null) {
      TreeUtil.addChildren(treeElement,element);
    }
  }
  treeElement.clearCaches();
  treeElement.subtreeChanged();
  return treeElement.getFirstChildNode();
}
