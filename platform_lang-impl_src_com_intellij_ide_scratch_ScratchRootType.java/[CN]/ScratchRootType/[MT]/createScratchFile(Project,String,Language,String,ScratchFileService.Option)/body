{
  RunResult<VirtualFile> result=new WriteCommandAction<VirtualFile>(project,UIBundle.message("file.chooser.create.new.file.command.name")){
    @Override protected boolean isGlobalUndoAction(){
      return true;
    }
    @Override protected UndoConfirmationPolicy getUndoConfirmationPolicy(){
      return UndoConfirmationPolicy.REQUEST_CONFIRMATION;
    }
    @Override protected void run(    @NotNull Result<VirtualFile> result) throws Throwable {
      ScratchFileService fileService=ScratchFileService.getInstance();
      VirtualFile file=fileService.findFile(ScratchRootType.this,fileName,option);
      fileService.getScratchesMapping().setMapping(file,language);
      VfsUtil.saveText(file,text);
      result.setResult(file);
    }
  }
.execute();
  if (result.hasException()) {
    Messages.showMessageDialog(UIBundle.message("create.new.file.could.not.create.file.error.message",fileName),UIBundle.message("error.dialog.title"),Messages.getErrorIcon());
    return null;
  }
  return result.getResultObject();
}
