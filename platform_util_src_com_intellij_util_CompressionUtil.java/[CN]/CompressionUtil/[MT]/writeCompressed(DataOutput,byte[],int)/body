{
  if (length > COMPRESSION_THRESHOLD) {
    final byte[] compressedOutputBuffer=spareBufferLocal.getBuffer(Snappy.maxCompressedLength(length));
    int compressedSize=Snappy.compress(bytes,0,length,compressedOutputBuffer,0);
    DataInputOutputUtil.writeINT(out,-compressedSize);
    out.write(compressedOutputBuffer,0,compressedSize);
    return compressedSize;
  }
 else {
    DataInputOutputUtil.writeINT(out,length);
    out.write(bytes,0,length);
    return length;
  }
}
