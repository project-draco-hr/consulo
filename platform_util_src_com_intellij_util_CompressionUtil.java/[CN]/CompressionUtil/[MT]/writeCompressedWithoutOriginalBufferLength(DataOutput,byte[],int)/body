{
  long started=System.nanoTime();
  final byte[] compressedOutputBuffer=spareBufferLocal.getBuffer(Snappy.maxCompressedLength(length));
  int compressedSize=Snappy.compress(bytes,0,length,compressedOutputBuffer,0);
  final long time=System.nanoTime() - started;
  mySizeAfterCompression.addAndGet(compressedSize);
  mySizeBeforeCompression.addAndGet(length);
  int requests=myCompressionRequests.incrementAndGet();
  long l=myCompressionTime.addAndGet(time);
  if (DUMP_COMPRESSION_STATS && requests % 1000 == 0) {
    System.out.println("Compressed " + requests + " times, size:"+ mySizeBeforeCompression+ "->"+ mySizeAfterCompression+ " for "+ (l / 1000000)+ "ms");
  }
  DataInputOutputUtil.writeINT(out,compressedSize);
  out.write(compressedOutputBuffer,0,compressedSize);
  return compressedSize;
}
