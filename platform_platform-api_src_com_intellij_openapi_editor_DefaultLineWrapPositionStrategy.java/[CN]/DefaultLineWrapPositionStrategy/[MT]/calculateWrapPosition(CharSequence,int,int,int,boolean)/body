{
  if (endOffset <= startOffset) {
    return endOffset;
  }
  int maxPreferredOffsetToUse=maxPreferredOffset >= endOffset ? endOffset - 1 : maxPreferredOffset;
  for (int i=maxPreferredOffsetToUse; i > startOffset; i--) {
    char c=text.charAt(i);
    if (WHITE_SPACES.contains(c)) {
      return i < maxPreferredOffsetToUse ? i + 1 : i;
    }
    if (i > startOffset + 1 && !isIdSymbol(c) && !isIdSymbol(text.charAt(i - 1))) {
      continue;
    }
    if (SPECIAL_SYMBOLS_TO_WRAP_AFTER.contains(c)) {
      if (i < maxPreferredOffsetToUse) {
        return i + 1;
      }
      continue;
    }
    if (SPECIAL_SYMBOLS_TO_WRAP_BEFORE.contains(c) || WHITE_SPACES.contains(c)) {
      return i;
    }
    if (!isIdSymbol(c) && (i < startOffset + 2 || (isIdSymbol(text.charAt(i - 1)) && !WHITE_SPACES.contains(text.charAt(i - 1))))) {
      return i;
    }
  }
  for (int i=maxPreferredOffsetToUse + 1; i < endOffset; i++) {
    char c=text.charAt(i);
    if (WHITE_SPACES.contains(c)) {
      return i;
    }
    if (i < endOffset - 1 && !isIdSymbol(c) && !isIdSymbol(text.charAt(i + 1)) && !isIdSymbol(text.charAt(i - 1))) {
      continue;
    }
    if (SPECIAL_SYMBOLS_TO_WRAP_BEFORE.contains(c)) {
      return i;
    }
    if (SPECIAL_SYMBOLS_TO_WRAP_AFTER.contains(c) && i < endOffset - 1) {
      return i + 1;
    }
    if (!isIdSymbol(c) && (i >= endOffset - 1 || isIdSymbol(text.charAt(i + 1)))) {
      return i;
    }
  }
  return maxPreferredOffset;
}
