{
  if (session.isAsynchronous()) {
    queueSession(session,ModalityState.defaultModalityState());
  }
 else {
    final Application app=ApplicationManager.getApplication();
    boolean isEDT=app.isDispatchThread();
    final boolean hasWriteAction=app.isWriteAccessAllowed();
    if (isEDT || hasWriteAction) {
      session.scan();
      if (hasWriteAction) {
        session.fireEvents();
      }
 else {
        app.runWriteAction(new Runnable(){
          public void run(){
            session.fireEvents();
          }
        }
);
      }
    }
 else {
      if (((ApplicationEx)app).holdsReadLock()) {
        LOG.error("Do not call synchronous refresh from inside read action except for event dispatch thread. This will eventually cause deadlock if there are events to fire");
        return;
      }
      queueSession(session,ModalityState.defaultModalityState());
      session.waitFor();
    }
  }
}
