{
  final Runnable worker=new Runnable(){
    public void run(){
synchronized (queue) {
        final VirtualFileManagerEx manager=(VirtualFileManagerEx)VirtualFileManager.getInstance();
        manager.fireBeforeRefreshStart(async);
        for (        RefreshResult result : queue) {
          ManagingFS.getInstance().processEvents(result.getEvents());
        }
        manager.fireAfterRefreshFinish(async);
        for (        RefreshResult result : queue) {
          final Runnable finishRunnable=result.getFinishRunnable();
          if (finishRunnable != null) {
            finishRunnable.run();
          }
        }
        notifyCacheUpdaters();
        queue.clear();
      }
    }
  }
;
  if (async) {
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            worker.run();
          }
        }
);
      }
    }
,ModalityState.NON_MODAL);
  }
 else {
    worker.run();
  }
}
