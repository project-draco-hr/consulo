{
  CharSequence chars=editor.getDocument().getCharsSequence();
  if (!(offset >= 3 && chars.charAt(offset - 1) == '!' && chars.charAt(offset - 2) == '%' && chars.charAt(offset - 3) == '<') && !(offset >= 2 && chars.charAt(offset - 1) == '%' && chars.charAt(offset - 2) == '<')) {
    return false;
  }
  EditorHighlighter highlighter=((EditorEx)editor).getHighlighter();
  HighlighterIterator iterator=highlighter.createIterator(offset - 2);
  if (iterator.getTokenType() != JspTokenType.JSP_SCRIPTLET_START && iterator.getTokenType() != JspTokenType.JSP_DECLARATION_START) {
    return false;
  }
  iterator=highlighter.createIterator(offset);
  while (!iterator.atEnd()) {
    IElementType tokenType=iterator.getTokenType();
    if (tokenType == JspTokenType.JSP_SCRIPTLET_START || tokenType == JspTokenType.JSP_DECLARATION_START) {
      return true;
    }
    if (tokenType == JspTokenType.JSP_SCRIPTLET_END || tokenType == JspTokenType.JSP_DECLARATION_END) {
      return false;
    }
    iterator.advance();
  }
  return true;
}
