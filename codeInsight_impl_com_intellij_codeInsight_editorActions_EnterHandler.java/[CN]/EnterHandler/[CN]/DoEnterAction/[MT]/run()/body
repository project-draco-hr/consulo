{
  try {
    final CharSequence chars=myDocument.getCharsSequence();
    int offset=CharArrayUtil.shiftBackwardUntil(chars,myOffset - 1,LINE_SEPARATOR) - 1;
    offset=CharArrayUtil.shiftBackwardUntil(chars,offset,LINE_SEPARATOR) + 1;
    int lineStart=CharArrayUtil.shiftForward(chars,offset," \t");
    boolean isInsideJava=PsiUtil.getLanguageAtOffset(myFile,offset) == StdLanguages.JAVA;
    boolean docStart=isInsideJava && CharArrayUtil.regionMatches(chars,lineStart,DOC_COMMENT_PREFIX);
    boolean cStyleStart=isInsideJava && CharArrayUtil.regionMatches(chars,lineStart,CSTYLE_COMMENT_PREFIX);
    boolean docAsterisk=isInsideJava && CharArrayUtil.regionMatches(chars,lineStart,DOC_COMMENT_ASTERISK_STRING);
    boolean slashSlash=isInsideJava && CharArrayUtil.regionMatches(chars,lineStart,"//") && chars.charAt(CharArrayUtil.shiftForward(chars,myOffset," \t")) != '\n';
    if (docStart) {
      PsiElement element=myFile.findElementAt(lineStart);
      if (element.getText().equals(DOC_COMMENT_PREFIX) && element.getParent() instanceof PsiDocComment) {
        PsiDocComment comment=(PsiDocComment)element.getParent();
        int commentEnd=comment.getTextRange().getEndOffset();
        if (myOffset >= commentEnd) {
          docStart=false;
        }
 else {
          if (isCommentComplete(comment)) {
            if (myOffset >= commentEnd) {
              docAsterisk=false;
              docStart=false;
            }
 else {
              docAsterisk=true;
              docStart=false;
            }
          }
 else {
            generateJavadoc();
          }
        }
      }
 else {
        docStart=false;
      }
    }
 else     if (cStyleStart) {
      PsiElement element=myFile.findElementAt(lineStart);
      if (element instanceof PsiComment && ((PsiComment)element).getTokenType() == JavaTokenType.C_STYLE_COMMENT) {
        final PsiComment comment=(PsiComment)element;
        int commentEnd=comment.getTextRange().getEndOffset();
        if (myOffset >= commentEnd) {
          docStart=false;
        }
 else {
          if (isCommentComplete(comment)) {
            if (myOffset >= commentEnd) {
              docAsterisk=false;
              docStart=false;
            }
 else {
              docAsterisk=true;
              docStart=false;
            }
          }
 else {
            myDocument.insertString(myOffset," " + DOC_COMMENT_SUFFIX);
            int lstart=CharArrayUtil.shiftBackwardUntil(chars,myOffset,"\n");
            myDocument.insertString(myOffset,chars.subSequence(lstart,myOffset));
          }
        }
      }
 else {
        docStart=false;
      }
    }
    if (docAsterisk) {
      docAsterisk=insertDocAsterisk(lineStart,docAsterisk);
    }
    if (CodeInsightSettings.getInstance().SMART_INDENT_ON_ENTER || myForceIndent || docStart|| docAsterisk|| slashSlash) {
      myOffset=CodeStyleManager.getInstance(getProject()).adjustLineIndent(myFile,myOffset);
    }
    if (docAsterisk || docStart || slashSlash) {
      if (myInsertSpace) {
        if (myOffset == myDocument.getTextLength()) {
          myDocument.insertString(myOffset," ");
        }
        myDocument.insertString(myOffset + 1," ");
      }
      final char c=myDocument.getCharsSequence().charAt(myOffset);
      if (c != '\n') {
        myOffset+=1;
      }
    }
    if ((docAsterisk || slashSlash) && !docStart) {
      myCaretAdvance=slashSlash ? 2 : 1;
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
  myEditor.getCaretModel().moveToOffset(myOffset);
  myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  myEditor.getSelectionModel().removeSelection();
  if (myCaretAdvance != 0) {
    LogicalPosition caretPosition=myEditor.getCaretModel().getLogicalPosition();
    LogicalPosition pos=new LogicalPosition(caretPosition.line,caretPosition.column + myCaretAdvance);
    myEditor.getCaretModel().moveToLogicalPosition(pos);
  }
}
