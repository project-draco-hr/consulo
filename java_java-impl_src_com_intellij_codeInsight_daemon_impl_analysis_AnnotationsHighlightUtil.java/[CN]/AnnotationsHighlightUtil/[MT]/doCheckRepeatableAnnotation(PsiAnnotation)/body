{
  PsiAnnotationOwner owner=annotation.getOwner();
  if (!(owner instanceof PsiModifierList))   return null;
  PsiElement target=((PsiModifierList)owner).getParent();
  if (!(target instanceof PsiClass) || !((PsiClass)target).isAnnotationType())   return null;
  PsiClass container=getRepeatableContainer(annotation);
  if (container == null)   return null;
  PsiMethod[] methods=container.findMethodsByName("value",false);
  if (methods.length == 0) {
    return JavaErrorMessages.message("annotation.container.no.value",container.getQualifiedName());
  }
  if (methods.length == 1) {
    PsiType expected=new PsiImmediateClassType((PsiClass)target,PsiSubstitutor.EMPTY).createArrayType();
    if (!expected.equals(methods[0].getReturnType())) {
      return JavaErrorMessages.message("annotation.container.bad.type",container.getQualifiedName(),HighlightUtil.formatType(expected));
    }
  }
  RetentionPolicy targetPolicy=getRetentionPolicy((PsiClass)target);
  if (targetPolicy != null) {
    RetentionPolicy containerPolicy=getRetentionPolicy(container);
    if (containerPolicy != null && targetPolicy.compareTo(containerPolicy) > 0) {
      return JavaErrorMessages.message("annotation.container.low.retention",container.getQualifiedName(),containerPolicy);
    }
  }
  Set<PsiAnnotation.TargetType> repeatableTargets=PsiImplUtil.getAnnotationTargets((PsiClass)target);
  if (repeatableTargets != null) {
    Set<PsiAnnotation.TargetType> containerTargets=PsiImplUtil.getAnnotationTargets(container);
    if (containerTargets != null && !repeatableTargets.containsAll(containerTargets)) {
      return JavaErrorMessages.message("annotation.container.wide.target",container.getQualifiedName());
    }
  }
  return null;
}
