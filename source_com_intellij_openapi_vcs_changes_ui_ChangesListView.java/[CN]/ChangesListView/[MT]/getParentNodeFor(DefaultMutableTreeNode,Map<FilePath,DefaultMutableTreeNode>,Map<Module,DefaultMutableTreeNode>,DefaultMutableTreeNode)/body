{
  if (isShowFlatten()) {
    return rootNode;
  }
  ProjectFileIndex index=ProjectRootManager.getInstance(myProject).getFileIndex();
  final FilePath path=getPathForObject(node.getUserObject());
  final VirtualFile rootFolder=VcsDirtyScope.getRootFor(index,path);
  if (rootFolder == null) {
    return rootNode;
  }
  if (path.getVirtualFile() == rootFolder) {
    Module module=index.getModuleForFile(rootFolder);
    return getNodeForModule(module,moduleNodesCache,rootNode);
  }
  FilePath parentPath=getParentPath(path);
  DefaultMutableTreeNode parentNode=folderNodesCache.get(parentPath);
  if (parentNode == null) {
    parentNode=new DefaultMutableTreeNode(parentPath);
    DefaultMutableTreeNode grandPa=getParentNodeFor(parentNode,folderNodesCache,moduleNodesCache,rootNode);
    ((DefaultTreeModel)getModel()).insertNodeInto(parentNode,grandPa,grandPa.getChildCount());
    folderNodesCache.put(parentPath,parentNode);
  }
  return parentNode;
}
