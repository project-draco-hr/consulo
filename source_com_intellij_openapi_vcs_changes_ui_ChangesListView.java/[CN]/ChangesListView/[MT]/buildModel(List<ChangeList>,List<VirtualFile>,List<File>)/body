{
  Node root=new Node(ROOT_NODE_VALUE);
  final DefaultTreeModel model=new DefaultTreeModel(root);
  for (  ChangeList list : changeLists) {
    Node listNode=new Node(list);
    model.insertNodeInto(listNode,root,0);
    final HashMap<FilePath,Node> foldersCache=new HashMap<FilePath,Node>();
    final HashMap<Module,Node> moduleCache=new HashMap<Module,Node>();
    for (    Change change : list.getChanges()) {
      final Node node=new Node(change);
      ChangesUtil.getFilePath(change).refresh();
      model.insertNodeInto(node,getParentNodeFor(node,foldersCache,moduleCache,listNode),0);
    }
  }
  if (!unversionedFiles.isEmpty()) {
    Node unversionedNode=new Node(VcsBundle.message("changes.nodetitle.unversioned.files"));
    model.insertNodeInto(unversionedNode,root,root.getChildCount());
    final HashMap<FilePath,Node> foldersCache=new HashMap<FilePath,Node>();
    final HashMap<Module,Node> moduleCache=new HashMap<Module,Node>();
    for (    VirtualFile file : unversionedFiles) {
      final Node node=new Node(file);
      model.insertNodeInto(node,getParentNodeFor(node,foldersCache,moduleCache,unversionedNode),0);
    }
  }
  if (!locallyDeletedFiles.isEmpty()) {
    Node locallyDeletedNode=new Node("Locally Deleted");
    model.insertNodeInto(locallyDeletedNode,root,root.getChildCount());
    final VcsContextFactory factory=PeerFactory.getInstance().getVcsContextFactory();
    final HashMap<FilePath,Node> foldersCache=new HashMap<FilePath,Node>();
    final HashMap<Module,Node> moduleCache=new HashMap<Module,Node>();
    for (    File file : locallyDeletedFiles) {
      final Node node=new Node(factory.createFilePathOn(file));
      model.insertNodeInto(node,getParentNodeFor(node,foldersCache,moduleCache,locallyDeletedNode),0);
    }
  }
  collapseDirectories(model,root);
  return model;
}
