{
  final Change[] changes=getSelectedChanges();
  ArrayList<VirtualFile> files=new ArrayList<VirtualFile>();
  for (  Change change : changes) {
    final ContentRevision afterRevision=change.getAfterRevision();
    if (afterRevision != null) {
      final VirtualFile file=afterRevision.getFile().getVirtualFile();
      if (file != null && file.isValid()) {
        files.add(file);
      }
    }
  }
  final TreePath[] paths=getSelectionPaths();
  if (paths != null) {
    for (    TreePath path : paths) {
      DefaultMutableTreeNode node=(DefaultMutableTreeNode)path.getLastPathComponent();
      final Object userObject=node.getUserObject();
      if (userObject instanceof VirtualFile) {
        final VirtualFile file=(VirtualFile)userObject;
        if (file.isValid()) {
          files.add(file);
        }
      }
    }
  }
  return files.toArray(new VirtualFile[files.size()]);
}
