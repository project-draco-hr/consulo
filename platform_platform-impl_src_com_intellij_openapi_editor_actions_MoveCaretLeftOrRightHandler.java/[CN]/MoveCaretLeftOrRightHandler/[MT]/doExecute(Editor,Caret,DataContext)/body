{
  final SelectionModel selectionModel=editor.getSelectionModel();
  final CaretModel caretModel=editor.getCaretModel();
  ScrollingModel scrollingModel=editor.getScrollingModel();
  if (selectionModel.hasSelection() && (!(editor instanceof EditorEx) || !((EditorEx)editor).isStickySelection())) {
    if (editor.getIndentsModel().getCaretIndentGuide() != null) {
      selectionModel.removeSelection();
    }
 else {
      int start=selectionModel.getSelectionStart();
      int end=selectionModel.getSelectionEnd();
      int caretOffset=caretModel.getOffset();
      if (start <= caretOffset && end >= caretOffset) {
        VisualPosition targetPosition=null;
        if (Registry.is("editor.new.rendering")) {
          targetPosition=myDirection == Direction.RIGHT ? caret.getSelectionEndPosition() : caret.getSelectionStartPosition();
        }
 else         if (caretModel.supportsMultipleCarets() && editor.isColumnMode()) {
          targetPosition=myDirection == Direction.RIGHT ? selectionModel.getSelectionEndPosition() : selectionModel.getSelectionStartPosition();
        }
        selectionModel.removeSelection();
        if (targetPosition != null) {
          caretModel.moveToVisualPosition(targetPosition);
        }
 else {
          caretModel.moveToOffset(myDirection == Direction.RIGHT ^ caret.isAtRtlLocation() ? end : start);
        }
        if (caret == editor.getCaretModel().getPrimaryCaret()) {
          scrollingModel.scrollToCaret(ScrollType.RELATIVE);
        }
        return;
      }
    }
  }
  VisualPosition currentPosition=caret.getVisualPosition();
  if (caret.isAtBidiRunBoundary() && (myDirection == Direction.RIGHT ^ currentPosition.leansRight)) {
    caret.moveToVisualPosition(currentPosition.leanRight(!currentPosition.leansRight));
  }
 else {
    final boolean scrollToCaret=(!(editor instanceof EditorImpl) || ((EditorImpl)editor).isScrollToCaret()) && caret == editor.getCaretModel().getPrimaryCaret();
    caretModel.moveCaretRelatively(myDirection == Direction.RIGHT ? 1 : -1,0,false,false,scrollToCaret);
  }
}
