{
  final MavenProjectsManager manager=MavenProjectsManager.getInstance(project);
  final MavenImportingSettings settings=manager.getImportingSettings();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      List<ModifiableRootModel> rootModels=new ArrayList<ModifiableRootModel>();
      for (      Module each : ModuleManager.getInstance(project).getModules()) {
        MavenProject project=manager.findProject(each);
        if (project == null)         continue;
        MavenRootModelAdapter a=new MavenRootModelAdapter(each,null);
        new MavenFoldersConfigurator(project,settings,a).config(updateTargetFoldersOnly);
        ModifiableRootModel model=a.getRootModel();
        if (model.isChanged()) {
          rootModels.add(model);
        }
 else {
          model.dispose();
        }
      }
      if (!rootModels.isEmpty()) {
        ModifiableRootModel[] modelsArray=rootModels.toArray(new ModifiableRootModel[rootModels.size()]);
        ProjectRootManager.getInstance(project).multiCommit(modelsArray);
      }
    }
  }
);
}
