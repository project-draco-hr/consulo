{
  final PsiElement paramParent=param.getParent();
  if (paramParent instanceof PsiParameterList) {
    final int parameterIndex=((PsiParameterList)paramParent).getParameterIndex(param);
    if (parameterIndex > -1) {
      final PsiLambdaExpression lambdaExpression=PsiTreeUtil.getParentOfType(param,PsiLambdaExpression.class);
      if (lambdaExpression != null) {
        final PsiElement parent=lambdaExpression.getParent();
        PsiType type=null;
        if (parent instanceof PsiTypeCastExpression) {
          type=((PsiTypeCastExpression)parent).getType();
        }
 else         if (parent instanceof PsiVariable) {
          type=((PsiVariable)parent).getType();
        }
        if (type instanceof PsiClassType) {
          final PsiClassType.ClassResolveResult resolveResult=((PsiClassType)type).resolveGenerics();
          final PsiClass psiClass=resolveResult.getElement();
          if (psiClass != null) {
            final MethodSignature methodSignature=getFunction(psiClass);
            if (methodSignature != null) {
              return resolveResult.getSubstitutor().substitute(methodSignature.getParameterTypes()[parameterIndex]);
            }
          }
        }
      }
    }
  }
  return new PsiLambdaParameterType(param);
}
