{
  if (text == null) {
    text=getMode() == EvaluationMode.EXPRESSION ? XExpressionImpl.EMPTY_EXPRESSION : XExpressionImpl.EMPTY_CODE_FRAGMENT;
  }
  saveTextInHistory(text);
  Language language=text.getLanguage();
  if (language == null) {
    if (mySourcePosition != null) {
      language=getFileTypeLanguage(mySourcePosition.getFile().getFileType());
    }
    if (language == null) {
      language=getFileTypeLanguage(getEditorsProvider().getFileType());
    }
  }
  text=new XExpressionImpl(text.getExpression(),language,text.getCustomInfo(),getMode());
  Collection<Language> languages=getEditorsProvider().getSupportedLanguages(myProject,mySourcePosition);
  boolean many=languages.size() > 1;
  if (language != null) {
    myChooseFactory.setVisible(many);
  }
  myChooseFactory.setVisible(myChooseFactory.isVisible() || many);
  if (language != null && language.getAssociatedFileType() != null) {
    Icon icon=language.getAssociatedFileType().getIcon();
    myChooseFactory.setIcon(icon);
    myChooseFactory.setDisabledIcon(IconLoader.getDisabledIcon(icon));
  }
  doSetText(text);
}
