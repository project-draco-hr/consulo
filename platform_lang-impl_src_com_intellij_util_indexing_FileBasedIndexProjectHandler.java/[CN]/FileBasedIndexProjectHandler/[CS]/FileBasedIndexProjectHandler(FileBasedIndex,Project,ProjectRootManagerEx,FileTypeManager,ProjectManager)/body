{
  super(project);
  myIndex=index;
  myRootManager=rootManager;
  myFileTypeManager=ftManager;
  myExclusionManager=ProjectFileExclusionManager.getInstance(project);
  final StartupManagerEx startupManager=(StartupManagerEx)StartupManager.getInstance(project);
  if (startupManager != null) {
    startupManager.registerPreStartupActivity(new Runnable(){
      public void run(){
        final RefreshCacheUpdater changedFilesUpdater=new RefreshCacheUpdater();
        final UnindexedFilesUpdater unindexedFilesUpdater=new UnindexedFilesUpdater(project,index);
        startupManager.registerCacheUpdater(unindexedFilesUpdater);
        rootManager.registerRootsChangeUpdater(unindexedFilesUpdater);
        rootManager.registerRefreshUpdater(changedFilesUpdater);
        myIndex.registerIndexableSet(FileBasedIndexProjectHandler.this,project);
        projectManager.addProjectManagerListener(project,new ProjectManagerAdapter(){
          public void projectClosing(          Project project){
            rootManager.unregisterRefreshUpdater(changedFilesUpdater);
            rootManager.unregisterRootsChangeUpdater(unindexedFilesUpdater);
            myIndex.removeIndexableSet(FileBasedIndexProjectHandler.this);
          }
        }
);
      }
    }
);
  }
}
