{
  EditorEventMulticaster eventMulticaster=EditorFactory.getInstance().getEventMulticaster();
  EditorMouseAdapter myEditorMouseListener=new EditorMouseAdapter(){
    @Nullable private EditorMouseEvent myMousePressedEvent;
    @Nullable private Breakpoint toggleBreakpoint(    final boolean mostSuitingBreakpoint,    final int line){
      final Editor editor=FileEditorManager.getInstance(myProject).getSelectedTextEditor();
      if (editor == null) {
        return null;
      }
      final Document document=editor.getDocument();
      final PsiFile psiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
      if (psiFile == null) {
        return null;
      }
      final FileType fileType=psiFile.getFileType();
      boolean isInsideCompiledClass=StdFileTypes.CLASS.equals(fileType);
      if (!isInsideCompiledClass && !(DebuggerUtils.supportsJVMDebugging(fileType) || DebuggerUtils.supportsJVMDebugging(psiFile))) {
        return null;
      }
      PsiDocumentManager.getInstance(myProject).commitDocument(document);
      int offset=editor.getCaretModel().getOffset();
      int editorLine=editor.getDocument().getLineNumber(offset);
      if (editorLine != line) {
        if (line < 0 || line >= document.getLineCount()) {
          return null;
        }
        offset=editor.getDocument().getLineStartOffset(line);
      }
      ExpandRegionAction.expandRegionAtCaret(myProject,editor);
      Breakpoint breakpoint=findBreakpoint(document,offset,null);
      if (breakpoint == null) {
        if (mostSuitingBreakpoint || isInsideCompiledClass) {
          breakpoint=addFieldBreakpoint(document,offset);
          if (breakpoint == null) {
            breakpoint=addMethodBreakpoint(document,line);
          }
          if (breakpoint == null && !isInsideCompiledClass) {
            breakpoint=addLineBreakpoint(document,line);
          }
        }
 else {
          breakpoint=addLineBreakpoint(document,line);
          if (breakpoint == null) {
            breakpoint=addMethodBreakpoint(document,line);
          }
        }
        if (breakpoint != null) {
          RequestManagerImpl.createRequests(breakpoint);
        }
        return breakpoint;
      }
 else {
        removeBreakpoint(breakpoint);
        return null;
      }
    }
    private boolean isFromMyProject(    Editor editor){
      FileEditor[] allEditors=FileEditorManager.getInstance(myProject).getAllEditors();
      for (      FileEditor ed : allEditors) {
        if (!(ed instanceof TextEditor)) {
          continue;
        }
        if (((TextEditor)ed).getEditor().equals(editor)) {
          return true;
        }
      }
      return false;
    }
    @Override public void mousePressed(    @NotNull EditorMouseEvent e){
      if (MarkupEditorFilterFactory.createIsDiffFilter().avaliableIn(e.getEditor()))       return;
      if (e.isConsumed())       return;
      if (e.getArea() == EditorMouseEventArea.LINE_MARKERS_AREA && e.getMouseEvent().isShiftDown()) {
        myMousePressedEvent=e;
        e.consume();
      }
    }
    @Override public void mouseReleased(    @NotNull EditorMouseEvent e){
      if (myMousePressedEvent != null) {
        mouseClicked(e);
      }
      myMousePressedEvent=null;
    }
    @Override public void mouseClicked(    @NotNull final EditorMouseEvent e){
      if (MarkupEditorFilterFactory.createIsDiffFilter().avaliableIn(e.getEditor()))       return;
      if (e.isConsumed())       return;
      if (e.getArea() == EditorMouseEventArea.LINE_MARKERS_AREA) {
        PsiDocumentManager.getInstance(myProject).commitAndRunReadAction(new Runnable(){
          @Override public void run(){
            final Editor editor=e.getEditor();
            if (!isFromMyProject(editor)) {
              return;
            }
            final int line=editor.xyToLogicalPosition(e.getMouseEvent().getPoint()).line;
            final Document document=editor.getDocument();
            if (line < 0 || line >= document.getLineCount()) {
              return;
            }
            MouseEvent event=e.getMouseEvent();
            if (event.isPopupTrigger()) {
              return;
            }
            if (event.getButton() != 1) {
              return;
            }
            if (e.getMouseEvent().isControlDown() || e.getMouseEvent().isMetaDown()) {
              return;
            }
            if (XDebuggerUtil.getInstance().canPutBreakpointAt(myProject,FileDocumentManager.getInstance().getFile(document),line)) {
              return;
            }
            e.consume();
            DebuggerInvocationUtil.invokeLater(myProject,new Runnable(){
              @Override public void run(){
                Breakpoint breakpoint=toggleBreakpoint(e.getMouseEvent().isAltDown(),line);
                if (e.getMouseEvent().isShiftDown() && breakpoint != null) {
                  breakpoint.LOG_EXPRESSION_ENABLED=true;
                  String selection=editor.getSelectionModel().getSelectedText();
                  String text=selection != null ? selection : DebuggerBundle.message("breakpoint.log.message",breakpoint.getDisplayName());
                  breakpoint.setLogMessage(new TextWithImportsImpl(CodeFragmentKind.EXPRESSION,text));
                  breakpoint.SUSPEND_POLICY=DebuggerSettings.SUSPEND_NONE;
                  DialogWrapper dialog=DebuggerManagerEx.getInstanceEx(myProject).getBreakpointManager().createConfigurationDialog(breakpoint,BreakpointPropertiesPanel.CONTROL_LOG_MESSAGE);
                  dialog.show();
                  if (!dialog.isOK()) {
                    removeBreakpoint(breakpoint);
                  }
                }
              }
            }
);
          }
        }
);
      }
    }
  }
;
  eventMulticaster.addEditorMouseListener(myEditorMouseListener,myProject);
  final DocumentListener myDocumentListener=new DocumentAdapter(){
    private final Alarm myUpdateAlarm=new Alarm();
    @Override public void documentChanged(    @NotNull final DocumentEvent e){
      final Document document=e.getDocument();
synchronized (BreakpointManager.this) {
        List<BreakpointWithHighlighter> breakpoints=myDocumentBreakpoints.get(document);
        if (breakpoints != null) {
          myUpdateAlarm.cancelAllRequests();
          final List<BreakpointWithHighlighter> breakpointsToUpdate=new ArrayList<BreakpointWithHighlighter>(breakpoints);
          myUpdateAlarm.addRequest(new Runnable(){
            @Override public void run(){
              if (!myProject.isDisposed()) {
                PsiDocumentManager.getInstance(myProject).commitDocument(document);
                update(breakpointsToUpdate);
              }
            }
          }
,300,ModalityState.NON_MODAL);
        }
      }
    }
  }
;
  eventMulticaster.addDocumentListener(myDocumentListener,myProject);
}
