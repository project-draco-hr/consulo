{
  File dir=FileUtil.createTempDirectory(tempName,null);
  filesToDelete.add(dir);
  final VirtualFile vDir=LocalFileSystem.getInstance().refreshAndFindFileByPath(dir.getCanonicalPath().replace(File.separatorChar,'/'));
  final Exception[] exception={null};
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      if (rootPath != null) {
        VirtualFile vDir1=LocalFileSystem.getInstance().findFileByPath(rootPath.replace(File.separatorChar,'/'));
        if (vDir1 == null) {
          exception[0]=new Exception(rootPath + " not found");
          return;
        }
        try {
          VfsUtil.copyDirectory(null,vDir1,vDir,null);
        }
 catch (        IOException e) {
          exception[0]=e;
          return;
        }
      }
      if (addProjectRoots) {
        addSourceContentToRoots(module,vDir);
      }
    }
  }
);
  if (exception[0] != null)   throw exception[0];
  return vDir;
}
