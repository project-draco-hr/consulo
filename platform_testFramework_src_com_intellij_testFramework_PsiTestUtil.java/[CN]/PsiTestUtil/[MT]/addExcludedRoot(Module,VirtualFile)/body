{
  AccessToken token=WriteAction.start();
  try {
    final ModifiableRootModel model=ModuleRootManager.getInstance(module).getModifiableModel();
    boolean added=false;
    for (    ContentEntry entry : model.getContentEntries()) {
      if (VfsUtil.isAncestor(entry.getFile(),dir,false)) {
        entry.addExcludeFolder(dir);
        added=true;
        break;
      }
    }
    if (!added) {
      throw new RuntimeException(dir + " is not under content roots: " + Arrays.toString(model.getContentRoots()));
    }
    model.commit();
  }
  finally {
    token.finish();
  }
}
