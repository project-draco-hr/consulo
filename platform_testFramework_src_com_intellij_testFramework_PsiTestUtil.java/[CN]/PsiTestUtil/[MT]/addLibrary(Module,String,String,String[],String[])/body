{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      final ModifiableRootModel model=ModuleRootManager.getInstance(module).getModifiableModel();
      final String parentUrl=VirtualFileManager.constructUrl(classRoots[0].endsWith(".jar!/") ? JarFileSystem.PROTOCOL : LocalFileSystem.PROTOCOL,libDir);
      final Library library=model.getModuleLibraryTable().createLibrary(libName);
      final Library.ModifiableModel libModifiableModel=library.getModifiableModel();
      for (      String classRoot : classRoots) {
        libModifiableModel.addRoot(parentUrl + classRoot,OrderRootType.CLASSES);
      }
      for (      String sourceRoot : sourceRoots) {
        libModifiableModel.addRoot(parentUrl + sourceRoot,OrderRootType.SOURCES);
      }
      libModifiableModel.commit();
      model.commit();
    }
  }
);
}
