{
  if (!DiffUtil.canMakeWritable(document)) {
    throw new InvalidDiffRequestException("Output is read only" + (file != null ? " : '" + file.getPresentableUrl() + "'" : ""));
  }
  if (windowTitle == null)   windowTitle=getBadPatchTitle(file);
  if (localTitle == null)   localTitle=VcsBundle.message("patch.apply.conflict.local.version");
  if (resultTitle == null)   resultTitle=VcsBundle.message("patch.apply.conflict.patched.somehow.version");
  if (patchTitle == null)   patchTitle=VcsBundle.message("patch.apply.conflict.patch");
  DocumentContent resultContent=DiffContentFactory.getInstance().create(project,document,file);
  return new ApplyPatchMergeRequest(project,resultContent,textPatch,localContent,windowTitle,localTitle,resultTitle,patchTitle,callback);
}
