{
  for (  LinkedList<UndoableGroup> each : getAffectedStacks(clearGlobal,refs)) {
    while (!each.isEmpty()) {
      clearStacksFrom(each.getLast());
    }
  }
  Set<DocumentReference> stacksToDrop=new THashSet<DocumentReference>();
  for (  Map.Entry<DocumentReference,LinkedList<UndoableGroup>> each : myDocumentStacks.entrySet()) {
    if (each.getValue().isEmpty())     stacksToDrop.add(each.getKey());
  }
  for (  DocumentReference each : stacksToDrop) {
    myDocumentStacks.remove(each);
  }
  Set<Document> docsToDrop=new THashSet<Document>();
  for (  Document each : myDocumentsWithStacks) {
    LinkedList<UndoableGroup> stack=each.getUserData(STACK_IN_DOCUMENT_KEY);
    if (stack != null && stack.isEmpty()) {
      each.putUserData(STACK_IN_DOCUMENT_KEY,null);
      docsToDrop.add(each);
    }
  }
  myDocumentsWithStacks.removeAll(docsToDrop);
}
