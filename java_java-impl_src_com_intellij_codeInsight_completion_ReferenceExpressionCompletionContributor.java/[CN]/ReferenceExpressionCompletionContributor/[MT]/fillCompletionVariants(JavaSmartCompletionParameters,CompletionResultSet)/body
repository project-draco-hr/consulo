{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      final PsiElement element=parameters.getPosition();
      if (JavaSmartCompletionContributor.INSIDE_TYPECAST_EXPRESSION.accepts(element))       return;
      final int offset=parameters.getOffset();
      final PsiReference reference=element.getContainingFile().findReferenceAt(offset);
      if (reference != null) {
        final boolean isSecond=parameters.getInvocationCount() >= 2;
        final ElementFilter filter=getReferenceFilter(element,false);
        final Set<LookupElement> set=JavaSmartCompletionContributor.completeReference(element,reference,filter,false,parameters);
        for (        final LookupElement item : set) {
          result.addElement(item);
          addSingleArrayElementAccess(element,item,parameters,result);
          if (isSecond) {
            addSecondCompletionVariants(element,reference,item,parameters,result);
          }
        }
        if (isSecond) {
          if (!psiElement().afterLeaf(".").accepts(element)) {
            BasicExpressionCompletionContributor.processDataflowExpressionTypes(element,null,TRUE_MATCHER,new Consumer<LookupElement>(){
              public void consume(              LookupElement baseItem){
                addSecondCompletionVariants(element,reference,baseItem,parameters,result);
              }
            }
);
          }
        }
      }
    }
  }
);
}
