{
  ArrayList<VirtualFile> files=myFileTree.getFiles(psiDirectory.getVirtualFile());
  ArrayList<PsiFile> psiFileList=new ArrayList<PsiFile>(files.size());
  PsiManager psiManager=PsiManager.getInstance(myProject);
  for (int i=0; i < files.size(); i++) {
    VirtualFile file=files.get(i);
    final Module module=ModuleUtil.findModuleForPsiElement(psiDirectory);
    if (module != null) {
      final boolean isInContent=ModuleRootManager.getInstance(module).getFileIndex().isInContent(file);
      if (!isInContent)       continue;
    }
    if (file.isValid()) {
      PsiFile psiFile=psiManager.findFile(file);
      if (psiFile != null) {
        final PsiDirectory directory=psiFile.getContainingDirectory();
        if (directory == null || !skip || !TodoTreeHelper.getInstance(myProject).skipDirectory(directory)) {
          psiFileList.add(psiFile);
        }
      }
    }
  }
  return psiFileList.iterator();
}
