{
  registrar.extend(CompletionType.BASIC,psiElement().inFile(PlatformPatterns.psiFile().withLanguage(StdLanguages.JAVA)),new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      result.stopHere();
      final PsiFile file=parameters.getOriginalFile();
      final int startOffset=parameters.getOffset();
      final PsiElement lastElement=file.findElementAt(startOffset - 1);
      final PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=ApplicationManager.getApplication().runReadAction(new Computable<CompletionData>(){
        public CompletionData compute(){
          return CompletionUtil.getCompletionData(lastElement,file,startOffset,getCompletionDataByElementInner(lastElement));
        }
      }
);
      result.setPrefixMatcher(completionData.findPrefix(insertedElement,startOffset));
      final Set<LookupItem> lookupSet=new LinkedHashSet<LookupItem>();
      final PsiReference ref=ApplicationManager.getApplication().runReadAction(new Computable<PsiReference>(){
        public PsiReference compute(){
          return insertedElement.getContainingFile().findReferenceAt(startOffset);
        }
      }
);
      if (ref != null) {
        completionData.completeReference(ref,lookupSet,insertedElement,result.getPrefixMatcher(),parameters.getOriginalFile(),startOffset);
      }
      final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
      completionData.addKeywordVariants(keywordVariants,insertedElement,parameters.getOriginalFile());
      completionData.completeKeywordsBySet(lookupSet,keywordVariants,insertedElement,result.getPrefixMatcher(),parameters.getOriginalFile());
      for (      final LookupItem item : lookupSet) {
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            JavaCompletionUtil.highlightMemberOfContainer(item);
          }
        }
);
        if (item.getInsertHandler() == null) {
          item.setInsertHandler(new InsertHandler(){
            public void handleInsert(            final CompletionContext context,            final int startOffset,            final LookupData data,            final LookupItem item,            final boolean signatureSelected,            final char completionChar){
              analyzeItem(context,item,item.getObject(),parameters.getPosition());
              new DefaultInsertHandler().handleInsert(context,startOffset,data,item,signatureSelected,completionChar);
            }
          }
);
        }
        result.addElement(item);
      }
    }
    private CompletionData getCompletionDataByElementInner(    PsiElement element){
      if (element != null && PsiTreeUtil.getParentOfType(element,PsiDocComment.class) != null) {
        return JavaCompletionUtil.ourJavaDocCompletionData.getValue();
      }
      return element != null && PsiUtil.getLanguageLevel(element).equals(LanguageLevel.JDK_1_5) ? JavaCompletionUtil.ourJava15CompletionData.getValue() : JavaCompletionUtil.ourJavaCompletionData.getValue();
    }
  }
);
  registrar.extend(psiElement().inFile(PlatformPatterns.psiFile().withLanguage(StdLanguages.JAVA)),new CompletionAdvertiser(){
    public String advertise(    @NotNull final CompletionParameters parameters,    final ProcessingContext context){
      if (parameters.getCompletionType() == CompletionType.CLASS_NAME && parameters.getInvocationCount() == 1 && parameters.getOriginalFile().getLanguage() == StdLanguages.JAVA) {
        if (shouldShowFeature(parameters,CodeCompletionFeatures.SECOND_CLASS_NAME_COMPLETION)) {
          final String shortcut=getShortcut(IdeActions.ACTION_CLASS_NAME_COMPLETION);
          if (shortcut != null) {
            return CompletionBundle.message("completion.class.name.hint.2",shortcut);
          }
        }
      }
      if (parameters.getCompletionType() != CompletionType.SMART && shouldSuggestSmartCompletion(parameters.getPosition())) {
        if (shouldShowFeature(parameters,CodeCompletionFeatures.EDITING_COMPLETION_SMARTTYPE_GENERAL)) {
          final String shortcut=getShortcut(IdeActions.ACTION_SMART_TYPE_COMPLETION);
          if (shortcut != null) {
            return CompletionBundle.message("completion.smart.hint",shortcut);
          }
        }
      }
      if (parameters.getCompletionType() != CompletionType.CLASS_NAME && shouldSuggestClassNameCompletion(parameters.getPosition())) {
        if (shouldShowFeature(parameters,CodeCompletionFeatures.EDITING_COMPLETION_CLASSNAME)) {
          final String shortcut=getShortcut(IdeActions.ACTION_CLASS_NAME_COMPLETION);
          if (shortcut != null) {
            return CompletionBundle.message("completion.class.name.hint",shortcut);
          }
        }
      }
      return null;
    }
    public String handleEmptyLookup(    @NotNull final CompletionParameters parameters,    final ProcessingContext context){
      final String ad=advertise(parameters,context);
      final String suffix=ad == null ? "" : "; " + StringUtil.decapitalize(ad);
      if (parameters.getCompletionType() == CompletionType.SMART) {
        final ExpectedTypeInfo[] expectedTypes=JavaCompletionUtil.getExpectedTypes(parameters);
        if (expectedTypes != null) {
          PsiType type=expectedTypes.length == 1 ? expectedTypes[0].getType() : null;
          if (type != null) {
            final PsiType deepComponentType=type.getDeepComponentType();
            if (deepComponentType instanceof PsiClassType) {
              if (((PsiClassType)deepComponentType).resolve() != null) {
                return CompletionBundle.message("completion.no.suggestions.of.type",type.getPresentableText()) + suffix;
              }
              return CompletionBundle.message("completion.unknown.type",type.getPresentableText()) + suffix;
            }
            if (!PsiType.NULL.equals(type)) {
              return CompletionBundle.message("completion.no.suggestions.of.type",type.getPresentableText()) + suffix;
            }
          }
        }
      }
      return LangBundle.message("completion.no.suggestions") + suffix;
    }
  }
);
  registrar.extend(CompletionType.BASIC,PlatformPatterns.psiElement().withParent(XmlPatterns.xmlAttributeValue().save(XML_ATTRIBUTE_VALUE)),new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext context,    @NotNull final CompletionResultSet<LookupElement> result){
      for (      final PsiReference reference : context.get(XML_ATTRIBUTE_VALUE).getReferences()) {
        if (reference instanceof JavaClassReference) {
          result.setSuccessorFilter(new AsyncConsumer<LookupElement>(){
            public void consume(            final LookupElement lookupElement){
              if (lookupElement.getTailType() == TailType.UNKNOWN) {
                lookupElement.setTailType(TailType.NONE);
              }
              result.addElement(lookupElement);
            }
          }
);
          return;
        }
      }
    }
  }
);
}
