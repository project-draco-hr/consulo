{
  registrar.extendBasicCompletion(psiElement(PsiIdentifier.class).andNot(INSIDE_TYPE_PARAMS_PATTERN).withParent(or(psiElement(PsiLocalVariable.class),psiElement(PsiParameter.class)))).withId(VARIABLE_NAME).dependingOn(LegacyCompletionContributor.LEGACY).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      final PsiFile file=parameters.getOriginalFile();
      final PsiElement lastElement=file.findElementAt(context.startOffset - 1);
      PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=CompletionUtil.getCompletionDataByElement(lastElement,file,context.startOffset);
      context.setPrefix(insertedElement,context.startOffset,completionData);
      result.setPrefixMatcher(context.getPrefix());
      Set<LookupItem> lookupSet=new THashSet<LookupItem>();
      final PsiVariable variable=(PsiVariable)parameters.getPosition().getParent();
      JavaCompletionUtil.completeLocalVariableName(lookupSet,result.getPrefixMatcher(),variable);
      result.addAllElements(lookupSet);
    }
  }
);
  registrar.extendBasicCompletion(psiElement(PsiIdentifier.class).withParent(PsiField.class)).withId(VARIABLE_NAME).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      final PsiFile file=parameters.getOriginalFile();
      final PsiElement lastElement=file.findElementAt(context.startOffset - 1);
      PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=CompletionUtil.getCompletionDataByElement(lastElement,file,context.startOffset);
      context.setPrefix(insertedElement,context.startOffset,completionData);
      result.setPrefixMatcher(context.getPrefix());
      Set<LookupItem> lookupSet=new THashSet<LookupItem>();
      final PsiVariable variable=(PsiVariable)parameters.getPosition().getParent();
      JavaCompletionUtil.completeFieldName(lookupSet,variable,result.getPrefixMatcher());
      JavaCompletionUtil.completeMethodName(lookupSet,variable,result.getPrefixMatcher());
      result.addAllElements(lookupSet);
    }
  }
);
  registrar.extendBasicCompletion(PsiJavaPatterns.psiElement().nameIdentifierOf(PsiJavaPatterns.psiMethod().withParent(PsiClass.class))).withId(METHOD_NAME).dependingOn(LegacyCompletionContributor.LEGACY).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      final PsiFile file=parameters.getOriginalFile();
      final PsiElement lastElement=file.findElementAt(context.startOffset - 1);
      PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=CompletionUtil.getCompletionDataByElement(lastElement,file,context.startOffset);
      context.setPrefix(insertedElement,context.startOffset,completionData);
      result.setPrefixMatcher(context.getPrefix());
      Set<LookupItem> lookupSet=new THashSet<LookupItem>();
      JavaCompletionUtil.completeMethodName(lookupSet,parameters.getPosition().getParent(),result.getPrefixMatcher());
      result.addAllElements(lookupSet);
    }
  }
);
  registrar.extendBasicCompletion(psiElement()).dependingOn(LegacyCompletionContributor.LEGACY,VARIABLE_NAME,METHOD_NAME).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext context,    @NotNull final CompletionResultSet<LookupElement> result){
      result.processResults(new Processor<LookupElement>(){
        public boolean process(        final LookupElement lookupElement){
          LookupItem item=(LookupItem)lookupElement;
          CompletionUtil.highlightMemberOfContainer(item);
          if (item.getInsertHandler() != null)           return true;
          item.setAttribute(LookupItem.INSERT_HANDLER_ATTR,new InsertHandler(){
            public void handleInsert(            final CompletionContext context,            final int startOffset,            final LookupData data,            final LookupItem item,            final boolean signatureSelected,            final char completionChar){
              analyzeItem(context,item,item.getObject(),parameters.getPosition());
              new DefaultInsertHandler().handleInsert(context,startOffset,data,item,signatureSelected,completionChar);
            }
          }
);
          return true;
        }
      }
);
    }
  }
);
  registrar.extendSmartCompletion(psiElement()).withId(JAVA_LEGACY).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      final Set<LookupItem> set=new LinkedHashSet<LookupItem>();
      final PsiElement identifierCopy=parameters.getPosition();
      final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
      final CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      PsiFile file=parameters.getOriginalFile();
      final PsiReference ref=identifierCopy.getContainingFile().findReferenceAt(identifierCopy.getTextRange().getStartOffset());
      if (ref != null) {
        SMART_DATA.completeReference(ref,set,identifierCopy,result.getPrefixMatcher(),file,context.offset);
      }
      SMART_DATA.addKeywordVariants(keywordVariants,identifierCopy,file);
      CompletionData.completeKeywordsBySet(set,keywordVariants,identifierCopy,result.getPrefixMatcher(),file);
      CompletionUtil.highlightMembersOfContainer(set);
      result.addAllElements(set);
    }
  }
);
  registrar.extendClassNameCompletion(PlatformPatterns.psiElement()).withId(JAVA_LEGACY).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet<LookupElement> result){
      CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      final PsiFile file=parameters.getOriginalFile();
      PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=CLASS_NAME_DATA;
      context.setPrefix(insertedElement,context.startOffset,completionData);
      result.setPrefixMatcher(context.getPrefix());
      final Set<LookupItem> lookupSet=new LinkedHashSet<LookupItem>();
      final PsiReference ref=insertedElement.getContainingFile().findReferenceAt(context.offset);
      if (ref != null) {
        completionData.completeReference(ref,lookupSet,insertedElement,result.getPrefixMatcher(),file,context.offset);
      }
      if (lookupSet.isEmpty() || !CodeInsightUtil.isAntFile(file)) {
        final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
        completionData.addKeywordVariants(keywordVariants,insertedElement,file);
        CompletionData.completeKeywordsBySet(lookupSet,keywordVariants,insertedElement,result.getPrefixMatcher(),file);
      }
      result.addAllElements(lookupSet);
    }
  }
);
}
