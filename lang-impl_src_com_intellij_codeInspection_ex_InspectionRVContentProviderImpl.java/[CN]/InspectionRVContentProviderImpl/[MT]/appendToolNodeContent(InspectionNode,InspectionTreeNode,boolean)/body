{
  final InspectionTool tool=toolNode.getTool();
  final boolean runWithEditorProfile=tool.getContext().RUN_WITH_EDITOR_PROFILE;
  final Map<RefEntity,CommonProblemDescriptor[]> problems=tool instanceof DescriptorProviderInspection ? ((DescriptorProviderInspection)tool).getProblemElements() : null;
  Function<RefEntity,UserObjectContainer<RefEntity>> computeContainer=new Function<RefEntity,UserObjectContainer<RefEntity>>(){
    public UserObjectContainer<RefEntity> fun(    final RefEntity refElement){
      return new RefElementContainer(refElement,problems != null ? problems.get(refElement) : null);
    }
  }
;
  final Map<String,Set<RefEntity>> contents=tool.getPackageContent();
  final Set<RefModule> moduleProblems=tool.getModuleProblems();
  if (moduleProblems != null) {
    Set<RefEntity> entities=contents.get("");
    if (entities == null) {
      entities=new HashSet<RefEntity>();
      contents.put("",entities);
    }
    entities.addAll(moduleProblems);
  }
  List<InspectionTreeNode> list=buildTree(contents,false,tool,computeContainer,showStructure);
  for (  InspectionTreeNode node : list) {
    merge(node,toolNode,runWithEditorProfile);
  }
  if (tool.isOldProblemsIncluded()) {
    final Map<RefEntity,CommonProblemDescriptor[]> oldProblems=tool instanceof DescriptorProviderInspection ? ((DescriptorProviderInspection)tool).getOldProblemElements() : null;
    computeContainer=new Function<RefEntity,UserObjectContainer<RefEntity>>(){
      public UserObjectContainer<RefEntity> fun(      final RefEntity refElement){
        return new RefElementContainer(refElement,oldProblems != null ? oldProblems.get(refElement) : null);
      }
    }
;
    list=buildTree(tool.getOldPackageContent(),true,tool,computeContainer,showStructure);
    for (    InspectionTreeNode node : list) {
      merge(node,toolNode,true);
    }
  }
  merge(toolNode,parentNode,runWithEditorProfile);
}
