{
  int page;
  RefCountingStorage contentStorage=getContentStorage();
  final boolean fixedSize;
  try {
    w.lock();
    incModCount(myFileId);
    checkFileIsValid(myFileId);
    if (weHaveContentHashes) {
      page=findOrCreateContentRecord(bytes.getBytes(),bytes.getOffset(),bytes.getLength());
      incModCount(myFileId);
      checkFileIsValid(myFileId);
      setContentRecordId(myFileId,page > 0 ? page : -page);
      if (page < 0)       return;
      fixedSize=true;
    }
 else {
      page=getContentRecordId(myFileId);
      if (page == 0 || contentStorage.getRefCount(page) > 1) {
        page=contentStorage.acquireNewRecord();
        setContentRecordId(myFileId,page);
      }
      fixedSize=myFixedSize;
    }
  }
  finally {
    w.unlock();
  }
  contentStorage.writeBytes(page,bytes,fixedSize);
}
