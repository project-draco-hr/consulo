{
  int page;
  RefCountingStorage contentStorage=getContentStorage();
  final boolean fixedSize;
  w.lock();
  try {
    incModCount(myFileId);
    checkFileIsValid(myFileId);
    if (weHaveContentHashes) {
      page=findOrCreateContentRecord(bytes.getBytes(),bytes.getOffset(),bytes.getLength());
      incModCount(myFileId);
      checkFileIsValid(myFileId);
      setContentRecordId(myFileId,page > 0 ? page : -page);
      if (page > 0)       return;
      page=-page;
      fixedSize=true;
    }
 else {
      page=getContentRecordId(myFileId);
      if (page == 0 || contentStorage.getRefCount(page) > 1) {
        page=contentStorage.acquireNewRecord();
        setContentRecordId(myFileId,page);
      }
      fixedSize=myFixedSize;
    }
  }
  finally {
    w.unlock();
  }
  if (useSnappyForCompression) {
    BufferExposingByteArrayOutputStream out=new BufferExposingByteArrayOutputStream();
    DataOutputStream outputStream=new DataOutputStream(out);
    byte[] rawBytes=bytes.getBytes();
    if (bytes.getOffset() != 0) {
      rawBytes=new byte[bytes.getLength()];
      System.arraycopy(bytes.getBytes(),bytes.getOffset(),rawBytes,0,bytes.getLength());
    }
    CompressionUtil.writeCompressed(outputStream,rawBytes,bytes.getLength());
    outputStream.close();
    bytes=new ByteSequence(out.getInternalBuffer(),0,out.size());
  }
  contentStorage.writeBytes(page,bytes,fixedSize);
}
