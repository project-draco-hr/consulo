{
  w.lock();
  try {
    int recordId;
    if (weHaveContentHashes) {
      recordId=findOrCreateContentRecord(bytes,0,bytes.length);
      if (recordId > 0)       return recordId;
      recordId=-recordId;
    }
 else {
      recordId=getContentStorage().acquireNewRecord();
    }
    AbstractStorage.StorageDataOutput output=getContentStorage().writeStream(recordId,true);
    output.write(bytes);
    output.close();
    return recordId;
  }
 catch (  IOException e) {
    throw DbConnection.handleError(e);
  }
 finally {
    w.unlock();
  }
}
