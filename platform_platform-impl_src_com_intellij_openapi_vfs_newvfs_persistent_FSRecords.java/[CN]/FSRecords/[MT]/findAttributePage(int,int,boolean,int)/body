{
  if (fileId <= 0) {
    throw DbConnection.handleError(new AssertionError("assert fileId > 0 failed"));
  }
  if ((getFlags(fileId) & FREE_RECORD_FLAG) != 0) {
    throw DbConnection.handleError(new AssertionError("Trying to find an attribute of deleted page"));
  }
  int attrsRecord=getAttributeRecordId(fileId,attributeId);
  AbstractStorage storage=getAttributes(attributeId);
  if (attrsRecord == 0) {
    if (!createIfNotFound)     return 0;
    attrsRecord=storage.createNewRecord(16 * 8);
    getRecords().putInt(getAttrOffset(fileId,attributeId),attrsRecord);
  }
 else {
    final DataInputStream attrRefs=storage.readStream(attrsRecord);
    try {
      int offset=4;
      while (attrRefs.available() > 0) {
        final int attIdOnPage=attrRefs.readInt();
        if (attrRefs.available() < 4) {
          LOG.error("bad");
        }
        final int attAddress=attrRefs.readInt();
        if (attIdOnPage == attributeId) {
          if (capacity > 0) {
            int newAddress=storage.ensureCapacity(attAddress,capacity);
            if (newAddress == attAddress) {
              return attAddress;
            }
            ((CompactStorage)storage).replaceIntInData(attrsRecord + offset,newAddress,attAddress);
            return newAddress;
          }
 else {
            return attAddress;
          }
        }
        offset+=8;
      }
    }
  finally {
      attrRefs.close();
    }
  }
  if (createIfNotFound) {
    Storage.AppenderStream appender=storage.appendStream(attrsRecord);
    appender.writeInt(attributeId);
    int attAddress=storage.createNewRecord(capacity);
    appender.writeInt(attAddress);
    appender.close();
    if (appender.getRecordId() != attrsRecord) {
      getRecords().putInt(getAttrOffset(fileId,attributeId),appender.getRecordId());
    }
    return attAddress;
  }
  return 0;
}
