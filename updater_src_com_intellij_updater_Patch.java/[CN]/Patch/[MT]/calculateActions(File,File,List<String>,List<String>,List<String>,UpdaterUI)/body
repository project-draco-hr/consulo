{
  DiffCalculator.Result diff;
  ui.startProcess("Calculating difference...");
  ui.checkCancelled();
  diff=DiffCalculator.calculate(Digester.digestFiles(olderDir,ignoredFiles,ui),Digester.digestFiles(newerDir,ignoredFiles,ui));
  List<PatchAction> tempActions=new ArrayList<PatchAction>();
  for (  Map.Entry<String,Long> each : diff.filesToDelete.entrySet()) {
    tempActions.add(new DeleteAction(each.getKey(),each.getValue()));
  }
  for (  String each : diff.filesToCreate) {
    tempActions.add(new CreateAction(each));
  }
  for (  Map.Entry<String,Long> each : diff.filesToUpdate.entrySet()) {
    if (Utils.isZipFile(each.getKey())) {
      tempActions.add(new UpdateZipAction(each.getKey(),each.getValue()));
    }
 else {
      tempActions.add(new UpdateAction(each.getKey(),each.getValue()));
    }
  }
  ui.startProcess("Preparing actions...");
  ui.checkCancelled();
  for (  PatchAction each : tempActions) {
    ui.setStatus(each.getPath());
    ui.checkCancelled();
    if (!each.calculate(olderDir,newerDir))     continue;
    myActions.add(each);
    each.setCritical(criticalFiles.contains(each.getPath()));
    each.setOptional(optionalFiles.contains(each.getPath()));
  }
}
