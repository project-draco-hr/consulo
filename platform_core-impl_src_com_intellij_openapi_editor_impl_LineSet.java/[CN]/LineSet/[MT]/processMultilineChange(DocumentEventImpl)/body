{
  int offset=e.getOffset();
  CharSequence newString=e.getNewFragment();
  CharSequence chars=e.getDocument().getCharsSequence();
  int oldStartLine=e.getStartOldIndex();
  int offset1=getLineStart(oldStartLine);
  if (offset1 != offset) {
    CharSequence prefix=chars.subSequence(offset1,offset);
    newString=new MergingCharSequence(prefix,newString);
  }
  int oldEndLine=findLineIndex(e.getOffset() + e.getOldLength());
  if (oldEndLine < 0) {
    oldEndLine=getLineCount() - 1;
  }
  int offset2=getLineEnd(oldEndLine);
  if (offset2 != offset + e.getOldLength()) {
    final int start=offset + e.getNewLength();
    final int length=offset2 - offset - e.getOldLength();
    CharSequence postfix=chars.subSequence(start,start + length);
    newString=new MergingCharSequence(newString,postfix);
  }
  updateSegments(newString,oldStartLine,oldEndLine,offset1,e);
  addEmptyLineAtEnd();
}
