{
  TypedLookupItem typed=typedFrom(element);
  if (typed != null) {
    return typed.getType();
  }
  final PsiType qualifierType=getPsiType(element.getObject());
  final LookupItem lookupItem=LookupItem.from(element);
  if (lookupItem != null) {
    final Object o=lookupItem.getAttribute(LookupItem.TYPE);
    if (o instanceof PsiType) {
      return (PsiType)o;
    }
    final PsiSubstitutor substitutor=(PsiSubstitutor)lookupItem.getAttribute(LookupItem.SUBSTITUTOR);
    if (substitutor != null) {
      return substitutor.substitute(qualifierType);
    }
  }
  return qualifierType;
}
