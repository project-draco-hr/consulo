{
  final Editor editor=context.getEditor();
  final char completionChar=context.getCompletionChar();
  final PsiFile file=context.getFile();
  final TailType tailType=completionChar == '(' ? TailType.NONE : completionChar == ':' ? TailType.COND_EXPR_COLON : LookupItem.handleCompletionChar(context.getEditor(),item,completionChar);
  final boolean hasTail=tailType != TailType.NONE && tailType != TailType.UNKNOWN;
  final boolean smart=completionChar == Lookup.COMPLETE_STATEMENT_SELECT_CHAR;
  if (completionChar == '(' || completionChar == '.' || completionChar == ',' || completionChar == ';' || completionChar == ':' || completionChar == ' ') {
    context.setAddCompletionChar(false);
  }
  final boolean needRightParenth=forceClosingParenthesis || !smart && (CodeInsightSettings.getInstance().AUTOINSERT_PAIR_BRACKET || hasTail);
  if (hasTail) {
    hasParams=false;
  }
  PsiDocumentManager.getInstance(context.getProject()).commitDocument(context.getDocument());
  final CommonCodeStyleSettings styleSettings=context.getCodeStyleSettings();
  ParenthesesInsertHandler.getInstance(hasParams,styleSettings.SPACE_BEFORE_METHOD_CALL_PARENTHESES,styleSettings.SPACE_WITHIN_METHOD_CALL_PARENTHESES && hasParams,needRightParenth,styleSettings.METHOD_PARAMETERS_LPAREN_ON_NEXT_LINE).handleInsert(context,item);
  if (hasParams) {
    AutoPopupController.getInstance(file.getProject()).autoPopupParameterInfo(editor,overloadsMatter ? null : (PsiElement)item.getObject());
  }
  if (smart || needRightParenth) {
    TailType toInsert=tailType;
    LookupItem lookupItem=item.as(LookupItem.CLASS_CONDITION_KEY);
    if (lookupItem == null || lookupItem.getAttribute(LookupItem.TAIL_TYPE_ATTR) != TailType.UNKNOWN) {
      if (!hasTail && item.getObject() instanceof PsiMethod && ((PsiMethod)item.getObject()).getReturnType() == PsiType.VOID) {
        PsiDocumentManager.getInstance(file.getProject()).commitAllDocuments();
        if (psiElement().beforeLeaf(psiElement().withText(".")).accepts(file.findElementAt(context.getTailOffset() - 1))) {
          return;
        }
        toInsert=TailType.SEMICOLON;
      }
    }
    toInsert.processTail(editor,context.getTailOffset());
    if (completionChar == '.') {
      AutoPopupController.getInstance(file.getProject()).autoPopupMemberLookup(context.getEditor(),null);
    }
 else     if (completionChar == ',') {
      AutoPopupController.getInstance(file.getProject()).autoPopupParameterInfo(context.getEditor(),null);
    }
  }
}
