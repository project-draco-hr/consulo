{
  validateContext();
  removeBlockSelection();
  Document doc=myEditor.getDocument();
  if (!(startOffset >= 0 && startOffset <= doc.getTextLength() && endOffset >= 0 && endOffset <= doc.getTextLength())) {
    LOG.assertTrue(startOffset >= 0 && startOffset <= doc.getTextLength(),"Wrong startOffset: " + startOffset);
    LOG.assertTrue(endOffset >= 0 && endOffset <= doc.getTextLength(),"Wrong endOffset: " + endOffset);
  }
  myLastSelectionStart=startOffset;
  if (startOffset == endOffset) {
    removeSelection();
    return;
  }
  if (startOffset > endOffset) {
    int tmp=startOffset;
    startOffset=endOffset;
    endOffset=tmp;
  }
{
    Clipboard clip=myEditor.getComponent().getToolkit().getSystemSelection();
    if (clip != null) {
      clip.setContents(new StringSelection(getSelectedText()),defaultClipboardOwner);
    }
  }
  int oldSelectionStart;
  int oldSelectionEnd;
  if (hasSelection()) {
    oldSelectionStart=mySelectionMarker.getStartOffset();
    oldSelectionEnd=mySelectionMarker.getEndOffset();
    if (oldSelectionStart == startOffset && oldSelectionEnd == endOffset)     return;
  }
 else {
    oldSelectionStart=oldSelectionEnd=myEditor.getCaretModel().getOffset();
  }
  if (mySelectionMarker != null) {
    mySelectionMarker.release();
  }
  mySelectionMarker=new MyRangeMarker(doc,startOffset,endOffset);
  fireSelectionChanged(oldSelectionStart,oldSelectionEnd,startOffset,endOffset);
}
