{
  File templateFile;
synchronized (this) {
    if (!myModified && !myRenamed) {
      return;
    }
    if (myRenamed) {
      LOG.assertTrue(myTemplateFile != null);
      LOG.assertTrue(myTemplateFile.delete());
      myTemplateFile=null;
      myRenamed=false;
    }
    templateFile=myReadOnly ? null : myTemplateFile;
    if (templateFile == null) {
      LOG.assertTrue(defaultDir.isDirectory());
      templateFile=new File(defaultDir,myName + "." + myExtension);
    }
  }
  FileOutputStream fileOutputStream=new FileOutputStream(templateFile);
  OutputStreamWriter outputStreamWriter;
  try {
    outputStreamWriter=new OutputStreamWriter(fileOutputStream,ourEncoding);
  }
 catch (  UnsupportedEncodingException e) {
    Messages.showMessageDialog(IdeBundle.message("error.unable.to.save.file.template.using.encoding",getName(),ourEncoding),CommonBundle.getErrorTitle(),Messages.getErrorIcon());
    outputStreamWriter=new OutputStreamWriter(fileOutputStream);
  }
  String content=getContent();
  Project project=ProjectManagerEx.getInstanceEx().getDefaultProject();
  String lineSeparator=CodeStyleSettingsManager.getSettings(project).getLineSeparator();
  if (!lineSeparator.equals("\n")) {
    content=StringUtil.convertLineSeparators(content,lineSeparator);
  }
  outputStreamWriter.write(content);
  outputStreamWriter.close();
  fileOutputStream.close();
synchronized (this) {
    myModified=false;
    myTemplateFile=templateFile;
  }
}
