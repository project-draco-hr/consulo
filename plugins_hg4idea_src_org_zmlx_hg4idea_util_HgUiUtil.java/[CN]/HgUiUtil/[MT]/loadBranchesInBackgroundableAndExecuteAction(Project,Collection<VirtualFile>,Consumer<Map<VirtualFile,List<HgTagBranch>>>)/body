{
  final Map<VirtualFile,List<HgTagBranch>> branchesForRepos=new HashMap<VirtualFile,List<HgTagBranch>>();
  new Task.Backgroundable(project,"Collecting information..."){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      for (      final VirtualFile repo : repos) {
        HgCommandResult result=new HgTagBranchCommand(project,repo).collectBranches();
        if (result == null) {
          indicator.cancel();
          return;
        }
        branchesForRepos.put(repo,HgTagBranchCommand.parseResult(result));
      }
    }
    @Override public void onCancel(){
      new HgCommandResultNotifier(project).notifyError(null,"Mercurial command failed",HgVcsMessages.message("hg4idea.branches.error.description"));
    }
    @Override public void onSuccess(){
      successHandler.consume(branchesForRepos);
    }
  }
.queue();
}
