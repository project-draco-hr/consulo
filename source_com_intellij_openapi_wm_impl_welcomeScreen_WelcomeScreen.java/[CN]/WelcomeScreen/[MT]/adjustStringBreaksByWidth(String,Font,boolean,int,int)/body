{
  String modifiedString=string.trim();
  if (StringUtil.isEmpty(modifiedString)) {
    return "<html>Not specified</html>";
  }
  Rectangle2D r=font.getStringBounds(string,new FontRenderContext(new AffineTransform(),isAntiAliased,false));
  if (r.getWidth() > maxWidth) {
    String prefix="";
    String suffix=string.trim();
    int maxIdxPerLine=(int)(maxWidth / r.getWidth() * string.length());
    int lengthLeft=string.length();
    int rows=maxRows;
    if (rows <= 0) {
      rows=string.length() / maxIdxPerLine + 1;
    }
    while (lengthLeft > maxIdxPerLine && rows > 1) {
      int i;
      for (i=maxIdxPerLine; i > 0; i--) {
        if (suffix.charAt(i) == ' ') {
          prefix+=suffix.substring(0,i) + "<br>";
          suffix=suffix.substring(i + 1,suffix.length());
          lengthLeft=suffix.length();
          if (maxRows > 0) {
            rows--;
          }
 else {
            rows=lengthLeft / maxIdxPerLine + 1;
          }
          break;
        }
      }
      if (i == 0) {
        if (rows > 1 && maxRows <= 0) {
          prefix+=suffix.substring(0,maxIdxPerLine) + "<br>";
          suffix=suffix.substring(maxIdxPerLine,suffix.length());
          lengthLeft=suffix.length();
          rows--;
        }
 else {
          break;
        }
      }
    }
    if (suffix.length() > maxIdxPerLine) {
      suffix=suffix.substring(0,maxIdxPerLine - 3) + "...";
    }
    modifiedString=prefix + suffix;
  }
  return "<html>" + modifiedString + "</html>";
}
