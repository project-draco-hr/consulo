def getchanges(self, rev):
    copies = {}
    changes = []
    man = None
    for elt in self.changes[rev].find('summary').getchildren():
        if (elt.tag in ('add_directory', 'remove_directory')):
            continue
        if (elt.tag == 'move'):
            if (man is None):
                man = self.manifest()
            (source, dest) = (elt.get('from'), elt.get('to'))
            if (source in man):
                changes.append((source, rev))
                changes.append((dest, rev))
                copies[dest] = source
            else:
                source = (source + '/')
                for f in man:
                    if (not f.startswith(source)):
                        continue
                    fdest = ((dest + '/') + f[len(source):])
                    changes.append((f, rev))
                    changes.append((fdest, rev))
                    copies[fdest] = f
        else:
            changes.append((elt.text.strip(), rev))
    self.pull(rev)
    self.lastrev = rev
    return (sorted(changes), copies)
