{
  String typeId=libraryElement.getAttributeValue("type");
  final JpsLibraryPropertiesLoader<?> loader=getLibraryPropertiesLoader(typeId);
  JpsLibrary library=createLibrary(name,loader,libraryElement.getChild("properties"));
  MultiMap<JpsOrderRootType,String> jarDirectories=new MultiMap<JpsOrderRootType,String>();
  MultiMap<JpsOrderRootType,String> recursiveJarDirectories=new MultiMap<JpsOrderRootType,String>();
  for (  Element jarDirectory : JDOMUtil.getChildren(libraryElement,"jarDirectory")) {
    String url=jarDirectory.getAttributeValue("url");
    String rootTypeId=jarDirectory.getAttributeValue("type");
    final JpsOrderRootType rootType=rootTypeId != null ? getRootType(rootTypeId) : JpsOrderRootType.COMPILED;
    boolean recursive=Boolean.parseBoolean(jarDirectory.getAttributeValue("recursive"));
    jarDirectories.putValue(rootType,url);
    if (recursive) {
      recursiveJarDirectories.putValue(rootType,url);
    }
  }
  for (  Element rootsElement : JDOMUtil.getChildren(libraryElement)) {
    final String rootTypeId=rootsElement.getName();
    if (!rootTypeId.equals("jarDirectory")) {
      final JpsOrderRootType rootType=getRootType(rootTypeId);
      for (      Element rootElement : JDOMUtil.getChildren(rootsElement,"root")) {
        String url=rootElement.getAttributeValue("url");
        JpsLibraryRoot.InclusionOptions options;
        if (jarDirectories.get(rootType).contains(url)) {
          final boolean recursive=recursiveJarDirectories.get(rootType).contains(url);
          options=recursive ? JpsLibraryRoot.InclusionOptions.ARCHIVES_UNDER_ROOT_RECURSIVELY : JpsLibraryRoot.InclusionOptions.ARCHIVES_UNDER_ROOT;
        }
 else {
          options=JpsLibraryRoot.InclusionOptions.ROOT_ITSELF;
        }
        library.addRoot(url,rootType,options);
      }
    }
  }
  return library;
}
