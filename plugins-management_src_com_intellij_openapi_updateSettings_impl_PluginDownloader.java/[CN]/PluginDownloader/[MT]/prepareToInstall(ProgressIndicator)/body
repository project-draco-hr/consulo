{
  IdeaPluginDescriptor ideaPluginDescriptor=null;
  if (PluginManager.isPluginInstalled(PluginId.getId(myPluginId))) {
    ideaPluginDescriptor=PluginManager.getPlugin(PluginId.getId(myPluginId));
    LOG.assertTrue(ideaPluginDescriptor != null);
    if (myPluginVersion != null && IdeaPluginDescriptorImpl.compareVersion(ideaPluginDescriptor.getVersion(),myPluginVersion) >= 0)     return false;
    myOldFile=ideaPluginDescriptor.getPath();
  }
  String errorMessage=IdeBundle.message("unknown.error");
  try {
    myFile=downloadPlugin(pi);
  }
 catch (  IOException ex) {
    myFile=null;
    errorMessage=ex.getMessage();
  }
  if (myFile == null) {
    final String errorMessage1=errorMessage;
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        Messages.showErrorDialog(IdeBundle.message("error.plugin.was.not.installed",getPluginName(),errorMessage1),IdeBundle.message("title.failed.to.download"));
      }
    }
);
    return false;
  }
  if (ideaPluginDescriptor != null) {
    final IdeaPluginDescriptorImpl descriptor=PluginManager.loadDescriptorFromJar(myFile);
    if (descriptor == null)     return false;
    if (IdeaPluginDescriptorImpl.compareVersion(ideaPluginDescriptor.getVersion(),descriptor.getVersion()) >= 0)     return false;
  }
  return true;
}
