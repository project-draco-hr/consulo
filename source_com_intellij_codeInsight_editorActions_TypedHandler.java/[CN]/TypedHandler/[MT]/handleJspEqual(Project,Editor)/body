{
  final CharSequence chars=editor.getDocument().getCharsSequence();
  int current=editor.getCaretModel().getOffset();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  JspFile file=(JspFile)PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  PsiElement element=file.findElementAt(current);
  if (element == null) {
    element=file.findElementAt(editor.getDocument().getTextLength() - 1);
    if (element == null)     return;
  }
  if (current >= 3 && chars.charAt(current - 3) == '<' && chars.charAt(current - 2) == '%') {
    while (element instanceof PsiWhiteSpace) {
      element=element.getNextSibling();
    }
    JspExpression expression=PsiTreeUtil.getParentOfType(element,JspExpression.class);
    if (expression != null) {
      int ptr=current;
      while (ptr < chars.length() && Character.isWhitespace(chars.charAt(ptr)))       ++ptr;
      if (ptr + 1 < chars.length() && (chars.charAt(ptr) == '%' && chars.charAt(ptr + 1) == '>')) {
      }
 else {
        editor.getDocument().insertString(current,"%>");
      }
    }
  }
}
