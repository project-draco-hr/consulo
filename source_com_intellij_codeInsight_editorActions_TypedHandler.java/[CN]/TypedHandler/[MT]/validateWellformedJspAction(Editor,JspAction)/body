{
  JspToken actionEnd=JspUtil.getTokenOfType(tag,JspTokenType.JSP_EMPTY_ACTION_END);
  if (actionEnd != null)   return false;
  int tagOffset=tag.getTextRange().getStartOffset();
  HighlighterIterator iterator=((EditorEx)editor).getHighlighter().createIterator(tagOffset);
  if (BraceMatchingUtil.matchBrace(editor.getDocument().getCharsSequence(),StdFileTypes.JSP,iterator,true)) {
    final PsiElement[] elements=tag.getChildren();
    if (elements.length > 2 && elements[0] instanceof JspToken && ((JspToken)elements[0]).getTokenType() == JspTokenType.JSP_ACTION_START && elements[1] instanceof JspToken && ((JspToken)elements[1]).getTokenType() == JspTokenType.JSP_ACTION_NAME) {
      int nextPtr=2;
      if (elements.length > nextPtr && elements[nextPtr] instanceof JspToken && ((JspToken)elements[nextPtr]).getTokenType() == JspTokenType.JSP_ACTION_WHITE_SPACE) {
        nextPtr++;
      }
      while (elements.length > nextPtr && elements[nextPtr] instanceof JspAttribute) {
        nextPtr++;
        if (elements.length > nextPtr && elements[nextPtr] instanceof JspToken && ((JspToken)elements[nextPtr]).getTokenType() == JspTokenType.JSP_ACTION_WHITE_SPACE) {
          nextPtr++;
        }
      }
      if (nextPtr < elements.length && elements[nextPtr].getText().equals("<")) {
        editor.getDocument().insertString(editor.getCaretModel().getOffset(),"</" + elements[0].getText().substring(1) + elements[1].getText()+ ">");
      }
    }
    return false;
  }
  PsiElement element=tag.findElementAt(editor.getCaretModel().getOffset() - tag.getStartOffsetInParent());
  if (element != null) {
    element=element.getNextSibling();
    if (element instanceof JspToken && ((JspToken)element).getTokenType() == JspTokenType.JSP_BAD_CHARACTER && element.getText().equals("<")) {
      element=element.getNextSibling();
      if (element instanceof JspToken && ((JspToken)element).getTokenType() == JspTokenType.JSP_BAD_CHARACTER && element.getText().equals("/")) {
        element=element.getNextSibling();
        if (element instanceof JspToken && ((JspToken)element).getTokenType() == JspTokenType.JSP_ACTION_ATTRIBUTE_NAME && element.getText().equals(tag.getQualifiedName())) {
          return false;
        }
      }
    }
  }
  return true;
}
