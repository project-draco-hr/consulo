{
  myInitialMouseEvent=e;
  if (myMouseSelectionState != MOUSE_SELECTION_STATE_NONE && System.currentTimeMillis() - myMouseSelectionChangeTimestamp > Registry.intValue("editor.mouseSelectionStateResetTimeout")) {
    resetMouseSelectionState(e);
  }
  int x=e.getX();
  int y=e.getY();
  if (x < 0)   x=0;
  if (y < 0)   y=0;
  final EditorMouseEventArea eventArea=getMouseEventArea(e);
  myMousePressArea=eventArea;
  boolean isNavigation=false;
  if (eventArea == EditorMouseEventArea.FOLDING_OUTLINE_AREA) {
    final FoldRegion range=myGutterComponent.findFoldingAnchorAt(x,y);
    if (range != null) {
      final boolean expansion=!range.isExpanded();
      int scrollShift=y - getScrollingModel().getVerticalScrollOffset();
      Runnable processor=new Runnable(){
        @Override public void run(){
          myFoldingModel.flushCaretShift();
          range.setExpanded(expansion);
        }
      }
;
      getFoldingModel().runBatchFoldingOperation(processor);
      y=myGutterComponent.getHeadCenterY(range);
      getScrollingModel().scrollVertically(y - scrollShift);
      myGutterComponent.updateSize();
      return isNavigation;
    }
  }
  if (e.getSource() == myGutterComponent) {
    if (eventArea == EditorMouseEventArea.LINE_MARKERS_AREA || eventArea == EditorMouseEventArea.ANNOTATIONS_AREA || eventArea == EditorMouseEventArea.LINE_NUMBERS_AREA) {
      if (tweakSelectionIfNecessary(e)) {
        mySelectionTweaked=true;
      }
 else {
        myGutterComponent.mousePressed(e);
      }
      if (e.isConsumed())       return isNavigation;
    }
    x=0;
  }
  int oldSelectionStart=mySelectionModel.getLeadSelectionOffset();
  final int oldStart=mySelectionModel.getSelectionStart();
  final int oldEnd=mySelectionModel.getSelectionEnd();
  moveCaretToScreenPos(x,y);
  if (e.isPopupTrigger())   return isNavigation;
  requestFocus();
  int caretOffset=getCaretModel().getOffset();
  int newStart=mySelectionModel.getSelectionStart();
  int newEnd=mySelectionModel.getSelectionEnd();
  if (oldStart != newStart && oldEnd != newEnd) {
    if (oldStart == oldEnd && newStart == newEnd) {
      isNavigation=true;
    }
  }
  myMouseSelectedRegion=myFoldingModel.getFoldingPlaceholderAt(new Point(x,y));
  myMousePressedInsideSelection=mySelectionModel.hasSelection() && caretOffset >= mySelectionModel.getSelectionStart() && caretOffset <= mySelectionModel.getSelectionEnd();
  if (!myMousePressedInsideSelection && mySelectionModel.hasBlockSelection()) {
    int[] starts=mySelectionModel.getBlockSelectionStarts();
    int[] ends=mySelectionModel.getBlockSelectionEnds();
    for (int i=0; i < starts.length; i++) {
      if (caretOffset >= starts[i] && caretOffset < ends[i]) {
        myMousePressedInsideSelection=true;
        break;
      }
    }
  }
  if (getMouseEventArea(e) == EditorMouseEventArea.LINE_NUMBERS_AREA && e.getClickCount() == 1) {
    mySelectionModel.selectLineAtCaret();
    setMouseSelectionState(MOUSE_SELECTION_STATE_LINE_SELECTED);
    mySavedSelectionStart=mySelectionModel.getSelectionStart();
    mySavedSelectionEnd=mySelectionModel.getSelectionEnd();
    return isNavigation;
  }
  if (e.isShiftDown() && !e.isControlDown() && !e.isAltDown()) {
    if (getMouseSelectionState() != MOUSE_SELECTION_STATE_NONE) {
      if (caretOffset < mySavedSelectionStart) {
        mySelectionModel.setSelection(mySavedSelectionEnd,caretOffset);
      }
 else {
        mySelectionModel.setSelection(mySavedSelectionStart,caretOffset);
      }
    }
 else {
      int startToUse=oldSelectionStart;
      int endToUse=caretOffset;
      if (mySelectionModel.isUnknownDirection() && caretOffset > startToUse) {
        startToUse=Math.min(oldStart,oldEnd);
      }
      mySelectionModel.setSelection(startToUse,endToUse);
    }
  }
 else {
    if (!myMousePressedInsideSelection && (getSelectionModel().hasSelection() || getSelectionModel().hasBlockSelection())) {
      setMouseSelectionState(MOUSE_SELECTION_STATE_NONE);
      mySelectionModel.setSelection(caretOffset,caretOffset);
    }
 else {
      if (!e.isPopupTrigger()) {
switch (e.getClickCount()) {
case 2:
          selectWordAtCaret(mySettings.isMouseClickSelectionHonorsCamelWords() && mySettings.isCamelWords());
        break;
case 3:
      if (HONOR_CAMEL_HUMPS_ON_TRIPLE_CLICK && mySettings.isCamelWords()) {
        selectWordAtCaret(false);
        break;
      }
case 4:
    mySelectionModel.selectLineAtCaret();
  setMouseSelectionState(MOUSE_SELECTION_STATE_LINE_SELECTED);
mySavedSelectionStart=mySelectionModel.getSelectionStart();
mySavedSelectionEnd=mySelectionModel.getSelectionEnd();
mySelectionModel.setUnknownDirection(true);
break;
}
}
}
}
return isNavigation;
}
