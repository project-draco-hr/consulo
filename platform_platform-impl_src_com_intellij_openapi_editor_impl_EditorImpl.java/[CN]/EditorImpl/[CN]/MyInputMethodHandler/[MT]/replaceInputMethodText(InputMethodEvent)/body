{
  int commitCount=e.getCommittedCharacterCount();
  AttributedCharacterIterator text=e.getText();
  final Document doc=getDocument();
  if (composedText != null) {
    if (!isViewer() && doc.isWritable()) {
      runUndoTransparent(new Runnable(){
        @Override public void run(){
          int docLength=doc.getTextLength();
          ProperTextRange range=composedTextRange.intersection(new TextRange(0,docLength));
          doc.deleteString(range.getStartOffset(),range.getEndOffset());
        }
      }
);
    }
    composedText=null;
  }
  if (text != null) {
    text.first();
    if (commitCount > 0) {
      for (char c=text.current(); commitCount > 0; c=text.next(), commitCount--) {
        if (c >= 0x20 && c != 0x7F) {
          processKeyTyped(c);
        }
      }
    }
    if (!isViewer() && doc.isWritable()) {
      int composedTextIndex=text.getIndex();
      if (composedTextIndex < text.getEndIndex()) {
        createComposedString(composedTextIndex,text);
        runUndoTransparent(new Runnable(){
          @Override public void run(){
            EditorModificationUtil.insertStringAtCaret(EditorImpl.this,composedText,false,false);
          }
        }
);
        composedTextRange=ProperTextRange.from(getCaretModel().getOffset(),composedText.length());
      }
    }
  }
}
