{
  if (SwingUtilities.isRightMouseButton(e)) {
    return;
  }
  Rectangle visibleArea=getScrollingModel().getVisibleArea();
  int x=e.getX();
  if (e.getSource() == myGutterComponent) {
    x=0;
  }
  int dx=0;
  if (x < visibleArea.x && visibleArea.x > 0) {
    dx=x - visibleArea.x;
  }
 else {
    if (x > visibleArea.x + visibleArea.width) {
      dx=x - visibleArea.x - visibleArea.width;
    }
  }
  int dy=0;
  int y=e.getY();
  if (y < visibleArea.y && visibleArea.y > 0) {
    dy=y - visibleArea.y;
  }
 else {
    if (y > visibleArea.y + visibleArea.height) {
      dy=y - visibleArea.y - visibleArea.height;
    }
  }
  if (dx == 0 && dy == 0) {
    myScrollingTimer.stop();
    SelectionModel selectionModel=getSelectionModel();
    int oldSelectionStart=selectionModel.getLeadSelectionOffset();
    int oldCaretOffset=getCaretModel().getOffset();
    LogicalPosition oldLogicalCaret=getCaretModel().getLogicalPosition();
    moveCaretToScreenPos(x,y);
    getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    int newCaretOffset=getCaretModel().getOffset();
    int caretShift=newCaretOffset - mySavedSelectionStart;
    if (myMousePressedEvent != null && getMouseEventArea(myMousePressedEvent) != EditorMouseEventArea.EDITING_AREA && getMouseEventArea(myMousePressedEvent) != EditorMouseEventArea.LINE_NUMBERS_AREA) {
      selectionModel.setSelection(oldSelectionStart,newCaretOffset);
    }
 else {
      if (isColumnMode() || e.isAltDown()) {
        final LogicalPosition blockStart=selectionModel.hasBlockSelection() ? selectionModel.getBlockStart() : oldLogicalCaret;
        selectionModel.setBlockSelection(blockStart,getCaretModel().getLogicalPosition());
      }
 else {
        if (getMouseSelectionState() != MOUSE_SELECTION_STATE_NONE) {
          if (caretShift < 0) {
            int newSelection=newCaretOffset;
            if (getMouseSelectionState() == MOUSE_SELECTION_STATE_WORD_SELECTED) {
              newSelection=mySelectionModel.getWordAtCaretStart();
            }
 else {
              if (getMouseSelectionState() == MOUSE_SELECTION_STATE_LINE_SELECTED) {
                newSelection=logicalPositionToOffset(visualToLogicalPosition(new VisualPosition(getCaretModel().getVisualPosition().line,0)));
              }
            }
            if (newSelection < 0)             newSelection=newCaretOffset;
            selectionModel.setSelection(mySavedSelectionEnd,newSelection);
            getCaretModel().moveToOffset(newSelection);
          }
 else {
            int newSelection=newCaretOffset;
            if (getMouseSelectionState() == MOUSE_SELECTION_STATE_WORD_SELECTED) {
              newSelection=mySelectionModel.getWordAtCaretEnd();
            }
 else {
              if (getMouseSelectionState() == MOUSE_SELECTION_STATE_LINE_SELECTED) {
                newSelection=logicalPositionToOffset(visualToLogicalPosition(new VisualPosition(getCaretModel().getVisualPosition().line + 1,0)));
              }
            }
            if (newSelection < 0)             newSelection=newCaretOffset;
            selectionModel.setSelection(mySavedSelectionStart,newSelection);
            getCaretModel().moveToOffset(newSelection);
          }
          return;
        }
        if (!myMousePressedInsideSelection) {
          selectionModel.setSelection(oldSelectionStart,newCaretOffset);
        }
 else {
          if (caretShift != 0) {
            if (myMousePressedEvent != null) {
              if (mySettings.isDndEnabled()) {
                boolean isCopy=UIUtil.isControlKeyDown(e) || isViewer() || !getDocument().isWritable();
                mySavedCaretOffsetForDNDUndoHack=oldCaretOffset;
                getContentComponent().getTransferHandler().exportAsDrag(getContentComponent(),e,isCopy ? TransferHandler.COPY : TransferHandler.MOVE);
              }
 else {
                selectionModel.removeSelection();
              }
              myMousePressedEvent=null;
            }
          }
        }
      }
    }
  }
 else {
    myScrollingTimer.start(dx,dy);
  }
}
