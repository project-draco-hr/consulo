{
  int line=yPositionToVisibleLineNumber(p.y);
  int px=p.x;
  if (line == 0 && myPrefixText != null) {
    for (    char c : myPrefixText) {
      px-=EditorUtil.charWidth(c,myPrefixAttributes.getFontType(),this);
    }
  }
  int offset=logicalPositionToOffset(visualToLogicalPosition(new VisualPosition(line,0)));
  int textLength=myDocument.getTextLength();
  if (offset >= textLength)   return new VisualPosition(line,0);
  int column=0;
  int prevX=0;
  CharSequence text=myDocument.getCharsNoThreadCheck();
  char c=' ';
  IterationState state=new IterationState(this,offset,false);
  int fontType=state.getMergedAttributes().getFontType();
  int spaceSize=EditorUtil.getSpaceWidth(fontType,this);
  int x=0;
  outer:   while (true) {
    if (offset >= textLength)     break;
    if (offset >= state.getEndOffset()) {
      state.advance();
      fontType=state.getMergedAttributes().getFontType();
    }
    FoldRegion region=state.getCurrentFold();
    if (region != null) {
      char[] placeholder=region.getPlaceholderText().toCharArray();
      for (      char aPlaceholder : placeholder) {
        c=aPlaceholder;
        x+=EditorUtil.charWidth(c,fontType,this);
        if (x >= px)         break outer;
        column++;
      }
      offset=region.getEndOffset();
    }
 else {
      prevX=x;
      c=text.charAt(offset);
      if (c == '\n') {
        break;
      }
      if (c == '\t') {
        x=EditorUtil.nextTabStop(x,this);
      }
 else {
        x+=EditorUtil.charWidth(c,fontType,this);
      }
      if (x >= px)       break;
      if (c == '\t') {
        column+=(x - prevX) / spaceSize;
      }
 else {
        column++;
      }
      offset++;
    }
  }
  int charWidth=EditorUtil.charWidth(c,fontType,this);
  if (x >= px && c == '\t') {
    if (mySettings.isCaretInsideTabs()) {
      column+=(px - prevX) / spaceSize;
      if ((px - prevX) % spaceSize > spaceSize / 2)       column++;
    }
 else {
      if ((x - px) * 2 < x - prevX) {
        column+=(x - prevX) / spaceSize;
      }
    }
  }
 else {
    if (x >= px) {
      if ((x - px) * 2 < charWidth)       column++;
    }
 else {
      column+=(px - x) / EditorUtil.getSpaceWidth(fontType,this);
    }
  }
  return new VisualPosition(line,column);
}
