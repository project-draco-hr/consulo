{
  if (!segmentHighlighter.isAfterEndOfLine()) {
    return;
  }
  int startOffset=segmentHighlighter.getStartOffset();
  int visibleStartLine=offsetToVisualLine(startOffset);
  if (getFoldingModel().isOffsetCollapsed(startOffset)) {
    return;
  }
  if (visibleStartLine >= startLine && visibleStartLine <= endLine) {
    int logStartLine=offsetToLogicalLine(startOffset);
    if (logStartLine >= myDocument.getLineCount()) {
      return;
    }
    LogicalPosition logPosition=offsetToLogicalPosition(myDocument.getLineEndOffset(logStartLine));
    Point end=logicalPositionToXY(logPosition);
    int charWidth=EditorUtil.getSpaceWidth(Font.PLAIN,this);
    int lineHeight=getLineHeight();
    TextAttributes attributes=segmentHighlighter.getTextAttributes();
    if (attributes != null && getBackgroundColor(attributes) != null) {
      g.setColor(getBackgroundColor(attributes));
      g.fillRect(end.x,end.y,charWidth,lineHeight);
    }
    if (attributes != null && attributes.getEffectColor() != null) {
      int y=visibleLineToY(visibleStartLine) + getAscent() + 1;
      if (attributes.getEffectType() == EffectType.WAVE_UNDERSCORE) {
        EffectPainter.WAVE_UNDERSCORE.paint((Graphics2D)g,end.x,y - 1,charWidth - 1,getDescent(),attributes.getEffectColor());
      }
 else       if (attributes.getEffectType() == EffectType.BOLD_DOTTED_LINE) {
        g.setColor(getBackgroundColor(attributes));
        EffectPainter.BOLD_DOTTED_UNDERSCORE.paint((Graphics2D)g,end.x,y - 1,charWidth - 1,getDescent(),attributes.getEffectColor());
      }
 else       if (attributes.getEffectType() == EffectType.STRIKEOUT) {
        EffectPainter.STRIKE_THROUGH.paint((Graphics2D)g,end.x,y - 1,charWidth - 1,getCharHeight(),attributes.getEffectColor());
      }
 else       if (attributes.getEffectType() == EffectType.BOLD_LINE_UNDERSCORE) {
        EffectPainter.BOLD_LINE_UNDERSCORE.paint((Graphics2D)g,end.x,y - 1,charWidth - 1,getDescent(),attributes.getEffectColor());
      }
 else       if (attributes.getEffectType() != EffectType.BOXED) {
        EffectPainter.LINE_UNDERSCORE.paint((Graphics2D)g,end.x,y - 1,charWidth - 1,getDescent(),attributes.getEffectColor());
      }
    }
  }
}
