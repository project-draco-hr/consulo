{
  if (start >= end && getSoftWrapModel().getSoftWrap(start) == null) {
    return position.x;
  }
  int softWrapRetrievalEndOffset=end;
  if (start < end) {
    softWrapRetrievalEndOffset--;
  }
  outer:   for (  SoftWrap softWrap : getSoftWrapModel().getSoftWrapsForRange(start,softWrapRetrievalEndOffset)) {
    char[] softWrapChars=softWrap.getChars();
    CharArrayCharSequence softWrapSeq=new CharArrayCharSequence(softWrapChars);
    if (softWrap.getStart() == startDrawingOffset) {
      int i=CharArrayUtil.lastIndexOf(softWrapChars,'\n',0,softWrapChars.length);
      if (i < softWrapChars.length - 1) {
        position.x=0;
        position.x=drawString(g,softWrapSeq,i + 1,softWrapChars.length,position,clip,null,null,fontType,fontColor,context);
      }
      position.x+=mySoftWrapModel.paint(g,SoftWrapDrawingType.AFTER_SOFT_WRAP,position.x,position.y,getLineHeight());
      continue;
    }
    if (softWrap.getStart() > start) {
      position.x=drawString(g,text,start,softWrap.getStart(),position,clip,null,null,fontType,fontColor,context);
    }
    start=softWrap.getStart();
    int softWrapSegmentStartIndex=0;
    for (int i=0; i < softWrapChars.length; i++) {
      if (softWrapChars[i] != '\n') {
        continue;
      }
      if (i - softWrapSegmentStartIndex > 0) {
        drawString(g,softWrapSeq,softWrapSegmentStartIndex,i,position,clip,null,null,fontType,fontColor,context);
      }
      mySoftWrapModel.paint(g,SoftWrapDrawingType.BEFORE_SOFT_WRAP_LINE_FEED,position.x,position.y,getLineHeight());
      position.x=0;
      if (position.y > clip.y + clip.height) {
        break outer;
      }
      position.y+=getLineHeight();
      softWrapSegmentStartIndex=i + 1;
    }
    if (softWrapSegmentStartIndex < softWrapChars.length) {
      position.x+=drawString(g,softWrapSeq,softWrapSegmentStartIndex,softWrapChars.length,position,clip,null,null,fontType,fontColor,context);
    }
    position.x+=mySoftWrapModel.paint(g,SoftWrapDrawingType.AFTER_SOFT_WRAP,position.x,position.y,getLineHeight());
  }
  return position.x=drawString(g,text,start,end,position,clip,effectColor,effectType,fontType,fontColor,context);
}
