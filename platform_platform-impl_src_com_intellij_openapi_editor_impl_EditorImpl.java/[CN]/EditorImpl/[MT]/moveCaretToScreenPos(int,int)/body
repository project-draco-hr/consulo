{
  if (x < 0) {
    x=0;
  }
  LogicalPosition pos=xyToLogicalPosition(new Point(x,y));
  int columnNumber=pos.column;
  int lineNumber=pos.line;
  int softWrapLinesBeforeTargetLogicalLine=pos.softWrapLinesBeforeCurrentLogicalLine;
  int softWrapLinesOnTargetLogicalLine=pos.softWrapLinesOnCurrentLogicalLine;
  int softWrapColumns=pos.softWrapColumnDiff;
  if (lineNumber < 0) {
    lineNumber=0;
    columnNumber=0;
    softWrapLinesBeforeTargetLogicalLine=0;
    softWrapLinesOnTargetLogicalLine=0;
    softWrapColumns=0;
  }
  final int totalLines=myDocument.getLineCount();
  if (totalLines <= 0) {
    getCaretModel().moveToOffset(0);
    return;
  }
  if (lineNumber >= totalLines && totalLines > 0) {
    int visibleLineCount=getVisibleLineCount();
    int newY=visibleLineCount > 0 ? visibleLineNumberToYPosition(visibleLineCount - 1) : 0;
    if (newY > 0 && newY == y) {
      newY=visibleLineNumberToYPosition(getVisibleLogicalLinesCount());
    }
    moveCaretToScreenPos(x,newY);
    return;
  }
  if (!mySettings.isVirtualSpace() && !mySelectionModel.hasBlockSelection()) {
    int lineEndOffset=myDocument.getLineEndOffset(lineNumber);
    int lineEndColumnNumber=calcColumnNumber(lineEndOffset,lineNumber);
    if (columnNumber > lineEndColumnNumber) {
      columnNumber=lineEndColumnNumber;
      if (softWrapColumns != 0) {
        softWrapColumns-=columnNumber - lineEndColumnNumber;
      }
    }
  }
  if (!mySettings.isCaretInsideTabs()) {
    int offset=logicalPositionToOffset(new LogicalPosition(lineNumber,columnNumber));
    CharSequence text=myDocument.getCharsSequence();
    if (offset >= 0 && offset < myDocument.getTextLength()) {
      if (text.charAt(offset) == '\t') {
        columnNumber=calcColumnNumber(offset,lineNumber);
      }
    }
  }
  LogicalPosition pos1=new LogicalPosition(lineNumber,columnNumber,softWrapLinesBeforeTargetLogicalLine,softWrapLinesOnTargetLogicalLine,softWrapColumns,pos.foldedLines,pos.foldingColumnDiff);
  getCaretModel().moveToLogicalPosition(pos1);
}
