{
  int textLength=myDocument.getTextLength();
  if (textLength == 0)   return 0;
  if (offset > textLength || offset < 0) {
    throw new IndexOutOfBoundsException("Wrong offset: " + offset + " textLength: "+ textLength);
  }
  int lineIndex=myDocument.getLineNumber(offset);
  LOG.assertTrue(lineIndex >= 0 && lineIndex < myDocument.getLineCount());
  if (softWrapAware) {
    int column=calcColumnNumber(offset,lineIndex,false);
    return mySoftWrapModel.adjustLogicalPosition(new LogicalPosition(lineIndex,column),offset).line;
  }
 else {
    return lineIndex;
  }
}
