{
  startOptimizedScrolling();
  if (myUpdateCursor) {
    setCursorPosition();
    myUpdateCursor=false;
  }
  Rectangle clip=g.getClipBounds();
  if (clip == null) {
    return;
  }
  Rectangle visibleArea=getScrollingModel().getVisibleArea();
  if (visibleArea == null) {
    return;
  }
  if (isReleased) {
    g.setColor(new Color(128,255,128));
    g.fillRect(clip.x,clip.y,clip.width,clip.height);
    return;
  }
  if (myProject != null && myProject.isDisposed())   return;
  paintBackgrounds(g,clip);
  paintRectangularSelection(g);
  paintRightMargin(g,clip);
  paintCustomRenderers((Graphics2D)g,clip);
  final MarkupModel docMarkup=myDocument.getMarkupModel(myProject);
  paintLineMarkersSeparators(g,clip,docMarkup);
  paintLineMarkersSeparators(g,clip,myMarkupModel);
  paintText(g,clip);
  paintPlaceholderText(g,clip);
  paintSegmentHighlightersBorderAndAfterEndOfLine(g,clip);
  BorderEffect borderEffect=new BorderEffect(this,g);
  borderEffect.paintHighlighters(getHighlighter());
  borderEffect.paintHighlighters(docMarkup.getAllHighlighters());
  borderEffect.paintHighlighters(getMarkupModel().getAllHighlighters());
  paintCaretCursor(g);
  paintComposedTextDecoration((Graphics2D)g);
}
