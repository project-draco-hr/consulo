{
  CharSequence softWrapText=softWrap.getText();
  int activeRowY=getCaretModel().getVisualPosition().line * getLineHeight();
  int afterSoftWrapWidth=clip.x + clip.width - position.x;
  if (drawCustomBackgroundAtSoftWrapVirtualSpace && backColor != null) {
    drawBackground(g,backColor,afterSoftWrapWidth,position,defaultBackground,clip);
  }
 else   if (position.y == activeRowY) {
    Color caretRowColor=mySettings.isCaretRowShown() ? getColorsScheme().getColor(EditorColors.CARET_ROW_COLOR) : null;
    drawBackground(g,caretRowColor,afterSoftWrapWidth,position,defaultBackground,clip);
    caretRowPainted[0]=true;
  }
  paintSelectionOnFirstSoftWrapLineIfNecessary(g,position,clip,defaultBackground,fontType);
  int i=CharArrayUtil.lastIndexOf(softWrapText,"\n",softWrapText.length()) + 1;
  int width=getTextSegmentWidth(softWrapText,i,softWrapText.length(),0,fontType,clip) + getSoftWrapModel().getMinDrawingWidthInPixels(SoftWrapDrawingType.AFTER_SOFT_WRAP);
  position.x=0;
  position.y+=getLineHeight();
  if (drawCustomBackgroundAtSoftWrapVirtualSpace && backColor != null) {
    drawBackground(g,backColor,width,position,defaultBackground,clip);
  }
 else   if (position.y == activeRowY) {
    Color caretRowColor=mySettings.isCaretRowShown() ? getColorsScheme().getColor(EditorColors.CARET_ROW_COLOR) : null;
    drawBackground(g,caretRowColor,width,position,defaultBackground,clip);
  }
  position.x=0;
  paintSelectionOnSecondSoftWrapLineIfNecessary(g,position,clip,defaultBackground,fontType,softWrap);
  position.x=width;
}
