{
  if (myDocument.getLineCount() == 0) {
    return new VisualPosition(0,0);
  }
  if (x < 0) {
    x=0;
  }
  if (y < 0) {
    y=0;
  }
  int visualLineCount=getVisibleLineCount();
  if (yPositionToVisibleLine(y) >= visualLineCount) {
    y=visibleLineToY(Math.max(0,visualLineCount - 1));
  }
  VisualPosition visualPosition=xyToVisualPosition(new Point(x,y));
  if (trimToLineWidth && !mySettings.isVirtualSpace()) {
    LogicalPosition logicalPosition=visualToLogicalPosition(visualPosition);
    LogicalPosition lineEndPosition=offsetToLogicalPosition(myDocument.getLineEndOffset(logicalPosition.line));
    if (logicalPosition.column > lineEndPosition.column) {
      visualPosition=logicalToVisualPosition(lineEndPosition.leanForward(true));
    }
  }
  return visualPosition;
}
