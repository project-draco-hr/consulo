{
  int startToUse=start;
  int softWrapLinesToSkip=0;
  if (startDrawingLogicalPosition.get() != null) {
    softWrapLinesToSkip=startDrawingLogicalPosition.get().softWrapLinesOnCurrentLogicalLine;
  }
  SoftWrap lastSkippedSoftWrap=null;
  if (softWrapLinesToSkip > 0) {
    List<? extends SoftWrap> softWraps=getSoftWrapModel().getSoftWrapsForLine(startDrawingLogicalPosition.get().line);
    for (    SoftWrap softWrap : softWraps) {
      softWrapLinesToSkip--;
      if (softWrapLinesToSkip <= 0) {
        lastSkippedSoftWrap=softWrap;
        startToUse=softWrap.getStart();
        break;
      }
    }
  }
  startToUse=Math.max(startToUse,start);
  if (startToUse >= end && getSoftWrapModel().getSoftWrap(startToUse) == null) {
    return position.x;
  }
  startDrawingLogicalPosition.set(null);
  int softWrapRetrievalEndOffset=end;
  if (startToUse < end) {
    softWrapRetrievalEndOffset--;
  }
  outer:   for (  SoftWrap softWrap : getSoftWrapModel().getSoftWrapsForRange(startToUse,softWrapRetrievalEndOffset)) {
    char[] softWrapChars=softWrap.getChars();
    CharArrayCharSequence softWrapSeq=new CharArrayCharSequence(softWrapChars);
    if (softWrap.equals(lastSkippedSoftWrap)) {
      int i=CharArrayUtil.lastIndexOf(softWrapChars,'\n',0,softWrapChars.length);
      if (i < softWrapChars.length - 1) {
        position.x=0;
        position.x=drawString(g,softWrapSeq,i + 1,softWrapChars.length,position,clip,null,null,fontType,fontColor);
      }
      position.x+=mySoftWrapModel.paint(g,SoftWrapDrawingType.AFTER_SOFT_WRAP,position.x,position.y,getLineHeight());
      myForceRefreshFont=true;
      continue;
    }
    if (softWrap.getStart() > startToUse) {
      position.x=drawString(g,text,startToUse,softWrap.getStart(),position,clip,null,null,fontType,fontColor);
    }
    startToUse=softWrap.getStart();
    int softWrapSegmentStartIndex=0;
    for (int i=0; i < softWrapChars.length; i++) {
      if (softWrapChars[i] != '\n') {
        continue;
      }
      if (i - softWrapSegmentStartIndex > 0) {
        drawString(g,softWrapSeq,softWrapSegmentStartIndex,i,position,clip,null,null,fontType,fontColor);
      }
      mySoftWrapModel.paint(g,SoftWrapDrawingType.BEFORE_SOFT_WRAP_LINE_FEED,position.x,position.y,getLineHeight());
      myForceRefreshFont=true;
      position.x=0;
      if (position.y > clip.y + clip.height) {
        break outer;
      }
      position.y+=getLineHeight();
      softWrapSegmentStartIndex=i + 1;
    }
    if (softWrapSegmentStartIndex < softWrapChars.length) {
      position.x+=drawString(g,softWrapSeq,softWrapSegmentStartIndex,softWrapChars.length,position,clip,null,null,fontType,fontColor);
    }
    position.x+=mySoftWrapModel.paint(g,SoftWrapDrawingType.AFTER_SOFT_WRAP,position.x,position.y,getLineHeight());
    myForceRefreshFont=true;
  }
  return position.x=drawString(g,text,startToUse,end,position,clip,effectColor,effectType,fontType,fontColor);
}
