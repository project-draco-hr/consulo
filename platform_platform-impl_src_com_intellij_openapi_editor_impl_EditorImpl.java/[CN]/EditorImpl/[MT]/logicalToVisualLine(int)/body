{
  assertReadAccess();
  if (!myFoldingModel.isFoldingEnabled())   return line;
  int offset=line >= myDocument.getLineCount() ? myDocument.getTextLength() : myDocument.getLineStartOffset(line);
  FoldRegion outermostCollapsed=myFoldingModel.getCollapsedRegionAtOffset(offset);
  if (outermostCollapsed != null && offset > outermostCollapsed.getStartOffset()) {
    if (offset < getDocument().getTextLength()) {
      offset=outermostCollapsed.getStartOffset();
      return offsetToVisualLine(offset);
    }
 else {
      offset=outermostCollapsed.getEndOffset() + 3;
    }
  }
  line-=myFoldingModel.getFoldedLinesCountBefore(offset);
  return line;
}
