{
  IterationState state=new IterationState(this,start,start + offset,false);
  try {
    int fontType=state.getMergedAttributes().getFontType();
    int column=0;
    int x=0;
    int spaceSize=EditorUtil.getSpaceWidth(fontType,this);
    for (int i=start; i < offset; i++) {
      if (i >= state.getEndOffset()) {
        state.advance();
        fontType=state.getMergedAttributes().getFontType();
      }
      SoftWrap softWrap=getSoftWrapModel().getSoftWrap(i);
      if (softWrap != null) {
        column++;
        x=getSoftWrapModel().getMinDrawingWidthInPixels(SoftWrapDrawingType.AFTER_SOFT_WRAP);
      }
      char c=text.charAt(i);
      if (c == '\t') {
        int prevX=x;
        x=EditorUtil.nextTabStop(x,this);
        column+=EditorUtil.columnsNumber(c,x,prevX,spaceSize);
      }
 else {
        x+=EditorUtil.charWidth(c,fontType,this);
        column++;
      }
    }
    return column;
  }
  finally {
    state.dispose();
  }
}
