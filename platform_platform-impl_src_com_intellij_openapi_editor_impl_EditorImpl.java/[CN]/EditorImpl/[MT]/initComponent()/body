{
  myPanel.setLayout(new BorderLayout());
  myPanel.add(myHeaderPanel,BorderLayout.NORTH);
  myGutterComponent.setOpaque(true);
  myScrollPane.setVerticalScrollBar(myVerticalScrollBar);
  myScrollPane.setViewportView(myEditorComponent);
  myScrollPane.setVerticalScrollBarPolicy(ScrollPaneConstants.VERTICAL_SCROLLBAR_ALWAYS);
  myScrollPane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
  myScrollPane.setRowHeaderView(myGutterComponent);
  stopOptimizedScrolling();
  myEditorComponent.setTransferHandler(new MyTransferHandler());
  myEditorComponent.setAutoscrolls(true);
  if (mayShowToolbar()) {
    JLayeredPane layeredPane=new JLayeredPane(){
      @Override public void doLayout(){
        final Component[] components=getComponents();
        final Rectangle r=getBounds();
        for (        Component c : components) {
          if (c instanceof JScrollPane) {
            c.setBounds(0,0,r.width,r.height);
          }
 else {
            final Dimension d=c.getPreferredSize();
            final MyScrollBar scrollBar=getVerticalScrollBar();
            c.setBounds(r.width - d.width - scrollBar.getWidth()- 30,20,d.width,d.height);
          }
        }
      }
    }
;
    layeredPane.add(myScrollPane,JLayeredPane.DEFAULT_LAYER);
    myPanel.add(layeredPane);
    new ContextMenuImpl(layeredPane,myScrollPane,this);
  }
 else {
    myPanel.add(myScrollPane);
  }
  myEditorComponent.addKeyListener(new KeyAdapter(){
    @Override public void keyTyped(    @NotNull KeyEvent event){
      if (Patches.APPLE_BUG_ID_3337563)       return;
      if (event.isConsumed()) {
        return;
      }
      if (processKeyTyped(event)) {
        event.consume();
      }
    }
  }
);
  MyMouseAdapter mouseAdapter=new MyMouseAdapter();
  myEditorComponent.addMouseListener(mouseAdapter);
  myGutterComponent.addMouseListener(mouseAdapter);
  MyMouseMotionListener mouseMotionListener=new MyMouseMotionListener();
  myEditorComponent.addMouseMotionListener(mouseMotionListener);
  myGutterComponent.addMouseMotionListener(mouseMotionListener);
  myEditorComponent.addFocusListener(new FocusAdapter(){
    @Override public void focusGained(    FocusEvent e){
      myCaretCursor.activate();
      int caretLine=getCaretModel().getLogicalPosition().line;
      repaintLines(caretLine,caretLine);
      fireFocusGained();
      if (myGutterNeedsUpdate) {
        updateGutterSize();
      }
    }
    @Override public void focusLost(    FocusEvent e){
      clearCaretThread();
      int caretLine=getCaretModel().getLogicalPosition().line;
      repaintLines(caretLine,caretLine);
      fireFocusLost();
    }
  }
);
  try {
    final DropTarget dropTarget=myEditorComponent.getDropTarget();
    if (dropTarget != null) {
      dropTarget.addDropTargetListener(new DropTargetAdapter(){
        @Override public void drop(        DropTargetDropEvent e){
        }
        @Override public void dragOver(        @NotNull DropTargetDragEvent e){
          Point location=e.getLocation();
          moveCaretToScreenPos(location.x,location.y);
          getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
        }
      }
);
    }
  }
 catch (  TooManyListenersException e) {
    LOG.error(e);
  }
  myPanel.addComponentListener(new ComponentAdapter(){
    @Override public void componentResized(    ComponentEvent e){
      myMarkupModel.recalcEditorDimensions();
      myMarkupModel.repaint(-1,-1);
    }
  }
);
}
