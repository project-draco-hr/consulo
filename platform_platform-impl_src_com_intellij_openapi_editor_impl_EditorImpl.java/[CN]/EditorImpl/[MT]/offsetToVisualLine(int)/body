{
  int line=calcLogicalLineNumber(offset);
  int lineStartOffset=myDocument.getLineStartOffset(line);
  int result=logicalToVisualLine(line);
  int i=getSoftWrapModel().getSoftWrapIndex(lineStartOffset);
  if (i < 0) {
    i=-i - 1;
  }
  List<? extends SoftWrap> softWraps=getSoftWrapModel().getRegisteredSoftWraps();
  for (; i < softWraps.size(); i++) {
    SoftWrap softWrap=softWraps.get(i);
    if (softWrap.getStart() > offset) {
      break;
    }
    result++;
  }
  return result;
}
