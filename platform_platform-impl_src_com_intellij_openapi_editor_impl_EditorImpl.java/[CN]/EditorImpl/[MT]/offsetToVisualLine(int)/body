{
  int textLength=getDocument().getTextLength();
  if (offset >= textLength) {
    int result=Math.max(0,getVisibleLineCount() - 1);
    if (textLength > 0 && getDocument().getCharsSequence().charAt(textLength - 1) == '\n') {
      result++;
    }
    return result;
  }
  int line=offsetToLogicalLine(offset);
  int lineStartOffset=line >= myDocument.getLineCount() ? myDocument.getTextLength() : myDocument.getLineStartOffset(line);
  int result=logicalToVisualLine(line);
  int i=getSoftWrapModel().getSoftWrapIndex(lineStartOffset);
  if (i < 0) {
    i=-i - 1;
  }
  List<? extends SoftWrap> softWraps=getSoftWrapModel().getRegisteredSoftWraps();
  for (; i < softWraps.size(); i++) {
    SoftWrap softWrap=softWraps.get(i);
    if (softWrap.getStart() > offset) {
      break;
    }
    result++;
  }
  return result;
}
