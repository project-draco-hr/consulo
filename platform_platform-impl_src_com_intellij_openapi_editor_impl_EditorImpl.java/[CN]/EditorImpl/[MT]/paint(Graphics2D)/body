{
  Rectangle clip=g.getClipBounds();
  if (clip == null) {
    return;
  }
  if (Registry.is("editor.dumb.mode.available")) {
    final BufferedImage buffer=getUserData(BUFFER);
    if (buffer != null) {
      final Rectangle rect=getContentComponent().getVisibleRect();
      UIUtil.drawImage(g,buffer,null,rect.x,rect.y);
      return;
    }
  }
  startOptimizedScrolling();
  if (myUpdateCursor) {
    setCursorPosition();
    myUpdateCursor=false;
  }
  if (isReleased) {
    g.setColor(new Color(128,255,128));
    g.fillRect(clip.x,clip.y,clip.width,clip.height);
    return;
  }
  if (myProject != null && myProject.isDisposed())   return;
  VisualPosition clipStartVisualPos=xyToVisualPosition(new Point(0,clip.y));
  LogicalPosition clipStartPosition=visualToLogicalPosition(clipStartVisualPos);
  int clipStartOffset=logicalPositionToOffset(clipStartPosition);
  LogicalPosition clipEndPosition=xyToLogicalPosition(new Point(0,clip.y + clip.height + getLineHeight()));
  int clipEndOffset=logicalPositionToOffset(clipEndPosition);
  paintBackgrounds(g,clip,clipStartPosition,clipStartVisualPos,clipStartOffset,clipEndOffset);
  if (paintPlaceholderText(g,clip))   return;
  paintRectangularSelection(g);
  paintRightMargin(g,clip);
  paintCustomRenderers(g,clipStartOffset,clipEndOffset);
  MarkupModelEx docMarkup=(MarkupModelEx)DocumentMarkupModel.forDocument(myDocument,myProject,true);
  paintLineMarkersSeparators(g,clip,docMarkup,clipStartOffset,clipEndOffset);
  paintLineMarkersSeparators(g,clip,myMarkupModel,clipStartOffset,clipEndOffset);
  paintText(g,clip,clipStartPosition,clipStartOffset,clipEndOffset);
  paintSegmentHighlightersBorderAndAfterEndOfLine(g,clip,clipStartOffset,clipEndOffset,docMarkup);
  BorderEffect borderEffect=new BorderEffect(this,g,clipStartOffset,clipEndOffset);
  borderEffect.paintHighlighters(getHighlighter());
  borderEffect.paintHighlighters(docMarkup);
  borderEffect.paintHighlighters(myMarkupModel);
  paintCaretCursor(g);
  paintComposedTextDecoration(g);
}
