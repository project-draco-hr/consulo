{
  if (!CodeInsightUtil.prepareFileForWrite(file))   return;
  final CharSequence charsSequence=editor.getDocument().getCharsSequence();
  final Pair<String,Integer> p=getPrefix(editor,charsSequence);
  String currentPrefix=p.first;
  int startOffset=p.second.intValue();
  String oldPrefix=myFastWordCompletionAction.getOldPrefix();
  if (oldPrefix == null || !currentPrefix.startsWith(oldPrefix) || oldPrefix.length() == 0 || !currentPrefix.equals(myFastWordCompletionAction.getLastProposedVariant())) {
    oldPrefix=currentPrefix;
    myFastWordCompletionAction.setOldPrefix(oldPrefix);
  }
  Set variants=computeVariants(editor);
  for (Iterator i=variants.iterator(); i.hasNext(); ) {
    String s=(String)i.next();
    if (!s.startsWith(oldPrefix))     i.remove();
  }
  if (variants.isEmpty())   return;
  String nextVariant=(String)variants.iterator().next();
  for (Iterator i=variants.iterator(); i.hasNext(); ) {
    String s=(String)i.next();
    if (s.equals(currentPrefix)) {
      if (i.hasNext()) {
        nextVariant=(String)i.next();
        break;
      }
    }
  }
  editor.getDocument().replaceString(startOffset,startOffset + currentPrefix.length(),nextVariant);
  editor.getCaretModel().moveToOffset(startOffset + nextVariant.length());
  myFastWordCompletionAction.setLastProposedVariant(nextVariant);
}
