{
  myPreviouslyFocusedComponent=WindowManagerEx.getInstanceEx().getFocusedComponent(myProject);
  myActionListener=callback;
  myTextFieldPanel=new JPanelProvider();
  myTextFieldPanel.setLayout(new BoxLayout(myTextFieldPanel,BoxLayout.Y_AXIS));
  final JPanel hBox=new JPanel();
  hBox.setLayout(new BoxLayout(hBox,BoxLayout.X_AXIS));
  if (myModel.getPromptText() != null) {
    JLabel label=new JLabel(" " + myModel.getPromptText());
    label.setFont(UIUtil.getLabelFont().deriveFont(Font.BOLD));
    hBox.add(label);
  }
  myCard=new CardLayout();
  myCardContainer=new JPanel(myCard);
  final JPanel checkBoxPanel=new JPanel();
  checkBoxPanel.setBorder(BorderFactory.createEmptyBorder(0,0,0,5));
  myCheckBox=new JCheckBox(myModel.getCheckBoxName());
  myCheckBox.setSelected(myModel.loadInitialCheckBoxState());
  if (myModel.getPromptText() != null) {
    checkBoxPanel.setLayout(new BoxLayout(checkBoxPanel,BoxLayout.X_AXIS));
    checkBoxPanel.add(new JLabel("  ("));
    checkBoxPanel.add(myCheckBox);
    checkBoxPanel.add(new JLabel(")"));
  }
 else {
    checkBoxPanel.setLayout(new BoxLayout(checkBoxPanel,BoxLayout.LINE_AXIS));
    checkBoxPanel.setComponentOrientation(ComponentOrientation.RIGHT_TO_LEFT);
    checkBoxPanel.add(new JLabel(")"));
    checkBoxPanel.add(myCheckBox);
    checkBoxPanel.add(new JLabel("  ("));
  }
  checkBoxPanel.setVisible(myModel.getCheckBoxName() != null);
  JPanel panel=new JPanel(new BorderLayout());
  panel.add(checkBoxPanel,BorderLayout.CENTER);
  myCardContainer.add(panel,CHECK_BOX_CARD);
  myCardContainer.add(new JLabel("  (" + myModel.getNotInMessage() + ")"),NOT_FOUND_IN_PROJECT_CARD);
  myCardContainer.add(new JLabel("  " + IdeBundle.message("label.choosebyname.no.matches.found")),NOT_FOUND_CARD);
  myCardContainer.add(new JLabel("  " + IdeBundle.message("label.choosebyname.searching")),SEARCHING_CARD);
  myCard.show(myCardContainer,CHECK_BOX_CARD);
  if (isCheckboxVisible()) {
    hBox.add(myCardContainer);
  }
  if (myToolArea != null) {
    hBox.add(myToolArea);
  }
  myTextFieldPanel.add(hBox);
  myHistory=new ArrayList<Pair<String,Integer>>();
  myFuture=new ArrayList<Pair<String,Integer>>();
  myTextField=new MyTextField();
  myTextField.setText(myInitialText);
  final ActionMap actionMap=new ActionMap();
  actionMap.setParent(myTextField.getActionMap());
  actionMap.put(DefaultEditorKit.copyAction,new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      if (myTextField.getSelectedText() != null) {
        actionMap.getParent().get(DefaultEditorKit.copyAction).actionPerformed(e);
        return;
      }
      final Object chosenElement=getChosenElement();
      if (chosenElement instanceof PsiElement) {
        CopyReferenceAction.doCopy((PsiElement)chosenElement,myProject);
      }
    }
  }
);
  myTextField.setActionMap(actionMap);
  myTextFieldPanel.add(myTextField);
  EditorColorsScheme scheme=EditorColorsManager.getInstance().getGlobalScheme();
  Font editorFont=new Font(scheme.getEditorFontName(),Font.PLAIN,scheme.getEditorFontSize());
  myTextField.setFont(editorFont);
  if (isCloseByFocusLost()) {
    myTextField.addFocusListener(new FocusAdapter(){
      public void focusLost(      final FocusEvent e){
        myHideAlarm.addRequest(new Runnable(){
          public void run(){
            if (!JBPopupFactory.getInstance().isChildPopupFocused(e.getComponent())) {
              hideHint();
            }
          }
        }
,200);
      }
    }
);
  }
  myCheckBox.addItemListener(new ItemListener(){
    public void itemStateChanged(    ItemEvent e){
      rebuildList();
    }
  }
);
  myCheckBox.setFocusable(false);
  myTextField.getDocument().addDocumentListener(new DocumentAdapter(){
    protected void textChanged(    DocumentEvent e){
      clearPosponedOkAction(false);
      rebuildList();
    }
  }
);
  myTextField.addKeyListener(new KeyAdapter(){
    public void keyPressed(    KeyEvent e){
      if (!myListScrollPane.isVisible()) {
        return;
      }
      final int keyCode=e.getKeyCode();
switch (keyCode) {
case KeyEvent.VK_DOWN:
        ListScrollingUtil.moveDown(myList,e.getModifiersEx());
      break;
case KeyEvent.VK_UP:
    ListScrollingUtil.moveUp(myList,e.getModifiersEx());
  break;
case KeyEvent.VK_PAGE_UP:
ListScrollingUtil.movePageUp(myList);
break;
case KeyEvent.VK_PAGE_DOWN:
ListScrollingUtil.movePageDown(myList);
break;
case KeyEvent.VK_ENTER:
if (myTextField.getActionMap().get("notify-field-accept") == null) {
LOG.error("Text field has no action for 'notify-field-accept' input map entry");
for (Object o : myTextField.getActionMap().allKeys()) {
if (o instanceof String && ((String)o).contains("vim")) {
LOG.error("Text field action map contains ExEditorKit action: " + o);
}
}
}
if (myList.getSelectedValue() == EXTRA_ELEM) {
myMaximumListSizeLimit+=MAXIMUM_LIST_SIZE_LIMIT;
rebuildList(myList.getSelectedIndex(),REBUILD_DELAY,null,ModalityState.current());
e.consume();
}
break;
}
}
}
);
myTextField.addActionListener(new ActionListener(){
public void actionPerformed(ActionEvent actionEvent){
doClose(true);
}
}
);
myListModel=new DefaultListModel();
myList=new JList(myListModel);
myList.setFocusable(false);
myList.setSelectionMode(allowMultipleSelection ? ListSelectionModel.MULTIPLE_INTERVAL_SELECTION : ListSelectionModel.SINGLE_SELECTION);
myList.addMouseListener(new MouseAdapter(){
public void mouseClicked(MouseEvent e){
if (!myTextField.hasFocus()) {
myTextField.requestFocus();
}
if (e.getClickCount() == 2) {
if (myList.getSelectedValue() == EXTRA_ELEM) {
myMaximumListSizeLimit+=MAXIMUM_LIST_SIZE_LIMIT;
rebuildList(myList.getSelectedIndex(),REBUILD_DELAY,null,ModalityState.current());
e.consume();
}
 else {
doClose(true);
}
}
}
}
);
myList.setCellRenderer(myModel.getListCellRenderer());
myList.setFont(editorFont);
myList.addListSelectionListener(new ListSelectionListener(){
public void valueChanged(ListSelectionEvent e){
choosenElementMightChange();
updateDocumentation();
}
}
);
myListScrollPane=new JScrollPane(myList);
if (!UIUtil.isMotifLookAndFeel()) {
UIUtil.installPopupMenuBorder(myTextFieldPanel);
}
UIUtil.installPopupMenuColorAndFonts(myTextFieldPanel);
showTextFieldPanel();
if (modalityState != null) {
rebuildList(0,0,null,modalityState);
}
}
