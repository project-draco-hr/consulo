{
  ApplicationManager.getApplication().assertIsDispatchThread();
  myListIsUpToDate=false;
  myAlarm.cancelAllRequests();
  myListUpdater.cancelAll();
  cancelCalcElementsThread();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    @Override public void run(){
      final String text=myTextField.getText();
      if (!canShowListForEmptyPattern() && (text == null || text.trim().isEmpty())) {
        myListModel.clear();
        hideList();
        if (myTextFieldPanel != null)         myTextFieldPanel.hideHint();
        myCard.show(myCardContainer,CHECK_BOX_CARD);
        return;
      }
      final Runnable request=new Runnable(){
        @Override public void run(){
          final CalcElementsCallback callback=new CalcElementsCallback(){
            @Override public void run(            @NotNull final Set<?> elements){
synchronized (myRebuildMutex) {
                ApplicationManager.getApplication().assertIsDispatchThread();
                if (checkDisposed()) {
                  return;
                }
                myListIsUpToDate=true;
                setElementsToList(pos,elements);
                myList.repaint();
                choosenElementMightChange();
                if (elements.isEmpty() && myTextFieldPanel != null) {
                  myTextFieldPanel.hideHint();
                }
                if (postRunnable != null) {
                  postRunnable.run();
                }
              }
            }
          }
;
          cancelCalcElementsThread();
          final ListCellRenderer cellRenderer=myList.getCellRenderer();
          if (cellRenderer instanceof MatcherHolder) {
            final String pattern=transformPattern(text);
            final Matcher matcher=buildPatternMatcher(isSearchInAnyPlace() ? "*" + pattern + "*" : pattern);
            ((MatcherHolder)cellRenderer).setPatternMatcher(matcher);
          }
          myCalcElementsThread=new CalcElementsThread(text,myCheckBox.isSelected(),callback,modalityState,postRunnable == null);
          ApplicationManager.getApplication().executeOnPooledThread(myCalcElementsThread);
        }
      }
;
      if (delay > 0) {
        myAlarm.addRequest(request,delay,ModalityState.stateForComponent(myTextField));
      }
 else {
        request.run();
      }
    }
  }
,modalityState);
}
