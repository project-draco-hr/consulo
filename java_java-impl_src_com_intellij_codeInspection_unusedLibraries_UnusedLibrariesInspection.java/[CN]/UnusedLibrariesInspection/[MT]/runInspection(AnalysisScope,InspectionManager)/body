{
  final Project project=getContext().getProject();
  final ArrayList<VirtualFile> libraryRoots=new ArrayList<VirtualFile>();
  if (scope.getScopeType() == AnalysisScope.PROJECT) {
    ContainerUtil.addAll(libraryRoots,LibraryUtil.getLibraryRoots(project,false,false));
  }
 else {
    final Set<Module> modules=new HashSet<Module>();
    scope.accept(new PsiRecursiveElementVisitor(){
      @Override public void visitFile(      PsiFile file){
        if (!(file instanceof PsiCompiledElement)) {
          final VirtualFile virtualFile=file.getVirtualFile();
          if (virtualFile != null) {
            final Module module=ModuleUtil.findModuleForFile(virtualFile,project);
            if (module != null) {
              modules.add(module);
            }
          }
        }
      }
    }
);
    ContainerUtil.addAll(libraryRoots,LibraryUtil.getLibraryRoots(modules.toArray(new Module[modules.size()]),false,false));
  }
  if (libraryRoots.isEmpty()) {
    return;
  }
  GlobalSearchScope searchScope;
  try {
    @NonNls final String libsName="libs";
    searchScope=GlobalSearchScopes.filterScope(project,new NamedScope(libsName,PackageSetFactory.getInstance().compile("lib:*..*")));
  }
 catch (  ParsingException e) {
    LOG.error(e);
    return;
  }
  final AnalysisScope analysisScope=new AnalysisScope(searchScope,project);
  analysisScope.setSearchInLibraries(true);
  final BackwardDependenciesBuilder builder=new BackwardDependenciesBuilder(project,analysisScope);
  final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
  BACKWARD_ANALYSIS.setTotalAmount(builder.getTotalFileCount());
  ((ProgressManagerImpl)ProgressManager.getInstance()).executeProcessUnderProgress(new Runnable(){
    public void run(){
      builder.analyze();
    }
  }
,new ProgressIndicatorBase(){
    public void setFraction(    final double fraction){
      super.setFraction(fraction);
      int nextAmount=(int)(fraction * BACKWARD_ANALYSIS.getTotalAmount());
      if (nextAmount > BACKWARD_ANALYSIS.getDoneAmount() && nextAmount < BACKWARD_ANALYSIS.getTotalAmount()) {
        BACKWARD_ANALYSIS.setDoneAmount(nextAmount);
        getContext().incrementJobDoneAmount(BACKWARD_ANALYSIS,getText2());
      }
    }
    public boolean isCanceled(){
      return progressIndicator != null && progressIndicator.isCanceled() || super.isCanceled();
    }
  }
);
  BACKWARD_ANALYSIS.setDoneAmount(BACKWARD_ANALYSIS.getTotalAmount());
  final Map<PsiFile,Set<PsiFile>> dependencies=builder.getDependencies();
  for (  PsiFile file : dependencies.keySet()) {
    final VirtualFile virtualFile=file.getVirtualFile();
    LOG.assertTrue(virtualFile != null);
    for (Iterator<VirtualFile> i=libraryRoots.iterator(); i.hasNext(); ) {
      if (VfsUtil.isAncestor(i.next(),virtualFile,false)) {
        i.remove();
      }
    }
  }
  if (libraryRoots.isEmpty()) {
    return;
  }
  ProjectFileIndex projectIndex=ProjectRootManager.getInstance(project).getFileIndex();
  Map<OrderEntry,Set<VirtualFile>> unusedLibs=new HashMap<OrderEntry,Set<VirtualFile>>();
  for (  VirtualFile libraryRoot : libraryRoots) {
    final List<OrderEntry> orderEntries=projectIndex.getOrderEntriesForFile(libraryRoot);
    for (    OrderEntry orderEntry : orderEntries) {
      Set<VirtualFile> files=unusedLibs.get(orderEntry);
      if (files == null) {
        files=new HashSet<VirtualFile>();
        unusedLibs.put(orderEntry,files);
      }
      files.add(libraryRoot);
    }
  }
  final RefManager refManager=getRefManager();
  for (  OrderEntry orderEntry : unusedLibs.keySet()) {
    if (!(orderEntry instanceof LibraryOrderEntry))     continue;
    final RefModule refModule=refManager.getRefModule(orderEntry.getOwnerModule());
    final Set<VirtualFile> files=unusedLibs.get(orderEntry);
    final VirtualFile[] roots=((LibraryOrderEntry)orderEntry).getRootFiles(OrderRootType.CLASSES);
    if (files.size() < roots.length) {
      final String unusedLibraryRoots=StringUtil.join(files,new Function<VirtualFile,String>(){
        public String fun(        final VirtualFile file){
          return file.getPresentableName();
        }
      }
,",");
      String message=InspectionsBundle.message("unused.library.roots.problem.descriptor",unusedLibraryRoots,orderEntry.getPresentableName());
      addProblemElement(refModule,manager.createProblemDescriptor(message,new RemoveUnusedLibrary(refModule,orderEntry,files)));
    }
 else {
      String message=InspectionsBundle.message("unused.library.problem.descriptor",orderEntry.getPresentableName());
      addProblemElement(refModule,manager.createProblemDescriptor(message,new RemoveUnusedLibrary(refModule,orderEntry,null)));
    }
  }
}
