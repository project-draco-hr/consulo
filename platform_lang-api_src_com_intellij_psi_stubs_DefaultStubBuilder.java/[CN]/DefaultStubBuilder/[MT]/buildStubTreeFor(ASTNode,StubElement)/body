{
  StubElement stub=parentStub;
  IElementType nodeType=node.getElementType();
  if (nodeType instanceof IStubElementType) {
    final IStubElementType type=(IStubElementType)nodeType;
    if (type.shouldCreateStub(node)) {
      PsiElement element=node.getPsi();
      if (!(element instanceof StubBasedPsiElement)) {
        LOG.error("Non-StubBasedPsiElement requests stub creation. Stub type: " + type + ", PSI: "+ element);
      }
      stub=type.createStub(element,parentStub);
    }
  }
  for (ASTNode childNode=node.getFirstChildNode(); childNode != null; childNode=childNode.getTreeNext()) {
    if (!skipChildProcessingWhenBuildingStubs(node,childNode.getElementType())) {
      buildStubTreeFor(childNode,stub);
    }
  }
  return stub;
}
