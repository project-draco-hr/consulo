{
  root.accept(new PsiRecursiveElementWalkingVisitor(){
    @Override public void visitElement(    PsiElement element){
      StubElement parentStub=getParentStub(element,root,rootStub);
      StubElement stub=parentStub;
      if (element instanceof StubBasedPsiElement) {
        final IStubElementType type=((StubBasedPsiElement)element).getElementType();
        if (type.shouldCreateStub(element.getNode())) {
          stub=type.createStub(element,parentStub);
        }
      }
 else {
        final ASTNode node=element.getNode();
        final IElementType type=node == null ? null : node.getElementType();
        if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(node)) {
          LOG.error("Non-StubBasedPsiElement requests stub creation. Stub type: " + type + ", PSI: "+ element);
        }
      }
      setParentStubForChildrenOf(element,stub);
      super.visitElement(element);
    }
    @Override protected void elementFinished(    PsiElement element){
      setParentStubForChildrenOf(element,null);
    }
  }
);
  return rootStub;
}
