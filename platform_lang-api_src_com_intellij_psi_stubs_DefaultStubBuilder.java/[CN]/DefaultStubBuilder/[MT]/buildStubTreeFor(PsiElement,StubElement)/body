{
  ASTNode node;
  IElementType eltType;
  if (elt instanceof StubBasedPsiElement) {
    eltType=((StubBasedPsiElement)elt).getElementType();
    if (((IStubElementType)eltType).shouldCreateStub(elt.getNode())) {
      parentStub=((IStubElementType)eltType).createStub(elt,parentStub);
    }
  }
 else {
    node=elt.getNode();
    eltType=node == null ? null : node.getElementType();
    if (eltType instanceof IStubElementType && ((IStubElementType)eltType).shouldCreateStub(node)) {
      LOG.error("Non-StubBasedPsiElement requests stub creation. Stub type: " + eltType + ", PSI: "+ elt);
    }
  }
  for (elt=elt.getFirstChild(); elt != null; elt=elt.getNextSibling()) {
    node=elt.getNode();
    if (!skipChildProcessingWhenBuildingStubs(eltType,node != null ? node.getElementType() : null)) {
      buildStubTreeFor(elt,parentStub);
    }
  }
  return parentStub;
}
