{
  StubElement stub=parentStub;
  if (elt instanceof StubBasedPsiElement) {
    final IStubElementType type=((StubBasedPsiElement)elt).getElementType();
    if (type.shouldCreateStub(elt.getNode())) {
      stub=type.createStub(elt,parentStub);
    }
  }
  final PsiElement[] psiElements=elt.getChildren();
  for (  PsiElement child : psiElements) {
    buildStubTreeFor(child,stub);
  }
  return stub;
}
