{
  StubElement stub=parentStub;
  if (elt instanceof StubBasedPsiElement) {
    final IStubElementType type=((StubBasedPsiElement)elt).getElementType();
    if (type.shouldCreateStub(elt.getNode())) {
      stub=type.createStub(elt,parentStub);
    }
  }
 else {
    final ASTNode node=elt.getNode();
    final IElementType type=node == null ? null : node.getElementType();
    if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(node)) {
      LOG.error("Non-StubBasedPsiElement requests stub creation. Stub type: " + type + ", PSI: "+ elt);
    }
  }
  for (PsiElement child=elt.getFirstChild(); child != null; child=child.getNextSibling()) {
    if (!skipChildProcessingWhenBuildingStubs(elt,child)) {
      buildStubTreeFor(child,stub);
    }
  }
  return stub;
}
