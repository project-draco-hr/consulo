{
  StubElement stub=parentStub;
  if (elt instanceof StubBasedPsiElement) {
    final IStubElementType type=((StubBasedPsiElement)elt).getElementType();
    if (type.shouldCreateStub(elt.getNode())) {
      stub=type.createStub(elt,parentStub);
    }
  }
  for (PsiElement child=elt.getFirstChild(); child != null; child=child.getNextSibling()) {
    buildStubTreeFor(child,stub);
  }
  return stub;
}
