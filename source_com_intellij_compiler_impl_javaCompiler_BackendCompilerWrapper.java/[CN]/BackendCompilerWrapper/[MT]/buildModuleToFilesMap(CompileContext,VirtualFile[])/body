{
  final Map<Module,Set<VirtualFile>> map=new com.intellij.util.containers.HashMap<Module,Set<VirtualFile>>();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (int idx=0; idx < files.length; idx++) {
        VirtualFile file=files[idx];
        final Module module=context.getModuleByFile(file);
        if (module == null) {
          continue;
        }
        Set<VirtualFile> moduleFiles=map.get(module);
        if (moduleFiles == null) {
          moduleFiles=new HashSet<VirtualFile>();
          map.put(module,moduleFiles);
        }
        moduleFiles.add(file);
      }
    }
  }
);
  return map;
}
