{
  final Compiler[] transformers=CompilerManager.getInstance(myProject).getCompilers(JavaSourceTransformingCompiler.class);
  if (transformers.length == 0) {
    return;
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Running transforming compilers...");
  }
  final Module[] modules=chunk.getModules();
  for (int idx=0; idx < transformers.length; idx++) {
    final JavaSourceTransformingCompiler transformer=(JavaSourceTransformingCompiler)transformers[idx];
    final Map<VirtualFile,VirtualFile> originalToCopyFileMap=new HashMap<VirtualFile,VirtualFile>();
    final Application application=ApplicationManager.getApplication();
    application.invokeAndWait(new Runnable(){
      public void run(){
        for (int idx=0; idx < modules.length; idx++) {
          final Module module=modules[idx];
          VirtualFile[] filesToCompile=chunk.getFilesToCompile(module);
          for (int j=0; j < filesToCompile.length; j++) {
            final VirtualFile file=filesToCompile[j];
            if (transformer.isTransformable(file)) {
              application.runWriteAction(new Runnable(){
                public void run(){
                  try {
                    VirtualFile fileCopy=createFileCopy(getTempDir(module),file);
                    originalToCopyFileMap.put(file,fileCopy);
                  }
 catch (                  IOException e) {
                  }
                }
              }
);
            }
          }
        }
      }
    }
,myCompileContext.getProgressIndicator().getModalityState());
    for (int i=0; i < modules.length; i++) {
      final Module module=modules[i];
      final VirtualFile[] filesToCompile=chunk.getFilesToCompile(module);
      for (int j=0; j < filesToCompile.length; j++) {
        final VirtualFile file=filesToCompile[j];
        VirtualFile fileCopy=originalToCopyFileMap.get(file);
        if (fileCopy != null) {
          final boolean ok=transformer.transform(myCompileContext,fileCopy,file);
          if (ok) {
            filesToCompile[j]=fileCopy;
          }
        }
      }
    }
  }
}
