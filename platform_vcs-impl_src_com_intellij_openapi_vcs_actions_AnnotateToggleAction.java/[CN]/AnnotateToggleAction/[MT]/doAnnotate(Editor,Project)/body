{
  final VirtualFile file=FileDocumentManager.getInstance().getFile(editor.getDocument());
  if (project == null)   return;
  final ProjectLevelVcsManager plVcsManager=ProjectLevelVcsManager.getInstance(project);
  final AbstractVcs vcs=plVcsManager.getVcsFor(file);
  if (vcs == null)   return;
  final AnnotationProvider annotationProvider=vcs.getCachingAnnotationProvider();
  final Ref<FileAnnotation> fileAnnotationRef=new Ref<FileAnnotation>();
  final Ref<VcsException> exceptionRef=new Ref<VcsException>();
  final BackgroundableActionEnabledHandler handler=((ProjectLevelVcsManagerImpl)plVcsManager).getBackgroundableActionHandler(VcsBackgroundableActions.ANNOTATE);
  handler.register(file.getPath());
  final Task.Backgroundable annotateTask=new Task.Backgroundable(project,VcsBundle.message("retrieving.annotations"),true,BackgroundFromStartOption.getInstance()){
    public void run(    final @NotNull ProgressIndicator indicator){
      try {
        fileAnnotationRef.set(annotationProvider.annotate(file));
      }
 catch (      VcsException e) {
        exceptionRef.set(e);
      }
catch (      Throwable t) {
        handler.completed(file.getPath());
      }
    }
    @Override public void onCancel(){
      onSuccess();
    }
    @Override public void onSuccess(){
      handler.completed(file.getPath());
      if (!exceptionRef.isNull()) {
        AbstractVcsHelper.getInstance(project).showErrors(Arrays.asList(exceptionRef.get()),VcsBundle.message("message.title.annotate"));
      }
      if (!fileAnnotationRef.isNull()) {
        doAnnotate(editor,project,file,fileAnnotationRef.get(),vcs,true);
      }
    }
  }
;
  ProgressManager.getInstance().run(annotateTask);
}
