{
  if (AnnotateDiffViewerAction.isEnabled(e)) {
    AnnotateDiffViewerAction.perform(e);
    return;
  }
  final VcsContext context=VcsContextFactory.SERVICE.getInstance().createContextOn(e);
  Editor editor=context.getEditor();
  VirtualFile selectedFile=context.getSelectedFile();
  if (selectedFile == null)   return;
  Project project=context.getProject();
  if (project == null)   return;
  if (!selected) {
    for (    FileEditor fileEditor : FileEditorManager.getInstance(project).getEditors(selectedFile)) {
      if (fileEditor instanceof TextEditor) {
        ((TextEditor)fileEditor).getEditor().getGutter().closeAllAnnotations();
      }
    }
  }
 else {
    if (editor == null) {
      FileEditor[] fileEditors=FileEditorManager.getInstance(project).openFile(selectedFile,false);
      for (      FileEditor fileEditor : fileEditors) {
        if (fileEditor instanceof TextEditor) {
          editor=((TextEditor)fileEditor).getEditor();
        }
      }
    }
    LOG.assertTrue(editor != null);
    doAnnotate(editor,project);
  }
}
