{
  if (fileAnnotation.getFile() != null && fileAnnotation.getFile().isInLocalFileSystem()) {
    ProjectLevelVcsManager.getInstance(project).getAnnotationLocalChangesListener().registerAnnotation(fileAnnotation.getFile(),fileAnnotation);
  }
  editor.getGutter().closeAllAnnotations();
  fileAnnotation.setCloser(new Runnable(){
    @Override public void run(){
      if (project.isDisposed())       return;
      UIUtil.invokeLaterIfNeeded(new Runnable(){
        @Override public void run(){
          if (project.isDisposed())           return;
          editor.getGutter().closeAllAnnotations();
        }
      }
);
    }
  }
);
  final EditorGutterComponentEx editorGutter=(EditorGutterComponentEx)editor.getGutter();
  final List<AnnotationFieldGutter> gutters=new ArrayList<AnnotationFieldGutter>();
  final AnnotationSourceSwitcher switcher=fileAnnotation.getAnnotationSourceSwitcher();
  if (getUpToDateLineNumber == null)   getUpToDateLineNumber=new UpToDateLineNumberProviderImpl(editor.getDocument(),project);
  final AnnotationPresentation presentation=new AnnotationPresentation(fileAnnotation,getUpToDateLineNumber,switcher);
  if (currentFile != null && vcs.getCommittedChangesProvider() != null) {
    presentation.addAction(new ShowDiffFromAnnotation(fileAnnotation,vcs,currentFile));
  }
  presentation.addAction(new CopyRevisionNumberFromAnnotateAction(fileAnnotation));
  presentation.addAction(AnSeparator.getInstance());
  final Couple<Map<VcsRevisionNumber,Color>> bgColorMap=Registry.is("vcs.show.colored.annotations") ? computeBgColors(fileAnnotation) : null;
  final Map<VcsRevisionNumber,Integer> historyIds=Registry.is("vcs.show.history.numbers") ? computeLineNumbers(fileAnnotation) : null;
  if (switcher != null) {
    switcher.switchTo(switcher.getDefaultSource());
    final LineAnnotationAspect revisionAspect=switcher.getRevisionAspect();
    final CurrentRevisionAnnotationFieldGutter currentRevisionGutter=new CurrentRevisionAnnotationFieldGutter(fileAnnotation,revisionAspect,presentation,bgColorMap);
    final MergeSourceAvailableMarkerGutter mergeSourceGutter=new MergeSourceAvailableMarkerGutter(fileAnnotation,null,presentation,bgColorMap);
    SwitchAnnotationSourceAction switchAction=new SwitchAnnotationSourceAction(switcher,editorGutter);
    presentation.addAction(switchAction);
    switchAction.addSourceSwitchListener(currentRevisionGutter);
    switchAction.addSourceSwitchListener(mergeSourceGutter);
    currentRevisionGutter.consume(switcher.getDefaultSource());
    mergeSourceGutter.consume(switcher.getDefaultSource());
    gutters.add(currentRevisionGutter);
    gutters.add(mergeSourceGutter);
  }
  final LineAnnotationAspect[] aspects=fileAnnotation.getAspects();
  for (  LineAnnotationAspect aspect : aspects) {
    gutters.add(new AnnotationFieldGutter(fileAnnotation,aspect,presentation,bgColorMap));
  }
  if (historyIds != null) {
    gutters.add(new HistoryIdColumn(fileAnnotation,presentation,bgColorMap,historyIds));
  }
  gutters.add(new HighlightedAdditionalColumn(fileAnnotation,null,presentation,bgColorMap));
  final AnnotateActionGroup actionGroup=new AnnotateActionGroup(gutters,editorGutter);
  presentation.addAction(actionGroup,1);
  gutters.add(new ExtraFieldGutter(fileAnnotation,presentation,bgColorMap,actionGroup));
  presentation.addAction(new AnnotateCurrentRevisionAction(fileAnnotation,vcs));
  presentation.addAction(new AnnotatePreviousRevisionAction(fileAnnotation,vcs));
  addActionsFromExtensions(presentation,fileAnnotation);
  for (  AnnotationFieldGutter gutter : gutters) {
    final AnnotationGutterLineConvertorProxy proxy=new AnnotationGutterLineConvertorProxy(getUpToDateLineNumber,gutter);
    if (gutter.isGutterAction()) {
      editor.getGutter().registerTextAnnotation(proxy,proxy);
    }
 else {
      editor.getGutter().registerTextAnnotation(proxy);
    }
  }
}
