{
  StateMap fileToState=storageData.myStates.get(componentName);
  Object oldState=fileToState == null || fileName == null ? null : fileToState.get(fileName);
  if (fileName == null || newState == null || JDOMUtil.isEmpty(newState)) {
    if (fileName == null) {
      if (fileToState == null) {
        return null;
      }
    }
 else     if (oldState == null) {
      return null;
    }
    DirectoryStorageData newStorageData=storageData.clone();
    if (fileName == null) {
      newStorageData.myStates.remove(componentName);
    }
 else {
      StateMap clonedFileToState=newStorageData.myStates.get(componentName);
      if (clonedFileToState.size() == 1) {
        newStorageData.myStates.remove(componentName);
      }
 else {
        clonedFileToState.remove(fileName);
        if (clonedFileToState.isEmpty()) {
          newStorageData.myStates.remove(componentName);
        }
      }
    }
    return newStorageData;
  }
  byte[] newBytes=null;
  if (oldState instanceof Element) {
    if (JDOMUtil.areElementsEqual((Element)oldState,newState)) {
      return null;
    }
  }
 else   if (oldState != null) {
    newBytes=getNewByteIfDiffers(componentName,newState,(byte[])oldState);
    if (newBytes == null) {
      return null;
    }
  }
  DirectoryStorageData newStorageData=storageData.clone();
  newStorageData.put(componentName,fileName,newBytes == null ? newState : newBytes);
  return newStorageData;
}
