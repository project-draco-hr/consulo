{
  myUpdating.set(true);
  final JBLoadingPanel loadingPanel=getLoadingPanel();
  loadingPanel.startLoading();
  final Runnable action=new Runnable(){
    public void run(){
      try {
        updater=new Updater(loadingPanel,100);
        updater.start();
        myTree=new DTree(null,"",true);
        mySrc.refresh(userForcedRefresh);
        myTrg.refresh(userForcedRefresh);
        scan(mySrc,myTree,true);
        scan(myTrg,myTree,false);
      }
 catch (      final IOException e) {
        LOG.warn(e);
        reportException(VcsBundle.message("refresh.failed.message",StringUtil.decapitalize(e.getLocalizedMessage())));
      }
 finally {
        myTree.setSource(mySrc);
        myTree.setTarget(myTrg);
        myTree.update(mySettings);
        applySettings();
      }
    }
  }
;
  if (DirDiffManagerImpl.isFromModalDialog(myProject)) {
    action.run();
  }
 else {
    ApplicationManager.getApplication().executeOnPooledThread(action);
  }
}
