{
  final VirtualFile vFile=event.getFile();
  final String propertyName=event.getPropertyName();
  VirtualFile parent=vFile.getParent();
  final PsiDirectory parentDir=getCachedDirectory(parent);
  if (parent != null && parentDir == null)   return;
  ApplicationManager.getApplication().runWriteAction(new ExternalChangeAction(){
    @Override public void run(){
      PsiTreeChangeEventImpl treeEvent=new PsiTreeChangeEventImpl(myManager);
      treeEvent.setParent(parentDir);
      if (VirtualFile.PROP_NAME.equals(propertyName)) {
        final String newName=(String)event.getNewValue();
        if (parentDir == null)         return;
        if (vFile.isDirectory()) {
          PsiDirectory psiDir=myFileManager.findDirectory(vFile);
          if (psiDir != null) {
            if (!myFileTypeManager.isFileIgnored(newName)) {
              treeEvent.setChild(psiDir);
              treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_DIRECTORY_NAME);
              treeEvent.setOldValue(vFile.getName());
              treeEvent.setNewValue(newName);
              myManager.beforePropertyChange(treeEvent);
            }
 else {
              treeEvent.setChild(psiDir);
              myManager.beforeChildRemoval(treeEvent);
            }
          }
 else {
            if (!isExcludeRoot(vFile) && !myFileTypeManager.isFileIgnored(newName)) {
              myManager.beforeChildAddition(treeEvent);
            }
          }
        }
 else {
          final FileViewProvider viewProvider=myFileManager.findViewProvider(vFile);
          PsiFile psiFile=viewProvider.getPsi(viewProvider.getBaseLanguage());
          PsiFile psiFile1=createFileCopyWithNewName(vFile,newName);
          if (psiFile != null) {
            if (psiFile1 == null) {
              treeEvent.setChild(psiFile);
              myManager.beforeChildRemoval(treeEvent);
            }
 else             if (!psiFile1.getClass().equals(psiFile.getClass())) {
              treeEvent.setOldChild(psiFile);
              myManager.beforeChildReplacement(treeEvent);
            }
 else {
              treeEvent.setChild(psiFile);
              treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_FILE_NAME);
              treeEvent.setOldValue(vFile.getName());
              treeEvent.setNewValue(newName);
              myManager.beforePropertyChange(treeEvent);
            }
          }
 else {
            if (psiFile1 != null) {
              myManager.beforeChildAddition(treeEvent);
            }
          }
        }
      }
 else       if (VirtualFile.PROP_WRITABLE.equals(propertyName)) {
        PsiFile psiFile=myFileManager.getCachedPsiFileInner(vFile);
        if (psiFile == null)         return;
        treeEvent.setElement(psiFile);
        treeEvent.setPropertyName(PsiTreeChangeEvent.PROP_WRITABLE);
        treeEvent.setOldValue(event.getOldValue());
        treeEvent.setNewValue(event.getNewValue());
        myManager.beforePropertyChange(treeEvent);
      }
    }
  }
);
}
