{
  if (!CodeInsightUtil.prepareFileForWrite(file))   return;
  PsiReferenceExpression[] refs=CreateFromUsageUtils.collectExpressions(myRefExpr,true,PsiMember.class,PsiFile.class);
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    PsiElement element=PsiTreeUtil.getParentOfType(myRefExpr,PsiMember.class,PsiFile.class);
    LookupItem[] items=collectItems();
    ReferenceNameExpression refExpr=new ReferenceNameExpression(items,myRefExpr.getReferenceName());
    Document document=editor.getDocument();
    TemplateBuilder builder=new TemplateBuilder(element);
    for (    PsiReferenceExpression expr : refs) {
      if (!expr.equals(myRefExpr)) {
        builder.replaceElement(expr.getReferenceNameElement(),OTHER_VARIABLE_NAME,INPUT_VARIABLE_NAME,false);
      }
 else {
        builder.replaceElement(expr.getReferenceNameElement(),INPUT_VARIABLE_NAME,refExpr,true);
      }
    }
    final float proportion=EditorUtil.calcVerticalScrollProportion(editor);
    editor.getCaretModel().moveToOffset(element.getTextRange().getStartOffset());
    for (int i=refs.length - 1; i >= 0; i--) {
      TextRange range=refs[i].getReferenceNameElement().getTextRange();
      document.deleteString(range.getStartOffset(),range.getEndOffset());
    }
    Template template=builder.buildInlineTemplate();
    editor.getCaretModel().moveToOffset(element.getTextRange().getStartOffset());
    TemplateManager.getInstance(project).startTemplate(editor,template,new TemplateStateListener(){
      public void templateFinished(      Template template){
        TemplateState templateState=TemplateManagerImpl.getTemplateState(editor);
        int offset=templateState.getVariableRange(INPUT_VARIABLE_NAME).getEndOffset();
        editor.getCaretModel().moveToOffset(offset);
        EditorUtil.setVerticalScrollProportion(editor,proportion);
      }
    }
);
    EditorUtil.setVerticalScrollProportion(editor,proportion);
  }
}
