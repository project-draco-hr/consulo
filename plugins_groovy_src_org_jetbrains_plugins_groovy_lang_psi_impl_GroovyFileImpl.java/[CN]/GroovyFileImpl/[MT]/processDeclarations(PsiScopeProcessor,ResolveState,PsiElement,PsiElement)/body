{
  if (myContext != null) {
    if (!processChildrenScopes(processor,state,lastParent,place))     return false;
    return true;
  }
  GroovyScriptClass scriptClass=getScriptClass();
  if (scriptClass != null) {
    if (!(lastParent instanceof GrTypeDefinition)) {
      if (!scriptClass.processDeclarations(processor,state,lastParent,place))       return false;
    }
    if (!ResolveUtil.processElement(processor,scriptClass,state))     return false;
  }
  for (  GrTypeDefinition definition : getTypeDefinitions()) {
    if (!ResolveUtil.processElement(processor,definition,state))     return false;
  }
  if (!processChildrenScopes(processor,state,lastParent,place))   return false;
  final ClassHint classHint=processor.getHint(ClassHint.KEY);
  final boolean processClasses=classHint == null || classHint.shouldProcess(ClassHint.ResolveKind.CLASS);
  final String expectedName=ResolveUtil.getNameHint(processor);
  PsiScopeProcessor importProcessor=!processClasses || expectedName == null ? processor : new DelegatingScopeProcessor(processor){
    public boolean execute(    @NotNull PsiElement element,    ResolveState state){
      return isImplicitlyImported(element,expectedName) || super.execute(element,state);
    }
  }
;
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(getProject());
  GrImportStatement[] importStatements=getImportStatements();
  if (!processImports(state,lastParent,place,importProcessor,importStatements,false))   return false;
  if (!processDeclarationsInPackage(processor,state,lastParent,place,facade,getPackageName()))   return false;
  if (!processImports(state,lastParent,place,importProcessor,importStatements,true))   return false;
  if (processClasses && !processImplicitImports(processor,state,lastParent,place)) {
    return false;
  }
  if (classHint == null || classHint.shouldProcess(ClassHint.ResolveKind.PACKAGE)) {
    if (expectedName != null) {
      final PsiPackage pkg=facade.findPackage(expectedName);
      if (pkg != null && !processor.execute(pkg,state)) {
        return false;
      }
    }
 else {
      PsiPackage defaultPackage=facade.findPackage("");
      if (defaultPackage != null) {
        for (        PsiPackage subPackage : defaultPackage.getSubPackages(getResolveScope())) {
          if (!ResolveUtil.processElement(processor,subPackage,state))           return false;
        }
      }
    }
  }
  if (lastParent != null && !(lastParent instanceof GrTypeDefinition) && scriptClass != null) {
    if (!ResolveUtil.processElement(processor,getSyntheticArgsParameter(),state))     return false;
  }
  return true;
}
