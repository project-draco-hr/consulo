{
  if (oldNode instanceof FileElement && newNode instanceof FileElement) {
    BlockSupportImpl.replaceFileElement(myFile,(FileElement)oldNode,(FileElement)newNode,myPsiManager);
  }
 else {
    if (oldNode instanceof ChameleonElement) {
      oldNode=ChameleonTransforming.transform((ChameleonElement)oldNode);
    }
    myRepositoryManager.beforeChildAddedOrRemoved(myFile,oldNode);
    TreeUtil.remove((TreeElement)newNode);
    TreeUtil.replaceWithList((TreeElement)oldNode,(TreeElement)newNode);
    final ReplaceChangeInfoImpl change=(ReplaceChangeInfoImpl)ChangeInfoImpl.create(ChangeInfo.REPLACE,newNode);
    change.setReplaced(oldNode);
    myEvent.addElementaryChange(newNode,change);
    ((TreeElement)newNode).clearCaches();
    if (!(newNode instanceof FileElement)) {
      ((CompositeElement)newNode.getTreeParent()).subtreeChanged();
    }
    myRepositoryManager.beforeChildAddedOrRemoved(myFile,newNode);
  }
}
