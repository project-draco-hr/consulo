{
  for (  ProjectStructureValidator validator : EP_NAME.getExtensions()) {
    if (validator.addLibraryToDependencies(library,project,allowEmptySelection)) {
      return;
    }
  }
  final ModuleStructureConfigurable moduleStructureConfigurable=ModuleStructureConfigurable.getInstance(project);
  final List<Module> modules=LibraryEditingUtil.getSuitableModules(moduleStructureConfigurable,((LibraryEx)library).getType(),library);
  if (modules.isEmpty())   return;
  final ChooseModulesDialog dlg=new ChooseModulesDialog(moduleStructureConfigurable.getProject(),modules,ProjectBundle.message("choose.modules.dialog.title"),ProjectBundle.message("choose.modules.dialog.description",library.getName()));
  dlg.show();
  if (dlg.isOK()) {
    final List<Module> chosenModules=dlg.getChosenElements();
    for (    Module module : chosenModules) {
      moduleStructureConfigurable.addLibraryOrderEntry(module,library);
    }
  }
}
