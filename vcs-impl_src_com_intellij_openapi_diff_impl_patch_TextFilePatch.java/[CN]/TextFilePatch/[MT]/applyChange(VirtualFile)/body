{
  byte[] fileContents=fileToPatch.contentsToByteArray();
  CharSequence text=LoadTextUtil.getTextByBinaryPresentation(fileContents,fileToPatch);
  StringBuilder newText=new StringBuilder();
  ApplyPatchStatus status=applyModifications(text,newText);
  if (status != ApplyPatchStatus.ALREADY_APPLIED) {
    final Document document=FileDocumentManager.getInstance().getDocument(fileToPatch);
    if (document == null) {
      throw new ApplyPatchException("Failed to set contents for updated file " + fileToPatch.getPath());
    }
    document.setText(newText.toString());
    FileDocumentManager.getInstance().saveDocument(document);
  }
  return status;
}
