{
  final Set<String> usedWords=new HashSet<String>();
  final PsiElement position=parameters.getPosition();
  final boolean checkAccess=parameters.getInvocationCount() <= 1;
  LegacyCompletionContributor.processReferences(parameters,result,new PairConsumer<PsiReference,CompletionResultSet>(){
    public void consume(    final PsiReference reference,    final CompletionResultSet result){
      if (reference instanceof PsiJavaReference) {
        final ElementFilter filter=getReferenceFilter(position);
        if (filter != null) {
          boolean filterVoid=JavaSmartCompletionContributor.getExpectedTypes(parameters).length > 0 && parameters.getInvocationCount() < 2;
          final boolean isSwitchLabel=SWITCH_LABEL.accepts(position);
          final PsiFile originalFile=parameters.getOriginalFile();
          for (          LookupElement element : JavaCompletionUtil.processJavaReference(position,(PsiJavaReference)reference,new ElementExtractorFilter(filter),checkAccess,result.getPrefixMatcher(),parameters)) {
            if (inheritors.alreadyProcessed(element)) {
              continue;
            }
            if (isSwitchLabel) {
              result.addElement(TailTypeDecorator.withTail(element,TailType.createSimpleTailType(':')));
            }
 else {
              final LookupItem item=element.as(LookupItem.CLASS_CONDITION_KEY);
              if (originalFile instanceof PsiJavaCodeReferenceCodeFragment && !((PsiJavaCodeReferenceCodeFragment)originalFile).isClassesAccepted() && item != null) {
                item.setTailType(TailType.NONE);
              }
              Object object=element.getObject();
              if (filterVoid && object instanceof PsiMethod && PsiType.VOID.equals(((PsiMethod)object).getReturnType())) {
                continue;
              }
              result.addElement(element);
            }
          }
        }
        return;
      }
      final Object[] variants=reference.getVariants();
      if (variants == null) {
        LOG.error("Reference=" + reference);
      }
      for (      Object completion : variants) {
        if (completion == null) {
          LOG.error("Position=" + position + "\n;Reference="+ reference+ "\n;variants="+ Arrays.toString(variants));
        }
        if (completion instanceof LookupElement && !inheritors.alreadyProcessed((LookupElement)completion)) {
          usedWords.add(((LookupElement)completion).getLookupString());
          result.addElement((LookupElement)completion);
        }
 else         if (completion instanceof PsiClass) {
          if (!inheritors.alreadyProcessed((PsiClass)completion)) {
            JavaPsiClassReferenceElement item=JavaClassNameCompletionContributor.createClassLookupItem((PsiClass)completion,true);
            usedWords.add(item.getLookupString());
            result.addElement(item);
          }
        }
 else {
          LookupElement element=LookupItemUtil.objectToLookupItem(completion);
          usedWords.add(element.getLookupString());
          result.addElement(element);
        }
      }
    }
  }
);
  return usedWords;
}
