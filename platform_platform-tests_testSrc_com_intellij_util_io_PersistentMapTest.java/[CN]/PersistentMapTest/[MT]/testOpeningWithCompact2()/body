{
  File file=FileUtil.createTempFile("persistent","map");
  PersistentHashMap<Integer,String> map=new PersistentHashMap<Integer,String>(file,new IntInlineKeyDescriptor(),new EnumeratorStringDescriptor());
  try {
    final int stringsCount=5;
    Map<Integer,String> testMapping=new LinkedHashMap<Integer,String>(stringsCount);
    for (int i=0; i < stringsCount; ++i) {
      final String key=createRandomString();
      String value=key + "_value";
      testMapping.put(i,value);
      map.put(i,value);
    }
    map.close();
    map=new PersistentHashMap<Integer,String>(file,new IntInlineKeyDescriptor(),new EnumeratorStringDescriptor());
{
      final Collection<Integer> allKeys=new HashSet<Integer>(map.getAllKeysWithExistingMapping());
      assertEquals(new HashSet<Integer>(testMapping.keySet()),allKeys);
      for (      Integer key : allKeys) {
        final String val=map.get(key);
        assertEquals(testMapping.get(key),val);
      }
    }
    map.compact();
{
      final Collection<Integer> allKeys=new HashSet<Integer>(map.getAllKeysWithExistingMapping());
      assertEquals(new HashSet<Integer>(testMapping.keySet()),allKeys);
      for (      Integer key : allKeys) {
        final String val=map.get(key);
        assertEquals(testMapping.get(key),val);
      }
    }
  }
  finally {
    clearMap(file,map);
  }
}
