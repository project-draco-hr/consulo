{
  final int eol=pattern.indexOf('\n');
  if (eol != -1) {
    pattern=pattern.substring(0,eol);
  }
  if (pattern.length() >= 80) {
    pattern=pattern.substring(0,80);
  }
  @NonNls final StringBuffer buffer=new StringBuffer();
  boolean lastIsUppercase=false;
  final boolean endsWithSpace=StringUtil.endsWithChar(pattern,' ');
  pattern=pattern.trim();
  exactPrefixLen=Math.min(exactPrefixLen,pattern.length());
  final boolean uppercaseOnly=containsOnlyUppercaseLetters(pattern.substring(exactPrefixLen));
  if (uppercaseOnly) {
    allowToLower=false;
  }
  for (int i=0; i != exactPrefixLen; ++i) {
    final char c=pattern.charAt(i);
    if (Character.isLetterOrDigit(c)) {
      buffer.append(c);
    }
 else {
      buffer.append("\\x");
      buffer.append(Integer.toHexString(c + 0x20000).substring(3));
    }
  }
  boolean firstIdentifierLetter=(exactPrefixLen == 0);
  for (int i=exactPrefixLen; i < pattern.length(); i++) {
    final char c=pattern.charAt(i);
    lastIsUppercase=false;
    if (Character.isLetterOrDigit(c)) {
      if (Character.isUpperCase(c) || Character.isDigit(c)) {
        buffer.append('(');
        if (!firstIdentifierLetter) {
          buffer.append("[a-z0-9\\$]*");
        }
        buffer.append(c);
        if (allowToLower || i == exactPrefixLen) {
          buffer.append('|');
          buffer.append(Character.toLowerCase(c));
        }
        if (!firstIdentifierLetter) {
          buffer.append("|([A-Za-z0-9\\$]*(_|-)(");
          buffer.append(c);
          buffer.append("|");
          buffer.append(Character.toLowerCase(c));
          buffer.append("))");
        }
        buffer.append(')');
        lastIsUppercase=true;
      }
 else       if (Character.isLowerCase(c) && allowToUpper) {
        buffer.append('[');
        buffer.append(c);
        buffer.append('|');
        buffer.append(Character.toUpperCase(c));
        buffer.append(']');
      }
 else {
        buffer.append(c);
      }
      firstIdentifierLetter=false;
    }
 else     if (c == '*') {
      buffer.append(".*");
      firstIdentifierLetter=true;
    }
 else     if (c == '.') {
      if (!firstIdentifierLetter) {
        buffer.append("[a-z0-9\\$]*\\.");
      }
 else {
        buffer.append("\\.");
      }
      firstIdentifierLetter=true;
    }
 else {
      firstIdentifierLetter=true;
      buffer.append("\\x");
      buffer.append(Integer.toHexString(c + 0x20000).substring(3));
    }
  }
  if (!endsWithSpace) {
    buffer.append(".*");
  }
 else   if (lastIsUppercase) {
    buffer.append("[a-z0-9\\$]*");
  }
  return buffer.toString();
}
