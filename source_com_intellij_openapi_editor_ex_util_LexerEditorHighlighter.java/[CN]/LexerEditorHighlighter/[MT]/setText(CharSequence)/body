{
  char[] chars=CharArrayUtil.fromSequence(text);
  if (myLexer instanceof JspHighlightLexer && myEditor != null && myEditor.getProject() != null) {
    final PsiDocumentManager instance=PsiDocumentManager.getInstance(myEditor.getProject());
    final PsiFile psiFile=instance.getPsiFile(myEditor.getDocument());
    if (PsiUtil.isInJspFile(psiFile))     ((JspHighlightLexer)myLexer).setBaseFile(PsiUtil.getJspFile(psiFile));
  }
  int startOffset=0;
  myLexer.start(chars,startOffset,text.length());
  mySegments.removeAll();
  int i=0;
  while (myLexer.getTokenType() != null) {
    int data=packData(myLexer.getTokenType(),myLexer.getState());
    mySegments.setElementAt(i,myLexer.getTokenStart(),myLexer.getTokenEnd(),data);
    i++;
    myLexer.advance();
  }
  checkUpdateCorrect(text.length());
  if (myEditor != null) {
    ((EditorEx)myEditor).repaint(0,text.length());
  }
}
