{
  Document document=e.getDocument();
  if (myLexer instanceof JspHighlightLexer && myEditor != null && myEditor.getProject() != null) {
    final PsiDocumentManager instance=PsiDocumentManager.getInstance(myEditor.getProject());
    final PsiFile psiFile=instance.getPsiFile(document);
    if (psiFile instanceof JspFile)     ((JspHighlightLexer)myLexer).setBaseFile((JspFile)psiFile);
  }
  if (mySegments.getSegmentCount() == 0) {
    setText(document.getCharsSequence());
    return;
  }
  CharSequence text=document.getCharsSequence();
  int oldStartOffset=e.getOffset();
  final int oldStartIndex=Math.max(0,mySegments.findSegmentIndex(oldStartOffset) - 2);
  int startIndex=oldStartIndex;
  int data;
  do {
    data=mySegments.getSegmentData(startIndex);
    if (isInitialState(data) || startIndex == 0)     break;
    startIndex--;
  }
 while (true);
  int startOffset=mySegments.getSegmentStart(startIndex);
  int newEndOffset=e.getOffset() + e.getNewLength();
  myLexer.start(CharArrayUtil.fromSequence(text),startOffset,text.length(),myInitialState);
  int lastTokenStart=-1;
  int lastLexerState=-1;
  while (myLexer.getTokenType() != null) {
    if (startIndex >= oldStartIndex)     break;
    int tokenStart=myLexer.getTokenStart();
    int lexerState=myLexer.getState();
    if (tokenStart == lastTokenStart && lexerState == lastLexerState) {
      throw new IllegalStateException("Error while updating lexer: " + e + " document text: "+ document.getText());
    }
    int tokenEnd=myLexer.getTokenEnd();
    data=packData(myLexer.getTokenType(),lexerState);
    if (mySegments.getSegmentStart(startIndex) != tokenStart || mySegments.getSegmentEnd(startIndex) != tokenEnd || mySegments.getSegmentData(startIndex) != data) {
      break;
    }
    startIndex++;
    myLexer.advance();
    lastTokenStart=tokenStart;
    lastLexerState=lexerState;
  }
  startOffset=mySegments.getSegmentStart(startIndex);
  int repaintEnd=-1;
  int insertSegmentCount=0;
  int oldEndIndex=-1;
  SegmentArrayWithData insertSegments=new SegmentArrayWithData();
  while (myLexer.getTokenType() != null) {
    int tokenStart=myLexer.getTokenStart();
    int lexerState=myLexer.getState();
    if (tokenStart == lastTokenStart && lexerState == lastLexerState) {
      throw new IllegalStateException("Error while updating lexer: " + e + " document text: "+ document.getText());
    }
    lastTokenStart=tokenStart;
    lastLexerState=lexerState;
    int tokenEnd=myLexer.getTokenEnd();
    data=packData(myLexer.getTokenType(),lexerState);
    if (tokenStart >= newEndOffset && lexerState == myInitialState) {
      int shiftedTokenStart=tokenStart - e.getNewLength() + e.getOldLength();
      int index=mySegments.findSegmentIndex(shiftedTokenStart);
      if (mySegments.getSegmentStart(index) == shiftedTokenStart && mySegments.getSegmentData(index) == data) {
        repaintEnd=tokenStart;
        oldEndIndex=index;
        break;
      }
    }
    insertSegments.setElementAt(insertSegmentCount,tokenStart,tokenEnd,data);
    insertSegmentCount++;
    myLexer.advance();
  }
  final int shift=e.getNewLength() - e.getOldLength();
  if (repaintEnd > 0) {
    while (insertSegmentCount > 0 && oldEndIndex > startIndex) {
      if (!segmentsEqual(mySegments,oldEndIndex - 1,insertSegments,insertSegmentCount - 1,shift)) {
        break;
      }
      insertSegmentCount--;
      oldEndIndex--;
      repaintEnd=insertSegments.getSegmentStart(insertSegmentCount);
      insertSegments.remove(insertSegmentCount,insertSegmentCount + 1);
    }
  }
  if (repaintEnd == -1) {
    repaintEnd=text.length();
  }
  if (oldEndIndex < 0) {
    oldEndIndex=mySegments.getSegmentCount();
  }
  int changedIndex=changedOffsetIndex(startIndex,oldEndIndex,insertSegments);
  mySegments.shiftSegments(oldEndIndex,shift);
  mySegments.remove(startIndex,oldEndIndex);
  mySegments.insert(insertSegments,startIndex);
synchronized (document) {
    int tokenStartOffset;
    if (changedIndex == -1) {
      tokenStartOffset=-1;
    }
 else {
      tokenStartOffset=mySegments.getSegmentStart(changedIndex);
      Integer oldTokenStartOffset=document.getUserData(CHANGED_TOKEN_START_OFFSET);
      if (oldTokenStartOffset != null && oldTokenStartOffset.intValue() != tokenStartOffset) {
        tokenStartOffset=-1;
      }
    }
    document.putUserData(CHANGED_TOKEN_START_OFFSET,new Integer(tokenStartOffset));
  }
  int lastDocOffset=document.getTextLength();
  checkUpdateCorrect(lastDocOffset);
  if (insertSegmentCount == 0 || oldEndIndex == startIndex + 1 && insertSegmentCount == 1 && data == mySegments.getSegmentData(startIndex)) {
    return;
  }
  ((EditorEx)myEditor).repaint(startOffset,repaintEnd);
}
