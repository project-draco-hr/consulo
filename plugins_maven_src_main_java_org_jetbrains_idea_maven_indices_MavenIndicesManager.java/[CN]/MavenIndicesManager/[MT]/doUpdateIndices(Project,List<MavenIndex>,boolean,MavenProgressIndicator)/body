{
  MavenLog.LOG.assertTrue(!fullUpdate || projectOrNull != null);
  List<MavenIndex> remainingWaiting=new ArrayList<MavenIndex>(indices);
  try {
    for (    MavenIndex each : indices) {
      if (indicator.isCanceled())       return;
      indicator.setText(IndicesBundle.message("maven.indices.updating.index",each.getRepositoryId(),each.getRepositoryPathOrUrl()));
synchronized (myUpdatingIndicesLock) {
        remainingWaiting.remove(each);
        myWaitingIndices.remove(each);
        myUpdatingIndex=each;
      }
      try {
        getIndicesObject().updateOrRepair(each,fullUpdate,fullUpdate ? getMavenSettings(projectOrNull,indicator) : null,indicator);
        if (projectOrNull != null)         MavenRehighlighter.rehighlight(projectOrNull);
      }
  finally {
synchronized (myUpdatingIndicesLock) {
          myUpdatingIndex=null;
        }
      }
    }
  }
  finally {
synchronized (myUpdatingIndicesLock) {
      myWaitingIndices.removeAll(remainingWaiting);
    }
  }
}
