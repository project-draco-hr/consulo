{
  super.setUp();
  final TestFixtureBuilder<IdeaProjectTestFixture> projectBuilder=IdeaTestFixtureFactory.getFixtureFactory().createFixtureBuilder(getName());
  myFixture=JavaTestFixtureFactory.getFixtureFactory().createCodeInsightFixture(projectBuilder.getFixture());
  myFixture.enableInspections(AndroidDomInspection.class);
  final JavaModuleFixtureBuilder appModuleBuilder=projectBuilder.addModule(JavaModuleFixtureBuilder.class);
  String appModuleDir=myFixture.getTempDirPath() + "/app";
  new File(appModuleDir).mkdir();
  AndroidTestCase.tuneModule(appModuleBuilder,appModuleDir);
  final JavaModuleFixtureBuilder libModuleBuilder=projectBuilder.addModule(JavaModuleFixtureBuilder.class);
  String libModuleDir=myFixture.getTempDirPath() + "/lib";
  new File(libModuleDir).mkdir();
  libModuleBuilder.addContentRoot(libModuleDir);
  new File(libModuleDir + "/src/").mkdir();
  libModuleBuilder.addSourceRoot("src");
  final JavaModuleFixtureBuilder libGenModuleBuilder=projectBuilder.addModule(JavaModuleFixtureBuilder.class);
  String libGenModule=myFixture.getTempDirPath() + "/lib/gen";
  new File(libGenModule).mkdir();
  libGenModuleBuilder.addSourceContentRoot(libGenModule);
  myFixture.setUp();
  myFixture.setTestDataPath(AndroidTestCase.getAbsoluteTestDataPath());
  myAppModule=appModuleBuilder.getFixture().getModule();
  myLibModule=libModuleBuilder.getFixture().getModule();
  myLibGenModule=libGenModuleBuilder.getFixture().getModule();
  myAppFacet=AndroidTestCase.addAndroidFacet(myAppModule,getTestSdkPath());
  myLibFacet=AndroidTestCase.addAndroidFacet(myLibModule,getTestSdkPath());
  myLibFacet.getConfiguration().LIBRARY_PROJECT=true;
  final ModifiableRootModel model1=ModuleRootManager.getInstance(myAppModule).getModifiableModel();
  model1.addModuleOrderEntry(myLibModule);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      model1.commit();
    }
  }
);
  final ModifiableRootModel model2=ModuleRootManager.getInstance(myLibModule).getModifiableModel();
  model2.addModuleOrderEntry(myLibGenModule);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      model2.commit();
    }
  }
);
}
