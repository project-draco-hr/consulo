{
  try {
    String root=PathManager.getHomePath().replace(File.separatorChar,'/') + getBasePath() + testName;
    String rootBefore=root + "/before";
    PsiTestUtil.removeAllRoots(myModule,JavaSdkImpl.getMockJdk17());
    VirtualFile rootDir=PsiTestUtil.createTestProjectStructure(getProject(),myModule,rootBefore,myFilesToDelete);
    final Module second=createModule("second");
    rootDir.findChild("second").createChildDirectory(this,"p2");
    performAction(classNames,newPackageName,1);
    String rootAfter=root + "/after";
    VirtualFile rootDir2=LocalFileSystem.getInstance().findFileByPath(rootAfter.replace(File.separatorChar,'/'));
    myProject.getComponent(PostprocessReformattingAspect.class).doPostponedFormatting();
    PlatformTestUtil.assertDirectoriesEqual(rootDir2,rootDir,PlatformTestUtil.CVS_FILE_FILTER);
  }
 catch (  Exception e) {
    throw new RuntimeException(e);
  }
}
