{
  if (file instanceof PsiFileEx && ((PsiFileEx)file).isContentsLoaded() && file.getNode().isParsed()) {
    return computeHeaderByPsi(file);
  }
  if (!XmlUtil.isStubBuilding(file) && file.getFileType() == XmlFileType.INSTANCE) {
    VirtualFile virtualFile=file.getVirtualFile();
    if (virtualFile instanceof VirtualFileWithId) {
      ObjectStubTree tree=StubTreeLoader.getInstance().readFromVFile(file.getProject(),virtualFile);
      if (tree != null) {
        return ((FileStub)tree.getRoot()).getHeader();
      }
    }
  }
  if (!file.isValid())   return XmlFileHeader.EMPTY;
  return NanoXmlUtil.parseHeader(file);
}
