{
  final AbstractProjectViewPane viewPane=getCurrentProjectViewPane();
  PsiElement[] elements=viewPane.getSelectedPSIElements();
  for (int idx=0; idx < elements.length; idx++) {
    final PsiElement element=elements[idx];
    if (element instanceof PsiDirectory) {
      PsiDirectory directory=(PsiDirectory)element;
      if (isHideEmptyMiddlePackages(viewPane.getId()) && directory.getChildren().length == 0 && JavaDirectoryService.getInstance().getPackage(directory) != null) {
        while (true) {
          PsiDirectory parent=directory.getParentDirectory();
          if (parent == null)           break;
          PsiPackage psiPackage=JavaDirectoryService.getInstance().getPackage(parent);
          if (psiPackage == null || psiPackage.getName() == null)           break;
          PsiElement[] children=parent.getChildren();
          if (children.length == 0 || children.length == 1 && children[0] == directory) {
            directory=parent;
          }
 else {
            break;
          }
        }
        elements[idx]=directory;
      }
      final VirtualFile virtualFile=directory.getVirtualFile();
      final String path=virtualFile.getPath();
      if (path.endsWith(JarFileSystem.JAR_SEPARATOR)) {
        final VirtualFile vFile=LocalFileSystem.getInstance().findFileByPath(path.substring(0,path.length() - JarFileSystem.JAR_SEPARATOR.length()));
        if (vFile != null) {
          final PsiFile psiFile=PsiManager.getInstance(myProject).findFile(vFile);
          if (psiFile != null) {
            elements[idx]=psiFile;
          }
        }
      }
    }
  }
  return elements;
}
