{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  SelectionModel selectionModel=editor.getSelectionModel();
  if (file == null && !selectionModel.hasSelection()) {
    selectionModel.selectWordAtCaret(false);
  }
  if (file == null || selectionModel.hasSelection()) {
    doRangeHighlighting(editor,project);
    return;
  }
  final HighlightUsagesHandlerBase handler=createCustomHandler(editor,file);
  if (handler != null) {
    handler.highlightUsages();
    return;
  }
  UsageTarget[] usageTargets=UsageTargetUtil.findUsageTargets(editor,file);
  if (usageTargets == null) {
    PsiElement targetElement=getTargetElement(editor,file);
    if (targetElement != null) {
      usageTargets=new UsageTarget[]{new PsiElement2UsageTargetAdapter(targetElement)};
    }
  }
  if (usageTargets == null) {
    PsiReference ref=TargetElementUtilBase.findReference(editor);
    if (ref instanceof PsiPolyVariantReference) {
      ResolveResult[] results=((PsiPolyVariantReference)ref).multiResolve(false);
      if (results.length > 0) {
        usageTargets=new UsageTarget[results.length];
        for (int i=0; i < results.length; ++i) {
          usageTargets[i]=new PsiElement2UsageTargetAdapter(results[i].getElement());
        }
      }
    }
  }
  if (usageTargets == null) {
    if (file.findElementAt(editor.getCaretModel().getOffset()) instanceof PsiWhiteSpace)     return;
    selectionModel.selectWordAtCaret(false);
    String selection=selectionModel.getSelectedText();
    LOG.assertTrue(selection != null);
    for (int i=0; i < selection.length(); i++) {
      if (!Character.isJavaIdentifierPart(selection.charAt(i))) {
        selectionModel.removeSelection();
        return;
      }
    }
    doRangeHighlighting(editor,project);
    selectionModel.removeSelection();
    return;
  }
  boolean clearHighlights=isClearHighlights(editor);
  UsageTarget target=usageTargets[0];
  target.highlightUsages(file,editor,clearHighlights);
}
