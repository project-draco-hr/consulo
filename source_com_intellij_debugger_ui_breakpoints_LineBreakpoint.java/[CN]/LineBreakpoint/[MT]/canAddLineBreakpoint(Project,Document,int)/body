{
  if (lineIndex < 0 || lineIndex >= document.getLineCount()) {
    return false;
  }
  final BreakpointWithHighlighter breakpointAtLine=DebuggerManagerEx.getInstanceEx(project).getBreakpointManager().findBreakpoint(document,document.getLineStartOffset(lineIndex));
  if (breakpointAtLine != null && CATEGORY.equals(breakpointAtLine.getCategory())) {
    return false;
  }
  final boolean[] canAdd=new boolean[]{false};
  PsiDocumentManager.getInstance(project).commitDocument(document);
  DebuggerUtilsEx.iterateLine(project,document,lineIndex,new DebuggerUtilsEx.ElementVisitor(){
    public boolean acceptElement(    PsiElement element){
      if ((element instanceof PsiWhiteSpace) || (PsiTreeUtil.getParentOfType(element,PsiComment.class,false) != null)) {
        return false;
      }
      PsiElement child=element;
      while (element != null) {
        if (document.getLineNumber(element.getTextOffset()) != lineIndex) {
          break;
        }
        child=element;
        element=element.getParent();
      }
      if (child instanceof PsiMethod && child.getTextRange().getEndOffset() >= document.getLineEndOffset(lineIndex)) {
        PsiCodeBlock body=((PsiMethod)child).getBody();
        if (body == null) {
          canAdd[0]=false;
        }
 else {
          PsiStatement[] statements=body.getStatements();
          canAdd[0]=statements.length > 0 && document.getLineNumber(statements[0].getTextOffset()) == lineIndex;
        }
      }
 else {
        canAdd[0]=true;
      }
      return true;
    }
  }
);
  return canAdd[0];
}
