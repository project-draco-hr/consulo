{
  PsiSubstitutor substitutor=mySubstitutor;
  if (aClass instanceof PsiAnonymousClass) {
    ClassResolveResult baseResolveResult=((PsiAnonymousClass)aClass).getBaseClassType().resolveGenerics();
    aClass=baseResolveResult.getElement();
    substitutor=baseResolveResult.getSubstitutor();
    if (aClass == null)     return;
  }
  PsiClass parentClass=null;
  if (!aClass.hasModifierProperty(PsiModifier.STATIC)) {
    final PsiElement parent=aClass.getParent();
    if (parent instanceof PsiClass && !(parent instanceof PsiAnonymousClass)) {
      parentClass=(PsiClass)parent;
    }
  }
  buffer.append(getAnnotationsTextPrefix());
  if (parentClass != null) {
    buildText(parentClass,buffer,canonical,false);
    buffer.append('.');
    buffer.append(aClass.getName());
  }
 else {
    final String name;
    if (!canonical) {
      name=aClass.getName();
    }
 else {
      final String qualifiedName=aClass.getQualifiedName();
      if (qualifiedName != null) {
        name=qualifiedName;
      }
 else {
        name=aClass.getName();
      }
    }
    buffer.append(name);
  }
  final PsiTypeParameter[] typeParameters=aClass.getTypeParameters();
  if (typeParameters.length > 0) {
    StringBuilder pineBuffer=new StringBuilder();
    pineBuffer.append('<');
    for (int i=0; i < typeParameters.length; i++) {
      PsiTypeParameter typeParameter=typeParameters[i];
      if (i > 0)       pineBuffer.append(',');
      final PsiType substitutionResult=substitutor.substitute(typeParameter);
      if (substitutionResult == null) {
        pineBuffer=null;
        break;
      }
      if (!canonical) {
        pineBuffer.append(substitutionResult.getPresentableText());
      }
 else {
        if (internal) {
          pineBuffer.append(substitutionResult.getInternalCanonicalText());
        }
 else {
          pineBuffer.append(substitutionResult.getCanonicalText());
        }
      }
    }
    if (pineBuffer != null) {
      buffer.append(pineBuffer);
      buffer.append('>');
    }
  }
}
