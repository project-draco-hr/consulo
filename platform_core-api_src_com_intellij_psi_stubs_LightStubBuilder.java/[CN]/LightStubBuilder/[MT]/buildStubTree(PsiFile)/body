{
  LighterAST tree=FORCED_AST.get();
  if (tree == null) {
    FileType fileType=file.getFileType();
    if (!(fileType instanceof LanguageFileType)) {
      LOG.error("File is not of LanguageFileType: " + fileType + ", "+ file);
      return null;
    }
    Language language=((LanguageFileType)fileType).getLanguage();
    final IFileElementType contentType=LanguageParserDefinitions.INSTANCE.forLanguage(language).getFileNodeType();
    if (!(contentType instanceof IStubFileElementType)) {
      LOG.error("File is not of IStubFileElementType: " + contentType + ", "+ file);
      return null;
    }
    final FileASTNode node=file.getNode();
    if (contentType instanceof ILightStubFileElementType) {
      tree=node.getLighterAST();
    }
 else {
      tree=new TreeBackedLighterAST(node);
    }
  }
 else {
    FORCED_AST.set(null);
  }
  if (tree == null)   return null;
  final StubElement rootStub=createStubForFile(file,tree);
  buildStubTree(tree,tree.getRoot(),rootStub);
  return rootStub;
}
