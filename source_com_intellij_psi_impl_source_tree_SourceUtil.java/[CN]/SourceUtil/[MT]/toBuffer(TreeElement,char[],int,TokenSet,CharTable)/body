{
synchronized (PsiLock.LOCK) {
    if (skipTypes != null && skipTypes.isInSet(element.getElementType()))     return offset;
    if (element instanceof LeafElement) {
      return ((LeafElement)element).copyTo(buffer,offset,table);
    }
 else {
      int curOffset=offset;
      for (TreeElement child=((CompositeElement)element).firstChild; child != null; child=child.getTreeNext()) {
        curOffset=toBuffer(child,buffer,curOffset,skipTypes,table);
      }
      return curOffset;
    }
  }
}
