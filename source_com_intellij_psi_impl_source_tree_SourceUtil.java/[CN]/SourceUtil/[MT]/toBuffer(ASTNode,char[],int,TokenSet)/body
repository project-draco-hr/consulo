{
synchronized (PsiLock.LOCK) {
    if (skipTypes != null && skipTypes.isInSet(element.getElementType()))     return offset;
    if (element instanceof LeafElement) {
      return ((LeafElement)element).copyTo(buffer,offset);
    }
 else {
      int curOffset=offset;
      for (ASTNode child=element.getFirstChildNode(); child != null; child=child.getTreeNext()) {
        curOffset=toBuffer(child,buffer,curOffset,skipTypes);
      }
      return curOffset;
    }
  }
}
