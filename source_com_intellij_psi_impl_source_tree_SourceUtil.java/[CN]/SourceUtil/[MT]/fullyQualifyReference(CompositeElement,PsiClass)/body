{
  if (((SourceJavaCodeReference)reference).isQualified()) {
    final PsiClass parentClass=targetClass.getContainingClass();
    if (parentClass == null)     return;
    final ASTNode qualifier=reference.findChildByRole(ChildRole.QUALIFIER);
    if (qualifier instanceof SourceJavaCodeReference) {
      ((SourceJavaCodeReference)qualifier).fullyQualify(parentClass);
    }
  }
 else {
    final String qName=targetClass.getQualifiedName();
    if (qName == null) {
      return;
    }
    final int i=qName.lastIndexOf('.');
    if (i > 0) {
      final String prefix=qName.substring(0,i);
      PsiManager manager=reference.getManager();
      char[] chars=prefix.toCharArray();
      final CharTable table=SharedImplUtil.findCharTableByTree(reference);
      final CompositeElement qualifier;
      if (reference instanceof PsiReferenceExpression) {
        qualifier=ExpressionParsing.parseExpressionText(manager,chars,0,chars.length,table);
      }
 else {
        qualifier=Parsing.parseJavaCodeReferenceText(manager,chars,table);
      }
      if (qualifier != null) {
        final CharTable systemCharTab=SharedImplUtil.findCharTableByTree(qualifier);
        final LeafElement dot=Factory.createSingleLeafElement(DOT,new char[]{'.'},0,1,systemCharTab,null);
        TreeUtil.insertAfter(qualifier,dot);
        reference.addInternal(qualifier,dot,null,Boolean.FALSE);
      }
    }
  }
}
