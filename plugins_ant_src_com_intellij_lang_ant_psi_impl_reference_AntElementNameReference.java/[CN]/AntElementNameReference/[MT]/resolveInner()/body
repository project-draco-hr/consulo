{
  final AntStructuredElement element=getElement();
  final AntTypeDefinition elementDef=element.getTypeDefinition();
  if (elementDef != null) {
    final PsiElement definingElement=elementDef.getDefiningElement();
    if (element.isPresetDefined() || element.isTypeDefined()) {
      return definingElement;
    }
    if (!(element instanceof AntTask)) {
      return (definingElement == null) ? findClass(elementDef,element) : definingElement;
    }
    AntTask task=(AntTask)element;
    if (task.isMacroDefined() || task.isScriptDefined()) {
      final XmlAttribute attr=getAttribute();
      if (definingElement != null && attr != null) {
        for (        PsiElement child : definingElement.getChildren()) {
          if (child instanceof AntStructuredElement && attr.getName().equals(((AntStructuredElement)child).getName())) {
            return child;
          }
        }
      }
      return definingElement;
    }
    return findClass(elementDef,element);
  }
  return null;
}
