{
  final AntStructuredElement element=getElement();
  final AntTypeDefinition elementDef=element.getTypeDefinition();
  if (elementDef != null) {
    if (!(element instanceof AntTask)) {
      final PsiElement nestedMacroElement=elementDef.getDefiningElement();
      return (nestedMacroElement == null) ? findClass(elementDef,element) : nestedMacroElement;
    }
    AntTask task=(AntTask)element;
    if (task.isMacroDefined() || task.isPresetDefined()) {
      final PsiElement definingElement=elementDef.getDefiningElement();
      final XmlAttribute attr=getAttribute();
      if (definingElement != null && attr != null) {
        for (        PsiElement child : definingElement.getChildren()) {
          if (child instanceof AntStructuredElement && attr.getName().equals(((AntStructuredElement)child).getName())) {
            return child;
          }
        }
      }
      return definingElement;
    }
    return findClass(elementDef,element);
  }
  return null;
}
