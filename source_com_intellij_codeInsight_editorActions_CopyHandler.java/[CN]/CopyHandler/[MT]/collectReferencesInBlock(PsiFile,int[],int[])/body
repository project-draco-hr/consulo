{
  if (file instanceof PsiCompiledElement) {
    file=(PsiFile)((PsiCompiledElement)file).getMirror();
  }
  final ArrayList<TextBlockTransferable.ReferenceData> array=new ArrayList<TextBlockTransferable.ReferenceData>();
  for (int j=0; j < startOffsets.length; j++) {
    final int startOffset=startOffsets[j];
    final int endOffset=endOffsets[j];
    final PsiElement[] elements=CodeInsightUtil.getElementsInRange(file,startOffset,endOffset);
    for (int i=0; i < elements.length; i++) {
      final PsiElement element=elements[i];
      if (element instanceof PsiJavaCodeReferenceElement) {
        if (!((PsiJavaCodeReferenceElement)element).isQualified()) {
          final JavaResolveResult resolveResult=((PsiJavaCodeReferenceElement)element).advancedResolve(false);
          final PsiElement refElement=resolveResult.getElement();
          if (refElement != null && refElement.getContainingFile() != file) {
            if (refElement instanceof PsiClass) {
              if (refElement.getContainingFile() != element.getContainingFile()) {
                final String qName=((PsiClass)refElement).getQualifiedName();
                if (qName != null) {
                  addReferenceData(element,array,startOffset,qName,null);
                }
              }
            }
 else             if (resolveResult.getCurrentFileResolveScope() instanceof PsiImportStaticStatement) {
              final String classQName=((PsiMember)refElement).getContainingClass().getQualifiedName();
              final String name=((PsiNamedElement)refElement).getName();
              if (classQName != null && name != null) {
                addReferenceData(element,array,startOffset,classQName,name);
              }
            }
          }
        }
      }
    }
  }
  return array.toArray(new TextBlockTransferable.ReferenceData[array.size()]);
}
