{
  if (!(file instanceof GroovyFile))   return;
  ((GroovyFile)file).accept(new PsiRecursiveElementWalkingVisitor(){
    @Override public void visitElement(    PsiElement element){
      super.visitElement(element);
      if (element instanceof GrReferenceElement) {
        visitRefElement((GrReferenceElement)element);
      }
    }
    private void visitRefElement(    GrReferenceElement refElement){
      final GroovyResolveResult[] resolveResults=refElement.multiResolve(false);
      for (      GroovyResolveResult resolveResult : resolveResults) {
        final GroovyPsiElement context=resolveResult.getCurrentFileResolveContext();
        final PsiElement element=resolveResult.getElement();
        if (element == null)         return;
        if (context instanceof GrImportStatement) {
          final GrImportStatement importStatement=(GrImportStatement)context;
          if (usedImports != null && isImportUsed(refElement,element)) {
            usedImports.add(importStatement);
          }
          if (isImplicitlyImported(element,refElement.getReferenceName(),(GroovyFile)file)) {
            addImplicitClass(element);
          }
          if (!importStatement.isAliasedImport() && !isAnnotatedImport(importStatement)) {
            String importedName=null;
            if (importStatement.isOnDemand()) {
              if (importStatement.isStatic()) {
                if (element instanceof PsiMember) {
                  final PsiMember member=(PsiMember)element;
                  final PsiClass clazz=member.getContainingClass();
                  if (clazz != null) {
                    final String classQName=clazz.getQualifiedName();
                    if (classQName != null) {
                      final String name=member.getName();
                      if (name != null) {
                        importedName=classQName + "." + name;
                      }
                    }
                  }
                }
              }
 else {
                importedName=getTargetQualifiedName(element);
              }
            }
 else {
              final GrCodeReferenceElement importReference=importStatement.getImportReference();
              if (importReference != null) {
                importedName=PsiUtil.getQualifiedReferenceText(importReference);
              }
            }
            if (importedName == null)             return;
            final String importRef=getImportReferenceText(importStatement);
            if (annotations != null) {
              if (isAnnotatedImport(importStatement)) {
                annotations.put(importRef,importStatement.getAnnotationList().getText());
              }
            }
            if (importStatement.isAliasedImport()) {
              if (aliased != null) {
                aliased.put(importRef,importedName);
              }
              return;
            }
            if (importStatement.isStatic()) {
              if (staticallyImportedMembers != null) {
                staticallyImportedMembers.add(importedName);
              }
            }
 else {
              if (importedClasses != null) {
                importedClasses.add(importedName);
              }
              if (element instanceof PsiClass && ((PsiClass)element).getContainingClass() != null && innerClasses != null) {
                innerClasses.add(importedName);
              }
            }
          }
        }
 else         if (context == null && !(refElement.getParent() instanceof GrImportStatement) && refElement.getQualifier() == null) {
          addImplicitClass(element);
        }
      }
    }
    private void addImplicitClass(    PsiElement element){
      final String qname=getTargetQualifiedName(element);
      if (qname != null) {
        if (implicitlyImported != null) {
          implicitlyImported.add(qname);
        }
        if (importedClasses != null) {
          importedClasses.add(qname);
        }
      }
    }
    /** 
 * checks if import for implicitly imported class is needed
 */
    private boolean isImportUsed(    GrReferenceElement refElement,    PsiElement element){
      if (isImplicitlyImported(element,refElement.getReferenceName(),(GroovyFile)file)) {
        final ClassResolverProcessor processor=new ClassResolverProcessor(refElement.getReferenceName(),refElement,ResolverProcessor.RESOLVE_KINDS_CLASS);
        processImports(ResolveState.initial(),null,refElement,processor,((GroovyFile)file).getImportStatements(),true);
        if (!processor.hasCandidates()) {
          return false;
        }
      }
      return true;
    }
  }
);
}
