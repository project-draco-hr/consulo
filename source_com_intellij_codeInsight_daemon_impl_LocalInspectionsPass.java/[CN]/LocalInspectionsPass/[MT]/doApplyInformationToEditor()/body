{
  List<HighlightInfo> infos=new ArrayList<HighlightInfo>(myDescriptors.size());
  for (int i=0; i < myDescriptors.size(); i++) {
    ProblemDescriptor descriptor=myDescriptors.get(i);
    final LocalInspectionTool tool=myTools.get(i);
    PsiElement psiElement=descriptor.getPsiElement();
    String message=renderDescriptionMessage(descriptor);
    final HighlightInfoType level=myLevels.get(i);
    final HighlightDisplayKey key=HighlightDisplayKey.find(tool.getShortName());
    final InspectionProfileImpl inspectionProfile=DaemonCodeAnalyzerSettings.getInstance().getInspectionProfile();
    if (!inspectionProfile.isToolEnabled(key))     continue;
    final boolean isError=inspectionProfile.getErrorLevel(key) == HighlightDisplayLevel.ERROR;
    final HighlightInfoType type=new HighlightInfoType(){
      public HighlightSeverity getSeverity(){
        return isError ? HighlightSeverity.ERROR : HighlightSeverity.WARNING;
      }
      public TextAttributesKey getAttributesKey(){
        return level.getAttributesKey();
      }
    }
;
    final HighlightInfo highlightInfo=HighlightInfo.createHighlightInfo(type,psiElement,message,message);
    infos.add(highlightInfo);
    if (descriptor.getFix() != null) {
      QuickFixAction.registerQuickFixAction(highlightInfo,new QuickFixWrapper(descriptor));
    }
    QuickFixAction.registerQuickFixAction(highlightInfo,new AddNoInspectionCommentAction(tool,psiElement));
    QuickFixAction.registerQuickFixAction(highlightInfo,new AddNoInspectionDocTagAction(tool,psiElement));
    QuickFixAction.registerQuickFixAction(highlightInfo,new SwitchOffToolAction(tool));
  }
  final HighlightInfo[] array=infos.toArray(new HighlightInfo[infos.size()]);
  UpdateHighlightersUtil.setHighlightersToEditor(myProject,myDocument,myStartOffset,myEndOffset,array,UpdateHighlightersUtil.INSPECTION_HIGHLIGHTERS_GROUP);
  myDescriptors=Collections.EMPTY_LIST;
  myLevels=Collections.EMPTY_LIST;
  myTools=Collections.EMPTY_LIST;
  DaemonCodeAnalyzerImpl daemonCodeAnalyzer=(DaemonCodeAnalyzerImpl)DaemonCodeAnalyzer.getInstance(myProject);
  daemonCodeAnalyzer.getFileStatusMap().markFileUpToDate(myDocument,FileStatusMap.LOCAL_INSPECTIONS);
  ErrorStripeRenderer renderer=new RefreshStatusRenderer(myProject,daemonCodeAnalyzer,myDocument,myFile);
  Editor[] editors=EditorFactory.getInstance().getEditors(myDocument,myProject);
  for (int i=0; i < editors.length; i++) {
    Editor editor=editors[i];
    ((EditorMarkupModel)editor.getMarkupModel()).setErrorStripeRenderer(renderer);
  }
}
