{
  List<HighlightInfo> infos=new ArrayList<HighlightInfo>(myDescriptors.size());
  for (int i=0; i < myDescriptors.size(); i++) {
    ProblemDescriptor descriptor=myDescriptors.get(i);
    LocalInspectionTool tool=myTools.get(i);
    PsiElement psiElement=descriptor.getPsiElement();
    if (psiElement == null)     continue;
    String message=renderDescriptionMessage(descriptor);
    final HighlightInfoType level=myLevels.get(i);
    HighlightDisplayKey key=HighlightDisplayKey.find(tool.getShortName());
    InspectionProfileImpl inspectionProfile=DaemonCodeAnalyzerSettings.getInstance().getInspectionProfile(myFile);
    if (!inspectionProfile.isToolEnabled(key))     continue;
    final boolean isError=inspectionProfile.getErrorLevel(key) == HighlightDisplayLevel.ERROR;
    HighlightInfoType type=new HighlightInfoType(){
      public HighlightSeverity getSeverity(      final PsiElement psiElement){
        return isError ? HighlightSeverity.ERROR : HighlightSeverity.WARNING;
      }
      public TextAttributesKey getAttributesKey(){
        return level.getAttributesKey();
      }
    }
;
    String plainMessage=XmlUtil.unescape(message.replaceAll("<[^>]*>",""));
    HighlightInfo highlightInfo=HighlightInfo.createHighlightInfo(type,psiElement,plainMessage,message);
    infos.add(highlightInfo);
    List<IntentionAction> options=new ArrayList<IntentionAction>();
    options.add(new SwitchOffToolAction(tool));
    options.add(new AddNoInspectionCommentAction(tool,psiElement));
    options.add(new AddNoInspectionDocTagAction(tool,psiElement));
    options.add(new AddNoInspectionForClassAction(tool,psiElement));
    options.add(new AddNoInspectionAllForClassAction(psiElement));
    options.add(new AddSuppressWarningsAnnotationAction(tool,psiElement));
    options.add(new AddSuppressWarningsAnnotationForClassAction(tool,psiElement));
    options.add(new AddSuppressWarningsAnnotationForAllAction(psiElement));
    final LocalQuickFix[] fixes=descriptor.getFixes();
    if (fixes != null && fixes.length > 0) {
      for (int k=0; k < fixes.length; k++) {
        QuickFixAction.registerQuickFixAction(highlightInfo,new QuickFixWrapper(descriptor,k),options);
      }
    }
 else {
      QuickFixAction.registerQuickFixAction(highlightInfo,new EmptyIntentionAction(tool.getDisplayName(),options),options);
    }
  }
  UpdateHighlightersUtil.setHighlightersToEditor(myProject,myDocument,myStartOffset,myEndOffset,infos,UpdateHighlightersUtil.INSPECTION_HIGHLIGHTERS_GROUP);
  myDescriptors=Collections.EMPTY_LIST;
  myLevels=Collections.EMPTY_LIST;
  myTools=Collections.EMPTY_LIST;
  DaemonCodeAnalyzerImpl daemonCodeAnalyzer=(DaemonCodeAnalyzerImpl)DaemonCodeAnalyzer.getInstance(myProject);
  daemonCodeAnalyzer.getFileStatusMap().markFileUpToDate(myDocument,FileStatusMap.LOCAL_INSPECTIONS);
  ErrorStripeRenderer renderer=new RefreshStatusRenderer(myProject,daemonCodeAnalyzer,myDocument);
  Editor[] editors=EditorFactory.getInstance().getEditors(myDocument,myProject);
  for (  Editor editor : editors) {
    ((EditorMarkupModel)editor.getMarkupModel()).setErrorStripeRenderer(renderer);
  }
}
