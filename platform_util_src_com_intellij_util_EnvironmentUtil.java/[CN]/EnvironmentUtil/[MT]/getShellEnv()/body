{
  String shell=System.getenv("SHELL");
  if (shell == null || !new File(shell).canExecute()) {
    throw new Exception("shell:" + shell);
  }
  File reader=FileUtil.findFirstThatExist(PathManager.getBinPath() + "/printenv.py",PathManager.getHomePath() + "/community/bin/mac/printenv.py",PathManager.getHomePath() + "/bin/mac/printenv.py");
  if (reader == null) {
    throw new Exception("bin:" + PathManager.getBinPath());
  }
  File envFile=FileUtil.createTempFile("intellij-shell-env",null,false);
  try {
    String[] command={shell,"-l","-i","-c",("'" + reader.getAbsolutePath() + "' '"+ envFile.getAbsolutePath()+ "'")};
    LOG.info("loading shell env: " + StringUtil.join(command," "));
    Process process=Runtime.getRuntime().exec(command);
    ProcessKiller processKiller=new ProcessKiller(process);
    processKiller.killAfter(SHELL_ENV_READING_TIMEOUT);
    int rv=process.waitFor();
    processKiller.stopWaiting();
    String lines=FileUtil.loadFile(envFile);
    if (rv != 0 || lines.isEmpty()) {
      throw new Exception("rv:" + rv + " text:"+ lines.length());
    }
    return parseEnv(lines);
  }
  finally {
    FileUtil.delete(envFile);
  }
}
