{
  Set<String> toIgnore=new HashSet<String>(Arrays.asList("_","PWD","SHLVL",DISABLE_OMZ_AUTO_UPDATE));
  Map<String,String> env=System.getenv();
  Map<String,String> newEnv=new HashMap<String,String>();
  String[] lines=text.split(lineSeparator);
  for (  String line : lines) {
    int pos=line.indexOf('=');
    if (pos <= 0) {
      throw new Exception("malformed:" + line);
    }
    String name=line.substring(0,pos);
    if (!toIgnore.contains(name)) {
      newEnv.put(name,line.substring(pos + 1));
    }
 else     if (env.containsKey(name)) {
      newEnv.put(name,env.get(name));
    }
  }
  LOG.info("shell environment loaded (" + newEnv.size() + " vars)");
  return newEnv;
}
