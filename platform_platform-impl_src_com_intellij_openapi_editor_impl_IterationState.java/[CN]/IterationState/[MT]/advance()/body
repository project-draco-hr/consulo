{
  myNextIsFoldRegion=false;
  myStartOffset=myEndOffset;
  advanceSegmentHighlighters();
  advanceCurrentSelectionIndex();
  advanceCurrentVirtualSelectionIndex();
  if (!myUseOnlyFullLineHighlighters) {
    myCurrentFold=myFoldingModel.getCollapsedRegionAtOffset(myStartOffset);
  }
  if (myCurrentFold != null) {
    myEndOffset=myCurrentFold.getEndOffset();
  }
 else {
    myEndOffset=Math.min(getHighlighterEnd(myStartOffset),getSelectionEnd());
    myEndOffset=Math.min(myEndOffset,getMinSegmentHighlightersEnd());
    int foldRangesEnd=getFoldRangesEnd(myStartOffset);
    myEndOffset=Math.min(myEndOffset,foldRangesEnd);
    myEndOffset=Math.min(myEndOffset,getCaretEnd(myStartOffset));
    myEndOffset=Math.min(myEndOffset,getGuardedBlockEnd(myStartOffset));
    myNextIsFoldRegion=myEndOffset == foldRangesEnd && myEndOffset < myEnd;
  }
  reinit();
}
