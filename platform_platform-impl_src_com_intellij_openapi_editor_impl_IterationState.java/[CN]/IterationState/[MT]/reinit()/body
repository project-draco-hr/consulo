{
  if (myHighlighterIterator.atEnd()) {
    return;
  }
  boolean isInSelection=hasSelection && myStartOffset >= mySelectionStart && myStartOffset < mySelectionEnd;
  boolean isInCaretRow=myStartOffset >= myCaretRowStart && myStartOffset < myCaretRowEnd;
  boolean isInGuardedBlock=myDocument.getOffsetGuard(myStartOffset) != null;
  TextAttributes syntax=myHighlighterIterator.getTextAttributes();
  TextAttributes selection=isInSelection ? mySelectionAttributes : null;
  TextAttributes caret=isInCaretRow ? myCaretRowAttributes : null;
  TextAttributes fold=myCurrentFold != null ? myFoldTextAttributes : null;
  TextAttributes guard=isInGuardedBlock ? new TextAttributes(null,myReadOnlyColor,null,EffectType.BOXED,Font.PLAIN) : null;
  final int size=myCurrentHighlighters.size();
  if (size > 1) {
    ContainerUtil.quickSort(myCurrentHighlighters,LayerComparator.INSTANCE);
  }
  for (int i=0; i < size; i++) {
    RangeHighlighterEx highlighter=myCurrentHighlighters.get(i);
    if (highlighter.getTextAttributes() == TextAttributes.ERASE_MARKER) {
      syntax=null;
    }
  }
  List<TextAttributes> cachedAttributes=myCachedAttributesList;
  cachedAttributes.clear();
  for (int i=0; i < size; i++) {
    RangeHighlighterEx highlighter=myCurrentHighlighters.get(i);
    if (selection != null && highlighter.getLayer() < HighlighterLayer.SELECTION) {
      cachedAttributes.add(selection);
      selection=null;
    }
    if (syntax != null && highlighter.getLayer() < HighlighterLayer.SYNTAX) {
      if (fold != null) {
        cachedAttributes.add(fold);
        fold=null;
      }
      cachedAttributes.add(syntax);
      syntax=null;
    }
    if (guard != null && highlighter.getLayer() < HighlighterLayer.GUARDED_BLOCKS) {
      cachedAttributes.add(guard);
      guard=null;
    }
    if (caret != null && highlighter.getLayer() < HighlighterLayer.CARET_ROW) {
      cachedAttributes.add(caret);
      caret=null;
    }
    TextAttributes textAttributes=highlighter.getTextAttributes();
    if (textAttributes != null && textAttributes != TextAttributes.ERASE_MARKER) {
      cachedAttributes.add(textAttributes);
    }
  }
  if (selection != null)   cachedAttributes.add(selection);
  if (fold != null)   cachedAttributes.add(fold);
  if (guard != null)   cachedAttributes.add(guard);
  if (caret != null)   cachedAttributes.add(caret);
  if (syntax != null)   cachedAttributes.add(syntax);
  Color fore=null;
  Color back=isInGuardedBlock ? myReadOnlyColor : null;
  Color effect=null;
  EffectType effectType=null;
  int fontType=0;
  for (int i=0; i < cachedAttributes.size(); i++) {
    TextAttributes attrs=cachedAttributes.get(i);
    if (fore == null) {
      fore=ifDiffers(attrs.getForegroundColor(),myDefaultForeground);
    }
    if (back == null) {
      back=ifDiffers(attrs.getBackgroundColor(),myDefaultBackground);
    }
    if (fontType == Font.PLAIN) {
      fontType=attrs.getFontType();
    }
    if (effect == null) {
      effect=attrs.getEffectColor();
      effectType=attrs.getEffectType();
    }
  }
  if (fore == null)   fore=myDefaultForeground;
  if (back == null)   back=myDefaultBackground;
  if (effectType == null)   effectType=EffectType.BOXED;
  myMergedAttributes.setForegroundColor(fore);
  myMergedAttributes.setBackgroundColor(back);
  myMergedAttributes.setFontType(fontType);
  myMergedAttributes.setEffectColor(effect);
  myMergedAttributes.setEffectType(effectType);
}
