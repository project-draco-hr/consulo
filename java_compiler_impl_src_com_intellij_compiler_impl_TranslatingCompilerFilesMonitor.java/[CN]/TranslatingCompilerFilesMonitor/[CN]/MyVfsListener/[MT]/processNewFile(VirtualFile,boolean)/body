{
  final Set<File> pathsToMark=notifyServer ? new THashSet<File>(FileUtil.FILE_HASHING_STRATEGY) : Collections.<File>emptySet();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (      final Project project : myProjectManager.getOpenProjects()) {
        if (!project.isInitialized()) {
          continue;
        }
        final int projectId=getProjectId(project);
        final boolean projectSuspended=isSuspended(projectId);
        final ProjectRootManager rootManager=ProjectRootManager.getInstance(project);
        if (rootManager.getFileIndex().isInSourceContent(file)) {
          final TranslatingCompiler[] translators=CompilerManager.getInstance(project).getCompilers(TranslatingCompiler.class);
          processRecursively(file,false,new FileProcessor(){
            public void execute(            final VirtualFile file){
              if (notifyServer) {
                pathsToMark.add(new File(file.getPath()));
              }
              if (!projectSuspended && isCompilable(file)) {
                loadInfoAndAddSourceForRecompilation(projectId,file);
              }
            }
            boolean isCompilable(            VirtualFile file){
              for (              TranslatingCompiler translator : translators) {
                if (translator.isCompilableFile(file,DummyCompileContext.getInstance())) {
                  return true;
                }
              }
              return false;
            }
          }
);
        }
 else {
          if (!projectSuspended && belongsToIntermediateSources(file,project)) {
            processRecursively(file,false,new FileProcessor(){
              public void execute(              final VirtualFile file){
                loadInfoAndAddSourceForRecompilation(projectId,file);
              }
            }
);
          }
        }
      }
    }
  }
);
  if (notifyServer) {
    notifyFilesChanged(pathsToMark);
  }
}
