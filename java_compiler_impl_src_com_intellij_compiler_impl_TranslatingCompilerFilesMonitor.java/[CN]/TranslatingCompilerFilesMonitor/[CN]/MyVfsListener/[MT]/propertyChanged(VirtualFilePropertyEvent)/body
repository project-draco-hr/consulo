{
  if (VirtualFile.PROP_NAME.equals(event.getPropertyName())) {
    final VirtualFile eventFile=event.getFile();
    final VirtualFile parent=event.getParent();
    if (parent != null) {
      final String oldName=(String)event.getOldValue();
      final String root=parent.getPath() + "/" + oldName;
      final Set<String> toMark;
      if (eventFile.isDirectory()) {
        toMark=new HashSet<String>();
        new Object(){
          void process(          VirtualFile file,          String filePath){
            if (file.isDirectory()) {
              for (              VirtualFile child : file.getChildren()) {
                process(child,filePath + "/" + child.getName());
              }
            }
 else {
              toMark.add(filePath);
            }
          }
        }
.process(eventFile,root);
      }
 else {
        toMark=Collections.singleton(root);
      }
      if (!toMark.isEmpty()) {
        notifyFilesDeleted(toMark);
      }
    }
    markDirtyIfSource(eventFile,false);
  }
}
