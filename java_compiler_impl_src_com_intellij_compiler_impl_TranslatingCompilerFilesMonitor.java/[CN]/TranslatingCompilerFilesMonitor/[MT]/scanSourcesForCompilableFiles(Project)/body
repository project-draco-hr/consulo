{
  final int projectId=getProjectId(project);
synchronized (myInitializationLock) {
    myInitInProgress.add(projectId);
    myInitializationLock.notifyAll();
  }
  StartupManager.getInstance(project).runWhenProjectIsInitialized(new Runnable(){
    public void run(){
      new Task.Backgroundable(project,CompilerBundle.message("compiler.initial.scanning.progress.text"),false){
        public void run(        @NotNull final ProgressIndicator indicator){
          try {
            if (project.isDisposed()) {
              return;
            }
            final IntermediateOutputCompiler[] compilers=CompilerManager.getInstance(project).getCompilers(IntermediateOutputCompiler.class);
            final Set<VirtualFile> intermediateRoots=new HashSet<VirtualFile>();
            if (compilers.length > 0) {
              final Module[] modules=ModuleManager.getInstance(project).getModules();
              for (              IntermediateOutputCompiler compiler : compilers) {
                for (                Module module : modules) {
                  if (module.isDisposed()) {
                    continue;
                  }
                  final VirtualFile outputRoot=LocalFileSystem.getInstance().refreshAndFindFileByPath(CompilerPaths.getGenerationOutputPath(compiler,module,false));
                  if (outputRoot != null) {
                    intermediateRoots.add(outputRoot);
                  }
                  final VirtualFile testsOutputRoot=LocalFileSystem.getInstance().refreshAndFindFileByPath(CompilerPaths.getGenerationOutputPath(compiler,module,true));
                  if (testsOutputRoot != null) {
                    intermediateRoots.add(testsOutputRoot);
                  }
                }
              }
            }
            final List<VirtualFile> projectRoots=Arrays.asList(ProjectRootManager.getInstance(project).getContentSourceRoots());
            final int totalRootsCount=projectRoots.size() + intermediateRoots.size();
            scanSourceContent(project,projectRoots,totalRootsCount,true);
            if (!intermediateRoots.isEmpty()) {
              final FileProcessor processor=new FileProcessor(){
                public void execute(                final VirtualFile file){
                  if (!isMarkedForRecompilation(projectId,getFileId(file))) {
                    final SourceFileInfo srcInfo=loadSourceInfo(file);
                    if (srcInfo == null || srcInfo.getTimestamp(projectId) != file.getTimeStamp()) {
                      addSourceForRecompilation(projectId,file,srcInfo);
                    }
                  }
                }
              }
;
              int processed=projectRoots.size();
              for (              VirtualFile root : intermediateRoots) {
                indicator.setText2(root.getPresentableUrl());
                indicator.setFraction(++processed / (double)totalRootsCount);
                processRecursively(root,false,processor);
              }
            }
            markOldOutputRoots(project,buildOutputRootsLayout(project));
          }
  finally {
synchronized (myInitializationLock) {
              if (myInitInProgress.remove(projectId)) {
                myInitializationLock.notifyAll();
              }
            }
          }
        }
      }
.queue();
    }
  }
);
}
