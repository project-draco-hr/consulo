{
  final Collection<CacheUpdater> updatersCopy=new ArrayList<CacheUpdater>(updaters);
  CacheUpdateRunner runner=new CacheUpdateRunner(myProject,updatersCopy);
  if (ApplicationManager.getApplication().isUnitTestMode() || ApplicationManager.getApplication().isHeadlessEnvironment()) {
    EmptyProgressIndicator i=new EmptyProgressIndicator();
    runner.queryNeededFiles(i);
    runner.processFiles(i,false);
    runner.updatingDone();
    return;
  }
  ProgressIndicator indicator=new EmptyProgressIndicator();
  if (ApplicationManager.getApplication().isDispatchThread() && !isDumb()) {
    int size=runner.queryNeededFiles(indicator);
    System.out.println("querying on request: " + size);
    if (size < 10) {
      if (size > 0) {
        runner.processFiles(indicator,false);
      }
      runner.updatingDone();
      System.out.println("finished " + size);
      return;
    }
    updateStarted();
  }
  try {
    System.out.println("queuing request");
    myUpdatesQueue.put(runner);
  }
 catch (  InterruptedException e) {
    throw new RuntimeException(e);
  }
}
