{
  final Ref<Pair<DumbModeTask,ProgressIndicatorEx>> result=Ref.create();
  invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      if (myProject.isDisposed())       return;
      if (prevTask != null) {
        Disposer.dispose(prevTask);
      }
      while (true) {
        if (myUpdatesQueue.isEmpty()) {
          updateFinished();
          return;
        }
        DumbModeTask queuedTask=myUpdatesQueue.pullFirst();
        ProgressIndicatorEx indicator=myProgresses.get(queuedTask);
        if (indicator.isCanceled()) {
          Disposer.dispose(queuedTask);
          continue;
        }
        result.set(Pair.create(queuedTask,indicator));
        return;
      }
    }
  }
);
  return result.get();
}
