{
  final Runnable update=new Runnable(){
    public void run(){
      if (myProject.isDisposed()) {
        updateFinished();
        return;
      }
      ProgressManager.getInstance().run(new Task.Backgroundable(myProject,"Updating indices",false){
        @Override public void run(        @NotNull final ProgressIndicator indicator){
          indicator.setIndeterminate(false);
          indicator.setText("Indexing...");
          try {
            action.consume(indicator);
          }
  finally {
            ApplicationManager.getApplication().invokeLater(new DumbAwareRunnable(){
              public void run(){
                updateFinished();
              }
            }
);
          }
        }
      }
);
    }
  }
;
  invokeOnEDT(new DumbAwareRunnable(){
    public void run(){
      if (myProject.isDisposed())       return;
      final boolean wasDumb=myDumb.getAndSet(true);
      if (!wasDumb) {
        myPublisher.beforeEnteringDumbMode();
        new WriteAction(){
          protected void run(          Result result) throws Throwable {
            myPublisher.enteredDumbMode();
          }
        }
.execute();
        update.run();
      }
 else {
        myUpdateQueue.addLast(update);
      }
    }
  }
);
}
