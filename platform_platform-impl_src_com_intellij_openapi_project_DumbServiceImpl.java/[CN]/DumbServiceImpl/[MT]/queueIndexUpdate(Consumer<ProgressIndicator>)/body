{
  final Runnable update=new Runnable(){
    public void run(){
      if (myProject.isDisposed()) {
        updateFinished();
        return;
      }
      ProgressManager.getInstance().run(new Task.Backgroundable(myProject,"Updating indices",false){
        @Override public void run(        @NotNull final ProgressIndicator indicator){
          indicator.setIndeterminate(false);
          indicator.setText("Indexing...");
          try {
            action.consume(indicator);
          }
  finally {
            ApplicationManager.getApplication().invokeLater(new DumbAwareRunnable(){
              public void run(){
                updateFinished();
              }
            }
);
          }
        }
      }
);
    }
  }
;
  final boolean goDumbImmediately=((StartupManagerEx)StartupManager.getInstance(myProject)).startupActivityPassed();
  final boolean wasDumb=goDumbImmediately ? myDumb.getAndSet(true) : false;
  invokeOnEDT(new DumbAwareRunnable(){
    public void run(){
      if (myProject.isDisposed())       return;
      boolean wasDumbEx=wasDumb;
      if (!goDumbImmediately) {
        wasDumbEx=myDumb.getAndSet(true);
      }
      if (!wasDumbEx) {
        myPublisher.enteredDumbMode();
        update.run();
      }
 else {
        myUpdateQueue.addLast(update);
      }
    }
  }
);
}
