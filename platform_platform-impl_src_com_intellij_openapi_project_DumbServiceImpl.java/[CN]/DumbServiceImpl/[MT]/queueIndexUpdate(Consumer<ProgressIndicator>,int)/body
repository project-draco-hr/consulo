{
  final IndexUpdateRunnable update=new IndexUpdateRunnable(action,itemsCount);
  final boolean goDumbImmediately=((StartupManagerEx)StartupManager.getInstance(myProject)).startupActivityPassed();
  final boolean wasDumb=goDumbImmediately ? myDumb.getAndSet(true) : false;
  invokeOnEDT(new DumbAwareRunnable(){
    public void run(){
      if (myProject.isDisposed()) {
        return;
      }
      boolean wasDumbEx=wasDumb;
      if (!goDumbImmediately) {
        wasDumbEx=myDumb.getAndSet(true);
      }
      if (!wasDumbEx) {
        myPublisher.enteredDumbMode();
        update.run();
      }
 else {
        final IndexUpdateRunnable currentUpdateRunnable=myCurrentUpdateRunnable;
        if (currentUpdateRunnable != null) {
          currentUpdateRunnable.myTotalItems+=itemsCount;
        }
        myUpdateQueue.addLast(update);
      }
    }
  }
);
}
