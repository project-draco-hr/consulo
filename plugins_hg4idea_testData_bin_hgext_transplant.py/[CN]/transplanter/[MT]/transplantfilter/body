def transplantfilter(self, repo, source, root):

    def matchfn(node):
        if self.applied(repo, node, root):
            return False
        if (source.changelog.parents(node)[1] != revlog.nullid):
            return False
        extra = source.changelog.read(node)[5]
        cnode = extra.get('transplant_source')
        if (cnode and self.applied(repo, cnode, root)):
            return False
        return True
    return matchfn
