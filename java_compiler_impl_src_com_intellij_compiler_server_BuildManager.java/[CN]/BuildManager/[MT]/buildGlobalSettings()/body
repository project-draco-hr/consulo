{
  final PathMacrosImpl pathVars=PathMacrosImpl.getInstanceEx();
  final CmdlineRemoteProto.Message.ControllerMessage.GlobalSettings cached=myGlobals;
  if (cached != null && myGlobalsStamp == pathVars.getModificationStamp()) {
    return cached;
  }
  myGlobals=null;
  myGlobalsStamp=pathVars.getModificationStamp();
  final Map<String,String> data=new HashMap<String,String>();
  for (  Map.Entry<String,String> entry : PathMacrosImpl.getGlobalSystemMacros().entrySet()) {
    data.put(entry.getKey(),FileUtil.toSystemIndependentName(entry.getValue()));
  }
  for (  String name : pathVars.getAllMacroNames()) {
    final String path=pathVars.getValue(name);
    if (path != null) {
      data.put(name,FileUtil.toSystemIndependentName(path));
    }
  }
  final CmdlineRemoteProto.Message.ControllerMessage.GlobalSettings.Builder cmdBuilder=CmdlineRemoteProto.Message.ControllerMessage.GlobalSettings.newBuilder();
  cmdBuilder.setGlobalOptionsPath(PathManager.getOptionsPath());
  if (!data.isEmpty()) {
    for (    Map.Entry<String,String> entry : data.entrySet()) {
      final String var=entry.getKey();
      final String value=entry.getValue();
      if (var != null && value != null) {
        cmdBuilder.addPathVariable(CmdlineProtoUtil.createPair(var,value));
      }
    }
  }
  return myGlobals=cmdBuilder.build();
}
