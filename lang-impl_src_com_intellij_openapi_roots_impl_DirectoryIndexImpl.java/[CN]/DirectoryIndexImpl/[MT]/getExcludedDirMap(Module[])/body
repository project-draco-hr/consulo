{
  Map<VirtualFile,Set<VirtualFile>> excludeRootsMap=new THashMap<VirtualFile,Set<VirtualFile>>();
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    ContentEntry[] contentEntries=rootManager.getContentEntries();
    for (    ContentEntry contentEntry : contentEntries) {
      VirtualFile contentRoot=contentEntry.getFile();
      if (contentRoot == null)       continue;
      VirtualFile[] excludeRoots=contentEntry.getExcludeFolderFiles();
      for (      VirtualFile excludeRoot : excludeRoots) {
        if (!VfsUtil.isAncestor(contentRoot,excludeRoot,false)) {
          if (isExcludeRootForModule(module,excludeRoot)) {
            putForFileAndAllAncestors(excludeRootsMap,excludeRoot,excludeRoot);
          }
        }
        putForFileAndAllAncestors(excludeRootsMap,contentRoot,excludeRoot);
      }
    }
  }
  for (  DirectoryIndexExcludePolicy policy : myExcludePolicies) {
    for (    VirtualFile file : policy.getExcludeRootsForProject()) {
      putForFileAndAllAncestors(excludeRootsMap,file,file);
    }
  }
  return excludeRootsMap;
}
