{
  final ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.pushState();
    progress.setText(ProjectBundle.message("project.index.scanning.files.progress"));
  }
  if (forDir == null) {
    myDirToInfoMap.clear();
    clearIdMap();
    myPackageNameToDirsMap.clear();
  }
  if (forDir != null) {
    VirtualFile dir=forDir;
    do {
      myDirToInfoMap.remove(dir);
      removeInfoById(((VirtualFileWithId)dir).getId());
      dir=dir.getParent();
    }
 while (dir != null);
  }
  Module[] modules=getModules();
  if (reverseAllSets) {
    modules=ArrayUtil.reverseArray(modules);
  }
  if (progress != null) {
    progress.checkCanceled();
    progress.setText2(ProjectBundle.message("project.index.building.exclude.roots.progress"));
  }
  Map<VirtualFile,Set<VirtualFile>> excludeRootsMap=getExcludedDirMap(modules);
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.checkCanceled();
      progress.setText2(ProjectBundle.message("project.index.processing.module.content.progress",module.getName()));
    }
    VirtualFile[] contentRoots=rootManager.getContentRoots();
    if (reverseAllSets) {
      contentRoots=ArrayUtil.reverseArray(contentRoots);
    }
    for (    final VirtualFile contentRoot : contentRoots) {
      Set<VirtualFile> excludeRootsSet=excludeRootsMap.get(contentRoot);
      fillMapWithModuleContent(contentRoot,module,contentRoot,excludeRootsSet,forDir,fileTypeManager);
    }
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.checkCanceled();
      progress.setText2(ProjectBundle.message("project.index.processing.module.sources.progress",module.getName()));
    }
    ContentEntry[] contentEntries=rootManager.getContentEntries();
    if (reverseAllSets) {
      contentEntries=ArrayUtil.reverseArray(contentEntries);
    }
    for (    ContentEntry contentEntry : contentEntries) {
      SourceFolder[] sourceFolders=contentEntry.getSourceFolders();
      if (reverseAllSets) {
        sourceFolders=ArrayUtil.reverseArray(sourceFolders);
      }
      for (      SourceFolder sourceFolder : sourceFolders) {
        VirtualFile dir=sourceFolder.getFile();
        if (dir != null) {
          fillMapWithModuleSource(dir,module,sourceFolder.getPackagePrefix(),dir,sourceFolder.isTestSource(),forDir);
        }
      }
    }
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.checkCanceled();
      progress.setText2(ProjectBundle.message("project.index.processing.library.sources.progress",module.getName()));
    }
    OrderEntry[] orderEntries=rootManager.getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      boolean isLibrary=orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry;
      if (isLibrary) {
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        final VirtualFile sourceRoot : sourceRoots) {
          fillMapWithLibrarySources(sourceRoot,"",sourceRoot,forDir,fileTypeManager);
        }
      }
    }
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    if (progress != null) {
      progress.checkCanceled();
      progress.setText2(ProjectBundle.message("project.index.processing.library.classes.progress",module.getName()));
    }
    OrderEntry[] orderEntries=rootManager.getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      boolean isLibrary=orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry;
      if (isLibrary) {
        VirtualFile[] classRoots=orderEntry.getFiles(OrderRootType.CLASSES);
        for (        final VirtualFile classRoot : classRoots) {
          fillMapWithLibraryClasses(classRoot,"",classRoot,forDir,fileTypeManager);
        }
      }
    }
  }
  if (progress != null) {
    progress.checkCanceled();
    progress.setText2("");
  }
  for (  Module module : modules) {
    ModuleRootManager rootManager=ModuleRootManager.getInstance(module);
    OrderEntry[] orderEntries=rootManager.getOrderEntries();
    final Map<VirtualFile,List<OrderEntry>> depEntries=new HashMap<VirtualFile,List<OrderEntry>>();
    final Map<VirtualFile,List<OrderEntry>> libClassRootEntries=new HashMap<VirtualFile,List<OrderEntry>>();
    final Map<VirtualFile,List<OrderEntry>> libSourceRootEntries=new HashMap<VirtualFile,List<OrderEntry>>();
    for (    OrderEntry orderEntry : orderEntries) {
      if (orderEntry instanceof ModuleOrderEntry) {
        VirtualFile[] importedClassRoots=orderEntry.getFiles(OrderRootType.COMPILATION_CLASSES);
        for (        VirtualFile importedClassRoot : importedClassRoots) {
          addEntryToMap(importedClassRoot,orderEntry,depEntries);
        }
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        VirtualFile sourceRoot : sourceRoots) {
          addEntryToMap(sourceRoot,orderEntry,depEntries);
        }
      }
 else       if (orderEntry instanceof ModuleSourceOrderEntry) {
        List<OrderEntry> oneEntryList=Arrays.asList(new OrderEntry[]{orderEntry});
        Module entryModule=orderEntry.getOwnerModule();
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        VirtualFile sourceRoot : sourceRoots) {
          fillMapWithOrderEntries(sourceRoot,oneEntryList,entryModule,null,null,forDir,null,null,fileTypeManager);
        }
      }
 else       if (orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry) {
        VirtualFile[] classRoots=orderEntry.getFiles(OrderRootType.CLASSES);
        for (        VirtualFile classRoot : classRoots) {
          addEntryToMap(classRoot,orderEntry,libClassRootEntries);
        }
        VirtualFile[] sourceRoots=orderEntry.getFiles(OrderRootType.SOURCES);
        for (        VirtualFile sourceRoot : sourceRoots) {
          addEntryToMap(sourceRoot,orderEntry,libSourceRootEntries);
        }
      }
    }
    for (    Map.Entry<VirtualFile,List<OrderEntry>> mapEntry : depEntries.entrySet()) {
      final VirtualFile vRoot=mapEntry.getKey();
      final List<OrderEntry> entries=mapEntry.getValue();
      fillMapWithOrderEntries(vRoot,entries,null,null,null,forDir,null,null,fileTypeManager);
    }
    for (    Map.Entry<VirtualFile,List<OrderEntry>> mapEntry : libClassRootEntries.entrySet()) {
      final VirtualFile vRoot=mapEntry.getKey();
      final List<OrderEntry> entries=mapEntry.getValue();
      fillMapWithOrderEntries(vRoot,entries,null,vRoot,null,forDir,null,null,fileTypeManager);
    }
    for (    Map.Entry<VirtualFile,List<OrderEntry>> mapEntry : libSourceRootEntries.entrySet()) {
      final VirtualFile vRoot=mapEntry.getKey();
      final List<OrderEntry> entries=mapEntry.getValue();
      fillMapWithOrderEntries(vRoot,entries,null,null,vRoot,forDir,null,null,fileTypeManager);
    }
  }
  if (progress != null) {
    progress.popState();
  }
}
