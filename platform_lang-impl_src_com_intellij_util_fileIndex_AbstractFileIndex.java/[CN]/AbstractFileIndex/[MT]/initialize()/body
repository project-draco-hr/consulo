{
  final Runnable loadCacheRunnable=new Runnable(){
    public void run(){
      myRootsChangeCacheUpdater=new FileIndexCacheUpdater();
      final ProjectRootManagerEx rootManager=ProjectRootManagerEx.getInstanceEx(myProject);
      rootManager.registerChangeUpdater(myRootsChangeCacheUpdater);
      loadCache();
      buildIndex();
      if (!ApplicationManager.getApplication().isUnitTestMode()) {
        myRefreshCacheUpdater=new FileIndexRefreshCacheUpdater(AbstractFileIndex.this);
      }
    }
  }
;
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    myRefreshCacheUpdater=new FileIndexRefreshCacheUpdater(this);
    loadCacheRunnable.run();
  }
 else {
    StartupManager.getInstance(myProject).registerStartupActivity(loadCacheRunnable);
  }
}
