{
  final StartupManager sm=StartupManager.getInstance(myProject);
  final Runnable startupRunnable=new Runnable(){
    public void run(){
      loadCache();
      sm.registerCacheUpdater(new FileIndexCacheUpdater(true,getFileTypesToRefresh()));
      myRootsChangeCacheUpdater=new FileIndexCacheUpdater(false,null);
      ProjectRootManagerEx.getInstanceEx(myProject).registerRootsChangeUpdater(myRootsChangeCacheUpdater);
      if (!ApplicationManager.getApplication().isUnitTestMode()) {
        myRefreshCacheUpdater=new FileIndexRefreshCacheUpdater(myProject,AbstractFileIndex.this);
      }
    }
  }
;
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    myRefreshCacheUpdater=new FileIndexRefreshCacheUpdater(myProject,this);
    startupRunnable.run();
  }
 else {
    sm.registerStartupActivity(startupRunnable);
  }
}
