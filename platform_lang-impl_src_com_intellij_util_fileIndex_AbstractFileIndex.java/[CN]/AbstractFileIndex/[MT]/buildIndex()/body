{
  final ProgressIndicator indicator=getProgressIndicator();
  if (indicator != null) {
    indicator.pushState();
    indicator.setIndeterminate(false);
    indicator.setText(getBuildingIndicesMessage(myFormatChanged));
    myFormatChanged=false;
  }
  PsiManager.getInstance(myProject).startBatchFilesProcessingMode();
  try {
    final VirtualFile[] files=queryNeededFiles(true,getFileTypesToRefresh());
    for (int i=0; i < files.length; i++) {
      if (indicator != null) {
        indicator.setFraction(((double)i) / files.length);
      }
      doUpdateIndexEntry(files[i]);
    }
  }
  finally {
    PsiManager.getInstance(myProject).finishBatchFilesProcessingMode();
  }
  if (indicator != null) {
    indicator.popState();
  }
}
