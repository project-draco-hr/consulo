{
  if (!element.isValid())   return null;
  Project project=element.getProject();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  if (element instanceof PsiPackage) {
    final PsiDirectory[] directories=((PsiPackage)element).getDirectories();
    for (int idx=0; idx < directories.length; idx++) {
      final Module module=fileIndex.getModuleForFile(directories[idx].getVirtualFile());
      if (module != null) {
        return module;
      }
    }
    return null;
  }
  if (element instanceof PsiFile) {
    VirtualFile vFile=((PsiFile)element).getVirtualFile();
    return vFile != null ? fileIndex.getModuleForFile(vFile) : null;
  }
  if (element instanceof PsiDirectory) {
    final VirtualFile vFile=((PsiDirectory)element).getVirtualFile();
    if (fileIndex.isInLibrarySource(vFile) || fileIndex.isInLibraryClasses(vFile)) {
      final OrderEntry[] orderEntries=fileIndex.getOrderEntriesForFile(vFile);
      if (orderEntries.length == 0) {
        return null;
      }
      Set<Module> modules=new HashSet<Module>();
      for (int j=0; j < orderEntries.length; j++) {
        modules.add(orderEntries[j].getOwnerModule());
      }
      final Module[] candidates=modules.toArray(new Module[modules.size()]);
      Arrays.sort(candidates,ModuleManager.getInstance(project).moduleDependencyComparator());
      return candidates[0];
    }
    return fileIndex.getModuleForFile(vFile);
  }
  final PsiFile containingFile=element.getContainingFile();
  if (containingFile != null) {
    final VirtualFile virtualFile=containingFile.getVirtualFile();
    if (virtualFile != null) {
      return fileIndex.getModuleForFile(virtualFile);
    }
  }
  return null;
}
