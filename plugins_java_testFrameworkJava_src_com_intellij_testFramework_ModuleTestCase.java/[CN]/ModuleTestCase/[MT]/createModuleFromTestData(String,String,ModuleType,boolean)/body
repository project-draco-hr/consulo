{
  final File dirInTestDataFile=new File(dirInTestData);
  assertTrue(dirInTestDataFile.isDirectory());
  final File moduleDir=createTempDirectory();
  FileUtil.copyDir(dirInTestDataFile,moduleDir);
  final Module module=createModule(moduleDir + "/" + newModuleFileName,moduleType);
  final VirtualFile root=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(moduleDir);
  new WriteCommandAction.Simple(module.getProject()){
    @Override protected void run() throws Throwable {
      root.refresh(false,true);
    }
  }
.execute().throwException();
  if (addSourceRoot) {
    PsiTestUtil.addSourceContentToRoots(module,root);
  }
 else {
    PsiTestUtil.addContentRoot(module,root);
  }
  return module;
}
