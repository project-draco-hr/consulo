{
  final LibraryTable libraryTable=ProjectLibraryTable.getInstance(myProject);
  Library lib=ApplicationManager.getApplication().runWriteAction(new Computable<Library>(){
    @Override public Library compute(){
      return libraryTable.createLibrary("LIB");
    }
  }
);
  ModuleRootModificationUtil.addDependency(myModule,lib);
  final JavaPsiFacade manager=getJavaFacade();
  assertNull(manager.findClass("pack.MyClass",GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(myModule)));
  final ModifiableRootModel rootModel2=ModuleRootManager.getInstance(myModule).getModifiableModel();
  assertNotNull(rootModel2.findLibraryOrderEntry(lib));
  final File file=new File(PathManagerEx.getTestDataPath() + "/psi/repositoryUse/cls");
  final VirtualFile root=ApplicationManager.getApplication().runWriteAction(new Computable<VirtualFile>(){
    @Override public VirtualFile compute(){
      return LocalFileSystem.getInstance().refreshAndFindFileByIoFile(file);
    }
  }
);
  assertNotNull(root);
  final Library.ModifiableModel modifyableModel=lib.getModifiableModel();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      modifyableModel.addRoot(root,OrderRootType.CLASSES);
      modifyableModel.commit();
    }
  }
);
  final PsiClass aClass=manager.findClass("pack.MyClass",GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(myModule));
  assertNotNull(aClass);
  assertTrue(Arrays.asList(rootModel2.orderEntries().librariesOnly().classes().getRoots()).contains(root));
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      rootModel2.commit();
    }
  }
);
  final PsiClass aClass1=manager.findClass("pack.MyClass",GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(myModule));
  assertNotNull(aClass1);
}
