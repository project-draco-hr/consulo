{
  final VirtualFile file=FileDocumentManager.getInstance().getFile(editor.getDocument());
  if (project == null)   return;
  AbstractVcs vcs=ProjectLevelVcsManager.getInstance(project).getVcsFor(file);
  if (vcs == null)   return;
  final AnnotationProvider annotationProvider=vcs.getAnnotationProvider();
  final Ref<FileAnnotation> fileAnnotationRef=new Ref<FileAnnotation>();
  final Ref<VcsException> exceptionRef=new Ref<VcsException>();
  boolean result=ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    public void run(){
      try {
        fileAnnotationRef.set(annotationProvider.annotate(file));
      }
 catch (      VcsException e) {
        exceptionRef.set(e);
      }
    }
  }
,VcsBundle.message("retrieving.annotations"),true,project);
  if (!result) {
    return;
  }
  if (!exceptionRef.isNull()) {
    AbstractVcsHelper.getInstance(project).showErrors(Arrays.asList(exceptionRef.get()),VcsBundle.message("message.title.annotate"));
  }
  if (fileAnnotationRef.isNull()) {
    return;
  }
  doAnnotate(editor,project,file,fileAnnotationRef.get());
}
