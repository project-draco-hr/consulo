{
  String upToDateContent=fileAnnotation.getAnnotatedContent();
  final UpToDateLineNumberProvider getUpToDateLineNumber=new UpToDateLineNumberProviderImpl(editor.getDocument(),project,upToDateContent);
  editor.getGutter().closeAllAnnotations();
  Collection<AnnotationFieldGutter> annotations=editor.getUserData(KEY_IN_EDITOR);
  if (annotations == null) {
    annotations=new HashSet<AnnotationFieldGutter>();
    editor.putUserData(KEY_IN_EDITOR,annotations);
  }
  final HighlightAnnotationsActions highlighting=new HighlightAnnotationsActions(project,file,fileAnnotation,((EditorGutterComponentEx)editor.getGutter()));
  final LineAnnotationAspect[] aspects=fileAnnotation.getAspects();
  for (  LineAnnotationAspect aspect : aspects) {
    final AnnotationFieldGutter gutter=new AnnotationFieldGutter(getUpToDateLineNumber,fileAnnotation,editor,aspect,highlighting);
    if (aspect instanceof EditorGutterAction) {
      editor.getGutter().registerTextAnnotation(gutter,gutter);
    }
 else {
      editor.getGutter().registerTextAnnotation(gutter);
    }
    annotations.add(gutter);
  }
}
