{
  final PsiFile file=psi.getContainingFile();
  if (file != null && file != file.getOriginalFile()) {
    final Document document=file.getViewProvider().getDocument();
    if (document != null) {
      final List<DocumentEvent> translator=document.getUserData(RANGE_TRANSLATION);
      if (translator != null) {
        TextRange range=psi.getTextRange();
        Integer start=range.getStartOffset();
        Integer end=range.getEndOffset();
        for (        DocumentEvent event : translator) {
          start=translateOffset(range.getStartOffset(),event);
          end=translateOffset(range.getEndOffset(),event);
          if (start == null || end == null) {
            return null;
          }
        }
        return (T)PsiTreeUtil.findElementOfClassAtRange(file.getOriginalFile(),start,end,psi.getClass());
      }
    }
  }
  return psi;
}
