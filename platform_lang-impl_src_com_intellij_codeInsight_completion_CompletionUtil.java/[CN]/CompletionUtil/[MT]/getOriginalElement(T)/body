{
  final PsiFile file=psi.getContainingFile();
  if (file != null && file != file.getOriginalFile() && psi.getTextRange() != null) {
    TextRange range=psi.getTextRange();
    Integer start=range.getStartOffset();
    Integer end=range.getEndOffset();
    final Document document=file.getViewProvider().getDocument();
    if (document != null) {
      Document hostDocument=document instanceof DocumentWindowImpl ? ((DocumentWindowImpl)document).getDelegate() : document;
      OffsetTranslator translator=hostDocument.getUserData(RANGE_TRANSLATION);
      if (translator != null) {
        if (document instanceof DocumentWindowImpl) {
          ProperTextRange translated=((DocumentWindowImpl)document).injectedToHost(new TextRange(start,end));
          start=translated.getStartOffset();
          end=translated.getEndOffset();
        }
        start=translator.translateOffset(start);
        end=translator.translateOffset(end);
        if (start == null || end == null) {
          return null;
        }
        if (document instanceof DocumentWindowImpl) {
          start=((DocumentWindowImpl)document).hostToInjected(start);
          end=((DocumentWindowImpl)document).hostToInjected(end);
        }
      }
    }
    return (T)PsiTreeUtil.findElementOfClassAtRange(file.getOriginalFile(),start,end,psi.getClass());
  }
  return psi;
}
