{
  final PsiFile file=psi.getContainingFile();
  if (file != null && file != file.getOriginalFile() && psi.getTextRange() != null) {
    TextRange range=psi.getTextRange();
    Integer start=range.getStartOffset();
    Integer end=range.getEndOffset();
    final Document document=file.getViewProvider().getDocument();
    if (document != null) {
      final OffsetTranslator translator=document.getUserData(RANGE_TRANSLATION);
      if (translator != null) {
        start=translator.translateOffset(start);
        end=translator.translateOffset(end);
        if (start == null || end == null) {
          return null;
        }
      }
    }
    return (T)PsiTreeUtil.findElementOfClassAtRange(file.getOriginalFile(),start,end,psi.getClass());
  }
  return psi;
}
