{
  indicator.checkCanceled();
  PolicyData cachedData=getFromCache(request,config,stamp1,stamp2);
  List<LineFragment> newFragments;
  if (cachedData != null) {
    if (cachedData.getFragments().isEmpty())     return cachedData.getFragments();
    if (!config.innerFragments)     return cachedData.getFragments();
    if (cachedData.isInnerFragments())     return cachedData.getFragments();
    newFragments=ComparisonManager.getInstance().compareLinesInner(text1,text2,cachedData.getFragments(),config.policy,indicator);
  }
 else {
    if (config.innerFragments) {
      newFragments=ComparisonManager.getInstance().compareLinesInner(text1,text2,config.policy,indicator);
    }
 else {
      newFragments=ComparisonManager.getInstance().compareLines(text1,text2,config.policy,indicator);
    }
  }
  indicator.checkCanceled();
  putToCache(request,config,stamp1,stamp2,newFragments,config.innerFragments);
  return newFragments;
}
