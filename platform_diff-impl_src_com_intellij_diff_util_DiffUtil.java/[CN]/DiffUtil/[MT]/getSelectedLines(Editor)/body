{
  Document document=editor.getDocument();
  int totalLines=getLineCount(document);
  BitSet lines=new BitSet(totalLines + 1);
  for (  Caret caret : editor.getCaretModel().getAllCarets()) {
    if (caret.hasSelection()) {
      int line1=editor.offsetToLogicalPosition(caret.getSelectionStart()).line;
      int line2=editor.offsetToLogicalPosition(caret.getSelectionEnd()).line;
      lines.set(line1,line2 + 1);
      if (caret.getSelectionEnd() == document.getTextLength())       lines.set(totalLines);
    }
 else {
      lines.set(caret.getLogicalPosition().line);
      if (caret.getOffset() == document.getTextLength())       lines.set(totalLines);
    }
  }
  return lines;
}
