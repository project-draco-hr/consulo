{
  myContext.getProgressIndicator().setText(CompilerBundle.message("packaging.compiler.message.building.0",jar.getPresentableDestination()));
  File jarFile=FileUtil.createTempFile("artifactCompiler","tmp");
  myBuiltJars.put(jar,jarFile);
  FileUtil.createParentDirs(jarFile);
  final JarOutputStream jarOutputStream=new JarOutputStream(new BufferedOutputStream(new FileOutputStream(jarFile)));
  try {
    final THashSet<String> writtenPaths=new THashSet<String>();
    for (    Pair<String,VirtualFile> pair : jar.getPackedFiles()) {
      File file=VfsUtil.virtualToIoFile(pair.getSecond());
      addFileToJar(jarOutputStream,file,pair.getFirst(),writtenPaths);
    }
    for (    Pair<String,JarInfo> nestedJar : jar.getPackedJars()) {
      File nestedJarFile=myBuiltJars.get(nestedJar.getSecond());
      addFileToJar(jarOutputStream,nestedJarFile,nestedJar.getFirst(),writtenPaths);
    }
  }
  finally {
    jarOutputStream.close();
  }
}
