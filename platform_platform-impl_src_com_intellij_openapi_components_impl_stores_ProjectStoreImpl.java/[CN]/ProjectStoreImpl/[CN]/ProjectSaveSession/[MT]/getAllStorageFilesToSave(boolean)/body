{
  List<IFile> result=new ArrayList<IFile>();
  boolean subStructuresSave=false;
  if (includingSubStructures) {
    collectSubfilesToSave(result);
    subStructuresSave=!result.isEmpty();
  }
  final StateStorage.SaveSession defaultSaveSession=myStorageManagerSaveSession.getSaveSession(DEFAULT_STATE_STORAGE);
  if (defaultSaveSession instanceof FileBasedStorage.FileSaveSession) {
    final FileBasedStorage.FileSaveSession session=(FileBasedStorage.FileSaveSession)defaultSaveSession;
    if (subStructuresSave) {
      updateUsedMacros();
      session.clearHash();
    }
 else     if (shouldUpdateMacros()) {
      updateUsedMacros();
    }
  }
  result.addAll(super.getAllStorageFilesToSave(false));
  return result;
}
