{
  PsiReference ref=findReference(editor,offset);
  if (ref == null)   return null;
  final Language language=ref.getElement().getLanguage();
  final TargetElementEvaluator evaluator=targetElementEvaluator.forLanguage(language);
  if (evaluator != null) {
    final PsiElement element=evaluator.getElementByReference(ref,flags);
    if (element != null)     return element;
  }
  PsiManager manager=file.getManager();
  PsiElement refElement=ref.resolve();
  if (refElement == null) {
    if (ApplicationManager.getApplication().isDispatchThread()) {
      DaemonCodeAnalyzer.getInstance(manager.getProject()).updateVisibleHighlighters(editor);
    }
    return null;
  }
 else {
    return refElement;
  }
}
