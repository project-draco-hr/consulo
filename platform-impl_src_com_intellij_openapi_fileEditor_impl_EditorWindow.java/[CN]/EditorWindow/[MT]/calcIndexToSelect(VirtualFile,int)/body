{
  final int currentlySelectedIndex=myTabbedPane.getSelectedIndex();
  if (currentlySelectedIndex != fileIndex) {
    return fileIndex < currentlySelectedIndex ? currentlySelectedIndex - 1 : -1;
  }
  if (UISettings.getInstance().ACTIVATE_MRU_EDITOR_ON_CLOSE) {
    final VirtualFile[] histFiles=EditorHistoryManager.getInstance(getManager().getProject()).getFiles();
    for (int idx=histFiles.length - 1; idx >= 0; idx--) {
      final VirtualFile histFile=histFiles[idx];
      if (histFile.equals(fileBeingClosed)) {
        continue;
      }
      final EditorWithProviderComposite editor=findFileComposite(histFile);
      if (editor == null) {
        continue;
      }
      final int histFileIndex=findComponentIndex(editor.getComponent());
      if (histFileIndex >= 0) {
        return fileIndex < histFileIndex ? histFileIndex - 1 : histFileIndex;
      }
    }
  }
  if (fileIndex > 0) {
    return fileIndex - 1;
  }
  return -1;
}
