{
  final Project project=context.project;
  final String newPrefix=new WriteCommandAction<String>(project){
    protected void run(    Result<String> result) throws Throwable {
      if (isAutocompleteCommonPrefixOnInvocation() && items.length > 1) {
        result.setResult(fillInCommonPrefix(items,prefix,context.editor));
      }
 else {
        result.setResult(prefix);
      }
      PsiDocumentManager.getInstance(project).commitAllDocuments();
    }
  }
.execute().getResultObject();
  if (!newPrefix.equals(prefix)) {
    lookup.setPrefix(newPrefix);
    context.editor.getCaretModel().moveToOffset(offset1 - prefix.length() + newPrefix.length());
    context.setPrefix(newPrefix);
    context.editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  }
}
