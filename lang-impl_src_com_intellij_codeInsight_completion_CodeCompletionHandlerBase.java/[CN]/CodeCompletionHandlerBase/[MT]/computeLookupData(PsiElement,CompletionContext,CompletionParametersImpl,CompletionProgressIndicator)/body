{
  final Collection<LookupElement> lookupSet=new LinkedHashSet<LookupElement>();
  CompletionService.getCompletionService().performAsyncCompletion(myCompletionType,parameters,new AsyncConsumer<LookupElement>(){
    public void consume(    final LookupElement lookupElement){
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          if (lookupSet.add(lookupElement)) {
            indicator.addItem((LookupItem)lookupElement);
          }
        }
      }
);
    }
  }
);
  final LookupItem[] items=lookupSet.toArray(new LookupItem[lookupSet.size()]);
  final LookupData data=ApplicationManager.getApplication().runReadAction(new Computable<LookupData>(){
    public LookupData compute(){
      return createLookupData(context,items,insertedElement);
    }
  }
);
  data.itemPreferencePolicy=new CompletionPreferencePolicy(context.getPrefix(),parameters);
  return data;
}
