{
  final InsertHandler handler;
  if (item.getInsertHandler() == null) {
    handler=new InsertHandler(){
      public void handleInsert(      final CompletionContext context,      final int startOffset,      final LookupData data,      final LookupItem item,      final boolean signatureSelected,      final char completionChar){
        final int idEndOffset=context.getOffsetMap().getOffset(CompletionInitializationContext.IDENTIFIER_END_OFFSET);
        if (idEndOffset != context.getSelectionEndOffset() && CompletionUtil.isOverwrite(item,completionChar)) {
          context.editor.getDocument().deleteString(context.getSelectionEndOffset(),idEndOffset);
        }
        item.getTailType().processTail(context.editor,context.editor.getCaretModel().getOffset());
      }
    }
;
  }
 else {
    handler=item.getInsertHandler();
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      PsiDocumentManager.getInstance(context.project).commitAllDocuments();
      context.setPrefix(data.prefix);
      final PsiElement position=context.file.findElementAt(context.getStartOffset() + item.getLookupString().length() - 1);
      analyseItem(item,position,context);
      handler.handleInsert(context,context.getStartOffset(),data,item,signatureSelected,completionChar);
    }
  }
);
}
