{
  final InsertHandler handler=item.getInsertHandler() != null ? item.getInsertHandler() : new BasicInsertHandler(){
    public void handleInsert(    final CompletionContext context,    final int startOffset,    final LookupData data,    final LookupItem item,    final boolean signatureSelected,    final char completionChar){
      super.handleInsert(context,startOffset,data,item,signatureSelected,completionChar);
      item.getTailType().processTail(context.editor,context.editor.getCaretModel().getOffset());
    }
  }
;
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      PsiDocumentManager.getInstance(context.project).commitAllDocuments();
      context.setPrefix(data.prefix);
      final PsiElement position=context.file.findElementAt(context.getStartOffset() + item.getLookupString().length() - 1);
      analyseItem(item,position,context);
      handler.handleInsert(context,context.getStartOffset(),data,item,signatureSelected,completionChar);
    }
  }
);
}
