{
  (new Task.ConditionalModal(myProject,HgVcsMessages.message("hg4idea.add.progress"),false,VcsConfiguration.getInstance(myProject).getAddRemoveOption()){
    @Override public void run(    @NotNull ProgressIndicator aProgressIndicator){
      final ArrayList<VirtualFile> adds=new ArrayList<VirtualFile>();
      final HashMap<VirtualFile,VirtualFile> copies=new HashMap<VirtualFile,VirtualFile>();
      for (      VirtualFile file : addedFiles) {
        if (file.isDirectory()) {
          continue;
        }
        final VirtualFile copyFrom=copyFromMap.get(file);
        if (copyFrom != null) {
          copies.put(copyFrom,file);
        }
 else {
          adds.add(file);
        }
      }
      if (!adds.isEmpty()) {
        new HgAddCommand(myProject).execute(adds);
      }
      if (!copies.isEmpty()) {
        for (        Map.Entry<VirtualFile,VirtualFile> copy : copies.entrySet()) {
          new HgCopyCommand(myProject).execute(copy.getKey(),copy.getValue());
        }
      }
      for (      VirtualFile file : addedFiles) {
        dirtyScopeManager.fileDirty(file);
      }
    }
  }
).queue();
}
