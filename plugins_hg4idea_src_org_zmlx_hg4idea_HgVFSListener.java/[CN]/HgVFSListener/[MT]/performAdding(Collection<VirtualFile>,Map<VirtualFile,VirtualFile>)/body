{
  (new Task.ConditionalModal(myProject,HgVcsMessages.message("hg4idea.add.progress"),false,VcsConfiguration.getInstance(myProject).getAddRemoveOption()){
    @Override public void run(    @NotNull ProgressIndicator aProgressIndicator){
      final ArrayList<HgFile> adds=new ArrayList<HgFile>();
      final HashMap<HgFile,HgFile> copies=new HashMap<HgFile,HgFile>();
      for (      VirtualFile file : addedFiles) {
        if (file.isDirectory()) {
          continue;
        }
        final VirtualFile copyFrom=copyFromMap.get(file);
        if (copyFrom != null) {
          copies.put(new HgFile(myProject,copyFrom),new HgFile(myProject,file));
        }
 else {
          adds.add(new HgFile(myProject,file));
        }
      }
      if (!adds.isEmpty()) {
        new HgAddCommand(myProject).execute(adds);
      }
      if (!copies.isEmpty()) {
        for (        Map.Entry<HgFile,HgFile> copy : copies.entrySet()) {
          new HgCopyCommand(myProject).execute(copy.getKey(),copy.getValue());
        }
      }
      for (      VirtualFile file : addedFiles) {
        dirtyScopeManager.fileDirty(file);
      }
    }
  }
).queue();
}
