{
  final LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(editor);
  if (lookup == null) {
    throw new AssertionError("The last lookup disposed at: " + LookupImpl.getLastLookupDisposeTrace() + "\n-----------------------\n");
  }
  if (finishingChar == Lookup.NORMAL_SELECT_CHAR) {
    if (!lookup.isFocused()) {
      FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_CONTROL_ENTER);
    }
  }
 else   if (finishingChar == Lookup.COMPLETE_STATEMENT_SELECT_CHAR) {
    FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_FINISH_BY_SMART_ENTER);
  }
 else   if (finishingChar == Lookup.REPLACE_SELECT_CHAR) {
    FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_REPLACE);
  }
 else   if (finishingChar == '.') {
    FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_FINISH_BY_CONTROL_DOT);
  }
  lookup.uninstallPreview();
  Runnable command=new Runnable(){
    @Override public void run(){
      lookup.finishLookup(finishingChar);
    }
  }
;
  Document doc=editor.getDocument();
  DocCommandGroupId group=DocCommandGroupId.noneGroupId(doc);
  CommandProcessor.getInstance().executeCommand(editor.getProject(),command,"Completion",group,UndoConfirmationPolicy.DEFAULT,doc);
}
