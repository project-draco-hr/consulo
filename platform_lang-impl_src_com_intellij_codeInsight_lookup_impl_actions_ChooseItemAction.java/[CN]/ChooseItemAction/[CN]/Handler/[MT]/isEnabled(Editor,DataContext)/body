{
  LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(editor);
  if (lookup == null)   return false;
  if (!lookup.isAvailableToUser())   return false;
  if (focusedOnly && !CompletionPreview.hasPreview(lookup) && !lookup.isFocused())   return false;
  if (finishingChar == Lookup.NORMAL_SELECT_CHAR && hasTemplatePrefix(lookup,TemplateSettings.ENTER_CHAR) || finishingChar == Lookup.REPLACE_SELECT_CHAR && hasTemplatePrefix(lookup,TemplateSettings.TAB_CHAR)) {
    return false;
  }
  if (finishingChar == Lookup.REPLACE_SELECT_CHAR) {
    if (lookup.isFocused()) {
      return true;
    }
    return !lookup.getItems().isEmpty();
  }
  return true;
}
