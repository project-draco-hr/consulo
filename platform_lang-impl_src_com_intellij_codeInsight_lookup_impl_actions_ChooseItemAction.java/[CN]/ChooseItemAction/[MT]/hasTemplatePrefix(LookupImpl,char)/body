{
  lookup.refreshUi(false,false);
  CompletionProcess completion=CompletionService.getCompletionService().getCurrentCompletion();
  if (completion == null || !completion.isAutopopupCompletion()) {
    return false;
  }
  if (lookup.isSelectionTouched()) {
    return false;
  }
  final PsiFile file=lookup.getPsiFile();
  if (file == null)   return false;
  final Editor editor=lookup.getEditor();
  final int offset=editor.getCaretModel().getOffset();
  PsiDocumentManager.getInstance(file.getProject()).commitDocument(editor.getDocument());
  final LiveTemplateLookupElement liveTemplateLookup=ContainerUtil.findInstance(lookup.getItems(),LiveTemplateLookupElement.class);
  if (liveTemplateLookup == null || !liveTemplateLookup.sudden) {
    if (LiveTemplateCompletionContributor.customTemplateAvailableAndHasCompletionItem(shortcutChar,editor,file,offset)) {
      return true;
    }
    List<TemplateImpl> templates=TemplateManagerImpl.listApplicableTemplateWithInsertingDummyIdentifier(editor,file,false);
    TemplateImpl template=LiveTemplateCompletionContributor.findFullMatchedApplicableTemplate(editor,offset,templates);
    if (template != null && shortcutChar == TemplateSettings.getInstance().getShortcutChar(template)) {
      return true;
    }
    return false;
  }
  return liveTemplateLookup.getTemplateShortcut() == shortcutChar;
}
