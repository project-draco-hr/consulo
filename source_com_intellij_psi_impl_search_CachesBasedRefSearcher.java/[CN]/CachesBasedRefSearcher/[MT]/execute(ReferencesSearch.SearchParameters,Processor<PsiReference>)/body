{
  final PsiElement refElement=p.getElementToSearch();
  String text=null;
  if (refElement instanceof XmlAttributeValue) {
    text=((XmlAttributeValue)refElement).getValue();
  }
 else   if (refElement instanceof PsiFile) {
    final VirtualFile vFile=((PsiFile)refElement).getVirtualFile();
    if (vFile != null) {
      text=vFile.getNameWithoutExtension();
    }
  }
 else   if (refElement instanceof PsiNamedElement) {
    text=((PsiNamedElement)refElement).getName();
  }
  if (text == null && refElement instanceof PsiMetaBaseOwner) {
    final PsiMetaDataBase metaData=((PsiMetaBaseOwner)refElement).getMetaData();
    if (metaData != null)     text=metaData.getName();
  }
  if (text == null)   return true;
  SearchScope searchScope=p.getEffectiveSearchScope();
  final TextOccurenceProcessor processor=new TextOccurenceProcessor(){
    public boolean execute(    PsiElement element,    int offsetInElement){
      final PsiReference[] refs=element.getReferences();
      for (      PsiReference ref : refs) {
        if (ref.getRangeInElement().contains(offsetInElement)) {
          if (ref.isReferenceTo(refElement)) {
            return consumer.process(ref);
          }
        }
      }
      return true;
    }
  }
;
  short searchContext;
  if (refElement instanceof XmlEntityDecl) {
    searchContext=UsageSearchContext.IN_PLAIN_TEXT;
  }
 else {
    searchContext=UsageSearchContext.IN_CODE | UsageSearchContext.IN_FOREIGN_LANGUAGES | UsageSearchContext.IN_COMMENTS;
  }
  final PsiSearchHelper helper=PsiManager.getInstance(refElement.getProject()).getSearchHelper();
  if (!helper.processElementsWithWord(processor,searchScope,text,searchContext,refElement.getLanguage() == StdLanguages.JAVA)) {
    return false;
  }
  return true;
}
