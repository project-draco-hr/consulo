{
  final Project project=context.getProject();
  final MavenProjectsManager mavenProjectManager=MavenProjectsManager.getInstance(project);
  if (!mavenProjectManager.isMavenizedProject())   return ProcessingItem.EMPTY_ARRAY;
  return new ReadAction<ProcessingItem[]>(){
    protected void run(    Result<ProcessingItem[]> resultObject) throws Throwable {
      List<ProcessingItem> allItemsToProcess=new ArrayList<ProcessingItem>();
      List<String> filesToDelete=new ArrayList<String>();
      for (      Module eachModule : context.getCompileScope().getAffectedModules()) {
        MavenProject mavenProject=mavenProjectManager.findProject(eachModule);
        if (mavenProject == null)         continue;
        Properties properties=loadPropertiesAndFilters(context,mavenProject);
        List<String> nonFilteredExtensions=collectNonFilteredExtensions(mavenProject);
        String escapeString=MavenJDOMUtil.findChildValueByPath(mavenProject.getPluginConfiguration("org.apache.maven.plugins","maven-resources-plugin"),"escapeString","\\");
        long propertiesHashCode=calculateHashCode(mavenProject,properties);
        List<ProcessingItem> moduleItemsToProcess=new ArrayList<ProcessingItem>();
        collectProcessingItems(eachModule,mavenProject,context,properties,propertiesHashCode,nonFilteredExtensions,escapeString,false,moduleItemsToProcess);
        collectProcessingItems(eachModule,mavenProject,context,properties,propertiesHashCode,nonFilteredExtensions,escapeString,true,moduleItemsToProcess);
        collectItemsToDelete(eachModule,moduleItemsToProcess,filesToDelete);
        allItemsToProcess.addAll(moduleItemsToProcess);
      }
      if (!filesToDelete.isEmpty()) {
        allItemsToProcess.add(new FakeProcessingItem());
      }
      context.putUserData(FILES_TO_DELETE_KEY,filesToDelete);
      resultObject.setResult(allItemsToProcess.toArray(new ProcessingItem[allItemsToProcess.size()]));
      removeObsoleteModulesFromCache(project);
      saveCache(project);
    }
  }
.execute().getResultObject();
}
