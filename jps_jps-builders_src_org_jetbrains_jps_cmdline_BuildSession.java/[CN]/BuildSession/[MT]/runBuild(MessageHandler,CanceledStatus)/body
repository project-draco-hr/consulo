{
  final File dataStorageRoot=Utils.getDataStorageRoot(myProjectPath);
  if (dataStorageRoot == null) {
    msgHandler.processMessage(new CompilerMessage("build",BuildMessage.Kind.ERROR,"Cannot determine build data storage root for project " + myProjectPath));
    return;
  }
  if (!dataStorageRoot.exists()) {
    myBuildRunner.setForceCleanCaches(true);
  }
  final DataInputStream fsStateStream=createFSDataStream(dataStorageRoot);
  if (fsStateStream != null) {
    final boolean hasWorkToDoWithModules=fsStateStream.readBoolean();
    if (!myForceModelLoading && (myBuildType == BuildType.BUILD || myBuildType == BuildType.UP_TO_DATE_CHECK) && !hasWorkToDoWithModules&& scopeContainsModulesOnlyForIncrementalMake(myBuildRunner.getScopes())&& !containsChanges(myInitialFSDelta)) {
      updateFsStateOnDisk(dataStorageRoot,fsStateStream,myInitialFSDelta.getOrdinal());
      return;
    }
  }
  final BuildFSState fsState=new BuildFSState(false);
  try {
    final ProjectDescriptor pd=myBuildRunner.load(msgHandler,dataStorageRoot,fsState);
    myProjectDescriptor=pd;
    if (fsStateStream != null) {
      try {
        try {
          fsState.load(fsStateStream,pd.getModel(),pd.getBuildRootIndex());
          applyFSEvent(pd,myInitialFSDelta,false);
        }
  finally {
          fsStateStream.close();
        }
      }
 catch (      Throwable e) {
        LOG.error(e);
        fsState.clearAll();
      }
    }
    myLastEventOrdinal=myInitialFSDelta != null ? myInitialFSDelta.getOrdinal() : 0L;
    myInitialFSDelta=null;
    myEventsProcessor.startProcessing();
    myBuildRunner.runBuild(pd,cs,myConstantSearch,msgHandler,myBuildType);
  }
  finally {
    saveData(fsState,dataStorageRoot);
  }
}
