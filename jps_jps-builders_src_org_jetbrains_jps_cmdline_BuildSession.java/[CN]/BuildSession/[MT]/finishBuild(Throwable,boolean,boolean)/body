{
  CmdlineRemoteProto.Message lastMessage=null;
  try {
    if (error != null) {
      Throwable cause=error.getCause();
      if (cause == null) {
        cause=error;
      }
      final ByteArrayOutputStream out=new ByteArrayOutputStream();
      cause.printStackTrace(new PrintStream(out));
      final StringBuilder messageText=new StringBuilder();
      messageText.append("Internal error: (").append(cause.getClass().getName()).append(") ").append(cause.getMessage());
      final String trace=out.toString();
      if (!trace.isEmpty()) {
        messageText.append("\n").append(trace);
      }
      lastMessage=CmdlineProtoUtil.toMessage(mySessionId,CmdlineProtoUtil.createFailure(messageText.toString(),cause));
    }
 else {
      CmdlineRemoteProto.Message.BuilderMessage.BuildEvent.Status status=CmdlineRemoteProto.Message.BuilderMessage.BuildEvent.Status.SUCCESS;
      if (myCanceled) {
        status=CmdlineRemoteProto.Message.BuilderMessage.BuildEvent.Status.CANCELED;
      }
 else       if (hadBuildErrors) {
        status=CmdlineRemoteProto.Message.BuilderMessage.BuildEvent.Status.ERRORS;
      }
 else       if (!markedUptodateFiles) {
        status=CmdlineRemoteProto.Message.BuilderMessage.BuildEvent.Status.UP_TO_DATE;
      }
      lastMessage=CmdlineProtoUtil.toMessage(mySessionId,CmdlineProtoUtil.createBuildCompletedEvent("build completed",status));
    }
  }
 catch (  Throwable e) {
    lastMessage=CmdlineProtoUtil.toMessage(mySessionId,CmdlineProtoUtil.createFailure(e.getMessage(),e));
  }
 finally {
    Channels.write(myChannel,lastMessage).addListener(new ChannelFutureListener(){
      public void operationComplete(      ChannelFuture future) throws Exception {
        SharedThreadPool.INSTANCE.submit(new Runnable(){
          @Override public void run(){
            final ChannelFuture closeFuture=myChannel.close();
            closeFuture.awaitUninterruptibly();
          }
        }
);
      }
    }
);
  }
}
