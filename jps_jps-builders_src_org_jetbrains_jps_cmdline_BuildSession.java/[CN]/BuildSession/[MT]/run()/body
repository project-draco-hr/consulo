{
  Throwable error=null;
  final Ref<Boolean> hasErrors=new Ref<Boolean>(false);
  final Ref<Boolean> doneSomething=new Ref<Boolean>(false);
  try {
    ProfilingHelper profilingHelper=null;
    if (Utils.IS_PROFILING_MODE) {
      profilingHelper=new ProfilingHelper();
      profilingHelper.startProfiling();
    }
    runBuild(new MessageHandler(){
      public void processMessage(      BuildMessage buildMessage){
        final CmdlineRemoteProto.Message.BuilderMessage response;
        if (buildMessage instanceof FileGeneratedEvent) {
          final Collection<Pair<String,String>> paths=((FileGeneratedEvent)buildMessage).getPaths();
          response=!paths.isEmpty() ? CmdlineProtoUtil.createFileGeneratedEvent(paths) : null;
        }
 else         if (buildMessage instanceof DoneSomethingNotification) {
          doneSomething.set(true);
          response=null;
        }
 else         if (buildMessage instanceof CompilerMessage) {
          doneSomething.set(true);
          final CompilerMessage compilerMessage=(CompilerMessage)buildMessage;
          final String compilerName=compilerMessage.getCompilerName();
          final String text=!StringUtil.isEmptyOrSpaces(compilerName) ? compilerName + ": " + compilerMessage.getMessageText() : compilerMessage.getMessageText();
          final BuildMessage.Kind kind=compilerMessage.getKind();
          if (kind == BuildMessage.Kind.ERROR) {
            hasErrors.set(true);
          }
          response=CmdlineProtoUtil.createCompileMessage(kind,text,compilerMessage.getSourcePath(),compilerMessage.getProblemBeginOffset(),compilerMessage.getProblemEndOffset(),compilerMessage.getProblemLocationOffset(),compilerMessage.getLine(),compilerMessage.getColumn(),-1.0f);
        }
 else         if (buildMessage instanceof CustomBuilderMessage) {
          CustomBuilderMessage builderMessage=(CustomBuilderMessage)buildMessage;
          response=CmdlineProtoUtil.createCustomBuilderMessage(builderMessage.getBuilderId(),builderMessage.getMessageType(),builderMessage.getMessageText());
        }
 else         if (!(buildMessage instanceof BuildingTargetProgressMessage)) {
          float done=-1.0f;
          if (buildMessage instanceof ProgressMessage) {
            done=((ProgressMessage)buildMessage).getDone();
          }
          response=CmdlineProtoUtil.createCompileProgressMessageResponse(buildMessage.getMessageText(),done);
        }
 else {
          response=null;
        }
        if (response != null) {
          Channels.write(myChannel,CmdlineProtoUtil.toMessage(mySessionId,response));
        }
      }
    }
,this);
    if (profilingHelper != null) {
      profilingHelper.stopProfiling();
    }
  }
 catch (  Throwable e) {
    LOG.info(e);
    error=e;
  }
 finally {
    finishBuild(error,hasErrors.get(),doneSomething.get());
  }
}
