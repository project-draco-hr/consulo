{
  final ProjectDescriptor pd=myProjectDescriptor;
  final File file=new File(dataStorageRoot,FS_STATE_FILE);
  try {
    final BufferExposingByteArrayOutputStream bytes=new BufferExposingByteArrayOutputStream();
    final DataOutputStream out=new DataOutputStream(bytes);
    try {
      out.writeInt(FSState.VERSION);
      out.writeLong(myLastEventOrdinal);
      boolean hasWorkToDo=state.hasWorkToDo();
      if (!hasWorkToDo) {
        for (        JpsModule module : pd.jpsProject.getModules()) {
          for (          JavaModuleBuildTargetType type : JavaModuleBuildTargetType.ALL_TYPES) {
            ModuleBuildTarget target=new ModuleBuildTarget(module,type);
            if (!state.isInitialScanPerformed(target)) {
              hasWorkToDo=true;
              break;
            }
          }
          if (hasWorkToDo) {
            break;
          }
        }
      }
      out.writeBoolean(hasWorkToDo);
      state.save(out);
    }
  finally {
      out.close();
    }
    saveOnDisk(bytes,file);
  }
 catch (  Throwable e) {
    LOG.error(e);
    FileUtil.delete(file);
  }
}
