{
  myNewMarkup.ranges.clear();
  myOldMarkup.document=beforeDocument;
  myNewMarkup.document=currentDocument;
  List<LineFragment> lineFragments=myCompareProcessor.process(beforeDocument.getText(),currentDocument.getText());
  for (Iterator<LineFragment> iterator=lineFragments.iterator(); iterator.hasNext(); ) {
    LineFragment fragment=iterator.next();
    final FragmentHighlighterImpl fragmentHighlighter=new FragmentHighlighterImpl(myOldMarkup,myNewMarkup,!iterator.hasNext());
    fragment.highlight(fragmentHighlighter);
  }
  return new ArrayList<TextRange>(myNewMarkup.ranges);
}
