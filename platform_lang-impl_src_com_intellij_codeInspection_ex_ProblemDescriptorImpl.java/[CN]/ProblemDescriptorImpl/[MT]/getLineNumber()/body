{
  PsiElement psiElement=getPsiElement();
  if (psiElement == null)   return -1;
  if (!psiElement.isValid())   return -1;
  LOG.assertTrue(psiElement.isPhysical());
  PsiFile containingFile=psiElement.getContainingFile();
  PsiElement containingFileContext=containingFile.getContext();
  if (containingFileContext != null) {
    containingFile=containingFileContext.getContainingFile();
  }
  Document document=PsiDocumentManager.getInstance(psiElement.getProject()).getDocument(containingFile);
  if (document == null)   return -1;
  TextRange textRange=getTextRange();
  if (textRange == null)   return -1;
  if (containingFileContext != null) {
    textRange=textRange.shiftRight(PsiUtilBase.findInjectedElementOffsetInRealDocument(psiElement));
  }
  return document.getLineNumber(textRange.getStartOffset()) + 1;
}
