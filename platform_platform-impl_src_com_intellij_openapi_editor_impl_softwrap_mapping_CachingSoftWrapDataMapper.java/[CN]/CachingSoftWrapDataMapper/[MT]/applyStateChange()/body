{
  int visualLinesDiff=myAfterChangeState.visualLines - myBeforeChangeState.visualLines;
  int logicalLinesDiff=myAfterChangeState.logicalLines - myBeforeChangeState.logicalLines;
  int softWrappedLinesDiff=myAfterChangeState.softWrapLines - myBeforeChangeState.softWrapLines;
  int foldedLinesDiff=myAfterChangeState.foldedLines - myBeforeChangeState.foldedLines;
  int offsetsDiff=(myAfterChangeState.endOffset - myAfterChangeState.startOffset) - (myBeforeChangeState.endOffset - myBeforeChangeState.startOffset);
  int cacheIndex=myAfterChangeState.endCacheEntryIndex;
  for (int i=cacheIndex + 1; i < myCache.size(); i++) {
    CacheEntry cacheEntry=myCache.get(i);
    cacheEntry.visualLine+=visualLinesDiff;
    cacheEntry.startLogicalLine+=logicalLinesDiff;
    cacheEntry.endLogicalLine+=logicalLinesDiff;
    cacheEntry.advance(offsetsDiff);
    cacheEntry.startSoftWrapLinesBefore+=softWrappedLinesDiff;
    cacheEntry.endSoftWrapLinesBefore+=softWrappedLinesDiff;
    cacheEntry.startFoldedLines+=foldedLinesDiff;
    cacheEntry.endFoldedLines+=foldedLinesDiff;
  }
  if (offsetsDiff == 0) {
    return;
  }
  int softWrapIndex=myStorage.getSoftWrapIndex(myCache.get(cacheIndex).startOffset);
  if (softWrapIndex < 0) {
    softWrapIndex=-softWrapIndex - 1;
  }
  List<SoftWrapImpl> softWraps=myStorage.getSoftWraps();
  for (int i=softWrapIndex; i < softWraps.size(); i++) {
    softWraps.get(i).advance(offsetsDiff);
  }
}
