{
  if (DEBUG_SOFT_WRAP_PROCESSING) {
    log(String.format("xxxxxxxxxxxx CachingSoftWrapDataMapper.onRecalculationEnd(%s, %b). Current cache size: %d",event,normal,myCache.size()));
    if (myCache.size() < 10) {
      log("\tCurrent cache:");
      for (      CacheEntry cacheEntry : myCache) {
        log("\t\t" + cacheEntry);
      }
    }
  }
  int exactOffsetsDiff=event.getExactOffsetsDiff();
  if (normal) {
    myAfterChangeState.updateByDocumentOffsets(event.getNewStartOffset(),event.getNewEndOffset(),event.getNewLogicalLinesDiff());
    myCache.addAll(myNotAffectedByUpdateTailCacheEntries);
  }
 else {
    myAfterChangeState.logicalLines=event.getNewLogicalLinesDiff();
    myAfterChangeState.visualLines=event.getNewLogicalLinesDiff();
    myAfterChangeState.softWrapLines=0;
    myAfterChangeState.foldedLines=0;
    myCache.addAll(myNotAffectedByUpdateTailCacheEntries);
  }
  applyStateChange(exactOffsetsDiff);
  if (myCache.size() > 1) {
    CacheEntry beforeLast=myCache.get(myCache.size() - 2);
    CacheEntry last=myCache.get(myCache.size() - 1);
    if (beforeLast.visualLine == last.visualLine || (beforeLast.visualLine + 1 == last.visualLine && last.startOffset - beforeLast.endOffset > 1)) {
      LOG.error(String.format("Detected invalid soft wraps recalculation. Event: %s, normal: %b.%n%nCurrent cache state: %s%n%nTail cache entries: %s%n%n" + "Affected by change cache entries: %s%n%nBefore change state: %s%n%nAfter change state: %s",event,normal,myCache,myNotAffectedByUpdateTailCacheEntries,myAffectedByUpdateCacheEntries,myBeforeChangeState,myAfterChangeState));
    }
  }
  myAffectedByUpdateCacheEntries.clear();
  myNotAffectedByUpdateTailCacheEntries.clear();
  if (DEBUG_SOFT_WRAP_PROCESSING) {
    log("After Applying state change");
    dumpCache();
  }
  myBeforeChangeState.cacheShouldBeUpdated=false;
}
