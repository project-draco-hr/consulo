{
  if (DEBUG_SOFT_WRAP_PROCESSING) {
    log(String.format("xxxxxxxxxxxx CachingSoftWrapDataMapper.onRecalculationEnd(%s, %b). Current cache size: %d",event,normal,myCache.size()));
    if (myCache.size() < 10) {
      log("\tCurrent cache:");
      for (      CacheEntry cacheEntry : myCache) {
        log("\t\t" + cacheEntry);
      }
    }
  }
  int exactOffsetsDiff=event.getExactOffsetsDiff();
  if (normal) {
    myAfterChangeState.updateByDocumentOffsets(event.getNewStartOffset(),event.getNewEndOffset(),event.getNewLogicalLinesDiff());
    myCache.addAll(myNotAffectedByUpdateTailCacheEntries);
  }
 else {
    myAfterChangeState.logicalLines=event.getNewLogicalLinesDiff();
    myAfterChangeState.visualLines=event.getNewLogicalLinesDiff();
    myAfterChangeState.softWrapLines=0;
    myAfterChangeState.foldedLines=0;
    myCache.addAll(myNotAffectedByUpdateTailCacheEntries);
  }
  applyStateChange(exactOffsetsDiff,event.getNewEndOffset());
  myAffectedByUpdateCacheEntries.clear();
  myNotAffectedByUpdateTailCacheEntries.clear();
  if (DEBUG_SOFT_WRAP_PROCESSING) {
    log("After Applying state change");
    dumpCache();
  }
  myBeforeChangeState.cacheShouldBeUpdated=false;
}
