{
  reset();
  Document document=myEditor.getDocument();
  startCacheEntryIndex=MappingUtil.getCacheEntryIndexForOffset(startOffset,document,myCache);
  endCacheEntryIndex=MappingUtil.getCacheEntryIndexForOffset(endOffset,document,myCache);
  if (startCacheEntryIndex < 0) {
    startCacheEntryIndex=-startCacheEntryIndex - 1;
  }
  if (endCacheEntryIndex < 0) {
    endCacheEntryIndex=-endCacheEntryIndex - 1;
  }
  logicalLines=logicalLinesDiff;
  visualLines=logicalLinesDiff;
  softWrapLines=myStorage.getNumberOfSoftWrapsInRange(startOffset,endOffset);
  visualLines+=softWrapLines;
  if (startCacheEntryIndex >= myCache.size()) {
    cacheShouldBeUpdated=false;
    return;
  }
  foldedLines=0;
  for (int i=startCacheEntryIndex, max=Math.max(0,Math.min(myCache.size() - 1,endCacheEntryIndex)); i <= max; i++) {
    CacheEntry cacheEntry=myCache.get(i);
    foldedLines+=cacheEntry.endFoldedLines - cacheEntry.startFoldedLines;
  }
  visualLines-=foldedLines;
  if (DEBUG_SOFT_WRAP_PROCESSING) {
    log(String.format("CachingSoftWrapDataMapper$CacheState.updateByDocumentOffsets(). Collected %d fold lines for cache entry indices " + "%d-%d (cache size is %d)",foldedLines,startCacheEntryIndex,endCacheEntryIndex,myCache.size()));
  }
}
