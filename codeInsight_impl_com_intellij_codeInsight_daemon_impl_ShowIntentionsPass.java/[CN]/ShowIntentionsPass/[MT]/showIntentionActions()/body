{
  DaemonCodeAnalyzerImpl codeAnalyzer=(DaemonCodeAnalyzerImpl)DaemonCodeAnalyzer.getInstance(myProject);
  if (LookupManager.getInstance(myProject).getActiveLookup() != null)   return;
  LogicalPosition caretPos=myEditor.getCaretModel().getLogicalPosition();
  Rectangle visibleArea=myEditor.getScrollingModel().getVisibleArea();
  Point xy=myEditor.logicalPositionToXY(caretPos);
  if (!visibleArea.contains(xy))   return;
  final Editor injectedEditor=InjectedLanguageUtil.getEditorForInjectedLanguage(myEditor,myFile);
  final PsiFile injectedFile=injectedEditor instanceof EditorDelegate ? ((EditorDelegate)injectedEditor).getInjectedFile() : myFile;
  List<HighlightInfo.IntentionActionDescriptor> intentionsToShow=new ArrayList<HighlightInfo.IntentionActionDescriptor>();
  List<HighlightInfo.IntentionActionDescriptor> errorFixesToShow=new ArrayList<HighlightInfo.IntentionActionDescriptor>();
  List<HighlightInfo.IntentionActionDescriptor> inspectionFixesToShow=new ArrayList<HighlightInfo.IntentionActionDescriptor>();
  getActionsToShow(injectedEditor,injectedFile,intentionsToShow,errorFixesToShow,inspectionFixesToShow,myIntentionActions,myPassIdToShowIntentionsFor);
  if (!intentionsToShow.isEmpty() || !errorFixesToShow.isEmpty() || !inspectionFixesToShow.isEmpty()) {
    boolean showBulb=false;
    for (    HighlightInfo.IntentionActionDescriptor action : ContainerUtil.concat(errorFixesToShow,inspectionFixesToShow)) {
      if (IntentionManagerSettings.getInstance().isShowLightBulb(action.getAction())) {
        showBulb=true;
        break;
      }
    }
    if (!showBulb) {
      for (      HighlightInfo.IntentionActionDescriptor descriptor : intentionsToShow) {
        final IntentionAction action=descriptor.getAction();
        if (IntentionManagerSettings.getInstance().isShowLightBulb(action) && action.isAvailable(myProject,injectedEditor,injectedFile)) {
          showBulb=true;
          break;
        }
      }
    }
    if (showBulb) {
      IntentionHintComponent hintComponent=codeAnalyzer.getLastIntentionHint();
      if (hintComponent != null) {
        if (hintComponent.updateActions(intentionsToShow,errorFixesToShow,inspectionFixesToShow)) {
          return;
        }
        codeAnalyzer.setLastIntentionHint(null);
      }
      if (!HintManager.getInstance().hasShownHintsThatWillHideByOtherHint()) {
        hintComponent=IntentionHintComponent.showIntentionHint(myProject,injectedFile,injectedEditor,intentionsToShow,errorFixesToShow,inspectionFixesToShow,false);
        codeAnalyzer.setLastIntentionHint(hintComponent);
      }
    }
  }
}
