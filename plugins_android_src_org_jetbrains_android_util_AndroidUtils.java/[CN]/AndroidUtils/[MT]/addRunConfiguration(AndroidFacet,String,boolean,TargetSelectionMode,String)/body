{
  final Module module=facet.getModule();
  final Project project=module.getProject();
  final Runnable r=new Runnable(){
    public void run(){
      final RunManagerEx runManager=RunManagerEx.getInstanceEx(project);
      final RunnerAndConfigurationSettings settings=runManager.createRunConfiguration(module.getName(),AndroidRunConfigurationType.getInstance().getFactory());
      final AndroidRunConfiguration configuration=(AndroidRunConfiguration)settings.getConfiguration();
      configuration.setModule(module);
      if (activityClass != null) {
        configuration.MODE=AndroidRunConfiguration.LAUNCH_SPECIFIC_ACTIVITY;
        configuration.ACTIVITY_CLASS=activityClass;
      }
 else {
        configuration.MODE=AndroidRunConfiguration.LAUNCH_DEFAULT_ACTIVITY;
      }
      if (targetSelectionMode != null) {
        configuration.setTargetSelectionMode(targetSelectionMode);
      }
      if (preferredAvdName != null) {
        configuration.PREFERRED_AVD=preferredAvdName;
      }
      runManager.addConfiguration(settings,false);
      runManager.setActiveConfiguration(settings);
    }
  }
;
  if (!ask) {
    r.run();
  }
 else {
    UIUtil.invokeLaterIfNeeded(new Runnable(){
      public void run(){
        final String moduleName=facet.getModule().getName();
        final int result=Messages.showYesNoDialog(project,AndroidBundle.message("create.run.configuration.question",moduleName),AndroidBundle.message("create.run.configuration.title"),Messages.getQuestionIcon());
        if (result == 0) {
          r.run();
        }
      }
    }
);
  }
}
