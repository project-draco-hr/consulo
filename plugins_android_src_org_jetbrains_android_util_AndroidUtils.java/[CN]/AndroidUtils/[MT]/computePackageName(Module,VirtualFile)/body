{
  final Set<VirtualFile> sourceRoots=new HashSet<VirtualFile>();
  Collections.addAll(sourceRoots,ModuleRootManager.getInstance(module).getSourceRoots());
  final VirtualFile projectDir=module.getProject().getBaseDir();
  final List<String> packages=new ArrayList<String>();
  file=file.getParent();
  while (file != null && projectDir != file && !sourceRoots.contains(file)) {
    packages.add(file.getName());
    file=file.getParent();
  }
  if (file != null && sourceRoots.contains(file)) {
    final StringBuilder packageName=new StringBuilder();
    for (int i=packages.size() - 1; i >= 0; i--) {
      packageName.append(packages.get(i));
      if (i > 0)       packageName.append('.');
    }
    return packageName.toString();
  }
  return null;
}
