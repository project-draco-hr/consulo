{
  int startLine=document.getLineNumber(startOffset);
  int endLine=document.getLineNumber(endOffset);
  CharSequence text=document.getCharsSequence();
  int maximumCommonIndent=Integer.MAX_VALUE;
  int firstLineStart=startOffset;
  int firstLineEnd=startOffset;
  for (int line=startLine; line <= endLine; line++) {
    int lineStartOffset=document.getLineStartOffset(line);
    int lineEndOffset=document.getLineEndOffset(line);
    if (line == startLine) {
      firstLineStart=lineStartOffset;
      firstLineEnd=lineEndOffset;
    }
    int nonWsOffset=lineEndOffset;
    for (int i=lineStartOffset; i < lineEndOffset && (i - lineStartOffset) < maximumCommonIndent && i < endOffset; i++) {
      char c=text.charAt(i);
      if (c != ' ' && c != '\t') {
        nonWsOffset=i;
        break;
      }
    }
    if (nonWsOffset >= lineEndOffset) {
      continue;
    }
    int indent=nonWsOffset - lineStartOffset;
    maximumCommonIndent=Math.min(maximumCommonIndent,indent);
    if (maximumCommonIndent == 0) {
      break;
    }
  }
  int startOffsetToUse=Math.min(firstLineEnd,Math.max(startOffset,firstLineStart + maximumCommonIndent));
  return Pair.create(startOffsetToUse,maximumCommonIndent);
}
