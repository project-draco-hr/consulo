{
  if (original == null)   return null;
  if (substituted == null) {
    return original.accept(new PsiTypeVisitor<PsiType>(){
      public PsiType visitArrayType(      PsiArrayType arrayType){
        return new PsiArrayType(arrayType.getComponentType().accept(this));
      }
      public PsiType visitEllipsisType(      PsiEllipsisType ellipsisType){
        return new PsiEllipsisType(ellipsisType.getComponentType().accept(this));
      }
      public PsiType visitClassType(      PsiClassType classType){
        PsiClass aClass=classType.resolve();
        if (aClass != null) {
          if (aClass instanceof PsiTypeParameter) {
            return rawTypeForTypeParameter((PsiTypeParameter)aClass);
          }
 else {
            return JavaPsiFacade.getInstance(aClass.getProject()).getElementFactory().createType(aClass);
          }
        }
 else {
          return classType;
        }
      }
      public PsiType visitType(      PsiType type){
        LOG.error(type.getInternalCanonicalText());
        return null;
      }
    }
);
  }
  return substituted;
}
