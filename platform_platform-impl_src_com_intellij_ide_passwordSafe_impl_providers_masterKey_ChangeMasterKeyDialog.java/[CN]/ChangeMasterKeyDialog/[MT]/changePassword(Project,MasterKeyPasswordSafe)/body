{
  String error=null;
  boolean encrypt=safe.isPasswordEncrypted();
  while (true) {
    ChangeMasterKeyDialog d=new ChangeMasterKeyDialog(project,safe,encrypt,error);
    d.show();
    encrypt=d.myEncryptMasterPasswordWithCheckBox.isSelected();
switch (d.getExitCode()) {
case OK_EXIT_CODE:
      String o=new String(d.myOldPasswordPasswordField.getPassword());
    String n=new String(d.myNewPasswordPasswordField.getPassword());
  if (safe.changeMasterPassword(o,n,encrypt)) {
    return true;
  }
 else {
    error="Invalid old password was specified, please retry";
  }
break;
case CANCEL_EXIT_CODE:
return false;
case RESET_PASSWORD_CODE:
return ResetPasswordDialog.resetPassword(project,safe);
}
}
}
