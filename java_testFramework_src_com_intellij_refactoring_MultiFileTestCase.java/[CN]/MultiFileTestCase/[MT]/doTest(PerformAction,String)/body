{
  String path=getTestDataPath() + getTestRoot() + testName;
  String pathBefore=path + "/before";
  VirtualFile rootDir=PsiTestUtil.createTestProjectStructure(myProject,myModule,pathBefore,myFilesToDelete,false);
  prepareProject(rootDir);
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  String pathAfter=path + "/after";
  VirtualFile rootAfter=LocalFileSystem.getInstance().findFileByPath(pathAfter.replace(File.separatorChar,'/'));
  performAction.performAction(rootDir,rootAfter);
  myProject.getComponent(PostprocessReformattingAspect.class).doPostponedFormatting();
  FileDocumentManager.getInstance().saveAllDocuments();
  if (myDoCompare) {
    PlatformTestUtil.assertDirectoriesEqual(rootAfter,rootDir,PlatformTestUtil.CVS_FILE_FILTER);
  }
}
