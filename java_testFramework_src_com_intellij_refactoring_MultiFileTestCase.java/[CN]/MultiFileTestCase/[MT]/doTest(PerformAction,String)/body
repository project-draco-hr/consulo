{
  String path=getTestDataPath() + getTestRoot() + testName;
  String pathBefore=path + "/before";
  final VirtualFile rootDir=PsiTestUtil.createTestProjectStructure(myProject,myModule,pathBefore,myFilesToDelete,false);
  prepareProject(rootDir);
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  String pathAfter=path + "/after";
  final VirtualFile rootAfter=LocalFileSystem.getInstance().findFileByPath(pathAfter.replace(File.separatorChar,'/'));
  performAction.performAction(rootDir,rootAfter);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      myProject.getComponent(PostprocessReformattingAspect.class).doPostponedFormatting();
    }
  }
);
  FileDocumentManager.getInstance().saveAllDocuments();
  if (myDoCompare) {
    PlatformTestUtil.assertDirectoriesEqual(rootAfter,rootDir,PlatformTestUtil.CVS_FILE_FILTER);
  }
}
