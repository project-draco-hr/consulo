def unbundle(self, cg, heads, source):
    d = self.call('unbundle', heads=' '.join(map(hex, heads)))
    if d:
        self.abort(error.RepoError((_('push refused: %s') % d)))
    while 1:
        d = cg.read(4096)
        if (not d):
            break
        self._send(d)
    self._send('', flush=True)
    r = self._recv()
    if r:
        self.abort(error.RepoError((_('push failed: %s') % r)))
    r = self._recv()
    try:
        return int(r)
    except:
        self.abort(error.ResponseError(_('unexpected response:'), r))
