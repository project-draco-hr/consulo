def addchangegroup(self, cg, source, url):
    d = self.call('addchangegroup')
    if d:
        self.abort(error.RepoError((_('push refused: %s') % d)))
    while 1:
        d = cg.read(4096)
        if (not d):
            break
        self.pipeo.write(d)
        self.readerr()
    self.pipeo.flush()
    self.readerr()
    r = self._recv()
    if (not r):
        return 1
    try:
        return int(r)
    except:
        self.abort(error.ResponseError(_('unexpected response:'), r))
