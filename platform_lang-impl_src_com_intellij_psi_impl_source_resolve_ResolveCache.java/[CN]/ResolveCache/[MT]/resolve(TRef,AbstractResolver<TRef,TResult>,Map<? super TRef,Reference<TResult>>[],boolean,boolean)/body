{
  ProgressManager.checkCanceled();
  int clearCountOnStart=myClearCount.intValue();
  boolean physical=ref.getElement().isPhysical();
  TResult result=getCached(ref,maps,physical,incompleteCode);
  if (result != null) {
    return result;
  }
  if (incompleteCode) {
    result=resolve(ref,resolver,maps,needToPreventRecursion,false);
    if (result != null && !(result instanceof Object[] && ((Object[])result).length == 0)) {
      cache(ref,result,maps,physical,incompleteCode,clearCountOnStart);
      return result;
    }
  }
  if (needToPreventRecursion && !lockElement(ref))   return null;
  try {
    result=resolver.resolve(ref,incompleteCode);
  }
  finally {
    if (needToPreventRecursion) {
      unlockElement(ref);
    }
  }
  cache(ref,result,maps,physical,incompleteCode,clearCountOnStart);
  return result;
}
