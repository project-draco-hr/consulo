def _copyfile(self, source, dest):
    wdest = self.wjoin(dest)
    exists = os.path.exists(wdest)
    if exists:
        (fd, tempname) = tempfile.mkstemp(prefix='hg-copy-', dir=os.path.dirname(wdest))
        os.close(fd)
        os.unlink(tempname)
        os.rename(wdest, tempname)
    try:
        self.run0('copy', source, dest)
    finally:
        if exists:
            try:
                os.unlink(wdest)
            except OSError:
                pass
            os.rename(tempname, wdest)
