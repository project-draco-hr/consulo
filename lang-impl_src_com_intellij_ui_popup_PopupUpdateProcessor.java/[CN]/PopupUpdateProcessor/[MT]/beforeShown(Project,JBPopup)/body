{
  final Lookup activeLookup=LookupManager.getInstance(project).getActiveLookup();
  if (activeLookup != null) {
    activeLookup.addLookupListener(new LookupAdapter(){
      public void currentItemChanged(      LookupEvent event){
        if (jbPopup.isVisible()) {
          final LookupItem item=event.getItem();
          if (item != null) {
            final Object o=item.getObject();
            if (o instanceof PsiElement) {
              jbPopup.cancel();
              myPopupUpdater.value((PsiElement)o);
            }
          }
        }
        activeLookup.removeLookupListener(this);
      }
    }
);
  }
 else {
    final Component focusedComponent=WindowManagerEx.getInstanceEx().getFocusedComponent(project);
    boolean fromQuickSearch=focusedComponent != null && focusedComponent.getParent() instanceof ChooseByNameBase.JPanelProvider;
    if (fromQuickSearch) {
      ChooseByNameBase.JPanelProvider panelProvider=(ChooseByNameBase.JPanelProvider)focusedComponent.getParent();
      panelProvider.registerHint(jbPopup);
    }
  }
}
