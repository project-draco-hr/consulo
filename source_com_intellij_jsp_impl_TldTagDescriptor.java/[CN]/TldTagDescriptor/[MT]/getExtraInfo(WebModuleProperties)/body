{
  Object tei;
  TagExtraInfo castedTei=null;
  if (myTeiClass != null) {
    List<URL> urls=new ArrayList<URL>();
    final VirtualFile virtualFile=myTag.getContainingFile().getVirtualFile();
    if (virtualFile != null) {
      final String ext=virtualFile.getExtension();
      if (ext != null && ext.equalsIgnoreCase("jar")) {
        addUrl(urls,virtualFile);
      }
    }
    if (moduleProperties != null) {
      final VirtualFile[] files=ModuleRootManager.getInstance(moduleProperties.getModule()).getFiles(OrderRootType.CLASSES_AND_OUTPUT);
      for (int j=0; j < files.length; j++) {
        final VirtualFile file;
        try {
          if (files[j] instanceof VirtualFileImpl) {
            file=LocalFileSystem.getInstance().findFileByIoFile(new File(JarFileSystem.getInstance().getJarFile(files[j]).getName()));
          }
 else           file=files[j];
          addUrl(urls,file);
        }
 catch (        IOException e) {
          LOG.error(e);
        }
      }
    }
    TeiClassLoader classLoader=new TeiClassLoader(urls,getClass().getClassLoader());
    try {
      Class aClass=classLoader.loadClass(myTeiClass);
      tei=aClass.newInstance();
      castedTei=(TagExtraInfo)tei;
      castedTei.setTagInfo(new TagInfo(myName,myTagClass,"","",new TagLibraryInfo("",""){
      }
,castedTei,myTLDAttributes.toArray(new TagAttributeInfo[0]),myName,"","",myTLDVars.toArray(new TagVariableInfo[myTLDVars.size()])));
    }
 catch (    Exception e) {
    }
  }
  if (castedTei != null)   return castedTei;
  return new MyTEI(myTLDVars);
}
