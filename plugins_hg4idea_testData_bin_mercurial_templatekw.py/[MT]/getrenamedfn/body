def getrenamedfn(repo, endrev=None):
    rcache = {}
    if (endrev is None):
        endrev = len(repo)

    def getrenamed(fn, rev):
        'looks up all renames for a file (up to endrev) the first\n        time the file is given. It indexes on the changerev and only\n        parses the manifest if linkrev != changerev.\n        Returns rename info for fn at changerev rev.'
        if (fn not in rcache):
            rcache[fn] = {}
            fl = repo.file(fn)
            for i in fl:
                lr = fl.linkrev(i)
                renamed = fl.renamed(fl.node(i))
                rcache[fn][lr] = renamed
                if (lr >= endrev):
                    break
        if (rev in rcache[fn]):
            return rcache[fn][rev]
        try:
            return repo[rev][fn].renamed()
        except error.LookupError:
            return None
    return getrenamed
