{
  if (isSkippedExternalDependency(instruction))   return true;
  final VirtualFile sourceFile=myLocalFileSystem.findFileByIoFile(instruction.getFile());
  if (sourceFile == null)   return true;
  if (myBuildConfiguration.willBuildExploded()) {
    String outputRoot=DeploymentUtilImpl.getOrCreateExplodedDir(myBuildParticipant);
    String jarPath=DeploymentUtil.concatPaths(outputRoot,myOutputPaths.peek(),instruction.getOutputRelativePath());
    jarPath=getCanonicalPath(jarPath);
    checkRecursiveCopying(sourceFile,jarPath);
    addItemsToJar(sourceFile,createExplodedDestination(jarPath));
  }
  if (myNestedJars != null) {
    final NestedJarInfo nestedJar=getNestedJar(myNestedJars,instruction.isExternalDependencyInstruction());
    if (nestedJar != null) {
      final String outputRelativePath=trimParentPrefix(instruction.getOutputRelativePath());
      JarDestinationInfo destination=new JarDestinationInfo(outputRelativePath,nestedJar.myJarInfo,nestedJar.myDestination);
      checkRecursiveCopying(sourceFile,destination.getOutputFilePath());
      addItemsToJar(sourceFile,destination);
    }
 else {
      String jarPath=DeploymentUtil.concatPaths(myBuildConfiguration.getJarPath(),instruction.getOutputRelativePath());
      jarPath=getCanonicalPath(jarPath);
      checkRecursiveCopying(sourceFile,jarPath);
      addItemsToJar(sourceFile,createExplodedDestination(jarPath));
    }
  }
  return true;
}
