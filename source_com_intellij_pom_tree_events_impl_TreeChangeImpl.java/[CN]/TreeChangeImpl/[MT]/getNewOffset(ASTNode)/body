{
  ASTNode current=myParent.getFirstChildNode();
  final Iterator<Pair<ASTNode,Integer>> iterator=myOffsets.iterator();
  Pair<ASTNode,Integer> currentChange=iterator.hasNext() ? iterator.next() : null;
  int currentOffsetInNewTree=0;
  int currentOldOffset=0;
  while (current != null) {
    boolean counted=false;
    while (currentChange != null && currentOldOffset == currentChange.getSecond().intValue()) {
      if (currentChange.getFirst() == node)       return currentOffsetInNewTree;
      if (current == currentChange.getFirst()) {
        final int textLength=current.getTextLength();
        counted=true;
        current=current.getTreeNext();
        currentOffsetInNewTree+=textLength;
      }
      final ChangeInfo changeInfo=myChanges.get(currentChange.getFirst());
      currentOldOffset+=changeInfo.getOldLength();
      currentChange=iterator.hasNext() ? iterator.next() : null;
    }
    if (current == null)     break;
    if (!counted) {
      final int textLength=current.getTextLength();
      currentOldOffset+=textLength;
      current=current.getTreeNext();
      currentOffsetInNewTree+=textLength;
    }
  }
  return currentOffsetInNewTree;
}
