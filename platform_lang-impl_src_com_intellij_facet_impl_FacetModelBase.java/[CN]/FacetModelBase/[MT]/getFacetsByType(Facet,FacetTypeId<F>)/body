{
  if (myChildFacets == null) {
    MultiValuesMap<Pair<Facet,FacetTypeId>,Facet> children=new MultiValuesMap<Pair<Facet,FacetTypeId>,Facet>();
    for (    Facet facet : getAllFacets()) {
      final Facet underlying=facet.getUnderlyingFacet();
      if (underlying != null) {
        children.put(Pair.create(underlying,facet.getTypeId()),facet);
      }
    }
    Map<Pair<Facet,FacetTypeId>,Collection<Facet>> childFacets=new HashMap<Pair<Facet,FacetTypeId>,Collection<Facet>>();
    for (    Pair<Facet,FacetTypeId> pair : children.keySet()) {
      final Collection<Facet> facets=children.get(pair);
      childFacets.put(pair,Collections.unmodifiableCollection(facets));
    }
    myChildFacets=childFacets;
  }
  final Collection<F> facets=(Collection<F>)myChildFacets.get(new Pair(underlyingFacet,typeId));
  return facets != null ? facets : Collections.<F>emptyList();
}
