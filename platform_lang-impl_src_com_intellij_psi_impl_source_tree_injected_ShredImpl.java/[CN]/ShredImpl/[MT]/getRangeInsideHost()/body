{
  PsiLanguageInjectionHost host=getHost();
  ProperTextRange textRange=relevantRangeInHost.isValid() ? new ProperTextRange(relevantRangeInHost.getStartOffset(),relevantRangeInHost.getEndOffset()) : null;
  if (host == null) {
    if (textRange != null)     return textRange;
    Segment fromSP=hostElementPointer.getRange();
    if (fromSP != null)     return TextRange.create(fromSP);
    return new TextRange(0,0);
  }
  TextRange hostTextRange=host.getTextRange();
  textRange=textRange == null ? null : textRange.intersection(hostTextRange);
  if (textRange == null)   return new ProperTextRange(0,hostTextRange.getLength());
  return textRange.shiftRight(-hostTextRange.getStartOffset());
}
