{
  int blankLinesBefore=0;
  TIntArrayList lineFeedOffsets=new TIntArrayList();
  int oldStartLine=document.getLineNumber(oldEntry.getStartOffset());
  if (oldStartLine > 0) {
    int lastLineFeed=document.getLineStartOffset(oldStartLine) - 1;
    lineFeedOffsets.add(lastLineFeed);
    for (int i=lastLineFeed - 1 - myParentShift; i >= 0; i--) {
      i=CharArrayUtil.shiftBackward(myParentText,i," \t");
      if (myParentText.charAt(i) == '\n') {
        blankLinesBefore++;
        lineFeedOffsets.add(i + myParentShift);
      }
 else {
        break;
      }
    }
  }
  int desiredBlankLinesNumber=rearranger.getBlankLines(mySettings,parent,previous,newEntry);
  if (desiredBlankLinesNumber == blankLinesBefore && newEntry.equals(oldEntry)) {
    return;
  }
  String newEntryText=myParentText.substring(newEntry.getStartOffset() - myParentShift,newEntry.getEndOffset() - myParentShift);
  int lineFeedsDiff=desiredBlankLinesNumber - blankLinesBefore;
  if (lineFeedsDiff == 0) {
    document.replaceString(oldEntry.getStartOffset(),oldEntry.getEndOffset(),newEntryText);
    return;
  }
  int oldEndOffset=oldEntry.getEndOffset();
  if (myExtraSizes.containsKey(oldEntry)) {
    oldEndOffset+=myExtraSizes.get(oldEntry);
  }
  if (lineFeedsDiff > 0) {
    StringBuilder buffer=new StringBuilder(StringUtil.repeat("\n",lineFeedsDiff));
    buffer.append(newEntryText);
    document.replaceString(oldEntry.getStartOffset(),oldEndOffset,buffer);
    for (ArrangementEntry entry=newEntry; entry != null; entry=entry.getParent()) {
      if (myExtraSizes.containsKey(entry)) {
        myExtraSizes.put(entry,myExtraSizes.get(entry) + lineFeedsDiff);
      }
 else {
        myExtraSizes.put(entry,lineFeedsDiff);
      }
    }
  }
 else   if (desiredBlankLinesNumber == blankLinesBefore) {
    document.replaceString(oldEntry.getStartOffset(),oldEndOffset,newEntryText);
  }
 else {
    int blankLinesToCut=blankLinesBefore - desiredBlankLinesNumber;
    int replacementStartOffset=lineFeedOffsets.get(lineFeedOffsets.size() - blankLinesToCut);
    document.replaceString(replacementStartOffset,oldEndOffset,newEntryText);
  }
  for (ArrangementEntry entry=newEntry; entry != null; entry=entry.getParent()) {
    if (myExtraSizes.containsKey(entry)) {
      myExtraSizes.put(entry,myExtraSizes.get(entry) + lineFeedsDiff);
    }
 else {
      myExtraSizes.put(entry,lineFeedsDiff);
    }
  }
}
