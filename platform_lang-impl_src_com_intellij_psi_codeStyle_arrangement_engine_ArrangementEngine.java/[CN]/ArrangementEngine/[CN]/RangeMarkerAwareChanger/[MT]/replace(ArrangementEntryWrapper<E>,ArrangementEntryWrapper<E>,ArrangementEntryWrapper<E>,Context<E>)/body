{
  int blankLinesBefore=oldWrapper.getBlankLinesBefore();
  ArrangementEntryWrapper<E> parentWrapper=oldWrapper.getParent();
  int desiredBlankLinesNumber=context.rearranger.getBlankLines(context.settings,parentWrapper == null ? null : parentWrapper.getEntry(),previous == null ? null : previous.getEntry(),newWrapper.getEntry());
  if ((desiredBlankLinesNumber < 0 || desiredBlankLinesNumber == blankLinesBefore) && newWrapper.equals(oldWrapper)) {
    return;
  }
  int lineFeedsDiff=desiredBlankLinesNumber - blankLinesBefore;
  int insertionOffset=oldWrapper.getStartOffset();
  if (oldWrapper.getStartOffset() > newWrapper.getStartOffset()) {
    insertionOffset-=newWrapper.getEndOffset() - newWrapper.getStartOffset();
  }
  myDocument.moveText(newWrapper.getStartOffset(),newWrapper.getEndOffset(),oldWrapper.getStartOffset());
  newWrapper.placeBefore(oldWrapper);
  myNotMoved.remove(newWrapper);
  for (  ArrangementEntryWrapper<E> w : myNotMoved) {
    if (w.getStartOffset() >= oldWrapper.getStartOffset() && w.getStartOffset() < newWrapper.getStartOffset()) {
      w.applyShift(newWrapper.getEndOffset() - newWrapper.getStartOffset());
    }
 else     if (w.getStartOffset() < oldWrapper.getStartOffset() && w.getStartOffset() > newWrapper.getStartOffset()) {
      w.applyShift(newWrapper.getStartOffset() - newWrapper.getEndOffset());
    }
  }
  if (desiredBlankLinesNumber >= 0 && lineFeedsDiff > 0) {
    myDocument.insertString(insertionOffset,StringUtil.repeat("\n",lineFeedsDiff));
    shiftOffsets(newWrapper,null,lineFeedsDiff);
  }
  if (desiredBlankLinesNumber >= 0 && lineFeedsDiff < 0) {
    int replacementStartOffset=getBlankLineOffset(-lineFeedsDiff,insertionOffset);
    myDocument.deleteString(replacementStartOffset,insertionOffset);
    shiftOffsets(oldWrapper,null,lineFeedsDiff);
  }
  if (desiredBlankLinesNumber < 0 || lineFeedsDiff == 0 || parentWrapper == null) {
    return;
  }
  Deque<ArrangementEntryWrapper<E>> parents=new ArrayDeque<ArrangementEntryWrapper<E>>();
  do {
    parents.add(parentWrapper);
    parentWrapper.setEndOffset(parentWrapper.getEndOffset() + lineFeedsDiff);
    parentWrapper=parentWrapper.getParent();
  }
 while (parentWrapper != null);
  while (!parents.isEmpty()) {
    for (ArrangementEntryWrapper<E> wrapper=parents.removeLast().getNext(); wrapper != null; wrapper=wrapper.getNext()) {
      wrapper.applyShift(lineFeedsDiff);
    }
  }
}
