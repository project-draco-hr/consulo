{
  final Document document=PsiDocumentManager.getInstance(file.getProject()).getDocument(file);
  if (document == null) {
    return;
  }
  Rearranger<?> rearranger=Rearranger.EXTENSION.forLanguage(file.getLanguage());
  if (rearranger == null) {
    return;
  }
  CodeStyleSettings settings=CodeStyleSettingsManager.getInstance(file.getProject()).getCurrentSettings();
  final Ref<List<? extends ArrangementRule>> rulesRef=new Ref<List<? extends ArrangementRule>>();
  List<? extends ArrangementRule> arrangementRules=settings.getCommonSettings(file.getLanguage()).getArrangementRules();
  if (arrangementRules.isEmpty() && rearranger instanceof ArrangementStandardSettingsAware) {
    List<StdArrangementRule> defaultRules=((ArrangementStandardSettingsAware)rearranger).getDefaultRules();
    if (defaultRules != null) {
      arrangementRules=defaultRules;
    }
  }
  if (arrangementRules.isEmpty()) {
    return;
  }
 else {
    rulesRef.set(arrangementRules);
  }
  final Collection<? extends ArrangementEntry> entriesToProcess=rearranger.parse(file,document,ranges);
  final DocumentEx documentEx;
  if (document instanceof DocumentEx && !((DocumentEx)document).isInBulkUpdate()) {
    documentEx=(DocumentEx)document;
  }
 else {
    documentEx=null;
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      if (documentEx != null) {
        documentEx.setInBulkUpdate(true);
      }
      try {
        doArrange(document,rulesRef.get(),entriesToProcess);
      }
  finally {
        if (documentEx != null) {
          documentEx.setInBulkUpdate(false);
        }
      }
    }
  }
);
}
