{
  if (getModuleCount() == 0) {
    return VirtualFile.EMPTY_ARRAY;
  }
  final Set<Module> modules=getNodes();
  final Project project=modules.iterator().next().getProject();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  final List<VirtualFile> filesToCompile=new ArrayList<VirtualFile>();
  for (Iterator<Module> it=modules.iterator(); it.hasNext(); ) {
    final VirtualFile[] moduleCompilableFiles=getFilesToCompile(it.next());
    if (mySourcesFilter == ALL_SOURCES) {
      filesToCompile.addAll(Arrays.asList(moduleCompilableFiles));
    }
 else {
      for (int idx=0; idx < moduleCompilableFiles.length; idx++) {
        final VirtualFile file=moduleCompilableFiles[idx];
        if (mySourcesFilter == TEST_SOURCES) {
          if (fileIndex.isInTestSourceContent(file)) {
            filesToCompile.add(file);
          }
        }
 else {
          if (!fileIndex.isInTestSourceContent(file)) {
            filesToCompile.add(file);
          }
        }
      }
    }
  }
  return filesToCompile.toArray(new VirtualFile[filesToCompile.size()]);
}
