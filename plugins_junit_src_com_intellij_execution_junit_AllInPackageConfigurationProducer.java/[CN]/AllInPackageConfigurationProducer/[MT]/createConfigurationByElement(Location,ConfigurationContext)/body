{
  final Project project=location.getProject();
  final PsiElement element=location.getPsiElement();
  myPackage=checkPackage(element);
  if (myPackage == null)   return null;
  RunnerAndConfigurationSettingsImpl settings=cloneTemplateConfiguration(project,context);
  final JUnitConfiguration configuration=(JUnitConfiguration)settings.getConfiguration();
  final JUnitConfiguration.Data data=configuration.getPersistentData();
  data.PACKAGE_NAME=myPackage.getQualifiedName();
  data.TEST_OBJECT=JUnitConfiguration.TEST_PACKAGE;
  final RunnerAndConfigurationSettingsImpl template=((RunManagerImpl)context.getRunManager()).getConfigurationTemplate(getConfigurationFactory());
  if (data.getScope() != TestSearchScope.WHOLE_PROJECT) {
    final Module contextModule=context.getModule();
    final Module predefinedModule=((ModuleBasedConfiguration)template.getConfiguration()).getConfigurationModule().getModule();
    if (predefinedModule != null) {
      configuration.setModule(predefinedModule);
    }
 else     if (contextModule != null) {
      configuration.setModule(contextModule);
    }
 else {
      data.setScope(TestSearchScope.WHOLE_PROJECT);
    }
  }
  configuration.setGeneratedName();
  copyStepsBeforeRun(project,configuration);
  return settings;
}
