{
  if (targets.length == 0)   return null;
  if (targets.length == 1) {
    targets[0].navigate(true);
    return null;
  }
  final CollectionListModel<NavigatablePsiElement> model=new CollectionListModel<NavigatablePsiElement>(targets);
  final JBListWithHintProvider list=new JBListWithHintProvider(model){
    @Override protected PsiElement getPsiElementForHint(    final Object selectedValue){
      return (PsiElement)selectedValue;
    }
  }
;
  list.setCellRenderer(listRenderer);
  final PopupChooserBuilder builder=new PopupChooserBuilder(list);
  if (listRenderer instanceof PsiElementListCellRenderer) {
    ((PsiElementListCellRenderer)listRenderer).installSpeedSearch(builder);
  }
  PopupChooserBuilder popupChooserBuilder=builder.setTitle(title).setMovable(true).setItemChoosenCallback(new Runnable(){
    @Override public void run(){
      int[] ids=list.getSelectedIndices();
      if (ids == null || ids.length == 0)       return;
      Object[] selectedElements=list.getSelectedValues();
      for (      Object element : selectedElements) {
        PsiElement selected=(PsiElement)element;
        LOG.assertTrue(selected.isValid());
        ((NavigatablePsiElement)selected).navigate(true);
      }
    }
  }
).setCancelCallback(new Computable<Boolean>(){
    @Override public Boolean compute(){
      list.hideHint();
      return true;
    }
  }
);
  if (findUsagesTitle != null) {
    popupChooserBuilder=popupChooserBuilder.setCouldPin(new Processor<JBPopup>(){
      @Override public boolean process(      JBPopup popup){
        final List<NavigatablePsiElement> items=model.getItems();
        FindUtil.showInUsageView(null,items.toArray(new PsiElement[items.size()]),findUsagesTitle,targets[0].getProject());
        popup.cancel();
        return false;
      }
    }
);
  }
  final JBPopup popup=popupChooserBuilder.createPopup();
  if (listUpdaterTask != null) {
    listUpdaterTask.init((AbstractPopup)popup,list);
    ProgressManager.getInstance().run(listUpdaterTask);
  }
  return popup;
}
