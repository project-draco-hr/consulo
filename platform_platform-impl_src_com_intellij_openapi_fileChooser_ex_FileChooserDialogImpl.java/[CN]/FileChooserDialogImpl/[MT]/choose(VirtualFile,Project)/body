{
  init();
  VirtualFile selectFile=null;
  if (toSelect == null && ourLastFile == null) {
    if (project != null && project.getBaseDir() != null) {
      selectFile=project.getBaseDir();
    }
  }
 else {
    selectFile=(toSelect == null) ? ourLastFile : (ourLastFile == null ? toSelect : myChooserDescriptor.getUserData(PREFER_LAST_OVER_TO_SELECT.getName()) == null ? toSelect : ourLastFile);
  }
  final VirtualFile file=selectFile;
  if (file != null && file.isValid()) {
    myFileSystemTree.select(file,new Runnable(){
      public void run(){
        if (!file.equals(myFileSystemTree.getSelectedFile())) {
          VirtualFile parent=file.getParent();
          if (parent != null) {
            myFileSystemTree.select(parent,null);
          }
        }
 else         if (file.isDirectory())         myFileSystemTree.expand(file);
      }
    }
);
  }
  show();
  return myChosenFiles;
}
