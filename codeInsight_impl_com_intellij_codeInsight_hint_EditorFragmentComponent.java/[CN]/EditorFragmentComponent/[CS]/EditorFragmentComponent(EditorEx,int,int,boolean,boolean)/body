{
  Document doc=editor.getDocument();
  final int endOffset=endLine < doc.getLineCount() ? doc.getLineEndOffset(endLine) : doc.getTextLength();
  int textWidth=Math.min(editor.getMaxWidthInRange(doc.getLineStartOffset(startLine),endOffset),editor.getComponent().getWidth());
  FoldingModelEx foldingModel=(FoldingModelEx)editor.getFoldingModel();
  boolean isFoldingEnabled=foldingModel.isFoldingEnabled();
  if (!showFolding) {
    foldingModel.setFoldingEnabled(false);
  }
  Point p1=editor.logicalPositionToXY(new LogicalPosition(startLine,0));
  Point p2=editor.logicalPositionToXY(new LogicalPosition(Math.max(endLine,startLine + 1),0));
  int y1=p1.y;
  int y2=p2.y;
  int savedScrollOfset=editor.getScrollingModel().getHorizontalScrollOffset();
  if (savedScrollOfset > 0) {
    editor.stopOptimizedScrolling();
    editor.getScrollingModel().scrollHorizontally(0);
  }
  final Image textImage=new BufferedImage(textWidth,y2 - y1,BufferedImage.TYPE_INT_RGB);
  Graphics textGraphics=textImage.getGraphics();
  final JComponent rowHeader;
  final Image markersImage;
  if (showGutter) {
    rowHeader=editor.getGutterComponentEx();
    markersImage=new BufferedImage(rowHeader.getWidth(),y2 - y1,BufferedImage.TYPE_INT_RGB);
    Graphics markerGraphics=markersImage.getGraphics();
    markerGraphics.translate(0,-y1);
    markerGraphics.setClip(0,y1,rowHeader.getWidth(),y2 - y1);
    markerGraphics.setColor(getBackgroundColor(editor));
    markerGraphics.fillRect(0,y1,rowHeader.getWidth(),y2 - y1);
    rowHeader.paint(markerGraphics);
  }
 else {
    rowHeader=null;
    markersImage=null;
  }
  textGraphics.translate(0,-y1);
  textGraphics.setClip(0,y1,textWidth,y2 - y1);
  editor.setCaretVisible(false);
  editor.getContentComponent().paint(textGraphics);
  editor.setCaretVisible(true);
  if (!showFolding) {
    foldingModel.setFoldingEnabled(isFoldingEnabled);
  }
  if (savedScrollOfset > 0) {
    editor.stopOptimizedScrolling();
    editor.getScrollingModel().scrollHorizontally(savedScrollOfset);
  }
  JComponent component=new JComponent(){
    public Dimension getPreferredSize(){
      return new Dimension(textImage.getWidth(null) + (markersImage == null ? 0 : markersImage.getWidth(null)),textImage.getHeight(null));
    }
    protected void paintComponent(    Graphics graphics){
      if (markersImage != null) {
        graphics.drawImage(markersImage,0,0,null);
        graphics.drawImage(textImage,rowHeader.getWidth(),0,null);
      }
 else {
        graphics.drawImage(textImage,0,0,null);
      }
    }
  }
;
  setLayout(new BorderLayout());
  add(component);
  final Color borderColor=editor.getColorsScheme().getColor(EditorColors.SELECTED_FOLDING_TREE_COLOR);
  Border outsideBorder=BorderFactory.createLineBorder(borderColor,1);
  Border insideBorder=BorderFactory.createEmptyBorder(2,2,2,2);
  setBorder(BorderFactory.createCompoundBorder(outsideBorder,insideBorder));
}
