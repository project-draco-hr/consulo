{
  SVNURL root;
  RepositoryTreeNode node=getRepositoryBrowser().getSelectedNode();
  if (node == null) {
    return;
  }
  while (node.getSVNDirEntry() != null) {
    node=(RepositoryTreeNode)node.getParent();
  }
  root=node.getURL();
  final RepositoryTreeNode selectedNode=getSelectedNode();
  if (selectedNode == null) {
    return;
  }
  SVNURL sourceURL=selectedNode.getURL();
  DiffOptionsDialog dialog=new DiffOptionsDialog(myProject,root,sourceURL);
  dialog.show();
  if (dialog.isOK()) {
    SVNURL targetURL=dialog.getTargetURL();
    if (dialog.isReverseDiff()) {
      targetURL=sourceURL;
      sourceURL=dialog.getTargetURL();
    }
    final SVNURL sURL=sourceURL;
    final SVNURL tURL=targetURL;
    Runnable command;
    boolean cancelable;
    if (dialog.isUnifiedDiff()) {
      final File targetFile=dialog.getTargetFile();
      command=new Runnable(){
        public void run(){
          targetFile.getParentFile().mkdirs();
          doUnifiedDiff(targetFile,sURL,tURL);
        }
      }
;
      cancelable=false;
    }
 else {
      command=new Runnable(){
        public void run(){
          try {
            doGraphicalDiff(sURL,tURL);
          }
 catch (          SVNCancelException ex) {
          }
catch (          final SVNException e1) {
            WaitForProgressToShow.runOrInvokeLaterAboveProgress(new Runnable(){
              public void run(){
                Messages.showErrorDialog(myProject,e1.getErrorMessage().getFullMessage(),"Error");
              }
            }
,null,myProject);
          }
        }
      }
;
      cancelable=true;
    }
    ProgressManager.getInstance().runProcessWithProgressSynchronously(command,SvnBundle.message("progress.computing.difference"),cancelable,myProject);
  }
}
