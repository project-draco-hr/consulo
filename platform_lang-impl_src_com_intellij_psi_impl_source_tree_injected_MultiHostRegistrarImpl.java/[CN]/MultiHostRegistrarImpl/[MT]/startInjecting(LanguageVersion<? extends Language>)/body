{
  escapers=new SmartList<LiteralTextEscaper<? extends PsiLanguageInjectionHost>>();
  shreds=new SmartList<PsiLanguageInjectionHost.Shred>();
  outChars=new StringBuilder();
  if (!cleared) {
    clear();
    throw new IllegalStateException("Seems you haven't called doneInjecting()");
  }
  Language language=languageVersion.getLanguage();
  if (LanguageParserDefinitions.INSTANCE.forLanguage(language) == null) {
    ReferenceInjector injector=ReferenceInjector.findById(language.getID());
    if (injector == null) {
      throw new UnsupportedOperationException("Cannot inject language '" + language + "' since its getParserDefinition() returns null");
    }
    myLanguage=null;
    myReferenceInjector=injector;
  }
  myLanguage=language;
  myLanguageVersion=languageVersion;
  return this;
}
