{
  if (library.getTable() == null || !LibraryTablesRegistrar.APPLICATION_LEVEL.equals(library.getTable().getTableLevel())) {
    final ArrayList<Library> result=new ArrayList<Library>();
    for (    VirtualFile file : library.getFiles(OrderRootType.CLASSES)) {
      if (!existingFiles.add(file))       continue;
      final Library newLibrary=LibraryTableImplUtil.createModuleLevelLibrary(null,null,null);
      Disposer.register(parentDisposable,newLibrary);
      final Library.ModifiableModel libModel=newLibrary.getModifiableModel();
      libModel.addRoot(file,OrderRootType.CLASSES);
      libModel.commit();
      result.add(newLibrary);
    }
    return result;
  }
  return Collections.singletonList(library);
}
