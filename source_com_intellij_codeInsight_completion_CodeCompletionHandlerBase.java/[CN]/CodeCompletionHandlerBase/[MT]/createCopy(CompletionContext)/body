{
  final PsiElementVisitor visitor=new PsiRecursiveElementVisitor(){
    public void visitReferenceExpression(    PsiReferenceExpression expression){
      visitExpression(expression);
    }
    public void visitClass(    PsiClass aClass){
      aClass.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,aClass);
      super.visitClass(aClass);
    }
    public void visitVariable(    PsiVariable variable){
      variable.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,variable);
      super.visitVariable(variable);
    }
    public void visitMethod(    PsiMethod method){
      method.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,method);
      super.visitMethod(method);
    }
    public void visitXmlTag(    XmlTag tag){
      tag.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,tag);
      super.visitXmlTag(tag);
    }
  }
;
  visitor.visitFile(context.file);
  final PsiFile fileCopy=(PsiFile)context.file.copy();
  final PsiElementVisitor copyVisitor=new PsiRecursiveElementVisitor(){
    public void visitReferenceExpression(    PsiReferenceExpression expression){
      visitExpression(expression);
    }
    public void visitClass(    PsiClass aClass){
      final PsiElement originalElement=aClass.getCopyableUserData(CompletionUtil.ORIGINAL_KEY);
      if (originalElement != null) {
        originalElement.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,null);
        originalElement.putUserData(CompletionUtil.COPY_KEY,aClass);
        aClass.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,null);
        aClass.putUserData(CompletionUtil.ORIGINAL_KEY,originalElement);
      }
      super.visitClass(aClass);
    }
  }
;
  copyVisitor.visitFile(fileCopy);
  return fileCopy;
}
