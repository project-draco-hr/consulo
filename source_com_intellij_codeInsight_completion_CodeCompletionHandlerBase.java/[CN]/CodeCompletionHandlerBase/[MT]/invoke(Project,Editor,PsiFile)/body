{
  if (!file.isWritable()) {
    if (!FileDocumentManager.fileForDocumentCheckedOutSuccessfully(editor.getDocument(),project)) {
      return;
    }
  }
  final CodeInsightSettings settings=CodeInsightSettings.getInstance();
  Lookup activeLookup=LookupManager.getInstance(project).getActiveLookup();
  if (activeLookup != null) {
    Class<? extends CodeCompletionHandlerBase> handlerClass=activeLookup.getUserData(COMPLETION_HANDLER_CLASS_KEY);
    if (handlerClass == null) {
      handlerClass=CodeCompletionHandler.class;
    }
    if (handlerClass.equals(this.getClass())) {
      if (!isAutocompleteCommonPrefixOnInvocation() || activeLookup.fillInCommonPrefix(true)) {
        return;
      }
    }
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      EditorUtil.fillVirtualSpaceUntil(editor,editor.getCaretModel().getLogicalPosition().column,editor.getCaretModel().getLogicalPosition().line);
      PsiDocumentManager.getInstance(project).commitAllDocuments();
    }
  }
);
  final int offset1=editor.getSelectionModel().hasSelection() ? editor.getSelectionModel().getSelectionStart() : editor.getCaretModel().getOffset();
  final int offset2=editor.getSelectionModel().hasSelection() ? editor.getSelectionModel().getSelectionEnd() : offset1;
  final CompletionContext context=new CompletionContext(project,editor,file,offset1,offset2);
  final LookupData data=getLookupData(context);
  final LookupItem[] items=data.items;
  String prefix=data.prefix;
  context.prefix=data.prefix;
  if (items.length == 0) {
    handleEmptyLookup(context,data);
    return;
  }
  final int startOffset=offset1 - prefix.length();
  String uniqueText=null;
  LookupItem item=null;
  boolean doNotAutocomplete=false;
  boolean signatureSencetive=false;
  for (  final LookupItem item1 : items) {
    if (item1.getAttribute(LookupItem.DO_NOT_AUTOCOMPLETE_ATTR) != null) {
      item=null;
      doNotAutocomplete=true;
      break;
    }
    if (item1.getAttribute(LookupItem.FORCE_SHOW_SIGNATURE_ATTR) != null) {
      signatureSencetive=true;
    }
    if (uniqueText == null) {
      uniqueText=item1.getLookupString();
      item=item1;
    }
 else {
      if (!uniqueText.equals(item1.getLookupString())) {
        item=null;
        break;
      }
      if (item.getObject() instanceof PsiMethod && item1.getObject() instanceof PsiMethod) {
        if (!signatureSencetive) {
          final PsiParameter[] parms=((PsiMethod)item1.getObject()).getParameterList().getParameters();
          if (parms.length > 0) {
            item=item1;
          }
        }
 else {
          item=null;
          break;
        }
      }
 else {
        item=null;
        break;
      }
    }
  }
  if (item != null) {
    if (!isAutocompleteOnInvocation() && item.getAttribute(LookupItem.DO_AUTOCOMPLETE_ATTR) == null) {
      item=null;
    }
  }
  if (item != null && context.identifierEndOffset != context.selectionEndOffset) {
    if (item.getAttribute(LookupItem.DO_AUTOCOMPLETE_ATTR) == null) {
      item=null;
    }
  }
  if (item != null) {
    if (item.getObject() instanceof DeferredUserLookupValue) {
      if (!((DeferredUserLookupValue)item.getObject()).handleUserSelection(item,context.project)) {
        return;
      }
      uniqueText=item.getLookupString();
      context.startOffset-=prefix.length();
      data.prefix=context.prefix="";
    }
    EditorModificationUtil.deleteSelectedText(editor);
    if (!uniqueText.toLowerCase().startsWith(prefix.toLowerCase())) {
      FeatureUsageTracker.getInstance().triggerFeatureUsed("editing.completion.camelHumps");
    }
    editor.getDocument().replaceString(offset1 - prefix.length(),offset1,uniqueText);
    final int offset=offset1 - prefix.length() + uniqueText.length();
    editor.getCaretModel().moveToOffset(offset);
    editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    editor.getSelectionModel().removeSelection();
    lookupItemSelected(context,startOffset,data,item,false,(char)0);
  }
 else {
    if (isAutocompleteCommonPrefixOnInvocation() && !doNotAutocomplete) {
      final String newPrefix=fillInCommonPrefix(items,prefix,editor);
      if (!newPrefix.equals(prefix)) {
        final int shift=newPrefix.length() - prefix.length();
        context.prefix=newPrefix;
        prefix=newPrefix;
        context.shiftOffsets(shift);
        editor.getCaretModel().moveToOffset(context.startOffset + shift);
        editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
      }
    }
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    final RangeMarker startOffsetMarker=editor.getDocument().createRangeMarker(startOffset,startOffset);
    final Lookup lookup=showLookup(project,editor,items,prefix,data,file);
    if (lookup != null) {
      lookup.putUserData(COMPLETION_HANDLER_CLASS_KEY,this.getClass());
      lookup.addLookupListener(new LookupAdapter(){
        public void itemSelected(        LookupEvent event){
          int shift=startOffsetMarker.getStartOffset() - startOffset;
          context.shiftOffsets(shift);
          context.startOffset+=shift;
          lookupItemSelected(context,startOffsetMarker.getStartOffset(),data,event.getItem(),settings.SHOW_SIGNATURES_IN_LOOKUPS || event.getItem().getAttribute(LookupItem.FORCE_SHOW_SIGNATURE_ATTR) != null,event.getCompletionChar());
        }
      }
);
    }
  }
}
