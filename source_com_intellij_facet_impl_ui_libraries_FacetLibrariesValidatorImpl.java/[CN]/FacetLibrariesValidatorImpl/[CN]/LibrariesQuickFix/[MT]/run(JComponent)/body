{
  Library[] allLibraries=myContext.getLibraries();
  List<Library> suitableLibraries=new ArrayList<Library>();
  RequiredLibrariesInfo missingLibrariesInfo=new RequiredLibrariesInfo(myMissingLibraries);
  for (  Library library : allLibraries) {
    if (myAddedLibraries.contains(library))     continue;
    if (missingLibrariesInfo.checkLibraries(myContext.getFiles(library,OrderRootType.CLASSES)) == null) {
      suitableLibraries.add(library);
    }
  }
  final Ref<ListPopup> popupRef=Ref.create(null);
  final String useLibrary=IdeBundle.message("facet.libraries.use.library.popup.item");
  final String downloadJars=IdeBundle.message("facet.libraries.download.jars.popup.item");
  final String addJars=IdeBundle.message("facet.libraries.create.new.library.popup.item");
  final BaseListPopupStep librariesStep;
  List<String> popupItems=new ArrayList<String>();
  if (!suitableLibraries.isEmpty()) {
    librariesStep=new BaseListPopupStep<Library>(IdeBundle.message("add.library.popup.title"),suitableLibraries,Icons.LIBRARY_ICON){
      @NotNull public String getTextFor(      final Library value){
        return value.getName();
      }
      public PopupStep onChosen(      final Library selectedValue,      final boolean finalChoice){
        addLibrary(selectedValue);
        return FINAL_CHOICE;
      }
    }
;
    popupItems.add(useLibrary);
  }
 else {
    librariesStep=null;
  }
  if (canDownload(myMissingLibraries)) {
    popupItems.add(downloadJars);
  }
  popupItems.add(addJars);
  final BaseListPopupStep popupStep=new BaseListPopupStep<String>(null,popupItems,QUICK_FIX_ICON){
    public boolean hasSubstep(    final String selectedValue){
      return useLibrary.equals(selectedValue);
    }
    public PopupStep onChosen(    final String selectedValue,    final boolean finalChoice){
      if (useLibrary.equals(selectedValue)) {
        return librariesStep;
      }
      popupRef.get().cancel();
      if (downloadJars.equals(selectedValue)) {
        downloadJars(myMissingLibraries,place);
      }
 else {
        addJars(place);
      }
      return FINAL_CHOICE;
    }
  }
;
  final ListPopup popup=JBPopupFactory.getInstance().createListPopup(popupStep);
  popupRef.set(popup);
  popup.showUnderneathOf(place);
}
