{
  State state=State.TEXT;
  int dataStartOffset=start;
  int tagNameStartOffset=start;
  String tagName=null;
  for (; start < end; start++) {
    char c=text.charAt(start);
switch (state) {
case TEXT:
      if (c == '<') {
        if (start > dataStartOffset) {
          if (!callback.onText(text.substring(dataStartOffset,start).replace("&nbsp;"," "))) {
            return dataStartOffset;
          }
        }
        dataStartOffset=start;
        if (start < text.length() - 1 && text.charAt(start + 1) == '/') {
          state=State.INSIDE_CLOSE_TAG;
          tagNameStartOffset=++start + 1;
        }
 else {
          state=State.INSIDE_OPEN_TAG;
          tagNameStartOffset=start + 1;
        }
      }
    break;
case INSIDE_OPEN_TAG:
  if (c == ' ') {
    tagName=text.substring(tagNameStartOffset,start);
  }
 else   if (c == '/') {
    if (start < text.length() - 1 && text.charAt(start + 1) == '>') {
      if (tagName == null) {
        tagName=text.substring(tagNameStartOffset,start);
      }
      if (!callback.onStandaloneTag(tagName,text.substring(dataStartOffset,start + 2))) {
        return dataStartOffset;
      }
      tagName=null;
      state=State.TEXT;
      dataStartOffset=++start + 1;
      break;
    }
  }
 else   if (c == '>') {
    if (tagName == null) {
      tagName=text.substring(tagNameStartOffset,start);
    }
    if (!callback.onOpenTag(tagName,text.substring(dataStartOffset,start + 1))) {
      return dataStartOffset;
    }
    tagName=null;
    state=State.TEXT;
    dataStartOffset=start + 1;
  }
break;
case INSIDE_CLOSE_TAG:
if (c == '>') {
if (tagName == null) {
  tagName=text.substring(tagNameStartOffset,start);
}
if (!callback.onCloseTag(tagName,text.substring(dataStartOffset,start + 1))) {
  return dataStartOffset;
}
tagName=null;
state=State.TEXT;
dataStartOffset=start + 1;
}
}
}
return start;
}
