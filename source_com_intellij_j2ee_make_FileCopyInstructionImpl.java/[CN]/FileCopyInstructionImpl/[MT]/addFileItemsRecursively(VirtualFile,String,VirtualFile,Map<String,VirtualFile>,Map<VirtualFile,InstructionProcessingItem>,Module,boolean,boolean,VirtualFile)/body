{
  if (myFileFilter != null && !myFileFilter.accept(new File(virtualFile.getPath())))   return;
  if (virtualFile.isDirectory()) {
    VirtualFile[] children=virtualFile.getChildren();
    VirtualFile[] explodedChildren=fileInExplodedPath == null ? null : fileInExplodedPath.getChildren();
    if (explodedChildren == null)     explodedChildren=VirtualFile.EMPTY_ARRAY;
    if (explodedFilesMap == null) {
      explodedFilesMap=new THashMap<String,VirtualFile>();
    }
    for (    VirtualFile file : explodedChildren) {
      String childRelativePath=MakeUtil.appendToPath(outputRelativePath,file.getName());
      explodedFilesMap.put(childRelativePath,file);
    }
    for (    final VirtualFile child : children) {
      String childRelativePath=MakeUtil.appendToPath(outputRelativePath,child.getName());
      VirtualFile childFileInExploded=fileInExplodedPath == null ? null : explodedFilesMap.get(childRelativePath);
      addFileItemsRecursively(child,childRelativePath,childFileInExploded,explodedFilesMap,items,targetModule,isExplodedEnabled,jarEnabled,jarFile);
    }
  }
 else {
    InstructionProcessingItem processingItem=items.get(virtualFile);
    if (processingItem == null) {
      processingItem=new InstructionProcessingItem(virtualFile);
      items.put(virtualFile,processingItem);
    }
    boolean targetFileExists=(!isExplodedEnabled || fileInExplodedPath != null) && (!jarEnabled || jarFile != null);
    processingItem.addInstructionInfo(new InstructionProcessingItem.InstructionInfo(this,outputRelativePath,targetModule,targetFileExists));
  }
}
