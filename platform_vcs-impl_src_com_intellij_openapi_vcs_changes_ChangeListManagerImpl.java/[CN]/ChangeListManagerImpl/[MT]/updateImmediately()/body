{
  final DataHolder dataHolder;
  final ProjectLevelVcsManager vcsManager=ProjectLevelVcsManager.getInstance(myProject);
  if (!vcsManager.hasActiveVcss())   return;
  final VcsInvalidated invalidated=myDirtyScopeManager.retrieveScopes();
  if (checkScopeIsEmpty(invalidated))   return;
  final boolean wasEverythingDirty=invalidated.isEverythingDirty();
  final List<VcsDirtyScope> scopes=invalidated.getScopes();
  try {
    checkIfDisposed();
synchronized (myDataLock) {
      dataHolder=new DataHolder((FileHolderComposite)myComposite.copy(),myWorker.copy(),wasEverythingDirty);
      myModifier.enterUpdate();
      if (wasEverythingDirty) {
        myUpdateException=null;
        myAdditionalInfo.clear();
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("refresh procedure started, everything = " + wasEverythingDirty);
      }
    }
    dataHolder.notifyStart();
    myChangesViewManager.scheduleRefresh();
    myUpdateChangesProgressIndicator=createProgressIndicator();
    iterateScopes(dataHolder,scopes,wasEverythingDirty);
    final boolean takeChanges=(myUpdateException == null);
    if (takeChanges) {
      updateIgnoredFiles(dataHolder.getComposite());
    }
    clearCurrentRevisionsCache(invalidated);
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
synchronized (myDataLock) {
          dataHolder.notifyEnd();
          myModifier.finishUpdate(dataHolder.getChangeListWorker());
          if (takeChanges) {
            final ChangeListWorker oldWorker=myWorker;
            myWorker=dataHolder.getChangeListWorker();
            myWorker.onAfterWorkerSwitch(oldWorker);
            myModifier.setWorker(myWorker);
            if (LOG.isDebugEnabled()) {
              LOG.debug("refresh procedure finished, size: " + dataHolder.getComposite().getVFHolder(FileHolder.HolderType.UNVERSIONED).getSize());
            }
            final boolean statusChanged=!myComposite.equals(dataHolder.getComposite());
            myComposite=dataHolder.getComposite();
            if (statusChanged) {
              myDelayedNotificator.getProxyDispatcher().unchangedFileStatusChanged();
            }
          }
          myShowLocalChangesInvalidated=false;
        }
      }
    }
);
    myChangesViewManager.scheduleRefresh();
  }
 catch (  DisposedException e) {
  }
catch (  ProcessCanceledException e) {
  }
catch (  RuntimeInterruptedException ignore) {
  }
catch (  Exception ex) {
    LOG.error(ex);
  }
catch (  AssertionError ex) {
    LOG.error(ex);
  }
 finally {
    myDirtyScopeManager.changesProcessed();
synchronized (myDataLock) {
      myDelayedNotificator.getProxyDispatcher().changeListUpdateDone();
      myChangesViewManager.scheduleRefresh();
    }
  }
}
