{
  final FileHolderComposite composite;
  final ChangeListWorker changeListWorker;
  final ProjectLevelVcsManager vcsManager=ProjectLevelVcsManager.getInstance(myProject);
  if (!vcsManager.hasActiveVcss())   return;
  final VcsDirtyScopeManagerImpl dirtyScopeManager=getVcsManager();
  if (dirtyScopeManager == null)   return;
  final VcsInvalidated invalidated=dirtyScopeManager.retrieveScopes();
  if (invalidated == null || invalidated.isEmpty()) {
    if (invalidated != null && invalidated.isEmpty() && invalidated.isEverythingDirty()) {
      VcsDirtyScopeManager.getInstance(myProject).markEverythingDirty();
    }
    return;
  }
  final boolean wasEverythingDirty=invalidated.isEverythingDirty();
  final List<VcsDirtyScope> scopes=invalidated.getScopes();
  if (!wasEverythingDirty) {
    filterOutIgnoredFiles(scopes);
    if (scopes.isEmpty()) {
      return;
    }
  }
  try {
    checkIfDisposed();
synchronized (myDataLock) {
      changeListWorker=myWorker.copy();
      composite=(FileHolderComposite)myComposite.copy();
      myModifier.enterUpdate();
      if (wasEverythingDirty) {
        myUpdateException=null;
        composite.cleanAll();
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("refresh procedure started, everything = " + wasEverythingDirty);
      }
    }
    if (wasEverythingDirty) {
      changeListWorker.notifyStartProcessingChanges(null);
    }
    myChangesViewManager.scheduleRefresh();
    final ChangeListManagerGate gate=changeListWorker.createSelfGate();
    final UpdatingChangeListBuilder builder=new UpdatingChangeListBuilder(changeListWorker,composite,new Getter<Boolean>(){
      public Boolean get(){
        return myUpdater.isStopped();
      }
    }
,myIgnoredIdeaLevel,gate);
    myUpdateChangesProgressIndicator=new EmptyProgressIndicator(){
      @Override public boolean isCanceled(){
        return myUpdater.isStopped() || atomicSectionsAware.shouldExitAsap();
      }
      @Override public void checkCanceled(){
        checkIfDisposed();
        atomicSectionsAware.checkShouldExit();
      }
    }
;
    for (    final VcsDirtyScope scope : scopes) {
      atomicSectionsAware.checkShouldExit();
      final AbstractVcs vcs=scope.getVcs();
      if (vcs == null)       continue;
      final VcsModifiableDirtyScope adjustedScope=vcs.adjustDirtyScope((VcsModifiableDirtyScope)scope);
      myChangesViewManager.updateProgressText(VcsBundle.message("changes.update.progress.message",vcs.getDisplayName()),false);
      if (!wasEverythingDirty) {
        composite.cleanAndAdjustScope(adjustedScope);
        changeListWorker.notifyStartProcessingChanges(adjustedScope);
      }
      try {
        actualUpdate(wasEverythingDirty,composite,builder,adjustedScope,vcs,changeListWorker,gate);
      }
 catch (      Throwable t) {
        LOG.debug(t);
        Rethrow.reThrowRuntime(t);
      }
      if (myUpdateException != null)       break;
    }
    final boolean takeChanges=(myUpdateException == null);
    if (takeChanges) {
      updateIgnoredFiles(composite);
    }
synchronized (myDataLock) {
      if (wasEverythingDirty) {
        changeListWorker.notifyDoneProcessingChanges(myDelayedNotificator.getProxyDispatcher());
      }
      myModifier.exitUpdate();
      myModifier.apply(changeListWorker);
      myModifier.clearQueue();
      if (takeChanges) {
        myWorker.takeData(changeListWorker);
      }
      if (takeChanges) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("refresh procedure finished, size: " + composite.getVFHolder(FileHolder.HolderType.UNVERSIONED).getSize());
        }
        final boolean statusChanged=!myComposite.equals(composite);
        myComposite=composite;
        if (statusChanged) {
          myDelayedNotificator.getProxyDispatcher().unchangedFileStatusChanged();
        }
      }
      myShowLocalChangesInvalidated=false;
    }
    myChangesViewManager.scheduleRefresh();
  }
 catch (  DisposedException e) {
  }
catch (  ProcessCanceledException e) {
  }
catch (  RuntimeInterruptedException ignore) {
  }
catch (  Exception ex) {
    LOG.error(ex);
  }
catch (  AssertionError ex) {
    LOG.error(ex);
  }
 finally {
    dirtyScopeManager.changesProcessed();
synchronized (myDataLock) {
      myDelayedNotificator.getProxyDispatcher().changeListUpdateDone();
      myChangesViewManager.scheduleRefresh();
    }
  }
}
