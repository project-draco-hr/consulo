{
  try {
    final ChangeProvider changeProvider=vcs.getChangeProvider();
    if (changeProvider != null) {
      final FoldersCutDownWorker foldersCutDownWorker=new FoldersCutDownWorker();
      try {
        builder.setCurrent(scope,foldersCutDownWorker);
        changeProvider.getChanges(scope,builder,myUpdateChangesProgressIndicator,gate);
      }
 catch (      final VcsException e) {
        LOG.info(e);
        if (e instanceof VcsConnectionProblem) {
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            @Override public void run(){
              ((VcsConnectionProblem)e).attemptQuickFix(false);
            }
          }
);
        }
        if (myUpdateException == null) {
          if (ApplicationManager.getApplication().isUnitTestMode()) {
            e.printStackTrace();
          }
          myUpdateException=e;
        }
      }
    }
  }
 catch (  Throwable t) {
    LOG.debug(t);
    Rethrow.reThrowRuntime(t);
  }
 finally {
    if (!myUpdater.isStopped()) {
      dataHolder.notifyDoneProcessingChanges();
    }
  }
}
