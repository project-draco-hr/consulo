{
  final LanguageLevelProjectExtension projectExt=LanguageLevelProjectExtension.getInstance(getProject());
  final LanguageLevelModuleExtension moduleExt=LanguageLevelModuleExtension.getInstance(getModule());
  final LanguageLevel projectLevel=projectExt.getLanguageLevel();
  final LanguageLevel moduleLevel=moduleExt.getLanguageLevel();
  try {
    projectExt.setLanguageLevel(level);
    final LanguageLevelModuleExtension modifiable=(LanguageLevelModuleExtension)moduleExt.getModifiableModel(true);
    modifiable.setLanguageLevel(level);
    modifiable.commit();
    r.run();
  }
  finally {
    final LanguageLevelModuleExtension modifiable=(LanguageLevelModuleExtension)moduleExt.getModifiableModel(true);
    modifiable.setLanguageLevel(moduleLevel);
    modifiable.commit();
    projectExt.setLanguageLevel(projectLevel);
  }
}
