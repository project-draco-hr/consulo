{
  final List<Pair<File,DownloadableFileDescription>> downloadedFiles=new ArrayList<Pair<File,DownloadableFileDescription>>();
  final List<Pair<File,DownloadableFileDescription>> existingFiles=new ArrayList<Pair<File,DownloadableFileDescription>>();
  final Ref<Exception> exceptionRef=Ref.create(null);
  final Ref<DownloadableFileDescription> currentFile=new Ref<DownloadableFileDescription>();
  final File ioDir=VfsUtilCore.virtualToIoFile(dir);
  ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    @Override public void run(){
      final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
      try {
        for (int i=0; i < myFileDescriptions.size(); i++) {
          DownloadableFileDescription description=myFileDescriptions.get(i);
          currentFile.set(description);
          if (indicator != null) {
            indicator.checkCanceled();
            indicator.setText(IdeBundle.message("progress.downloading.0.of.1.file.text",i + 1,myFileDescriptions.size()));
          }
          final File existing=new File(ioDir,description.getDefaultFileName());
          long size=existing.exists() ? existing.length() : -1;
          if (!download(description,size,downloadedFiles)) {
            existingFiles.add(Pair.create(existing,description));
          }
        }
      }
 catch (      ProcessCanceledException e) {
        exceptionRef.set(e);
      }
catch (      IOException e) {
        exceptionRef.set(e);
      }
    }
  }
,myDialogTitle,true,myProject,myParent);
  Exception exception=exceptionRef.get();
  if (exception != null) {
    deleteFiles(downloadedFiles);
    if (exception instanceof IOException) {
      String message=IdeBundle.message("error.file.download.failed",exception.getMessage());
      if (currentFile.get() != null) {
        message+=": " + currentFile.get().getDownloadUrl();
      }
      final boolean tryAgain=IOExceptionDialog.showErrorDialog(myDialogTitle,message);
      if (tryAgain) {
        return doDownload(dir);
      }
    }
    return null;
  }
  try {
    return moveToDir(existingFiles,downloadedFiles,dir);
  }
 catch (  IOException e) {
    if (myProject != null) {
      Messages.showErrorDialog(myProject,myDialogTitle,e.getMessage());
    }
 else {
      Messages.showErrorDialog(myParent,myDialogTitle,e.getMessage());
    }
    return null;
  }
}
