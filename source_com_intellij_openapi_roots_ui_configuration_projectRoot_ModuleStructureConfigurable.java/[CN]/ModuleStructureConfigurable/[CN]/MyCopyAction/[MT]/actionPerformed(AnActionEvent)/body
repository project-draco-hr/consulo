{
  final NamedConfigurable namedConfigurable=getSelectedConfugurable();
  if (namedConfigurable instanceof ModuleConfigurable) {
    try {
      final String modulePresentation=IdeBundle.message("project.new.wizard.module.identification");
      final NamePathComponent component=new NamePathComponent(IdeBundle.message("label.project.name"),IdeBundle.message("label.component.file.location",StringUtil.capitalize(modulePresentation)),'a','l',IdeBundle.message("title.select.project.file.directory",modulePresentation),IdeBundle.message("description.select.project.file.directory",StringUtil.capitalize(modulePresentation)));
      final DialogWrapper dlg=new DialogWrapper(myTree,false){
{
          setTitle("Copy module");
          init();
        }
        public JComponent getPreferredFocusedComponent(){
          return component.getNameComponent();
        }
        @Nullable protected JComponent createCenterPanel(){
          return component;
        }
        protected void doOKAction(){
          if (component.getNameValue().length() == 0) {
            Messages.showErrorDialog("Enter module copy name",CommonBundle.message("title.error"));
            return;
          }
          if (component.getPath().length() == 0) {
            Messages.showErrorDialog(IdeBundle.message("prompt.enter.project.file.location",modulePresentation),CommonBundle.message("title.error"));
            return;
          }
          if (!ProjectWizardUtil.createDirectoryIfNotExists(IdeBundle.message("directory.project.file.directory",modulePresentation),component.getPath(),true)) {
            Messages.showErrorDialog("Path \'" + component.getPath() + "\' is invalid",CommonBundle.message("title.error"));
            return;
          }
          super.doOKAction();
        }
      }
;
      dlg.show();
      if (!dlg.isOK())       return;
      final ModifiableRootModel rootModel=((ModuleConfigurable)namedConfigurable).getModuleEditor().getModifiableRootModel();
      final String path=component.getPath();
      final ModuleBuilder builder=new ModuleBuilder(){
        public void setupRootModel(        final ModifiableRootModel modifiableRootModel) throws ConfigurationException {
          if (ModuleJdkUtil.isJdkInherited(rootModel)) {
            ModuleJdkUtil.inheritJdk(modifiableRootModel);
          }
 else {
            ModuleJdkUtil.setJdk(modifiableRootModel,ModuleJdkUtil.getJdk(rootModel));
          }
          modifiableRootModel.inheritCompilerOutputPath(true);
          JavaModuleExtension.getInstance(modifiableRootModel.getModule()).setLanguageLevel(JavaModuleExtension.getInstance(rootModel.getModule()).getLanguageLevel());
          for (          OrderEntry entry : rootModel.getOrderEntries()) {
            if (entry instanceof JdkOrderEntry)             continue;
            if (entry instanceof ModuleSourceOrderEntry)             continue;
            if (entry instanceof ClonableOrderEntry) {
              modifiableRootModel.addOrderEntry(((ClonableOrderEntry)entry).cloneEntry((RootModelImpl)modifiableRootModel,(ProjectRootManagerImpl)ProjectRootManager.getInstance(myProject),VirtualFilePointerManager.getInstance()));
            }
          }
          VirtualFile content=LocalFileSystem.getInstance().findFileByPath(component.getPath());
          if (content == null) {
            content=LocalFileSystem.getInstance().refreshAndFindFileByPath(component.getPath());
          }
          modifiableRootModel.addContentEntry(content);
        }
        public ModuleType getModuleType(){
          return rootModel.getModule().getModuleType();
        }
      }
;
      builder.setName(component.getNameValue());
      builder.setModuleFilePath(path + "/" + builder.getName()+ ".iml");
      final Module module=myContext.myModulesConfigurator.addModule(builder);
      if (module != null) {
        addModuleNode(module);
      }
    }
 catch (    Exception e1) {
      LOG.error(e1);
    }
  }
}
