{
  lookup.refreshUi(false);
  CompletionProcess completion=CompletionService.getCompletionService().getCurrentCompletion();
  if (completion == null || !completion.isAutopopupCompletion()) {
    return false;
  }
  if (lookup.isSelectionTouched()) {
    return false;
  }
  final PsiFile file=lookup.getPsiFile();
  if (file == null)   return false;
  final Editor editor=lookup.getEditor();
  PsiDocumentManager.getInstance(file.getProject()).commitDocument(editor.getDocument());
  final int end=editor.getCaretModel().getOffset();
  final int start=lookup.getLookupStart();
  final String prefix=!lookup.getItems().isEmpty() ? editor.getDocument().getText(TextRange.create(start,end)) : ListTemplatesHandler.getPrefix(editor.getDocument(),end);
  final TemplateImpl template=LiveTemplateCompletionContributor.findApplicableTemplate(file,start,prefix);
  return template != null && shortcutChar == TemplateSettings.getInstance().getShortcutChar(template);
}
