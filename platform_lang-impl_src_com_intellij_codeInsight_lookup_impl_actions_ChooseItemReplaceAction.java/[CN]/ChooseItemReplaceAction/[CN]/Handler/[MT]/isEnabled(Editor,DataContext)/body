{
  LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(editor);
  if (lookup != null) {
    CompletionProcess completion=CompletionService.getCompletionService().getCurrentCompletion();
    if (completion != null && completion.isAutopopupCompletion() && hasTemplatePrefix(lookup,TemplateSettings.TAB_CHAR)) {
      return false;
    }
    if (lookup.isFocused()) {
      return true;
    }
    if (lookup.isCompletion()) {
      lookup.refreshUi();
      return !lookup.getItems().isEmpty();
    }
  }
  return false;
}
