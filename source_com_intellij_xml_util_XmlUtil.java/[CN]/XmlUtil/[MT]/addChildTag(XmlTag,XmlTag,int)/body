{
  if (parent.getSubTags().length == 0 && parent.getText().endsWith("/>")) {
    final PsiElementFactory factory=parent.getManager().getElementFactory();
    final String name=parent.getName();
    final String text=parent.getText();
    final XmlTag tag=factory.createTagFromText(text.substring(0,text.length() - 2) + "></" + name+ ">");
    parent=(XmlTag)parent.replace(tag);
  }
  final XmlElementDescriptor parentDescriptor=parent.getDescriptor();
  final XmlTag[] subTags=parent.getSubTags();
  if (parentDescriptor == null || subTags.length == 0)   return (XmlTag)parent.add(child);
  int subTagNum=-1;
  for (  XmlElementDescriptor childElementDescriptor : parentDescriptor.getElementsDescriptors(parent)) {
    final String childElementName=childElementDescriptor.getName();
    int prevSubTagNum=subTagNum;
    while (subTagNum < subTags.length - 1 && subTags[subTagNum + 1].getName().equals(childElementName)) {
      subTagNum++;
    }
    if (childElementName.equals(child.getLocalName())) {
      subTagNum=index == -1 || index > subTagNum - prevSubTagNum ? subTagNum : prevSubTagNum + index;
      return (XmlTag)(subTagNum == -1 ? parent.addBefore(child,subTags[0]) : parent.addAfter(child,subTags[subTagNum]));
    }
  }
  return (XmlTag)parent.add(child);
}
