{
  Collection<TreeElement> ungroupedObjects=collectValues(ungrouped);
  Collection<Group> groups=grouper.group(ungroupedObjects);
  Map<Group,GroupWrapper> groupNodes=createGroupNodes(groups);
  for (Iterator<Group> eachGroup=groups.iterator(); eachGroup.hasNext(); ) {
    Group group=eachGroup.next();
    for (Iterator<AbstractTreeNode> eachUngrNode=ungrouped.iterator(); eachUngrNode.hasNext(); ) {
      AbstractTreeNode node=eachUngrNode.next();
      if (group.contains((TreeElement)node.getValue())) {
        GroupWrapper groupWrapper=groupNodes.get(group);
        groupWrapper.addSubElement((CachingChildrenTreeNode)node);
        node.setParent(groupWrapper);
        eachUngrNode.remove();
      }
    }
  }
}
