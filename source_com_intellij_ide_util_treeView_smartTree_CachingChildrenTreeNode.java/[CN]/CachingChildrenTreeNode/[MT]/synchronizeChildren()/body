{
  if (myOldChildren != null && myChildren != null) {
    HashMap<Object,CachingChildrenTreeNode> oldValuesToChildrenMap=new HashMap<Object,CachingChildrenTreeNode>();
    for (    CachingChildrenTreeNode oldChild : myOldChildren) {
      final Object oldValue=oldChild instanceof TreeElementWrapper ? oldChild.getValue() : oldChild;
      if (oldValue != null) {
        oldValuesToChildrenMap.put(oldValue,oldChild);
      }
    }
    for (int i=0; i < myChildren.size(); i++) {
      CachingChildrenTreeNode newChild=myChildren.get(i);
      final Object newValue=newChild instanceof TreeElementWrapper ? newChild.getValue() : newChild;
      if (newValue != null) {
        final CachingChildrenTreeNode oldChild=oldValuesToChildrenMap.get(newValue);
        if (oldChild != null) {
          oldChild.copyFromNewInstance(newChild);
          oldChild.setValue(newChild.getValue());
          myChildren.set(i,oldChild);
        }
      }
    }
    myOldChildren=null;
  }
}
