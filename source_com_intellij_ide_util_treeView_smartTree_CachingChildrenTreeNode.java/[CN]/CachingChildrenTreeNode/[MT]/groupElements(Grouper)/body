{
  ArrayList<AbstractTreeNode<TreeElement>> ungrouped=new ArrayList<AbstractTreeNode<TreeElement>>();
  Collection<AbstractTreeNode> children=getChildren();
  for (  final AbstractTreeNode aChildren : children) {
    CachingChildrenTreeNode<TreeElement> node=(CachingChildrenTreeNode<TreeElement>)aChildren;
    if (node instanceof TreeElementWrapper) {
      ungrouped.add(node);
    }
 else {
      node.groupElements(grouper);
    }
  }
  if (ungrouped.size() != 0) {
    processUngrouped(ungrouped,grouper);
  }
  Collection<AbstractTreeNode> result=new ArrayList<AbstractTreeNode>();
  for (  AbstractTreeNode child : children) {
    AbstractTreeNode parent=child.getParent();
    if (parent != this) {
      if (!result.contains(parent))       result.add(parent);
    }
 else {
      result.add(child);
    }
  }
  setChildren(result);
}
