{
  TreeElement element=this;
  startFind:   while (true) {
    TreeElement child=element.getFirstChildNode();
    while (child != null) {
      final int textLength=child.getTextLength();
      if (textLength > offset) {
        if (child instanceof LeafElement) {
          if (child instanceof ForeignLeafPsiElement) {
            child=child.getTreeNext();
            continue;
          }
          return (LeafElement)child;
        }
        element=child;
        continue startFind;
      }
      offset-=textLength;
      child=child.getTreeNext();
    }
    return null;
  }
}
