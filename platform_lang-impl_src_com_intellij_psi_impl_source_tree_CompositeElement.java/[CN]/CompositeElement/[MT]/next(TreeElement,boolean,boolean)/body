{
  if (down) {
    CompositeElement composite=(CompositeElement)cur;
    TreeElement child=composite.firstChild;
    if (child != null) {
      LOG.assertTrue(child.getTreeParent() == composite,cur);
      return child;
    }
    if (update) {
      composite.myCachedLength=0;
    }
  }
  while (cur != this) {
    CompositeElement parent=cur.getTreeParent();
    int curLength=cur.getCachedLength();
    if (update) {
      LOG.assertTrue(curLength != NOT_CACHED,cur);
      parent.myCachedLength-=curLength;
    }
    TreeElement next=cur.getTreeNext();
    if (next != null) {
      LOG.assertTrue(next.getTreePrev() == cur,cur);
      return next;
    }
    LOG.assertTrue(parent.lastChild == cur,parent);
    if (update) {
      parent.myCachedLength=-parent.myCachedLength + NOT_CACHED;
    }
    cur=parent;
  }
  return null;
}
