{
  if (down) {
    CompositeElement composite=(CompositeElement)cur;
    TreeElement child=composite.firstChild;
    if (child != null) {
      LOG.assertTrue(child.getTreeParent() == composite,cur);
      return child;
    }
    composite.myCachedLength=0;
  }
  while (cur != this) {
    CompositeElement parent=cur.getTreeParent();
    parent.myCachedLength-=cur.getCachedLength();
    TreeElement next=cur.getTreeNext();
    if (next != null) {
      LOG.assertTrue(next.getTreePrev() == cur,cur);
      return next;
    }
    parent.myCachedLength=-parent.myCachedLength + NOT_CACHED;
    cur=parent;
  }
  return null;
}
