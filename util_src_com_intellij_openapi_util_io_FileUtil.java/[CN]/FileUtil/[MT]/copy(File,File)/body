{
  FileOutputStream fos;
  try {
    fos=new FileOutputStream(toFile);
  }
 catch (  FileNotFoundException e) {
    File parentFile=toFile.getParentFile();
    if (parentFile == null) {
      final IOException ioException=new IOException("parent file is null for " + toFile.getPath());
      ioException.initCause(e);
      throw ioException;
    }
    createParentDirs(toFile);
    fos=new FileOutputStream(toFile);
  }
  if (Patches.FILE_CHANNEL_TRANSFER_BROKEN) {
    FileInputStream fis=new FileInputStream(fromFile);
    try {
      copy(fis,fos);
    }
  finally {
      fis.close();
      fos.close();
    }
  }
 else {
    FileChannel fromChannel=new FileInputStream(fromFile).getChannel();
    FileChannel toChannel=fos.getChannel();
    try {
      fromChannel.transferTo(0,Long.MAX_VALUE,toChannel);
    }
  finally {
      fromChannel.close();
      toChannel.close();
    }
  }
  toFile.setLastModified(fromFile.lastModified());
}
