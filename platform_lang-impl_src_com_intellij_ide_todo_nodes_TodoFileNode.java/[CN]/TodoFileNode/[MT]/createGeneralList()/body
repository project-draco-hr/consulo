{
  ArrayList<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  PsiFile psiFile=getValue();
  final TodoItem[] items=findAllTodos(psiFile,myBuilder.getTodoTreeStructure().getSearchHelper());
  final Document document=PsiDocumentManager.getInstance(getProject()).getDocument(psiFile);
  if (document != null) {
    for (    final TodoItem todoItem : items) {
      if (todoItem.getTextRange().getEndOffset() < document.getTextLength() + 1) {
        final SmartTodoItemPointer pointer=new SmartTodoItemPointer(todoItem,document);
        TodoFilter todoFilter=getToDoFilter();
        if (todoFilter != null) {
          if (todoFilter.contains(todoItem.getPattern())) {
            children.add(new TodoItemNode(getProject(),pointer,myBuilder));
          }
        }
 else {
          children.add(new TodoItemNode(getProject(),pointer,myBuilder));
        }
      }
    }
  }
  Collections.sort(children,SmartTodoItemPointerComparator.ourInstance);
  return children;
}
