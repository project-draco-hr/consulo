{
  PsiFile psiFile=getValue();
  TodoItem[] items=findAllTodos(psiFile,myBuilder.getTodoTreeStructure().getSearchHelper());
  ArrayList<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>(items.length);
  Document document=PsiDocumentManager.getInstance(getProject()).getDocument(psiFile);
  if (document != null) {
    for (    TodoItem todoItem : items) {
      if (todoItem.getTextRange().getEndOffset() < document.getTextLength() + 1) {
        SmartTodoItemPointer pointer=new SmartTodoItemPointer(todoItem,document);
        TodoFilter toDoFilter=getToDoFilter();
        if (toDoFilter != null) {
          TodoItemNode itemNode=new TodoItemNode(getProject(),pointer,myBuilder);
          if (toDoFilter.contains(todoItem.getPattern())) {
            children.add(itemNode);
          }
        }
 else {
          children.add(new TodoItemNode(getProject(),pointer,myBuilder));
        }
      }
    }
  }
  Collections.sort(children,SmartTodoItemPointerComparator.ourInstance);
  return children;
}
