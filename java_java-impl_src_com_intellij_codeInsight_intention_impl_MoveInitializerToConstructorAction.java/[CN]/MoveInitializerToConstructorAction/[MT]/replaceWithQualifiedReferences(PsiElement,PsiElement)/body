{
  PsiReference reference=expression.getReference();
  if (reference != null) {
    PsiElement resolved=reference.resolve();
    if (resolved instanceof PsiVariable && !(resolved instanceof PsiField) && !PsiTreeUtil.isAncestor(root,resolved,false)) {
      PsiVariable variable=(PsiVariable)resolved;
      PsiElementFactory factory=JavaPsiFacade.getInstance(resolved.getProject()).getElementFactory();
      PsiElement qualifiedExpr=factory.createExpressionFromText("this." + variable.getName(),expression);
      expression.replace(qualifiedExpr);
    }
  }
 else {
    for (    PsiElement child : expression.getChildren()) {
      replaceWithQualifiedReferences(child,root);
    }
  }
}
