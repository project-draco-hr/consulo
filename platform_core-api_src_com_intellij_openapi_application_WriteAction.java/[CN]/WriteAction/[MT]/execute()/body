{
  final RunResult<T> result=new RunResult<T>(this);
  final Application application=ApplicationManager.getApplication();
  boolean dispatchThread=application.isDispatchThread();
  if (dispatchThread) {
    AccessToken token=start(getClass());
    try {
      result.run();
    }
  finally {
      token.finish();
    }
    return result;
  }
  if (application.isReadAccessAllowed()) {
    LOG.error("Must not start write action from within read action in the other thread - deadlock is coming");
  }
  TransactionGuard.getInstance().submitTransactionAndWait(new Runnable(){
    @Override public void run(){
      AccessToken token=start(WriteAction.this.getClass());
      try {
        result.run();
      }
  finally {
        token.finish();
      }
    }
  }
);
  result.throwException();
  return result;
}
