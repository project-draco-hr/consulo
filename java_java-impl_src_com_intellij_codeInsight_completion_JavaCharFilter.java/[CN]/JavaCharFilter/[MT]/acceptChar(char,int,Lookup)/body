{
  if (!lookup.isCompletion())   return null;
  if (!lookup.getPsiFile().getLanguage().isKindOf(JavaLanguage.INSTANCE)) {
    return null;
  }
  LookupElement item=lookup.getCurrentItem();
  if (item == null)   return null;
  final Object o=item.getObject();
  if (c == '!') {
    if (o instanceof PsiVariable) {
      if (PsiType.BOOLEAN.isAssignableFrom(((PsiVariable)o).getType()))       return Result.SELECT_ITEM_AND_FINISH_LOOKUP;
    }
    if (o instanceof PsiMethod) {
      final PsiType type=((PsiMethod)o).getReturnType();
      if (type != null && PsiType.BOOLEAN.isAssignableFrom(type))       return Result.SELECT_ITEM_AND_FINISH_LOOKUP;
    }
    return null;
  }
  if (c == '.' && isWithinLiteral(lookup))   return Result.ADD_TO_PREFIX;
  if (c == ':') {
    PsiFile file=lookup.getPsiFile();
    PsiDocumentManager.getInstance(file.getProject()).commitDocument(lookup.getEditor().getDocument());
    PsiElement element=lookup.getPsiElement();
    if (PsiTreeUtil.getParentOfType(element,PsiSwitchLabelStatement.class) != null || PsiTreeUtil.getParentOfType(element,PsiConditionalExpression.class) != null) {
      return Result.SELECT_ITEM_AND_FINISH_LOOKUP;
    }
    return Result.HIDE_LOOKUP;
  }
  if ((c == '[' || c == '<' || c == '.' || c == ' ' || c == '(') && isNonImportedClassEntered((LookupImpl)lookup,c == '.')) {
    return Result.HIDE_LOOKUP;
  }
  if (c == '[')   return CharFilter.Result.SELECT_ITEM_AND_FINISH_LOOKUP;
  if (c == '<' && o instanceof PsiClass)   return Result.SELECT_ITEM_AND_FINISH_LOOKUP;
  if (c == '(') {
    if (o instanceof PsiClass) {
      if (PsiJavaPatterns.psiElement().afterLeaf(PsiKeyword.NEW).accepts(lookup.getPsiElement())) {
        return Result.SELECT_ITEM_AND_FINISH_LOOKUP;
      }
      return Result.HIDE_LOOKUP;
    }
    if (o instanceof PsiType) {
      return Result.HIDE_LOOKUP;
    }
  }
  if ((c == ',' || c == '=') && o instanceof PsiVariable) {
    int lookupStart=((LookupImpl)lookup).getLookupStart();
    String name=((PsiVariable)o).getName();
    if (lookupStart >= 0 && name != null && name.equals(lookup.itemPattern(item))) {
      return Result.HIDE_LOOKUP;
    }
  }
  if (c == '#' && PsiTreeUtil.getParentOfType(lookup.getPsiElement(),PsiDocComment.class) != null) {
    if (o instanceof PsiClass) {
      return Result.SELECT_ITEM_AND_FINISH_LOOKUP;
    }
  }
  if (c == '(' && PsiKeyword.RETURN.equals(item.getLookupString())) {
    return Result.HIDE_LOOKUP;
  }
  return null;
}
