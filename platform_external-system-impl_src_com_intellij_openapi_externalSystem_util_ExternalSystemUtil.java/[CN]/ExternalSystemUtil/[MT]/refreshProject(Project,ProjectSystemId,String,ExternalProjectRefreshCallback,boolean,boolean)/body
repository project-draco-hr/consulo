{
  final TaskUnderProgress refreshProjectStructureTask=new TaskUnderProgress(){
    @SuppressWarnings({"ThrowableResultOfMethodCallIgnored","IOResourceOpenedButNotSafelyClosed"}) @Override public void execute(    @NotNull ProgressIndicator indicator){
      ExternalSystemResolveProjectTask task=new ExternalSystemResolveProjectTask(externalSystemId,project,externalProjectPath,resolveLibraries);
      task.execute(indicator);
      final Throwable error=task.getError();
      if (error == null) {
        DataNode<ProjectData> externalProject=task.getExternalProject();
        callback.onSuccess(externalProject);
        return;
      }
      String message=buildErrorMessage(error);
      if (StringUtil.isEmpty(message)) {
        message=String.format("Can't resolve %s project at '%s'. Reason: %s",ExternalSystemApiUtil.toReadableName(externalSystemId),externalProjectPath,message);
      }
      callback.onFailure(message,extractDetails(error));
    }
  }
;
  UIUtil.invokeAndWaitIfNeeded(new Runnable(){
    @Override public void run(){
      if (modal) {
        String title=ExternalSystemBundle.message("progress.import.text",ExternalSystemApiUtil.toReadableName(externalSystemId));
        ProgressManager.getInstance().run(new Task.Modal(project,title,false){
          @Override public void run(          @NotNull ProgressIndicator indicator){
            refreshProjectStructureTask.execute(indicator);
          }
        }
);
      }
 else {
        String title=ExternalSystemBundle.message("progress.refresh.text",ExternalSystemApiUtil.toReadableName(externalSystemId));
        ProgressManager.getInstance().run(new Task.Backgroundable(project,title){
          @Override public void run(          @NotNull ProgressIndicator indicator){
            refreshProjectStructureTask.execute(indicator);
          }
        }
);
      }
    }
  }
);
}
