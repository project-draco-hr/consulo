{
  ExternalSystemManager<?,?,?,?,?> manager=ExternalSystemApiUtil.getManager(externalSystemId);
  if (manager == null) {
    return;
  }
  AbstractExternalSystemSettings<?,?> settings=manager.getSettingsProvider().fun(project);
  final Collection<? extends ExternalProjectSettings> projectsSettings=settings.getLinkedProjectsSettings();
  if (projectsSettings.isEmpty()) {
    return;
  }
  final ProjectDataManager projectDataManager=ServiceManager.getService(ProjectDataManager.class);
  ExternalProjectRefreshCallback callback=new ExternalProjectRefreshCallback(){
    @NotNull private final Set<String> myExternalModuleNames=ContainerUtilRt.newHashSet();
    private int myCounter=projectsSettings.size();
    @Override public void onSuccess(    @Nullable DataNode<ProjectData> externalProject){
      if (externalProject == null) {
        return;
      }
      Collection<DataNode<ModuleData>> moduleNodes=ExternalSystemApiUtil.findAll(externalProject,ProjectKeys.MODULE);
      for (      DataNode<ModuleData> node : moduleNodes) {
        myExternalModuleNames.add(node.getData().getName());
      }
      projectDataManager.importData(externalProject.getKey(),Collections.singleton(externalProject),project,false);
      if (--myCounter <= 0) {
        processOrphanModules();
      }
    }
    @Override public void onFailure(    @NotNull String errorMessage,    @Nullable String errorDetails){
      if (--myCounter <= 0 && !project.isDisposed() && project.isOpen()) {
        processOrphanModules();
      }
    }
    private void processOrphanModules(){
      PlatformFacade platformFacade=ServiceManager.getService(PlatformFacade.class);
      List<Module> orphanIdeModules=ContainerUtilRt.newArrayList();
      String externalSystemIdAsString=externalSystemId.toString();
      for (      Module module : platformFacade.getModules(project)) {
        String s=module.getOptionValue(ExternalSystemConstants.EXTERNAL_SYSTEM_ID_KEY);
        if (externalSystemIdAsString.equals(s) && !myExternalModuleNames.contains(module.getName())) {
          orphanIdeModules.add(module);
        }
      }
      if (!orphanIdeModules.isEmpty()) {
        ruleOrphanModules(orphanIdeModules,project,externalSystemId);
      }
    }
  }
;
  for (  ExternalProjectSettings setting : projectsSettings) {
    refreshProject(project,externalSystemId,setting.getExternalProjectPath(),callback,true,false);
  }
}
