{
  final TemplateManagerImpl templateManager=(TemplateManagerImpl)TemplateManager.getInstance(getProject());
  try {
    templateManager.setTemplateTesting(true);
    configureByFile(BASE_PATH + fileName + ".java");
    SurroundWithHandler.invoke(getProject(),getEditor(),getFile(),surrounder);
    if (textToType != null) {
      type(textToType);
    }
    TemplateState templateState=TemplateManagerImpl.getTemplateState(getEditor());
    assertNotNull(templateState);
    templateState.nextTab();
    checkResultByFile(BASE_PATH + fileName + "_after.java");
  }
  finally {
    templateManager.setTemplateTesting(false);
  }
}
