{
  for (  PsiElement child : children) {
    LOG.assertTrue(child.isValid());
    final VirtualFile vFile;
    if (child instanceof PsiFile) {
      vFile=((PsiFile)child).getVirtualFile();
      addNode(moduleFileIndex,projectFileIndex,psiDir,vFile,container,PsiFileNode.class,child,viewSettings);
    }
 else     if (child instanceof PsiDirectory) {
      if (withSubDirectories) {
        PsiDirectory dir=(PsiDirectory)child;
        vFile=dir.getVirtualFile();
        if (!vFile.equals(projectFileIndex.getSourceRootForFile(vFile))) {
          if (viewSettings.isHideEmptyMiddlePackages() && !skipDirectory(psiDir) && isEmptyMiddleDirectory(dir,true)) {
            processPsiDirectoryChildren(dir,directoryChildrenInProject(dir),container,projectFileIndex,moduleFileIndex,viewSettings,withSubDirectories);
            continue;
          }
        }
        addNode(moduleFileIndex,projectFileIndex,psiDir,vFile,container,PsiDirectoryNode.class,child,viewSettings);
      }
    }
 else {
      LOG.error("Either PsiFile or PsiDirectory expected as a child of " + child.getParent() + ", but was "+ child);
    }
  }
}
