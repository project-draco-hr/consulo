{
  try {
    final PsiReference reference=file.findReferenceAt(selectionEndOffset);
    if (reference != null) {
      final List<TextRange> ranges=ReferenceRange.getAbsoluteRanges(reference);
      for (      TextRange range : ranges) {
        if (range.contains(selectionEndOffset)) {
          return range.getEndOffset();
        }
      }
      return reference.getElement().getTextRange().getStartOffset() + reference.getRangeInElement().getEndOffset();
    }
  }
 catch (  IndexNotReadyException ignored) {
  }
  final String text=file.getText();
  int idEnd=selectionEndOffset;
  while (idEnd < text.length() && Character.isJavaIdentifierPart(text.charAt(idEnd))) {
    idEnd++;
  }
  return idEnd;
}
