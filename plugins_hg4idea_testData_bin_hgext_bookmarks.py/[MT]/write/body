def write(repo):
    'Write bookmarks\n\n    Write the given bookmark => hash dictionary to the .hg/bookmarks file\n    in a format equal to those of localtags.\n\n    We also store a backup of the previous state in undo.bookmarks that\n    can be copied back on rollback.\n    '
    refs = repo._bookmarks
    if os.path.exists(repo.join('bookmarks')):
        util.copyfile(repo.join('bookmarks'), repo.join('undo.bookmarks'))
    if (repo._bookmarkcurrent not in refs):
        setcurrent(repo, None)
    wlock = repo.wlock()
    try:
        file = repo.opener('bookmarks', 'w', atomictemp=True)
        for (refspec, node) in refs.iteritems():
            file.write(('%s %s\n' % (hex(node), refspec)))
        file.rename()
    finally:
        wlock.release()
