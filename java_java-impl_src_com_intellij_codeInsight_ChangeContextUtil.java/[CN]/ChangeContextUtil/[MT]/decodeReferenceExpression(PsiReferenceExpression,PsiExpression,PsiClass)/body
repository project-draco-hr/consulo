{
  PsiManager manager=refExpr.getManager();
  PsiElementFactory factory=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory();
  PsiExpression qualifier=refExpr.getQualifierExpression();
  if (qualifier == null) {
    PsiMember refMember=refExpr.getCopyableUserData(REF_MEMBER_KEY);
    refExpr.putCopyableUserData(REF_MEMBER_KEY,null);
    if (refMember != null && refMember.isValid()) {
      PsiClass containingClass=refMember.getContainingClass();
      if (refMember.hasModifierProperty(PsiModifier.STATIC)) {
        PsiElement refElement=refExpr.resolve();
        if (!manager.areElementsEquivalent(refMember,refElement)) {
          refExpr.setQualifierExpression(factory.createReferenceExpression(containingClass));
        }
      }
 else {
        final PsiClass realParentClass=refExpr.getCopyableUserData(REF_MEMBER_THIS_CLASS_KEY);
        refExpr.putCopyableUserData(REF_MEMBER_THIS_CLASS_KEY,null);
        if (thisAccessExpr != null && thisClass != null && realParentClass != null && InheritanceUtil.isInheritorOrSelf(thisClass,realParentClass,true)) {
          boolean needQualifier=true;
          PsiElement refElement=refExpr.resolve();
          if (refMember.equals(refElement)) {
            if (thisAccessExpr instanceof PsiThisExpression && ((PsiThisExpression)thisAccessExpr).getQualifier() == null) {
              needQualifier=false;
            }
 else {
              final PsiClass currentClass=findThisClass(refExpr,refMember);
              if (thisAccessExpr instanceof PsiThisExpression) {
                PsiJavaCodeReferenceElement thisQualifier=((PsiThisExpression)thisAccessExpr).getQualifier();
                PsiClass thisExprClass=thisQualifier != null ? (PsiClass)thisQualifier.resolve() : RefactoringUtil.getThisClass(refExpr);
                if (currentClass.equals(thisExprClass) || thisExprClass.isInheritor(realParentClass,true)) {
                  needQualifier=false;
                }
              }
            }
          }
          if (needQualifier) {
            refExpr.setQualifierExpression(thisAccessExpr);
          }
        }
 else         if (thisClass != null && realParentClass != null && PsiTreeUtil.isAncestor(realParentClass,thisClass,true)) {
          PsiElement refElement=refExpr.resolve();
          if (refElement != null && !manager.areElementsEquivalent(refMember,refElement)) {
            refExpr=FieldConflictsResolver.qualifyReference(refExpr,refMember,null);
          }
        }
      }
    }
 else {
      PsiClass refClass=refExpr.getCopyableUserData(REF_CLASS_KEY);
      refExpr.putCopyableUserData(REF_CLASS_KEY,null);
      if (refClass != null && refClass.isValid()) {
        refExpr=(PsiReferenceExpression)refExpr.bindToElement(refClass);
      }
    }
  }
 else {
    Boolean couldRemove=refExpr.getCopyableUserData(CAN_REMOVE_QUALIFIER_KEY);
    refExpr.putCopyableUserData(CAN_REMOVE_QUALIFIER_KEY,null);
    if (couldRemove == Boolean.FALSE && canRemoveQualifier(refExpr)) {
      PsiReferenceExpression newRefExpr=(PsiReferenceExpression)factory.createExpressionFromText(refExpr.getReferenceName(),null);
      refExpr=(PsiReferenceExpression)refExpr.replace(newRefExpr);
    }
  }
  return refExpr;
}
