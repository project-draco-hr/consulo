{
  if (root.getFirstChildNode() == null) {
    if (root.getLastChildNode() != null) {
      throw new IncorrectTreeStructureException(root,"firstChild == null, but lastChild != null");
    }
  }
 else {
    Set<ASTNode> children=new HashSet<ASTNode>();
    for (ASTNode child=root.getFirstChildNode(); child != null; child=child.getTreeNext()) {
      if (children.contains(child)) {
        throw new IncorrectTreeStructureException(child,"Looping in next siblings");
      }
      children.add(child);
      checkChild(root,child);
    }
    Set<ASTNode> prevs=new HashSet<ASTNode>();
    for (ASTNode child=root.getLastChildNode(); child != null; child=child.getTreePrev()) {
      if (prevs.contains(child)) {
        throw new IncorrectTreeStructureException(child,"Looping in prev siblings");
      }
      if (!children.contains(child)) {
        throw new IncorrectTreeStructureException(child,"There's prev, which is not in nexts");
      }
      children.remove(child);
      prevs.add(child);
    }
    if (!children.isEmpty()) {
      throw new IncorrectTreeStructureException(children.iterator().next(),"There's next, which is not in prevs");
    }
  }
}
