{
  int offset=editor.getCaretModel().getOffset();
  for (  DocumentWindow documentWindow : InjectedLanguageUtil.getCachedInjectedDocuments(oldFile)) {
    if (documentWindow.isValid() && documentWindow.containsRange(offset,offset)) {
      PsiFile injectedFile=PsiDocumentManager.getInstance(oldFile.getProject()).getPsiFile(documentWindow);
      final Editor injectedEditor=InjectedLanguageUtil.getInjectedEditorForInjectedFile(editor,injectedFile);
      final CharSequence charsSequence=editor.getDocument().getCharsSequence();
      if (injectedEditor.getCaretModel().getOffset() == injectedEditor.getDocument().getTextLength() && offset < charsSequence.length() && charTyped == charsSequence.charAt(offset)) {
        return editor;
      }
      return injectedEditor;
    }
  }
  return editor;
}
