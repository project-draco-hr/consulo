{
  int offset=editor.getCaretModel().getOffset();
  for (  DocumentWindow documentWindow : InjectedLanguageUtil.getCachedInjectedDocuments(oldFile)) {
    if (documentWindow.isValid() && documentWindow.containsRange(offset,offset)) {
      PsiFile injectedFile=PsiDocumentManager.getInstance(oldFile.getProject()).getPsiFile(documentWindow);
      if (injectedFile != null) {
        Editor injectedEditor=InjectedLanguageUtil.getInjectedEditorForInjectedFile(editor,injectedFile);
        TextRange hostRange=documentWindow.getHostRange(offset);
        CharSequence sequence=editor.getDocument().getCharsSequence();
        if (sequence.length() > offset && charTyped != sequence.charAt(offset) || hostRange != null && hostRange.contains(offset)) {
          return injectedEditor;
        }
      }
    }
  }
  return editor;
}
