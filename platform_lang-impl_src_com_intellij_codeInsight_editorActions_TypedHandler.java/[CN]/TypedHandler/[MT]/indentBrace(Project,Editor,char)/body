{
  final int offset=editor.getCaretModel().getOffset() - 1;
  final Document document=editor.getDocument();
  CharSequence chars=document.getCharsSequence();
  if (offset < 0 || chars.charAt(offset) != braceChar)   return;
  int spaceStart=CharArrayUtil.shiftBackward(chars,offset - 1," \t");
  if (spaceStart < 0 || chars.charAt(spaceStart) == '\n' || chars.charAt(spaceStart) == '\r') {
    PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
    documentManager.commitDocument(document);
    final PsiFile file=documentManager.getPsiFile(document);
    if (file == null || !file.isWritable())     return;
    PsiElement element=file.findElementAt(offset);
    if (element == null)     return;
    EditorHighlighter highlighter=((EditorEx)editor).getHighlighter();
    HighlighterIterator iterator=highlighter.createIterator(offset);
    final FileType fileType=file.getFileType();
    BraceMatcher braceMatcher=BraceMatchingUtil.getBraceMatcher(fileType,iterator);
    boolean rBraceToken=braceMatcher.isRBraceToken(iterator,chars,fileType);
    final boolean isBrace=braceMatcher.isLBraceToken(iterator,chars,fileType) || rBraceToken;
    int lBraceOffset=-1;
    if (CodeInsightSettings.getInstance().REFORMAT_BLOCK_ON_RBRACE && rBraceToken && braceMatcher.isStructuralBrace(iterator,chars,fileType)&& offset > 0) {
      lBraceOffset=BraceMatchingUtil.findLeftLParen(highlighter.createIterator(offset - 1),braceMatcher.getOppositeBraceTokenType(iterator.getTokenType()),editor.getDocument().getCharsSequence(),fileType);
    }
    if (element.getNode() != null && isBrace) {
      final int finalLBraceOffset=lBraceOffset;
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          try {
            int newOffset;
            if (finalLBraceOffset != -1) {
              RangeMarker marker=document.createRangeMarker(offset,offset + 1);
              CodeStyleManager.getInstance(project).reformatRange(file,finalLBraceOffset,offset,true);
              newOffset=marker.getStartOffset();
              marker.dispose();
            }
 else {
              newOffset=CodeStyleManager.getInstance(project).adjustLineIndent(file,offset);
            }
            editor.getCaretModel().moveToOffset(newOffset + 1);
            editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
            editor.getSelectionModel().removeSelection();
          }
 catch (          IncorrectOperationException e) {
            LOG.error(e);
          }
        }
      }
);
    }
  }
}
