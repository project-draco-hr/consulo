{
  PsiType type=expression.getType();
  if (type == null || type instanceof PsiArrayType || type instanceof PsiPrimitiveType)   return null;
  PsiClass aClass=PsiUtil.resolveClassInType(type);
  if (aClass == null)   return null;
  if (aClass instanceof PsiAnonymousClass) {
    aClass=((PsiAnonymousClass)aClass).getBaseClassType().resolve();
    if (aClass == null)     return null;
  }
  if (!PsiUtil.isInnerClass(aClass))   return null;
  PsiClass outerClass=aClass.getContainingClass();
  if (outerClass == null)   return null;
  PsiElement placeToSearchEnclosingFrom;
  PsiExpression qualifier=expression.getQualifier();
  if (qualifier != null) {
    PsiType qtype=qualifier.getType();
    placeToSearchEnclosingFrom=PsiUtil.resolveClassInType(qtype);
  }
 else {
    placeToSearchEnclosingFrom=expression;
  }
  if (outerClass instanceof JspClass || hasEnclosingInstanceInScope(outerClass,placeToSearchEnclosingFrom,true))   return null;
  return reportIllegalEnclosingUsage(placeToSearchEnclosingFrom,aClass,outerClass,expression);
}
