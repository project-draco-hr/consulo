{
  if (stubId != -1) {
    PsiFile file=SelfElementInfo.restoreFileFromVirtual(getVirtualFile(),myProject);
    if (!(file instanceof PsiFileWithStubSupport))     return null;
    return PsiAnchor.restoreFromStubIndex((PsiFileWithStubSupport)file,stubId,myStubElementType,false);
  }
  if (!mySyncMarkerIsValid)   return null;
  PsiFile file=SelfElementInfo.restoreFileFromVirtual(getVirtualFile(),myProject);
  if (file == null)   return null;
  PsiElement anchor=file.findElementAt(getSyncStartOffset());
  if (anchor == null)   return null;
  TextRange range=anchor.getTextRange();
  if (range.getStartOffset() != getSyncStartOffset() || range.getEndOffset() != getSyncEndOffset())   return null;
  if (anchor instanceof PsiIdentifier) {
    PsiElement parent=anchor.getParent();
    if (parent instanceof PsiJavaCodeReferenceElement) {
      parent=parent.getParent();
    }
    if (!anchor.equals(AnchorElementInfoFactory.getAnchor(parent)))     return null;
    return parent;
  }
  if (anchor instanceof XmlToken) {
    XmlToken token=(XmlToken)anchor;
    return token.getTokenType() == XmlTokenType.XML_NAME ? token.getParent() : null;
  }
  return null;
}
