{
  final StateStorage defaultStateStorage=getStateStorageManager().getFileStateStorage(ProjectStoreImpl.DEFAULT_STATE_STORAGE);
  final Element element=((XmlElementStorage)defaultStateStorage).getRootElement();
  if (element != null) {
    final PathMacros pathMacros=PathMacros.getInstance();
    for (Iterator<String> i=usedMacros.iterator(); i.hasNext(); ) {
      String macro=i.next();
      final Set<String> systemMacroNames=pathMacros.getSystemMacroNames();
      for (      String systemMacroName : systemMacroNames) {
        if (macro.equals(systemMacroName) || macro.indexOf("$" + systemMacroName + "$") >= 0) {
          i.remove();
        }
      }
    }
    element.removeChildren(USED_MACROS_ELEMENT_NAME);
    if (!usedMacros.isEmpty()) {
      Element usedMacrosElement=new Element(USED_MACROS_ELEMENT_NAME);
      for (      String usedMacro : usedMacros) {
        Element macroElement=new Element(ELEMENT_MACRO);
        macroElement.setAttribute(NAME_ATTR,usedMacro);
        usedMacrosElement.addContent(macroElement);
      }
      element.addContent(usedMacrosElement);
    }
  }
}
