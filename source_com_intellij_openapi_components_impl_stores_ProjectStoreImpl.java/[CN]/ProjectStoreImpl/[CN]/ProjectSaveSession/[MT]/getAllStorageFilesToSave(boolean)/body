{
  List<IFile> result=new ArrayList<IFile>();
  boolean moduleSaves=false;
  if (includingSubStructures) {
    for (    SaveSession moduleSaveSession : myModuleSaveSessions) {
      final List<IFile> moduleFiles=moduleSaveSession.getAllStorageFilesToSave(true);
      if (moduleFiles.size() > 0)       moduleSaves=true;
      result.addAll(moduleFiles);
    }
  }
  if (moduleSaves) {
    updateUsedMacros();
    final FileBasedStorage.FileSaveSession session=(FileBasedStorage.FileSaveSession)myStorageManagerSaveSession.getSaveSession(DEFAULT_STATE_STORAGE);
    session.clearHash();
  }
  final FileBasedStorage.FileSaveSession session=(FileBasedStorage.FileSaveSession)myStorageManagerSaveSession.getSaveSession(DEFAULT_STATE_STORAGE);
  if (!session.isHashUpToDate()) {
    updateUsedMacros();
  }
  result.addAll(super.getAllStorageFilesToSave(false));
  return result;
}
