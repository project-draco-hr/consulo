{
  List<IFile> result=new ArrayList<IFile>();
  boolean moduleSaves=false;
  if (includingSubStructures) {
    for (    SaveSession moduleSaveSession : myModuleSaveSessions) {
      final List<IFile> moduleFiles=moduleSaveSession.getAllStorageFilesToSave(true);
      if (moduleFiles.size() > 0)       moduleSaves=true;
      result.addAll(moduleFiles);
    }
  }
  if (moduleSaves) {
    updateUsedMacros();
    final FileBasedStorage.FileSaveSession session=(FileBasedStorage.FileSaveSession)myStorageManagerSaveSession.getSaveSession(DEFAULT_STATE_STORAGE);
    session.clearHash();
  }
  final List<IFile> myFiles=super.getAllStorageFilesToSave(false);
  if (myFiles.size() > 0 && !moduleSaves) {
    updateUsedMacros();
  }
  result.addAll(myFiles);
  return result;
}
