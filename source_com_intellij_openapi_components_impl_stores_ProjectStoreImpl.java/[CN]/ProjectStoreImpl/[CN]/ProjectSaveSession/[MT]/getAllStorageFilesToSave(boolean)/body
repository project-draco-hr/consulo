{
  List<IFile> result=new ArrayList<IFile>();
  boolean moduleSaves=false;
  if (includingSubStructures) {
    for (    SaveSession moduleSaveSession : myModuleSaveSessions) {
      final List<IFile> moduleFiles=moduleSaveSession.getAllStorageFilesToSave(true);
      if (moduleFiles.size() > 0)       moduleSaves=true;
      result.addAll(moduleFiles);
    }
  }
  final StateStorage.SaveSession defaultSaveSession=myStorageManagerSaveSession.getSaveSession(DEFAULT_STATE_STORAGE);
  if (defaultSaveSession instanceof FileBasedStorage.FileSaveSession) {
    final FileBasedStorage.FileSaveSession session=(FileBasedStorage.FileSaveSession)defaultSaveSession;
    if (moduleSaves) {
      updateUsedMacros();
      session.clearHash();
    }
 else     if (!session.isHashUpToDate()) {
      updateUsedMacros();
    }
  }
  result.addAll(super.getAllStorageFilesToSave(false));
  return result;
}
