{
  final CanBeFinalFilter filter=new CanBeFinalFilter(this);
  getRefManager().iterate(new RefVisitor(){
    public void visitElement(    RefEntity refEntity){
      if (!(refEntity instanceof RefElement))       return;
      if (filter.accepts((RefElement)refEntity)) {
        refEntity.accept(new RefVisitor(){
          public void visitMethod(          final RefMethod refMethod){
            if (!refMethod.isStatic() && !PsiModifier.PRIVATE.equals(refMethod.getAccessModifier()) && !(refMethod instanceof RefImplicitConstructor)) {
              getContext().enqueueDerivedMethodsProcessor(refMethod,new GlobalInspectionContextImpl.DerivedMethodsProcessor(){
                public boolean process(                PsiMethod derivedMethod){
                  ((RefElementImpl)refMethod).setFlag(false,CanBeFinalAnnotator.CAN_BE_FINAL_MASK);
                  return false;
                }
              }
);
            }
          }
          public void visitClass(          final RefClass refClass){
            if (!refClass.isAnonymous()) {
              getContext().enqueueDerivedClassesProcessor(refClass,new GlobalInspectionContextImpl.DerivedClassesProcessor(){
                public boolean process(                PsiClass inheritor){
                  ((RefClassImpl)refClass).setFlag(false,CanBeFinalAnnotator.CAN_BE_FINAL_MASK);
                  return false;
                }
              }
);
            }
          }
          public void visitField(          final RefField refField){
            getContext().enqueueFieldUsagesProcessor(refField,new GlobalInspectionContextImpl.UsagesProcessor(){
              public boolean process(              PsiReference psiReference){
                PsiElement expression=psiReference.getElement();
                if (expression instanceof PsiReferenceExpression && PsiUtil.isAccessedForWriting((PsiExpression)expression)) {
                  ((RefFieldImpl)refField).setFlag(false,CanBeFinalAnnotator.CAN_BE_FINAL_MASK);
                  return false;
                }
                return true;
              }
            }
);
          }
        }
);
      }
    }
  }
);
  return false;
}
