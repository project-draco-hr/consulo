{
  Document document=editor.getDocument();
  SelectionModel selectionModel=editor.getSelectionModel();
  int selectionStart=selectionModel.getLeadSelectionOffset();
  CaretModel caretModel=editor.getCaretModel();
  LogicalPosition blockSelectionStart=selectionModel.hasBlockSelection() ? selectionModel.getBlockStart() : caretModel.getLogicalPosition();
  EditorSettings editorSettings=editor.getSettings();
  int logCaretLine=caretModel.getLogicalPosition().line;
  VisualPosition currentVisCaret=caretModel.getVisualPosition();
  VisualPosition caretLogLineStartVis=editor.offsetToVisualPosition(document.getLineStartOffset(logCaretLine));
  if (currentVisCaret.line > caretLogLineStartVis.line) {
    moveCaretToStartOfSoftWrappedLine(editor,currentVisCaret);
    setupSelection(editor,isWithSelection,selectionStart,blockSelectionStart);
    editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    return;
  }
  int logLineToUse=logCaretLine - 1;
  while (logLineToUse >= 0 && editor.offsetToVisualPosition(document.getLineEndOffset(logLineToUse)).line == currentVisCaret.line) {
    logLineToUse--;
  }
  logLineToUse++;
  if (logLineToUse >= document.getLineCount()) {
    editor.getCaretModel().moveToVisualPosition(new VisualPosition(logLineToUse,0));
  }
 else   if (logLineToUse == logCaretLine) {
    int line=currentVisCaret.line;
    int column;
    if (currentVisCaret.column == 0) {
      column=findSmartIndentColumn(editor,currentVisCaret.line);
    }
 else {
      column=findFirstNonSpaceColumnOnTheLine(editor,currentVisCaret.line);
    }
    caretModel.moveToVisualPosition(new VisualPosition(line,column));
  }
 else {
    LogicalPosition logLineEndLog=editor.offsetToLogicalPosition(document.getLineEndOffset(logLineToUse));
    VisualPosition logLineEndVis=editor.logicalToVisualPosition(logLineEndLog);
    if (logLineEndLog.isOnSoftWrappedLine()) {
      moveCaretToStartOfSoftWrappedLine(editor,logLineEndVis);
    }
 else {
      int line=logLineEndVis.line;
      int column=0;
      if (currentVisCaret.column == 0 && editorSettings.isSmartHome()) {
        findSmartIndentColumn(editor,line);
      }
      caretModel.moveToVisualPosition(new VisualPosition(line,column));
    }
  }
  setupSelection(editor,isWithSelection,selectionStart,blockSelectionStart);
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
}
