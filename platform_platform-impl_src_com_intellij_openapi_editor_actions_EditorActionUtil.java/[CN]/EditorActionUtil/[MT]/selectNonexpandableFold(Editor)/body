{
  final CaretModel caretModel=editor.getCaretModel();
  final VisualPosition pos=caretModel.getVisualPosition();
  VisualPosition prevPos=editor.getUserData(PREV_POS);
  if (prevPos != null) {
    int columnShift=pos.line == prevPos.line ? pos.column - prevPos.column : 0;
    final FoldRegion collapsedUndeCaret=editor.getFoldingModel().getCollapsedRegionAtOffset(caretModel.getOffset());
    if (collapsedUndeCaret != null && collapsedUndeCaret.shouldNeverExpand()) {
      if (columnShift > 0) {
        caretModel.moveToOffset(collapsedUndeCaret.getEndOffset());
      }
 else       if (columnShift < 0) {
        caretModel.moveToOffset(collapsedUndeCaret.getStartOffset());
      }
      editor.getSelectionModel().setSelection(collapsedUndeCaret.getStartOffset(),collapsedUndeCaret.getEndOffset());
    }
  }
  editor.putUserData(PREV_POS,pos);
}
