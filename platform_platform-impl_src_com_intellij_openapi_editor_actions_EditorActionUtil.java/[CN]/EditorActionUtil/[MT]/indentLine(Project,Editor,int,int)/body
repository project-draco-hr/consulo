{
  EditorSettings editorSettings=editor.getSettings();
  Document document=editor.getDocument();
  int spacesEnd=0;
  int lineStart=0;
  int tabsEnd=0;
  boolean inTabs=true;
  if (lineNumber < document.getLineCount()) {
    lineStart=document.getLineStartOffset(lineNumber);
    int lineEnd=document.getLineEndOffset(lineNumber);
    spacesEnd=lineStart;
    CharSequence text=document.getCharsSequence();
    for (; spacesEnd <= lineEnd; spacesEnd++) {
      if (spacesEnd == lineEnd) {
        break;
      }
      char c=text.charAt(spacesEnd);
      if (c != '\t') {
        if (inTabs) {
          inTabs=false;
          tabsEnd=spacesEnd;
        }
        if (c != ' ')         break;
      }
    }
  }
  int oldLength=editor.offsetToLogicalPosition(spacesEnd).column;
  tabsEnd=editor.offsetToLogicalPosition(tabsEnd).column;
  int newLength=oldLength + indent;
  if (newLength < 0) {
    newLength=0;
  }
  tabsEnd+=indent;
  if (tabsEnd < 0)   tabsEnd=0;
  if (!shouldUseSmartTabs(project,editor))   tabsEnd=newLength;
  StringBuilder buf=new StringBuilder(newLength);
  int tabSize=editorSettings.getTabSize(project);
  for (int i=0; i < newLength; ) {
    if (tabSize > 0 && editorSettings.isUseTabCharacter(project) && i + tabSize <= tabsEnd) {
      buf.append('\t');
      i+=tabSize;
    }
 else {
      buf.append(' ');
      i++;
    }
  }
  int newCaretOffset=editor.getCaretModel().getOffset();
  if (newCaretOffset >= spacesEnd) {
    newCaretOffset+=buf.length() - (spacesEnd - lineStart);
  }
  if (buf.length() > 0) {
    if (spacesEnd > lineStart) {
      document.replaceString(lineStart,spacesEnd,buf.toString());
    }
 else {
      document.insertString(lineStart,buf.toString());
    }
  }
 else {
    if (spacesEnd > lineStart) {
      document.deleteString(lineStart,spacesEnd);
    }
  }
  editor.getCaretModel().moveToOffset(newCaretOffset);
}
