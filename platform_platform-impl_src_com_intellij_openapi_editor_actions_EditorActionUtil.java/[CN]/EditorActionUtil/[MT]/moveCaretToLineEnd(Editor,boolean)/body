{
  Document document=editor.getDocument();
  SelectionModel selectionModel=editor.getSelectionModel();
  int selectionStart=selectionModel.getLeadSelectionOffset();
  CaretModel caretModel=editor.getCaretModel();
  LogicalPosition blockSelectionStart=caretModel.getLogicalPosition();
  SoftWrapModel softWrapModel=editor.getSoftWrapModel();
  int lineNumber=editor.getCaretModel().getLogicalPosition().line;
  if (lineNumber >= document.getLineCount()) {
    LogicalPosition pos=new LogicalPosition(lineNumber,0);
    editor.getCaretModel().moveToLogicalPosition(pos);
    setupSelection(editor,isWithSelection,selectionStart,blockSelectionStart);
    EditorModificationUtil.scrollToCaret(editor);
    return;
  }
  VisualPosition currentVisualCaret=editor.getCaretModel().getVisualPosition();
  VisualPosition visualEndOfLineWithCaret=new VisualPosition(currentVisualCaret.line,EditorUtil.getLastVisualLineColumnNumber(editor,currentVisualCaret.line));
  if (currentVisualCaret.equals(visualEndOfLineWithCaret)) {
    LogicalPosition logical=editor.visualToLogicalPosition(visualEndOfLineWithCaret);
    int offset=editor.logicalPositionToOffset(logical);
    if (offset < editor.getDocument().getTextLength()) {
      SoftWrap softWrap=softWrapModel.getSoftWrap(offset);
      if (softWrap == null) {
        softWrap=softWrapModel.getSoftWrap(offset + 1);
      }
      int line=currentVisualCaret.line;
      int column=currentVisualCaret.column;
      if (softWrap != null) {
        line++;
        column=EditorUtil.getLastVisualLineColumnNumber(editor,line);
      }
      visualEndOfLineWithCaret=new VisualPosition(line,column);
    }
  }
  LogicalPosition logLineEnd=editor.visualToLogicalPosition(visualEndOfLineWithCaret);
  int offset=editor.logicalPositionToOffset(logLineEnd);
  lineNumber=logLineEnd.line;
  int newOffset=offset;
  CharSequence text=document.getCharsSequence();
  for (int i=newOffset - 1; i >= document.getLineStartOffset(lineNumber); i--) {
    if (softWrapModel.getSoftWrap(i) != null) {
      newOffset=offset;
      break;
    }
    if (text.charAt(i) != ' ' && text.charAt(i) != '\t') {
      break;
    }
    newOffset=i;
  }
  if (newOffset == offset || newOffset == caretModel.getOffset()) {
    caretModel.moveToVisualPosition(visualEndOfLineWithCaret);
  }
 else {
    caretModel.moveToOffset(newOffset);
  }
  EditorModificationUtil.scrollToCaret(editor);
  setupSelection(editor,isWithSelection,selectionStart,blockSelectionStart);
}
