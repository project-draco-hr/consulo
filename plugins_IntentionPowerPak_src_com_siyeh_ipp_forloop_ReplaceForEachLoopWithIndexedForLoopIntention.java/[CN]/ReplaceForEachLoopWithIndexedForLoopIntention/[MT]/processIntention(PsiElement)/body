{
  final PsiForeachStatement statement=(PsiForeachStatement)element.getParent();
  if (statement == null) {
    return;
  }
  final PsiExpression iteratedValue=statement.getIteratedValue();
  if (iteratedValue == null) {
    return;
  }
  final PsiParameter iterationParameter=statement.getIterationParameter();
  final PsiType type=iterationParameter.getType();
  final PsiType iteratedValueType=iteratedValue.getType();
  if (iteratedValueType == null) {
    return;
  }
  final boolean isArray=iteratedValueType instanceof PsiArrayType;
  final Project project=statement.getProject();
  final JavaCodeStyleManager codeStyleManager=JavaCodeStyleManager.getInstance(project);
  final String indexText=codeStyleManager.suggestUniqueVariableName("i",statement,true);
  final String iteratedValueText;
  if (iteratedValue instanceof PsiMethodCallExpression) {
    final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)iteratedValue;
    final PsiReferenceExpression methodExpression=methodCallExpression.getMethodExpression();
    final String name=methodExpression.getReferenceName();
    if (name == null) {
      return;
    }
    if (name.startsWith("to") && name.length() > 2) {
      iteratedValueText=StringUtil.decapitalize(name.substring(2));
    }
 else     if (name.startsWith("get") && name.length() > 3) {
      iteratedValueText=StringUtil.decapitalize(name.substring(3));
    }
 else {
      iteratedValueText=name;
    }
  }
 else {
    iteratedValueText=iteratedValue.getText();
  }
  final String lengthText;
  if (isArray) {
    lengthText=codeStyleManager.suggestUniqueVariableName(iteratedValueText + "Length",statement,true);
  }
 else {
    lengthText=codeStyleManager.suggestUniqueVariableName(iteratedValueText + "Size",statement,true);
  }
  final CodeStyleSettings codeStyleSettings=CodeStyleSettingsManager.getSettings(project);
  if (iteratedValue instanceof PsiMethodCallExpression) {
    final String variableName=codeStyleManager.suggestUniqueVariableName(iteratedValueText,statement,true);
    final StringBuilder declaration=new StringBuilder();
    if (codeStyleSettings.GENERATE_FINAL_LOCALS) {
      declaration.append("final ");
    }
    declaration.append(iteratedValueType.getCanonicalText());
    declaration.append(' ');
    declaration.append(variableName);
    declaration.append('=');
    declaration.append(iteratedValue.getText());
    declaration.append(';');
    final PsiElementFactory elementFactory=JavaPsiFacade.getElementFactory(project);
    final PsiStatement declarationStatement=elementFactory.createStatementFromText(declaration.toString(),statement);
    statement.getParent().addBefore(declarationStatement,statement);
  }
  @NonNls final StringBuilder newStatement=new StringBuilder();
  newStatement.append("for(int ");
  newStatement.append(indexText);
  newStatement.append(" = 0, ");
  newStatement.append(lengthText);
  newStatement.append(" = ");
  newStatement.append(iteratedValueText);
  if (isArray) {
    newStatement.append(".length;");
  }
 else {
    newStatement.append(".size();");
  }
  newStatement.append(indexText);
  newStatement.append('<');
  newStatement.append(lengthText);
  newStatement.append(';');
  newStatement.append(indexText);
  newStatement.append("++)");
  newStatement.append("{ ");
  if (codeStyleSettings.GENERATE_FINAL_LOCALS) {
    newStatement.append("final ");
  }
  newStatement.append(type.getCanonicalText());
  newStatement.append(' ');
  newStatement.append(iterationParameter.getName());
  newStatement.append(" = ");
  newStatement.append(iteratedValueText);
  if (isArray) {
    newStatement.append('[');
    newStatement.append(indexText);
    newStatement.append("];");
  }
 else {
    newStatement.append(".get(");
    newStatement.append(indexText);
    newStatement.append(");");
  }
  final PsiStatement body=statement.getBody();
  if (body == null) {
    return;
  }
  if (body instanceof PsiBlockStatement) {
    final PsiCodeBlock block=((PsiBlockStatement)body).getCodeBlock();
    final PsiElement[] children=block.getChildren();
    for (int i=1; i < children.length - 1; i++) {
      newStatement.append(children[i].getText());
    }
  }
 else {
    newStatement.append(body.getText());
  }
  newStatement.append('}');
  replaceStatementAndShorten(newStatement.toString(),statement);
}
