{
  final AbstractProjectViewPane viewPane=getCurrentProjectViewPane();
  DefaultMutableTreeNode node=viewPane != null ? viewPane.getSelectedNode() : null;
  while (true) {
    if (node == null) {
      break;
    }
    final Object userObject=node.getUserObject();
    if (userObject instanceof PsiDirectoryNode || userObject instanceof AbstractModuleNode || userObject instanceof PackageElementNode) {
      break;
    }
    node=(DefaultMutableTreeNode)node.getParent();
  }
  if (node == null) {
    return PsiDirectory.EMPTY_ARRAY;
  }
  final Object userObject=node.getUserObject();
  if (userObject instanceof PsiDirectoryNode) {
    PsiDirectory directory=((PsiDirectoryNode)userObject).getValue();
    if (directory != null) {
      return new PsiDirectory[]{directory};
    }
  }
 else   if (userObject instanceof AbstractModuleNode) {
    final ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(((AbstractModuleNode)userObject).getValue());
    final VirtualFile[] sourceRoots=moduleRootManager.getSourceRoots();
    List<PsiDirectory> dirs=new ArrayList<PsiDirectory>(sourceRoots.length);
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    for (    final VirtualFile sourceRoot : sourceRoots) {
      final PsiDirectory directory=psiManager.findDirectory(sourceRoot);
      if (directory != null) {
        dirs.add(directory);
      }
    }
    return dirs.toArray(new PsiDirectory[dirs.size()]);
  }
 else   if (userObject instanceof PackageElementNode) {
    final PsiPackage aPackage=((PackageElementNode)userObject).getValue().getPackage();
    if (aPackage == null || !aPackage.isValid()) {
      return PsiDirectory.EMPTY_ARRAY;
    }
 else {
      return aPackage.getDirectories();
    }
  }
  return PsiDirectory.EMPTY_ARRAY;
}
