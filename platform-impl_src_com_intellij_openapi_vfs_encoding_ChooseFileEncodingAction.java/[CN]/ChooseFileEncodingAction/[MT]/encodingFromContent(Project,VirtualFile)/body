{
  FileType fileType=virtualFile.getFileType();
  if (fileType instanceof LanguageFileType) {
    Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
    if (document == null)     return null;
    Pair<Charset,Long> cachedCharset=document.getUserData(CACHED_CHARSET_FROM_CONTENT);
    Charset charset;
    if (cachedCharset == null || cachedCharset.getSecond() != document.getModificationStamp()) {
      charset=((LanguageFileType)fileType).extractCharsetFromFileContent(project,virtualFile,document.getText());
      document.putUserData(CACHED_CHARSET_FROM_CONTENT,Pair.create(charset,document.getModificationStamp()));
    }
 else {
      charset=cachedCharset.getFirst();
    }
    if (charset != null) {
      return charset;
    }
  }
  return null;
}
