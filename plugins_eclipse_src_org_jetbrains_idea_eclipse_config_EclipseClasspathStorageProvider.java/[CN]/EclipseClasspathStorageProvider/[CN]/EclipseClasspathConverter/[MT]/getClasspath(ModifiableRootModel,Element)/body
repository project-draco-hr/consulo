{
  try {
    final HashSet<String> usedVariables=new HashSet<String>();
    final CachedXmlDocumentSet documentSet=getFileSet();
    final String path=documentSet.getParent(EclipseXml.PROJECT_FILE);
    LOG.assertTrue(documentSet.exists(EclipseXml.PROJECT_FILE));
    final EclipseClasspathReader classpathReader=new EclipseClasspathReader(path,module.getProject(),null);
    classpathReader.init(model);
    if (documentSet.exists(EclipseXml.CLASSPATH_FILE)) {
      classpathReader.readClasspath(model,new ArrayList<String>(),new ArrayList<String>(),usedVariables,new HashSet<String>(),null,documentSet.read(EclipseXml.CLASSPATH_FILE).getRootElement());
    }
 else {
      EclipseClasspathReader.setOutputUrl(model,path + "/bin");
    }
    final String eml=model.getModule().getName() + EclipseXml.IDEA_SETTINGS_POSTFIX;
    if (documentSet.exists(eml)) {
      IdeaSpecificSettings.readIDEASpecific(model,documentSet,eml);
    }
 else {
      model.getModuleExtensionOld(CompilerModuleExtension.class).setExcludeOutput(false);
    }
    ((RootModelImpl)model).writeExternal(element);
    return usedVariables;
  }
 catch (  ConversionException e) {
    throw new InvalidDataException(e);
  }
catch (  WriteExternalException e) {
    throw new InvalidDataException(e);
  }
catch (  JDOMException e) {
    throw new InvalidDataException(e);
  }
}
