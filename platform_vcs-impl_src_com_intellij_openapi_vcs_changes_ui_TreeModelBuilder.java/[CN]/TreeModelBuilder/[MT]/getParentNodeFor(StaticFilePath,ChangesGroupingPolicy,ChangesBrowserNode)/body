{
  if (showFlatten) {
    return rootNode;
  }
  if (policy != null) {
    ChangesBrowserNode nodeFromPolicy=policy.getParentNodeFor(nodePath,rootNode);
    if (nodeFromPolicy != null) {
      return nodeFromPolicy;
    }
  }
  final StaticFilePath parentPath=nodePath.getParent();
  if (parentPath == null) {
    return rootNode;
  }
  ChangesBrowserNode parentNode=myFoldersCache.get(parentPath.getKey());
  if (parentNode == null) {
    parentNode=createPathNode(parentPath);
    if (parentNode != null) {
      ChangesBrowserNode grandPa=getParentNodeFor(parentPath,policy,rootNode);
      model.insertNodeInto(parentNode,grandPa,grandPa.getChildCount());
      myFoldersCache.put(parentPath.getKey(),parentNode);
    }
  }
  return ObjectUtils.chooseNotNull(parentNode,rootNode);
}
