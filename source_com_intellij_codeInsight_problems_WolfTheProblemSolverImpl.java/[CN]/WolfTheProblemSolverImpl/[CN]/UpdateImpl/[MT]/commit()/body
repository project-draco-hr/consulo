{
  Set<VirtualFile> added=new THashSet<VirtualFile>();
  added.addAll(problems.keySet());
  added.removeAll(backedProblems.keySet());
  Set<VirtualFile> removed=new THashSet<VirtualFile>();
  removed.addAll(backedProblems.keySet());
  removed.removeAll(problems.keySet());
synchronized (myProblems) {
    for (    VirtualFile addedFile : added) {
      Collection<ProblemImpl> addedProblems=problems.get(addedFile);
      Collection<ProblemImpl> existingProblems=myProblems.get(addedFile);
      if (existingProblems == null) {
        myProblems.put(addedFile,addedProblems);
      }
 else {
        existingProblems.addAll(existingProblems);
      }
    }
    for (    VirtualFile removedFile : removed) {
      if (scope.belongs(removedFile.getUrl())) {
        myProblems.remove(removedFile);
      }
    }
  }
  problems=null;
  scope=null;
  if (!added.isEmpty() || !removed.isEmpty()) {
    fireProblemListeners.problemsChanged(added,removed);
  }
}
