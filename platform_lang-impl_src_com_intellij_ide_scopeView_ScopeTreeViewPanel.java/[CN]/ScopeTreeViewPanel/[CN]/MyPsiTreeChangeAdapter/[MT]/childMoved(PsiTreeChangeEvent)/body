{
  final PsiElement oldParent=event.getOldParent();
  final PsiElement newParent=event.getNewParent();
  final PsiElement child=event.getChild();
  if (oldParent instanceof PsiDirectory && newParent instanceof PsiDirectory) {
    if (child instanceof PsiFile && !isInjected((PsiFile)child)) {
      final PsiFile file=(PsiFile)child;
      queueUpdate(new Runnable(){
        public void run(){
          reload(myBuilder.removeNode(child,(PsiDirectory)oldParent));
          final VirtualFile virtualFile=file.getVirtualFile();
          if (virtualFile != null) {
            final PsiFile newFile=file.isValid() ? file : PsiManager.getInstance(myProject).findFile(virtualFile);
            if (newFile != null) {
              final PackageDependenciesNode rootToReload=myBuilder.addFileNode(newFile);
              if (rootToReload != null) {
                reload(rootToReload);
              }
            }
          }
        }
      }
,true);
    }
  }
}
