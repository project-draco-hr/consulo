{
  FileTreeModelBuilder.clearCaches(myProject);
  if (scope == null) {
    scope=DefaultScopesProvider.getAllScope();
  }
  LOG.assertTrue(scope != null);
  final NamedScopesHolder holder=NamedScopesHolder.getHolder(myProject,scope.getName(),myDependencyValidationManager);
  final PackageSet packageSet=scope.getValue() != null ? scope.getValue() : new InvalidPackageSet("");
  final DependenciesPanel.DependencyPanelSettings settings=new DependenciesPanel.DependencyPanelSettings();
  settings.UI_FILTER_LEGALS=true;
  settings.UI_GROUP_BY_SCOPE_TYPE=false;
  settings.UI_SHOW_FILES=true;
  final ProjectView projectView=ProjectView.getInstance(myProject);
  settings.UI_FLATTEN_PACKAGES=projectView.isFlattenPackages(ScopeViewPane.ID);
  settings.UI_COMPACT_EMPTY_MIDDLE_PACKAGES=projectView.isHideEmptyMiddlePackages(ScopeViewPane.ID);
  settings.UI_SHOW_MODULES=projectView.isShowModules(ScopeViewPane.ID);
  settings.UI_SHOW_MODULE_GROUPS=projectView.isShowModules(ScopeViewPane.ID);
  myBuilder=new FileTreeModelBuilder(myProject,new Marker(){
    @Override public boolean isMarked(    VirtualFile file){
      return packageSet != null && (packageSet instanceof PackageSetBase ? ((PackageSetBase)packageSet).contains(file,holder) : packageSet.contains(PackageSetBase.getPsiFile(file,holder),holder));
    }
  }
,settings);
  myTree.setPaintBusy(true);
  myBuilder.setTree(myTree);
  myTree.getEmptyText().setText("Loading...");
  myActionCallback=new ActionCallback();
  myTree.putClientProperty(TreeState.CALLBACK,new WeakReference<ActionCallback>(myActionCallback));
  myTree.setModel(myBuilder.build(myProject,true,new Runnable(){
    @Override public void run(){
      myTree.setPaintBusy(false);
      myTree.getEmptyText().setText(UIBundle.message("message.nothingToShow"));
      myActionCallback.setDone();
    }
  }
));
  ((PackageDependenciesNode)myTree.getModel().getRoot()).sortChildren();
  ((DefaultTreeModel)myTree.getModel()).reload();
  FileTreeModelBuilder.clearCaches(myProject);
}
