{
  int shift=0;
  WhiteSpace prev=null;
  for (BlockWrapper block=myFirstTokenBlock; block != null; block=block.getNextBlock()) {
    final WhiteSpace whiteSpace=block.getWhiteSpace();
    if (!whiteSpace.isReadOnly()) {
      final int oldTextRangeLength=block.getTextRange().getLength();
      final String newWhiteSpace=whiteSpace.generateWhiteSpace(myIndentOption);
      if (prev == whiteSpace || whiteSpace.isReadOnly())       continue;
      if (whiteSpace.equals(newWhiteSpace))       continue;
      final TextRange textRange=whiteSpace.getTextRange();
      final TextRange wsRange=new TextRange(textRange.getStartOffset() + shift,textRange.getEndOffset() + shift);
      myModel.replaceWhiteSpace(wsRange,newWhiteSpace);
      shift+=(newWhiteSpace.length() - (textRange.getLength())) + (block.getBlock().getTextRange().getLength() - oldTextRangeLength);
    }
    prev=whiteSpace;
  }
}
