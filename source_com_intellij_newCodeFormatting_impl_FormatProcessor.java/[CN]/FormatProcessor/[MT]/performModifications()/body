{
  int shift=0;
  WhiteSpace prev=null;
  for (LeafBlockWrapper block=myFirstTokenBlock; block != null; block=block.getNextBlock()) {
    final WhiteSpace whiteSpace=block.getWhiteSpace();
    if (!whiteSpace.isReadOnly()) {
      final int oldTextRangeLength=block.getTextRange().getLength();
      final String newWhiteSpace=whiteSpace.generateWhiteSpace(myIndentOption);
      if (prev == whiteSpace || whiteSpace.isReadOnly())       continue;
      if (whiteSpace.equals(newWhiteSpace))       continue;
      final TextRange textRange=whiteSpace.getTextRange();
      final TextRange wsRange=shiftRange(textRange,shift);
      final TextRange newBlockRange=myModel.replaceWhiteSpace(wsRange,newWhiteSpace,shiftRange(block.getTextRange(),shift),true);
      shift+=(newWhiteSpace.length() - (textRange.getLength())) + (newBlockRange.getLength() - oldTextRangeLength);
    }
    prev=whiteSpace;
  }
  myModel.commitChanges();
}
