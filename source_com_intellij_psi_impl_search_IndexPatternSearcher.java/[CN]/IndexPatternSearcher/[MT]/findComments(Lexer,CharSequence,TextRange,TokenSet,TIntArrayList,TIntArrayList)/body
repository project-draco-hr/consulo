{
  for (lexer.start(chars,0,chars.length(),0); ; lexer.advance()) {
    IElementType tokenType=lexer.getTokenType();
    if (tokenType == null)     break;
    if (range != null) {
      if (lexer.getTokenEnd() <= range.getStartOffset())       continue;
      if (lexer.getTokenStart() >= range.getEndOffset())       break;
    }
    boolean isComment=commentTokens.contains(tokenType);
    if (!isComment) {
      final Language commentLang=tokenType.getLanguage();
      final ParserDefinition parserDefinition=commentLang.getParserDefinition();
      if (parserDefinition != null) {
        final TokenSet langCommentTokens=parserDefinition.getCommentTokens();
        isComment=langCommentTokens.contains(tokenType);
      }
    }
    if (isComment) {
      final boolean jspToken=lexer.getTokenType() == JspTokenType.JSP_COMMENT;
      final int startDelta=jspToken ? "<%--".length() : 0;
      final int endDelta=jspToken ? "--%>".length() : 0;
      commentStarts.add(lexer.getTokenStart() + startDelta);
      commentEnds.add(lexer.getTokenEnd() - endDelta);
    }
  }
}
