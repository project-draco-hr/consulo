{
  for (lexer.start(chars); ; lexer.advance()) {
    IElementType tokenType=lexer.getTokenType();
    if (tokenType instanceof CopyCreatorLexer.HighlightingCopyElementType) {
      tokenType=((CopyCreatorLexer.HighlightingCopyElementType)tokenType).getBase();
    }
    if (tokenType == null)     break;
    if (range != null) {
      if (lexer.getTokenEnd() <= range.getStartOffset())       continue;
      if (lexer.getTokenStart() >= range.getEndOffset())       break;
    }
    boolean isComment=commentTokens.contains(tokenType);
    if (!isComment) {
      final Language commentLang=tokenType.getLanguage();
      final ParserDefinition parserDefinition=commentLang.getParserDefinition();
      if (parserDefinition != null) {
        final TokenSet langCommentTokens=parserDefinition.getCommentTokens();
        isComment=langCommentTokens.contains(tokenType);
      }
    }
    if (isComment) {
      commentStarts.add(lexer.getTokenStart());
      commentEnds.add(lexer.getTokenEnd());
    }
  }
}
