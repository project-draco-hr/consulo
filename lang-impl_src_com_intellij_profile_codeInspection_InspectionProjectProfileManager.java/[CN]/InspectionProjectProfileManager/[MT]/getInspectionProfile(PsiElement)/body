{
  final PsiFile psiFile=psiElement.getContainingFile();
  if (psiFile == null) {
    LOG.assertTrue(psiElement instanceof PsiDirectory,"Element of type: " + psiElement.getClass().getName());
    return (InspectionProfile)getProjectProfileImpl();
  }
  final HighlightingSettingsPerFile settingsPerFile=HighlightingSettingsPerFile.getInstance(myProject);
  final InspectionProfile cachedProfile=settingsPerFile.getInspectionProfile(psiFile);
  if (cachedProfile != null) {
    return cachedProfile;
  }
  InspectionProfileImpl inspectionProfile=null;
  final String profile=super.getProfileName(psiFile);
  if (profile != null) {
    inspectionProfile=(InspectionProfileImpl)getProfile(profile);
  }
  if (inspectionProfile == null) {
    inspectionProfile=(InspectionProfileImpl)myApplicationProfileManager.getRootProfile();
  }
  settingsPerFile.addProfileSettingForFile(psiFile,inspectionProfile);
  return inspectionProfile;
}
