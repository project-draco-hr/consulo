{
  if (toImport.isEmpty()) {
    return;
  }
  if (!project.isInitialized()) {
    myAlarm.addRequest(new ImportModulesTask(project,toImport,recursive,synchronous),PROJECT_INITIALISATION_DELAY_MS);
    return;
  }
  Runnable task=new Runnable(){
    @Override public void run(){
      removeExistingModulesConfigs(toImport,project);
      Application application=ApplicationManager.getApplication();
      final Map<DataNode<ModuleData>,Module> moduleMappings=ContainerUtilRt.newHashMap();
      application.runWriteAction(new Runnable(){
        @Override public void run(){
          final ModuleManager moduleManager=ModuleManager.getInstance(project);
          final ProjectEntityChangeListener publisher=project.getMessageBus().syncPublisher(ProjectEntityChangeListener.TOPIC);
          for (          DataNode<ModuleData> module : toImport) {
            publisher.onChangeStart(module,module.getData().getOwner());
            try {
              importModule(moduleManager,module);
            }
  finally {
              publisher.onChangeEnd(module,module.getData().getOwner());
            }
          }
        }
        private void importModule(        @NotNull ModuleManager moduleManager,        @NotNull DataNode<ModuleData> module){
          final Module created=moduleManager.newModule(module.getData().getModuleFilePath(),StdModuleTypes.JAVA.getId());
          ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(created);
          final ModifiableRootModel moduleRootModel=moduleRootManager.getModifiableModel();
          moduleRootModel.inheritSdk();
          RootPolicy<Object> visitor=new RootPolicy<Object>(){
            @Override public Object visitLibraryOrderEntry(            LibraryOrderEntry libraryOrderEntry,            Object value){
              moduleRootModel.removeOrderEntry(libraryOrderEntry);
              return value;
            }
            @Override public Object visitModuleOrderEntry(            ModuleOrderEntry moduleOrderEntry,            Object value){
              moduleRootModel.removeOrderEntry(moduleOrderEntry);
              return value;
            }
          }
;
          try {
            for (            OrderEntry orderEntry : moduleRootModel.getOrderEntries()) {
              orderEntry.accept(visitor,null);
            }
          }
  finally {
            moduleRootModel.commit();
          }
          moduleMappings.put(module,created);
        }
      }
);
      if (!recursive) {
        return;
      }
      for (      DataNode<ModuleData> node : toImport) {
        final Module ideModule=moduleMappings.get(node);
        Collection<DataNode<ContentRootData>> contentRoots=ExternalSystemUtil.findAll(node,ProjectKeys.CONTENT_ROOT);
        myContentRootManager.importData(contentRoots,project,synchronous);
        Collection<DataNode<ModuleDependencyData>> moduleDependencies=ExternalSystemUtil.findAll(node,ProjectKeys.MODULE_DEPENDENCY);
        myModuleDependencyManager.importData(moduleDependencies,node.getData().getOwner(),ideModule,synchronous);
        Collection<DataNode<LibraryDependencyData>> libraryDependencies=ExternalSystemUtil.findAll(node,ProjectKeys.LIBRARY_DEPENDENCY);
        myLibraryDependencyManager.importData(libraryDependencies,node.getData().getOwner(),ideModule,synchronous);
      }
    }
  }
;
  if (synchronous) {
    UIUtil.invokeAndWaitIfNeeded(task);
  }
 else {
    UIUtil.invokeLaterIfNeeded(task);
  }
}
