{
  assertCanRunWriteAction();
  fireBeforeWriteActionStart(action);
  myIsWaitingForWriteAction=true;
  try {
    while (true) {
      try {
        myActionsLock.writeLock().acquire();
      }
 catch (      InterruptedException e) {
        throw new RuntimeInterruptedException(e);
      }
      break;
    }
  }
  finally {
    myIsWaitingForWriteAction=false;
  }
  fireWriteActionStarted(action);
  try {
synchronized (myWriteActionsStack) {
      myWriteActionsStack.push(action);
    }
    final Project project=CommandProcessor.getInstance().getCurrentCommandProject();
    if (project != null) {
      PostprocessReformattingAspect.getInstance(project).postponeFormattingInside(new Computable<Object>(){
        public Object compute(){
          action.run();
          return null;
        }
      }
);
    }
 else     action.run();
  }
  finally {
synchronized (myWriteActionsStack) {
      writeActionPostprocessing();
      myWriteActionsStack.pop();
    }
    fireWriteActionFinished(action);
    myActionsLock.writeLock().release();
  }
}
