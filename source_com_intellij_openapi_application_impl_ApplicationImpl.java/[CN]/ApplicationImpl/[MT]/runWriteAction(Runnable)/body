{
  assertCanRunWriteAction();
  fireBeforeWriteActionStart(action);
  myIsWaitingForWriteAction=true;
  try {
    while (true) {
      try {
        myActionsLock.writeLock().acquire();
      }
 catch (      InterruptedException e) {
        throw new RuntimeInterruptedException(e);
      }
      break;
    }
  }
  finally {
    myIsWaitingForWriteAction=false;
  }
  fireWriteActionStarted(action);
  try {
synchronized (myWriteActionsStack) {
      myWriteActionsStack.push(action);
    }
    action.run();
  }
  finally {
synchronized (myWriteActionsStack) {
      if (myWriteActionsStack.size() == 1)       writeActionPostprocessing();
      myWriteActionsStack.pop();
    }
    fireWriteActionFinished(action);
    myActionsLock.writeLock().release();
  }
}
