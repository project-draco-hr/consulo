{
  ArrayList<LiveOccurrence> occurrences=new ArrayList<LiveOccurrence>();
  if (myFindModel != null) {
    TextRange r=myFindModel.isGlobal() ? new TextRange(0,Integer.MAX_VALUE) : new TextRange(editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd());
    if (r.getLength() == 0) {
      r=new TextRange(0,Integer.MAX_VALUE);
    }
    int offset=r.getStartOffset();
    VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(editor.getDocument());
    final ArrayList<FindResult> results=new ArrayList<FindResult>();
    while (true) {
      FindManager findManager=FindManager.getInstance(editor.getProject());
      FindResult result=findManager.findString(editor.getDocument().getCharsSequence(),offset,myFindModel,virtualFile);
      if (!result.isStringFound())       break;
      int newOffset=result.getEndOffset();
      if (offset == newOffset || result.getEndOffset() > r.getEndOffset())       break;
      offset=newOffset;
      results.add(result);
      if (results.size() > myMatchesLimit)       break;
    }
    if (results.size() < myMatchesLimit) {
      findResultsToOccurrences(results,occurrences);
    }
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      @Override public void run(){
        searchEndsWith(results.size());
      }
    }
);
  }
  return occurrences;
}
