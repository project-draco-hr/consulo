{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  final StubTree derefd=derefStub();
  if (derefd != null)   return derefd;
  StubTree stubHolder=StubTreeLoader.getInstance().readOrBuild(getProject(),getVirtualFile(),this);
  if (stubHolder == null) {
    LOG.info("Class file is corrupted: " + getVirtualFile().getPresentableUrl());
    StubTree emptyTree=new StubTree(new PsiJavaFileStubImpl("corrupted.classfiles",true));
    setStubTree(emptyTree);
    resetMirror();
    return emptyTree;
  }
synchronized (lock) {
    final StubTree derefdOnLock=derefStub();
    if (derefdOnLock != null)     return derefdOnLock;
    setStubTree(stubHolder);
  }
  resetMirror();
  return stubHolder;
}
