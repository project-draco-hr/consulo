{
synchronized (MIRROR_LOCK) {
    if (myMirrorFileElement == null) {
      VirtualFile virtualFile=getVirtualFile();
      final Document document=FileDocumentManager.getInstance().getDocument(virtualFile);
      String text=document.getText();
      String ext=JavaFileType.INSTANCE.getDefaultExtension();
      PsiClass[] classes=getClasses();
      String fileName=(classes.length > 0 ? classes[0].getName() : virtualFile.getNameWithoutExtension()) + "." + ext;
      PsiManager manager=getManager();
      PsiFile mirror=PsiFileFactory.getInstance(manager.getProject()).createFileFromText(fileName,JavaLanguage.INSTANCE,text,false,false);
      final ASTNode mirrorTreeElement=SourceTreeToPsiMap.psiElementToTree(mirror);
      final NonCancelableSection section=ProgressIndicatorProvider.getInstance().startNonCancelableSection();
      try {
        setMirror((TreeElement)mirrorTreeElement);
      }
  finally {
        section.done();
      }
    }
    return myMirrorFileElement.getPsi();
  }
}
