{
  final List<UsageInfo> usages=new ArrayList<UsageInfo>();
  ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  int totalCount=searchIn.size();
  int count=0;
  for (Iterator<PsiFile> inIterator=searchIn.iterator(); inIterator.hasNext(); ) {
    final PsiFile psiFile=inIterator.next();
    if (indicator != null) {
      if (indicator.isCanceled())       throw new ProcessCanceledException();
      indicator.setFraction(((double)++count) / totalCount);
      indicator.setText(AnalysisScopeBundle.message("find.dependencies.progress.text",psiFile.getVirtualFile().getPresentableUrl()));
    }
    final Set<PsiFile> depsByFile=builder.getDependencies().get(psiFile);
    final Set<PsiFile> deps=depsByFile != null ? new HashSet<PsiFile>(depsByFile) : new HashSet<PsiFile>();
    deps.retainAll(searchFor);
    if (deps.isEmpty())     continue;
    if (!psiFile.isValid())     continue;
    builder.analyzeFileDependencies(psiFile,new DependenciesBuilder.DependencyProcessor(){
      public void process(      PsiElement place,      PsiElement dependency){
        PsiFile dependencyFile=dependency.getContainingFile();
        if (deps.contains(dependencyFile)) {
          usages.add(new UsageInfo(place));
        }
      }
    }
);
  }
  return usages.toArray(new UsageInfo[usages.size()]);
}
