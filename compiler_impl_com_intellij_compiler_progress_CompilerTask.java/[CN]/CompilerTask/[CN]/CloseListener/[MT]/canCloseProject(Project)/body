{
  if (shouldAskUser()) {
    int result=Messages.showOkCancelDialog(myProject,CompilerBundle.message("warning.compiler.running.on.project.close"),CompilerBundle.message("compiler.running.dialog.title"),Messages.getQuestionIcon());
    if (result != 0) {
      return false;
    }
    myUserAcceptedCancel=true;
    final MessageBusConnection connection=project.getComponent(MessageBus.class).connect();
    connection.subscribe(CompilerTopics.COMPILATION_STATUS,new CompilationStatusListener(){
      public void compilationFinished(      boolean aborted,      int errors,      int warnings,      final CompileContext compileContext){
        connection.disconnect();
        ProjectUtil.closeProject(project);
      }
    }
);
    cancel();
    return false;
  }
  return !myIndicator.isRunning();
}
