{
  List<FoldRegion> newRegions=arrayList();
  for (  final Map.Entry<PsiElement,FoldingDescriptor> entry : myElementsToFoldMap.entrySet()) {
    ProgressManager.getInstance().checkCanceled();
    PsiElement element=entry.getKey();
    final FoldingDescriptor descriptor=entry.getValue();
    TextRange range=descriptor.getRange();
    FoldRegion region=new FoldRegionImpl(myEditor,range.getStartOffset(),range.getEndOffset(),descriptor.getPlaceholderText(),descriptor.getGroup());
    if (!foldingModel.addFoldRegion(region))     continue;
    info.addRegion(region,element);
    newRegions.add(region);
    boolean expandStatus=shouldExpandNewRegion(element,range,rangeToExpandStatusMap);
    final FoldingGroup group=region.getGroup();
    if (group == null) {
      shouldExpand.put(region,expandStatus);
    }
 else {
      final Boolean alreadyExpanded=groupExpand.get(group);
      groupExpand.put(group,alreadyExpanded == null ? expandStatus : alreadyExpanded.booleanValue() || expandStatus);
    }
  }
  return newRegions;
}
