{
  final SubTree subTree=new SubTree(myWorkingCopyDir);
  checkin();
  clManager.stopEveryThingIfInTestMode();
  sleep(100);
  final File rootFile=new File(subTree.myRootDir.getPath());
  FileUtil.delete(rootFile);
  FileUtil.delete(new File(myWorkingCopyDir.getPath() + File.separator + ".svn"));
  Assert.assertTrue(!rootFile.exists());
  sleep(200);
  myWorkingCopyDir.refresh(false,true);
  verify(runSvn("co",myMainUrl));
  final File sourceDir=new File(myWorkingCopyDir.getPath(),"source");
  CreateExternalAction.addToExternalProperty(myVcs,sourceDir,"external",myExternalURL);
  sleep(100);
  verify(runSvn("up",sourceDir.getPath()));
  sleep(100);
  myWorkingCopyDir.refresh(false,true);
  Assert.assertTrue(new File(sourceDir,"external").exists());
  clManager.forceGoInTestMode();
  SvnConfiguration.getInstance(myProject).DETECT_NESTED_COPIES=true;
  myVcs.invokeRefreshSvnRoots(false);
  clManager.ensureUpToDate(false);
  clManager.ensureUpToDate(false);
}
