{
  if (data instanceof THashMap) {
    final Ref<StorageException> exceptionRef=new Ref<StorageException>();
    final boolean b=((THashMap<Key,Value>)data).forEachEntry(new TObjectObjectProcedure<Key,Value>(){
      @Override public boolean execute(      Key key,      Value value){
        try {
          consumer.process(key,value,inputId);
        }
 catch (        StorageException ex) {
          exceptionRef.set(ex);
          return false;
        }
        return true;
      }
    }
);
    if (!b)     throw exceptionRef.get();
  }
 else {
    for (    Map.Entry<Key,Value> entry : data.entrySet()) {
      consumer.process(entry.getKey(),entry.getValue(),inputId);
    }
  }
}
