{
  byte[] bytes;
  try {
    bytes=virtualFile.contentsToByteArray();
  }
 catch (  IOException e) {
    return true;
  }
  String separator=FileDocumentManager.getInstance().getLineSeparator(virtualFile,project);
  String toSave=StringUtil.convertLineSeparators(text,separator);
  byte[] bom=virtualFile.getBOM();
  bom=bom == null ? ArrayUtil.EMPTY_BYTE_ARRAY : bom;
  byte[] bytesToSave=toSave.getBytes(charset);
  if (!ArrayUtil.startsWith(bytesToSave,bom)) {
    bytesToSave=ArrayUtil.mergeArrays(bom,bytesToSave);
  }
  return Arrays.equals(bytesToSave,bytes);
}
