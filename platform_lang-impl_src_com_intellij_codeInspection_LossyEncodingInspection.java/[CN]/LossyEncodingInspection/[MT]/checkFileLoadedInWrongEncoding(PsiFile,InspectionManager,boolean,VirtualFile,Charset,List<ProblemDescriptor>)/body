{
  if (FileDocumentManager.getInstance().isFileModified(virtualFile) || ChooseFileEncodingAction.isEnabledAndWhyNot(virtualFile) != null) {
    return;
  }
  byte[] bytes;
  try {
    bytes=virtualFile.contentsToByteArray();
  }
 catch (  IOException e) {
    return;
  }
  String separator=FileDocumentManager.getInstance().getLineSeparator(virtualFile,file.getProject());
  String toSave=StringUtil.convertLineSeparators(file.getText(),separator);
  byte[] bom=virtualFile.getBOM();
  byte[] bytesToSave=ArrayUtil.mergeArrays(bom == null ? ArrayUtil.EMPTY_BYTE_ARRAY : bom,toSave.getBytes(charset));
  if (!Arrays.equals(bytesToSave,bytes)) {
    descriptors.add(manager.createProblemDescriptor(file,"File was loaded in a wrong encoding: '" + charset + "'",RELOAD_ENCODING_FIX,ProblemHighlightType.GENERIC_ERROR,isOnTheFly));
  }
}
