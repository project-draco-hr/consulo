{
  final BufferExposingByteArrayOutputStream savedKeysData;
  if (keys != null) {
    externalizer.save(new DataOutputStream(savedKeysData=new BufferExposingByteArrayOutputStream()),keys);
  }
 else {
    savedKeysData=null;
  }
  final FileAccessorCache.Handle<IndexedState> stateHandle=index.myStateCache.getIfCached(id);
  try {
    index.appendData(id,new PersistentHashMap.ValueDataAppender(){
      @Override public void append(      DataOutput out) throws IOException {
        byte[] internalBuffer=null;
        int size=0;
        if (savedKeysData != null) {
          internalBuffer=savedKeysData.getInternalBuffer();
          size=savedKeysData.size();
        }
        long indexCreationStamp=IndexingStamp.getIndexCreationStamp(indexId);
        writeIndexValue(indexId.getUniqueId(),indexCreationStamp,internalBuffer,0,size,out);
        final IndexedState indexedState=stateHandle != null ? stateHandle.get() : null;
        if (indexedState != null) {
          indexedState.appendIndexedState(indexId,indexCreationStamp,internalBuffer,size);
        }
      }
    }
);
  }
  finally {
    if (stateHandle != null)     stateHandle.release();
  }
}
