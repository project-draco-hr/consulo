{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      FileDocumentManager.getInstance().saveAllDocuments();
    }
  }
);
  HgCloneDialog dialog=new HgCloneDialog(project);
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  final VirtualFile destinationParent=LocalFileSystem.getInstance().findFileByIoFile(new File(dialog.getParentDirectory()));
  if (destinationParent == null) {
    return;
  }
  String targetDir=destinationParent.getPath() + File.separator + dialog.getDirectoryName();
  final String sourceRepositoryURL=dialog.getSourceRepositoryURL();
  HgCloneCommand clone=new HgCloneCommand(project);
  clone.setRepositoryURL(sourceRepositoryURL);
  clone.setDirectory(targetDir);
  HgCommandResult result=clone.execute();
  HgUtil.markDirectoryDirty(project,destinationParent);
  if (result.getExitValue() == 0) {
    if (listener != null) {
      listener.directoryCheckedOut(new File(dialog.getParentDirectory(),dialog.getDirectoryName()));
    }
  }
  if (listener != null) {
    listener.checkoutCompleted();
  }
}
