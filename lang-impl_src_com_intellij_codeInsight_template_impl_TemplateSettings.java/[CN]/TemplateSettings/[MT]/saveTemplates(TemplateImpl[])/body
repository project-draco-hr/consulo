{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      List<String> templateNames=new ArrayList<String>();
      for (      TemplateImpl template1 : templates) {
        templateNames.add(template1.getKey());
      }
      myDeletedTemplates.clear();
      for (      String defTemplateName : myDefaultTemplates.keySet()) {
        if (!templateNames.contains(defTemplateName)) {
          myDeletedTemplates.add(defTemplateName);
        }
      }
      File[] files=getUserTemplateFiles();
      if (files != null) {
        for (        File file : files) {
          file.delete();
        }
      }
      if (templates.length == 0)       return;
      HashMap<String,Element> groupToDocumentMap=new HashMap<String,Element>();
      for (      TemplateImpl template : templates) {
        if (template.equals(myDefaultTemplates.get(template.getKey())))         continue;
        String groupName=template.getGroupName();
        Element templateSetElement=groupToDocumentMap.get(groupName);
        if (templateSetElement == null) {
          templateSetElement=new Element(TEMPLATE_SET);
          templateSetElement.setAttribute(GROUP,groupName);
          groupToDocumentMap.put(groupName,templateSetElement);
        }
        try {
          saveTemplate(template,templateSetElement);
        }
 catch (        IllegalDataException e) {
        }
      }
      File dir=getTemplateDirectory(true);
      if (dir == null) {
        return;
      }
      Collection<Map.Entry<String,Element>> groups=groupToDocumentMap.entrySet();
      for (      Map.Entry<String,Element> entry : groups) {
        String groupName=entry.getKey();
        Element templateSetElement=entry.getValue();
        String fileName=convertName(groupName);
        String filePath=findFirstNotExistingFile(dir,fileName,XML_EXTENSION);
        try {
          JDOMUtil.writeDocument(new Document(templateSetElement),filePath,CodeStyleSettingsManager.getSettings(null).getLineSeparator());
        }
 catch (        IOException e) {
          LOG.error(e);
        }
      }
    }
  }
);
}
