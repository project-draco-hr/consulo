{
  final ScrollingModel scrollingModel=editor.getScrollingModel();
  scrollingModel.scrollToCaret(ScrollType.MAKE_VISIBLE);
  final CaretModel caretModel=editor.getCaretModel();
  final int position=caretModel.getOffset();
  final PsiElement element=file.findElementAt(position);
  final PsiMember selectedMember=PsiTreeUtil.getParentOfType(element,PsiMember.class,true);
  if (selectedMember == null) {
    return;
  }
  PsiClass containingClass=selectedMember.getContainingClass();
  if (containingClass == null && selectedMember instanceof PsiClass) {
    containingClass=(PsiClass)selectedMember;
  }
  if (containingClass == null) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactorJBundle.message("cannot.perform.the.refactoring") + RefactorJBundle.message("the.caret.should.be.positioned.within.a.class.to.be.refactored"),null,getHelpID());
    return;
  }
  if (containingClass.isInterface()) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactorJBundle.message("cannot.perform.the.refactoring") + RefactorJBundle.message("the.selected.class.is.an.interface"),null,getHelpID());
    return;
  }
  if (containingClass.isEnum()) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactorJBundle.message("cannot.perform.the.refactoring") + RefactorJBundle.message("the.selected.class.is.an.enumeration"),null,getHelpID());
    return;
  }
  if (containingClass.isAnnotationType()) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactorJBundle.message("cannot.perform.the.refactoring") + RefactorJBundle.message("the.selected.class.is.an.annotation.type"),null,getHelpID());
    return;
  }
  if (classIsInner(containingClass) && !containingClass.hasModifierProperty(PsiModifier.STATIC)) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactorJBundle.message("cannot.perform.the.refactoring") + RefactorJBundle.message("the.refactoring.is.not.supported.on.non.static.inner.classes"),null,getHelpID());
    return;
  }
  if (classIsTrivial(containingClass)) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactorJBundle.message("cannot.perform.the.refactoring") + RefactorJBundle.message("the.selected.class.has.no.members.to.extract"),null,getHelpID());
    return;
  }
  new ExtractClassDialog(containingClass,selectedMember).show();
}
