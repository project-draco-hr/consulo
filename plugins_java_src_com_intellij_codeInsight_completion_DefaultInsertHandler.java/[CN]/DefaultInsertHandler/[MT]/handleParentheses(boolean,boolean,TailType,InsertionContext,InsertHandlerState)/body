{
  final Document document=context.getEditor().getDocument();
  boolean insertRightParenth=context.getCompletionChar() != Lookup.COMPLETE_STATEMENT_SELECT_CHAR;
  if (needParenth) {
    if (context.getOffsetMap().getOffset(JavaCompletionUtil.LPAREN_OFFSET) >= 0 && context.getOffsetMap().getOffset(JavaCompletionUtil.ARG_LIST_END_OFFSET) >= 0) {
      myState.tailOffset=context.getOffsetMap().getOffset(JavaCompletionUtil.ARG_LIST_END_OFFSET);
      if (context.getOffsetMap().getOffset(JavaCompletionUtil.RPAREN_OFFSET) < 0 && insertRightParenth) {
        document.insertString(myState.tailOffset,")");
        myState.tailOffset+=1;
      }
      if (hasParams) {
        myState.caretOffset=context.getOffsetMap().getOffset(JavaCompletionUtil.LPAREN_OFFSET) + 1;
      }
 else {
        myState.caretOffset=context.getOffsetMap().getOffset(JavaCompletionUtil.ARG_LIST_END_OFFSET);
      }
    }
 else {
      final CommonCodeStyleSettings styleSettings=context.getCodeStyleSettings();
      myState.tailOffset=context.getSelectionEndOffset();
      myState.caretOffset=context.getSelectionEndOffset();
      if (styleSettings.SPACE_BEFORE_METHOD_CALL_PARENTHESES) {
        document.insertString(myState.tailOffset++," ");
        myState.caretOffset++;
      }
      if (insertRightParenth) {
        final CharSequence charsSequence=document.getCharsSequence();
        if (charsSequence.length() <= myState.tailOffset || charsSequence.charAt(myState.tailOffset) != '(') {
          document.insertString(myState.tailOffset,"(");
        }
        document.insertString(myState.tailOffset + 1,")");
        if (hasParams) {
          myState.tailOffset+=2;
          myState.caretOffset++;
        }
 else {
          if (tailType != TailTypes.CALL_RPARENTH) {
            myState.tailOffset+=2;
            myState.caretOffset+=2;
          }
 else {
            myState.tailOffset++;
            myState.caretOffset++;
          }
        }
      }
 else {
        document.insertString(myState.tailOffset++,"(");
        myState.caretOffset++;
      }
      if (hasParams && styleSettings.SPACE_WITHIN_METHOD_CALL_PARENTHESES) {
        document.insertString(myState.caretOffset++," ");
        myState.tailOffset++;
      }
    }
  }
}
