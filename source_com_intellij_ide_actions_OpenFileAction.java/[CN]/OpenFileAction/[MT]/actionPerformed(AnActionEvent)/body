{
  final Project project=(Project)e.getDataContext().getData(DataConstants.PROJECT);
  if (project == null)   return;
  String lastFilePath=getLastFilePath(project);
  String path=lastFilePath != null ? lastFilePath : RecentProjectsManager.getInstance().getLastProjectPath();
  JFileChooser fileChooser=new JFileChooser(path);
  FileView fileView=new FileView(){
    public Icon getIcon(    File f){
      if (f.isDirectory())       return super.getIcon(f);
      FileType fileType=FileTypeManager.getInstance().getFileTypeByFileName(f.getName());
      return fileType.getIcon();
    }
  }
;
  fileChooser.setFileView(fileView);
  fileChooser.setMultiSelectionEnabled(true);
  fileChooser.setAcceptAllFileFilterUsed(false);
  fileChooser.setDialogTitle("Open File");
class TypeFilter extends FileFilter {
    private FileType myType;
    public TypeFilter(    FileType fileType){
      myType=fileType;
      myDescription=myType.getDescription();
    }
    public boolean accept(    File f){
      if (f.isDirectory())       return true;
      FileType type=FileTypeManager.getInstance().getFileTypeByFileName(f.getName());
      return myType == type;
    }
    public String getDescription(){
      return myDescription;
    }
    private String myDescription;
  }
  FileFilter allFilesFilter=new FileFilter(){
    public boolean accept(    File f){
      return true;
    }
    public String getDescription(){
      return "All file types";
    }
  }
;
  fileChooser.addChoosableFileFilter(new TypeFilter(StdFileTypes.JAVA));
  fileChooser.addChoosableFileFilter(new TypeFilter(StdFileTypes.JSP));
  fileChooser.addChoosableFileFilter(new TypeFilter(StdFileTypes.XML));
  fileChooser.addChoosableFileFilter(new TypeFilter(StdFileTypes.HTML));
  fileChooser.addChoosableFileFilter(new TypeFilter(StdFileTypes.PLAIN_TEXT));
  fileChooser.addChoosableFileFilter(allFilesFilter);
  fileChooser.setFileFilter(allFilesFilter);
  if (fileChooser.showOpenDialog(WindowManager.getInstance().suggestParentWindow(project)) != JFileChooser.APPROVE_OPTION) {
    return;
  }
  File[] files=fileChooser.getSelectedFiles();
  if (files == null)   return;
  for (int i=0; i < files.length; i++) {
    File file=files[i];
    setLastFilePath(project,file.getParent());
    if (isProjectFile(file)) {
      int answer=Messages.showYesNoDialog(project,file.getName() + " is an IDEA project file.\nWould you like to open this project?","Open Project",Messages.getQuestionIcon());
      if (answer == 0) {
        ProjectUtil.openProject(file.getAbsolutePath(),project,false);
        return;
      }
    }
    FileType type=FileTypeChooser.getKnownFileTypeOrAssociate(file.getName());
    if (type == null)     return;
    String absolutePath=file.getAbsolutePath();
    openFile(absolutePath,project);
  }
}
