{
synchronized (LOCK) {
    s=StringUtil.convertLineSeparators(s,"\n");
    myContentSize+=s.length();
    myDeferredOutput.append(s);
    if (contentType == ConsoleViewContentType.USER_INPUT) {
      myDeferredUserInput.append(s);
    }
    boolean needNew=true;
    if (!myTokens.isEmpty()) {
      final TokenInfo lastToken=myTokens.get(myTokens.size() - 1);
      if (lastToken.contentType == contentType) {
        lastToken.endOffset=myContentSize;
        needNew=false;
      }
    }
    if (needNew) {
      myTokens.add(new TokenInfo(contentType,myContentSize - s.length(),myContentSize));
    }
  }
  if (s.indexOf('\n') >= 0 || s.indexOf('\r') >= 0) {
    if (contentType == ConsoleViewContentType.USER_INPUT) {
      flushDeferredUserInput();
    }
  }
  final Runnable requestFlush=new Runnable(){
    public void run(){
      if (myFlushAlarm.getActiveRequestCount() == 0) {
        myFlushAlarm.addRequest(myFlushDeferredRunnable,FLUSH_DELAY);
      }
    }
  }
;
  if (EventQueue.isDispatchThread())   requestFlush.run();
 else   SwingUtilities.invokeLater(requestFlush);
}
