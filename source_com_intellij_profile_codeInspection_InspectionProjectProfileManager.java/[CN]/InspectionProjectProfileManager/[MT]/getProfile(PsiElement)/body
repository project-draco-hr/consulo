{
  final Pair<String,Boolean> inspectionProfilePair=HighlightingSettingsPerFile.getInstance(psiElement.getProject()).getInspectionProfile(psiElement);
  if (inspectionProfilePair != null && inspectionProfilePair.second) {
    InspectionProfile inspectionProfile=(InspectionProfile)InspectionProjectProfileManager.getInstance(myProject).getProfile(inspectionProfilePair.first);
    if (inspectionProfile != null) {
      return inspectionProfile;
    }
  }
  final PsiFile psiFile=psiElement.getContainingFile();
  LOG.assertTrue(psiFile != null);
  final VirtualFile virtualFile=psiFile.getVirtualFile();
  if (virtualFile == null) {
    return (InspectionProfile)InspectionProfileManager.getInstance().getRootProfile();
  }
  return (InspectionProfile)InspectionProfileManager.getInstance().getProfile(getProfile(virtualFile));
}
