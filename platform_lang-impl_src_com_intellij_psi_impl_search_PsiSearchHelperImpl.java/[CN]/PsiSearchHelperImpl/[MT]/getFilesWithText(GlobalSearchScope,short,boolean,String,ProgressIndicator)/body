{
  myManager.startBatchFilesProcessingMode();
  try {
    final List<VirtualFile> result=new ArrayList<VirtualFile>();
    if (!processFilesWithText(scope,searchContext,caseSensitively,text,new Processor<PsiFile>(){
      public boolean process(      PsiFile file){
        result.add(file.getViewProvider().getVirtualFile());
        return true;
      }
    }
,progress)) {
      return Collections.emptyList();
    }
    return result;
  }
  finally {
    myManager.finishBatchFilesProcessingMode();
  }
}
