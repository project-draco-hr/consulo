{
  if (singles.isEmpty()) {
    return true;
  }
  if (singles.size() == 1) {
    final Collection<PsiSearchRequest.SingleRequest> requests=singles.get(singles.keySet().iterator().next());
    if (requests.size() == 1) {
      return processSingleRequest(requests.iterator().next());
    }
  }
  final ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.pushState();
    progress.setText(PsiBundle.message("psi.scanning.files.progress"));
  }
  final MultiMap<VirtualFile,PsiSearchRequest.SingleRequest> candidateFiles=collectFiles(singles);
  final Map<PsiSearchRequest.SingleRequest,StringSearcher> searchers=new HashMap<PsiSearchRequest.SingleRequest,StringSearcher>();
  final Set<String> allWords=new TreeSet<String>();
  for (  PsiSearchRequest.SingleRequest singleRequest : candidateFiles.values()) {
    searchers.put(singleRequest,new StringSearcher(singleRequest.word,singleRequest.caseSensitive,true));
    allWords.add(singleRequest.word);
  }
  if (progress != null) {
    progress.setText(PsiBundle.message("psi.search.for.word.progress",StringUtil.join(allWords,", ")));
  }
  return processPsiFileRoots(progress,new ArrayList<VirtualFile>(candidateFiles.keySet()),new Processor<PsiElement>(){
    public boolean process(    PsiElement psiRoot){
      final VirtualFile vfile=psiRoot.getContainingFile().getVirtualFile();
      for (      PsiSearchRequest.SingleRequest singleRequest : candidateFiles.get(vfile)) {
        StringSearcher searcher=searchers.get(singleRequest);
        if (!LowLevelSearchUtil.processElementsContainingWordInElement(singleRequest.processor,psiRoot,searcher,false,progress)) {
          return false;
        }
      }
      return true;
    }
  }
);
}
