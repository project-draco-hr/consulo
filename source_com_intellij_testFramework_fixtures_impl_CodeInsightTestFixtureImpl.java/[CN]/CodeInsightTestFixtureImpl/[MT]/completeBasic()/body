{
  return new WriteCommandAction<LookupItem[]>(getProject()){
    protected void run(    final Result<LookupItem[]> result) throws Throwable {
      new CodeCompletionAction(){
        public CodeInsightActionHandler getHandler(){
          return new CodeCompletionHandler(){
            protected PsiFile createFileCopy(            final PsiFile file){
              final PsiFile copy=super.createFileCopy(file);
              if (myFileContext != null) {
                final PsiElement contextCopy=myFileContext.copy();
                final PsiFile containingFile=contextCopy.getContainingFile();
                if (containingFile instanceof PsiFileImpl) {
                  ((PsiFileImpl)containingFile).setOriginalFile(myFileContext.getContainingFile());
                }
                setContext(copy,contextCopy);
              }
              return copy;
            }
            protected Lookup showLookup(            final Project project,            final Editor editor,            final LookupItem[] items,            final String prefix,            final LookupData data,            final PsiFile file){
              result.setResult(items);
              return super.showLookup(project,editor,items,prefix,data,file);
            }
          }
;
        }
      }
.actionPerformedImpl(getProject(),InjectedLanguageUtil.getEditorForInjectedLanguage(myEditor,myFile));
    }
  }
.execute().getResultObject();
}
