{
  FacetManagerState managerState=new FacetManagerState();
  final Facet[] facets=getSortedFacets();
  Map<Facet,List<FacetState>> states=new HashMap<Facet,List<FacetState>>();
  states.put(null,managerState.getFacets());
  for (  Facet facet : facets) {
    final Facet underlyingFacet=facet.getUnderlyingFacet();
    final List<FacetState> parent=states.get(underlyingFacet);
    FacetState facetState=new FacetState();
    facetState.setFacetType(facet.getType().getStringId());
    facetState.setName(facet.getName());
    final Element config;
    try {
      FacetConfiguration configuration=facet.getConfiguration();
      config=FacetUtil.saveFacetConfiguration(configuration);
      if (configuration instanceof InvalidFacetConfiguration) {
        facetState.getSubFacets().addAll(((InvalidFacetConfiguration)configuration).getSubFacetsStates());
      }
      if (facet instanceof JDOMExternalizable) {
        ((JDOMExternalizable)facet).writeExternal(config);
      }
    }
 catch (    WriteExternalException e) {
      continue;
    }
    facetState.setConfiguration(config);
    parent.add(facetState);
    states.put(facet,facetState.getSubFacets());
  }
  return managerState;
}
