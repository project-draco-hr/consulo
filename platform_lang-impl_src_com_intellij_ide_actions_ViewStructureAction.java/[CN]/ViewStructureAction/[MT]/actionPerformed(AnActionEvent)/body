{
  Project project=e.getData(CommonDataKeys.PROJECT);
  if (project == null)   return;
  final Editor editor=e.getData(PlatformDataKeys.EDITOR);
  final FileEditor fileEditor=e.getData(PlatformDataKeys.FILE_EDITOR);
  if (editor == null)   return;
  if (fileEditor == null)   return;
  PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  if (psiFile == null)   return;
  PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
  FeatureUsageTracker.getInstance().triggerFeatureUsed("navigation.popup.file.structure");
  Navigatable navigatable=e.getData(PlatformDataKeys.NAVIGATABLE);
  if (Registry.is("file.structure.tree.mode")) {
    FileStructurePopup popup=createPopup(editor,project,navigatable,fileEditor);
    if (popup != null) {
      final VirtualFile virtualFile=psiFile.getVirtualFile();
      if (virtualFile != null) {
        popup.setTitle(virtualFile.getName());
      }
      popup.show();
    }
  }
 else {
    DialogWrapper dialog=createDialog(editor,project,navigatable,fileEditor);
    if (dialog != null) {
      final VirtualFile virtualFile=psiFile.getVirtualFile();
      if (virtualFile != null) {
        dialog.setTitle(virtualFile.getName());
      }
      dialog.show();
    }
  }
}
