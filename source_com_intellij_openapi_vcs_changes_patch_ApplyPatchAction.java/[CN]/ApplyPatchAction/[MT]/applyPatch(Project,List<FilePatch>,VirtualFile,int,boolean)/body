{
  List<VirtualFile> filesToMakeWritable=new ArrayList<VirtualFile>();
  for (  FilePatch patch : patches) {
    VirtualFile fileToPatch=patch.findFileToPatch(baseDirectory,stripLeadingDirectories,false);
    if (fileToPatch != null && !fileToPatch.isDirectory()) {
      filesToMakeWritable.add(fileToPatch);
      FileType fileType=fileToPatch.getFileType();
      if (fileType == StdFileTypes.UNKNOWN) {
        fileType=FileTypeChooser.associateFileType(fileToPatch.getPresentableName());
        if (fileType == null) {
          return ApplyPatchStatus.FAILURE;
        }
      }
    }
  }
  final VirtualFile[] fileArray=filesToMakeWritable.toArray(new VirtualFile[filesToMakeWritable.size()]);
  final ReadonlyStatusHandler.OperationStatus readonlyStatus=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(fileArray);
  if (readonlyStatus.hasReadonlyFiles()) {
    return ApplyPatchStatus.FAILURE;
  }
  final Ref<ApplyPatchStatus> statusRef=new Ref<ApplyPatchStatus>();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        public void run(){
          ApplyPatchStatus status=null;
          for (          FilePatch patch : patches) {
            final ApplyPatchStatus patchStatus=applySinglePatch(project,patch,baseDirectory,stripLeadingDirectories,createDirectories);
            status=ApplyPatchStatus.and(status,patchStatus);
          }
          if (status == ApplyPatchStatus.ALREADY_APPLIED) {
            Messages.showInfoMessage(project,VcsBundle.message("patch.apply.already.applied"),VcsBundle.message("patch.apply.dialog.title"));
          }
 else           if (status == ApplyPatchStatus.PARTIAL) {
            Messages.showInfoMessage(project,VcsBundle.message("patch.apply.partially.applied"),VcsBundle.message("patch.apply.dialog.title"));
          }
          statusRef.set(status);
        }
      }
,VcsBundle.message("patch.apply.command"),null);
    }
  }
);
  return statusRef.get();
}
