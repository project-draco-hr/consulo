{
  VirtualFile file=patch.findFileToPatch(baseDirectory,stripLeadingDirectories);
  if (file == null) {
    Messages.showErrorDialog(project,"Cannot find file to patch: " + patch.getBeforeName(),"Apply Patch");
    return;
  }
  try {
    patch.apply(file);
  }
 catch (  ApplyPatchException ex) {
    boolean appliedAnyway=false;
    if (!patch.isNewFile() && !patch.isDeletedFile()) {
      CharSequence content=findMatchingContent(project,patch,file);
      if (content != null) {
        try {
          String patchedContent=patch.applyModifications(content);
          showMergeDialog(project,patch,file,content,patchedContent);
          appliedAnyway=true;
        }
 catch (        ApplyPatchException e) {
          appliedAnyway=false;
        }
      }
    }
    if (!appliedAnyway) {
      Messages.showErrorDialog(project,"Failed to apply patch because of conflicts: " + patch.getBeforeName(),VcsBundle.message("patch.apply.dialog.title"));
    }
  }
catch (  Exception ex) {
    LOG.error(ex);
  }
}
