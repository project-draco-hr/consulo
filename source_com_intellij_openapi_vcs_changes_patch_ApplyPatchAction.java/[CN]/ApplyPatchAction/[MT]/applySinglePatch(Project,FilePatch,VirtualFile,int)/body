{
  VirtualFile file=patch.findFileToPatch(baseDirectory,stripLeadingDirectories);
  if (file == null) {
    Messages.showErrorDialog(project,"Cannot find file to patch: " + patch.getBeforeName(),"Apply Patch");
    return ApplyPatchStatus.FAILURE;
  }
  try {
    return patch.apply(file);
  }
 catch (  ApplyPatchException ex) {
    if (!patch.isNewFile() && !patch.isDeletedFile()) {
      CharSequence content=findMatchingContent(project,patch,file);
      if (content != null) {
        try {
          StringBuilder newText=new StringBuilder();
          ApplyPatchStatus status=patch.applyModifications(content,newText);
          if (status != ApplyPatchStatus.ALREADY_APPLIED) {
            return showMergeDialog(project,file,content,newText.toString());
          }
 else {
            return status;
          }
        }
 catch (        ApplyPatchException e) {
        }
      }
    }
    Messages.showErrorDialog(project,"Failed to apply patch because of conflicts: " + patch.getBeforeName(),VcsBundle.message("patch.apply.dialog.title"));
  }
catch (  Exception ex) {
    LOG.error(ex);
  }
  return ApplyPatchStatus.FAILURE;
}
