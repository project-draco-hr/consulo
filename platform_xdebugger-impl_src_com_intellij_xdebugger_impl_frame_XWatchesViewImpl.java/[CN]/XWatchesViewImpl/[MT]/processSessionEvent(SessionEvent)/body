{
  if (getMainPanel().isShowing() || ApplicationManager.getApplication().isUnitTestMode()) {
    myRebuildNeeded=false;
  }
 else {
    myRebuildNeeded=true;
    return;
  }
  XDebuggerTree tree=myTreePanel.getTree();
  if (event == SessionEvent.BEFORE_RESUME || event == SessionEvent.SETTINGS_CHANGED) {
    if (myTreeRestorer != null) {
      myTreeRestorer.dispose();
    }
    myTreeState=XDebuggerTreeState.saveState(tree);
    if (event == SessionEvent.BEFORE_RESUME) {
      return;
    }
  }
  XDebugSession session=getSession(getMainPanel());
  XStackFrame stackFrame=session == null ? null : session.getCurrentStackFrame();
  if (stackFrame != null) {
    cancelClear();
    tree.setSourcePosition(stackFrame.getSourcePosition());
    myRootNode.updateWatches(stackFrame.getEvaluator());
    if (myTreeState != null) {
      myTreeRestorer=myTreeState.restoreState(tree);
    }
  }
 else {
    requestClear();
  }
}
