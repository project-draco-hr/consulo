{
  final PsiElement[] children=directory.getChildren();
  final String relativePath=VfsUtil.getRelativePath(directory.getVirtualFile(),rootDirectory.getVirtualFile(),'/');
  final TargetDirectoryWrapper newTargetDirectory=relativePath.length() == 0 ? targetDirectory : targetDirectory.findOrCreateChild(relativePath);
  for (  PsiElement child : children) {
    if (child instanceof PsiJavaFile) {
      for (      PsiClass aClass : ((PsiJavaFile)child).getClasses()) {
        classesToMove.put(aClass,newTargetDirectory);
      }
    }
 else     if (child instanceof PsiDirectory) {
      collectClasses(classesToMove,(PsiDirectory)child,directory,newTargetDirectory);
    }
  }
}
