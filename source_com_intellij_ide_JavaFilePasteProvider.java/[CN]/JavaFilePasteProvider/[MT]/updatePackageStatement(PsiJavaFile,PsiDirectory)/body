{
  final PsiPackage aPackage=JavaDirectoryService.getInstance().getPackage(targetDir);
  if (aPackage == null)   return;
  final PsiPackageStatement oldStatement=javaFile.getPackageStatement();
  final Project project=javaFile.getProject();
  if (oldStatement != null && !oldStatement.getPackageName().equals(aPackage.getQualifiedName())) {
    CommandProcessor.getInstance().executeCommand(project,new Runnable(){
      public void run(){
        try {
          PsiElementFactory factory=JavaPsiFacade.getInstance(project).getElementFactory();
          final PsiPackageStatement newStatement=factory.createPackageStatement(aPackage.getQualifiedName());
          oldStatement.replace(newStatement);
        }
 catch (        IncorrectOperationException e) {
        }
      }
    }
,"Updating package statement",null);
  }
}
