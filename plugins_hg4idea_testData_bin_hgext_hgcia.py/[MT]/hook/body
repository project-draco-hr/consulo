def hook(ui, repo, hooktype, node=None, url=None, **kwargs):
    ' send CIA notification '

    def sendmsg(cia, ctx):
        msg = ciamsg(cia, ctx).xml()
        if cia.dryrun:
            ui.write(msg)
        elif cia.ciaurl.startswith('mailto:'):
            if (not cia.emailfrom):
                raise util.Abort(_('email.from must be defined when sending by email'))
            cia.sendemail(cia.ciaurl[7:], msg)
        else:
            cia.sendrpc(msg)
    n = bin(node)
    cia = hgcia(ui, repo)
    if (not cia.user):
        ui.debug('cia: no user specified')
        return
    if (not cia.project):
        ui.debug('cia: no project specified')
        return
    if (hooktype == 'changegroup'):
        start = repo.changelog.rev(n)
        end = len(repo.changelog)
        for rev in xrange(start, end):
            n = repo.changelog.node(rev)
            ctx = repo.changectx(n)
            sendmsg(cia, ctx)
    else:
        ctx = repo.changectx(n)
        sendmsg(cia, ctx)
