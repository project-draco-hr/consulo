{
  PsiClass containingClass=PsiTreeUtil.getParentOfType(psiBlock,PsiClass.class);
  if (containingClass != null && PsiUtil.isLocalOrAnonymousClass(containingClass)) {
    final PsiElement parent=containingClass.getParent();
    final PsiCodeBlock block=DfaPsiUtil.getTopmostBlockInSameClass(parent);
    if ((parent instanceof PsiNewExpression || parent instanceof PsiDeclarationStatement) && block != null) {
      final RunnerResult result=analyzeMethod(block,visitor);
      if (result == RunnerResult.OK) {
        final Collection<DfaMemoryState> closureStates=myNestedClosures.get(DfaPsiUtil.getTopmostBlockInSameClass(psiBlock));
        if (!closureStates.isEmpty()) {
          return closureStates;
        }
      }
      return null;
    }
  }
  return Arrays.asList(createMemoryState());
}
