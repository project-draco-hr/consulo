{
  final boolean isForeignApp=!(ApplicationManager.getApplication() instanceof ApplicationImpl);
  if (ourInstance == null || isForeignApp) {
    if (isForeignApp) {
      disposeInstance();
      PluginManager.invalidatePlugins();
    }
    new IdeaTestApplication();
    PluginManager.getPlugins();
    final ApplicationEx app=ApplicationManagerEx.getApplicationEx();
    new WriteAction(){
      protected void run(      Result result) throws Throwable {
        app.load(configPath);
      }
    }
.execute();
  }
  return (IdeaTestApplication)ourInstance;
}
