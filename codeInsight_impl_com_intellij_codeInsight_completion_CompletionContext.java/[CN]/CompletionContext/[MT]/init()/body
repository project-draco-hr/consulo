{
  identifierEndOffset=selectionEndOffset;
  PsiElement element=file.findElementAt(selectionEndOffset);
  if (element == null)   return;
  final PsiReference reference=file.findReferenceAt(selectionEndOffset);
  if (reference != null) {
    if (reference instanceof PsiJavaCodeReferenceElement) {
      identifierEndOffset=element.getParent().getTextRange().getEndOffset();
    }
 else {
      identifierEndOffset=reference.getElement().getTextRange().getStartOffset() + reference.getRangeInElement().getEndOffset();
    }
    element=file.findElementAt(identifierEndOffset);
  }
 else   if (isWord(element)) {
    if (element instanceof PsiIdentifier && element.getParent() instanceof PsiJavaCodeReferenceElement) {
      identifierEndOffset=element.getParent().getTextRange().getEndOffset();
    }
 else {
      identifierEndOffset=element.getTextRange().getEndOffset();
    }
    element=file.findElementAt(identifierEndOffset);
    if (element == null)     return;
  }
  if (element instanceof PsiWhiteSpace && (!element.textContains('\n') || CodeStyleSettingsManager.getInstance(project).getCurrentSettings().METHOD_PARAMETERS_LPAREN_ON_NEXT_LINE)) {
    element=file.findElementAt(element.getTextRange().getEndOffset());
  }
  if (element instanceof PsiJavaToken && ((PsiJavaToken)element).getTokenType() == JavaTokenType.LPARENTH) {
    if (element.getParent() instanceof PsiExpressionList || ".".equals(file.findElementAt(selectionEndOffset - 1).getText())) {
      lparenthOffset=element.getTextRange().getStartOffset();
      PsiElement list=element.getParent();
      PsiElement last=list.getLastChild();
      if (last instanceof PsiJavaToken && ((PsiJavaToken)last).getTokenType() == JavaTokenType.RPARENTH) {
        rparenthOffset=last.getTextRange().getStartOffset();
      }
      argListEndOffset=list.getTextRange().getEndOffset();
      if (element instanceof PsiExpressionList)       hasArgs=((PsiExpressionList)element).getExpressions().length > 0;
    }
  }
}
