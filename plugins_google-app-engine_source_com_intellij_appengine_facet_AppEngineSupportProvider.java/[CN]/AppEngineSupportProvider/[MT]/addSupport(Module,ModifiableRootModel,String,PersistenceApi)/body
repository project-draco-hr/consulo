{
  super.addSupport(module,rootModel,null,null);
  final VirtualFile descriptorDir=AppEngineWebIntegration.getInstance().suggestParentDirectoryForAppEngineWebXml(module,rootModel);
  if (descriptorDir != null) {
    createFileFromTemplate(AppEngineTemplateGroupDescriptorFactory.APP_ENGINE_WEB_XML_TEMPLATE,descriptorDir,AppEngineUtil.APP_ENGINE_WEB_XML_NAME);
  }
  final AppEngineFacet appEngineFacet=AppEngineFacet.getAppEngineFacetByModule(module);
  LOG.assertTrue(appEngineFacet != null);
  final AppEngineFacetConfiguration facetConfiguration=appEngineFacet.getConfiguration();
  facetConfiguration.setSdkHomePath(sdkPath);
  final AppEngineSdk sdk=appEngineFacet.getSdk();
  final Artifact artifact=findContainingArtifact(appEngineFacet);
  final ApplicationServer appServer=sdk.getOrCreateAppServer();
  final Project project=module.getProject();
  if (appServer != null) {
    final ConfigurationFactory type=AppEngineServerConfigurationType.getInstance().getConfigurationFactories()[0];
    final RunnerAndConfigurationSettings settings=J2EEConfigurationFactory.getInstance().addAppServerConfiguration(project,type,appServer);
    if (artifact != null) {
      final CommonModel configuration=(CommonModel)settings.getConfiguration();
      ((AppEngineServerModel)configuration.getServerModel()).setArtifact(artifact);
      BuildArtifactsBeforeRunTaskProvider.setBuildArtifactBeforeRun(project,configuration,artifact);
    }
    rootModel.addLibraryEntry(appServer.getLibrary()).setScope(DependencyScope.PROVIDED);
  }
  final Library apiJar=addProjectLibrary(module,"AppEngine API",sdk.getLibUserDirectoryPath(),VirtualFile.EMPTY_ARRAY);
  rootModel.addLibraryEntry(apiJar);
  if (artifact != null) {
    WebArtifactUtil.getInstance().addLibrary(apiJar,artifact,project);
  }
  if (persistenceApi != null) {
    facetConfiguration.setRunEnhancerOnMake(true);
    facetConfiguration.setPersistenceApi(persistenceApi);
    facetConfiguration.getFilesToEnhance().addAll(AppEngineUtil.getDefaultSourceRootsToEnhance(rootModel));
    try {
      final VirtualFile[] sourceRoots=rootModel.getSourceRoots();
      final VirtualFile sourceRoot;
      if (sourceRoots.length > 0) {
        sourceRoot=sourceRoots[0];
      }
 else {
        sourceRoot=findOrCreateChildDirectory(rootModel.getContentRoots()[0],"src");
      }
      VirtualFile metaInf=findOrCreateChildDirectory(sourceRoot,"META-INF");
      if (persistenceApi == PersistenceApi.JDO || persistenceApi == PersistenceApi.JDO3) {
        createFileFromTemplate(AppEngineTemplateGroupDescriptorFactory.APP_ENGINE_JDO_CONFIG_TEMPLATE,metaInf,AppEngineUtil.JDO_CONFIG_XML_NAME);
      }
 else {
        final VirtualFile file=createFileFromTemplate(AppEngineTemplateGroupDescriptorFactory.APP_ENGINE_JPA_CONFIG_TEMPLATE,metaInf,AppEngineUtil.JPA_CONFIG_XML_NAME);
        if (file != null) {
          AppEngineWebIntegration.getInstance().setupJpaSupport(module,file);
        }
      }
    }
 catch (    IOException e) {
      LOG.error(e);
    }
    final Library library=addProjectLibrary(module,"AppEngine ORM",sdk.getOrmLibDirectoryPath(),sdk.getOrmLibSources());
    rootModel.addLibraryEntry(library);
    if (artifact != null) {
      WebArtifactUtil.getInstance().addLibrary(library,artifact,project);
    }
  }
}
