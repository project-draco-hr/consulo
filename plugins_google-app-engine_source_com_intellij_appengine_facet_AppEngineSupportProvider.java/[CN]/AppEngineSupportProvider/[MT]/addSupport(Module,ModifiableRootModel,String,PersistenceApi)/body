{
  super.addSupport(module,rootModel,null,null);
  final AppEngineFacet appEngineFacet=FacetManager.getInstance(module).getFacetByType(AppEngineFacet.ID);
  LOG.assertTrue(appEngineFacet != null);
  final AppEngineFacetConfiguration facetConfiguration=appEngineFacet.getConfiguration();
  facetConfiguration.setSdkHomePath(sdkPath);
  final AppEngineSdk sdk=appEngineFacet.getSdk();
  final Artifact artifact=findContainingArtifact(module,appEngineFacet);
  final ApplicationServer appServer=sdk.getOrCreateAppServer();
  if (appServer != null) {
    final ConfigurationFactory type=AppEngineServerConfigurationType.getInstance().getConfigurationFactories()[0];
    final RunManagerEx runManager=RunManagerEx.getInstanceEx(module.getProject());
    final RunnerAndConfigurationSettingsImpl runSettings=(RunnerAndConfigurationSettingsImpl)runManager.createRunConfiguration("AppEngine Dev",type);
    final CommonStrategy configuration=(CommonStrategy)runSettings.getConfiguration();
    configuration.setApplicationServer(appServer);
    configuration.setUrlToOpenInBrowser(configuration.getDefaultUrlForBrowser());
    if (artifact != null) {
      ((AppEngineServerModel)configuration.getServerModel()).setArtifact(artifact);
      BuildArtifactsBeforeRunTaskProvider.setBuildArtifactBeforeRun(module.getProject(),configuration,artifact);
    }
    runManager.addConfiguration(runSettings,false);
    runManager.setActiveConfiguration(runSettings);
  }
  final Library apiJar=addProjectLibrary(module,"AppEngine API",sdk.getLibUserDirectoryPath(),VirtualFile.EMPTY_ARRAY);
  rootModel.addLibraryEntry(apiJar);
  if (persistenceApi != null) {
    facetConfiguration.setRunEnhancerOnMake(true);
    facetConfiguration.getFilesToEnhance().addAll(AppEngineUtil.getDefaultSourceRootsToEnhance(rootModel));
    try {
      final VirtualFile[] sourceRoots=rootModel.getSourceRoots();
      final VirtualFile sourceRoot;
      if (sourceRoots.length > 0) {
        sourceRoot=sourceRoots[0];
      }
 else {
        sourceRoot=findOrCreateChildDirectory(rootModel.getContentRoots()[0],"src");
      }
      VirtualFile metaInf=findOrCreateChildDirectory(sourceRoot,"META-INF");
      if (persistenceApi == PersistenceApi.JDO) {
        createFileFromTemplate(AppEngineTemplateGroupDescriptorFactory.APP_ENGINE_JDO_CONFIG_TEMPLATE,metaInf,AppEngineUtil.JDO_CONFIG_XML_NAME);
      }
 else {
        final VirtualFile file=createFileFromTemplate(AppEngineTemplateGroupDescriptorFactory.APP_ENGINE_JPA_CONFIG_TEMPLATE,metaInf,AppEngineUtil.JPA_CONFIG_XML_NAME);
        if (file != null) {
          JpaFacet facet=FacetManager.getInstance(module).getFacetByType(JpaFacet.ID);
          if (facet == null) {
            final JpaFacet jpaFacet=FacetManager.getInstance(module).addFacet(JpaFacetType.INSTANCE,JpaFacetType.INSTANCE.getDefaultFacetName(),null);
            jpaFacet.getDescriptorsContainer().getConfiguration().replaceConfigFile(JavaeePersistenceDescriptorsConstants.PERSISTENCE_XML_META_DATA,file.getUrl());
          }
        }
      }
    }
 catch (    IOException e) {
      LOG.error(e);
    }
    final Library library=addProjectLibrary(module,"AppEngine ORM",sdk.getOrmLibDirectoryPath(),sdk.getOrmLibSources());
    rootModel.addLibraryEntry(library);
    if (artifact != null) {
      WebArtifactUtil.getInstance().addLibrary(library,artifact,module.getProject());
      WebArtifactUtil.getInstance().addLibrary(apiJar,artifact,module.getProject());
    }
  }
}
