{
  Project project=e.getData(PlatformDataKeys.PROJECT);
  NewDirectoryProjectDialog dlg=new NewDirectoryProjectDialog(project);
  dlg.show();
  if (dlg.getExitCode() != DialogWrapper.OK_EXIT_CODE)   return;
  final DirectoryProjectGenerator generator=dlg.getProjectGenerator();
  final File location=new File(dlg.getNewProjectLocation());
  if (!location.exists() && !location.mkdirs()) {
    Messages.showErrorDialog(project,"Cannot create directory '" + location + "'","Create Project");
    return;
  }
  final VirtualFile baseDir=ApplicationManager.getApplication().runWriteAction(new Computable<VirtualFile>(){
    public VirtualFile compute(){
      return LocalFileSystem.getInstance().refreshAndFindFileByIoFile(location);
    }
  }
);
  baseDir.refresh(false,true);
  if (baseDir.getChildren().length > 0) {
    int rc=Messages.showYesNoDialog(project,"The directory '" + location + "' is not empty. Would you like to create a project from existing sources instead?","Create New Project",Messages.getQuestionIcon());
    if (rc == 0) {
      PlatformProjectOpenProcessor.getInstance().doOpenProject(baseDir,null,false);
      return;
    }
  }
  Object settings=null;
  if (generator != null) {
    try {
      settings=generator.showGenerationSettings(baseDir);
    }
 catch (    ProcessCanceledException e1) {
      return;
    }
  }
  GeneralSettings.getInstance().setLastProjectLocation(location.getParent());
  final Object finalSettings=settings;
  PlatformProjectOpenProcessor.doOpenProject(baseDir,null,false,-1,new ProjectOpenedCallback(){
    @Override public void projectOpened(    Project project,    Module module){
      if (generator != null) {
        generator.generateProject(project,baseDir,finalSettings,module);
      }
    }
  }
);
}
