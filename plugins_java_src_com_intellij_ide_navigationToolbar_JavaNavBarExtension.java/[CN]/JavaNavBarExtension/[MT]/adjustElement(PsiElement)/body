{
  final ProjectFileIndex index=ProjectRootManager.getInstance(psiElement.getProject()).getFileIndex();
  final PsiFile containingFile=psiElement.getContainingFile();
  if (containingFile != null) {
    final VirtualFile file=containingFile.getVirtualFile();
    if (file != null && (index.isInSourceContent(file) || index.isInLibraryClasses(file) || index.isInLibrarySource(file))) {
      if (psiElement instanceof PsiJavaFile) {
        final PsiJavaFile psiJavaFile=(PsiJavaFile)psiElement;
        if (psiJavaFile.getViewProvider().getBaseLanguage() == StdLanguages.JAVA) {
          final PsiClass[] psiClasses=psiJavaFile.getClasses();
          if (psiClasses.length == 1) {
            return psiClasses[0];
          }
        }
      }
      if (psiElement instanceof PsiClass)       return psiElement;
    }
    return containingFile;
  }
  return psiElement.isPhysical() ? psiElement : null;
}
