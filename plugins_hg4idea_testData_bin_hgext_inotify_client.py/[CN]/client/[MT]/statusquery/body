@start_server
def statusquery(self, names, match, ignored, clean, unknown=True):

    def genquery():
        for n in names:
            yield n
        states = 'almrx!'
        if ignored:
            raise ValueError('this is insanity')
        if clean:
            states += 'c'
        if unknown:
            states += '?'
        yield states
    req = '\x00'.join(genquery())
    (cs, resphdr) = self.query('STAT', req)

    def readnames(nbytes):
        if nbytes:
            names = cs.read(nbytes)
            if names:
                return filter(match, names.split('\x00'))
        return []
    results = map(readnames, resphdr[:(-1)])
    if names:
        nbytes = resphdr[(-1)]
        vdirs = cs.read(nbytes)
        if vdirs:
            for vdir in vdirs.split('\x00'):
                match.dir(vdir)
    return results
