{
  ApplicationManager.getApplication().assertIsDispatchThread();
  cleanFileLevelHighlights(project,document,group);
  List<TextRange> ranges=new ArrayList<TextRange>(infos.keySet());
  Collections.sort(ranges,new Comparator<TextRange>(){
    public int compare(    final TextRange o1,    final TextRange o2){
      return o1.getStartOffset() - o2.getStartOffset();
    }
  }
);
  TextRange prev=ranges.get(0);
  for (int i=1; i < ranges.size(); i++) {
    TextRange range=ranges.get(i);
    if (prev.contains(range)) {
      TextRange removed=ranges.remove(i);
      infos.get(prev).addAll(infos.get(removed));
      i--;
    }
  }
  HighlightInfo[] oldHighlights=DaemonCodeAnalyzerImpl.getHighlights(document,project);
  List<HighlightInfo> result=new ArrayList<HighlightInfo>();
  if (oldHighlights != null) {
    for (    HighlightInfo info : oldHighlights) {
      RangeHighlighter highlighter=info.highlighter;
      boolean toRemove=!highlighter.isValid() || info.group == group && Collections.binarySearch(ranges,new TextRange(highlighter.getStartOffset(),highlighter.getEndOffset()),new Comparator<TextRange>(){
        public int compare(        final TextRange o1,        final TextRange o2){
          if (o1.contains(o2) || o2.contains(o1))           return 0;
          return o1.getStartOffset() - o2.getStartOffset();
        }
      }
) >= 0;
      if (toRemove) {
        document.getMarkupModel(project).removeHighlighter(highlighter);
      }
 else {
        result.add(info);
      }
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Removed segment highlighters:" + (oldHighlights.length - result.size()));
    }
  }
  for (  TextRange range : ranges) {
    Collection<HighlightInfo> highlights=infos.get(range);
    int startOffset=range.getStartOffset();
    int endOffset=range.getEndOffset();
    for (    HighlightInfo info : highlights) {
      int infoEndOffset=info.endOffset;
      int infoStartOffset=info.startOffset;
      if (infoStartOffset < startOffset || infoEndOffset > endOffset)       continue;
      HighlightSeverity severity=info.getSeverity();
      int layer;
      if (severity == HighlightSeverity.WARNING) {
        layer=HighlighterLayer.WARNING;
      }
 else       if (severity == HighlightSeverity.ERROR) {
        layer=HighlighterLayer.ERROR;
      }
 else {
        layer=HighlighterLayer.ADDITIONAL_SYNTAX;
      }
      final int docLength=document.getTextLength();
      if (infoEndOffset > docLength) {
        if (LOG.isDebugEnabled()) {
          LOG.debug("Invalid HighlightInfo created: (" + infoStartOffset + ":"+ infoEndOffset+ ")"+ info.description);
        }
        infoEndOffset=docLength;
      }
      if (info.isFileLevelAnnotation) {
        final PsiFile psiFile=PsiDocumentManager.getInstance(project).getPsiFile(document);
        if (psiFile != null) {
          if (psiFile.getViewProvider().isPhysical()) {
            VirtualFile vFile=psiFile.getViewProvider().getVirtualFile();
            final FileEditorManager manager=FileEditorManager.getInstance(project);
            for (            FileEditor fileEditor : manager.getEditors(vFile)) {
              if (fileEditor instanceof TextEditor) {
                FileLevelIntentionComponent component=new FileLevelIntentionComponent(info.description,info.severity,info.quickFixActionRanges,project,psiFile,((TextEditor)fileEditor).getEditor());
                manager.showEditorAnnotation(fileEditor,component);
                List<HighlightInfo> fileLevelInfos=fileEditor.getUserData(FILE_LEVEL_HIGHLIGHTS);
                if (fileLevelInfos == null) {
                  fileLevelInfos=new ArrayList<HighlightInfo>();
                  fileEditor.putUserData(FILE_LEVEL_HIGHLIGHTS,fileLevelInfos);
                }
                info.fileLevelComponent=component;
                info.group=group;
                fileLevelInfos.add(info);
              }
            }
            continue;
          }
        }
      }
      RangeHighlighterEx highlighter=(RangeHighlighterEx)document.getMarkupModel(project).addRangeHighlighter(infoStartOffset,infoEndOffset,layer,info.getTextAttributes(),HighlighterTargetArea.EXACT_RANGE);
      info.highlighter=highlighter;
      highlighter.setAfterEndOfLine(info.isAfterEndOfLine);
      info.text=document.getCharsSequence().subSequence(infoStartOffset,infoEndOffset).toString();
      info.group=group;
      highlighter.setErrorStripeMarkColor(info.getErrorStripeMarkColor());
      highlighter.setErrorStripeTooltip(info);
      highlighter.setGutterIconRenderer(info.getGutterIconRenderer());
      HashMap<TextRange,RangeMarker> ranges2markers=new HashMap<TextRange,RangeMarker>();
      ranges2markers.put(new TextRange(infoStartOffset,infoEndOffset),info.highlighter);
      if (info.quickFixActionRanges != null) {
        info.quickFixActionMarkers=new ArrayList<Pair<HighlightInfo.IntentionActionDescriptor,RangeMarker>>();
        for (        Pair<HighlightInfo.IntentionActionDescriptor,TextRange> pair : info.quickFixActionRanges) {
          TextRange textRange=pair.second;
          RangeMarker marker=ranges2markers.get(textRange);
          if (marker == null) {
            marker=document.createRangeMarker(textRange.getStartOffset(),textRange.getEndOffset());
            ranges2markers.put(textRange,marker);
          }
          info.quickFixActionMarkers.add(Pair.create(pair.first,marker));
        }
      }
      info.fixMarker=ranges2markers.get(new TextRange(info.fixStartOffset,info.fixEndOffset));
      if (info.fixMarker == null) {
        info.fixMarker=document.createRangeMarker(info.fixStartOffset,info.fixEndOffset);
      }
      result.add(info);
    }
  }
  HighlightInfo[] newHighlights=result.toArray(new HighlightInfo[result.size()]);
  DaemonCodeAnalyzerImpl.setHighlights(document,newHighlights,project);
  clearWhiteSpaceOptimizationFlag(document);
  return newHighlights;
}
