{
  final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
  if (file == null)   return null;
  final Language language=getLanguageInEditor(editor,project);
  if (language == null)   return file;
  if (language == file.getLanguage() || language == file.getLanguageDialect())   return file;
  final SelectionModel selectionModel=editor.getSelectionModel();
  int caretOffset=editor.getCaretModel().getOffset();
  int mostProbablyCorrectLanguageOffset=caretOffset == selectionModel.getSelectionStart() || caretOffset == selectionModel.getSelectionEnd() ? selectionModel.getSelectionStart() : caretOffset;
  PsiElement elt=getElementAtOffset(file,mostProbablyCorrectLanguageOffset);
  if (elt == null)   return file;
  return elt.getContainingFile();
}
