{
  PsiElement elt=getElementAtOffset(file,start);
  if (elt != null) {
    elt=elt.getParent();
    TextRange selectionRange=new TextRange(start,end);
    TextRange range=elt.getTextRange();
    while (!range.contains(selectionRange)) {
      elt=elt.getParent();
      if (elt == null)       break;
      range=elt.getTextRange();
    }
    if (range.contains(selectionRange) && elt != null) {
      return elt.getLanguage();
    }
  }
  return reallyEvaluateLanguageInRange(start,end,file);
}
