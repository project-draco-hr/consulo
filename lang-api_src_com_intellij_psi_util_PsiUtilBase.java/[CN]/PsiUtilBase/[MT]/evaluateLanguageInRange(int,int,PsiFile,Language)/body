{
  PsiElement elt;
  int curOffset=start;
  do {
    elt=getElementAtOffset(file,curOffset);
    if (elt == null)     break;
    if (!(elt instanceof PsiWhiteSpace)) {
      if (!Comparing.equal(lang,findLanguageFromElement(elt,file))) {
        lang=file.getLanguage();
        break;
      }
    }
    int endOffset=elt.getTextRange().getEndOffset();
    if (endOffset == curOffset) {
      endOffset++;
    }
    curOffset=endOffset;
  }
 while (curOffset < end);
  return narrowLanguage(lang,file.getLanguage());
}
