{
  Language lang=null;
  int curOffset=start;
  do {
    PsiElement elt=getElementAtOffset(file,curOffset);
    if (elt == null)     break;
    if (!(elt instanceof PsiWhiteSpace)) {
      final Language language=findLanguageFromElement(elt);
      if (lang == null) {
        lang=language;
      }
 else       if (lang != language) {
        return null;
      }
    }
    int endOffset=elt.getTextRange().getEndOffset();
    if (endOffset == curOffset) {
      endOffset++;
    }
    curOffset=endOffset;
  }
 while (curOffset < end);
  return narrowLanguage(lang,file.getLanguage());
}
