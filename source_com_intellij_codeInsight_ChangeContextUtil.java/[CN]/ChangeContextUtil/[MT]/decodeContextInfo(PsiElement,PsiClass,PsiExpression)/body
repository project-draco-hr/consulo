{
  if (scope.getCopyableUserData(ENCODED_KEY) != null) {
    scope.putCopyableUserData(ENCODED_KEY,null);
    if (scope instanceof PsiThisExpression) {
      PsiThisExpression thisExpr=(PsiThisExpression)scope;
      scope=decodeThisExpression(thisExpr,thisClass,thisAccessExpr);
    }
 else     if (scope instanceof PsiReferenceExpression) {
      scope=decodeReferenceExpression((PsiReferenceExpression)scope,thisAccessExpr,thisClass);
    }
 else {
      PsiClass refClass=scope.getCopyableUserData(REF_CLASS_KEY);
      scope.putCopyableUserData(REF_CLASS_KEY,null);
      if (refClass != null && refClass.isValid()) {
        PsiReference ref=scope.getReference();
        if (ref != null && refClass.getQualifiedName() != null) {
          final String qualifiedName=refClass.getQualifiedName();
          if (refClass.getManager().findClass(qualifiedName,scope.getResolveScope()) != null) {
            scope=ref.bindToElement(refClass);
          }
        }
      }
      final PsiFileSystemItem item=scope.getCopyableUserData(REF_FILE_SYSTEM_ITEM_KEY);
      scope.putCopyableUserData(REF_FILE_SYSTEM_ITEM_KEY,null);
      if (item != null && item.isValid()) {
        PsiReference[] refs=scope.getReferences();
        if (refs.length > 0) {
          scope=refs[refs.length - 1].bindToElement(item);
        }
      }
    }
  }
  if (scope instanceof PsiClass) {
    if (thisAccessExpr != null) {
      thisAccessExpr=(PsiExpression)qualifyThis(thisAccessExpr,thisClass);
    }
  }
  for (PsiElement child=scope.getFirstChild(); child != null; child=child.getNextSibling()) {
    child=decodeContextInfo(child,thisClass,thisAccessExpr);
  }
  return scope;
}
