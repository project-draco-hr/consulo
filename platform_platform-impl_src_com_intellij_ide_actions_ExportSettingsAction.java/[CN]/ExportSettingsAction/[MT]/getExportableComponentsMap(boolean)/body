{
  ExportableApplicationComponent[] components1=ApplicationManager.getApplication().getComponents(ExportableApplicationComponent.class);
  List<ExportableComponent> components2=ServiceBean.loadServicesFromBeans(ExportableComponent.EXTENSION_POINT,ExportableComponent.class);
  final MultiMap<File,ExportableComponent> result=MultiMap.createSet();
  for (  ExportableComponent component : ContainerUtil.concat(Arrays.asList(components1),components2)) {
    for (    File exportFile : component.getExportFiles()) {
      result.putValue(exportFile,component);
    }
  }
  if (onlyExisting) {
    for (Iterator<File> it=result.keySet().iterator(); it.hasNext(); ) {
      if (!it.next().exists()) {
        it.remove();
      }
    }
  }
  ApplicationImpl application=(ApplicationImpl)ApplicationManager.getApplication();
  final StateStorageManager storageManager=application.getStateStore().getStateStorageManager();
  ServiceManagerImpl.processAllImplementationClasses(application,new PairProcessor<Class<?>,PluginDescriptor>(){
    @Override public boolean process(    @NotNull Class<?> aClass,    @Nullable PluginDescriptor pluginDescriptor){
      State stateAnnotation=aClass.getAnnotation(State.class);
      if (stateAnnotation != null && !StringUtil.isEmpty(stateAnnotation.name())) {
        if (ExportableComponent.class.isAssignableFrom(aClass)) {
          return true;
        }
        int storageIndex;
        Storage[] storages=stateAnnotation.storages();
        if (storages.length == 1) {
          storageIndex=0;
        }
 else         if (storages.length > 1 && stateAnnotation.storageChooser() == LastStorageChooserForWrite.class) {
          storageIndex=storages.length - 1;
        }
 else {
          return true;
        }
        Storage storage=storages[storageIndex];
        if (storage.roamingType() != RoamingType.DISABLED && storage.storageClass().equals(StateStorage.class) && storage.scheme() == StorageScheme.DEFAULT && !StringUtil.isEmpty(storage.file()) && storage.file().startsWith(StoragePathMacros.APP_CONFIG)) {
          File file=new File(storageManager.expandMacros(storage.file()));
          if (!onlyExisting || file.exists()) {
            result.putValue(file,new MyExportableComponent(file,getExportableComponentPresentableName(stateAnnotation.name(),aClass,pluginDescriptor)));
          }
        }
      }
      return true;
    }
  }
);
  return result;
}
