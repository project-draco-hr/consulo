{
  final Facet[] facets=getSortedFacets();
  if (facets.length == 0 && myHasNoFacetsFromBeginning) {
    throw new WriteExternalException();
  }
  Map<Facet,Element> elements=new HashMap<Facet,Element>();
  elements.put(null,element);
  for (  Facet facet : facets) {
    final Facet underlyingFacet=facet.getUnderlyingFacet();
    final Element parent=elements.get(underlyingFacet);
    Element child=new Element(FACET_ELEMENT);
    child.setAttribute(TYPE_ATTRIBUTE,facet.getType().getStringId());
    child.setAttribute(NAME_ATTRIBUTE,facet.getName());
    if (facet.isImplicit()) {
      child.setAttribute(IMPLICIT_ATTRIBUTE,String.valueOf(facet.isImplicit()));
    }
    final Element config=new Element(CONFIGURATION_ELEMENT);
    try {
      facet.getConfiguration().writeExternal(config);
      if (facet instanceof JDOMExternalizable) {
        ((JDOMExternalizable)facet).writeExternal(config);
      }
    }
 catch (    WriteExternalException e) {
      continue;
    }
    child.addContent(config);
    parent.addContent(child);
    elements.put(facet,child);
  }
  if (element.getContentSize() == 0 && myHasNoFacetsFromBeginning) {
    throw new WriteExternalException();
  }
}
