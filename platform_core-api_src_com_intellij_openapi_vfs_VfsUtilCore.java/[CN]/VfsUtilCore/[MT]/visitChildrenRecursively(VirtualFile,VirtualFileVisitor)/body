{
  if (!file.isValid())   return VirtualFileVisitor.CONTINUE;
  visitor.pushFrame();
  try {
    final boolean visited=visitor.allowVisitFile(file);
    if (visited) {
      VirtualFileVisitor.Result result=visitor.visitFileEx(file);
      if (result.skipChildren)       return result;
    }
    if (!visitor.allowVisitChildren(file))     return VirtualFileVisitor.CONTINUE;
    if (!visitor.depthLimitReached()) {
      final Iterable<VirtualFile> iterable=visitor.getChildrenIterable(file);
      if (iterable != null) {
        for (        VirtualFile child : iterable) {
          VirtualFileVisitor.Result result=visitChildrenRecursively(child,visitor);
          if (result.skipToParent != null && result.skipToParent != child)           return result;
        }
      }
 else {
        @SuppressWarnings("UnsafeVfsRecursion") VirtualFile[] children=file.getChildren();
        for (        VirtualFile child : children) {
          VirtualFileVisitor.Result result=visitChildrenRecursively(child,visitor);
          if (result.skipToParent != null && result.skipToParent != child)           return result;
        }
      }
    }
    if (visited) {
      visitor.afterChildrenVisited(file);
    }
    return VirtualFileVisitor.CONTINUE;
  }
  finally {
    visitor.popFrame();
  }
}
