{
  if (!file.isValid())   return;
  if (!visitor.visitFile(file))   return;
  boolean visitChildren=true;
  if (file.isSymLink()) {
    if (!visitor.followSymLinks())     return;
    if (visitedSymLinks == null) {
      visitedSymLinks=new HashSet<VirtualFile>();
    }
    if (!visitedSymLinks.add(file) || isInvalidLink(file)) {
      visitChildren=false;
    }
  }
  if (visitChildren) {
    VirtualFile[] children=file.getChildren();
    for (    VirtualFile child : children) {
      visitChildrenRecursively(child,visitor,visitedSymLinks);
    }
  }
  visitor.afterChildrenVisited(file);
}
