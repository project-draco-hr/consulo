{
  if (!file.isValid())   return;
  if (!visitor.visitFile(file))   return;
  if (file.isSymLink()) {
    if (visitedSymlinks == null) {
      visitedSymlinks=new HashSet<VirtualFile>();
    }
    if (!visitedSymlinks.add(file)) {
      visitor.afterChildrenVisited(file);
      return;
    }
  }
  VirtualFile[] children=file.getChildren();
  for (  VirtualFile child : children) {
    visitChildrenRecursively(child,visitor,visitedSymlinks);
  }
  visitor.afterChildrenVisited(file);
}
