{
  if (!file.isValid())   return;
  if (!visitor.visitFile(file))   return;
  if (file.isSymLink()) {
    if (!visitor.followSymLinks())     return;
    if (visitedSymLinks == null) {
      visitedSymLinks=new HashSet<VirtualFile>();
    }
    if (!visitedSymLinks.add(file)) {
      visitor.afterChildrenVisited(file);
      return;
    }
  }
  VirtualFile[] children=file.getChildren();
  for (  VirtualFile child : children) {
    visitChildrenRecursively(child,visitor,visitedSymLinks);
  }
  visitor.afterChildrenVisited(file);
}
