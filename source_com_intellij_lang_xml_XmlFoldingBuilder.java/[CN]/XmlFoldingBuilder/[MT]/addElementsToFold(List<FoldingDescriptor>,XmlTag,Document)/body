{
  if (addToFold(foldings,tag,document) || tag instanceof JspXmlRootTag) {
    PsiElement[] children=tag.getChildren();
    for (    PsiElement child : children) {
      if (child instanceof XmlTag) {
        ProgressManager.getInstance().checkCanceled();
        addElementsToFold(foldings,(XmlTag)child,document);
      }
 else {
        final Language language=child.getLanguage();
        if (!(language instanceof XMLLanguage) && language != Language.ANY) {
          final FoldingBuilder foldingBuilder=language.getFoldingBuilder();
          if (foldingBuilder != null) {
            final FoldingDescriptor[] foldingDescriptors=foldingBuilder.buildFoldRegions(child.getNode(),document);
            if (foldingDescriptors != null) {
              for (              FoldingDescriptor descriptor : foldingDescriptors) {
                foldings.add(descriptor);
              }
            }
          }
        }
      }
    }
  }
}
