{
  if (addToFold(foldings,tag,document) || tag instanceof JspXmlRootTag) {
    PsiElement[] children=tag.getChildren();
    for (int i=0; i < children.length; i++) {
      if (children[i] instanceof XmlTag) {
        ProgressManager.getInstance().checkCanceled();
        addElementsToFold(foldings,(XmlTag)children[i],document);
      }
 else {
        final Language language=children[i].getLanguage();
        if (!(language instanceof XMLLanguage) && language != Language.ANY) {
          final FoldingBuilder foldingBuilder=language.getFoldingBuilder();
          if (foldingBuilder != null) {
            final FoldingDescriptor[] foldingDescriptors=foldingBuilder.buildFoldRegions(children[i].getNode(),document);
            if (foldingDescriptors != null) {
              for (int j=0; j < foldingDescriptors.length; j++) {
                foldings.add(foldingDescriptors[j]);
              }
            }
          }
        }
      }
    }
  }
}
