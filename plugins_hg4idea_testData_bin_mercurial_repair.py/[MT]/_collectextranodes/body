def _collectextranodes(repo, files, link):
    'return the nodes that have to be saved before the strip'

    def collectone(revlog):
        extra = []
        startrev = count = len(revlog)
        for i in xrange(count):
            lrev = revlog.linkrev(i)
            if (lrev >= link):
                startrev = (i + 1)
                break
        for i in xrange(startrev, count):
            node = revlog.node(i)
            lrev = revlog.linkrev(i)
            if (lrev < link):
                extra.append((node, cl.node(lrev)))
        return extra
    extranodes = {}
    cl = repo.changelog
    extra = collectone(repo.manifest)
    if extra:
        extranodes[1] = extra
    for fname in files:
        f = repo.file(fname)
        extra = collectone(f)
        if extra:
            extranodes[fname] = extra
    return extranodes
