{
  final ActionCallback menuBuilt=new ActionCallback();
  ArrayList<AnAction> list=new ArrayList<AnAction>();
  expandActionGroup(group,list,presentationFactory,context,place,ActionManager.getInstance());
  final boolean fixMacScreenMenu=SystemInfo.isMacSystemMenu && isWindowMenu && Registry.is("actionSystem.mac.screenMenuNotUpdatedFix");
  final ArrayList<Component> children=new ArrayList<Component>();
  for (int i=0; i < list.size(); i++) {
    AnAction action=list.get(i);
    if (action instanceof Separator) {
      if (i > 0 && i < list.size() - 1) {
        component.add(new JPopupMenu.Separator());
      }
    }
 else     if (action instanceof ActionGroup && !(((ActionGroup)action).canBePerformed(context) && !hasVisibleChildren((ActionGroup)action,presentationFactory,context,place))) {
      ActionMenu menu=new ActionMenu(context,place,(ActionGroup)action,presentationFactory,enableMnemonics);
      component.add(menu);
      children.add(menu);
    }
 else {
      final ActionMenuItem each=new ActionMenuItem(action,presentationFactory.getPresentation(action),place,context,enableMnemonics,!fixMacScreenMenu);
      component.add(each);
      children.add(each);
    }
  }
  if (list.isEmpty()) {
    final ActionMenuItem each=new ActionMenuItem(EMPTY_MENU_FILLER,presentationFactory.getPresentation(EMPTY_MENU_FILLER),place,context,enableMnemonics,!fixMacScreenMenu);
    component.add(each);
    children.add(each);
  }
  if (fixMacScreenMenu) {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        for (        Component each : children) {
          if (each.getParent() != null && each instanceof ActionMenuItem) {
            ((ActionMenuItem)each).prepare();
          }
        }
        menuBuilt.setDone();
      }
    }
);
  }
 else {
    menuBuilt.setDone();
  }
  menuBuilt.doWhenDone(new Runnable(){
    public void run(){
      if (IdeFocusManager.getInstance(null).isFocusBeingTransferred()) {
        IdeFocusManager.getInstance(null).doWhenFocusSettlesDown(new Runnable(){
          public void run(){
            if (!component.isShowing())             return;
            DataContext context=DataManager.getInstance().getDataContext();
            expandActionGroup(group,new ArrayList<AnAction>(),presentationFactory,context,place,ActionManager.getInstance());
            for (            Component each : children) {
              if (each instanceof ActionMenuItem) {
                ((ActionMenuItem)each).updateContext(context);
              }
 else               if (each instanceof ActionMenu) {
                ((ActionMenu)each).updateContext(context);
              }
            }
          }
        }
);
      }
    }
  }
);
}
