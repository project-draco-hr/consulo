{
  final HistoryElement selectedItem=myModel.getSelectedItem();
  final HistoryElement newElement;
  if (selectedItem != null) {
    newElement=selectedItem.changeContext(namespaces,variables);
  }
 else {
    newElement=new HistoryElement(myDocument.getText(),variables,namespaces);
  }
  myModel.setSelectedItem(newElement);
  if (myNamespaceCache == null) {
    myContextProvider.getNamespaceContext().setMap(asMap(namespaces));
  }
  final DaemonCodeAnalyzer analyzer=DaemonCodeAnalyzer.getInstance(myProject);
  analyzer.restart();
  analyzer.updateVisibleHighlighters(getEditor());
}
