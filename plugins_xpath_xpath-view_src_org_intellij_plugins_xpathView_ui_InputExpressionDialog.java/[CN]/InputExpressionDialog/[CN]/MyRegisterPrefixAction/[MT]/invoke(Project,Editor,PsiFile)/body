{
  final Set<String> prefix=Collections.singleton(myReference.getCanonicalText());
  final Map<String,String> myMap=myContextProvider.getNamespaceContext().myMap;
  final Collection<String> list;
  if (myNamespaceCache == null) {
    final ExternalResourceManager erm=ExternalResourceManager.getInstance();
    list=new ArrayList<String>(Arrays.asList(erm.getResourceUrls(null,true)));
    for (    String namespace : myMap.values()) {
      list.remove(namespace);
    }
    Collections.sort((List<String>)list);
  }
 else {
    list=myMap.values();
  }
  final AddNamespaceDialog dlg=new AddNamespaceDialog(project,prefix,list,myNamespaceCache == null ? AddNamespaceDialog.Mode.URI_EDITABLE : AddNamespaceDialog.Mode.FIXED);
  dlg.show();
  if (dlg.isOK()) {
    final Namespace namespace=new Namespace(dlg.getPrefix(),dlg.getURI());
    final HistoryElement selectedItem=myModel.getSelectedItem();
    final Collection<Namespace> n;
    final Collection<Variable> v;
    if (selectedItem != null) {
      n=new HashSet<Namespace>(selectedItem.namespaces);
      n.remove(namespace);
      n.add(namespace);
      v=selectedItem.variables;
    }
 else {
      n=Collections.singleton(namespace);
      v=Collections.EMPTY_SET;
    }
    updateContext(n,v);
  }
}
