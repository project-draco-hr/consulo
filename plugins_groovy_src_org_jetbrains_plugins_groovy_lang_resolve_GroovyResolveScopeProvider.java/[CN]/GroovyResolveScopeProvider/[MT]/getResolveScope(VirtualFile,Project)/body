{
  if (file.getFileType() != GroovyFileType.GROOVY_FILE_TYPE)   return null;
  ProjectFileIndex projectFileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  Module module=projectFileIndex.getModuleForFile(file);
  if (module == null)   return null;
  boolean includeTests=projectFileIndex.isInTestSourceContent(file) || !projectFileIndex.isInSourceContent(file);
  final GlobalSearchScope scope=GlobalSearchScope.moduleWithDependenciesAndLibrariesScope(module,includeTests);
  final PsiFile psi=PsiManager.getInstance(project).findFile(file);
  if (psi instanceof GroovyFile && ((GroovyFile)psi).isScript()) {
    return GroovyScriptTypeDetector.getScriptType((GroovyFile)psi).patchResolveScope((GroovyFile)psi,scope);
  }
 else {
    return scope;
  }
}
