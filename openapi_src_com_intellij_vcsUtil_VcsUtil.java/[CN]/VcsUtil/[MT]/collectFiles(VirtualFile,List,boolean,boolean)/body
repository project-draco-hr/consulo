{
  if (!dir.isDirectory()) {
    throw new IllegalArgumentException(VcsBundle.message("exception.text.file.should.be.directory",dir.getPresentableUrl()));
  }
  FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  VirtualFile[] children=dir.getChildren();
  for (  VirtualFile child : children) {
    if (!child.isDirectory() && (fileTypeManager == null || fileTypeManager.getFileTypeByFile(child) != StdFileTypes.UNKNOWN)) {
      files.add(child);
    }
 else     if (recursive && child.isDirectory()) {
      if (addDirectories) {
        files.add(child);
      }
      collectFiles(child,files,recursive,false);
    }
  }
}
