{
  Patch patchInfo=new Patch(olderDir,newerDir,ignoredFiles,criticalFiles,optionalFiles,ui);
  ui.startProcess("Creating the patch file '" + patchFile + "'...");
  ui.checkCancelled();
  ZipOutputStream out=new ZipOutputStream(new FileOutputStream(patchFile));
  try {
    out.setLevel(9);
    out.putNextEntry(new ZipEntry(PATCH_INFO_FILE_NAME));
    patchInfo.write(out);
    out.closeEntry();
    List<PatchAction> actions=patchInfo.getActions();
    for (    PatchAction each : actions) {
      ui.setStatus("Packing " + each.getPath());
      ui.checkCancelled();
      each.buildPatchFile(olderDir,newerDir,out);
    }
  }
  finally {
    out.close();
  }
}
