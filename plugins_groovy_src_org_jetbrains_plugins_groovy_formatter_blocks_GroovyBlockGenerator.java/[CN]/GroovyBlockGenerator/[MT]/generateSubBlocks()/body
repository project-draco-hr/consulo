{
  PsiElement blockPsi=myNode.getPsi();
  IElementType elementType=myNode.getElementType();
  if (blockPsi instanceof GrBinaryExpression && !(blockPsi.getParent() instanceof GrBinaryExpression)) {
    return generateForBinaryExpr();
  }
  if ((elementType == mSTRING_LITERAL || elementType == mGSTRING_LITERAL) && myBlock.getTextRange().equals(myNode.getTextRange())) {
    String text=myNode.getText();
    if (text.length() > 6) {
      if (text.substring(0,3).equals("'''") && text.substring(text.length() - 3).equals("'''") || text.substring(0,3).equals("\"\"\"") & text.substring(text.length() - 3).equals("\"\"\"")) {
        return generateForMultiLineString();
      }
    }
  }
  if (elementType == GSTRING || elementType == REGEX || elementType == mREGEX_LITERAL || elementType == mDOLLAR_SLASH_REGEX_LITERAL) {
    final FormattingContext context=myNode.getPsi() instanceof GrString && ((GrString)myNode.getPsi()).isPlainString() ? myContext.createContext(true) : myContext;
    final ArrayList<Block> subBlocks=new ArrayList<Block>();
    ASTNode[] children=getGroovyChildren(myNode);
    for (    ASTNode childNode : children) {
      if (childNode.getTextRange().getLength() > 0) {
        subBlocks.add(new GroovyBlock(childNode,getIndent(childNode),Wrap.createWrap(WrapType.NONE,false),context));
      }
    }
    return subBlocks;
  }
  if (NESTED.contains(elementType) && blockPsi.getParent() != null && !NESTED.contains(blockPsi.getParent().getNode().getElementType())) {
    final List<Block> subBlocks=new ArrayList<Block>();
    AlignmentProvider.Aligner dotsAligner=myContext.getSettings().ALIGN_MULTILINE_CHAINED_METHODS ? myAlignmentProvider.createAligner(false) : null;
    final Wrap wrap=myWrappingProcessor.getChainedMethodCallWrap();
    addNestedChildren(myNode.getPsi(),subBlocks,dotsAligner,true,wrap);
    return subBlocks;
  }
  if (blockPsi instanceof GrListOrMap && ((GrListOrMap)blockPsi).isMap() && myContext.getGroovySettings().ALIGN_NAMED_ARGS_IN_MAP) {
    AlignmentProvider.Aligner labels=myAlignmentProvider.createAligner(false);
    AlignmentProvider.Aligner exprs=myAlignmentProvider.createAligner(true);
    GrNamedArgument[] namedArgs=((GrListOrMap)blockPsi).getNamedArguments();
    for (    GrNamedArgument arg : namedArgs) {
      GrArgumentLabel label=arg.getLabel();
      if (label != null)       labels.append(label);
      PsiElement colon=arg.getColon();
      if (colon == null)       colon=arg.getExpression();
      if (colon != null)       exprs.append(colon);
    }
  }
  if (isListLikeClause(blockPsi)) {
    final ArrayList<Block> subBlocks=new ArrayList<Block>();
    List<ASTNode> astNodes=visibleChildren(myNode);
    if (mustAlign(blockPsi,astNodes)) {
      final AlignmentProvider.Aligner aligner=myAlignmentProvider.createAligner(false);
      for (      ASTNode node : astNodes) {
        if (!isKeyword(node))         aligner.append(node.getPsi());
      }
    }
    for (    ASTNode childNode : astNodes) {
      subBlocks.add(new GroovyBlock(childNode,getIndent(childNode),getChildWrap(childNode),myContext));
    }
    return subBlocks;
  }
  boolean classLevel=blockPsi instanceof GrTypeDefinitionBody;
  if (blockPsi instanceof GrClosableBlock && ((GrClosableBlock)blockPsi).getArrow() != null && ((GrClosableBlock)blockPsi).getParameters().length > 0 && !getClosureBodyVisibleChildren(myNode).isEmpty()) {
    GrClosableBlock closableBlock=(GrClosableBlock)blockPsi;
    ArrayList<Block> blocks=new ArrayList<Block>();
    PsiElement lbrace=closableBlock.getLBrace();
    if (lbrace != null) {
      ASTNode node=lbrace.getNode();
      blocks.add(new GroovyBlock(node,getIndent(node),Wrap.createWrap(WrapType.NONE,false),myContext));
    }
{
      Indent indent=Indent.getNormalIndent();
      ASTNode parameterListNode=closableBlock.getParameterList().getNode();
      ClosureBodyBlock bodyBlock=new ClosureBodyBlock(parameterListNode,indent,Wrap.createWrap(WrapType.NONE,false),myContext);
      blocks.add(bodyBlock);
    }
    PsiElement rbrace=closableBlock.getRBrace();
    if (rbrace != null) {
      ASTNode node=rbrace.getNode();
      blocks.add(new GroovyBlock(node,getIndent(node),Wrap.createWrap(WrapType.NONE,false),myContext));
    }
    return blocks;
  }
  if (blockPsi instanceof GrCodeBlock || blockPsi instanceof GroovyFile || classLevel) {
    return generateSubBlockForCodeBlocks(classLevel,visibleChildren(myNode),myContext.getGroovySettings().INDENT_LABEL_BLOCKS);
  }
  if (blockPsi instanceof GrMethod) {
    final ArrayList<Block> subBlocks=new ArrayList<Block>();
    for (    ASTNode childNode : getGroovyChildren(myNode)) {
      if (childNode.getElementType() == mLPAREN)       continue;
      if (childNode.getElementType() == mRPAREN)       continue;
      if (childNode.getElementType() == PARAMETERS_LIST) {
        subBlocks.add(new ParameterListBlock(((GrMethod)blockPsi),Indent.getNoneIndent(),Wrap.createWrap(WrapType.NONE,false),myContext));
      }
 else       if (canBeCorrectBlock(childNode)) {
        subBlocks.add(new GroovyBlock(childNode,getIndent(childNode),getChildWrap(childNode),myContext));
      }
    }
    return subBlocks;
  }
 else   if (blockPsi instanceof GrTraditionalForClause) {
    if (myContext.getSettings().ALIGN_MULTILINE_FOR) {
      final GrTraditionalForClause clause=(GrTraditionalForClause)blockPsi;
      final AlignmentProvider.Aligner parenthesesAligner=myAlignmentProvider.createAligner(false);
      parenthesesAligner.append(clause.getInitialization());
      parenthesesAligner.append(clause.getCondition());
      parenthesesAligner.append(clause.getUpdate());
    }
  }
 else   if (blockPsi instanceof GrBinaryExpression) {
    if (myContext.getSettings().ALIGN_MULTILINE_BINARY_OPERATION) {
      final GrBinaryExpression binary=(GrBinaryExpression)blockPsi;
      final GrExpression left=binary.getLeftOperand();
      final GrExpression right=binary.getRightOperand();
      if (left != null && right != null) {
        myAlignmentProvider.addPair(left,right,false);
      }
    }
  }
 else   if (blockPsi instanceof GrAssignmentExpression) {
    if (myContext.getSettings().ALIGN_MULTILINE_ASSIGNMENT) {
      final GrAssignmentExpression assignment=(GrAssignmentExpression)blockPsi;
      final GrExpression lValue=assignment.getLValue();
      final GrExpression rValue=assignment.getRValue();
      if (lValue != null && rValue != null) {
        myAlignmentProvider.addPair(lValue,rValue,false);
      }
    }
  }
 else   if (blockPsi instanceof GrConditionalExpression) {
    if (myContext.getSettings().ALIGN_MULTILINE_TERNARY_OPERATION) {
      final GrConditionalExpression conditional=(GrConditionalExpression)blockPsi;
      final AlignmentProvider.Aligner aligner=myAlignmentProvider.createAligner(false);
      aligner.append(conditional.getCondition());
      if (!(conditional instanceof GrElvisExpression)) {
        aligner.append(conditional.getThenBranch());
      }
      aligner.append(conditional.getElseBranch());
    }
  }
  final ArrayList<Block> subBlocks=new ArrayList<Block>();
  for (  ASTNode childNode : visibleChildren(myNode)) {
    subBlocks.add(new GroovyBlock(childNode,getIndent(childNode),getChildWrap(childNode),myContext));
  }
  return subBlocks;
}
