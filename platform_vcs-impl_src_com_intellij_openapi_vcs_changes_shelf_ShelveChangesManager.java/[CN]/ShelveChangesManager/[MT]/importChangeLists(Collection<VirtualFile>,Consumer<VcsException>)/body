{
  final List<ShelvedChangeList> result=new ArrayList<>(files.size());
  try {
    final FilesProgress filesProgress=new FilesProgress(files.size(),"Processing ");
    for (    VirtualFile file : files) {
      filesProgress.updateIndicator(file);
      final String description=file.getNameWithoutExtension().replace('_',' ');
      File schemeNameDir=generateUniqueSchemePatchDir(description,true);
      final File patchPath=getPatchFileInConfigDir(schemeNameDir);
      final ShelvedChangeList list=new ShelvedChangeList(patchPath.getPath(),description,new SmartList<>(),file.getTimeStamp());
      list.setName(schemeNameDir.getName());
      try {
        final List<TextFilePatch> patchesList=loadPatches(myProject,file.getPath(),new CommitContext());
        if (!patchesList.isEmpty()) {
          FileUtil.copy(new File(file.getPath()),patchPath);
          mySchemeManager.addNewScheme(list,false);
          result.add(list);
        }
      }
 catch (      IOException e) {
        exceptionConsumer.consume(new VcsException(e));
      }
catch (      PatchSyntaxException e) {
        exceptionConsumer.consume(new VcsException(e));
      }
    }
  }
  finally {
    notifyStateChanged();
  }
  return result;
}
