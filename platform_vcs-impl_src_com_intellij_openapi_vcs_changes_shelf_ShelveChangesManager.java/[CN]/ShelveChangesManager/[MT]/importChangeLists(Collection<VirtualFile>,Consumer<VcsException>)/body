{
  final List<ShelvedChangeList> result=new ArrayList<ShelvedChangeList>(files.size());
  try {
    final LinkedList<VirtualFile> filesQueue=new LinkedList<VirtualFile>(files);
    while (!filesQueue.isEmpty()) {
      ProgressManager.checkCanceled();
      final VirtualFile file=filesQueue.removeFirst();
      if (file.isDirectory()) {
        filesQueue.addAll(Arrays.asList(file.getChildren()));
        continue;
      }
      final String description=file.getNameWithoutExtension().replace('_',' ');
      final File patchPath=getPatchPath(description);
      final ShelvedChangeList list=new ShelvedChangeList(patchPath.getPath(),description,new SmartList<ShelvedBinaryFile>(),file.getTimeStamp());
      try {
        final List<TextFilePatch> patchesList=loadPatches(file.getPath());
        if (!patchesList.isEmpty()) {
          FileUtil.copy(new File(file.getPath()),patchPath);
          myShelvedChangeLists.add(list);
          result.add(list);
        }
      }
 catch (      IOException e) {
        exceptionConsumer.consume(new VcsException(e));
      }
catch (      PatchSyntaxException e) {
        exceptionConsumer.consume(new VcsException(e));
      }
    }
  }
  finally {
    notifyStateChanged();
  }
  return result;
}
