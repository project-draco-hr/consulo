{
  final String moduleName=getModule() == null ? "jar" : ModuleUtil.getModuleNameInReadAction(getModule());
  final File tempFile=createTempFile(moduleName,".tmp");
  makeJar(context,tempFile,fileFilter);
  final String outputRelativePath=getOutputRelativePath();
  File file=getJarFile();
  if (isExternalDependencyInstruction()) {
    final File toFile=MakeUtil.canonicalRelativePath(jarFile,outputRelativePath);
    MakeUtil.getInstance().copyFile(file,toFile,context,null,fileFilter);
    dependencies.addInstruction(this);
  }
 else {
    ZipUtil.addFileToZip(outputStream,file,outputRelativePath,writtenRelativePaths,fileFilter);
  }
}
