{
  if (myProject.isDefault())   return null;
  if (anImport) {
    final ProjectBuilder builder=runModuleWizard(parent,true);
    if (builder != null) {
      final List<Module> modules=new ArrayList<Module>();
      final List<Module> commitedModules;
      if (builder instanceof ProjectImportBuilder<?>) {
        final ModifiableArtifactModel artifactModel=ProjectStructureConfigurable.getInstance(myProject).getArtifactsStructureConfigurable().getModifiableArtifactModel();
        commitedModules=((ProjectImportBuilder<?>)builder).commit(myProject,myModuleModel,this,artifactModel);
      }
 else {
        commitedModules=builder.commit(myProject,myModuleModel,this);
      }
      if (commitedModules != null) {
        modules.addAll(commitedModules);
      }
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          for (          Module module : modules) {
            getOrCreateModuleEditor(module);
          }
        }
      }
);
      return modules;
    }
  }
 else {
    FileChooserDescriptor fileChooserDescriptor=new FileChooserDescriptor(false,true,false,false,false,false){
      @Override public boolean isFileSelectable(      VirtualFile file){
        if (!super.isFileSelectable(file)) {
          return false;
        }
        for (        Module module : myModuleModel.getModules()) {
          VirtualFile moduleDir=module.getModuleDir();
          if (moduleDir != null && moduleDir.equals(file)) {
            return false;
          }
        }
        return true;
      }
    }
;
    fileChooserDescriptor.setTitle(ProjectBundle.message("choose.module.home"));
    VirtualFile moduleDir=FileChooser.chooseFile(fileChooserDescriptor,myProject,null);
    if (moduleDir == null) {
      return null;
    }
    final Module newModule;
    if (EarlyAccessProgramManager.getInstance().getState(NewProjectOrModuleDialogWithSetup.EapDescriptor.class)) {
      NewProjectOrModuleDialogWithSetup dialogWithSetup=new NewProjectOrModuleDialogWithSetup(myProject,moduleDir);
      newModule=dialogWithSetup.showAndGet() ? dialogWithSetup.doCreate(myModuleModel,moduleDir) : null;
    }
 else {
      newModule=myModuleModel.newModule(moduleDir.getNameWithoutExtension(),moduleDir.getPath());
      final ModifiableRootModel modifiableModel=ModuleRootManager.getInstance(newModule).getModifiableModel();
      modifiableModel.addContentEntry(moduleDir);
      new WriteAction<Object>(){
        @Override protected void run(        Result<Object> result) throws Throwable {
          modifiableModel.commit();
        }
      }
.execute();
    }
    if (newModule == null) {
      return null;
    }
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        getOrCreateModuleEditor(newModule);
        Collections.sort(myModuleEditors,myModuleEditorComparator);
      }
    }
);
    processModuleCountChanged();
    return Collections.singletonList(newModule);
  }
  return null;
}
