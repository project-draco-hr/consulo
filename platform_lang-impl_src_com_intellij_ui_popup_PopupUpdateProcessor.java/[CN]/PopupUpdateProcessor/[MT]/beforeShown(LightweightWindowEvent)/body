{
  final Lookup activeLookup=LookupManager.getInstance(myProject).getActiveLookup();
  if (activeLookup != null) {
    activeLookup.addLookupListener(new LookupAdapter(){
      public void currentItemChanged(      LookupEvent event){
        if (windowEvent.asPopup().isVisible()) {
          final LookupElement item=event.getItem();
          if (item != null) {
            PsiElement targetElement=CompletionUtil.getTargetElement(item);
            if (targetElement == null) {
              targetElement=DocumentationManager.getInstance(myProject).getElementFromLookup(activeLookup.getEditor(),activeLookup.getPsiFile());
            }
            updatePopup(targetElement);
          }
        }
 else {
          activeLookup.removeLookupListener(this);
        }
      }
    }
);
  }
 else {
    final Component focusedComponent=WindowManagerEx.getInstanceEx().getFocusedComponent(myProject);
    boolean fromQuickSearch=focusedComponent != null && focusedComponent.getParent() instanceof ChooseByNameBase.JPanelProvider;
    if (fromQuickSearch) {
      ChooseByNameBase.JPanelProvider panelProvider=(ChooseByNameBase.JPanelProvider)focusedComponent.getParent();
      panelProvider.registerHint(windowEvent.asPopup());
    }
 else     if (focusedComponent != null) {
      if (focusedComponent instanceof JBListWithHintProvider) {
        ((JBListWithHintProvider)focusedComponent).registerHint(windowEvent.asPopup());
      }
 else       if (focusedComponent instanceof JBTableWithHintProvider) {
        ((JBTableWithHintProvider)focusedComponent).registerHint(windowEvent.asPopup());
      }
    }
  }
}
