{
  StringBuilder buffer=new StringBuilder("0123456789");
  RangeMarker marker=createMarker("0123456789",2,5);
  PsiToDocumentSynchronizer synchronizer=((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(getProject())).getSynchronizer();
  synchronizer.startTransaction(marker.getDocument(),null);
  final PsiToDocumentSynchronizer.DocumentChangeTransaction transaction=synchronizer.getTransaction(marker.getDocument());
  final Set<Pair<PsiToDocumentSynchronizer.MutableTextRange,StringBuffer>> affectedFragments=transaction.getAffectedFragments();
  for (int i=0; i < 10; i++) {
    synchronizer.insertString(marker.getDocument(),i,"" + i);
    buffer.insert(i,"" + i);
  }
  assertEquals(1,affectedFragments.size());
  synchronizer.replaceString(marker.getDocument(),0,20,"0123456789");
  buffer.replace(0,20,"0123456789");
  assertEquals(1,affectedFragments.size());
  synchronizer.doCommitTransaction(marker.getDocument());
  assertEquals(buffer.toString(),marker.getDocument().getText());
  assertTrue(marker.isValid());
  assertEquals(2,marker.getStartOffset());
  assertEquals(5,marker.getEndOffset());
}
