{
  try {
    final XmlTag contextTag=getContextTag(editor,file);
    if (contextTag == null) {
      throw new CommonRefactoringUtil.RefactoringErrorHintException("Caret should be positioned inside a tag");
    }
    XmlElementDescriptor currentTagDescriptor=contextTag.getDescriptor();
    final XmlElementDescriptor[] descriptors=currentTagDescriptor.getElementsDescriptors(contextTag);
    Arrays.sort(descriptors,new Comparator<XmlElementDescriptor>(){
      @Override public int compare(      XmlElementDescriptor o1,      XmlElementDescriptor o2){
        return o1.getName().compareTo(o2.getName());
      }
    }
);
    final JBList list=new JBList(descriptors);
    list.setCellRenderer(new ColoredListCellRenderer(){
      @Override protected void customizeCellRenderer(      JList list,      Object value,      int index,      boolean selected,      boolean hasFocus){
        XmlElementDescriptor descriptor=(XmlElementDescriptor)value;
        append(descriptor.getName());
        append(" " + getNamespace(descriptor),SimpleTextAttributes.GRAYED_ATTRIBUTES);
      }
    }
);
    Runnable runnable=new Runnable(){
      @Override public void run(){
        final XmlElementDescriptor selected=(XmlElementDescriptor)list.getSelectedValue();
        new WriteCommandAction.Simple(project,"Generate XML Tag",file){
          @Override protected void run(){
            XmlTag newTag=createTag(contextTag,selected);
            newTag=contextTag.addSubTag(newTag,false);
            generateTag(newTag);
          }
        }
.execute();
      }
    }
;
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      XmlElementDescriptor descriptor=ContainerUtil.find(descriptors,new Condition<XmlElementDescriptor>(){
        @Override public boolean value(        XmlElementDescriptor xmlElementDescriptor){
          return xmlElementDescriptor.getName().equals(TEST_THREAD_LOCAL.get());
        }
      }
);
      list.setSelectedValue(descriptor,false);
      runnable.run();
    }
 else {
      JBPopupFactory.getInstance().createListPopupBuilder(list).setTitle("Choose Tag Name").setItemChoosenCallback(runnable).createPopup().showInBestPositionFor(editor);
    }
  }
 catch (  CommonRefactoringUtil.RefactoringErrorHintException e) {
    HintManager.getInstance().showErrorHint(editor,e.getMessage());
  }
}
