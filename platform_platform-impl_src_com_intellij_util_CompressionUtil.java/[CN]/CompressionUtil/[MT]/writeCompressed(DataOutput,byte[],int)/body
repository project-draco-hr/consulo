{
  if (length > COMPRESSION_THRESHOLD) {
    SoftReference<byte[]> reference=spareBufferLocal.get();
    byte[] compressedOutputBuffer=com.intellij.reference.SoftReference.dereference(reference);
    int maxCompressedSize=Snappy.maxCompressedLength(length);
    if (compressedOutputBuffer == null || compressedOutputBuffer.length < maxCompressedSize) {
      compressedOutputBuffer=new byte[maxCompressedSize];
      spareBufferLocal.set(new SoftReference<byte[]>(compressedOutputBuffer));
    }
    int compressedSize=Snappy.compress(bytes,0,length,compressedOutputBuffer,0);
    DataInputOutputUtil.writeINT(out,-compressedSize);
    out.write(compressedOutputBuffer,0,compressedSize);
    return compressedSize;
  }
 else {
    DataInputOutputUtil.writeINT(out,length);
    out.write(bytes,0,length);
    return length;
  }
}
