{
  myInAction=getClass();
  final Ref<Boolean> shiftPressed=Ref.create(false);
  ChooseByNamePopup popup=ChooseByNamePopup.createPopup(project,new GotoTaskPopupModel(project),new ChooseByNameItemProvider(){
    @NotNull @Override public List<String> filterNames(    @NotNull ChooseByNameBase base,    @NotNull String[] names,    @NotNull String pattern){
      return ContainerUtil.emptyList();
    }
    @Override public void filterElements(    @NotNull ChooseByNameBase base,    @NotNull String pattern,    boolean everywhere,    @NotNull ProgressIndicator cancelled,    @NotNull Processor<Object> consumer){
      List<Task> cachedTasks=new TaskSearchSupport(project).getLocalAndCachedTasks(pattern);
      List<TaskPsiElement> taskPsiElements=ContainerUtil.map(cachedTasks,new Function<Task,TaskPsiElement>(){
        @Override public TaskPsiElement fun(        Task task){
          return new TaskPsiElement(PsiManager.getInstance(project),task);
        }
      }
);
      CREATE_NEW_TASK_ACTION.setTaskName(pattern);
      cancelled.checkCanceled();
      if (!consumer.process(CREATE_NEW_TASK_ACTION))       return;
      boolean cachedTasksFound=taskPsiElements.size() != 0;
      if (cachedTasksFound) {
        cancelled.checkCanceled();
        if (!consumer.process(ChooseByNameBase.NON_PREFIX_SEPARATOR))         return;
      }
      for (      Object element : taskPsiElements) {
        cancelled.checkCanceled();
        if (!consumer.process(element))         return;
      }
      List<Task> tasks=new TaskSearchSupport(project).getRepositoryTasks(pattern,ChooseByNameBase.MAXIMUM_LIST_SIZE_LIMIT,0,true);
      if (tasks.size() == 0)       return;
      tasks.removeAll(cachedTasks);
      taskPsiElements=ContainerUtil.map(tasks,new Function<Task,TaskPsiElement>(){
        @Override public TaskPsiElement fun(        Task task){
          return new TaskPsiElement(PsiManager.getInstance(project),task);
        }
      }
);
      if (!cachedTasksFound && taskPsiElements.size() != 0) {
        cancelled.checkCanceled();
        if (!consumer.process(ChooseByNameBase.NON_PREFIX_SEPARATOR))         return;
      }
      for (      Object element : taskPsiElements) {
        cancelled.checkCanceled();
        if (!consumer.process(element))         return;
      }
    }
  }
,"",false,0);
  popup.setShowListForEmptyPattern(true);
  popup.setSearchInAnyPlace(true);
  popup.setAdText("<html>Press SHIFT to merge with current context<br/>" + "Pressing " + KeymapUtil.getFirstKeyboardShortcutText(ActionManager.getInstance().getAction(IdeActions.ACTION_QUICK_JAVADOC)) + " would show task description and comments</html>");
  popup.registerAction("shiftPressed",KeyStroke.getKeyStroke("shift pressed SHIFT"),new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      shiftPressed.set(true);
    }
  }
);
  popup.registerAction("shiftReleased",KeyStroke.getKeyStroke("released SHIFT"),new AbstractAction(){
    public void actionPerformed(    ActionEvent e){
      shiftPressed.set(false);
    }
  }
);
  showNavigationPopup(new GotoActionCallback<Object>(){
    @Override public void elementChosen(    ChooseByNamePopup popup,    Object element){
      TaskManager taskManager=TaskManager.getManager(project);
      if (element instanceof TaskPsiElement) {
        Task task=((TaskPsiElement)element).getTask();
        LocalTask localTask=taskManager.findTask(task.getId());
        if (localTask != null) {
          final boolean createChangelist=taskManager.isVcsEnabled() && !taskManager.getOpenChangelists(localTask).isEmpty();
          taskManager.activateTask(localTask,!shiftPressed.get(),createChangelist);
        }
 else {
          popup.close(false);
          (new SimpleOpenTaskDialog(project,task)).show();
        }
      }
 else       if (element == CREATE_NEW_TASK_ACTION) {
        popup.close(false);
        Task task=taskManager.createLocalTask(CREATE_NEW_TASK_ACTION.getTaskName());
        new SimpleOpenTaskDialog(project,task).show();
      }
    }
  }
,null,popup);
}
