{
  myFile=file;
  myHolder=holder;
  boolean success=true;
  try {
    if (updateWholeFile) {
      Project project=file.getProject();
      DaemonCodeAnalyzer daemonCodeAnalyzer=DaemonCodeAnalyzer.getInstance(project);
      FileStatusMap fileStatusMap=((DaemonCodeAnalyzerImpl)daemonCodeAnalyzer).getFileStatusMap();
      RefCountHolder refCountHolder=RefCountHolder.startUsing(file);
      myRefCountHolder=refCountHolder;
      Document document=PsiDocumentManager.getInstance(project).getDocument(file);
      TextRange dirtyScope=document == null ? file.getTextRange() : fileStatusMap.getFileDirtyScope(document,Pass.UPDATE_ALL);
      ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
      success=indicator instanceof DaemonProgressIndicator && refCountHolder.analyze(file,dirtyScope,action,(DaemonProgressIndicator)indicator);
    }
 else {
      myRefCountHolder=null;
      action.run();
    }
  }
  finally {
    myUninitializedVarProblems.clear();
    myFinalVarProblems.clear();
    mySingleImportedClasses.clear();
    mySingleImportedFields.clear();
    myReassignedParameters.clear();
    myRefCountHolder=null;
    myFile=null;
    myHolder=null;
  }
  return success;
}
