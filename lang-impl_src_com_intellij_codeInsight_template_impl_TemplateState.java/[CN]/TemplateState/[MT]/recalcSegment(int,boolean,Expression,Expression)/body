{
  String oldValue=getExpressionString(segmentNumber);
  int start=mySegments.getSegmentStart(segmentNumber);
  int end=mySegments.getSegmentEnd(segmentNumber);
  ExpressionContext context=createExpressionContext(start);
  Result result;
  if (isQuick) {
    result=expressionNode.calculateQuickResult(context);
  }
 else {
    result=expressionNode.calculateResult(context);
    if (expressionNode instanceof ConstantNode) {
      if (result instanceof TextResult) {
        TextResult text=(TextResult)result;
        if (text.getText().length() == 0 && defaultValue != null) {
          result=defaultValue.calculateResult(context);
        }
      }
    }
    if (result == null && defaultValue != null) {
      result=defaultValue.calculateResult(context);
    }
  }
  if (result == null)   return;
  PsiFile psiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(myDocument);
  PsiElement element=psiFile.findElementAt(start);
  if (result.equalsToText(oldValue,element))   return;
  String newValue=result.toString();
  if (newValue == null)   newValue="";
  if (element instanceof PsiJavaToken && ((PsiJavaToken)element).getTokenType() == JavaTokenType.STRING_LITERAL) {
    newValue=StringUtil.escapeStringCharacters(newValue);
  }
  replaceString(newValue,start,end,segmentNumber);
  if (result instanceof PsiTypeResult) {
    shortenReferences();
    PsiDocumentManager.getInstance(myProject).commitDocument(myDocument);
    updateTypeBindings(((PsiTypeResult)result).getType(),psiFile,segmentNumber);
  }
}
