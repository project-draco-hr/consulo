{
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  UndoManager.getInstance(myProject).undoableActionPerformed(new UndoableAction(){
    public void undo(){
      if (myDocument != null) {
        fireTemplateCancelled();
        final int segmentNumber=getCurrentSegmentNumber();
        if (segmentNumber >= 0) {
          int offsetToMove=myTemplate.getSegmentOffset(segmentNumber) - 1;
          if (offsetToMove < 0)           offsetToMove=myDocument.getTextLength();
          final int oldOffset=myEditor.getCaretModel().getOffset();
          myEditor.getCaretModel().moveToOffset(offsetToMove);
          myEditor.getCaretModel().moveToOffset(oldOffset);
        }
        setCurrentVariableNumber(-1);
      }
    }
    public void redo(){
    }
    public DocumentReference[] getAffectedDocuments(){
      if (myDocument == null)       return new DocumentReference[0];
      return new DocumentReference[]{DocumentReferenceByDocument.createDocumentReference(myDocument)};
    }
    public boolean isComplex(){
      return false;
    }
  }
);
  myTemplateIndented=false;
  myCurrentVariableNumber=-1;
  mySegments=new TemplateSegments(myEditor);
  myTemplate=template;
  if (template.isInline()) {
    int caretOffset=myEditor.getCaretModel().getOffset();
    myTemplateRange=myDocument.createRangeMarker(caretOffset,caretOffset + template.getTemplateText().length());
  }
 else {
    preprocessTemplate(PsiDocumentManager.getInstance(myProject).getPsiFile(myDocument),myEditor.getCaretModel().getOffset(),myTemplate.getTemplateText());
    int caretOffset=myEditor.getCaretModel().getOffset();
    myTemplateRange=myDocument.createRangeMarker(caretOffset,caretOffset);
  }
  myTemplateRange.setGreedyToLeft(true);
  myTemplateRange.setGreedyToRight(true);
  processAllExpressions(template);
}
