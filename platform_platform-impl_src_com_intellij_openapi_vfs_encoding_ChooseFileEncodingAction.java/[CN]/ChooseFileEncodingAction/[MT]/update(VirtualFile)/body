{
  String pattern;
  String failReason=isEnabledAndWhyNot(virtualFile);
  boolean enabled=failReason == null;
  Charset charsetFromContent=cachedCharsetFromContent(virtualFile);
  if (virtualFile != null && FileDocumentManager.getInstance().isFileModified(virtualFile)) {
    if (charsetFromContent != null) {
      pattern="Encoding (content-specified): {0}";
      enabled=false;
    }
 else     if (enabled) {
      pattern="Save ''{0}'' file in another encoding";
    }
 else {
      pattern="Encoding ''{0}'' (" + failReason + ")";
    }
  }
 else {
    if (virtualFile != null && LoadTextUtil.wasCharsetDetectedFromBytes(virtualFile)) {
      pattern="Encoding (auto-detected): {0}";
      enabled=false;
    }
 else     if (enabled) {
      pattern="Reload ''{0}'' file in another encoding";
    }
 else     if (charsetFromContent != null) {
      pattern="Encoding (content-specified): {0}";
    }
 else {
      pattern="Encoding ''{0}'' (" + failReason + ")";
    }
  }
  Charset charset=charsetFromContent != null ? charsetFromContent : virtualFile != null ? virtualFile.getCharset() : NO_ENCODING;
  String text=charset == NO_ENCODING ? "Change file encoding" : MessageFormat.format(pattern,charset.displayName());
  return Pair.create(text,enabled);
}
