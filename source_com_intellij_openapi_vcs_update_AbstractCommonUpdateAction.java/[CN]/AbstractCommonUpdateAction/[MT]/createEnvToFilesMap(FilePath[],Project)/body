{
  HashMap<UpdateEnvironment,Collection<FilePath>> result=new HashMap<UpdateEnvironment,Collection<FilePath>>();
  for (int i=0; i < roots.length; i++) {
    FilePath file=roots[i];
    AbstractVcs vcs=VcsUtil.getVcsFor(project,file);
    if (vcs != null) {
      UpdateEnvironment updateEnvironment=myActionInfo.getEnvironment(vcs);
      if (updateEnvironment != null) {
        if (!result.containsKey(updateEnvironment))         result.put(updateEnvironment,new HashSet<FilePath>());
        if (vcs.fileIsUnderVcs(file)) {
          result.get(updateEnvironment).add(file);
        }
      }
    }
  }
  for (Iterator<Collection<FilePath>> iterator=result.values().iterator(); iterator.hasNext(); ) {
    filterSubDirectories(iterator.next());
  }
  return result;
}
