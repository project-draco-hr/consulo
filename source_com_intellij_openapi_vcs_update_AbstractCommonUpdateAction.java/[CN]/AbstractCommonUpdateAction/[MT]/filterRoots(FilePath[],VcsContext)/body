{
  final ArrayList<FilePath> result=new ArrayList<FilePath>();
  for (  FilePath file : roots) {
    AbstractVcs vcs=VcsUtil.getVcsFor(vcsContext.getProject(),file);
    if (vcs != null) {
      if (!myScopeInfo.filterExistsInVcs() || vcs.fileExistsInVcs(file)) {
        UpdateEnvironment updateEnvironment=myActionInfo.getEnvironment(vcs);
        if (updateEnvironment != null) {
          result.add(file);
        }
      }
 else {
        final VirtualFile virtualFile=file.getVirtualFile();
        if (virtualFile != null && virtualFile.isDirectory()) {
          final VirtualFile[] children=virtualFile.getChildren();
          if (children != null) {
            final FilePath[] childrenAsPaths=createFilePathsOn(children);
            result.addAll(Arrays.asList(filterRoots(childrenAsPaths,vcsContext)));
          }
        }
      }
    }
  }
  return result.toArray(new FilePath[result.size()]);
}
