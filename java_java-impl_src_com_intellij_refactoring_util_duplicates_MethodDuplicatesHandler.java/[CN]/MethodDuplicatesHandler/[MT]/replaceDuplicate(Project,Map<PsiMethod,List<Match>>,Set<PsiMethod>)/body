{
  LocalHistoryAction a=LocalHistory.getInstance().startAction(REFACTORING_NAME);
  try {
    final ProgressIndicator progressIndicator=ProgressManager.getInstance().getProgressIndicator();
    if (progressIndicator != null && progressIndicator.isCanceled())     return;
    final Runnable replaceRunnable=new Runnable(){
      public void run(){
        for (        final PsiMethod method : methods) {
          final List<Match> matches=duplicates.get(method);
          if (matches == null)           continue;
          final int duplicatesNo=matches.size();
          WindowManager.getInstance().getStatusBar(project).setInfo(getStatusMessage(duplicatesNo));
          CommandProcessor.getInstance().executeCommand(project,new Runnable(){
            public void run(){
              PostprocessReformattingAspect.getInstance(project).postponeFormattingInside(new Runnable(){
                public void run(){
                  DuplicatesImpl.invoke(project,new MethodDuplicatesMatchProvider(method,matches));
                }
              }
);
            }
          }
,REFACTORING_NAME,REFACTORING_NAME);
          WindowManager.getInstance().getStatusBar(project).setInfo("");
        }
      }
    }
;
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      replaceRunnable.run();
    }
 else {
      ApplicationManager.getApplication().invokeLater(replaceRunnable,ModalityState.NON_MODAL);
    }
  }
  finally {
    a.finish();
  }
}
