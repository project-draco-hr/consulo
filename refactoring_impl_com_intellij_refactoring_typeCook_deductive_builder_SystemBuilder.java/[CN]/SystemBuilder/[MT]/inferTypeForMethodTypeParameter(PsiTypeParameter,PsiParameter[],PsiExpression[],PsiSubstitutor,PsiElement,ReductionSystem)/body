{
  PsiType substitution=PsiType.NULL;
  PsiResolveHelper helper=typeParameter.getManager().getResolveHelper();
  if (parameters.length > 0) {
    for (int j=0; j < arguments.length; j++) {
      PsiExpression argument=arguments[j];
      final PsiParameter parameter=parameters[Math.min(j,parameters.length - 1)];
      if (j >= parameters.length && !parameter.isVarArgs())       break;
      PsiType parameterType=parameter.getType();
      PsiType argumentType=evaluateType(argument,system);
      if (parameterType instanceof PsiEllipsisType) {
        parameterType=((PsiEllipsisType)parameterType).getComponentType();
        if (arguments.length == parameters.length && argumentType instanceof PsiArrayType && !(((PsiArrayType)argumentType).getComponentType() instanceof PsiPrimitiveType)) {
          argumentType=((PsiArrayType)argumentType).getComponentType();
        }
      }
      final PsiType currentSubstitution=helper.getSubstitutionForTypeParameter(typeParameter,parameterType,argumentType,true,PsiUtil.getLanguageLevel(parent));
      if (currentSubstitution == null) {
        substitution=null;
        break;
      }
 else       if (currentSubstitution instanceof PsiWildcardType) {
        if (substitution instanceof PsiWildcardType)         return PsiType.NULL;
      }
 else       if (currentSubstitution == PsiType.NULL)       continue;
      if (substitution == PsiType.NULL) {
        substitution=currentSubstitution;
        continue;
      }
      if (!substitution.equals(currentSubstitution)) {
        if (substitution instanceof PsiTypeVariable || currentSubstitution instanceof PsiTypeVariable) {
          substitution=GenericsUtil.getLeastUpperBound(substitution,currentSubstitution,typeParameter.getManager());
          if (substitution == null)           break;
        }
      }
    }
  }
  if (substitution == PsiType.NULL) {
    substitution=inferMethodTypeParameterFromParent(typeParameter,partialSubstitutor,parent,system);
  }
  return substitution;
}
