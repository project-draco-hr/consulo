{
  myEditor.assertIsDispatchThread();
  if (!supportsMultipleCarets()) {
    action.perform(getPrimaryCaret());
    return;
  }
  if (myCurrentCaret != null) {
    throw new IllegalStateException("Current caret is defined, cannot operate on other ones");
  }
  doWithCaretMerging(new Runnable(){
    public void run(){
      try {
        Collection<Caret> sortedCarets=getAllCarets();
        for (        Caret caret : sortedCarets) {
          myCurrentCaret=(CaretImpl)caret;
          action.perform(caret);
        }
      }
  finally {
        myCurrentCaret=null;
      }
    }
  }
);
}
