{
  EditorImpl.assertIsDispatchThread();
  if (myCurrentCaret != null) {
    throw new IllegalStateException("Current caret is defined, cannot operate on other ones");
  }
  doWithCaretMerging(new Runnable(){
    public void run(){
      try {
        List<Caret> sortedCarets=getAllCarets();
        if (reverseOrder) {
          Collections.reverse(sortedCarets);
        }
        for (        Caret caret : sortedCarets) {
          myCurrentCaret=(CaretImpl)caret;
          action.perform(caret);
        }
      }
  finally {
        myCurrentCaret=null;
      }
    }
  }
);
}
