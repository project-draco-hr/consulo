{
  assertIsDispatchThread();
  SelectionModel selectionModel=myEditor.getSelectionModel();
  int selectionStart=selectionModel.getLeadSelectionOffset();
  LogicalPosition blockSelectionStart=selectionModel.hasBlockSelection() ? selectionModel.getBlockStart() : getLogicalPosition();
  EditorSettings editorSettings=myEditor.getSettings();
  VisualPosition visualCaret=getVisualPosition();
  int newColumnNumber=visualCaret.column + columnShift;
  int newLineNumber=visualCaret.line + lineShift;
  if (!editorSettings.isVirtualSpace() && columnShift == 0) {
    newColumnNumber=myEditor.getLastColumnNumber();
  }
 else   if (!editorSettings.isVirtualSpace() && lineShift == 0 && columnShift == 1) {
    int lastLine=myEditor.getDocument().getLineCount() - 1;
    if (lastLine < 0)     lastLine=0;
    if (EditorModificationUtil.calcAfterLineEnd(myEditor) >= 0 && newLineNumber < myEditor.logicalToVisualPosition(new LogicalPosition(lastLine,0)).line) {
      newColumnNumber=0;
      newLineNumber++;
    }
  }
 else   if (!editorSettings.isVirtualSpace() && lineShift == 0 && columnShift == -1) {
    if (newColumnNumber < 0 && newLineNumber > 0) {
      newLineNumber--;
      newColumnNumber=EditorUtil.getLastVisualLineColumnNumber(myEditor,newLineNumber);
    }
  }
  if (newColumnNumber < 0)   newColumnNumber=0;
  if (newLineNumber < 0)   newLineNumber=0;
  int lastColumnNumber=newColumnNumber;
  if (!editorSettings.isCaretInsideTabs()) {
    LogicalPosition log=myEditor.visualToLogicalPosition(new VisualPosition(newLineNumber,newColumnNumber));
    int offset=myEditor.logicalPositionToOffset(log);
    CharSequence text=myEditor.getDocument().getCharsSequence();
    if (offset >= 0 && offset < myEditor.getDocument().getTextLength()) {
      if (text.charAt(offset) == '\t') {
        if (columnShift <= 0) {
          newColumnNumber=myEditor.offsetToVisualPosition(offset).column;
        }
 else {
          if (myEditor.offsetToVisualPosition(offset).column < newColumnNumber) {
            newColumnNumber=myEditor.offsetToVisualPosition(offset + 1).column;
          }
        }
      }
    }
  }
  VisualPosition pos=new VisualPosition(newLineNumber,newColumnNumber);
  if (columnShift != 0 && lineShift == 0 && myEditor.getSoftWrapModel().isInsideSoftWrap(pos)) {
    LogicalPosition logical=myEditor.visualToLogicalPosition(pos);
    int offsetToUse=myEditor.logicalPositionToOffset(logical);
    if (columnShift < 0) {
      offsetToUse--;
    }
    moveToOffset(offsetToUse);
  }
 else {
    moveToVisualPosition(pos);
    if (!editorSettings.isVirtualSpace() && columnShift == 0) {
      myEditor.setLastColumnNumber(lastColumnNumber);
    }
  }
  if (withSelection) {
    if (blockSelection) {
      selectionModel.setBlockSelection(blockSelectionStart,getLogicalPosition());
    }
 else {
      selectionModel.setSelection(selectionStart,getOffset());
    }
  }
 else {
    selectionModel.removeSelection();
  }
  if (scrollToCaret) {
    myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  }
}
