{
  myEditor=editor;
  myLogicalCaret=new LogicalPosition(0,0);
  myVisibleCaret=new VisualPosition(0,0);
  myCaretInfo=new VerticalInfo(0,0);
  myOffset=0;
  myVisualLineStart=0;
  Document doc=editor.getDocument();
  myVisualLineEnd=doc.getLineCount() > 1 ? doc.getLineStartOffset(1) : doc.getLineCount() == 0 ? 0 : doc.getLineEndOffset(0);
  DocumentBulkUpdateListener bulkUpdateListener=new DocumentBulkUpdateListener(){
    @Override public void updateStarted(    @NotNull Document doc){
      if (doc != myEditor.getDocument() && myOffset >= doc.getTextLength())       return;
      savedBeforeBulkCaretMarker=doc.createRangeMarker(myOffset,myOffset);
    }
    @Override public void updateFinished(    @NotNull Document doc){
      if (doc != myEditor.getDocument() || myIsInUpdate)       return;
      if (savedBeforeBulkCaretMarker != null && savedBeforeBulkCaretMarker.isValid()) {
        moveToOffset(savedBeforeBulkCaretMarker.getStartOffset());
      }
      releaseBulkCaretMarker();
    }
  }
;
  ApplicationManager.getApplication().getMessageBus().connect(this).subscribe(DocumentBulkUpdateListener.TOPIC,bulkUpdateListener);
}
