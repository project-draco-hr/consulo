{
  final ICvsFiles cvsFiles;
  try {
    cvsFiles=scanFileSystem(clientEnvironment);
  }
 catch (  IOException ex) {
    throw new IOCommandException(ex);
  }
  final Requests requests=new Requests(CommandRequest.ANNOTATE,clientEnvironment);
  requests.addArgumentRequest(isUseHeadIfNotFound(),"-f");
  requests.addArgumentRequest(getDate(),"-D");
  requests.addArgumentRequest(getRevisionOrTag(),"-r");
  requests.addArgumentRequest(isAnnotateBinary(),"-F");
  addFileRequests(cvsFiles,requests,clientEnvironment);
  requests.addLocalPathDirectoryRequest();
  addArgumentRequests(requests);
  final ICvsListener parser=new AnnotateMessageParser(eventManager,clientEnvironment.getCvsFileSystem());
  parser.registerListeners(listenerRegistry);
  try {
    return requestProcessor.processRequests(requests,FileStateRequestsProgressHandler.create(progressViewer,cvsFiles));
  }
  finally {
    parser.unregisterListeners(listenerRegistry);
  }
}
