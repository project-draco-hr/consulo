{
  Application application=ApplicationManager.getApplication();
  if (application == null)   return null;
  CharsetSettings settings=CharsetSettings.getInstance();
  if (settings == null)   return null;
  String charsetName=settings.getCharsetName();
  if ("System Default".equals(charsetName))   return getDefaultSystemCharset();
  if (!Charset.isSupported(charsetName))   return getDefaultSystemCharset();
  Charset charset=Charset.forName(charsetName);
  return charset != null ? charset : getDefaultSystemCharset();
}
