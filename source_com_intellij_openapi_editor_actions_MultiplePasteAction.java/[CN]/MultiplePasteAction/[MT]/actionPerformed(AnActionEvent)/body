{
  final DataContext dataContext=e.getDataContext();
  Project project=(Project)dataContext.getData(DataConstants.PROJECT);
  Component focusedComponent=(Component)dataContext.getData(DataConstantsEx.CONTEXT_COMPONENT);
  Editor editor=(Editor)dataContext.getData(DataConstants.EDITOR);
  if (!(focusedComponent instanceof JComponent))   return;
  final ContentChooser<Transferable> chooser=new ContentChooser<Transferable>(project,"Choose Content to Paste",true){
    protected String getStringRepresentationFor(    final Transferable content){
      try {
        return (String)content.getTransferData(DataFlavor.stringFlavor);
      }
 catch (      UnsupportedFlavorException e1) {
        return "";
      }
catch (      IOException e1) {
        return "";
      }
    }
    protected List<Transferable> getContents(){
      return Arrays.asList(CopyPasteManager.getInstance().getAllContents());
    }
    protected void removeContentAt(    final Transferable content){
      ((CopyPasteManagerEx)CopyPasteManager.getInstance()).removeContent(content);
    }
  }
;
  if (chooser.getAllContents().size() > 0) {
    chooser.show();
  }
 else {
    chooser.close(ContentChooser.CANCEL_EXIT_CODE);
  }
  if (chooser.isOK()) {
    final int selectedIndex=chooser.getSelectedIndex();
    ((CopyPasteManagerEx)CopyPasteManager.getInstance()).moveContentTopStackTop(chooser.getAllContents().get(selectedIndex));
    if (editor != null) {
      if (!editor.getDocument().isWritable()) {
        if (!FileDocumentManager.fileForDocumentCheckedOutSuccessfully(editor.getDocument(),project)) {
          return;
        }
      }
      final AnAction pasteAction=ActionManager.getInstance().getAction(IdeActions.ACTION_PASTE);
      AnActionEvent newEvent=new AnActionEvent(e.getInputEvent(),DataManager.getInstance().getDataContext(focusedComponent),e.getPlace(),e.getPresentation(),ActionManager.getInstance(),e.getModifiers());
      pasteAction.actionPerformed(newEvent);
    }
 else {
      final Action pasteAction=((JComponent)focusedComponent).getActionMap().get(DefaultEditorKit.pasteAction);
      if (pasteAction != null) {
        pasteAction.actionPerformed(new ActionEvent(focusedComponent,ActionEvent.ACTION_PERFORMED,""));
      }
    }
  }
}
