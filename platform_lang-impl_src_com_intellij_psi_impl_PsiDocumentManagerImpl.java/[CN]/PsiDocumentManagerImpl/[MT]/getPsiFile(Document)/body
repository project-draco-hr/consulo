{
  final PsiFile userData=document.getUserData(HARD_REF_TO_PSI);
  if (userData != null)   return userData;
  PsiFile psiFile=getCachedPsiFile(document);
  if (psiFile == null) {
    final VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
    if (virtualFile == null || !virtualFile.isValid())     return null;
    psiFile=getPsiFile(virtualFile);
    if (psiFile == null)     return null;
    fireFileCreated(document,psiFile);
  }
  return psiFile;
}
