{
  final PsiFile userData=document.getUserData(HARD_REF_TO_PSI);
  if (userData != null)   return userData;
  PsiFile psiFile=getCachedPsiFile(document);
  if (psiFile != null)   return psiFile;
  final VirtualFile virtualFile=FileDocumentManager.getInstance().getFile(document);
  if (virtualFile == null || !virtualFile.isValid())   return null;
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    Collection<Project> projects=ProjectLocator.getInstance().getProjectsForFile(virtualFile);
    LOG.assertTrue(projects.isEmpty() || projects.contains(myProject),"Trying to get PSI for an alien project. VirtualFile=" + virtualFile + ";\n myProject="+ myProject+ ";\n projects returned: "+ projects);
  }
  psiFile=getPsiFile(virtualFile);
  if (psiFile == null)   return null;
  fireFileCreated(document,psiFile);
  return psiFile;
}
