{
  document.putUserData(TEMP_TREE_IN_DOCUMENT_KEY,null);
  TextBlock textBlock=getTextBlock(document,file);
  if (textBlock.isEmpty())   return false;
  ((DocumentImpl)document).normalizeRangeMarkers();
  myIsCommitInProgress=true;
  try {
    if (mySmartPointerManager != null) {
      SmartPointerManagerImpl.synchronizePointers(file);
    }
    myTreeElementBeingReparsedSoItWontBeCollected=((PsiFileImpl)file).calcTreeElement();
    if (textBlock.isEmpty())     return false;
    textBlock.lock();
    final CharSequence chars=document.getCharsSequence();
    final Boolean data=document.getUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY);
    if (data != null) {
      document.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,null);
      file.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,data);
    }
    final String oldText=ApplicationManagerEx.getApplicationEx().isInternal() && !ApplicationManagerEx.getApplicationEx().isUnitTestMode() ? file.getText() : null;
    int startOffset;
    int endOffset;
    int lengthShift;
    if (file.getViewProvider().supportsIncrementalReparse(file.getLanguage())) {
      startOffset=textBlock.getStartOffset();
      int psiEndOffset=textBlock.getPsiEndOffset();
      endOffset=psiEndOffset;
      lengthShift=textBlock.getTextEndOffset() - psiEndOffset;
    }
 else {
      startOffset=0;
      endOffset=document.getTextLength();
      lengthShift=document.getTextLength() - file.getTextLength();
    }
    myBlockSupport.reparseRange(file,startOffset,endOffset,lengthShift,chars);
    textBlock.unlock();
    textBlock.clear();
    if (file.getTextLength() != document.getTextLength()) {
      if (ApplicationManagerEx.getApplicationEx().isInternal()) {
        throw new AssertionError("commitDocument left PSI inconsistent; file len=" + file.getTextLength() + "; doc len="+ document.getTextLength()+ "; file text="+ file.getText()+ "; doc text="+ document.getText()+ "; old file text="+ oldText);
      }
      throw new AssertionError("commitDocument left PSI inconsistent");
    }
  }
  finally {
    myTreeElementBeingReparsedSoItWontBeCollected=null;
    myIsCommitInProgress=false;
  }
  return true;
}
