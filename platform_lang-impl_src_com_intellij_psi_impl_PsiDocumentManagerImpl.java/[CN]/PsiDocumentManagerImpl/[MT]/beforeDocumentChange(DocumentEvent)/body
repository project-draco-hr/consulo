{
  final Document document=event.getDocument();
  final FileViewProvider provider=getCachedViewProvider(document);
  if (provider == null)   return;
  VirtualFile virtualFile=provider.getVirtualFile();
  if (virtualFile.getFileType().isBinary())   return;
  final List<PsiFile> files=provider.getAllFiles();
  boolean hasLockedBlocks=false;
  for (  PsiFile file : files) {
    if (file == null)     continue;
    if (file.isPhysical() && mySmartPointerManager != null) {
      SmartPointerManagerImpl.fastenBelts(file,event.getOffset());
    }
    final TextBlock textBlock=getTextBlock(document,file);
    if (textBlock.isLocked()) {
      hasLockedBlocks=true;
      continue;
    }
    if (file instanceof PsiFileImpl) {
      myIsCommitInProgress=true;
      try {
        PsiFileImpl psiFile=(PsiFileImpl)file;
        document.putUserData(TEMP_TREE_IN_DOCUMENT_KEY,psiFile.calcTreeElement());
      }
  finally {
        myIsCommitInProgress=false;
      }
    }
  }
  if (!hasLockedBlocks) {
    ((SingleRootFileViewProvider)provider).beforeDocumentChanged();
  }
}
