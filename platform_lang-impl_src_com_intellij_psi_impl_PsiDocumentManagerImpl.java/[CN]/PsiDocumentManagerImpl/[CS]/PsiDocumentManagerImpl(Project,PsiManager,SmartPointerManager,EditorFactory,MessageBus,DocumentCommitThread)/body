{
  myProject=project;
  myPsiManager=psiManager;
  myDocumentCommitThread=documentCommitThread;
  mySmartPointerManager=(SmartPointerManagerImpl)smartPointerManager;
  mySynchronizer=new PsiToDocumentSynchronizer(this,bus);
  myPsiManager.addPsiTreeChangeListener(mySynchronizer);
  editorFactory.getEventMulticaster().addDocumentListener(this,myProject);
  bus.connect().subscribe(AppTopics.FILE_DOCUMENT_SYNC,new FileDocumentManagerAdapter(){
    @Override public void fileContentLoaded(    final VirtualFile virtualFile,    Document document){
      PsiFile psiFile=ApplicationManager.getApplication().runReadAction(new Computable<PsiFile>(){
        public PsiFile compute(){
          return getCachedPsiFile(virtualFile);
        }
      }
);
      fireDocumentCreated(document,psiFile);
    }
  }
);
  ApplicationManager.getApplication().addApplicationListener(new ApplicationAdapter(){
    @Override public void beforeWriteActionStart(    Object action){
      documentCommitThread.disable(action);
    }
    @Override public void writeActionFinished(    Object action){
      documentCommitThread.enable(action);
    }
  }
,myProject);
  documentCommitThread.enable("project open");
}
