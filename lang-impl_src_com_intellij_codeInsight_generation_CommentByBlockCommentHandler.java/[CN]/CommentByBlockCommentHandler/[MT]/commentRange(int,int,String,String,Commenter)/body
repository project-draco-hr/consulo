{
  CharSequence chars=myDocument.getCharsSequence();
  LogicalPosition caretPosition=myEditor.getCaretModel().getLogicalPosition();
  if (startOffset == 0 || chars.charAt(startOffset - 1) == '\n' || chars.charAt(startOffset - 1) == '\r') {
    if (endOffset == myDocument.getTextLength() || chars.charAt(endOffset - 1) == '\n' || chars.charAt(endOffset - 1) == '\r') {
      CodeStyleManager codeStyleManager=CodeStyleManager.getInstance(myProject);
      CodeStyleSettings settings=CodeStyleSettingsManager.getSettings(myProject);
      String space;
      if (!settings.BLOCK_COMMENT_AT_FIRST_COLUMN) {
        final FileType fileType=myFile.getFileType();
        int line1=myEditor.offsetToLogicalPosition(startOffset).line;
        int line2=myEditor.offsetToLogicalPosition(endOffset - 1).line;
        Indent minIndent=CommentUtil.getMinLineIndent(myProject,myDocument,line1,line2,fileType);
        if (minIndent == null) {
          minIndent=codeStyleManager.zeroIndent();
        }
        space=codeStyleManager.fillIndent(minIndent,fileType);
      }
 else {
        space="";
      }
      TextRange range=insertNestedComments(chars,startOffset,endOffset,space + commentPrefix + "\n",space + commentSuffix + "\n",commenter);
      myEditor.getSelectionModel().setSelection(range.getStartOffset(),range.getEndOffset());
      LogicalPosition pos=new LogicalPosition(caretPosition.line + 1,caretPosition.column);
      myEditor.getCaretModel().moveToLogicalPosition(pos);
      myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
      return;
    }
  }
  TextRange range=insertNestedComments(chars,startOffset,endOffset,commentPrefix,commentSuffix,commenter);
  myEditor.getSelectionModel().setSelection(range.getStartOffset(),range.getEndOffset());
  LogicalPosition pos=new LogicalPosition(caretPosition.line,caretPosition.column + commentPrefix.length());
  myEditor.getCaretModel().moveToLogicalPosition(pos);
  myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
}
