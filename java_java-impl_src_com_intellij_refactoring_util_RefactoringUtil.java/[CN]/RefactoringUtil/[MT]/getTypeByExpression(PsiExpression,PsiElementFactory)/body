{
  PsiType type=expr.getType();
  if (type == null) {
    if (expr instanceof PsiArrayInitializerExpression) {
      PsiExpression[] initializers=((PsiArrayInitializerExpression)expr).getInitializers();
      if (initializers.length > 0) {
        PsiType initType=getTypeByExpression(initializers[0]);
        if (initType == null)         return null;
        return initType.createArrayType();
      }
    }
    if (expr instanceof PsiReferenceExpression && PsiUtil.isOnAssignmentLeftHand(expr)) {
      return getTypeByExpression(((PsiAssignmentExpression)expr.getParent()).getRExpression());
    }
    return null;
  }
  PsiClass refClass=PsiUtil.resolveClassInType(type);
  if (refClass instanceof PsiAnonymousClass) {
    type=((PsiAnonymousClass)refClass).getBaseClassType();
  }
  if (PsiType.NULL.equals(type)) {
    ExpectedTypeInfo[] infos=ExpectedTypesProvider.getInstance(expr.getProject()).getExpectedTypes(expr,false);
    if (infos.length == 1) {
      type=infos[0].getType();
    }
 else {
      type=factory.createTypeByFQClassName(CommonClassNames.JAVA_LANG_OBJECT,expr.getResolveScope());
    }
  }
  return GenericsUtil.getVariableTypeByExpressionType(type);
}
