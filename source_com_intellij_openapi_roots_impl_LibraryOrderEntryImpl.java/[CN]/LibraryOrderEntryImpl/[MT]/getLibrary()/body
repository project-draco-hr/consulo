{
  if (myLibraryName == null || !getRootModel().isWritable()) {
    return myLibrary;
  }
  if (ApplicationManager.getApplication().isUnitTestMode())   return myLibrary;
  final Project project=getRootModel().getModule().getProject();
  final ProjectRootConfigurable rootConfigurable=ProjectRootConfigurable.getInstance(project);
  Library library=null;
  if (myLibrary == null) {
    if (myLibraryName != null) {
      library=rootConfigurable.getLibrary(myLibraryLevel);
    }
  }
 else {
    library=rootConfigurable.getLibrary(myLibrary.getTable().getTableLevel());
  }
  if (library != null) {
    return library;
  }
  if (myLibrary != null) {
    myLibraryName=myLibrary.getName();
    myLibraryLevel=myLibrary.getTable().getTableLevel();
  }
  myLibrary=null;
  return null;
}
