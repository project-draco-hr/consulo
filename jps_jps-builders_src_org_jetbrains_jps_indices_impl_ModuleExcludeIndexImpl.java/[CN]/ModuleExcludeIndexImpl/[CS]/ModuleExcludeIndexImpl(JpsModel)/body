{
  final Collection<JpsModule> allModules=model.getProject().getModules();
  for (  final JpsModule module : allModules) {
    final List<File> moduleExcludes=new ArrayList<File>();
    for (    String url : module.getExcludeRootsList().getUrls()) {
      moduleExcludes.add(JpsPathUtil.urlToFile(url));
    }
    JpsJavaModuleExtension moduleExtension=JpsJavaExtensionService.getInstance().getModuleExtension(module);
    if (moduleExtension != null && !moduleExtension.isInheritOutput() && moduleExtension.isExcludeOutput()) {
      String outputUrl=moduleExtension.getOutputUrl();
      if (outputUrl != null) {
        moduleExcludes.add(JpsPathUtil.urlToFile(outputUrl));
      }
      String testOutputUrl=moduleExtension.getTestOutputUrl();
      if (testOutputUrl != null) {
        moduleExcludes.add(JpsPathUtil.urlToFile(testOutputUrl));
      }
    }
    myModuleToExcludesMap.put(module,moduleExcludes);
    myExcludedRoots.addAll(moduleExcludes);
  }
  Map<File,JpsModule> contentToModule=new THashMap<File,JpsModule>(FileUtil.FILE_HASHING_STRATEGY);
  for (  JpsModule module : allModules) {
    for (    String contentUrl : module.getContentRootsList().getUrls()) {
      File contentRoot=JpsPathUtil.urlToFile(contentUrl);
      contentToModule.put(contentRoot,module);
    }
  }
  List<File> parents=new ArrayList<File>();
  for (  JpsModule module : allModules) {
    for (    String contentUrl : module.getContentRootsList().getUrls()) {
      File contentRoot=JpsPathUtil.urlToFile(contentUrl);
      File parent=contentRoot.getParentFile();
      JpsModule parentModule=null;
      parents.clear();
      while (parent != null) {
        parents.add(parent);
        if (contentToModule.containsKey(parent)) {
          parentModule=contentToModule.get(parent);
          break;
        }
        parent=parent.getParentFile();
      }
      if (parentModule != null) {
        myModuleToExcludesMap.get(parentModule).add(contentRoot);
      }
 else {
        myContentRoots.add(contentRoot);
      }
      for (      File file : parents) {
        contentToModule.put(file,parentModule);
      }
    }
  }
  JpsJavaProjectExtension projectExtension=JpsJavaExtensionService.getInstance().getProjectExtension(model.getProject());
  if (projectExtension != null) {
    String url=projectExtension.getOutputUrl();
    if (!StringUtil.isEmpty(url)) {
      File excluded=JpsPathUtil.urlToFile(url);
      File parent=excluded;
      while (parent != null) {
        JpsModule module=contentToModule.get(parent);
        if (module != null) {
          myModuleToExcludesMap.get(module).add(excluded);
        }
        parent=FileUtil.getParentFile(parent);
      }
      myExcludedRoots.add(excluded);
    }
  }
  for (  List<File> files : myModuleToExcludesMap.values()) {
    ((ArrayList<File>)files).trimToSize();
  }
}
