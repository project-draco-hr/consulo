{
  if (myIsRefTypes) {
    if (session.isProperType(myS) && session.isProperType(myT)) {
      if (myT == null || myS == null)       return myS == myT;
      return TypeConversionUtil.isAssignable(myT,myS);
    }
    InferenceVariable inferenceVariable=session.getInferenceVariable(myS);
    if (inferenceVariable != null) {
      inferenceVariable.addBound(myT,InferenceBound.UPPER);
      return true;
    }
    if (PsiType.NULL.equals(myS))     return true;
    inferenceVariable=session.getInferenceVariable(myT);
    if (inferenceVariable != null) {
      inferenceVariable.addBound(myS,InferenceBound.LOWER);
      return true;
    }
    if (myT instanceof PsiArrayType) {
      if (!(myS instanceof PsiArrayType))       return false;
      final PsiType tComponentType=((PsiArrayType)myT).getComponentType();
      final PsiType sComponentType=((PsiArrayType)myS).getComponentType();
      if (!(tComponentType instanceof PsiPrimitiveType) && !(sComponentType instanceof PsiPrimitiveType)) {
        constraints.add(new SubtypingConstraint(tComponentType,sComponentType,true));
        return true;
      }
      return sComponentType instanceof PsiPrimitiveType && sComponentType.equals(tComponentType);
    }
    if (myT instanceof PsiClassType) {
      final PsiClassType.ClassResolveResult TResult=((PsiClassType)myT).resolveGenerics();
      final PsiClass CClass=TResult.getElement();
      if (CClass != null) {
        if (CClass instanceof PsiTypeParameter) {
          if (myS instanceof PsiIntersectionType) {
            for (            PsiType conjunct : ((PsiIntersectionType)myS).getConjuncts()) {
              if (myT.equals(conjunct))               return true;
            }
          }
          return false;
        }
        if (!(myS instanceof PsiClassType))         return false;
        PsiClassType.ClassResolveResult SResult=((PsiClassType)myS).resolveGenerics();
        PsiClass SClass=SResult.getElement();
        final PsiSubstitutor tSubstitutor=TResult.getSubstitutor();
        final PsiSubstitutor sSubstitutor=SClass != null ? TypeConversionUtil.getClassSubstitutor(CClass,SClass,SResult.getSubstitutor()) : null;
        if (sSubstitutor != null) {
          for (          PsiTypeParameter parameter : CClass.getTypeParameters()) {
            final PsiType tSubstituted=tSubstitutor.substitute(parameter);
            final PsiType sSubstituted=sSubstitutor.substituteWithBoundsPromotion(parameter);
            constraints.add(new SubtypingConstraint(tSubstituted,sSubstituted,false));
          }
          return true;
        }
      }
      return false;
    }
    if (myT instanceof PsiIntersectionType) {
      for (      PsiType conjunct : ((PsiIntersectionType)myT).getConjuncts()) {
        constraints.add(new SubtypingConstraint(conjunct,myS,true));
      }
      return true;
    }
    if (PsiType.NULL.equals(myT))     return false;
  }
 else {
    if (myT instanceof PsiWildcardType) {
      final PsiType tBound=((PsiWildcardType)myT).getBound();
      if (tBound == null) {
        return true;
      }
      if (((PsiWildcardType)myT).isExtends()) {
        if (tBound.equalsToText(CommonClassNames.JAVA_LANG_OBJECT)) {
          return true;
        }
        if (myS instanceof PsiWildcardType) {
          final PsiType sBound=((PsiWildcardType)myS).getBound();
          if (sBound != null && ((PsiWildcardType)myS).isExtends()) {
            constraints.add(new SubtypingConstraint(tBound,sBound,true));
            return true;
          }
        }
 else {
          constraints.add(new SubtypingConstraint(tBound,myS,true));
          return true;
        }
        return false;
      }
 else {
        if (myS instanceof PsiCapturedWildcardType) {
          myS=((PsiCapturedWildcardType)myS).getWildcard();
        }
        if (myS instanceof PsiWildcardType) {
          final PsiType sBound=((PsiWildcardType)myS).getBound();
          if (sBound != null && ((PsiWildcardType)myS).isSuper()) {
            constraints.add(new SubtypingConstraint(sBound,tBound,true));
            return true;
          }
        }
 else {
          constraints.add(new SubtypingConstraint(myS,tBound,true));
          return true;
        }
      }
      return false;
    }
 else {
      InferenceVariable inferenceVariable=session.getInferenceVariable(myT);
      if (myS instanceof PsiWildcardType) {
        return inferenceVariable != null && inferenceVariable.isCaptured();
      }
 else {
        if (inferenceVariable != null) {
          inferenceVariable.addBound(myS,InferenceBound.EQ);
          return true;
        }
        inferenceVariable=session.getInferenceVariable(myS);
        if (inferenceVariable != null) {
          inferenceVariable.addBound(myT,InferenceBound.EQ);
          return true;
        }
        constraints.add(new SubtypingConstraint(myT,myS,true));
        return true;
      }
    }
  }
  return true;
}
