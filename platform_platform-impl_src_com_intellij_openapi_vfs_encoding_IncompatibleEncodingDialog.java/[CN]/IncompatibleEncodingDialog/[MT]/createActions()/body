{
  DialogWrapperAction reloadAction=new DialogWrapperAction("Reload"){
    @Override protected void doAction(    ActionEvent e){
      if (safeToReload == EncodingUtil.Magic8.NO_WAY) {
        Pair<Charset,String> detected=EncodingUtil.checkCanReload(virtualFile);
        String failReason=detected.second;
        Charset autoDetected=detected.first;
        int res;
        byte[] bom=virtualFile.getBOM();
        if (bom != null) {
          Messages.showErrorDialog("<html><body>" + "File '" + virtualFile.getName() + "' can't be reloaded in the '"+ charset.displayName()+ "' encoding.<br><br>"+ (failReason == null ? "" : "Why: " + failReason + "<br>")+ (autoDetected == null ? "" : "Detected encoding: '" + autoDetected.displayName() + "'")+ "</body></html>","Incompatible Encoding: " + charset.displayName());
          res=-1;
        }
 else {
          res=Messages.showDialog("<html><body>" + "File '" + virtualFile.getName() + "' most likely isn't stored in the '"+ charset.displayName()+ "' encoding."+ "<br><br>"+ (failReason == null ? "" : "Why: " + failReason + "<br>")+ (autoDetected == null ? "" : "Detected encoding: '" + autoDetected.displayName() + "'")+ "</body></html>","Incompatible Encoding: " + charset.displayName(),new String[]{"Reload anyway","Cancel"},1,AllIcons.General.WarningDialog);
        }
        if (res != 0) {
          doCancelAction();
          return;
        }
      }
      close(RELOAD_EXIT_CODE);
    }
  }
;
  if (!SystemInfo.isMac && safeToReload == EncodingUtil.Magic8.NO_WAY) {
    reloadAction.putValue(Action.SMALL_ICON,AllIcons.General.Warning);
  }
  reloadAction.putValue(Action.MNEMONIC_KEY,(int)'R');
  DialogWrapperAction convertAction=new DialogWrapperAction("Convert"){
    @Override protected void doAction(    ActionEvent e){
      if (safeToConvert == EncodingUtil.Magic8.NO_WAY) {
        String error=EncodingUtil.checkCanConvert(virtualFile);
        int res=Messages.showDialog("<html><body>" + "Please do not convert to '" + charset.displayName() + "'.<br><br>"+ (error == null ? "Encoding '" + charset.displayName() + "' does not support some characters from the text." : error)+ "</body></html>","Incompatible Encoding: " + charset.displayName(),new String[]{"Convert anyway","Cancel"},1,AllIcons.General.WarningDialog);
        if (res != 0) {
          doCancelAction();
          return;
        }
      }
      close(CONVERT_EXIT_CODE);
    }
  }
;
  if (!SystemInfo.isMac && safeToConvert == EncodingUtil.Magic8.NO_WAY) {
    convertAction.putValue(Action.SMALL_ICON,AllIcons.General.Warning);
  }
  convertAction.putValue(Action.MNEMONIC_KEY,(int)'C');
  return new Action[]{reloadAction,convertAction,getCancelAction()};
}
