{
  bus.connect().subscribe(VirtualFileManager.VFS_CHANGES,new BulkFileListener(){
    @Override public void before(    @NotNull final List<? extends VFileEvent> events){
    }
    @Override public void after(    @NotNull final List<? extends VFileEvent> events){
      final List<VirtualFile> rootsToRefresh=new ArrayList<VirtualFile>();
      for (      VFileEvent event : events) {
        if (event.getFileSystem() instanceof LocalFileSystem) {
          String path=event.getPath();
          String[] jarPaths;
synchronized (LOCK) {
            if (jarPathsCache == null) {
              jarPathsCache=new String[myHandlers.size()];
              int i=0;
              for (              String p : myHandlers.keySet()) {
                jarPathsCache[i++]=p.substring(0,p.length() - JAR_SEPARATOR.length());
              }
            }
            jarPaths=jarPathsCache;
          }
          for (          String jarPath : jarPaths) {
            if (FileUtil.startsWith(jarPath,path,SystemInfo.isFileSystemCaseSensitive)) {
              VirtualFile jarRootToRefresh=markDirty(jarPath);
              if (jarRootToRefresh != null) {
                rootsToRefresh.add(jarRootToRefresh);
              }
            }
          }
        }
      }
      if (!rootsToRefresh.isEmpty()) {
        final Application app=ApplicationManager.getApplication();
        Runnable runnable=new Runnable(){
          @Override public void run(){
            if (app.isDisposed())             return;
            for (            VirtualFile root : rootsToRefresh) {
              if (root.isValid()) {
                ((NewVirtualFile)root).markDirtyRecursively();
              }
            }
            VirtualFile[] roots=VfsUtil.toVirtualFileArray(rootsToRefresh);
            RefreshQueue.getInstance().refresh(false,true,null,roots);
          }
        }
;
        if (app.isUnitTestMode()) {
          runnable.run();
        }
 else {
          app.invokeLater(runnable,ModalityState.NON_MODAL);
        }
      }
    }
  }
);
}
