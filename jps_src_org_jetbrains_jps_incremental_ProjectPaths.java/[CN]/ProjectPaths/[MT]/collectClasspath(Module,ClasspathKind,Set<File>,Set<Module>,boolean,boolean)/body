{
  if (!processed.add(module))   return;
  for (  ClasspathItem it : module.getClasspath(kind,exportedOnly)) {
    if (it instanceof Module.ModuleSourceEntry) {
      final Module dep=((Module.ModuleSourceEntry)it).getModule();
      if (!excludeMainModuleOutput && kind.isTestsIncluded()) {
        classpath.add(getModuleOutputDir(dep,true));
      }
      if (!excludeMainModuleOutput || kind.isTestsIncluded()) {
        classpath.add(getModuleOutputDir(dep,false));
      }
    }
 else     if (it instanceof Module) {
      collectClasspath((Module)it,kind,classpath,processed,!kind.isRuntime(),false);
    }
 else {
      addFiles(classpath,it.getClasspathRoots(kind));
    }
  }
}
