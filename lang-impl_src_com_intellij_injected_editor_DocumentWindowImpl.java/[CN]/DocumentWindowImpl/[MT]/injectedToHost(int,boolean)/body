{
  if (offset < myPrefixes[0].length())   return myRelevantRangesInHostDocument[0].getStartOffset();
  int prevEnd=0;
  for (int i=0; i < myRelevantRangesInHostDocument.length; i++) {
    RangeMarker currentRange=myRelevantRangesInHostDocument[i];
    offset-=myPrefixes[i].length();
    int length=currentRange.getEndOffset() - currentRange.getStartOffset();
    if (offset < 0) {
      return preferLeftFragment ? prevEnd : currentRange.getStartOffset() - 1;
    }
 else     if (offset == 0) {
      return preferLeftFragment && i != 0 ? prevEnd : currentRange.getStartOffset();
    }
 else     if (offset < length || offset == length && preferLeftFragment) {
      return currentRange.getStartOffset() + offset;
    }
    offset-=length;
    offset-=mySuffixes[i].length();
    prevEnd=currentRange.getEndOffset();
  }
  return myRelevantRangesInHostDocument[myRelevantRangesInHostDocument.length - 1].getEndOffset();
}
