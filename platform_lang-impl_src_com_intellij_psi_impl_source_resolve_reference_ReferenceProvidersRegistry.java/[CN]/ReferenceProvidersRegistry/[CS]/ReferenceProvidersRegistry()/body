{
  PsiReferenceRegistrarImpl registrar=getRegistrar(Language.ANY);
  for (  final PsiReferenceProviderBean providerBean : PsiReferenceProviderBean.EP_NAME.getExtensions()) {
    final ElementPattern<PsiElement> pattern=providerBean.createElementPattern();
    if (pattern != null) {
      registrar.registerReferenceProvider(pattern,new PsiReferenceProvider(){
        PsiReferenceProvider myProvider;
        @NotNull @Override public PsiReference[] getReferencesByElement(        @NotNull PsiElement element,        @NotNull ProcessingContext context){
          if (myProvider == null) {
            myProvider=providerBean.instantiate();
            if (myProvider == null) {
              myProvider=NULL_REFERENCE_PROVIDER;
            }
          }
          return myProvider.getReferencesByElement(element,context);
        }
      }
);
    }
  }
}
