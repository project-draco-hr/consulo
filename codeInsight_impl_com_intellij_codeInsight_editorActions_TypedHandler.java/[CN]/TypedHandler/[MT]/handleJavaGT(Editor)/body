{
  if (!CodeInsightSettings.getInstance().AUTOINSERT_PAIR_BRACKET)   return false;
  int offset=editor.getCaretModel().getOffset();
  if (offset == editor.getDocument().getTextLength())   return false;
  HighlighterIterator iterator=((EditorEx)editor).getHighlighter().createIterator(offset);
  if (iterator.getTokenType() != JavaTokenType.GT)   return false;
  while (!iterator.atEnd() && !BraceMatchingUtil.isTokenInvalidInsideReference(iterator.getTokenType())) {
    iterator.advance();
  }
  if (iterator.atEnd())   return false;
  if (BraceMatchingUtil.isTokenInvalidInsideReference(iterator.getTokenType()))   iterator.retreat();
  int balance=0;
  while (!iterator.atEnd() && balance >= 0) {
    final IElementType tokenType=iterator.getTokenType();
    if (tokenType == JavaTokenType.LT) {
      balance--;
    }
 else     if (tokenType == JavaTokenType.GT) {
      balance++;
    }
 else     if (BraceMatchingUtil.isTokenInvalidInsideReference(tokenType)) {
      break;
    }
    iterator.retreat();
  }
  if (balance == 0) {
    editor.getCaretModel().moveToOffset(offset + 1);
    editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    return true;
  }
  return false;
}
