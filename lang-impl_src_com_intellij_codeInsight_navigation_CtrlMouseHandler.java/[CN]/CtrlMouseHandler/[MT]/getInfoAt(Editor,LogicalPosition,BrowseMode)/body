{
  Document document=editor.getDocument();
  PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
  if (file == null)   return null;
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  if (TargetElementUtilBase.inVirtualSpace(editor,pos)) {
    return null;
  }
  final int offset=editor.logicalPositionToOffset(pos);
  int selStart=editor.getSelectionModel().getSelectionStart();
  int selEnd=editor.getSelectionModel().getSelectionEnd();
  if (offset >= selStart && offset < selEnd)   return null;
  PsiElement targetElement=null;
  if (browseMode == BrowseMode.TypeDeclaration) {
    try {
      targetElement=GotoTypeDeclarationAction.findSymbolType(editor,offset);
    }
 catch (    IndexNotReadyException e) {
      showDumbModeNotification(myProject);
    }
  }
 else   if (browseMode == BrowseMode.Declaration) {
    PsiReference ref=TargetElementUtilBase.findReference(editor,offset);
    if (ref != null) {
      PsiElement resolvedElement=resolve(ref);
      if (resolvedElement != null) {
        return new InfoSingle(ref,resolvedElement);
      }
    }
    targetElement=GotoDeclarationAction.findTargetElement(myProject,editor,offset);
  }
 else   if (browseMode == BrowseMode.Implementation) {
    final PsiElement element=TargetElementUtilBase.getInstance().findTargetElement(editor,ImplementationSearcher.getFlags(),offset);
    PsiElement[] targetElements=new ImplementationSearcher(){
      @NotNull protected PsiElement[] searchDefinitions(      final PsiElement element){
        final List<PsiElement> found=new ArrayList<PsiElement>(2);
        DefinitionsSearch.search(element).forEach(new Processor<PsiElement>(){
          public boolean process(          final PsiElement psiElement){
            found.add(psiElement);
            return found.size() != 2;
          }
        }
);
        return found.toArray(new PsiElement[found.size()]);
      }
    }
.searchImplementations(editor,element,offset);
    if (targetElements.length > 1) {
      PsiElement elementAtPointer=file.findElementAt(offset);
      if (elementAtPointer != null) {
        return new InfoMultiple(elementAtPointer);
      }
      return null;
    }
    if (targetElements.length == 1) {
      Navigatable descriptor=EditSourceUtil.getDescriptor(targetElements[0]);
      if (descriptor == null || !descriptor.canNavigate()) {
        return null;
      }
      targetElement=targetElements[0];
    }
  }
  if (targetElement != null && targetElement.isPhysical()) {
    PsiElement elementAtPointer=file.findElementAt(offset);
    if (elementAtPointer != null) {
      return new InfoSingle(elementAtPointer,targetElement);
    }
  }
  return null;
}
