{
  if (fileImpl instanceof PsiCodeFragment) {
    FileElement parent=fileImpl.getTreeElement();
    final FileElement holderElement=new DummyHolder(fileImpl.getManager(),fileImpl.getContext()).getTreeElement();
    holderElement.rawAddChildren(fileImpl.createContentLeafElement(holderElement.getCharTable().intern(newFileText,0,newFileText.length())));
    DiffLog diffLog=new DiffLog();
    diffLog.appendReplaceFileElement(parent,(FileElement)holderElement.getFirstChildNode());
    return diffLog;
  }
 else {
    FileViewProvider viewProvider=fileImpl.getViewProvider();
    viewProvider.getLanguages();
    FileType fileType=viewProvider.getVirtualFile().getFileType();
    String fileName=fileImpl.getName();
    final LightVirtualFile lightFile=new LightVirtualFile(fileName,fileType,newFileText,viewProvider.getVirtualFile().getCharset(),fileImpl.getViewProvider().getModificationStamp());
    lightFile.setOriginalFile(viewProvider.getVirtualFile());
    FileViewProvider copy=viewProvider.createCopy(lightFile);
    if (copy.isEventSystemEnabled()) {
      throw new AssertionError("Copied view provider must be non-physical for reparse to deliver correct events: " + viewProvider);
    }
    copy.getLanguages();
    SingleRootFileViewProvider.doNotCheckFileSizeLimit(lightFile);
    PsiFileImpl newFile=getFileCopy(fileImpl,copy);
    newFile.setOriginalFile(fileImpl);
    final FileElement newFileElement=(FileElement)newFile.getNode();
    final FileElement oldFileElement=(FileElement)oldFileNode;
    if (!lastCommittedText.toString().equals(oldFileElement.getText())) {
      throw new IncorrectOperationException(viewProvider.toString());
    }
    DiffLog diffLog=mergeTrees(fileImpl,oldFileElement,newFileElement,indicator,lastCommittedText);
    ((PsiManagerEx)fileImpl.getManager()).getFileManager().setViewProvider(lightFile,null);
    return diffLog;
  }
}
