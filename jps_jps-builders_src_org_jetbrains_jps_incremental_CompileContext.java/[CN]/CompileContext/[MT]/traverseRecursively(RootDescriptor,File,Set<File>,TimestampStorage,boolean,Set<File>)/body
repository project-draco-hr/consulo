{
  if (file.isDirectory()) {
    if (!PathUtil.isUnder(excludes,file)) {
      final File[] children=file.listFiles();
      if (children != null) {
        for (        File child : children) {
          traverseRecursively(rd,child,excludes,tsStorage,forceDirty,currentFiles);
        }
      }
    }
  }
 else {
    boolean markDirty=forceDirty;
    if (!markDirty) {
      markDirty=tsStorage.getStamp(file) != file.lastModified();
    }
    if (markDirty) {
      final TimestampStorage _tsStorage=isProjectRebuild() ? null : tsStorage;
      myFsState.markDirty(file,rd,_tsStorage);
    }
    if (currentFiles != null) {
      currentFiles.add(file);
    }
  }
}
