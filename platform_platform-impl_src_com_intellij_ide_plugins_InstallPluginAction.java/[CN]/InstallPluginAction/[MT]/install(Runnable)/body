{
  IdeaPluginDescriptor[] selection=getPluginTable().getSelectedObjects();
  if (userConfirm(selection)) {
    final ArrayList<PluginNode> list=new ArrayList<PluginNode>();
    final PluginTableModel pluginTableModel=myAvailablePluginPanel.getPluginsModel();
    for (    IdeaPluginDescriptor descr : selection) {
      PluginNode pluginNode=null;
      if (descr instanceof PluginNode) {
        pluginNode=(PluginNode)descr;
      }
 else       if (descr instanceof IdeaPluginDescriptorImpl) {
        final PluginId pluginId=descr.getPluginId();
        pluginNode=new PluginNode(pluginId);
        pluginNode.setName(descr.getName());
        pluginNode.addDependency(descr.getDependentPluginIds());
        pluginNode.addOptionalDependency(descr.getOptionalDependentPluginIds());
        pluginNode.setSize("-1");
      }
      if (pluginNode != null) {
        list.add(pluginNode);
        ourInstallingNodes.add(pluginNode);
      }
      final InstalledPluginsTableModel pluginsModel=(InstalledPluginsTableModel)myInstalledPluginPanel.getPluginsModel();
      final Set<IdeaPluginDescriptor> disabled=new HashSet<IdeaPluginDescriptor>();
      final Set<IdeaPluginDescriptor> disabledDependants=new HashSet<IdeaPluginDescriptor>();
      for (      PluginNode node : list) {
        final PluginId pluginId=node.getPluginId();
        if (pluginsModel.isDisabled(pluginId)) {
          disabled.add(node);
        }
        for (        PluginId dependantId : node.getDependentPluginIds()) {
          final IdeaPluginDescriptor pluginDescriptor=PluginManager.getPlugin(dependantId);
          if (pluginDescriptor != null && pluginsModel.isDisabled(dependantId)) {
            disabledDependants.add(pluginDescriptor);
          }
        }
      }
      if (suggestToEnableInstalledPlugins(pluginsModel,disabled,disabledDependants,list)) {
        myInstalledPluginPanel.setRequireShutdown(true);
      }
    }
    try {
      final Consumer<Set<PluginNode>> onInstallRunnable=new Consumer<Set<PluginNode>>(){
        @Override public void consume(        final Set<PluginNode> pluginNodes){
          UIUtil.invokeLaterIfNeeded(new Runnable(){
            @Override public void run(){
              installedPluginsToModel(pluginNodes);
            }
          }
);
          if (!myInstalledPluginPanel.isDisposed()) {
            UIUtil.invokeLaterIfNeeded(new Runnable(){
              @Override public void run(){
                getPluginTable().updateUI();
                myInstalledPluginPanel.setRequireShutdown(true);
              }
            }
);
          }
 else {
            boolean needToRestart=false;
            for (            PluginNode node : pluginNodes) {
              final IdeaPluginDescriptor pluginDescriptor=PluginManager.getPlugin(node.getPluginId());
              if (pluginDescriptor == null || pluginDescriptor.isEnabled()) {
                needToRestart=true;
                break;
              }
            }
            if (needToRestart) {
              PluginManagerMain.notifyPluginsWereInstalled(pluginNodes,null);
            }
          }
          if (onSuccess != null) {
            onSuccess.run();
          }
        }
      }
;
      downloadPlugins(list,myAvailablePluginPanel.getPluginsModel().getAllPlugins(),onInstallRunnable,new Consumer<Set<PluginNode>>(){
        @Override public void consume(        Set<PluginNode> pluginNodes){
          ourInstallingNodes.removeAll(list);
        }
      }
);
    }
 catch (    final IOException e1) {
      ourInstallingNodes.removeAll(list);
      PluginManagerMain.LOG.error(e1);
      SwingUtilities.invokeLater(new Runnable(){
        @Override public void run(){
          IOExceptionDialog.showErrorDialog(IdeBundle.message("action.download.and.install.plugin"),IdeBundle.message("error.plugin.download.failed"));
        }
      }
);
    }
  }
}
