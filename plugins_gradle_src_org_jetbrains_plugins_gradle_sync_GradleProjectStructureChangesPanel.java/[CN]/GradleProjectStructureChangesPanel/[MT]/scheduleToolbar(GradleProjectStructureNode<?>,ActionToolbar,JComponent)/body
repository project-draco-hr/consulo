{
  if (mySuppressToolbar || node == myNodeWithActiveToolbar || myTree.getSelectionCount() > 1) {
    return;
  }
  myToolbarAppearanceAlarm.cancelAllRequests();
  myToolbarAppearanceAlarm.addRequest(new Runnable(){
    @Override public void run(){
      if (myNodeUnderMouse != node || myTree.getSelectionCount() > 1) {
        return;
      }
      final Point mouseLocation=MouseInfo.getPointerInfo().getLocation();
      SwingUtilities.convertPointFromScreen(mouseLocation,myTree);
      final TreePath path=myTree.getPathForLocation(mouseLocation.x,mouseLocation.y);
      if (path == null && !isUnderMouse(myToolbarComponent)) {
        hideToolbar();
        return;
      }
      Balloon activeToolbar=myToolbar;
      if (activeToolbar instanceof IdeTooltip.Ui && ((IdeTooltip.Ui)(activeToolbar)).isInside(new RelativePoint(myTree,mouseLocation))) {
        return;
      }
      hideToolbar();
      final ActionManagerEx actionManager=ActionManagerEx.getInstanceEx();
      if (!actionManager.isActionPopupStackEmpty()) {
        hideToolbar();
        return;
      }
      toolbar.updateActionsImmediately();
      if (!toolbar.hasVisibleActions()) {
        hideToolbar();
        return;
      }
      final Balloon balloon=GradleUtil.getBalloonBuilder(toolbarComponent,getProject()).setFillColor(myTree.getBackground()).createBalloon();
      Disposer.register(getProject(),balloon);
      Point hintPosition=GradleUtil.getHintPosition(node,myTree);
      if (hintPosition == null) {
        return;
      }
      myToolbarComponent=toolbarComponent;
      myToolbar=balloon;
      myNodeWithActiveToolbar=node;
      balloon.show(new RelativePoint(myTree,hintPosition),Balloon.Position.below);
      startToolbarTracking();
    }
  }
,TOOLTIP_DELAY_MILLIS);
}
