{
  ProgressIndicator progress=ProgressManager.getInstance().getProgressIndicator();
  if (progress != null) {
    progress.pushState();
    progress.setText("Scanning files...");
  }
  myManager.startBatchFilesProcessingMode();
  try {
    PsiFile[] files=myManager.getCacheManager().getFilesWithWord(searcher.getPattern(),occurrenceMask,scope);
    if (progress != null) {
      progress.setText("Searching for " + searcher.getPattern() + "...");
    }
    for (int i=0; i < files.length; i++) {
      ProgressManager.getInstance().checkCanceled();
      PsiFile file=files[i];
      PsiFile[] psiRoots=file.getPsiRoots();
      for (int j=0; j < psiRoots.length; j++) {
        PsiFile psiRoot=psiRoots[j];
        if (!LowLevelSearchUtil.processElementsContainingWordInElement(processor,psiRoot,searcher,elementTypes,progress)) {
          return false;
        }
      }
      if (progress != null) {
        double fraction=(double)i / files.length;
        progress.setFraction(fraction);
      }
      myManager.dropResolveCaches();
    }
  }
  finally {
    if (progress != null) {
      progress.popState();
    }
    myManager.finishBatchFilesProcessingMode();
  }
  return true;
}
