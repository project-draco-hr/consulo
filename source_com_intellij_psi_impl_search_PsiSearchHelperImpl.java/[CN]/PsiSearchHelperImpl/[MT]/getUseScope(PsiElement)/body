{
  final GlobalSearchScope maximalUseScope=myManager.getFileManager().getUseScope(element);
  if (element instanceof PsiPackage) {
    return maximalUseScope;
  }
 else   if (element instanceof PsiClass) {
    if (element instanceof PsiAnonymousClass) {
      return new LocalSearchScope(element);
    }
    PsiFile file=element.getContainingFile();
    if (PsiUtil.isInJspFile(file))     return maximalUseScope;
    PsiClass aClass=(PsiClass)element;
    final PsiClass containingClass=aClass.getContainingClass();
    if (aClass.hasModifierProperty(PsiModifier.PUBLIC)) {
      return containingClass != null ? containingClass.getUseScope() : maximalUseScope;
    }
 else     if (aClass.hasModifierProperty(PsiModifier.PROTECTED)) {
      return containingClass != null ? containingClass.getUseScope() : maximalUseScope;
    }
 else     if (aClass.hasModifierProperty(PsiModifier.PRIVATE) || aClass instanceof PsiTypeParameter) {
      PsiClass topClass=PsiUtil.getTopLevelClass(aClass);
      return new LocalSearchScope(topClass == null ? aClass.getContainingFile() : topClass);
    }
 else {
      PsiPackage aPackage=null;
      if (file instanceof PsiJavaFile) {
        aPackage=element.getManager().findPackage(((PsiJavaFile)file).getPackageName());
      }
      if (aPackage == null) {
        PsiDirectory dir=file.getContainingDirectory();
        if (dir != null) {
          aPackage=dir.getPackage();
        }
      }
      if (aPackage != null) {
        SearchScope scope=GlobalSearchScope.packageScope(aPackage,false);
        scope=scope.intersectWith(maximalUseScope);
        return scope;
      }
      return new LocalSearchScope(file);
    }
  }
 else   if (element instanceof PsiMethod || element instanceof PsiField) {
    PsiMember member=(PsiMember)element;
    PsiFile file=element.getContainingFile();
    if (PsiUtil.isInJspFile(file))     return maximalUseScope;
    PsiClass aClass=member.getContainingClass();
    if (aClass instanceof PsiAnonymousClass) {
      PsiElement methodCallExpr=PsiTreeUtil.getParentOfType(aClass,PsiMethodCallExpression.class);
      return new LocalSearchScope(methodCallExpr != null ? methodCallExpr : aClass);
    }
    if (member.hasModifierProperty(PsiModifier.PUBLIC)) {
      return aClass != null ? aClass.getUseScope() : maximalUseScope;
    }
 else     if (member.hasModifierProperty(PsiModifier.PROTECTED)) {
      return aClass != null ? aClass.getUseScope() : maximalUseScope;
    }
 else     if (member.hasModifierProperty(PsiModifier.PRIVATE)) {
      PsiClass topClass=PsiUtil.getTopLevelClass(member);
      return topClass != null ? new LocalSearchScope(topClass) : new LocalSearchScope(file);
    }
 else {
      PsiPackage aPackage=file instanceof PsiJavaFile ? myManager.findPackage(((PsiJavaFile)file).getPackageName()) : null;
      if (aPackage != null) {
        SearchScope scope=GlobalSearchScope.packageScope(aPackage,false);
        scope=scope.intersectWith(maximalUseScope);
        return scope;
      }
      return maximalUseScope;
    }
  }
 else   if (element instanceof ImplicitVariable) {
    return new LocalSearchScope(((ImplicitVariable)element).getDeclarationScope());
  }
 else   if (element instanceof PsiLocalVariable) {
    PsiElement parent=element.getParent();
    if (parent instanceof PsiDeclarationStatement) {
      return new LocalSearchScope(parent.getParent());
    }
 else {
      return maximalUseScope;
    }
  }
 else   if (element instanceof PsiParameter) {
    return new LocalSearchScope(((PsiParameter)element).getDeclarationScope());
  }
 else   if (element instanceof PsiLabeledStatement) {
    return new LocalSearchScope(element);
  }
 else   if (element instanceof Property) {
    return GlobalSearchScope.allScope(myManager.getProject());
  }
 else {
    return maximalUseScope;
  }
}
