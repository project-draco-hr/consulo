{
  final Project project=dir.getProject();
  final PsiManager psiManager=PsiManager.getInstance(project);
  final ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
  final boolean processGeneratedFiles=isInGeneratedSources(dir.getVirtualFile(),project);
  VfsUtilCore.iterateChildrenRecursively(dir.getVirtualFile(),VirtualFileFilter.ALL,new ContentIterator(){
    @Override @SuppressWarnings({"SimplifiableIfStatement"}) public boolean processFile(    @NotNull final VirtualFile fileOrDir){
      if (!myIncludeTestSource && index.isInTestSourceContent(fileOrDir))       return true;
      if (!processGeneratedFiles && isInGeneratedSources(fileOrDir,project))       return true;
      if (!fileOrDir.isDirectory()) {
        return AnalysisScope.processFile(fileOrDir,visitor,psiManager,needReadAction);
      }
      return true;
    }
  }
);
}
