{
  myFile=file;
  myText=document.getText();
  highlightingTypes=new LinkedHashMap<String,ExpectedHighlightingSet>();
  new WriteCommandAction.Simple(file == null ? null : file.getProject()){
    public void run(){
      highlightingTypes.put(ERROR_MARKER,new ExpectedHighlightingSet(HighlightInfoType.ERROR,HighlightSeverity.ERROR,false,true));
      highlightingTypes.put(WARNING_MARKER,new ExpectedHighlightingSet(HighlightInfoType.WARNING,HighlightSeverity.WARNING,false,checkWarnings));
      highlightingTypes.put(INFORMATION_MARKER,new ExpectedHighlightingSet(HighlightInfoType.WEAK_WARNING,HighlightSeverity.WEAK_WARNING,false,checkWeakWarnings));
      highlightingTypes.put("inject",new ExpectedHighlightingSet(HighlightInfoType.INJECTED_LANGUAGE_FRAGMENT,HighlightInfoType.INJECTED_FRAGMENT_SEVERITY,false,checkInfos));
      highlightingTypes.put(INFO_MARKER,new ExpectedHighlightingSet(HighlightInfoType.TODO,HighlightSeverity.INFORMATION,false,checkInfos));
      for (      SeveritiesProvider provider : Extensions.getExtensions(SeveritiesProvider.EP_NAME)) {
        for (        HighlightInfoType type : provider.getSeveritiesHighlightInfoTypes()) {
          final HighlightSeverity severity=type.getSeverity(null);
          highlightingTypes.put(severity.toString(),new ExpectedHighlightingSet(type,severity,false,true));
        }
      }
      highlightingTypes.put(END_LINE_HIGHLIGHT_MARKER,new ExpectedHighlightingSet(HighlightInfoType.ERROR,HighlightSeverity.ERROR,true,true));
      highlightingTypes.put(END_LINE_WARNING_MARKER,new ExpectedHighlightingSet(HighlightInfoType.WARNING,HighlightSeverity.WARNING,true,checkWarnings));
      initAdditionalHighlightingTypes();
      extractExpectedLineMarkerSet(document);
      extractExpectedHighlightsSet(document);
      refreshLineMarkers();
    }
  }
.execute().throwException();
}
