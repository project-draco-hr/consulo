{
synchronized (myLock) {
    if (fileType != null) {
      File newFile=new File(myLocalFile.getAbsolutePath() + "." + fileType.getDefaultExtension());
      try {
        FileUtil.rename(myLocalFile,newFile);
        myLocalFile=newFile;
      }
 catch (      IOException e) {
        LOG.debug(e);
      }
    }
  }
  VirtualFile localFile=new WriteAction<VirtualFile>(){
    protected void run(    final Result<VirtualFile> result){
      result.setResult(LocalFileSystem.getInstance().refreshAndFindFileByIoFile(myLocalFile));
    }
  }
.execute().getResultObject();
  LOG.debug("Virtual local file: " + localFile);
  FileDownloadingListener[] listeners;
synchronized (myLock) {
    myLocalVirtualFile=localFile;
    myDownloaded=true;
    myErrorMessage=null;
    listeners=myListeners.toArray(new FileDownloadingListener[myListeners.size()]);
  }
  for (  FileDownloadingListener listener : listeners) {
    listener.fileDownloaded(localFile);
  }
}
