{
  if (oldElement == null || newElement != null && newElement.getModuleElements().isEmpty())   return;
  ModuleManager moduleManager=ModuleManager.getInstance(myProject);
  List<Module> modulesToProcess=new ArrayList<Module>();
  List<DisabledAutodetectionInModuleElement> moduleElements=oldElement.getModuleElements();
  for (  DisabledAutodetectionInModuleElement moduleElement : moduleElements) {
    Set<String> files=moduleElement.getFiles();
    if (!files.isEmpty()) {
      for (      String url : files) {
        if (newElement == null || !newElement.isDisabled(moduleElement.getModuleName(),url)) {
          addFile(facetType,url);
        }
      }
    }
 else {
      Module module=moduleManager.findModuleByName(moduleElement.getModuleName());
      if (module != null) {
        modulesToProcess.add(module);
      }
    }
  }
  if (moduleElements.isEmpty()) {
    modulesToProcess.addAll(Arrays.asList(moduleManager.getModules()));
  }
  if (newElement != null) {
    Set<String> toRemove=new THashSet<String>();
    for (    DisabledAutodetectionInModuleElement moduleElement : newElement.getModuleElements()) {
      if (moduleElement.getFiles().isEmpty()) {
        toRemove.add(moduleElement.getModuleName());
      }
    }
    Iterator<Module> iterator=modulesToProcess.iterator();
    while (iterator.hasNext()) {
      Module module=iterator.next();
      if (toRemove.contains(module.getName())) {
        iterator.remove();
      }
    }
  }
  if (!modulesToProcess.isEmpty()) {
    myModulesToProcess.putAll(facetType,modulesToProcess);
  }
}
