{
  final FileChooserDescriptor descriptor=sdkType.getHomeChooserDescriptor();
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    Sdk sdk=SdkTable.getInstance().findMostRecentSdkOfType(sdkType);
    if (sdk == null)     throw new RuntimeException("No SDK of type " + sdkType + " found");
    consumer.consume(sdk.getHomePath());
    return;
  }
  FileChooser.chooseFiles(descriptor,null,getSuggestedSdkPath(sdkType),new Consumer<List<VirtualFile>>(){
    @Override public void consume(    final List<VirtualFile> chosen){
      final String path=chosen.get(0).getPath();
      if (sdkType.isValidSdkHome(path)) {
        consumer.consume(path);
        return;
      }
      final String adjustedPath=sdkType.adjustSelectedSdkHome(path);
      if (sdkType.isValidSdkHome(adjustedPath)) {
        consumer.consume(adjustedPath);
      }
    }
  }
);
}
