{
  Map<String,List<VirtualFile>> cacheMap=includeLibrarySources ? myDirectoriesByPackageNameCacheWithLibSrc : myDirectoriesByPackageNameCache;
  final List<VirtualFile> cachedResult=cacheMap.get(packageName);
  if (cachedResult != null) {
    return cachedResult;
  }
  final ArrayList<VirtualFile> result=ContainerUtil.newArrayList();
  if (StringUtil.isNotEmpty(packageName) && !packageName.startsWith(".")) {
    String parentPackage=StringUtil.getPackageName(packageName);
    String shortName=StringUtil.getShortName(packageName);
    for (    VirtualFile parentDir : getDirectoriesByPackageName(parentPackage,includeLibrarySources)) {
      VirtualFile child=parentDir.findChild(shortName);
      if (isValidPackageDirectory(includeLibrarySources,child) && child.isDirectory() && packageName.equals(getPackageName(child))) {
        result.add(child);
      }
    }
  }
  Collection<VirtualFile> packagePrefixRoots=myPackagePrefixRoots.get(packageName);
  if (!packagePrefixRoots.isEmpty()) {
    for (    VirtualFile file : packagePrefixRoots) {
      if (isValidPackageDirectory(includeLibrarySources,file)) {
        result.add(file);
      }
    }
  }
  if (!result.isEmpty()) {
    cacheMap.put(packageName,result);
  }
  return result;
}
