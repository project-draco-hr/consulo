{
  if (!dir.isValid()) {
    return null;
  }
  if (!dir.isDirectory()) {
    return myRoots.get(dir);
  }
  int count=0;
  for (VirtualFile root=dir; root != null; root=root.getParent()) {
    if (++count > 1000) {
      throw new IllegalStateException("Possible loop in tree");
    }
    final DirectoryInfo info=myRoots.get(root);
    if (info != null) {
      return info;
    }
    Boolean ignored=myIgnoredCache.get(root);
    if (ignored == null) {
      myIgnoredCache.put(root,ignored=isAnyExcludeRoot(root) || FileTypeManager.getInstance().isFileIgnored(root));
    }
    if (ignored.booleanValue()) {
      return null;
    }
  }
  return null;
}
