{
  if (!dir.isValid()) {
    return null;
  }
  if (!dir.isDirectory()) {
    return myRoots.get(dir);
  }
  int count=0;
  for (VirtualFile root=dir; root != null; root=root.getParent()) {
    if (++count > 1000) {
      throw new IllegalStateException("Possible loop in tree, started at " + dir.getName());
    }
    DirectoryInfo info=myInfoCache.get(root);
    if (info != null) {
      if (dir != root) {
        myInfoCache.put(dir,info);
      }
      return info == NULL_INFO ? null : info;
    }
    info=myRoots.get(root);
    if (info != null) {
      myInfoCache.put(dir,info);
      return info;
    }
    if (isAnyExcludeRoot(root) || FileTypeManager.getInstance().isFileIgnored(root)) {
      myInfoCache.put(dir,NULL_INFO);
      return null;
    }
  }
  myInfoCache.put(dir,NULL_INFO);
  return null;
}
