{
  if (!dir.isValid()) {
    return null;
  }
  if (!dir.isDirectory()) {
    DirectoryInfo info=myInfoCache.get(dir);
    return info == NULL_INFO ? null : info;
  }
  int count=0;
  for (VirtualFile root=dir; root != null; root=root.getParent()) {
    if (++count > 1000) {
      throw new IllegalStateException("Possible loop in tree, started at " + dir.getName());
    }
    DirectoryInfo info=myInfoCache.get(root);
    if (info != null) {
      if (dir != root) {
        cacheInfos(dir,root,info);
      }
      return info == NULL_INFO ? null : info;
    }
    if (isIgnored(root)) {
      return cacheInfos(dir,root,null);
    }
  }
  return cacheInfos(dir,null,null);
}
