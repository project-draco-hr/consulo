{
  final RootInfo info=new RootInfo();
  for (  final Module module : ModuleManager.getInstance(project).getModules()) {
    final ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(module);
    for (    final VirtualFile contentRoot : moduleRootManager.getContentRoots()) {
      if (!info.contentRootOf.containsKey(contentRoot)) {
        info.contentRootOf.put(contentRoot,module);
      }
    }
    for (    ContentEntry contentEntry : moduleRootManager.getContentEntries()) {
      for (      VirtualFile excludeRoot : contentEntry.getFolderFiles(ContentFolderScopes.excluded())) {
        info.excludedFromModule.put(excludeRoot,module);
      }
      for (      final ContentFolder sourceFolder : contentEntry.getFolders(ContentFolderScopes.all(false))) {
        final VirtualFile sourceFolderRoot=sourceFolder.getFile();
        if (sourceFolderRoot != null) {
          info.rootTypeId.put(sourceFolderRoot,getRootTypeId(sourceFolder.getType()));
          info.classAndSourceRoots.add(sourceFolderRoot);
          info.sourceRootOf.putValue(sourceFolderRoot,module);
          info.packagePrefix.put(sourceFolderRoot,"");
        }
      }
    }
    for (    OrderEntry orderEntry : moduleRootManager.getOrderEntries()) {
      if (orderEntry instanceof LibraryOrSdkOrderEntry) {
        final LibraryOrSdkOrderEntry entry=(LibraryOrSdkOrderEntry)orderEntry;
        final VirtualFile[] sourceRoots=entry.getRootFiles(OrderRootType.SOURCES);
        final VirtualFile[] classRoots=entry.getRootFiles(OrderRootType.CLASSES);
        for (        final VirtualFile sourceRoot : sourceRoots) {
          info.classAndSourceRoots.add(sourceRoot);
          info.libraryOrSdkSources.add(sourceRoot);
          info.packagePrefix.put(sourceRoot,"");
        }
        for (        final VirtualFile classRoot : classRoots) {
          info.classAndSourceRoots.add(classRoot);
          info.libraryOrSdkClasses.add(classRoot);
          info.packagePrefix.put(classRoot,"");
        }
        if (orderEntry instanceof LibraryOrderEntry) {
          Library library=((LibraryOrderEntry)orderEntry).getLibrary();
          if (library != null) {
            for (            VirtualFile root : ((LibraryEx)library).getExcludedRoots()) {
              info.excludedFromLibraries.putValue(root,library);
            }
            for (            VirtualFile root : sourceRoots) {
              info.sourceOfLibraries.putValue(root,library);
            }
            for (            VirtualFile root : classRoots) {
              info.classOfLibraries.putValue(root,library);
            }
          }
        }
      }
    }
  }
  for (  DirectoryIndexExcludePolicy policy : Extensions.getExtensions(DirectoryIndexExcludePolicy.EP_NAME,project)) {
    Collections.addAll(info.excludedFromProject,policy.getExcludeRootsForProject());
  }
  return info;
}
