{
  Set<Library> librariesToIgnore=ContainerUtil.newHashSet();
  for (  VirtualFile root : hierarchy) {
    librariesToIgnore.addAll(excludedFromLibraries.get(root));
    if (source && libSourceRootEntries.containsKey(root) && (!sourceOfLibraries.containsKey(root) || !librariesToIgnore.containsAll(sourceOfLibraries.get(root)))) {
      return root;
    }
 else     if (!source && libClassRootEntries.containsKey(root) && (!classOfLibraries.containsKey(root) || !librariesToIgnore.containsAll(classOfLibraries.get(root)))) {
      return root;
    }
  }
  return null;
}
