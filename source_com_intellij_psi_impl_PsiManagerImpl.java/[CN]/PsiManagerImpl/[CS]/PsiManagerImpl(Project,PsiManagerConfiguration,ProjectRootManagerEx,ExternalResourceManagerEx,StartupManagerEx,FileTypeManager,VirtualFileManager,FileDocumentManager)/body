{
  myProject=project;
  if (psiManagerConfiguration.REPOSITORY_ENABLED) {
    myRepositoryManager=new RepositoryManagerImpl(this);
  }
 else {
    myRepositoryManager=new EmptyRepository.MyRepositoryManagerImpl();
  }
  myLanguageLevel=projectRootManagerEx.getLanguageLevel();
  boolean isProjectDefault=project.isDefault();
  myFileManager=isProjectDefault ? new EmptyRepository.EmptyFileManager() : new FileManagerImpl(this,fileTypeManager,virtualFileManager,fileDocumentManager,projectRootManagerEx);
  myElementFactory=new PsiElementFactoryImpl(this);
  mySearchHelper=new PsiSearchHelperImpl(this);
  myResolveHelper=new PsiResolveHelperImpl(this);
  final CompositeCacheManager cacheManager=new CompositeCacheManager();
  if (psiManagerConfiguration.REPOSITORY_ENABLED && !isProjectDefault) {
    myShortNamesCache=new PsiShortNamesCacheImpl(this,projectRootManagerEx);
    cacheManager.addCacheManager(new CacheManagerImpl(this));
    myRepositoryElementsManager=new RepositoryElementsManager(this);
  }
 else {
    myShortNamesCache=new EmptyRepository.PsiShortNamesCacheImpl();
    cacheManager.addCacheManager(new EmptyRepository.CacheManagerImpl());
    myRepositoryElementsManager=new EmptyRepository.MyRepositoryElementsManager(this);
  }
  final CacheManager[] managers=myProject.getComponents(CacheManager.class);
  for (  CacheManager manager : managers) {
    cacheManager.addCacheManager(manager);
  }
  myCacheManager=cacheManager;
  myJavadocManager=new JavadocManagerImpl();
  myNameHelper=new PsiNameHelperImpl(this);
  myExternalResourceListener=new MyExternalResourceListener();
  myModificationTracker=new PsiModificationTrackerImpl(this);
  myResolveCache=new ResolveCache(this);
  myCachedValuesManager=new CachedValuesManagerImpl(this);
  myConstantEvaluationHelper=new PsiConstantEvaluationHelperImpl();
  List<PsiElementFinder> elementFinders=new ArrayList<PsiElementFinder>();
  elementFinders.addAll(Arrays.asList(myProject.getComponents(PsiElementFinder.class)));
  elementFinders.add(new PsiElementFinderImpl());
  myElementFinders=elementFinders.toArray(new PsiElementFinder[elementFinders.size()]);
  if (externalResourceManagerEx != null) {
    externalResourceManagerEx.addExteralResourceListener(myExternalResourceListener);
  }
  if (startupManagerEx != null) {
    startupManagerEx.registerPreStartupActivity(new Runnable(){
      public void run(){
        if (!ApplicationManager.getApplication().isUnitTestMode()) {
          myLanguageLevel=projectRootManagerEx.getLanguageLevel();
        }
        runStartupActivity();
      }
    }
);
  }
}
