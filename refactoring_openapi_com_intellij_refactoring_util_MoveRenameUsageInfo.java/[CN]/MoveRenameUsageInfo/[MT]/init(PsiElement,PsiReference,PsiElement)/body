{
  final Project project=element.getProject();
  myReferencedElement=referencedElement;
  if (referencedElement != null) {
    myReferencedElementPointer=SmartPointerManager.getInstance(project).createSmartPsiElementPointer(referencedElement);
  }
  if (reference == null)   reference=element.getReference();
  if (reference == null)   reference=element.getContainingFile().findReferenceAt(element.getTextRange().getStartOffset());
  myReference=reference;
  if (reference != null) {
    Document document=PsiDocumentManager.getInstance(project).getDocument(element.getContainingFile());
    int elementStart=element.getTextRange().getStartOffset();
    myReferenceRangeMarker=document.createRangeMarker(elementStart + reference.getRangeInElement().getStartOffset(),elementStart + reference.getRangeInElement().getEndOffset());
  }
}
