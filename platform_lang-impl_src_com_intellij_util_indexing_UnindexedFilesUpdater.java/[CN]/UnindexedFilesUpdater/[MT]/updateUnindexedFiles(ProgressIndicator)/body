{
  PerformanceWatcher.Snapshot snapshot=PerformanceWatcher.takeSnapshot();
  PushedFilePropertiesUpdater.getInstance(myProject).pushAllPropertiesNow();
  boolean trackResponsiveness=!ApplicationManager.getApplication().isUnitTestMode();
  if (trackResponsiveness)   snapshot.logResponsivenessSinceCreation("Pushing properties");
  indicator.setIndeterminate(true);
  indicator.setText(IdeBundle.message("progress.indexing.scanning"));
  CollectingContentIterator finder=myIndex.createContentIterator(indicator);
  snapshot=PerformanceWatcher.takeSnapshot();
  myIndex.iterateIndexableFilesConcurrently(finder,myProject,indicator);
  myIndex.filesUpdateEnumerationFinished();
  if (trackResponsiveness)   snapshot.logResponsivenessSinceCreation("Indexable file iteration");
  List<VirtualFile> files=finder.getFiles();
  if (myOnStartup && !ApplicationManager.getApplication().isUnitTestMode()) {
    ((StartupManagerImpl)StartupManager.getInstance(myProject)).scheduleInitialVfsRefresh();
  }
  if (files.isEmpty()) {
    return;
  }
  snapshot=PerformanceWatcher.takeSnapshot();
  if (trackResponsiveness)   LOG.info("Unindexed files update started: " + files.size() + " files to update");
  indicator.setIndeterminate(false);
  indicator.setText(IdeBundle.message("progress.indexing.updating"));
  indexFiles(indicator,files);
  if (trackResponsiveness)   snapshot.logResponsivenessSinceCreation("Unindexed files update");
}
