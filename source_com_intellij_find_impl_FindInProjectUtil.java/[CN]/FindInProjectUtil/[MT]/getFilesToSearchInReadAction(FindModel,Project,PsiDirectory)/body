{
  String moduleName=findModel.getModuleName();
  Module module=moduleName == null ? null : ModuleManager.getInstance(project).findModuleByName(moduleName);
  final FileIndex fileIndex=module == null ? ProjectRootManager.getInstance(project).getFileIndex() : ModuleRootManager.getInstance(module).getFileIndex();
  if (psiDirectory == null || findModel.isWithSubdirectories() && fileIndex.isInContent(psiDirectory.getVirtualFile())) {
    final Pattern fileMaskRegExp=createFileMaskRegExp(findModel);
    final Collection<PsiFile> filesForFastWordSearch=getFilesForFastWordSearch(findModel,project,psiDirectory,fileMaskRegExp,module);
    if (filesForFastWordSearch != null && canOptimizeForFastWordSearch(findModel))     return filesForFastWordSearch;
class EnumContentIterator implements ContentIterator {
      List<PsiFile> myFiles=new ArrayList<PsiFile>(filesForFastWordSearch == null ? Collections.<PsiFile>emptyList() : filesForFastWordSearch);
      final PsiManager psiManager=PsiManager.getInstance(project);
      public boolean processFile(      VirtualFile virtualFile){
        if (!virtualFile.isDirectory() && (fileMaskRegExp == null || fileMaskRegExp.matcher(virtualFile.getName()).matches())) {
          final PsiFile psiFile=psiManager.findFile(virtualFile);
          if (psiFile != null && (filesForFastWordSearch == null || !filesForFastWordSearch.contains(psiFile))) {
            myFiles.add(psiFile);
          }
        }
        return true;
      }
      private Collection<PsiFile> getFiles(){
        return myFiles;
      }
    }
    final EnumContentIterator iterator=new EnumContentIterator();
    if (psiDirectory == null) {
      fileIndex.iterateContent(iterator);
    }
 else {
      fileIndex.iterateContentUnderDirectory(psiDirectory.getVirtualFile(),iterator);
    }
    return iterator.getFiles();
  }
 else {
    Collection<PsiFile> fileList=new THashSet<PsiFile>();
    addFilesUnderDirectory(psiDirectory,fileList,findModel.isWithSubdirectories(),createFileMaskRegExp(findModel));
    return fileList;
  }
}
