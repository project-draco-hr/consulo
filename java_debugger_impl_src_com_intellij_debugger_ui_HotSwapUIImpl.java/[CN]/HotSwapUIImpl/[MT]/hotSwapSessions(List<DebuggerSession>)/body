{
  final boolean shouldAskBeforeHotswap=myAskBeforeHotswap;
  myAskBeforeHotswap=true;
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  final String runHotswap=DebuggerSettings.getInstance().RUN_HOTSWAP_AFTER_COMPILE;
  if (shouldAskBeforeHotswap && DebuggerSettings.RUN_HOTSWAP_NEVER.equals(runHotswap)) {
    return;
  }
  final HotSwapProgressImpl findClassesProgress=new HotSwapProgressImpl(myProject);
  ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
    public void run(){
      final Map<DebuggerSession,Map<String,HotSwapFile>> modifiedClasses=getModifiedClasses(findClassesProgress,sessions);
      final Application application=ApplicationManager.getApplication();
      if (modifiedClasses.isEmpty()) {
        final String message=DebuggerBundle.message("status.hotswap.uptodate");
        HotSwapProgressImpl.NOTIFICATION_GROUP.createNotification(message,NotificationType.INFORMATION).notify(myProject);
        return;
      }
      application.invokeLater(new Runnable(){
        public void run(){
          if (shouldAskBeforeHotswap && !DebuggerSettings.RUN_HOTSWAP_ALWAYS.equals(runHotswap)) {
            final RunHotswapDialog dialog=new RunHotswapDialog(myProject,sessions);
            dialog.show();
            if (!dialog.isOK()) {
              return;
            }
            modifiedClasses.keySet().retainAll(dialog.getSessionsToReload());
          }
          if (!modifiedClasses.isEmpty()) {
            final HotSwapProgressImpl progress=new HotSwapProgressImpl(myProject);
            application.executeOnPooledThread(new Runnable(){
              public void run(){
                reloadModifiedClasses(modifiedClasses,progress);
              }
            }
);
          }
        }
      }
,ModalityState.NON_MODAL);
    }
  }
);
}
