{
  myRenamers.clear();
  if (myElement instanceof PsiDirectory) {
    final PsiPackage aPackage=((PsiDirectory)myElement).getPackage();
    final UsageInfo[] usages;
    if (aPackage != null) {
      usages=RenameUtil.findUsages(aPackage,myNewName,mySearchInComments,mySearchInNonJavaFiles);
    }
 else {
      usages=RenameUtil.findUsages(myElement,myNewName,mySearchInComments,mySearchInNonJavaFiles);
    }
    return UsageViewUtil.removeDuplicatedUsages(usages);
  }
  ArrayList<UsageInfo> result=new ArrayList<UsageInfo>();
  for (int i=0; i < myElements.size(); i++) {
    PsiElement element=myElements.get(i);
    final String newName=myNames.get(i);
    final UsageInfo[] usages=RenameUtil.findUsages(element,newName,mySearchInComments,mySearchInNonJavaFiles);
    result.addAll(Arrays.asList(usages));
    if (element instanceof PsiClass && myShouldRenameVariables) {
      myRenamers.add(new AutomaticVariableRenamer((PsiClass)element,newName,Arrays.asList(usages)));
    }
    if (element instanceof PsiClass && myShouldRenameInheritors) {
      if (((PsiClass)element).getName() != null) {
        myRenamers.add(new InheritorRenamer((PsiClass)element,newName));
      }
    }
    if (element instanceof PsiClass && myShouldRenameForms) {
      myRenamers.add(new FormsRenamer((PsiClass)element,newName));
    }
  }
  EjbUsagesUtil.adjustEjbUsages(myElements,myNames,result);
  if (myElement != null) {
    EjbUsagesUtil.adjustEjbUsages(myElement,myNewName,result);
  }
  UsageInfo[] usageInfos=result.toArray(new UsageInfo[result.size()]);
  usageInfos=UsageViewUtil.removeDuplicatedUsages(usageInfos);
  return usageInfos;
}
