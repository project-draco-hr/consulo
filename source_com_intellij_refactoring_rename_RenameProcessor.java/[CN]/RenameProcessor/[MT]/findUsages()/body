{
  myRenamers.clear();
  if (myPrimaryElement instanceof PsiDirectory) {
    final PsiPackage aPackage=((PsiDirectory)myPrimaryElement).getPackage();
    final UsageInfo[] usages;
    if (aPackage != null) {
      usages=RenameUtil.findUsages(aPackage,myNewName,mySearchInComments,mySearchInNonJavaFiles,myAllRenames);
    }
 else {
      usages=RenameUtil.findUsages(myPrimaryElement,myNewName,mySearchInComments,mySearchInNonJavaFiles,myAllRenames);
    }
    return UsageViewUtil.removeDuplicatedUsages(usages);
  }
  ArrayList<UsageInfo> result=new ArrayList<UsageInfo>();
  for (  Map.Entry<PsiElement,String> entry : myAllRenames.entrySet()) {
    PsiElement element=entry.getKey();
    final String newName=entry.getValue();
    final UsageInfo[] usages=RenameUtil.findUsages(element,newName,mySearchInComments,mySearchInNonJavaFiles,myAllRenames);
    result.addAll(Arrays.asList(usages));
    if (element instanceof PsiClass && myShouldRenameVariables) {
      myRenamers.add(new AutomaticVariableRenamer((PsiClass)element,newName,Arrays.asList(usages)));
    }
    if (element instanceof PsiClass && myShouldRenameInheritors) {
      if (((PsiClass)element).getName() != null) {
        myRenamers.add(new InheritorRenamer((PsiClass)element,newName));
      }
    }
    if (element instanceof PsiClass && myShouldRenameForms) {
      myRenamers.add(new FormsRenamer((PsiClass)element,newName));
    }
  }
  EjbUsagesUtil.adjustEjbUsages(myAllRenames,result);
  if (myPrimaryElement != null) {
    EjbUsagesUtil.adjustEjbUsages(myPrimaryElement,myNewName,result);
  }
  UsageInfo[] usageInfos=result.toArray(new UsageInfo[result.size()]);
  usageInfos=UsageViewUtil.removeDuplicatedUsages(usageInfos);
  return usageInfos;
}
