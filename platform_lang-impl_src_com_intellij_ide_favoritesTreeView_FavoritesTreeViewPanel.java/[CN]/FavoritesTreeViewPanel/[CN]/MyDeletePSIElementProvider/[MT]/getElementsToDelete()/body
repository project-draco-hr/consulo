{
  ArrayList<PsiElement> result=new ArrayList<PsiElement>();
  Object[] elements=getSelectedNodeElements();
  for (int idx=0; elements != null && idx < elements.length; idx++) {
    if (elements[idx] instanceof PsiElement) {
      final PsiElement element=(PsiElement)elements[idx];
      result.add(element);
      if (element instanceof PsiDirectory) {
        final VirtualFile virtualFile=((PsiDirectory)element).getVirtualFile();
        final String path=virtualFile.getPath();
        if (path.endsWith(ArchiveFileSystem.ARCHIVE_SEPARATOR)) {
          final VirtualFile vFile=LocalFileSystem.getInstance().findFileByPath(path.substring(0,path.length() - ArchiveFileSystem.ARCHIVE_SEPARATOR.length()));
          if (vFile != null) {
            final PsiFile psiFile=PsiManager.getInstance(myProject).findFile(vFile);
            if (psiFile != null) {
              elements[idx]=psiFile;
            }
          }
        }
      }
    }
  }
  return PsiUtilCore.toPsiElementArray(result);
}
