{
  PsiElement place=initialInfo.getContext();
  final List<GrParametersOwner> scopes=new ArrayList<GrParametersOwner>();
  while (true) {
    final GrParametersOwner parent=PsiTreeUtil.getParentOfType(place,GrMethod.class,GrClosableBlock.class);
    if (parent == null)     break;
    scopes.add(parent);
    place=parent;
  }
  if (scopes.size() == 0) {
    throw new GrRefactoringError(GroovyRefactoringBundle.message("there.is.no.method.or.closure"));
  }
 else   if (scopes.size() == 1 || ApplicationManager.getApplication().isUnitTestMode()) {
    final GrParametersOwner owner=scopes.get(0);
    final PsiElement toSearchFor;
    if (owner instanceof GrMethod) {
      toSearchFor=SuperMethodWarningUtil.checkSuperMethod((PsiMethod)owner,RefactoringBundle.message("to.refactor"));
      if (toSearchFor == null)       return;
    }
 else {
      toSearchFor=MethodOrClosureScopeChooser.findVariableToUse(owner);
    }
    showDialog(new IntroduceParameterInfoImpl(initialInfo,owner,toSearchFor));
  }
 else {
    myEnclosingMethodsPopup=MethodOrClosureScopeChooser.create(scopes,editor,this,new PairFunction<GrParametersOwner,PsiElement,Object>(){
      @Override public Object fun(      GrParametersOwner owner,      PsiElement element){
        showDialog(new IntroduceParameterInfoImpl(initialInfo,owner,element));
        return null;
      }
    }
);
    myEnclosingMethodsPopup.showInBestPositionFor(editor);
  }
}
