{
  final SelectionModel selectionModel=editor.getSelectionModel();
  if (!selectionModel.hasSelection()) {
    final int offset=editor.getCaretModel().getOffset();
    final List<GrExpression> expressions=GrIntroduceHandlerBase.collectExpressions(file,editor,offset);
    if (expressions.isEmpty()) {
      final GrVariable variable=GrIntroduceHandlerBase.findVariableAtCaret(file,editor,offset);
      if (variable == null || variable instanceof GrField || variable instanceof GrParameter) {
        selectionModel.selectLineAtCaret();
      }
 else {
        final TextRange textRange=variable.getTextRange();
        selectionModel.setSelection(textRange.getStartOffset(),textRange.getEndOffset());
      }
    }
 else     if (expressions.size() == 1) {
      final TextRange textRange=expressions.get(0).getTextRange();
      selectionModel.setSelection(textRange.getStartOffset(),textRange.getEndOffset());
    }
 else {
      IntroduceTargetChooser.showChooser(editor,expressions,new Pass<GrExpression>(){
        public void pass(        final GrExpression selectedValue){
          invoke(project,editor,file,selectedValue.getTextRange().getStartOffset(),selectedValue.getTextRange().getEndOffset());
        }
      }
,new Function<GrExpression,String>(){
        @Override public String fun(        GrExpression grExpression){
          return grExpression.getText();
        }
      }
);
      return;
    }
  }
  invoke(project,editor,file,selectionModel.getSelectionStart(),selectionModel.getSelectionEnd());
}
