{
  myWizardContext=context;
  mySequence=sequence;
  Messages.installHyperlinkSupport(myDescriptionPane);
  myFormatPanel=new ProjectFormatPanel();
  myNamePathComponent=initNamePathComponent(context);
  if (context.isCreatingNewProject()) {
    mySettingsPanel.add(myNamePathComponent,BorderLayout.NORTH);
    addExpertPanel(myModulePanel);
  }
 else {
    mySettingsPanel.add(myModulePanel,BorderLayout.NORTH);
  }
  bindModuleSettings();
  myExpertDecorator=new HideableDecorator(myExpertPlaceholder,"Mor&e Settings",false);
  myExpertPanel.setBorder(IdeBorderFactory.createEmptyBorder(0,IdeBorderFactory.TITLED_BORDER_INDENT,5,0));
  myExpertDecorator.setContentComponent(myExpertPanel);
  final RemoteTemplatesFactory factory=new RemoteTemplatesFactory();
  String group=factory.getGroups()[0];
  final DynamicGroupNode dynamicGroupNode=new DynamicGroupNode(new TemplatesGroup(group,null,null),factory);
  SimpleTreeStructure.Impl structure=new SimpleTreeStructure.Impl(new SimpleNode(){
    @Override public SimpleNode[] getChildren(){
      SimpleNode[] nodes=ContainerUtil.map2Array(map.entrySet(),NO_CHILDREN,new Function<Map.Entry<TemplatesGroup,Collection<ProjectTemplate>>,SimpleNode>(){
        @Override public SimpleNode fun(        Map.Entry<TemplatesGroup,Collection<ProjectTemplate>> entry){
          return new GroupNode(entry.getKey(),entry.getValue());
        }
      }
);
      return ArrayUtil.append(nodes,dynamicGroupNode);
    }
  }
){
    @Override public boolean isToBuildChildrenInBackground(    Object element){
      return getDelegate(element) instanceof DynamicGroupNode;
    }
  }
;
  buildMatcher();
  myFilter=new ElementFilter.Active.Impl<SimpleNode>(){
    @Override public boolean shouldBeShowing(    SimpleNode template){
      return template instanceof TemplateNode && matches((TemplateNode)template);
    }
  }
;
  final FilteringTreeStructure filteringTreeStructure=new FilteringTreeStructure(myFilter,structure);
  myTreeBuilder=new FilteringTreeBuilder(myTemplatesTree,myFilter,filteringTreeStructure,new Comparator<NodeDescriptor>(){
    @Override public int compare(    NodeDescriptor o1,    NodeDescriptor o2){
      if (o1 instanceof FilteringTreeStructure.FilteringNode) {
        if (((FilteringTreeStructure.FilteringNode)o1).getDelegate() instanceof GroupNode) {
          String name=((GroupNode)((FilteringTreeStructure.FilteringNode)o1).getDelegate()).getName();
        }
      }
      return AlphaComparator.INSTANCE.compare(o1,o2);
    }
  }
){
    @Override public boolean isAutoExpandNode(    NodeDescriptor nodeDescriptor){
      return myMatchers != null && myMatchers.length > 0;
    }
    @Override protected void runBackgroundLoading(    @NotNull Runnable runnable){
      runnable.run();
    }
    @Override public boolean isToEnsureSelectionOnFocusGained(){
      return false;
    }
  }
;
  myTemplatesTree.setRootVisible(false);
  myTemplatesTree.setShowsRootHandles(false);
  myTemplatesTree.putClientProperty("JTree.lineStyle","None");
  final TreeUI ui=myTemplatesTree.getUI();
  if (ui instanceof WideSelectionTreeUI) {
    ((WideSelectionTreeUI)ui).setForceDontPaintLines();
  }
  myTemplatesTree.setCellRenderer(new NodeRenderer(){
    @Override public void customizeCellRenderer(    JTree tree,    Object value,    boolean selected,    boolean expanded,    boolean leaf,    int row,    boolean hasFocus){
      SimpleNode node=getSimpleNode(value);
      boolean group=node instanceof GroupNode;
      if (node != null) {
        String name=node.getName();
        if (name != null) {
          append(name,group ? SimpleTextAttributes.REGULAR_BOLD_ATTRIBUTES : SimpleTextAttributes.REGULAR_ATTRIBUTES);
        }
        setIcon(node.getIcon());
      }
      setBackground(group ? Color.gray : UIUtil.getTreeBackground());
      setFont(group ? UIUtil.getListFont().deriveFont(Font.BOLD) : UIUtil.getListFont());
      setBorder(group ? BorderFactory.createEmptyBorder(3,3,3,3) : BorderFactory.createEmptyBorder());
    }
  }
);
  myTemplatesTree.getSelectionModel().addTreeSelectionListener(new TreeSelectionListener(){
    @Override public void valueChanged(    TreeSelectionEvent e){
      ProjectTemplate template=getSelectedTemplate();
      myModuleBuilder=template == null ? null : template.createModuleBuilder();
      setupPanels(template);
      mySequence.setType(myModuleBuilder == null ? null : myModuleBuilder.getBuilderId());
      myWizardContext.requestWizardButtonsUpdate();
    }
  }
);
  mySearchField.addDocumentListener(new DocumentAdapter(){
    @Override protected void textChanged(    DocumentEvent e){
      doFilter();
    }
  }
);
  myDescriptionPanel.setVisible(false);
  if (myWizardContext.isCreatingNewProject()) {
    addField("Project \u001bformat:",myFormatPanel.getStorageFormatComboBox(),myModulePanel);
  }
  mySplitter=new JBSplitter(false,0.3f,0.3f,0.6f);
  mySplitter.setSplitterProportionKey("select.template.proportion");
  myLeftPanel.setMinimumSize(new Dimension(200,200));
  mySplitter.setFirstComponent(myLeftPanel);
  mySplitter.setSecondComponent(myRightPanel);
  new AnAction(){
    @Override public void actionPerformed(    AnActionEvent e){
      InputEvent event=e.getInputEvent();
      if (event instanceof KeyEvent) {
        int row=myTemplatesTree.getMaxSelectionRow();
        int toSelect;
switch (((KeyEvent)event).getKeyCode()) {
case KeyEvent.VK_UP:
          toSelect=row == 0 ? myTemplatesTree.getRowCount() - 1 : row - 1;
        myTemplatesTree.setSelectionRow(toSelect);
      myTemplatesTree.scrollRowToVisible(toSelect);
    break;
case KeyEvent.VK_DOWN:
  toSelect=row < myTemplatesTree.getRowCount() - 1 ? row + 1 : 0;
myTemplatesTree.setSelectionRow(toSelect);
myTemplatesTree.scrollRowToVisible(toSelect);
break;
}
}
}
}
.registerCustomShortcutSet(new CustomShortcutSet(KeyEvent.VK_UP,KeyEvent.VK_DOWN),mySearchField);
Runnable runnable=new Runnable(){
@Override public void run(){
myIsTreeUpdating=true;
FilteringTreeStructure.FilteringNode node=filteringTreeStructure.createFilteringNode(dynamicGroupNode);
myTreeBuilder.queueUpdateFrom(node,false);
TreeState state=SelectTemplateSettings.getInstance().getTreeState();
if (state != null && !ApplicationManager.getApplication().isUnitTestMode()) {
state.applyTo(myTemplatesTree,(DefaultMutableTreeNode)myTemplatesTree.getModel().getRoot());
}
 else {
myTreeBuilder.expandAll(new Runnable(){
@Override public void run(){
myTemplatesTree.setSelectionRow(1);
}
}
);
}
}
}
;
if (ApplicationManager.getApplication().isUnitTestMode()) {
SwingUtilities.invokeLater(runnable);
}
 else {
myTreeBuilder.getIntialized().doWhenDone(runnable);
}
}
