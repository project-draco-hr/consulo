{
  final Project project=PlatformDataKeys.PROJECT.getData(context);
  if (project == null)   return null;
  PsiElement[] elements=LangDataKeys.PSI_ELEMENT_ARRAY.getData(context);
  if (elements == null) {
    final PsiElement element=LangDataKeys.PSI_ELEMENT.getData(context);
    if (element != null) {
      elements=new PsiElement[]{element};
    }
  }
  final Collection<AbstractTreeNode> result=new ArrayList<AbstractTreeNode>();
  if (elements != null) {
    for (    PsiElement element : elements) {
      if (element instanceof PsiPackage) {
        final PsiPackage psiPackage=(PsiPackage)element;
        final PsiDirectory[] directories=psiPackage.getDirectories();
        if (directories.length > 0) {
          final VirtualFile firstDir=directories[0].getVirtualFile();
          final boolean isLibraryRoot=ProjectRootsUtil.isLibraryRoot(firstDir,project);
          final PackageElement packageElement=new PackageElement(LangDataKeys.MODULE.getData(context),psiPackage,isLibraryRoot);
          result.add(new PackageElementNode(project,packageElement,viewSettings));
        }
      }
    }
    return result.isEmpty() ? null : result;
  }
 else {
    final String currentViewId=ProjectView.getInstance(project).getCurrentViewId();
    final Module[] modules=LangDataKeys.MODULE_CONTEXT_ARRAY.getData(context);
    if (modules != null) {
      for (      Module module : modules) {
        if (PackageViewPane.ID.equals(currentViewId)) {
          result.add(new PackageViewModuleNode(project,module,viewSettings));
        }
 else {
          result.add(new ProjectViewModuleNode(project,module,viewSettings));
        }
      }
    }
 else {
      final ModuleGroup[] data=ModuleGroup.ARRAY_DATA_KEY.getData(context);
      if (data != null) {
        for (        ModuleGroup moduleGroup : data) {
          if (PackageViewPane.ID.equals(currentViewId)) {
            result.add(new PackageViewModuleGroupNode(project,moduleGroup,viewSettings));
          }
 else {
            result.add(new ProjectViewModuleGroupNode(project,moduleGroup,viewSettings));
          }
        }
      }
    }
  }
  return null;
}
