{
  if (getModule() == null) {
    throw new ExecutionException(DevKitBundle.message("run.configuration.no.module.specified"));
  }
  final ModuleRootManager rootManager=ModuleRootManager.getInstance(getModule());
  final Sdk jdk=rootManager.getSdk();
  if (jdk == null) {
    throw CantRunException.noJdkForModule(getModule());
  }
  final Sdk ideaJdk=IdeaJdk.findIdeaJdk(jdk);
  if (ideaJdk == null) {
    throw new ExecutionException(DevKitBundle.message("jdk.type.incorrect.common"));
  }
  String sandboxHome=((Sandbox)ideaJdk.getSdkAdditionalData()).getSandboxHome();
  if (sandboxHome == null) {
    throw new ExecutionException(DevKitBundle.message("sandbox.no.configured"));
  }
  try {
    sandboxHome=new File(sandboxHome).getCanonicalPath();
  }
 catch (  IOException e) {
    throw new ExecutionException(DevKitBundle.message("sandbox.no.configured"));
  }
  final String canonicalSandbox=sandboxHome;
  IdeaLicenseHelper.copyIDEALicense(sandboxHome,ideaJdk);
  final JavaCommandLineState state=new JavaCommandLineState(env){
    protected JavaParameters createJavaParameters() throws ExecutionException {
      final JavaParameters params=new JavaParameters();
      ParametersList vm=params.getVMParametersList();
      fillParameterList(vm,VM_PARAMETERS);
      fillParameterList(params.getProgramParametersList(),PROGRAM_PARAMETERS);
      Sdk usedIdeaJdk=ideaJdk;
      if (isAlternativeJreEnabled() && !StringUtil.isEmptyOrSpaces(getAlternativeJrePath())) {
        try {
          usedIdeaJdk=(Sdk)usedIdeaJdk.clone();
        }
 catch (        CloneNotSupportedException e) {
          throw new ExecutionException(e.getMessage());
        }
        final SdkModificator sdkToSetUp=usedIdeaJdk.getSdkModificator();
        sdkToSetUp.setHomePath(getAlternativeJrePath());
        sdkToSetUp.commitChanges();
      }
      @NonNls String libPath=usedIdeaJdk.getHomePath() + File.separator + "lib";
      vm.add("-Xbootclasspath/a:" + libPath + File.separator+ "boot.jar");
      vm.defineProperty("idea.config.path",canonicalSandbox + File.separator + "config");
      vm.defineProperty("idea.system.path",canonicalSandbox + File.separator + "system");
      vm.defineProperty("idea.plugins.path",canonicalSandbox + File.separator + "plugins");
      if (SystemInfo.isMac) {
        vm.defineProperty("idea.smooth.progress","false");
        vm.defineProperty("apple.laf.useScreenMenuBar","true");
      }
      if (SystemInfo.isLinux) {
        if (VM_PARAMETERS == null || !VM_PARAMETERS.contains("-Dsun.awt.disablegrab")) {
          vm.defineProperty("sun.awt.disablegrab","true");
        }
      }
      String buildNumber=IdeaJdk.getBuildNumber(usedIdeaJdk.getHomePath());
      if (buildNumber != null) {
        if (buildNumber.startsWith("IC")) {
          vm.defineProperty("idea.platform.prefix","Idea");
        }
 else         if (buildNumber.startsWith("PY")) {
          vm.defineProperty("idea.platform.prefix","Python");
        }
 else         if (buildNumber.startsWith("RM")) {
          vm.defineProperty("idea.platform.prefix","Ruby");
        }
 else         if (buildNumber.startsWith("PS")) {
          vm.defineProperty("idea.platform.prefix","PhpStorm");
        }
 else         if (buildNumber.startsWith("WS")) {
          vm.defineProperty("idea.platform.prefix","WebStorm");
        }
 else         if (buildNumber.startsWith("OC")) {
          vm.defineProperty("idea.platform.prefix","CIDR");
        }
      }
      params.setWorkingDirectory(usedIdeaJdk.getHomePath() + File.separator + "bin"+ File.separator);
      params.setJdk(usedIdeaJdk);
      params.getClassPath().addFirst(libPath + File.separator + "log4j.jar");
      params.getClassPath().addFirst(libPath + File.separator + "jdom.jar");
      params.getClassPath().addFirst(libPath + File.separator + "trove4j.jar");
      params.getClassPath().addFirst(libPath + File.separator + "openapi.jar");
      params.getClassPath().addFirst(libPath + File.separator + "util.jar");
      params.getClassPath().addFirst(libPath + File.separator + "extensions.jar");
      params.getClassPath().addFirst(libPath + File.separator + "bootstrap.jar");
      params.getClassPath().addFirst(libPath + File.separator + "idea.jar");
      params.getClassPath().addFirst(libPath + File.separator + "idea_rt.jar");
      params.getClassPath().addFirst(((JavaSdkType)usedIdeaJdk.getSdkType()).getToolsPath(usedIdeaJdk));
      params.setMainClass("com.intellij.idea.Main");
      return params;
    }
  }
;
  state.setConsoleBuilder(TextConsoleBuilderFactory.getInstance().createBuilder(getProject()));
  return state;
}
