{
  if (oldNode instanceof FileElement && newNode instanceof FileElement) {
    BlockSupportImpl.replaceFileElement(myFile,(FileElement)oldNode,(FileElement)newNode,myPsiManager);
  }
 else {
    final ASTNode parent=oldNode.getTreeParent();
    TreeUtil.ensureParsed(oldNode);
    transformNewChameleon(oldNode,newNode);
    ((TreeElement)newNode).rawRemove();
    ((TreeElement)oldNode).rawReplaceWithList((TreeElement)newNode);
    final ReplaceChangeInfoImpl change=(ReplaceChangeInfoImpl)ChangeInfoImpl.create(ChangeInfo.REPLACE,newNode);
    change.setReplaced(oldNode);
    myEvent.addElementaryChange(newNode,change);
    ((TreeElement)newNode).clearCaches();
    if (!(newNode instanceof FileElement)) {
      ((CompositeElement)newNode.getTreeParent()).subtreeChanged();
    }
    if (DEBUG) {
      DebugUtil.checkTreeStructure(parent);
    }
  }
}
