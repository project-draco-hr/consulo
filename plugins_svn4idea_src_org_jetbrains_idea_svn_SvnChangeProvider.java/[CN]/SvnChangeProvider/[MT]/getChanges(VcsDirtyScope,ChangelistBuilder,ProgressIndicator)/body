{
  try {
    final SVNStatusClient client=myVcs.createStatusClient();
    final List<SvnChangedFile> copiedFiles=new ArrayList<SvnChangedFile>();
    final List<SvnChangedFile> deletedFiles=new ArrayList<SvnChangedFile>();
    for (    FilePath path : dirtyScope.getRecursivelyDirtyDirectories()) {
      processFile(path,client,builder,copiedFiles,deletedFiles,null,true);
    }
    for (    FilePath path : dirtyScope.getDirtyFiles()) {
      FileStatus status=getParentStatus(client,path);
      processFile(path,client,builder,copiedFiles,deletedFiles,status,false);
    }
    for (    SvnChangedFile copiedFile : copiedFiles) {
      boolean foundRename=false;
      final SVNStatus copiedStatus=copiedFile.getStatus();
      for (Iterator<SvnChangedFile> iterator=deletedFiles.iterator(); iterator.hasNext(); ) {
        SvnChangedFile deletedFile=iterator.next();
        final SVNStatus deletedStatus=deletedFile.getStatus();
        if (copiedStatus.getCopyFromURL().equals(deletedStatus.getURL().toString())) {
          builder.processChange(new Change(SvnContentRevision.create(deletedFile.getFilePath(),deletedStatus.getRevision()),CurrentContentRevision.create(copiedFile.getFilePath())));
          iterator.remove();
          foundRename=true;
          break;
        }
      }
      if (!foundRename) {
        File wcPath=guessWorkingCopyPath(copiedStatus.getFile(),copiedStatus.getURL(),copiedStatus.getCopyFromURL());
        SVNStatus status;
        try {
          status=client.doStatus(wcPath,false);
        }
 catch (        SVNException ex) {
          status=null;
        }
        if (status != null && status.getContentsStatus() == SVNStatusType.STATUS_DELETED) {
          final FilePath filePath=myFactory.createFilePathOnDeleted(wcPath,false);
          final SvnContentRevision beforeRevision=SvnContentRevision.create(filePath,status.getRevision());
          final ContentRevision afterRevision=CurrentContentRevision.create(copiedFile.getFilePath());
          builder.processChange(new Change(beforeRevision,afterRevision));
          foundRename=true;
        }
      }
      if (!foundRename) {
        processStatus(copiedFile.getFilePath(),copiedStatus,builder,null);
      }
    }
    for (    SvnChangedFile deletedFile : deletedFiles) {
      processStatus(deletedFile.getFilePath(),deletedFile.getStatus(),builder,null);
    }
  }
 catch (  SVNException e) {
    throw new VcsException(e);
  }
}
