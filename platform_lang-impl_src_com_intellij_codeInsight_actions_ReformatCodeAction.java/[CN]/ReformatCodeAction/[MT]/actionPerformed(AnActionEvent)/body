{
  DataContext dataContext=event.getDataContext();
  final Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    return;
  }
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final Editor editor=PlatformDataKeys.EDITOR.getData(dataContext);
  final VirtualFile[] files=PlatformDataKeys.VIRTUAL_FILE_ARRAY.getData(dataContext);
  if (files == null) {
    return;
  }
  PsiFile file=null;
  final PsiDirectory dir;
  boolean hasSelection=false;
  if (editor != null) {
    file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return;
    dir=file.getContainingDirectory();
    hasSelection=editor.getSelectionModel().hasSelection();
  }
 else   if (areFiles(files)) {
    final ReadonlyStatusHandler.OperationStatus operationStatus=ReadonlyStatusHandler.getInstance(project).ensureFilesWritable(files);
    if (!operationStatus.hasReadonlyFiles()) {
      final ReformatFilesDialog reformatFilesDialog=new ReformatFilesDialog(project);
      reformatFilesDialog.show();
      if (!reformatFilesDialog.isOK())       return;
      if (reformatFilesDialog.optimizeImports() && !DumbService.getInstance(project).isDumb()) {
        new ReformatAndOptimizeImportsProcessor(project,convertToPsiFiles(files,project)).run();
      }
 else {
        new ReformatCodeProcessor(project,convertToPsiFiles(files,project),null).run();
      }
    }
    return;
  }
 else {
    Project projectContext=PlatformDataKeys.PROJECT_CONTEXT.getData(dataContext);
    Module moduleContext=LangDataKeys.MODULE_CONTEXT.getData(dataContext);
    if (projectContext != null || moduleContext != null) {
      final String text;
      if (moduleContext != null) {
        text=CodeInsightBundle.message("process.scope.module",moduleContext.getModuleFilePath());
      }
 else {
        text=CodeInsightBundle.message("process.scope.project",projectContext.getPresentableUrl());
      }
      LayoutProjectCodeDialog dialog=new LayoutProjectCodeDialog(project,CodeInsightBundle.message("process.reformat.code"),text,true);
      dialog.show();
      if (!dialog.isOK())       return;
      if (dialog.isOptimizeImports() && !DumbService.getInstance(project).isDumb()) {
        if (moduleContext != null) {
          new ReformatAndOptimizeImportsProcessor(project,moduleContext).run();
        }
 else {
          new ReformatAndOptimizeImportsProcessor(projectContext).run();
        }
      }
 else {
        if (moduleContext != null) {
          new ReformatCodeProcessor(project,moduleContext).run();
        }
 else {
          new ReformatCodeProcessor(projectContext).run();
        }
      }
      return;
    }
    PsiElement element=LangDataKeys.PSI_ELEMENT.getData(dataContext);
    if (element == null)     return;
    if (element instanceof PsiDirectoryContainer) {
      dir=((PsiDirectoryContainer)element).getDirectories()[0];
    }
 else     if (element instanceof PsiDirectory) {
      dir=(PsiDirectory)element;
    }
 else {
      file=element.getContainingFile();
      if (file == null)       return;
      dir=file.getContainingDirectory();
    }
  }
  boolean optimizeImports=ReformatFilesDialog.isOptmizeImportsOptionOn();
  boolean processWholeFile=false;
  if (EditorSettingsExternalizable.getInstance().getOptions().SHOW_REFORMAT_DIALOG) {
    final LayoutCodeDialog dialog=new LayoutCodeDialog(project,CodeInsightBundle.message("process.reformat.code"),file,dir,hasSelection ? Boolean.TRUE : Boolean.FALSE,HELP_ID);
    dialog.show();
    if (!dialog.isOK())     return;
    EditorSettingsExternalizable.getInstance().getOptions().SHOW_REFORMAT_DIALOG=!dialog.isDoNotAskMe();
    updateShowDialogSetting(dialog,"\"Reformat Code\" dialog disabled");
    optimizeImports=dialog.isOptimizeImports();
    processWholeFile=dialog.isProcessWholeFile();
    if (dialog.isProcessDirectory()) {
      if (optimizeImports) {
        new ReformatAndOptimizeImportsProcessor(project,dir,dialog.isIncludeSubdirectories()).run();
      }
 else {
        new ReformatCodeProcessor(project,dir,dialog.isIncludeSubdirectories()).run();
      }
      return;
    }
  }
  final TextRange range;
  if (!processWholeFile && editor != null && editor.getSelectionModel().hasSelection()) {
    range=new TextRange(editor.getSelectionModel().getSelectionStart(),editor.getSelectionModel().getSelectionEnd());
  }
 else {
    range=null;
  }
  if (optimizeImports && range == null) {
    new ReformatAndOptimizeImportsProcessor(project,file).run();
  }
 else {
    new ReformatCodeProcessor(project,file,range).run();
  }
}
