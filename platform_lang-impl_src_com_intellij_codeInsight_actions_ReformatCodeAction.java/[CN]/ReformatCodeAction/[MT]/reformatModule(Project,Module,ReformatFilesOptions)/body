{
  boolean shouldOptimizeImports=selectedFlags.isOptimizeImports() && !DumbService.getInstance(project).isDumb();
  boolean processOnlyChangedText=selectedFlags.getTextRangeType() == TextRangeType.VCS_CHANGED_TEXT;
  AbstractLayoutCodeProcessor processor;
  if (moduleContext != null)   processor=new ReformatCodeProcessor(project,moduleContext,processOnlyChangedText);
 else   processor=new ReformatCodeProcessor(project,processOnlyChangedText);
  registerScopeFilter(processor,selectedFlags.getSearchScope());
  registerFileMaskFilter(processor,selectedFlags.getFileTypeMask());
  if (shouldOptimizeImports) {
    processor=new OptimizeImportsProcessor(processor);
  }
  if (selectedFlags.isRearrangeCode()) {
    processor=new RearrangeCodeProcessor(processor);
  }
  processor.run();
}
