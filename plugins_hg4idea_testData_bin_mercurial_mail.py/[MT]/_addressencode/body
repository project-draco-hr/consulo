def _addressencode(ui, name, addr, charsets=None):
    name = headencode(ui, name, charsets)
    try:
        (acc, dom) = addr.split('@')
        acc = acc.encode('ascii')
        dom = dom.decode(encoding.encoding).encode('idna')
        addr = ('%s@%s' % (acc, dom))
    except UnicodeDecodeError:
        raise util.Abort((_('invalid email address: %s') % addr))
    except ValueError:
        try:
            addr = addr.encode('ascii')
        except UnicodeDecodeError:
            raise util.Abort((_('invalid local address: %s') % addr))
    return email.Utils.formataddr((name, addr))
