{
  final PsiElementPattern.Capture<PsiElement> everywhere=PlatformPatterns.psiElement();
  extend(CompletionType.BASIC,everywhere,new CompletionProvider<CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet _result){
      final PsiFile file=parameters.getOriginalFile();
      final int startOffset=parameters.getOffset();
      final PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=ApplicationManager.getApplication().runReadAction(new Computable<CompletionData>(){
        public CompletionData compute(){
          return CompletionUtil.getCompletionDataByElement(file);
        }
      }
);
      final CompletionResultSet result=_result.withPrefixMatcher(completionData == null ? CompletionData.findPrefixStatic(insertedElement,startOffset) : completionData.findPrefix(insertedElement,startOffset));
      if (completionData == null) {
        completionData=ApplicationManager.getApplication().runReadAction(new Computable<CompletionData>(){
          public CompletionData compute(){
            return CompletionUtil.getCompletionDataByElement(file);
          }
        }
);
      }
      if (completionData == null)       return;
      final Set<LookupElement> lookupSet=new LinkedHashSet<LookupElement>();
      final PsiReference ref=ApplicationManager.getApplication().runReadAction(new Computable<PsiReference>(){
        public PsiReference compute(){
          return insertedElement.getContainingFile().findReferenceAt(startOffset);
        }
      }
);
      if (ref instanceof PsiMultiReference) {
        for (        final PsiReference reference : completionData.getReferences((PsiMultiReference)ref)) {
          int offsetInElement=startOffset - reference.getElement().getTextRange().getStartOffset();
          final CompletionResultSet resultSet=result.withPrefixMatcher(reference.getElement().getText().substring(reference.getRangeInElement().getStartOffset(),offsetInElement));
          completionData.completeReference(reference,lookupSet,insertedElement,parameters.getOriginalFile(),startOffset);
          for (          final LookupElement item : lookupSet) {
            resultSet.addElement(item);
          }
          lookupSet.clear();
        }
      }
 else       if (ref != null) {
        completionData.completeReference(ref,lookupSet,insertedElement,parameters.getOriginalFile(),startOffset);
      }
      for (      final LookupElement item : lookupSet) {
        result.addElement(item);
      }
      lookupSet.clear();
      final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
      completionData.addKeywordVariants(keywordVariants,insertedElement,parameters.getOriginalFile());
      completionData.completeKeywordsBySet(lookupSet,keywordVariants,insertedElement,result.getPrefixMatcher(),parameters.getOriginalFile());
      for (      final LookupElement item : lookupSet) {
        result.addElement(item);
      }
    }
  }
);
}
