{
  final PsiElementPattern.Capture<PsiElement> everywhere=PlatformPatterns.psiElement();
  extend(CompletionType.BASIC,everywhere,new CompletionProvider<CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet result){
      final PsiFile file=parameters.getOriginalFile();
      final int offsetInFile=parameters.getOffset();
      final int startOffset=offsetInFile;
      final PsiElement lastElement=file.findElementAt(startOffset - 1);
      final PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=ApplicationManager.getApplication().runReadAction(new Computable<CompletionData>(){
        public CompletionData compute(){
          return CompletionUtil.getCompletionDataByElement(lastElement,file,startOffset);
        }
      }
);
      result.setPrefixMatcher(completionData == null ? CompletionData.findPrefixStatic(insertedElement,startOffset) : completionData.findPrefix(insertedElement,startOffset));
      if (completionData == null) {
        completionData=ApplicationManager.getApplication().runReadAction(new Computable<CompletionData>(){
          public CompletionData compute(){
            return CompletionUtil.getCompletionDataByElement(lastElement,file,startOffset);
          }
        }
);
      }
      if (completionData == null)       return;
      final Set<LookupItem> lookupSet=new LinkedHashSet<LookupItem>();
      final PsiReference ref=ApplicationManager.getApplication().runReadAction(new Computable<PsiReference>(){
        public PsiReference compute(){
          return insertedElement.getContainingFile().findReferenceAt(offsetInFile);
        }
      }
);
      if (ref instanceof PsiMultiReference) {
        for (        final PsiReference reference : completionData.getReferences((PsiMultiReference)ref)) {
          int offsetInElement=offsetInFile - reference.getElement().getTextRange().getStartOffset();
          result.setPrefixMatcher(reference.getElement().getText().substring(reference.getRangeInElement().getStartOffset(),offsetInElement));
          completionData.completeReference(reference,lookupSet,insertedElement,parameters.getOriginalFile(),offsetInFile);
          for (          final LookupItem item : lookupSet) {
            result.addElement(item);
          }
          lookupSet.clear();
        }
      }
 else       if (ref != null) {
        completionData.completeReference(ref,lookupSet,insertedElement,parameters.getOriginalFile(),offsetInFile);
      }
      for (      final LookupItem item : lookupSet) {
        result.addElement(item);
      }
      lookupSet.clear();
      final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
      completionData.addKeywordVariants(keywordVariants,insertedElement,parameters.getOriginalFile());
      completionData.completeKeywordsBySet(lookupSet,keywordVariants,insertedElement,result.getPrefixMatcher(),parameters.getOriginalFile());
      for (      final LookupItem item : lookupSet) {
        result.addElement(item);
      }
    }
  }
);
}
