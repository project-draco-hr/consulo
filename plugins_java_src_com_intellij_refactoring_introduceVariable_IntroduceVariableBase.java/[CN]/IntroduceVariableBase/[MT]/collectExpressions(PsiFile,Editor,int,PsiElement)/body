{
  Document document=editor.getDocument();
  CharSequence text=document.getCharsSequence();
  int correctedOffset=offset;
  int textLength=document.getTextLength();
  if (offset >= textLength) {
    correctedOffset=textLength - 1;
  }
 else   if (!Character.isJavaIdentifierPart(text.charAt(offset))) {
    correctedOffset--;
  }
  if (correctedOffset < 0) {
    correctedOffset=offset;
  }
 else   if (!Character.isJavaIdentifierPart(text.charAt(correctedOffset))) {
    if (text.charAt(correctedOffset) == ';') {
      correctedOffset--;
    }
    if (correctedOffset < 0 || text.charAt(correctedOffset) != ')') {
      correctedOffset=offset;
    }
  }
  final PsiElement elementAtCaret=file.findElementAt(correctedOffset);
  final List<PsiExpression> expressions=new ArrayList<PsiExpression>();
  PsiExpression expression=PsiTreeUtil.getParentOfType(elementAtCaret,PsiExpression.class);
  while (expression != null) {
    if (!expressions.contains(expression) && !(expression instanceof PsiParenthesizedExpression) && !(expression instanceof PsiSuperExpression)&& expression.getType() != PsiType.VOID) {
      if (expression instanceof PsiMethodReferenceExpression) {
        expressions.add(expression);
      }
 else       if (!(expression instanceof PsiAssignmentExpression)) {
        if (!(expression instanceof PsiReferenceExpression)) {
          expressions.add(expression);
        }
 else {
          if (!(expression.getParent() instanceof PsiMethodCallExpression)) {
            final PsiElement resolve=((PsiReferenceExpression)expression).resolve();
            if (!(resolve instanceof PsiClass) && !(resolve instanceof PsiPackage)) {
              expressions.add(expression);
            }
          }
        }
      }
    }
    expression=PsiTreeUtil.getParentOfType(expression,PsiExpression.class);
  }
  return expressions;
}
