{
  myUIDisposable=Disposer.newDisposable();
  myTemplatesList=new FileTemplateTabAsList(TEMPLATES_TITLE){
    public void onTemplateSelected(){
      onListSelectionChanged();
    }
  }
;
  myIncludesList=new FileTemplateTabAsList(INCLUDES_TITLE){
    public void onTemplateSelected(){
      onListSelectionChanged();
    }
  }
;
  myCurrentTab=myTemplatesList;
  final List<FileTemplateTab> allTabs=new ArrayList<FileTemplateTab>(Arrays.asList(myTemplatesList,myIncludesList));
  if (FileTemplateManager.getInstance().getAllCodeTemplates().length > 0) {
    myCodeTemplatesList=new FileTemplateTabAsList(CODE_TITLE){
      public void onTemplateSelected(){
        onListSelectionChanged();
      }
    }
;
    allTabs.add(myCodeTemplatesList);
  }
  final Set<FileTemplateGroupDescriptorFactory> factories=new THashSet<FileTemplateGroupDescriptorFactory>();
  ContainerUtil.addAll(factories,ApplicationManager.getApplication().getComponents(FileTemplateGroupDescriptorFactory.class));
  ContainerUtil.addAll(factories,Extensions.getExtensions(FileTemplateGroupDescriptorFactory.EXTENSION_POINT_NAME));
  if (!factories.isEmpty()) {
    myJ2eeTemplatesList=new FileTemplateTabAsTree(J2EE_TITLE){
      public void onTemplateSelected(){
        onListSelectionChanged();
      }
      protected FileTemplateNode initModel(){
        SortedSet<FileTemplateGroupDescriptor> categories=new TreeSet<FileTemplateGroupDescriptor>(new Comparator<FileTemplateGroupDescriptor>(){
          public int compare(          FileTemplateGroupDescriptor o1,          FileTemplateGroupDescriptor o2){
            return o1.getTitle().compareTo(o2.getTitle());
          }
        }
);
        for (        FileTemplateGroupDescriptorFactory templateGroupFactory : factories) {
          ContainerUtil.addIfNotNull(templateGroupFactory.getFileTemplatesDescriptor(),categories);
        }
        return new FileTemplateNode("ROOT",null,ContainerUtil.map2List(categories,new Function<FileTemplateGroupDescriptor,FileTemplateNode>(){
          public FileTemplateNode fun(          FileTemplateGroupDescriptor s){
            return new FileTemplateNode(s);
          }
        }
));
      }
    }
;
    allTabs.add(myJ2eeTemplatesList);
  }
  myTabs=allTabs.toArray(new FileTemplateTab[allTabs.size()]);
  myTabbedPane=new TabbedPaneWrapper(myUIDisposable);
  myTabbedPane.setTabLayoutPolicy(JTabbedPane.SCROLL_TAB_LAYOUT);
  for (  FileTemplateTab tab : myTabs) {
    ToolbarDecorator toolbarDecorator;
    if (tab.getComponent() instanceof JList) {
      toolbarDecorator=ToolbarDecorator.createDecorator((JList)tab.getComponent());
    }
 else     if (tab.getComponent() instanceof JTree) {
      toolbarDecorator=ToolbarDecorator.createDecorator((JTree)tab.getComponent());
    }
 else {
      continue;
    }
    toolbarDecorator.setAddAction(new AnActionButtonRunnable(){
      @Override public void run(      AnActionButton button){
        onAdd();
      }
    }
).setAddActionUpdater(new AnActionButtonUpdater(){
      @Override public boolean isEnabled(      AnActionEvent e){
        return !(myCurrentTab == myCodeTemplatesList || myCurrentTab == myJ2eeTemplatesList);
      }
    }
).setRemoveAction(new AnActionButtonRunnable(){
      @Override public void run(      AnActionButton button){
        onRemove();
      }
    }
).setRemoveActionUpdater(new AnActionButtonUpdater(){
      @Override public boolean isEnabled(      AnActionEvent e){
        FileTemplate selectedItem=myCurrentTab.getSelectedTemplate();
        return selectedItem != null && !isInternalTemplate(selectedItem.getName(),myCurrentTab.getTitle());
      }
    }
).addExtraAction(new AnActionButton(IdeBundle.message("action.copy.template"),PlatformIcons.COPY_ICON){
      @Override public void actionPerformed(      AnActionEvent e){
        onClone();
      }
      @Override public void updateButton(      AnActionEvent e){
        super.updateButton(e);
        if (e.getPresentation().isEnabled()) {
          e.getPresentation().setEnabled(myCurrentTab != myCodeTemplatesList && myCurrentTab != myJ2eeTemplatesList && myCurrentTab.getSelectedTemplate() != null);
        }
      }
    }
).addExtraAction(new AnActionButton(IdeBundle.message("action.reset.to.default"),AllIcons.Actions.Reset){
      @Override public void actionPerformed(      AnActionEvent e){
        onReset();
      }
      @Override public void updateButton(      AnActionEvent e){
        super.updateButton(e);
        if (e.getPresentation().isEnabled()) {
          final FileTemplate selectedItem=myCurrentTab.getSelectedTemplate();
          e.getPresentation().setEnabled(selectedItem instanceof BundledFileTemplate && !selectedItem.isDefault());
        }
      }
    }
);
    toolbarDecorator.disableUpDownActions().setToolbarPosition(ActionToolbarPosition.BOTTOM);
    JPanel panel=toolbarDecorator.createPanel();
    panel.setBorder(null);
    myTabbedPane.addTab(tab.getTitle(),panel);
  }
  myTabbedPane.addChangeListener(new ChangeListener(){
    public void stateChanged(    ChangeEvent e){
      onTabChanged();
    }
  }
);
  myEditor=new FileTemplateConfigurable();
  myEditor.addChangeListener(new ChangeListener(){
    public void stateChanged(    ChangeEvent e){
      onEditorChanged();
    }
  }
);
  myMainPanel=new JPanel(new BorderLayout());
  Splitter splitter=new Splitter();
  JPanel leftPanel=new JPanel(new BorderLayout());
  leftPanel.add(myTabbedPane.getComponent(),BorderLayout.CENTER);
  splitter.setFirstComponent(leftPanel);
  myEditorComponent=myEditor.createComponent();
  splitter.setSecondComponent(myEditorComponent);
  myMainPanel.add(splitter,BorderLayout.CENTER);
  return myMainPanel;
}
