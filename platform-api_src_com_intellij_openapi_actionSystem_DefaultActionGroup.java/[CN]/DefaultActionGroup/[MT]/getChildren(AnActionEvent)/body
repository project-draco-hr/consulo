{
  int sortedSize=mySortedChildren.size();
  AnAction[] children=new AnAction[sortedSize + myPairs.size()];
  for (int i=0; i < sortedSize; i++) {
    children[i]=mySortedChildren.get(i);
  }
  for (int i=0; i < myPairs.size(); i++) {
    children[i + sortedSize]=myPairs.get(i).first;
  }
  outer:   for (int i=0; i < children.length; i++) {
    AnAction action=children[i];
    if (!(action instanceof ActionStub)) {
      continue;
    }
    ActionStub stub=(ActionStub)action;
    ActionManager actionManager=e != null ? e.getActionManager() : ActionManager.getInstance();
    AnAction actualAction=actionManager.getAction(stub.getId());
    replace(stub,actualAction);
    int index=mySortedChildren.indexOf(stub);
    if (index != -1) {
      children[i]=actualAction;
      mySortedChildren.set(index,actualAction);
      continue;
    }
    for (int j=0; j < myPairs.size(); j++) {
      Pair<AnAction,Constraints> pair=myPairs.get(j);
      if (pair.first.equals(stub)) {
        children[i]=actualAction;
        myPairs.set(j,new Pair<AnAction,Constraints>(actualAction,pair.second));
        continue outer;
      }
    }
    throw new IllegalStateException("unknown stub: " + stub.getId());
  }
  return children;
}
