{
  final PsiElement parent=endPositionElement.getParent();
  final PsiVariable cachedCandidate=cache.get(parent);
  if (cachedCandidate != null) {
    return cachedCandidate;
  }
  if (parent != myMethod) {
    final PsiVariable parentResult=getLocalDeclaration(parent);
    if (parentResult != null) {
      return parentResult;
    }
  }
  for (  PsiElement element : parent.getChildren()) {
    if (element == endPositionElement) {
      break;
    }
    if (element instanceof PsiDeclarationStatement) {
      final PsiElement[] declared=((PsiDeclarationStatement)element).getDeclaredElements();
      for (      final PsiElement declaredElement : declared) {
        if (declaredElement instanceof PsiLocalVariable && myTargetType.equals(((PsiLocalVariable)declaredElement).getType())) {
          return goThroughCache(parent,(PsiVariable)declaredElement);
        }
      }
    }
 else     if (element instanceof PsiParameter) {
      if (myTargetType.equals(((PsiParameter)element).getType())) {
        return goThroughCache(parent,(PsiVariable)element);
      }
    }
  }
  return null;
}
