{
  Object moduleContext=dataProvider.getData(DataConstants.MODULE_CONTEXT);
  if (moduleContext != null) {
    return moduleContext;
  }
  Project project=(Project)dataProvider.getData(DataConstants.PROJECT);
  if (project == null) {
    PsiElement element=(PsiElement)dataProvider.getData(DataConstants.PSI_ELEMENT);
    if (element == null || !element.isValid())     return null;
    project=element.getProject();
  }
  final PackageElement packageElement=(PackageElement)dataProvider.getData(DataConstantsEx.PACKAGE_ELEMENT);
  if (packageElement != null) {
    return packageElement.getModule();
  }
  VirtualFile virtualFile=(VirtualFile)dataProvider.getData(DataConstants.VIRTUAL_FILE);
  if (virtualFile == null) {
    GetDataRule dataRule=((DataManagerImpl)DataManager.getInstance()).getDataRule(DataConstants.VIRTUAL_FILE);
    if (dataRule != null) {
      virtualFile=(VirtualFile)dataRule.getData(dataProvider);
    }
  }
  if (virtualFile == null) {
    return null;
  }
  return ModuleUtil.findModuleForFile(virtualFile,project);
}
