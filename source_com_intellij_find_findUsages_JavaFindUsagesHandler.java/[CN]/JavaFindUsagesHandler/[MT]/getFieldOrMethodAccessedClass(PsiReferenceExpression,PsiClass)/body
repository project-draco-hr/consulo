{
  PsiElement[] children=ref.getChildren();
  if (children.length > 1 && children[0] instanceof PsiExpression) {
    PsiExpression expr=(PsiExpression)children[0];
    PsiType type=expr.getType();
    if (type != null) {
      if (!(type instanceof PsiClassType))       return null;
      return PsiUtil.resolveClassInType(type);
    }
 else {
      if (expr instanceof PsiReferenceExpression) {
        PsiElement refElement=((PsiReferenceExpression)expr).resolve();
        if (refElement instanceof PsiClass)         return (PsiClass)refElement;
      }
      return null;
    }
  }
 else {
    PsiManager manager=ref.getManager();
    for (PsiElement parent=ref; parent != null; parent=parent.getParent()) {
      if (parent instanceof PsiClass && (manager.areElementsEquivalent(parent,fieldOrMethodClass) || ((PsiClass)parent).isInheritor(fieldOrMethodClass,true))) {
        return (PsiClass)parent;
      }
    }
  }
  return null;
}
