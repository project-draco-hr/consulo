{
  final TailType defType=LookupItem.getDefaultTailType(context.getCompletionChar());
  if (defType != null) {
    context.setAddCompletionChar(false);
    return defType;
  }
  final PsiExpression enclosing=PsiTreeUtil.getContextOfType(myPosition,PsiExpression.class,true);
  LookupElement item=getDelegate();
  if (enclosing != null && item.getObject() instanceof PsiElement) {
    final PsiType type=getItemType(item);
    final TailType itemType=item instanceof LookupItem ? ((LookupItem)item).getTailType() : TailType.NONE;
    TailType cached=itemType;
    int cachedPrior=0;
    if (type != null && type.isValid()) {
      for (      ExpectedTypeInfo info : myExpectedTypeInfos) {
        final PsiType infoType=info.getType();
        if (PsiType.VOID.equals(infoType)) {
          cached=info.getTailType();
          continue;
        }
        if (infoType.equals(type) && cachedPrior < 2) {
          cachedPrior=2;
          cached=info.getTailType();
        }
 else         if (cachedPrior == 2 && cached != info.getTailType()) {
          cachedPrior=3;
          cached=itemType;
        }
 else         if (((infoType.isAssignableFrom(type) && info.getKind() == ExpectedTypeInfo.TYPE_OR_SUBTYPE) || (type.isAssignableFrom(infoType) && info.getKind() == ExpectedTypeInfo.TYPE_OR_SUPERTYPE)) && cachedPrior < 1) {
          cachedPrior=1;
          cached=info.getTailType();
        }
 else         if (cachedPrior == 1 && cached != info.getTailType()) {
          cached=itemType;
        }
      }
    }
 else {
      if (myExpectedTypeInfos.size() == 1) {
        cached=myExpectedTypeInfos.iterator().next().getTailType();
      }
    }
    return cached;
  }
  return null;
}
