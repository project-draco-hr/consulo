{
  final ChangeListManager changeListManager=ChangeListManagerImpl.getInstance(myProject);
  final Runnable notifier=changeListManager.prepareForChangeDeletion(changes);
  final Runnable afterRefresh=new Runnable(){
    public void run(){
      changeListManager.invokeAfterUpdate(new Runnable(){
        public void run(){
          notifier.run();
          if (afterVcsRefreshInAwt != null) {
            afterVcsRefreshInAwt.run();
          }
        }
      }
,InvokeAfterUpdateMode.SILENT,"Refresh change lists after update",ModalityState.current());
    }
  }
;
  Runnable rollbackAction=new MyRollbackRunnable(changes,deleteLocallyAddedFiles,afterRefresh,localHistoryActionName);
  if (ApplicationManager.getApplication().isDispatchThread()) {
    ProgressManager.getInstance().runProcessWithProgressSynchronously(rollbackAction,VcsBundle.message("changes.action.rollback.text"),true,myProject);
  }
 else {
    rollbackAction.run();
  }
  ((ChangeListManagerImpl)changeListManager).showLocalChangesInvalidated();
}
