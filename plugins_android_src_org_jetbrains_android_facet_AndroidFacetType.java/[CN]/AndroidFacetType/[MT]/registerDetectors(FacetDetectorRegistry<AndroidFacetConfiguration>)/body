{
  FacetDetector<VirtualFile,AndroidFacetConfiguration> detector=new FacetDetector<VirtualFile,AndroidFacetConfiguration>(){
    public AndroidFacetConfiguration detectFacet(    VirtualFile source,    Collection<AndroidFacetConfiguration> existentFacetConfigurations){
      if (!existentFacetConfigurations.isEmpty()) {
        return existentFacetConfigurations.iterator().next();
      }
      return createDefaultConfiguration();
    }
    @Override public void afterFacetAdded(    @NotNull final Facet facet){
      if (facet instanceof AndroidFacet) {
        final Project project=facet.getModule().getProject();
        StartupManager.getInstance(project).runWhenProjectIsInitialized(new Runnable(){
          public void run(){
            final Module module=facet.getModule();
            setupAndroidPlatformInNeccessary(module);
            final AndroidFacet androidFacet=(AndroidFacet)facet;
            final String androidLibraryPropValue=getPropertyValue(module,SdkConstants.FN_DEFAULT_PROPERTIES,"android.library");
            if (androidLibraryPropValue != null && androidLibraryPropValue.equals("true")) {
              androidFacet.getConfiguration().LIBRARY_PROJECT=true;
            }
            Manifest manifest=androidFacet.getManifest();
            if (manifest != null) {
              if (AndroidUtils.getDefaultActivityName(manifest) != null) {
                AndroidUtils.addRunConfiguration(project,androidFacet,null,true);
              }
            }
            ApplicationManager.getApplication().saveAll();
          }
        }
);
      }
    }
  }
;
  VirtualFileFilter androidManifestFilter=new VirtualFileFilter(){
    public boolean accept(    VirtualFile file){
      return file.getName().equals(SdkConstants.FN_ANDROID_MANIFEST_XML);
    }
  }
;
  detectorRegistry.registerUniversalDetector(StdFileTypes.XML,androidManifestFilter,detector);
}
