{
  IdeFocusManager instance=null;
  if (context != null) {
    instance=getInstanceSafe(PlatformDataKeys.PROJECT.getData(context));
  }
  if (instance == null) {
    final Component focusOwner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getActiveWindow();
    final Component parent=UIUtil.findUltimateParent(focusOwner);
    if (parent instanceof IdeFrame) {
      instance=getInstanceSafe(((IdeFrame)parent).getProject());
    }
  }
  if (instance == null) {
    instance=PassThroughtIdeFocusManager.getInstance();
  }
  return instance;
}
