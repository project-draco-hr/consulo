{
  List<ModifiableRootModel> usingModels=new SmartList<ModifiableRootModel>();
  Project project=toRemove.getProject();
  ModuleManager moduleManager=ModuleManager.getInstance(project);
  for (  Module module : moduleManager.getModules()) {
    if (module == toRemove) {
      continue;
    }
    ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(module);
    for (    OrderEntry entry : moduleRootManager.getOrderEntries()) {
      if (entry instanceof ModuleOrderEntry && toRemove == ((ModuleOrderEntry)entry).getModule()) {
        usingModels.add(moduleRootManager.getModifiableModel());
        break;
      }
    }
  }
  final ModifiableModuleModel moduleModel=moduleManager.getModifiableModel();
  ModuleDeleteProvider.removeModule(toRemove,null,usingModels,moduleModel);
  ProjectRootManager.getInstance(project).multiCommit(moduleModel,usingModels.toArray(new ModifiableRootModel[usingModels.size()]));
}
