{
  for (  final VirtualFile appRoot : ModuleRootManager.getInstance(structure.myModule).getContentRoots()) {
    appRoot.refresh(false,false);
  }
  List<Consumer<ModifiableRootModel>> actions=ContainerUtil.newArrayList();
  removeInvalidSourceRoots(actions,structure);
  cleanupDefaultLibrary(structure.myModule,actions,appRoots,structure.getUserLibraryName());
  moveupLibrariesFromMavenPlugin(structure.myModule,actions);
  List<VirtualFile> rootsToFacetSetup=new ArrayList<VirtualFile>(appRoots.size());
  for (  VirtualFile appRoot : appRoots) {
    if (checkValidity(appRoot)) {
      ContainerUtil.addIfNotNull(addSourceRootsAndLibDirectory(appRoot,structure),actions);
      rootsToFacetSetup.add(appRoot);
    }
  }
  List<Runnable> facetActions=new ArrayList<Runnable>();
  structure.setupFacets(facetActions,rootsToFacetSetup);
  for (  final Runnable action : facetActions) {
    actions.add(new Consumer<ModifiableRootModel>(){
      @Override public void consume(      ModifiableRootModel model){
        action.run();
      }
    }
);
  }
  return actions;
}
