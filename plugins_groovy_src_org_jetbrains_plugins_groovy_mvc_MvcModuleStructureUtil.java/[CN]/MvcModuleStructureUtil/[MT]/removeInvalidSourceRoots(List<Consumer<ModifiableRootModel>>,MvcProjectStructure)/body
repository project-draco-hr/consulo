{
  final Set<SourceFolder> toRemove=CollectionFactory.troveSet();
  final Set<ContentEntry> toRemoveContent=CollectionFactory.troveSet();
  for (  ContentEntry entry : ModuleRootManager.getInstance(structure.myModule).getContentEntries()) {
    final VirtualFile file=entry.getFile();
    if (file == null || !structure.isValidContentRoot(file)) {
      toRemoveContent.add(entry);
    }
    for (    SourceFolder folder : entry.getSourceFolders()) {
      if (folder.getFile() == null) {
        toRemove.add(folder);
      }
    }
  }
  if (!toRemove.isEmpty() || !toRemoveContent.isEmpty()) {
    actions.add(new Consumer<ModifiableRootModel>(){
      public void consume(      ModifiableRootModel model){
        for (        final ContentEntry entry : toRemoveContent) {
          model.removeContentEntry(entry);
        }
        for (        ContentEntry entry : model.getContentEntries()) {
          for (          SourceFolder folder : entry.getSourceFolders()) {
            if (toRemove.remove(folder)) {
              entry.removeSourceFolder(folder);
            }
          }
        }
      }
    }
);
  }
}
