{
  checkAdd(element);
  if (element instanceof PsiDirectory) {
    LOG.error("not implemented");
    return null;
  }
 else   if (element instanceof PsiFile) {
    PsiFile originalFile=(PsiFile)element;
    try {
      VirtualFile newVFile;
      final PsiDocumentManager psiDocumentManager=PsiDocumentManager.getInstance(myManager.getProject());
      if (originalFile instanceof PsiFileImpl) {
        newVFile=myFile.createChildData(myManager,originalFile.getName());
        String text=originalFile.getText();
        final PsiFile psiFile=getManager().findFile(newVFile);
        final Document document=psiFile == null ? null : psiDocumentManager.getDocument(psiFile);
        final FileDocumentManager fileDocumentManager=FileDocumentManager.getInstance();
        if (document != null) {
          document.setText(text);
          fileDocumentManager.saveDocument(document);
        }
 else {
          String lineSeparator=fileDocumentManager.getLineSeparator(newVFile,getProject());
          if (!lineSeparator.equals("\n")) {
            text=StringUtil.convertLineSeparators(text,lineSeparator);
          }
          LoadTextUtil.write(getProject(),newVFile,myManager,text,-1);
        }
      }
 else {
        byte[] storedContents=((PsiBinaryFileImpl)originalFile).getStoredContents();
        if (storedContents != null) {
          newVFile=myFile.createChildData(myManager,originalFile.getName());
          newVFile.setBinaryContent(storedContents);
        }
 else {
          newVFile=VfsUtilCore.copyFile(null,originalFile.getVirtualFile(),myFile);
        }
      }
      psiDocumentManager.commitAllDocuments();
      PsiFile newFile=myManager.findFile(newVFile);
      updateAddedFile(newFile);
      return newFile;
    }
 catch (    IOException e) {
      throw new IncorrectOperationException(e.toString(),e);
    }
  }
 else {
    for (    PsiDirectoryMethodProxy proxy : PsiDirectoryMethodProxy.EP_NAME.getExtensions()) {
      PsiElement add=proxy.add(this,element);
      if (add != null) {
        return add;
      }
    }
    LOG.assertTrue(false);
    return null;
  }
}
