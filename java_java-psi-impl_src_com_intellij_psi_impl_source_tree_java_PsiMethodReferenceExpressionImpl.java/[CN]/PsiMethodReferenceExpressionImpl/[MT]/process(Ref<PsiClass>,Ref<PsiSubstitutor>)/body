{
  PsiClass containingClass=null;
  final PsiExpression expression=getQualifierExpression();
  PsiSubstitutor substitutor=PsiSubstitutor.EMPTY;
  if (expression != null) {
    PsiClassType.ClassResolveResult result=PsiUtil.resolveGenericsClassInType(expression.getType());
    containingClass=result.getElement();
    if (containingClass != null) {
      substitutor=result.getSubstitutor();
    }
    if (containingClass == null && expression instanceof PsiReferenceExpression) {
      final PsiElement resolve=((PsiReferenceExpression)expression).resolve();
      if (resolve instanceof PsiClass) {
        containingClass=(PsiClass)resolve;
      }
    }
  }
 else {
    final PsiTypeElement typeElement=getQualifierType();
    if (typeElement != null) {
      PsiClassType.ClassResolveResult result=PsiUtil.resolveGenericsClassInType(typeElement.getType());
      containingClass=result.getElement();
      if (containingClass != null) {
        substitutor=result.getSubstitutor();
      }
    }
  }
  psiClassRef.set(containingClass);
  substRef.set(substitutor);
}
