{
  PsiClass containingClass=null;
  PsiSubstitutor substitutor=PsiSubstitutor.EMPTY;
  try {
    final PsiExpression expression=getQualifierExpression();
    if (expression != null) {
      PsiClassType.ClassResolveResult result=PsiUtil.resolveGenericsClassInType(expression.getType());
      containingClass=result.getElement();
      if (containingClass != null) {
        substitutor=result.getSubstitutor();
      }
      if (containingClass == null && expression instanceof PsiReferenceExpression) {
        final JavaResolveResult resolveResult=((PsiReferenceExpression)expression).advancedResolve(false);
        final PsiElement resolve=resolveResult.getElement();
        if (resolve instanceof PsiClass) {
          containingClass=(PsiClass)resolve;
          substitutor=resolveResult.getSubstitutor();
          return true;
        }
      }
    }
 else {
      final PsiTypeElement typeElement=getQualifierType();
      if (typeElement != null) {
        PsiClassType.ClassResolveResult result=PsiUtil.resolveGenericsClassInType(typeElement.getType());
        containingClass=result.getElement();
        if (containingClass != null) {
          substitutor=result.getSubstitutor();
        }
      }
    }
    return false;
  }
  finally {
    psiClassRef.set(containingClass);
    substRef.set(substitutor);
  }
}
