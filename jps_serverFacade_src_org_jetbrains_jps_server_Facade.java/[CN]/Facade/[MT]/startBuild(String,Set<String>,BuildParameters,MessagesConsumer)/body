{
  ProjectWrapper pw=myProjects.get(projectPath);
  if (pw == null) {
    pw=ProjectWrapper.load(new GantBinding(),projectPath,getStartupScript(),myPathVariables,true);
    myProjects.put(projectPath,pw);
  }
  configureProject(pw,params,consumer);
  List<Module> toCompile=null;
  if (modules != null && modules.size() > 0) {
    for (    Module m : pw.getProject().getModules().values()) {
      if (modules.contains(m.getName())) {
        if (toCompile == null) {
          toCompile=new ArrayList<Module>();
        }
        toCompile.add(m);
      }
    }
  }
switch (params.buildType) {
case REBUILD:
    if (toCompile == null || toCompile.isEmpty()) {
      pw.rebuild();
    }
 else {
      pw.makeModules(toCompile,new ProjectWrapper.Flags(){
        public boolean tests(){
          return true;
        }
        public boolean incremental(){
          return false;
        }
        public boolean force(){
          return true;
        }
        public PrintStream logStream(){
          return null;
        }
      }
);
    }
  break;
case MAKE:
pw.makeModules(toCompile,new ProjectWrapper.Flags(){
  public boolean tests(){
    return true;
  }
  public boolean incremental(){
    return true;
  }
  public boolean force(){
    return false;
  }
  public PrintStream logStream(){
    return null;
  }
}
);
break;
case CLEAN:
pw.clean();
break;
}
pw.save();
}
