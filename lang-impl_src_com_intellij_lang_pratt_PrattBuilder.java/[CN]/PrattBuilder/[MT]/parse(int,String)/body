{
  IElementType tokenType=getTokenType();
  if (tokenType == null)   return null;
  if (!(tokenType instanceof PrattTokenType) || ((PrattTokenType)tokenType).getPriority() <= rightPriority) {
    error(expectedMessage != null ? expectedMessage : JavaErrorMessages.message("unexpected.token"));
    return null;
  }
  final Nud nud=((PrattTokenType)tokenType).getNud();
  if (nud == null) {
    error(expectedMessage != null ? expectedMessage : JavaErrorMessages.message("unexpected.token"));
    return null;
  }
  PsiBuilder.Marker marker=myBuilder.mark();
  ParseResult left;
  IElementType result;
  final PsiBuilder.Marker oldMarker=myPrevMarker;
  myPrevMarker=myBuilder.mark();
  myStack.push((PrattTokenType)tokenType);
  try {
    myBuilder.advanceLexer();
    left=nud.parsePrefix(this);
    result=left.getDoneType();
  }
  finally {
    myStack.pop();
    myPrevMarker.drop();
    myPrevMarker=oldMarker;
  }
  if (left.getErrorMessage() != null) {
    marker.rollbackTo();
    myBuilder.error(left.getErrorMessage());
    return null;
  }
  while (myStack.isEmpty() || !left.isStop()) {
    tokenType=myBuilder.getTokenType();
    if (!(tokenType instanceof PrattTokenType) || rightPriority >= ((PrattTokenType)tokenType).getPriority())     break;
    final Led led=((PrattTokenType)tokenType).getLed();
    if (led == null)     break;
    myPrevMarker=myBuilder.mark();
    myStack.push((PrattTokenType)tokenType);
    try {
      myBuilder.advanceLexer();
      left=led.parseInfix(result,this);
      if (result != null && left.getDoneType() != null) {
        final PsiBuilder.Marker marker1=marker.precede();
        marker.doneBefore(result,myPrevMarker);
        marker=marker1;
        result=left.getDoneType();
      }
    }
  finally {
      if (left.getErrorMessage() != null) {
        myPrevMarker.rollbackTo();
        myBuilder.error(left.getErrorMessage());
      }
      myStack.pop();
      myPrevMarker.drop();
      myPrevMarker=oldMarker;
    }
  }
  if (result != null) {
    marker.done(result);
  }
 else {
    marker.drop();
  }
  return result;
}
