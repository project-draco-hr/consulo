{
  final List<ArtifactBuildTarget> targets=new ArrayList<ArtifactBuildTarget>();
  new ReadAction(){
    protected void run(    final Result result){
      final Set<Artifact> artifacts;
      if (selectedOnly) {
        artifacts=ArtifactCompileScope.getArtifactsToBuild(getProject(),myContext.getCompileScope(),true);
      }
 else {
        artifacts=new HashSet<Artifact>(Arrays.asList(ArtifactManager.getInstance(getProject()).getArtifacts()));
      }
      Map<String,Artifact> artifactsMap=new HashMap<String,Artifact>();
      for (      Artifact artifact : artifacts) {
        artifactsMap.put(artifact.getName(),artifact);
      }
      for (      String name : ArtifactSortingUtil.getInstance(getProject()).getArtifactsSortedByInclusion()) {
        Artifact artifact=artifactsMap.get(name);
        if (artifact != null) {
          targets.add(new ArtifactBuildTarget(artifact));
        }
      }
    }
  }
.execute();
  return targets;
}
