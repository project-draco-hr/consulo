{
  final THashSet<String> deletedJars=deleteFiles(obsoleteItems,changedItems);
  final Set<String> writtenPaths=createPathsHashSet();
  final Ref<Boolean> built=Ref.create(false);
  final Set<ArtifactCompilerCompileItem> processedItems=new HashSet<ArtifactCompilerCompileItem>();
  CompilerUtil.runInContext(myContext,"Copying files",new ThrowableRunnable<RuntimeException>(){
    @Override public void run() throws RuntimeException {
      built.set(doBuild(target.getArtifact(),changedItems,processedItems,writtenPaths,deletedJars));
    }
  }
);
  if (!built.get()) {
    return;
  }
  myContext.getProgressIndicator().setText(CompilerBundle.message("packaging.compiler.message.updating.caches"));
  myContext.getProgressIndicator().setText2("");
  for (  String path : writtenPaths) {
    consumer.addFileToRefresh(new File(path));
  }
  for (  ArtifactCompilerCompileItem item : processedItems) {
    consumer.addProcessedItem(item);
  }
  ArtifactsCompiler.addWrittenPaths(myContext,writtenPaths);
  ArtifactsCompiler.addChangedArtifact(myContext,target.getArtifact());
}
