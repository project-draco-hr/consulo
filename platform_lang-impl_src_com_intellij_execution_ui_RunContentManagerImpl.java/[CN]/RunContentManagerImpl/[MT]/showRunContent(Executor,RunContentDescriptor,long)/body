{
  if (ApplicationManager.getApplication().isUnitTestMode())   return;
  final ContentManager contentManager=getContentManagerForRunner(executor);
  RunContentDescriptor oldDescriptor=chooseReuseContentForDescriptor(contentManager,descriptor,executionId,descriptor != null ? descriptor.getDisplayName() : null);
  final Content content;
  Content oldAttachedContent=oldDescriptor != null ? oldDescriptor.getAttachedContent() : null;
  if (oldDescriptor != null) {
    content=oldAttachedContent;
    getSyncPublisher().contentRemoved(oldDescriptor,executor);
    Disposer.dispose(oldDescriptor);
  }
 else   if (oldAttachedContent == null || !oldAttachedContent.isValid()) {
    content=createNewContent(contentManager,descriptor,executor);
    final Icon icon=descriptor.getIcon();
    content.setIcon(icon == null ? executor.getToolWindowIcon() : icon);
  }
 else {
    content=oldAttachedContent;
  }
  content.setExecutionId(executionId);
  content.setComponent(descriptor.getComponent());
  content.setPreferredFocusedComponent(descriptor.getPreferredFocusComputable());
  content.putUserData(DESCRIPTOR_KEY,descriptor);
  final ProcessHandler processHandler=descriptor.getProcessHandler();
  if (processHandler != null) {
    final ProcessAdapter processAdapter=new ProcessAdapter(){
      public void startNotified(      final ProcessEvent event){
        LaterInvocator.invokeLater(new Runnable(){
          public void run(){
            final Icon icon=descriptor.getIcon();
            content.setIcon(icon == null ? executor.getToolWindowIcon() : icon);
          }
        }
);
      }
      public void processTerminated(      final ProcessEvent event){
        LaterInvocator.invokeLater(new Runnable(){
          public void run(){
            final Icon icon=descriptor.getIcon();
            content.setIcon(icon == null ? executor.getDisabledIcon() : IconLoader.getTransparentIcon(icon));
          }
        }
);
      }
    }
;
    processHandler.addProcessListener(processAdapter);
    final Disposable disposer=content.getDisposer();
    if (disposer != null) {
      Disposer.register(disposer,new Disposable(){
        public void dispose(){
          processHandler.removeProcessListener(processAdapter);
        }
      }
);
    }
  }
  content.setDisplayName(descriptor.getDisplayName());
  descriptor.setAttachedContent(content);
  content.getManager().setSelectedContent(content);
  if (!descriptor.isActivateToolWindowWhenAdded()) {
    return;
  }
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      if (myProject.isDisposed())       return;
      ToolWindow window=ToolWindowManager.getInstance(myProject).getToolWindow(executor.getToolWindowId());
      descriptor.getPreferredFocusComputable();
      window.activate(null,descriptor.isAutoFocusContent(),descriptor.isAutoFocusContent());
    }
  }
);
}
