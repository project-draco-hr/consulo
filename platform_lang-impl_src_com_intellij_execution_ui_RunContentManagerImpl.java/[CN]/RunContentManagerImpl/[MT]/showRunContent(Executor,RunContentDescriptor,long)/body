{
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    return;
  }
  final ContentManager contentManager=getContentManagerForRunner(executor);
  RunContentDescriptor oldDescriptor=chooseReuseContentForDescriptor(contentManager,descriptor,executionId,descriptor.getDisplayName());
  final Content content;
  if (oldDescriptor == null) {
    content=createNewContent(contentManager,descriptor,executor);
    Icon icon=descriptor.getIcon();
    content.setIcon(icon == null ? executor.getToolWindowIcon() : icon);
  }
 else {
    content=oldDescriptor.getAttachedContent();
    LOG.assertTrue(content != null);
    getSyncPublisher().contentRemoved(oldDescriptor,executor);
    Disposer.dispose(oldDescriptor);
  }
  content.setExecutionId(executionId);
  content.setComponent(descriptor.getComponent());
  content.setPreferredFocusedComponent(descriptor.getPreferredFocusComputable());
  content.putUserData(DESCRIPTOR_KEY,descriptor);
  final ToolWindow toolWindow=ToolWindowManager.getInstance(myProject).getToolWindow(executor.getToolWindowId());
  final ProcessHandler processHandler=descriptor.getProcessHandler();
  if (processHandler != null) {
    final ProcessAdapter processAdapter=new ProcessAdapter(){
      @Override public void startNotified(      final ProcessEvent event){
        UIUtil.invokeLaterIfNeeded(new Runnable(){
          @Override public void run(){
            content.setIcon(ExecutionUtil.getLiveIndicator(descriptor.getIcon()));
            toolWindow.setIcon(ExecutionUtil.getLiveIndicator(myToolwindowIdToBaseIconMap.get(executor.getToolWindowId())));
          }
        }
);
      }
      @Override public void processTerminated(      final ProcessEvent event){
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          @Override public void run(){
            boolean alive=false;
            String toolWindowId=executor.getToolWindowId();
            ContentManager manager=myToolwindowIdToContentManagerMap.get(toolWindowId);
            if (manager == null)             return;
            for (            Content content : manager.getContents()) {
              RunContentDescriptor descriptor=getRunContentDescriptorByContent(content);
              if (descriptor != null) {
                ProcessHandler handler=descriptor.getProcessHandler();
                if (handler != null && !handler.isProcessTerminated()) {
                  alive=true;
                  break;
                }
              }
            }
            Icon base=myToolwindowIdToBaseIconMap.get(toolWindowId);
            toolWindow.setIcon(alive ? ExecutionUtil.getLiveIndicator(base) : base);
            Icon icon=descriptor.getIcon();
            content.setIcon(icon == null ? executor.getDisabledIcon() : IconLoader.getTransparentIcon(icon));
          }
        }
);
      }
    }
;
    processHandler.addProcessListener(processAdapter);
    final Disposable disposer=content.getDisposer();
    if (disposer != null) {
      Disposer.register(disposer,new Disposable(){
        @Override public void dispose(){
          processHandler.removeProcessListener(processAdapter);
        }
      }
);
    }
  }
  content.setDisplayName(descriptor.getDisplayName());
  descriptor.setAttachedContent(content);
  content.getManager().setSelectedContent(content);
  if (!descriptor.isActivateToolWindowWhenAdded()) {
    return;
  }
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    @Override public void run(){
      ToolWindow window=ToolWindowManager.getInstance(myProject).getToolWindow(executor.getToolWindowId());
      descriptor.getPreferredFocusComputable();
      window.activate(descriptor.getActivationCallback(),descriptor.isAutoFocusContent(),descriptor.isAutoFocusContent());
    }
  }
,myProject.getDisposed());
}
