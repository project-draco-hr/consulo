{
  final VirtualFileImpl file=((VirtualFileImpl)vFile);
  String name=vFile.getName();
  VirtualFileImpl oldParent=file.getParent();
  final boolean handled=auxMove(vFile,newParent);
  fireBeforeFileMovement(requestor,vFile,newParent);
  newParent.getChildren();
  PhysicalFile physicalFile=file.getPhysicalFile();
  boolean isDirectory=file.isDirectory();
  if (!handled) {
    PhysicalFile newPhysicalParent=((VirtualFileImpl)newParent).getPhysicalFile();
    PhysicalFile newPhysicalFile=newPhysicalParent.createChild(name);
    if (!physicalFile.renameTo(newPhysicalFile)) {
      throw new IOException(VfsBundle.message("file.move.to.error",physicalFile.getPath(),newPhysicalParent.getPath()));
    }
  }
  oldParent.removeChild(file);
  file.setParent((VirtualFileImpl)newParent);
  ((VirtualFileImpl)newParent).addChild(file);
  fireFileMoved(requestor,file,oldParent);
  if (handled && isDirectory && physicalFile.exists()) {
    VirtualFileImpl newMe=new VirtualFileImpl(oldParent,physicalFile,true);
    oldParent.addChild(newMe);
    fireFileCreated(requestor,newMe);
  }
}
