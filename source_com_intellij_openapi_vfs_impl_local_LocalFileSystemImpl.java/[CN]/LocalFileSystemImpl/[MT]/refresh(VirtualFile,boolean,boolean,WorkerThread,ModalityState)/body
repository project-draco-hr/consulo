{
  if (!FileWatcher.isAvailable()) {
    ((VirtualFileImpl)file).refreshInternal(recursive,worker,modalityState);
  }
 else {
synchronized (LOCK) {
      for (int i=0; i < myFilesToWatchManual.size(); i++) {
        VirtualFile fileToWatch=myFilesToWatchManual.get(i);
        if (VfsUtil.isAncestor(fileToWatch,file,false)) {
          ((VirtualFileImpl)file).refreshInternal(recursive,worker,modalityState);
          return;
        }
      }
    }
    if (storeStatus) {
      storeRefreshStatusToFiles();
    }
    Object status;
synchronized (myRefreshStatusMap) {
      status=myRefreshStatusMap.remove(file);
    }
    if (status == DELETED_STATUS) {
      if (((VirtualFileImpl)file).getPhysicalFile().exists()) {
        ((VirtualFileImpl)file).refreshInternal(true,worker,modalityState);
      }
    }
 else {
      if (status == DIRTY_STATUS) {
        ((VirtualFileImpl)file).refreshInternal(false,worker,modalityState);
      }
      if (recursive && ((VirtualFileImpl)file).areChildrenCached()) {
        VirtualFile[] children=file.getChildren();
        for (int i=0; i < children.length; i++) {
          VirtualFile child=children[i];
          if (status == DIRTY_STATUS && !((VirtualFileImpl)child).getPhysicalFile().exists())           continue;
          refresh(child,recursive,false,worker,modalityState);
        }
      }
    }
  }
}
