{
  if (!FileWatcher.isAvailable() || !recursive && !asynchronous) {
    ((VirtualFileImpl)file).refreshInternal(recursive,worker,modalityState,false);
  }
 else {
synchronized (LOCK) {
      for (int i=0; i < myFilesToWatchManual.size(); i++) {
        VirtualFile fileToWatch=myFilesToWatchManual.get(i);
        if (VfsUtil.isAncestor(fileToWatch,file,false)) {
          ((VirtualFileImpl)file).refreshInternal(recursive,worker,modalityState,false);
          return;
        }
      }
    }
    if (storeStatus) {
      storeRefreshStatusToFiles();
    }
    Key status;
synchronized (myRefreshStatusMap) {
      status=myRefreshStatusMap.remove(file);
    }
    if (status == DELETED_STATUS) {
      if (((VirtualFileImpl)file).getPhysicalFile().exists()) {
        ((VirtualFileImpl)file).refreshInternal(true,worker,modalityState,false);
      }
    }
 else {
      if (status == DIRTY_STATUS) {
        ((VirtualFileImpl)file).refreshInternal(false,worker,modalityState,false);
      }
      if (isRoot || (recursive && ((VirtualFileImpl)file).areChildrenCached())) {
        VirtualFile[] children=file.getChildren();
        for (        VirtualFile child : children) {
          if (status == DIRTY_STATUS && !((VirtualFileImpl)child).getPhysicalFile().exists()) {
            continue;
          }
          refresh(child,recursive,false,worker,modalityState,asynchronous,false);
        }
      }
    }
  }
}
