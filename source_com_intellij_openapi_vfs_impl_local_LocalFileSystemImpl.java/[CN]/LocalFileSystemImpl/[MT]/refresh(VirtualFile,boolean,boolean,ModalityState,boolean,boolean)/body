{
  if (!FileWatcher.isAvailable() || !recursive && !asynchronous) {
    ((VirtualFileImpl)file).refreshInternal(recursive,modalityState,false,asynchronous);
    if (!recursive && isRoot && ((VirtualFileImpl)file).areChildrenCached()) {
      final VirtualFile[] children=file.getChildren();
      for (      VirtualFile child : children) {
        ((VirtualFileImpl)child).refreshInternal(false,modalityState,false,asynchronous);
      }
    }
  }
 else {
synchronized (LOCK) {
      for (      VirtualFile fileToWatch : myFilesToWatchManual) {
        if (VfsUtil.isAncestor(fileToWatch,file,false)) {
          ((VirtualFileImpl)file).refreshInternal(recursive,modalityState,false,asynchronous);
          if (isRoot && !recursive && ((VirtualFileImpl)file).areChildrenCached()) {
            VirtualFile[] children=file.getChildren();
            for (            VirtualFile child : children) {
              ((VirtualFileImpl)child).refreshInternal(false,modalityState,false,asynchronous);
            }
          }
          return;
        }
      }
    }
    if (storeStatus) {
      storeRefreshStatusToFiles();
    }
    Key status;
synchronized (myRefreshStatusMap) {
      status=myRefreshStatusMap.remove(file);
    }
    if (status == DELETED_STATUS) {
      if (((VirtualFileImpl)file).getPhysicalFile().exists()) {
        ((VirtualFileImpl)file).refreshInternal(true,modalityState,false,asynchronous);
      }
    }
 else {
      if (status == DIRTY_STATUS) {
        ((VirtualFileImpl)file).refreshInternal(false,modalityState,false,asynchronous);
      }
      if ((isRoot || recursive) && ((VirtualFileImpl)file).areChildrenCached()) {
        VirtualFile[] children=file.getChildren();
        for (        VirtualFile child : children) {
          if (status == DIRTY_STATUS && !((VirtualFileImpl)child).getPhysicalFile().exists()) {
            continue;
          }
          refresh(child,recursive,false,modalityState,asynchronous,false);
        }
      }
    }
  }
}
