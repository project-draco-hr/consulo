{
  if (noWatcher || !FileWatcher.isAvailable() || !recursive && !asynchronous) {
    ((VirtualFileImpl)file).refreshInternal(recursive,modalityState,false,asynchronous);
    if (!recursive && isRoot && ((VirtualFileImpl)file).areChildrenCached()) {
      final VirtualFile[] children=file.getChildren();
      for (int i=0; i < children.length; i++) {
        VirtualFile child=children[i];
        ((VirtualFileImpl)child).refreshInternal(false,modalityState,false,asynchronous);
      }
    }
  }
 else {
synchronized (LOCK) {
      if (!myFilePathsToWatchManual.isEmpty()) {
        final String filePath=file.getPath();
        for (int i=0; i < myFilePathsToWatchManual.size(); i++) {
          String pathToWatchManual=myFilePathsToWatchManual.get(i);
          if (FileUtil.startsWith(filePath,pathToWatchManual)) {
            ((VirtualFileImpl)file).refreshInternal(recursive,modalityState,false,asynchronous);
            if (isRoot && !recursive && ((VirtualFileImpl)file).areChildrenCached()) {
              VirtualFile[] children=file.getChildren();
              for (int j=0; j < children.length; j++) {
                VirtualFile child=children[j];
                ((VirtualFileImpl)child).refreshInternal(false,modalityState,false,asynchronous);
              }
            }
            return;
          }
        }
      }
    }
    if (storeStatus) {
      storeRefreshStatusToFiles();
    }
    Key status;
synchronized (myRefreshStatusMap) {
      status=myRefreshStatusMap.remove(file);
    }
    if (status == DELETED_STATUS) {
      if (((VirtualFileImpl)file).getPhysicalFile().exists()) {
        ((VirtualFileImpl)file).refreshInternal(true,modalityState,false,asynchronous);
      }
    }
 else {
      if (status == DIRTY_STATUS) {
        ((VirtualFileImpl)file).refreshInternal(false,modalityState,false,asynchronous);
      }
      if ((isRoot || recursive) && ((VirtualFileImpl)file).areChildrenCached()) {
        VirtualFile[] children=file.getChildren();
        for (int i=0; i < children.length; i++) {
          VirtualFile child=children[i];
          if (status == DIRTY_STATUS && !((VirtualFileImpl)child).getPhysicalFile().exists()) {
            continue;
          }
          refresh(child,recursive,false,modalityState,asynchronous,false,false);
        }
      }
    }
  }
}
