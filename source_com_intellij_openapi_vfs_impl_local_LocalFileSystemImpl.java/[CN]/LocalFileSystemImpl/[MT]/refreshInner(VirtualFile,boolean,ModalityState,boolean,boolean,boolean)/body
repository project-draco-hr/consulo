{
  if (noWatcher || !FileWatcher.isAvailable() || !recursive && !asynchronous) {
    ((VirtualFileImpl)file).refreshInternal(recursive,modalityState,false,asynchronous);
    if ((isRoot && !recursive) && ((VirtualFileImpl)file).areChildrenCached()) {
      final VirtualFile[] children=file.getChildren();
      for (int i=0; i < children.length; i++) {
        VirtualFile child=children[i];
        refreshInner(child,false,modalityState,asynchronous,false,noWatcher);
      }
    }
  }
 else {
    Key status;
synchronized (myRefreshStatusMap) {
      status=myRefreshStatusMap.remove(file);
    }
    if (status == DELETED_STATUS) {
      if (((VirtualFileImpl)file).getPhysicalFile().exists()) {
        ((VirtualFileImpl)file).refreshInternal(true,modalityState,false,asynchronous);
      }
    }
 else {
      if (status == DIRTY_STATUS) {
        ((VirtualFileImpl)file).refreshInternal(false,modalityState,false,asynchronous);
      }
      if ((isRoot && !recursive) && ((VirtualFileImpl)file).areChildrenCached()) {
        VirtualFile[] children=file.getChildren();
        for (int i=0; i < children.length; i++) {
          VirtualFile child=children[i];
          if (status == DIRTY_STATUS && !((VirtualFileImpl)child).getPhysicalFile().exists()) {
            continue;
          }
          refreshInner(child,false,modalityState,asynchronous,false,noWatcher);
        }
      }
    }
  }
}
