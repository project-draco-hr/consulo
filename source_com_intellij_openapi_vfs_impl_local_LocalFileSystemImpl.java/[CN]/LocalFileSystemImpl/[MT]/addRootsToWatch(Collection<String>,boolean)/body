{
  Set<WatchRequest> result=new HashSet<WatchRequest>();
  Set<VirtualFile> filesToSynchronize=new HashSet<VirtualFile>();
  WRITE_LOCK.lock();
  try {
    for (    String rootPath : rootPaths) {
      LOG.assertTrue(rootPath != null);
      final WatchRequestImpl request=new WatchRequestImpl(rootPath,toWatchRecursively);
      final VirtualFile existingFile=findFileByPathIfCached(rootPath);
      if (existingFile != null) {
        if (!isAlreadyWatched(request)) {
          filesToSynchronize.add(existingFile);
        }
      }
      result.add(request);
      myRootsToWatch.add(request);
    }
    myCachedNormalizedRequests=null;
    setUpFileWatcher();
    if (!filesToSynchronize.isEmpty()) {
      refreshFiles(filesToSynchronize,toWatchRecursively);
    }
  }
  finally {
    WRITE_LOCK.unlock();
  }
  return result;
}
