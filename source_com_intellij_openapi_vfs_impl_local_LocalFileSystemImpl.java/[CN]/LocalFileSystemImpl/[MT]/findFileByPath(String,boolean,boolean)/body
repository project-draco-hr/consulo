{
  if (SystemInfo.isWindows || SystemInfo.isOS2) {
    if (path.endsWith(":/")) {
      path=Character.toUpperCase(path.charAt(0)) + path.substring(1);
    }
  }
  initRoots();
  for (  VirtualFile root : myFSRootsToPaths.keySet()) {
    String runPath=root.getPath();
    if (runPath.endsWith("/"))     runPath=runPath.substring(0,runPath.length() - 1);
    if (!FileUtil.startsWith(path,runPath))     continue;
    if (path.length() == runPath.length())     return root;
    String tail;
    if (path.charAt(runPath.length()) == '/') {
      tail=path.substring(runPath.length() + 1);
    }
 else     if (StringUtil.endsWithChar(runPath,'/')) {
      tail=path.substring(runPath.length());
    }
 else {
      continue;
    }
    StringTokenizer tokenizer=new StringTokenizer(tail,"/");
    while (tokenizer.hasMoreTokens()) {
      final String name=tokenizer.nextToken();
      if (".".equals(name))       continue;
      if ("..".equals(name)) {
        final int index=runPath.lastIndexOf("/");
        if (index >= 0) {
          runPath=runPath.substring(0,index);
        }
 else {
          return null;
        }
        root=root.getParent();
        if (root == null)         return null;
      }
 else {
        runPath=runPath + "/" + name;
        if (!((VirtualFileImpl)root).areChildrenCached()) {
          VirtualFile child=myUnaccountedFiles.get(runPath);
          if (child == null || !child.isValid()) {
            if (!createIfNoCache)             return null;
            if (myUnaccountedFiles.containsKey(runPath)) {
              if (refreshIfNotFound) {
                root.refresh(false,false);
                child=root.findChild(name);
                if (child == null)                 return null;
                root=child;
              }
 else {
                return null;
              }
            }
 else {
              root=((VirtualFileImpl)root).findSingleChild(name);
              if (root == null)               return null;
            }
          }
 else {
            root=child;
          }
        }
 else {
          VirtualFile child=root.findChild(name);
          if (child == null) {
            if (refreshIfNotFound) {
              root.refresh(false,false);
              child=root.findChild(name);
              if (child == null)               return null;
            }
 else {
              return null;
            }
          }
          root=child;
        }
      }
    }
    return root;
  }
  return null;
}
