def changegroup(repo, req):
    req.respond(HTTP_OK, HGTYPE)
    nodes = []
    if ('roots' in req.form):
        nodes = map(bin, req.form['roots'][0].split(' '))
    z = zlib.compressobj()
    f = repo.changegroup(nodes, 'serve')
    while 1:
        chunk = f.read(4096)
        if (not chunk):
            break
        yield z.compress(chunk)
    yield z.flush()
