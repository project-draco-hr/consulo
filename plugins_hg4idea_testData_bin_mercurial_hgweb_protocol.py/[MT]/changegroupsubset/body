def changegroupsubset(repo, req):
    req.respond(HTTP_OK, HGTYPE)
    bases = []
    heads = []
    if ('bases' in req.form):
        bases = [bin(x) for x in req.form['bases'][0].split(' ')]
    if ('heads' in req.form):
        heads = [bin(x) for x in req.form['heads'][0].split(' ')]
    z = zlib.compressobj()
    f = repo.changegroupsubset(bases, heads, 'serve')
    while 1:
        chunk = f.read(4096)
        if (not chunk):
            break
        yield z.compress(chunk)
    yield z.flush()
