def branchmap(repo, req):
    branches = repo.branchmap()
    heads = []
    for (branch, nodes) in branches.iteritems():
        branchname = urllib.quote(branch)
        branchnodes = [hex(node) for node in nodes]
        heads.append(('%s %s' % (branchname, ' '.join(branchnodes))))
    resp = '\n'.join(heads)
    req.respond(HTTP_OK, HGTYPE, length=len(resp))
    yield resp
