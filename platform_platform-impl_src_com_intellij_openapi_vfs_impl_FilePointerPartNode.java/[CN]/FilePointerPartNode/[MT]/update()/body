{
  long lastUpdated=myLastUpdated;
  Pair<VirtualFile,String> fileAndUrl=myFileAndUrl;
  long fsModCount=ourFileManager.getModificationCount();
  if (lastUpdated == fsModCount)   return fileAndUrl;
  VirtualFile file=fileAndUrl.first;
  String url=fileAndUrl.second;
  boolean changed=false;
  if (url == null) {
    url=file.getUrl();
    if (!file.isValid())     file=null;
    changed=true;
  }
  boolean fileIsValid=file != null && file.isValid();
  if (file != null && !fileIsValid) {
    file=null;
    changed=true;
  }
  if (file == null) {
    file=ourFileManager.findFileByUrl(url);
    fileIsValid=file != null && file.isValid();
    if (file != null) {
      changed=true;
    }
  }
  if (file != null) {
    if (fileIsValid) {
      url=file.getUrl();
      changed|=!url.equals(fileAndUrl.second);
    }
 else {
      file=null;
      changed=true;
    }
  }
  Pair<VirtualFile,String> result;
  if (changed) {
    result=Pair.create(file,url);
    myFileAndUrl=result;
  }
 else {
    result=fileAndUrl;
  }
  myLastUpdated=fsModCount;
  return result;
}
