{
  final PsiType type=expression.getType();
  if (type == null)   return null;
  if (type instanceof PsiArrayType) {
    return ((PsiArrayType)type).getComponentType();
  }
  if (type instanceof PsiClassType) {
    final PsiClassType.ClassResolveResult resolveResult=((PsiClassType)type).resolveGenerics();
    final PsiClass aClass=resolveResult.getElement();
    if (aClass == null)     return null;
    final PsiManager manager=aClass.getManager();
    final PsiClass iterable=manager.findClass("java.lang.Iterable",aClass.getResolveScope());
    if (iterable == null)     return null;
    final PsiSubstitutor substitutor=TypeConversionUtil.getClassSubstitutor(iterable,aClass,PsiSubstitutor.EMPTY);
    if (substitutor == null)     return null;
    final PsiTypeParameter itemTypeParameter=iterable.getTypeParameters()[0];
    PsiType itemType=substitutor.substitute(itemTypeParameter);
    itemType=resolveResult.getSubstitutor().substitute(itemType);
    return itemType == null ? PsiType.getJavaLangObject(manager,aClass.getResolveScope()) : itemType;
  }
  return null;
}
