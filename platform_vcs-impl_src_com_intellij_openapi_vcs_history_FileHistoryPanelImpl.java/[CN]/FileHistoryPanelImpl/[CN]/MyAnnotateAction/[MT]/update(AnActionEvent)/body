{
  VirtualFile revVFile=e.getData(VcsDataKeys.VCS_VIRTUAL_FILE);
  VcsFileRevision revision=e.getData(VcsDataKeys.VCS_FILE_REVISION);
  final Boolean nonLocal=e.getData(VcsDataKeys.VCS_NON_LOCAL_HISTORY_SESSION);
  boolean isFile=revVFile != null && !revVFile.isDirectory();
  FileType fileType=isFile ? revVFile.getFileType() : null;
  boolean enabled=revision != null && isFile && !fileType.isBinary() && !Boolean.TRUE.equals(nonLocal);
  if (enabled) {
    final ProjectLevelVcsManager plVcsManager=ProjectLevelVcsManager.getInstance(myVcs.getProject());
    enabled=(!(((ProjectLevelVcsManagerImpl)plVcsManager).getBackgroundableActionHandler(VcsBackgroundableActions.ANNOTATE).isInProgress(key(revVFile))));
  }
  e.getPresentation().setEnabled(enabled && myHistorySession.isContentAvailable(revision) && myAnnotationProvider != null && myAnnotationProvider.isAnnotationValid(revision));
}
