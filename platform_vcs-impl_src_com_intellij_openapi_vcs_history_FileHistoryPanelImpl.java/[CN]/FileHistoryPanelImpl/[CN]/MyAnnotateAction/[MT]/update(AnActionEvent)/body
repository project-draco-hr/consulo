{
  VirtualFile revVFile=e.getData(VcsDataKeys.VCS_VIRTUAL_FILE);
  VcsFileRevision revision=e.getData(VcsDataKeys.VCS_FILE_REVISION);
  FileType fileType=revVFile == null ? null : revVFile.getFileType();
  boolean enabled=revision != null && revVFile != null && !fileType.isBinary();
  if (enabled) {
    final ProjectLevelVcsManager plVcsManager=ProjectLevelVcsManager.getInstance(myVcs.getProject());
    enabled&=(!(((ProjectLevelVcsManagerImpl)plVcsManager).getBackgroundableActionHandler(VcsBackgroundableActions.ANNOTATE).isInProgress(key(revVFile,revision))));
  }
  e.getPresentation().setEnabled(enabled && myHistorySession.isContentAvailable(revision) && myAnnotationProvider != null && myAnnotationProvider.isAnnotationValid(revision));
}
