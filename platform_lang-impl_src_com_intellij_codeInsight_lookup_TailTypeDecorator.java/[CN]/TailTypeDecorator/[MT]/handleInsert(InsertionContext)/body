{
  final LookupElement delegate=getDelegate();
  final TailType tailType=computeTailType(context);
  final LookupItem lookupItem=delegate.as(LookupItem.CLASS_CONDITION_KEY);
  if (lookupItem != null && tailType != null) {
    lookupItem.setTailType(TailType.UNKNOWN);
  }
  delegate.handleInsert(context);
  if (tailType != null && tailType.isApplicable(context)) {
    PostprocessReformattingAspect.getInstance(context.getProject()).doPostponedFormatting();
    int tailOffset=context.getTailOffset();
    if (tailOffset < 0) {
      throw new AssertionError("tailOffset < 0: delegate=" + getDelegate() + "; this="+ this+ "; tail="+ tailType);
    }
    tailType.processTail(context.getEditor(),tailOffset);
  }
}
