{
  myEditor=editor;
  myFile=file;
  myCompletionType=completionType;
  myOffsetMap=new OffsetMap(editor.getDocument());
  final int caretOffset=editor.getCaretModel().getOffset();
  final SelectionModel selectionModel=editor.getSelectionModel();
  myOffsetMap.addOffset(START_OFFSET,selectionModel.hasSelection() ? selectionModel.getSelectionStart() : caretOffset,false);
  final int selectionEndOffset=selectionModel.hasSelection() ? selectionModel.getSelectionEnd() : caretOffset;
  myOffsetMap.addOffset(SELECTION_END_OFFSET,selectionEndOffset,true);
  final PsiReference reference=file.findReferenceAt(selectionEndOffset);
  if (reference != null) {
    myOffsetMap.addOffset(IDENTIFIER_END_OFFSET,reference.getElement().getTextRange().getStartOffset() + reference.getRangeInElement().getEndOffset(),true);
  }
 else {
    myOffsetMap.addOffset(IDENTIFIER_END_OFFSET,selectionEndOffset,true);
  }
}
