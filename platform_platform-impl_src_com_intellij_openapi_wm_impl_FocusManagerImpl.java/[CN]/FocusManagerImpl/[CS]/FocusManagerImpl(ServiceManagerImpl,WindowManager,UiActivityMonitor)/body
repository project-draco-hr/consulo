{
  myApp=ApplicationManager.getApplication();
  myQueue=IdeEventQueue.getInstance();
  myActivityMonitor=monitor;
  myFocusedComponentAlaram=new EdtAlarm();
  myForcedFocusRequestsAlarm=new EdtAlarm();
  myIdleAlarm=new EdtAlarm();
  final AppListener myAppListener=new AppListener();
  myApp.getMessageBus().connect().subscribe(ApplicationActivationListener.TOPIC,myAppListener);
  IdeEventQueue.getInstance().addDispatcher(new IdeEventQueue.EventDispatcher(){
    public boolean dispatch(    AWTEvent e){
      if (e instanceof FocusEvent) {
        final FocusEvent fe=(FocusEvent)e;
        final Component c=fe.getComponent();
        if (c instanceof Window || c == null)         return false;
        Component parent=SwingUtilities.getWindowAncestor(c);
        if (parent instanceof IdeFrame) {
          myLastFocused.put((IdeFrame)parent,new WeakReference<Component>(c));
        }
      }
 else       if (e instanceof WindowEvent) {
        Window wnd=((WindowEvent)e).getWindow();
        if (e.getID() == WindowEvent.WINDOW_CLOSED) {
          if (wnd instanceof IdeFrame) {
            myLastFocused.remove((IdeFrame)wnd);
            myLastFocusedAtDeactivation.remove((IdeFrame)wnd);
          }
        }
      }
      return false;
    }
  }
,this);
  KeyboardFocusManager.getCurrentKeyboardFocusManager().addPropertyChangeListener("focusedWindow",new PropertyChangeListener(){
    @Override public void propertyChange(    PropertyChangeEvent evt){
      if (evt.getNewValue() instanceof IdeFrame) {
        myLastFocusedFrame=(IdeFrame)evt.getNewValue();
      }
    }
  }
);
}
