{
  myApp=ApplicationManager.getApplication();
  myQueue=IdeEventQueue.getInstance();
  myWindowManager=wm;
  myFocusedComponentAlaram=new EdtAlarm(this);
  myForcedFocusRequestsAlarm=new EdtAlarm(this);
  myIdleAlarm=new EdtAlarm(this);
  final AppListener myAppListener=new AppListener();
  myApp.addApplicationListener(myAppListener);
  IdeEventQueue.getInstance().addDispatcher(new IdeEventQueue.EventDispatcher(){
    public boolean dispatch(    AWTEvent e){
      if (e instanceof FocusEvent) {
        final FocusEvent fe=(FocusEvent)e;
        final Component c=fe.getComponent();
        if (c instanceof Window || c == null)         return false;
        Component parent=UIUtil.findUltimateParent(c);
        if (parent instanceof IdeFrame) {
          myLastFocused.put((IdeFrame)parent,c);
        }
      }
 else       if (e instanceof WindowEvent) {
        if (e.getID() == WindowEvent.WINDOW_CLOSED) {
          Window wnd=((WindowEvent)e).getWindow();
          if (wnd instanceof IdeFrame) {
            myLastFocused.remove(wnd);
            myLastFocusedAtDeactivation.remove(wnd);
          }
        }
      }
      return false;
    }
  }
,this);
}
