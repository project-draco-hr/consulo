{
  int modalDialogs=0;
  Window[] windows=Window.getWindows();
  for (  Window each : windows) {
    if (each instanceof Dialog) {
      Dialog eachDialog=(Dialog)each;
      if (eachDialog.isModal() && eachDialog.isShowing()) {
        modalDialogs++;
      }
    }
 else     if (each instanceof JWindow) {
      final JBPopup popup=(JBPopup)((JWindow)each).getRootPane().getClientProperty(JBPopup.KEY);
      if (popup != null && popup.isModalContext()) {
        modalDialogs++;
      }
    }
  }
  Iterator<Integer> modalityCounts=myModalityCount2FlushCount.keySet().iterator();
  while (modalityCounts.hasNext()) {
    Integer eachModalityCount=modalityCounts.next();
    if (eachModalityCount > modalDialogs) {
      modalityCounts.remove();
    }
  }
  return modalDialogs;
}
