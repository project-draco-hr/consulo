{
  VirtualFile dotIdea=projectDir.findChild(".idea");
  VirtualFile modulesXml=dotIdea.findChild("modules.xml");
  final Document document=JDOMUtil.loadDocument(new ByteArrayInputStream(modulesXml.contentsToByteArray()));
  final Element moduleManagerState=getComponentState(document,"ProjectModuleManager");
  PathMacroManager.getInstance(project).expandPaths(moduleManagerState);
  if (moduleManagerState == null) {
    throw new JDOMException("cannot find ProjectModuleManager state in modules.xml");
  }
  final CoreModuleManager moduleManager=(CoreModuleManager)ModuleManager.getInstance(project);
  moduleManager.loadState(moduleManagerState);
  moduleManager.loadModules();
}
