{
  myProject=(ProjectEx)project;
  myConnection=project.getMessageBus().connect();
  myConnection.subscribe(AppTopics.FILE_TYPES,new FileTypeListener(){
    public void beforeFileTypesChanged(    FileTypeEvent event){
      beforeRootsChange(true);
    }
    public void fileTypesChanged(    FileTypeEvent event){
      rootsChanged(true);
    }
  }
);
  myVFSListener=new VirtualFileManagerAdapter(){
    @Override public void afterRefreshFinish(    boolean asynchonous){
      doUpdateOnRefresh();
    }
  }
;
  VirtualFileManager.getInstance().addVirtualFileManagerListener(myVFSListener);
  myRootsCache=new OrderRootsCache(project);
  myProjectFileIndex=new ProjectFileIndexImpl(myProject,directoryIndex,fileTypeManager);
  startupManager.registerStartupActivity(new Runnable(){
    public void run(){
      myStartupActivityPerformed=true;
    }
  }
);
  myHandler=new BatchUpdateListener(){
    public void onBatchUpdateStarted(){
      myRootsChanged.levelUp();
      myFileTypesChanged.levelUp();
    }
    public void onBatchUpdateFinished(){
      myRootsChanged.levelDown();
      myFileTypesChanged.levelDown();
    }
  }
;
  myConnection.subscribe(VirtualFilePointerListener.TOPIC,new MyVirtualFilePointerListener());
}
