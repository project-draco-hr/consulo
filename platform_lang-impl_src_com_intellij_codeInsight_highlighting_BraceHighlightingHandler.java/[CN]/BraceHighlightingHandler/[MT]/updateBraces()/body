{
  if (myPsiFile == null)   return;
  clearBraceHighlighters();
  if (!myCodeInsightSettings.HIGHLIGHT_BRACES)   return;
  if (myEditor.getSelectionModel().hasSelection())   return;
  int offset=myEditor.getCaretModel().getOffset();
  final CharSequence chars=myEditor.getDocument().getCharsSequence();
  if (myEditor.offsetToLogicalPosition(offset).column != myEditor.getCaretModel().getLogicalPosition().column) {
    final int caretLineNumber=myEditor.getCaretModel().getLogicalPosition().line;
    if (caretLineNumber >= myDocument.getLineCount())     return;
    offset=myDocument.getLineEndOffset(caretLineNumber) + myDocument.getLineSeparatorLength(caretLineNumber);
  }
  final int originalOffset=offset;
  HighlighterIterator iterator=getEditorHighlighter().createIterator(offset);
  if (iterator.atEnd()) {
    offset--;
  }
 else   if (BraceMatchingUtil.isRBraceToken(iterator,chars,myFileType)) {
    offset--;
  }
 else   if (!BraceMatchingUtil.isLBraceToken(iterator,chars,myFileType)) {
    offset--;
    if (offset >= 0) {
      final HighlighterIterator i=getEditorHighlighter().createIterator(offset);
      if (!BraceMatchingUtil.isRBraceToken(i,chars,myFileType))       offset++;
    }
  }
  if (offset < 0) {
    removeLineMarkers();
    return;
  }
  iterator=getEditorHighlighter().createIterator(offset);
  myAlarm.cancelAllRequests();
  if (BraceMatchingUtil.isLBraceToken(iterator,chars,myFileType) || BraceMatchingUtil.isRBraceToken(iterator,chars,myFileType)) {
    doHighlight(offset,originalOffset);
  }
  if (!myCodeInsightSettings.HIGHLIGHT_SCOPE) {
    removeLineMarkers();
    return;
  }
  final int _offset=offset;
  myAlarm.addRequest(new Runnable(){
    public void run(){
      if (!myProject.isDisposed() && !myEditor.isDisposed()) {
        highlightScope(_offset);
      }
    }
  }
,300);
}
