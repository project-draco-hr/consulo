{
  ApplicationManager.getApplication().assertIsDispatchThread();
  if (myPsiFile == null || !myPsiFile.isValid())   return;
  clearBraceHighlighters();
  if (!myCodeInsightSettings.HIGHLIGHT_BRACES)   return;
  if (myEditor.getSelectionModel().hasSelection())   return;
  if (myEditor.getSoftWrapModel().isInsideOrBeforeSoftWrap(myEditor.getCaretModel().getVisualPosition()))   return;
  int offset=myEditor.getCaretModel().getOffset();
  final CharSequence chars=myEditor.getDocument().getCharsSequence();
  final int originalOffset=offset;
  HighlighterIterator iterator=getEditorHighlighter().createIterator(offset);
  FileType fileType=PsiUtilBase.getPsiFileAtOffset(myPsiFile,offset).getFileType();
  if (iterator.atEnd()) {
    offset--;
  }
 else   if (BraceMatchingUtil.isRBraceToken(iterator,chars,fileType)) {
    offset--;
  }
 else   if (!BraceMatchingUtil.isLBraceToken(iterator,chars,fileType)) {
    offset--;
    if (offset >= 0) {
      final HighlighterIterator i=getEditorHighlighter().createIterator(offset);
      if (!BraceMatchingUtil.isRBraceToken(i,chars,getFileTypeByIterator(i)))       offset++;
    }
  }
  if (offset < 0) {
    removeLineMarkers();
    return;
  }
  iterator=getEditorHighlighter().createIterator(offset);
  fileType=getFileTypeByIterator(iterator);
  myAlarm.cancelAllRequests();
  if (BraceMatchingUtil.isLBraceToken(iterator,chars,fileType) || BraceMatchingUtil.isRBraceToken(iterator,chars,fileType)) {
    doHighlight(offset,originalOffset,fileType);
  }
 else   if (offset > 0 && offset < chars.length()) {
    char c=chars.charAt(offset);
    boolean searchForward=c != '\n';
    if (offset >= originalOffset && (c == ' ' || c == '\t' || c == '\n')) {
      int backwardNonWsOffset=CharArrayUtil.shiftBackward(chars,offset - 1,"\t ");
      if (backwardNonWsOffset >= 0) {
        iterator=getEditorHighlighter().createIterator(backwardNonWsOffset);
        FileType newFileType=getFileTypeByIterator(iterator);
        if (BraceMatchingUtil.isLBraceToken(iterator,chars,newFileType) || BraceMatchingUtil.isRBraceToken(iterator,chars,newFileType)) {
          offset=backwardNonWsOffset;
          searchForward=false;
          doHighlight(backwardNonWsOffset,originalOffset,newFileType);
        }
      }
    }
    if (searchForward) {
      int forwardOffset=CharArrayUtil.shiftForward(chars,offset,"\t ");
      if (forwardOffset > offset || c == ' ' || c == '\t') {
        iterator=getEditorHighlighter().createIterator(forwardOffset);
        FileType newFileType=getFileTypeByIterator(iterator);
        if (BraceMatchingUtil.isLBraceToken(iterator,chars,newFileType) || BraceMatchingUtil.isRBraceToken(iterator,chars,newFileType)) {
          offset=forwardOffset;
          doHighlight(forwardOffset,originalOffset,newFileType);
        }
      }
    }
  }
  if (!myCodeInsightSettings.HIGHLIGHT_SCOPE) {
    removeLineMarkers();
    return;
  }
  final int _offset=offset;
  final FileType _fileType=fileType;
  myAlarm.addRequest(new Runnable(){
    @Override public void run(){
      if (!myProject.isDisposed() && !myEditor.isDisposed()) {
        highlightScope(_offset,_fileType);
      }
    }
  }
,300);
}
