{
  Document document=editor.getDocument();
  if (PsiDocumentManager.getInstance(project).isCommitted(document)) {
    final PsiElement injectedElement=InjectedLanguageUtil.findInjectedElementNoCommit(psiFile,offset);
    if (injectedElement != null) {
      final PsiFile injected=injectedElement.getContainingFile();
      if (injected != null) {
        return injected;
      }
    }
  }
 else {
    PsiDocumentManager.getInstance(project).performForCommittedDocument(document,new Runnable(){
      @Override public void run(){
        if (!project.isDisposed() && !editor.isDisposed()) {
          BraceHighlighter.updateBraces(editor,alarm);
        }
      }
    }
);
  }
  return psiFile;
}
