{
  Document document=editor.getDocument();
  if (!PsiDocumentManager.getInstance(project).isUncommited(document)) {
    final PsiElement injectedElement=InjectedLanguageFacadeImpl.findInjectedElementNoCommit(psiFile,offset);
    if (injectedElement != null) {
      final PsiFile injected=injectedElement.getContainingFile();
      if (injected != null) {
        return injected;
      }
    }
  }
 else {
    PsiDocumentManager.getInstance(project).performForCommittedDocument(document,new Runnable(){
      public void run(){
        if (!project.isDisposed() && !editor.isDisposed()) {
          BraceHighlighter.updateBraces(editor,alarm);
        }
      }
    }
);
  }
  return psiFile;
}
