{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(method.getProject());
      StringBuilder builder=new StringBuilder(method.getTextLength());
      String modifiers=method.getModifierList().getText();
      if (modifiers.trim().length() == 0) {
        modifiers=GrModifier.DEF;
      }
      builder.append(modifiers).append(' ');
      builder.append(method.getName()).append("={");
      builder.append(method.getParameterList().getText()).append(" ->");
      final GrOpenBlock block=method.getBlock();
      builder.append(block.getText().substring(1));
      final GrVariableDeclaration variableDeclaration=GroovyPsiElementFactory.getInstance(method.getProject()).createFieldDeclarationFromText(builder.toString());
      method.replace(variableDeclaration);
      for (      GrReferenceExpression element : usagesToConvert) {
        final PsiElement qualifier=element.getQualifier();
        final StringBuilder text=new StringBuilder(qualifier.getText());
        element.setQualifierExpression(null);
        text.append('.').append(element.getText());
        element.replace(factory.createExpressionFromText(text.toString()));
      }
    }
  }
);
}
