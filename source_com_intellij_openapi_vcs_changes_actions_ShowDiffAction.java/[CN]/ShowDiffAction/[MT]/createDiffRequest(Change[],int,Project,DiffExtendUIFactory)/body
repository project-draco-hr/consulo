{
  final Change change=changes[index];
  final ContentRevision bRev=change.getBeforeRevision();
  final ContentRevision aRev=change.getAfterRevision();
  if ((bRev != null && (bRev.getFile().getFileType().isBinary() || bRev.getFile().isDirectory())) || (aRev != null && (aRev.getFile().getFileType().isBinary() || aRev.getFile().isDirectory()))) {
    if (bRev != null && bRev.getFile().getFileType() == StdFileTypes.UNKNOWN && !bRev.getFile().isDirectory()) {
      if (!checkAssociate(project,bRev.getFile()))       return null;
    }
 else     if (aRev != null && aRev.getFile().getFileType() == StdFileTypes.UNKNOWN && !aRev.getFile().isDirectory()) {
      if (!checkAssociate(project,aRev.getFile()))       return null;
    }
 else {
      return null;
    }
  }
  String beforePath=bRev != null ? bRev.getFile().getPath() : null;
  String afterPath=aRev != null ? aRev.getFile().getPath() : null;
  String title;
  if (beforePath != null && afterPath != null && !beforePath.equals(afterPath)) {
    title=beforePath + " -> " + afterPath;
  }
 else   if (beforePath != null) {
    title=beforePath;
  }
 else   if (afterPath != null) {
    title=afterPath;
  }
 else {
    title=VcsBundle.message("diff.unknown.path.title");
  }
  final ChangeDiffRequest diffReq=new ChangeDiffRequest(project,title,changes,index,actionsFactory);
  if (changes.length > 1 || actionsFactory != null) {
    diffReq.setToolbarAddons(new DiffRequest.ToolbarAddons(){
      public void customize(      DiffToolbar toolbar){
        if (changes.length > 1) {
          toolbar.addSeparator();
          toolbar.addAction(ActionManager.getInstance().getAction("Diff.PrevChange"));
          toolbar.addAction(ActionManager.getInstance().getAction("Diff.NextChange"));
        }
        if (actionsFactory != null) {
          toolbar.addSeparator();
          for (          AnAction action : actionsFactory.createActions(change)) {
            toolbar.addAction(action);
          }
        }
      }
    }
);
  }
  if (actionsFactory != null) {
    diffReq.setBottomComponentFactory(new NullableFactory<JComponent>(){
      public JComponent create(){
        return actionsFactory.createBottomComponent();
      }
    }
);
  }
  boolean result=ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
    public void run(){
      diffReq.setContents(createContent(project,(ContentRevision)bRev),createContent(project,(ContentRevision)aRev));
    }
  }
,VcsBundle.message("progress.loading.diff.revisions"),true,project);
  if (!result)   return null;
  String beforeRevisionTitle=(bRev != null) ? bRev.getRevisionNumber().asString() : "";
  String afterRevisionTitle=(aRev != null) ? aRev.getRevisionNumber().asString() : "";
  if (beforeRevisionTitle.length() == 0) {
    beforeRevisionTitle="Base version";
  }
  if (afterRevisionTitle.length() == 0) {
    afterRevisionTitle="Your version";
  }
  diffReq.setContentTitles(beforeRevisionTitle,afterRevisionTitle);
  return diffReq;
}
