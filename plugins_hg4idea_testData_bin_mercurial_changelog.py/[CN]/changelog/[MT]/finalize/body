def finalize(self, tr):
    'finalize index updates'
    self._delayed = False
    self.opener = self._realopener
    if self._divert:
        n = self.opener((self.indexfile + '.a')).name
        util.rename(n, n[:(-2)])
    elif self._delaybuf:
        fp = self.opener(self.indexfile, 'a')
        fp.write(''.join(self._delaybuf))
        fp.close()
        self._delaybuf = []
    self.checkinlinesize(tr)
