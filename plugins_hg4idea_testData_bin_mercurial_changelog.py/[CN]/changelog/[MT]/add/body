def add(self, manifest, files, desc, transaction, p1, p2, user, date=None, extra=None):
    user = user.strip()
    if (not user):
        raise error.RevlogError(_('empty username'))
    if ('\n' in user):
        raise error.RevlogError((_('username %s contains a newline') % repr(user)))
    desc = '\n'.join([l.rstrip() for l in desc.splitlines()]).strip('\n')
    (user, desc) = (encoding.fromlocal(user), encoding.fromlocal(desc))
    if date:
        parseddate = ('%d %d' % util.parsedate(date))
    else:
        parseddate = ('%d %d' % util.makedate())
    if extra:
        branch = extra.get('branch')
        if (branch in ('default', '')):
            del extra['branch']
        elif (branch in ('.', 'null', 'tip')):
            raise error.RevlogError((_("the name '%s' is reserved") % branch))
    if extra:
        extra = encodeextra(extra)
        parseddate = ('%s %s' % (parseddate, extra))
    l = (([hex(manifest), user, parseddate] + sorted(files)) + ['', desc])
    text = '\n'.join(l)
    return self.addrevision(text, transaction, len(self), p1, p2)
