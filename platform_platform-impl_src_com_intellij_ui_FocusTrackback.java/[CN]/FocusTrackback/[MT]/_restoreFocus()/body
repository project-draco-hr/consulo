{
  final List<FocusTrackback> stack=getCleanStack();
  if (!stack.contains(this))   return new ActionCallback.Rejected();
  Component toFocus=queryToFocus(stack,this,true);
  final ActionCallback result=new ActionCallback();
  if (toFocus != null) {
    final Component ownerBySwing=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
    if (ownerBySwing != null) {
      final Window ownerBySwingWindow=SwingUtilities.getWindowAncestor(ownerBySwing);
      if (ownerBySwingWindow != null && ownerBySwingWindow == SwingUtilities.getWindowAncestor(toFocus)) {
        if (!UIUtil.isMeaninglessFocusOwner(ownerBySwing)) {
          toFocus=ownerBySwing;
        }
      }
    }
    if (myParentWindow != null) {
      final Window to=toFocus instanceof Window ? (Window)toFocus : SwingUtilities.getWindowAncestor(toFocus);
      if (to != null && UIUtil.findUltimateParent(to) == UIUtil.findUltimateParent(myParentWindow)) {
        toFocus.requestFocus();
        result.setDone();
      }
    }
 else {
      toFocus.requestFocus();
      result.setDone();
    }
  }
  if (!result.isDone()) {
    result.setRejected();
  }
  stack.remove(this);
  dispose();
  return result;
}
