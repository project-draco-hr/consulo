{
  myTrack=getRequestor() instanceof DialogWrapper && "Use Interface Where Possible".equals(((DialogWrapper)getRequestor()).getTitle());
  final Application app=ApplicationManager.getApplication();
  if (app == null || wrongOS() || myConsumed || isSheduledForRestore())   return;
  Project project=null;
  DataContext context=myParentWindow == null ? DataManager.getInstance().getDataContext() : DataManager.getInstance().getDataContext(myParentWindow);
  if (context != null) {
    project=PlatformDataKeys.PROJECT.getData(context);
  }
  mySheduledForRestore=true;
  final List<FocusTrackback> stack=getCleanStackForRoot();
  final int index=stack.indexOf(this);
  for (int i=index - 1; i >= 0; i--) {
    if (stack.get(i).isSheduledForRestore()) {
      dispose();
      return;
    }
  }
  if (!myForcedRestore) {
    if (index == 0 && stack.size() == 1 && !UIUtil.isMeaninglessFocusOwner(getFocusOwner())) {
      myForcedRestore=true;
    }
  }
  if (project != null && !project.isDisposed()) {
    final IdeFocusManager focusManager=IdeFocusManager.getInstance(project);
    cleanParentWindow();
    final Project finalProject=project;
    focusManager.requestFocus(new MyFocusCommand(),myForcedRestore).doWhenProcessed(new Runnable(){
      public void run(){
        dispose();
      }
    }
).doWhenRejected(new Runnable(){
      @Override public void run(){
        focusManager.revalidateFocus(new ExpirableRunnable.ForProject(finalProject){
          @Override public void run(){
            if (UIUtil.isMeaninglessFocusOwner(focusManager.getFocusOwner())) {
              focusManager.requestDefaultFocus(false);
            }
          }
        }
);
      }
    }
);
  }
 else {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        _restoreFocus();
        dispose();
      }
    }
);
  }
}
