{
  HighlightingSession session=getHighlightingSession(psiFile,progressIndicator);
  if (session == null) {
    ConcurrentMap<PsiFile,HighlightingSession> map=progressIndicator.getUserData(HIGHLIGHTING_SESSION);
    if (map == null) {
      map=progressIndicator.putUserDataIfAbsent(HIGHLIGHTING_SESSION,ContainerUtil.<PsiFile,HighlightingSession>newConcurrentMap());
    }
    session=ConcurrencyUtil.cacheOrGet(map,psiFile,new HighlightingSessionImpl(psiFile,editor,progressIndicator,editorColorsScheme));
  }
  return session;
}
