{
  DataContext context=e.getDataContext();
  VirtualFile[] files=DataKeys.VIRTUAL_FILE_ARRAY.getData(context);
  if (files == null || files.length != 3) {
    return;
  }
  DiffRequestFactory diffRequestFactory=PeerFactory.getInstance().getDiffRequestFactory();
  VirtualFile file=files[1];
  try {
    String originalText=createValidContent(VfsUtil.loadText(file));
    String leftText=VfsUtil.loadText(files[0]);
    String rightText=VfsUtil.loadText(files[2]);
    Project project=DataKeys.PROJECT.getData(context);
    final MergeRequest diffData=diffRequestFactory.createMergeRequest(leftText,rightText,originalText,file,project,ActionButtonPresentation.createApplyButton());
    diffData.setVersionTitles(new String[]{files[0].getPresentableUrl(),files[1].getPresentableUrl(),files[2].getPresentableUrl()});
    diffData.setWindowTitle(DiffBundle.message("merge.files.dialog.title"));
    diffData.setHelpId("cvs.merge");
    DiffManager.getInstance().getDiffTool().show(diffData);
  }
 catch (  IOException e1) {
    Messages.showErrorDialog(DiffBundle.message("merge.dialog.cannot.load.file.error.message",e1.getLocalizedMessage()),DiffBundle.message("merge.files.dialog.title"));
  }
}
