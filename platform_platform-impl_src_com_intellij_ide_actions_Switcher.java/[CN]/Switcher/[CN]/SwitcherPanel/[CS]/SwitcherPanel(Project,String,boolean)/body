{
  setLayout(new SwitcherLayouter());
  this.project=project;
  myTitle=title;
  myPinned=pinned;
  mySpeedSearch=pinned ? new SwitcherSpeedSearch() : null;
  setBorder(JBUI.Borders.empty());
  setBackground(JBColor.background());
  pathLabel.setHorizontalAlignment(SwingConstants.LEFT);
  final Font font=pathLabel.getFont();
  pathLabel.setFont(font.deriveFont(Math.max(10f,font.getSize() - 4f)));
  descriptions=new JPanel(new BorderLayout()){
    @Override protected void paintComponent(    @NotNull Graphics g){
      super.paintComponent(g);
      g.setColor(UIUtil.isUnderDarcula() ? SEPARATOR_COLOR : BORDER_COLOR);
      g.drawLine(0,0,getWidth(),0);
    }
  }
;
  descriptions.setBorder(BorderFactory.createEmptyBorder(1,4,1,4));
  descriptions.add(pathLabel,BorderLayout.CENTER);
  twManager=ToolWindowManager.getInstance(project);
  DefaultListModel twModel=new DefaultListModel();
  List<ActivateToolWindowAction> actions=ToolWindowsGroup.getToolWindowActions(project);
  List<ToolWindow> windows=ContainerUtil.newArrayList();
  for (  ActivateToolWindowAction action : actions) {
    ToolWindow tw=twManager.getToolWindow(action.getToolWindowId());
    if (tw.isAvailable()) {
      windows.add(tw);
    }
  }
  twShortcuts=createShortcuts(windows);
  final Map<ToolWindow,String> map=ContainerUtil.reverseMap(twShortcuts);
  Collections.sort(windows,new Comparator<ToolWindow>(){
    @Override public int compare(    @NotNull ToolWindow o1,    @NotNull ToolWindow o2){
      return StringUtil.compare(map.get(o1),map.get(o2),false);
    }
  }
);
  for (  ToolWindow window : windows) {
    twModel.addElement(window);
  }
  toolWindows=new JBList(twModel);
  if (pinned) {
    new NameFilteringListModel<ToolWindow>(toolWindows,new Function<ToolWindow,String>(){
      @NotNull @Override public String fun(      @NotNull ToolWindow window){
        return window.getStripeTitle();
      }
    }
,new Condition<String>(){
      @Override public boolean value(      @NotNull String s){
        return !mySpeedSearch.isPopupActive() || StringUtil.isEmpty(mySpeedSearch.getEnteredPrefix()) || mySpeedSearch.getComparator().matchingFragments(mySpeedSearch.getEnteredPrefix(),s) != null;
      }
    }
,mySpeedSearch);
  }
  toolWindows.setBorder(IdeBorderFactory.createEmptyBorder(5,5,5,20));
  toolWindows.setSelectionMode(pinned ? ListSelectionModel.MULTIPLE_INTERVAL_SELECTION : ListSelectionModel.SINGLE_SELECTION);
  toolWindows.setCellRenderer(new SwitcherToolWindowsListRenderer(mySpeedSearch,map,myPinned){
    @NotNull @Override public Component getListCellRendererComponent(    @NotNull JList list,    Object value,    int index,    boolean selected,    boolean hasFocus){
      final JComponent renderer=(JComponent)super.getListCellRendererComponent(list,value,index,selected,selected);
      if (selected) {
        return renderer;
      }
      final Color bgColor=list == mouseMoveSrc && index == mouseMoveListIndex ? ON_MOUSE_OVER_BG_COLOR : list.getBackground();
      UIUtil.changeBackGround(renderer,bgColor);
      return renderer;
    }
  }
);
  toolWindows.addKeyListener(this);
  ListScrollingUtil.installActions(toolWindows);
  toolWindows.addMouseListener(this);
  toolWindows.addMouseMotionListener(this);
  ListScrollingUtil.ensureSelectionExists(toolWindows);
  myClickListener.installOn(toolWindows);
  toolWindows.getSelectionModel().addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    @NotNull ListSelectionEvent e){
      if (!toolWindows.isSelectionEmpty() && !files.isSelectionEmpty()) {
        files.clearSelection();
      }
    }
  }
);
  separator=new JPanel(){
    @Override protected void paintComponent(    @NotNull Graphics g){
      super.paintComponent(g);
      g.setColor(SEPARATOR_COLOR);
      g.drawLine(0,0,0,getHeight());
    }
  }
;
  separator.setBackground(toolWindows.getBackground());
  int selectionIndex=-1;
  final FileEditorManagerImpl editorManager=(FileEditorManagerImpl)FileEditorManager.getInstance(project);
  final ArrayList<FileInfo> filesData=new ArrayList<FileInfo>();
  final ArrayList<FileInfo> editors=new ArrayList<FileInfo>();
  if (!pinned) {
    if (UISettings.getInstance().EDITOR_TAB_PLACEMENT != UISettings.TABS_NONE) {
      for (      Pair<VirtualFile,EditorWindow> pair : editorManager.getSelectionHistory()) {
        editors.add(new FileInfo(pair.first,pair.second,project));
      }
    }
  }
  if (editors.size() < 2 || isPinnedMode()) {
    if (isPinnedMode() && editors.size() > 1) {
      filesData.addAll(editors);
    }
    final VirtualFile[] recentFiles=ArrayUtil.reverseArray(getFiles(project));
    final int maxFiles=Math.max(editors.size(),recentFiles.length);
    final int len=isPinnedMode() ? recentFiles.length : Math.min(toolWindows.getModel().getSize(),maxFiles);
    boolean firstRecentMarked=false;
    final List<VirtualFile> selectedFiles=Arrays.asList(editorManager.getSelectedFiles());
    for (int i=0; i < len; i++) {
      if (isPinnedMode() && selectedFiles.contains(recentFiles[i])) {
        continue;
      }
      final FileInfo info=new FileInfo(recentFiles[i],null,project);
      boolean add=true;
      if (isPinnedMode()) {
        for (        FileInfo fileInfo : filesData) {
          if (fileInfo.first.equals(info.first)) {
            add=false;
            break;
          }
        }
      }
      if (add) {
        filesData.add(info);
        if (!firstRecentMarked) {
          firstRecentMarked=true;
          selectionIndex=filesData.size() - 1;
        }
      }
    }
    if (editors.size() == 1 && (filesData.isEmpty() || !editors.get(0).getFirst().equals(filesData.get(0).getFirst()))) {
      filesData.add(0,editors.get(0));
    }
  }
 else {
    for (int i=0; i < Math.min(30,editors.size()); i++) {
      filesData.add(editors.get(i));
    }
  }
  final DefaultListModel filesModel=new DefaultListModel();
  for (  FileInfo editor : filesData) {
    filesModel.addElement(editor);
  }
  final VirtualFilesRenderer filesRenderer=new VirtualFilesRenderer(this){
    JPanel myPanel=new JPanel(new BorderLayout());
    JLabel myLabel=new JLabel(){
      @Override protected void paintComponent(      @NotNull Graphics g){
        GraphicsConfig config=new GraphicsConfig(g);
        ((Graphics2D)g).setComposite(AlphaComposite.getInstance(AlphaComposite.SRC_OVER,0.3f));
        super.paintComponent(g);
        config.restore();
      }
    }
;
{
      myPanel.setOpaque(false);
      myPanel.setBackground(UIUtil.getListBackground());
      myLabel.setText("* ");
    }
    @NotNull @Override public Component getListCellRendererComponent(    @NotNull JList list,    Object value,    int index,    boolean selected,    boolean hasFocus){
      final Component c=super.getListCellRendererComponent(list,value,index,selected,selected);
      final Color bg=UIUtil.getListBackground();
      final Color fg=UIUtil.getListForeground();
      myLabel.setFont(list.getFont());
      myLabel.setForeground(open ? fg : bg);
      myPanel.removeAll();
      myPanel.add(myLabel,BorderLayout.WEST);
      myPanel.add(c,BorderLayout.CENTER);
      return myPanel;
    }
    @Override protected void customizeCellRenderer(    JList list,    Object value,    int index,    boolean selected,    boolean hasFocus){
      setPaintFocusBorder(false);
      super.customizeCellRenderer(list,value,index,selected,hasFocus);
    }
  }
;
  final ListSelectionListener filesSelectionListener=new ListSelectionListener(){
    @Nullable private String getTitle2Text(    @Nullable String fullText){
      int labelWidth=pathLabel.getWidth();
      if (fullText == null || fullText.length() == 0)       return " ";
      while (pathLabel.getFontMetrics(pathLabel.getFont()).stringWidth(fullText) > labelWidth) {
        int sep=fullText.indexOf(File.separatorChar,4);
        if (sep < 0)         return fullText;
        fullText="..." + fullText.substring(sep);
      }
      return fullText;
    }
    @Override public void valueChanged(    @NotNull final ListSelectionEvent e){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          updatePathLabel();
        }
      }
);
    }
    private void updatePathLabel(){
      Object[] values=files.getSelectedValues();
      if (values != null && values.length == 1) {
        VirtualFile file=((FileInfo)values[0]).first;
        String presentableUrl=ObjectUtils.notNull(file.getParent(),file).getPresentableUrl();
        pathLabel.setText(getTitle2Text(FileUtil.getLocationRelativeToUserHome(presentableUrl)));
      }
 else {
        pathLabel.setText(" ");
      }
    }
  }
;
  files=new JBList(filesModel);
  if (pinned) {
    new NameFilteringListModel<FileInfo>(files,new Function<FileInfo,String>(){
      @Override public String fun(      @NotNull FileInfo info){
        return info.getNameForRendering();
      }
    }
,new Condition<String>(){
      @Override public boolean value(      @NotNull String s){
        return !mySpeedSearch.isPopupActive() || StringUtil.isEmpty(mySpeedSearch.getEnteredPrefix()) || mySpeedSearch.getComparator().matchingFragments(mySpeedSearch.getEnteredPrefix(),s) != null;
      }
    }
,mySpeedSearch);
  }
  files.setSelectionMode(pinned ? ListSelectionModel.MULTIPLE_INTERVAL_SELECTION : ListSelectionModel.SINGLE_SELECTION);
  files.getSelectionModel().addListSelectionListener(new ListSelectionListener(){
    @Override public void valueChanged(    @NotNull ListSelectionEvent e){
      if (!files.isSelectionEmpty() && !toolWindows.isSelectionEmpty()) {
        toolWindows.getSelectionModel().clearSelection();
      }
    }
  }
);
  files.getSelectionModel().addListSelectionListener(filesSelectionListener);
  files.setCellRenderer(filesRenderer);
  files.setBorder(IdeBorderFactory.createEmptyBorder(5,5,5,20));
  files.addKeyListener(this);
  ListScrollingUtil.installActions(files);
  files.addMouseListener(this);
  files.addMouseMotionListener(this);
  myClickListener.installOn(files);
  ListScrollingUtil.ensureSelectionExists(files);
  this.add(toolWindows,BorderLayout.WEST);
  if (filesModel.size() > 0) {
    files.setAlignmentY(1f);
    if (files.getModel().getSize() > 20) {
      final JScrollPane pane=ScrollPaneFactory.createScrollPane(files,true);
      pane.setPreferredSize(new Dimension(files.getPreferredSize().width + 10,20 * 20));
      pane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
      this.add(pane,BorderLayout.EAST);
    }
 else {
      this.add(files,BorderLayout.EAST);
    }
    if (selectionIndex > -1) {
      files.setSelectedIndex(selectionIndex);
    }
    this.add(separator,BorderLayout.CENTER);
  }
  this.add(descriptions,BorderLayout.SOUTH);
  final ShortcutSet shortcutSet=ActionManager.getInstance().getAction(IdeActions.ACTION_SWITCHER).getShortcutSet();
  final int modifiers=getModifiers(shortcutSet);
  final boolean isAlt=(modifiers & Event.ALT_MASK) != 0;
  ALT_KEY=isAlt ? VK_CONTROL : VK_ALT;
  CTRL_KEY=isAlt ? VK_ALT : VK_CONTROL;
  files.addKeyListener(ArrayUtil.getLastElement(getKeyListeners()));
  toolWindows.addKeyListener(ArrayUtil.getLastElement(getKeyListeners()));
  myPopup=JBPopupFactory.getInstance().createComponentPopupBuilder(this,filesModel.getSize() > 0 ? files : toolWindows).setResizable(pinned).setModalContext(false).setFocusable(true).setRequestFocus(true).setTitle(title).setCancelOnWindowDeactivation(true).setCancelOnOtherWindowOpen(true).setMovable(pinned).setCancelKeyEnabled(false).setCancelCallback(new Computable<Boolean>(){
    @Override @NotNull public Boolean compute(){
      SWITCHER=null;
      return true;
    }
  }
).createPopup();
  if (isPinnedMode()) {
    new AnAction(null,null,null){
      @RequiredDispatchThread @Override public void actionPerformed(      @NotNull AnActionEvent e){
        changeSelection();
      }
    }
.registerCustomShortcutSet(CustomShortcutSet.fromString("TAB"),this,myPopup);
    new AnAction(null,null,null){
      @RequiredDispatchThread @Override public void actionPerformed(      @NotNull AnActionEvent e){
        if (mySpeedSearch != null && mySpeedSearch.isPopupActive()) {
          mySpeedSearch.hidePopup();
        }
 else {
          myPopup.cancel();
        }
      }
    }
.registerCustomShortcutSet(CustomShortcutSet.fromString("ESCAPE"),this,myPopup);
  }
  new AnAction(null,null,null){
    @RequiredDispatchThread @Override public void actionPerformed(    @NotNull AnActionEvent e){
    }
  }
.registerCustomShortcutSet(TW_SHORTCUT,this,myPopup);
  Window window=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
  if (window == null) {
    window=WindowManager.getInstance().getFrame(project);
  }
  myAlarm=new Alarm(Alarm.ThreadToUse.SWING_THREAD,myPopup);
  myPopup.showInCenterOf(window);
}
