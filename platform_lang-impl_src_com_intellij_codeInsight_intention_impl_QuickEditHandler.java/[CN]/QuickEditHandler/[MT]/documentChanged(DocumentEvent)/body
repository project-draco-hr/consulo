{
  UndoManager undoManager=UndoManager.getInstance(myProject);
  boolean undoOrRedo=undoManager.isUndoInProgress() || undoManager.isRedoInProgress();
  if (undoOrRedo) {
    if (e.getDocument() == myOrigDocument) {
      SwingUtilities.invokeLater(new Runnable(){
        @Override public void run(){
          if (myOrigCreationStamp > myOrigDocument.getModificationStamp()) {
            closeEditor();
          }
        }
      }
);
    }
  }
 else   if (e.getDocument() == myNewDocument) {
    commitToOriginal(e);
    if (!isValid()) {
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          closeEditor();
        }
      }
,myProject.getDisposed());
    }
  }
 else   if (e.getDocument() == myOrigDocument) {
    if (myCommittingToOriginal || myAltFullRange != null && myAltFullRange.isValid())     return;
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      @Override public void run(){
        closeEditor();
      }
    }
,myProject.getDisposed());
  }
}
