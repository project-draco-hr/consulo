{
  int origOffset=-1;
  int curOffset=0;
  for (  PsiLanguageInjectionHost.Shred shred : shreds) {
    Segment hostRangeMarker=shred.getHostRangeMarker();
    int start=shred.getRange().getStartOffset() + shred.getPrefix().length();
    int end=shred.getRange().getEndOffset() - shred.getSuffix().length();
    if (curOffset < start) {
      RangeMarker guard=myNewDocument.createGuardedBlock(curOffset,start);
      if (curOffset == 0 && shred == shreds.get(0))       guard.setGreedyToLeft(true);
      String padding=origOffset < 0 ? "" : myOrigDocument.getText().substring(origOffset,hostRangeMarker.getStartOffset());
      guard.putUserData(REPLACEMENT_KEY,fixQuotes(padding));
    }
    curOffset=end;
    origOffset=hostRangeMarker.getEndOffset();
  }
  if (curOffset < myNewDocument.getTextLength()) {
    RangeMarker guard=myNewDocument.createGuardedBlock(curOffset,myNewDocument.getTextLength());
    guard.setGreedyToRight(true);
    guard.putUserData(REPLACEMENT_KEY,"");
  }
}
