{
  final List<VirtualFile> files=collectSelectedElements(new NullableFunction<FileElement,VirtualFile>(){
    @Override public VirtualFile fun(    final FileElement element){
      VirtualFile file=element.getFile();
      if (file == null || !file.isValid())       return null;
      file=myTreeStructure.getChooserDescriptor().getFileToSelect(file);
      if (file != null) {
        FileChooserUtil.setSelectionPath(file,element.getPath());
      }
      return file;
    }
  }
);
  return VfsUtil.toVirtualFileArray(files);
}
