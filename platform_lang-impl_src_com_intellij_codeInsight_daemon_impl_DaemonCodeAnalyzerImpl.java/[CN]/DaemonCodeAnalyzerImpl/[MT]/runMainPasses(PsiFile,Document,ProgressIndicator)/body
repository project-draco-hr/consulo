{
  final List<HighlightInfo> result=new ArrayList<HighlightInfo>();
  final VirtualFile virtualFile=psiFile.getVirtualFile();
  if (virtualFile != null && !virtualFile.getFileType().isBinary()) {
    final List<TextEditorHighlightingPass> passes=TextEditorHighlightingPassRegistrarEx.getInstanceEx(myProject).instantiateMainPasses(psiFile,document);
    Collections.sort(passes,new Comparator<TextEditorHighlightingPass>(){
      @Override public int compare(      TextEditorHighlightingPass o1,      TextEditorHighlightingPass o2){
        if (o1 instanceof GeneralHighlightingPass)         return -1;
        if (o2 instanceof GeneralHighlightingPass)         return 1;
        return 0;
      }
    }
);
    for (    TextEditorHighlightingPass pass : passes) {
      pass.doCollectInformation(progress);
      result.addAll(pass.getInfos());
    }
  }
  return result;
}
