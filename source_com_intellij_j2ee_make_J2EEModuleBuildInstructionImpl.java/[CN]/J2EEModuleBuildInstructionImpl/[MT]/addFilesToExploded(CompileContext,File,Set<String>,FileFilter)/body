{
  final File target=MakeUtil.canonicalRelativePath(outputDir,getOutputRelativePath());
  final Ref<Boolean> externalDependencyFound=new Ref<Boolean>(Boolean.FALSE);
  final BuildRecipe buildRecipe=getChildInstructions(context);
  try {
    if (myBuildProperties.isExplodedEnabled()) {
      File fromFile=new File(myBuildProperties.getExplodedPath());
      MakeUtil.getInstance().copyFile(fromFile,target,context,writtenPaths,fileFilter);
      buildRecipe.visitInstructionsWithExceptions(new BuildInstructionVisitor(){
        public boolean visitInstruction(        BuildInstruction instruction) throws Exception {
          if (instruction.isExternalDependencyInstruction()) {
            instruction.addFilesToExploded(context,target,writtenPaths,fileFilter);
            externalDependencyFound.set(Boolean.TRUE);
          }
          return true;
        }
      }
,false);
    }
 else {
      buildRecipe.visitInstructionsWithExceptions(new BuildInstructionVisitor(){
        public boolean visitInstruction(        BuildInstruction instruction) throws Exception {
          instruction.addFilesToExploded(context,target,writtenPaths,fileFilter);
          if (instruction.isExternalDependencyInstruction()) {
            externalDependencyFound.set(Boolean.TRUE);
          }
          return true;
        }
      }
,false);
    }
    if (externalDependencyFound.get().booleanValue()) {
      Manifest manifest=MakeUtil.getInstance().createManifest(buildRecipe);
      File manifestFile=new File(target,JarFile.MANIFEST_NAME);
      FileUtil.createParentDirs(manifestFile);
      FileOutputStream out=new FileOutputStream(manifestFile);
      manifest.write(out);
      out.close();
    }
  }
 catch (  Exception e) {
    if (e instanceof IOException)     throw (IOException)e;
    if (e instanceof RuntimeException)     throw (RuntimeException)e;
    Degenerator.unableToDegenerateMarker();
  }
}
