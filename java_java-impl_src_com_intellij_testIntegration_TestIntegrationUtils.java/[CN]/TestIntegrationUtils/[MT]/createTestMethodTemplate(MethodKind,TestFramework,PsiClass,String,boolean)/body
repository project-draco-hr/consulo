{
  FileTemplateDescriptor templateDesc=methodKind.getFileTemplateDescriptor(descriptor);
  String templateName=templateDesc.getFileName();
  FileTemplate fileTemplate=FileTemplateManager.getInstance().getCodeTemplate(templateName);
  Template template=TemplateManager.getInstance(targetClass.getProject()).createTemplate("","");
  String templateText;
  try {
    templateText=fileTemplate.getText(new Properties());
  }
 catch (  IOException e) {
    LOG.warn(e);
    templateText=fileTemplate.getText();
  }
  if (name == null)   name=methodKind.getDefaultName();
  templateText=StringUtil.replace(templateText,"${BODY}","");
  int from=0;
  while (true) {
    int index=templateText.indexOf("${NAME}",from);
    if (index == -1)     break;
    template.addTextSegment(templateText.substring(from,index));
    if (index > 0 && !Character.isWhitespace(templateText.charAt(index - 1))) {
      name=StringUtil.capitalize(name);
    }
 else {
      name=StringUtil.decapitalize(name);
    }
    if (from == 0) {
      Expression nameExpr=new ConstantNode(name);
      template.addVariable("name",nameExpr,nameExpr,!automatic);
    }
 else {
      template.addVariableSegment("name");
    }
    from=index + "${NAME}".length();
  }
  template.addTextSegment(templateText.substring(from,templateText.length()));
  template.setToIndent(true);
  template.setToReformat(true);
  template.setToShortenLongNames(true);
  return template;
}
