{
  return ApplicationManager.getApplication().runReadAction(new NullableComputable<PsiElement>(){
    public PsiElement compute(){
      PsiFileWithStubSupport fileImpl=(PsiFileWithStubSupport)getFile();
      if (fileImpl == null)       return null;
      StubTree tree=fileImpl.getStubTree();
      boolean foreign=tree == null;
      if (foreign) {
        if (fileImpl instanceof PsiFileImpl) {
          tree=((PsiFileImpl)fileImpl).calcStubTree();
        }
 else {
          return null;
        }
      }
      StubElement stub=tree.getPlainList().get(myIndex);
      if (foreign) {
        final PsiElement cachedPsi=((StubBase)stub).getCachedPsi();
        if (cachedPsi != null)         return cachedPsi;
        final ASTNode ast=fileImpl.findTreeForStub(tree,stub);
        return ast != null ? ast.getPsi() : null;
      }
 else {
        return stub != null ? stub.getPsi() : null;
      }
    }
  }
);
}
