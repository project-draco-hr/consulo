{
  if (fileImpl == null)   return null;
  StubTree tree=fileImpl.getStubTree();
  boolean foreign=tree == null;
  if (foreign) {
    if (fileImpl instanceof PsiFileImpl) {
      tree=((PsiFileImpl)fileImpl).calcStubTree();
    }
 else {
      return null;
    }
  }
  List<StubElement<?>> list=tree.getPlainList();
  if (index >= list.size())   return null;
  StubElement stub=list.get(index);
  if (stub.getStubType() != elementType)   return null;
  if (foreign) {
    final PsiElement cachedPsi=((StubBase)stub).getCachedPsi();
    if (cachedPsi != null)     return cachedPsi;
    final ASTNode ast=fileImpl.findTreeForStub(tree,stub);
    return ast != null ? ast.getPsi() : null;
  }
 else {
    return stub.getPsi();
  }
}
