{
  if (element instanceof StubBasedPsiElement && element.isPhysical() && (element instanceof PsiCompiledElement || ((PsiFileImpl)containingFile).getContentElementType() instanceof IStubFileElementType)) {
    final StubBasedPsiElement elt=(StubBasedPsiElement)element;
    final IStubElementType elementType=elt.getElementType();
    if (elt.getStub() != null || elementType.shouldCreateStub(element.getNode())) {
      int index=calcStubIndex((StubBasedPsiElement)element);
      if (index != -1) {
        return new StubIndexReference(containingFile,index,containingFile.getLanguage(),elementType);
      }
    }
  }
  return null;
}
