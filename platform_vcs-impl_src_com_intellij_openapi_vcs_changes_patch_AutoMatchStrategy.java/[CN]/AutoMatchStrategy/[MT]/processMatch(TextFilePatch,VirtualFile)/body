{
  final String beforeName=patch.getBeforeName();
  if (beforeName == null)   return null;
  final String[] parts=beforeName.replace('\\','/').split("/");
  VirtualFile parent=file.getParent();
  int idx=parts.length - 2;
  while ((parent != null) && (idx >= 0)) {
    if (!parent.getName().equals(parts[idx])) {
      break;
    }
    parent=parent.getParent();
    --idx;
  }
  if (parent != null) {
    final FilePatchInProgress result=new FilePatchInProgress(patch,null,myBaseDir);
    result.setNewBase(parent);
    int numDown=idx + 1;
    for (int i=0; i < numDown; i++) {
      result.up();
    }
    return result;
  }
  return null;
}
