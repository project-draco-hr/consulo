{
  Map map=(Map)o;
  Element m;
  if (myMapAnnotation == null || myMapAnnotation.surroundWithTag()) {
    m=new Element(Constants.MAP);
  }
 else {
    m=(Element)context;
  }
  final Set keySet=map.keySet();
  final Object[] keys=ArrayUtil.toObjectArray(keySet);
  Arrays.sort(keys,KEY_COMPARATOR);
  for (  Object k : keys) {
    Object v=map.get(k);
    Element entry=new Element(getEntryAttributeName());
    m.addContent(entry);
    Object kNode=myKeyBinding.serialize(k,entry,filter);
    if (kNode instanceof Text) {
      Text text=(Text)kNode;
      entry.setAttribute(getKeyAttributeValue(),text.getText());
    }
 else {
      if (myMapAnnotation != null && !myMapAnnotation.surroundKeyWithTag()) {
        entry.addContent((Content)kNode);
      }
 else {
        Element key=new Element(getKeyAttributeValue());
        entry.addContent(key);
        key.addContent((Content)kNode);
      }
    }
    Object vNode=myValueBinding.serialize(v,entry,filter);
    if (vNode instanceof Text) {
      Text text=(Text)vNode;
      entry.setAttribute(getValueAttributeName(),text.getText());
    }
 else {
      if (myMapAnnotation != null && !myMapAnnotation.surroundValueWithTag()) {
        entry.addContent((Element)vNode);
      }
 else {
        Element value=new Element(getValueAttributeName());
        entry.addContent(value);
        value.addContent((Content)vNode);
      }
    }
  }
  return m;
}
