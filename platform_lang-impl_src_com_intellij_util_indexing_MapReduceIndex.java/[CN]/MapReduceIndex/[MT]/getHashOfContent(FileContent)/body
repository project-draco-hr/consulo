{
  if (myIsPsiBackedIndex && myHasSnapshotMapping && content instanceof FileContentImpl) {
    Integer previouslyCalculatedUncommittedHashId=content.getUserData(ourSavedUncommittedHashIdKey);
    if (previouslyCalculatedUncommittedHashId == null) {
      Document document=FileDocumentManager.getInstance().getCachedDocument(content.getFile());
      if (document != null) {
        PsiDocumentManager psiDocumentManager=PsiDocumentManager.getInstance(content.getProject());
        if (psiDocumentManager.isUncommited(document)) {
          PsiFile file=psiDocumentManager.getCachedPsiFile(document);
          Charset charset=((FileContentImpl)content).getCharset();
          if (file != null) {
            previouslyCalculatedUncommittedHashId=ContentHashesSupport.calcContentHashIdWithFileType(file.getText().getBytes(charset),charset,content.getFileType());
            content.putUserData(ourSavedUncommittedHashIdKey,previouslyCalculatedUncommittedHashId);
          }
        }
      }
    }
    if (previouslyCalculatedUncommittedHashId != null)     return previouslyCalculatedUncommittedHashId;
  }
  Integer previouslyCalculatedContentHashId=content.getUserData(ourSavedContentHashIdKey);
  if (previouslyCalculatedContentHashId == null) {
    byte[] hash=content instanceof FileContentImpl ? ((FileContentImpl)content).getHash() : null;
    if (hash == null) {
      Charset charset=content instanceof FileContentImpl ? ((FileContentImpl)content).getCharset() : null;
      previouslyCalculatedContentHashId=ContentHashesSupport.calcContentHashIdWithFileType(content.getContent(),charset,content.getFileType());
    }
 else {
      previouslyCalculatedContentHashId=ContentHashesSupport.enumerateHash(hash);
    }
    content.putUserData(ourSavedContentHashIdKey,previouslyCalculatedContentHashId);
  }
  return previouslyCalculatedContentHashId;
}
