{
  myIndexId=extension.getName();
  myExtension=extension;
  SharedIndicesData.registerIndex(myIndexId,extension);
  myIndexer=extension.getIndexer();
  myStorage=storage;
  myHasSnapshotMapping=extension instanceof FileBasedIndexExtension && ((FileBasedIndexExtension<Key,Value>)extension).hasSnapshotMapping() && IdIndex.ourSnapshotMappingsEnabled;
  mySnapshotIndexExternalizer=createInputsIndexExternalizer(extension,myIndexId,extension.getKeyDescriptor());
  myValueExternalizer=extension.getValueExternalizer();
  myIsPsiBackedIndex=extension instanceof PsiDependentIndex;
  myContents=createContentsIndex();
  if (!SharedIndicesData.ourFileSharedIndicesEnabled || SharedIndicesData.DO_CHECKS) {
    if (myHasSnapshotMapping) {
      myInputsSnapshotMapping=createInputSnapshotMapping();
    }
 else {
      myInputsIndex=createInputsIndex();
    }
  }
  if (DebugAssertions.EXTRA_SANITY_CHECKS && myHasSnapshotMapping && myIndexId != null) {
    myIndexingTrace=createIndexingTrace();
  }
  if (storage instanceof MemoryIndexStorage) {
    ((MemoryIndexStorage)storage).addBufferingStateListener(new MemoryIndexStorage.BufferingStateListener(){
      @Override public void bufferingStateChanged(      boolean newState){
        myInMemoryMode.set(newState);
      }
      @Override public void memoryStorageCleared(){
synchronized (myInMemoryKeys) {
          myInMemoryKeys.clear();
        }
      }
    }
);
  }
}
