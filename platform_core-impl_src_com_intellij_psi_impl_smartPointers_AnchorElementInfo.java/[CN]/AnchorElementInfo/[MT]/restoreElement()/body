{
  long typeAndId=myStubElementTypeAndId;
  int stubId=(int)typeAndId;
  if (stubId != -1) {
    PsiFile file=restoreFile();
    if (!(file instanceof PsiFileWithStubSupport))     return null;
    short index=(short)(typeAndId >> 32);
    IStubElementType stubElementType=(IStubElementType)IElementType.find(index);
    return PsiAnchor.restoreFromStubIndex((PsiFileWithStubSupport)file,stubId,stubElementType,false);
  }
  Segment psiRange=getPsiRange();
  if (psiRange == null)   return null;
  PsiFile file=restoreFile();
  if (file == null)   return null;
  PsiElement anchor=findElementInside(file,psiRange.getStartOffset(),psiRange.getEndOffset(),myType);
  if (anchor == null)   return null;
  TextRange range=anchor.getTextRange();
  if (range == null || range.getStartOffset() != psiRange.getStartOffset() || range.getEndOffset() != psiRange.getEndOffset())   return null;
  return restoreFromAnchor(anchor);
}
