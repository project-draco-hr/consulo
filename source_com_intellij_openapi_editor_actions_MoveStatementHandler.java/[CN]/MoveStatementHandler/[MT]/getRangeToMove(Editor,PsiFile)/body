{
  final SelectionModel selectionModel=editor.getSelectionModel();
  final int startLine;
  final int endLine;
  LineRange result;
  if (selectionModel.hasSelection()) {
    startLine=editor.offsetToLogicalPosition(selectionModel.getSelectionStart()).line;
    final LogicalPosition endPos=editor.offsetToLogicalPosition(selectionModel.getSelectionEnd());
    endLine=endPos.column == 0 ? endPos.line - 1 : endPos.line;
    result=new LineRange(startLine,endLine);
  }
 else {
    startLine=editor.getCaretModel().getLogicalPosition().line;
    endLine=startLine;
    result=new LineRange(startLine,endLine);
  }
  if (file instanceof PsiJavaFile) {
    result=expandLineRangeToStatement(result,editor,file);
    if (result == null)     return null;
  }
  final int maxLine=editor.offsetToLogicalPosition(editor.getDocument().getTextLength()).line;
  if (result.startLine <= 1 && !isDown)   return null;
  if (result.endLine >= maxLine - 1 && isDown)   return null;
  final PsiElement elementAt=file.findElementAt(editor.getCaretModel().getOffset());
  if (elementAt == null)   return null;
  final PsiElement guard=PsiTreeUtil.getParentOfType(elementAt,new Class[]{PsiMethod.class,PsiClassInitializer.class,PsiClass.class});
  final int insertOffset=editor.logicalPositionToOffset(new LogicalPosition(isDown ? result.endLine + 2 : result.startLine - 1,0));
  if (guard != null && !guard.getTextRange().shiftRight(1).grown(-1).contains(insertOffset))   return null;
  return result;
}
