{
  if (!isStripTrailingSpacesEnabled) {
    return true;
  }
  boolean markAsNeedsStrippingLater=false;
  CharSequence text=myText.getCharArray();
  RangeMarker caretMarker=caretOffset < 0 || caretOffset > getTextLength() ? null : createRangeMarker(caretOffset,caretOffset);
  try {
    for (int line=0; line < myLineSet.getLineCount(); line++) {
      if (inChangedLinesOnly && !myLineSet.isModified(line))       continue;
      int whiteSpaceStart=-1;
      final int lineEnd=myLineSet.getLineEnd(line) - myLineSet.getSeparatorLength(line);
      int lineStart=myLineSet.getLineStart(line);
      for (int offset=lineEnd - 1; offset >= lineStart; offset--) {
        char c=text.charAt(offset);
        if (c != ' ' && c != '\t') {
          break;
        }
        whiteSpaceStart=offset;
      }
      if (whiteSpaceStart == -1)       continue;
      if (!virtualSpaceEnabled && caretLine == line && caretMarker != null && caretMarker.getStartOffset() >= 0 && whiteSpaceStart < caretMarker.getStartOffset()) {
        markAsNeedsStrippingLater=true;
      }
 else {
        final int finalStart=whiteSpaceStart;
        ApplicationManager.getApplication().runWriteAction(new DocumentRunnable(this,project){
          @Override public void run(){
            CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
              @Override public void run(){
                deleteString(finalStart,lineEnd);
              }
            }
);
          }
        }
);
        text=myText.getCharArray();
      }
    }
  }
  finally {
    if (caretMarker != null)     caretMarker.dispose();
  }
  return markAsNeedsStrippingLater;
}
