{
  LOG.assertTrue(file.isValid());
  final PsiFileImpl psiFile=(PsiFileImpl)file;
  final CompositeElement element=psiFile.calcTreeElement();
  file.getViewProvider().beforeContentsSynchronized();
  char[] newText=newTextS.toCharArray();
  int fileLength=element.getTextLength();
  int lengthShift=newText.length - (endOffset - startOffset);
  final PsiFileImpl fileImpl=(PsiFileImpl)file;
  final char[] newFileText=lengthShift > 0 ? new char[fileLength + lengthShift] : new char[fileLength];
  SourceUtil.toBuffer(fileImpl.getTreeElement(),newFileText,0);
  System.arraycopy(newFileText,endOffset,newFileText,endOffset + lengthShift,fileLength - endOffset);
  System.arraycopy(newText,0,newFileText,startOffset,newText.length);
  reparseRange(file,startOffset,endOffset,lengthShift,newFileText);
}
