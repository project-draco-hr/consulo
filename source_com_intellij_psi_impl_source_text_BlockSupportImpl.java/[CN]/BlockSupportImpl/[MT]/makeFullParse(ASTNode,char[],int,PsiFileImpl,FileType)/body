{
  if (parent instanceof CodeFragmentElement) {
    final FileElement holderElement=new DummyHolder(fileImpl.getManager(),null).getTreeElement();
    LeafElement chameleon=Factory.createLeafElement(fileImpl.getContentElementType(),newFileText,0,textLength,-1,holderElement.getCharTable());
    TreeUtil.addChildren(holderElement,chameleon);
    ChangeUtil.replaceAllChildren((CompositeElement)parent,holderElement);
  }
 else {
    final PsiFileImpl newFile=(PsiFileImpl)PsiElementFactoryImpl.createFileFromText((PsiManagerImpl)fileImpl.getManager(),fileType,fileImpl.getName(),newFileText,0,textLength);
    final CompositeElement newFileElement=newFile.getTreeElement();
    ChangeUtil.replaceAllChildren(fileImpl.getTreeElement(),newFileElement);
  }
}
