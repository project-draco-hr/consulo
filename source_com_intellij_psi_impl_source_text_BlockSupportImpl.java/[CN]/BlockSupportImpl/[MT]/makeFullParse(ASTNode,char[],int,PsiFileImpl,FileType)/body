{
  if (parent instanceof CodeFragmentElement) {
    final FileElement holderElement=new DummyHolder(fileImpl.getManager(),null).getTreeElement();
    TreeUtil.addChildren(holderElement,fileImpl.createContentLeafElement(newFileText,0,textLength,holderElement.getCharTable()));
    parent.replaceAllChildrenToChildrenOf(holderElement);
  }
 else {
    final PsiManagerImpl manager=(PsiManagerImpl)fileImpl.getManager();
    final PsiFileImpl newFile=(PsiFileImpl)PsiElementFactoryImpl.createFileFromText(manager,fileType,fileImpl.getName(),newFileText,0,textLength);
    newFile.setOriginalFile(fileImpl);
    final ASTNode newFileElement=newFile.getTreeElement();
    final RepositoryManager repositoryManager=manager.getRepositoryManager();
    final FileElement fileElement=(FileElement)fileImpl.getNode();
    final int oldLength=fileElement.getTextLength();
    sendPsiBeforeEvent(fileImpl);
    if (repositoryManager != null)     repositoryManager.beforeChildAddedOrRemoved(fileImpl,fileElement);
    if (fileElement.getFirstChildNode() != null)     TreeUtil.removeRange((TreeElement)fileElement.getFirstChildNode(),null);
    final ASTNode firstChildNode=newFileElement.getFirstChildNode();
    if (firstChildNode != null)     TreeUtil.addChildren(fileElement,(TreeElement)firstChildNode);
    if (repositoryManager != null)     repositoryManager.beforeChildAddedOrRemoved(fileImpl,fileElement);
    manager.invalidateFile(fileImpl);
    fileElement.subtreeChanged();
    sendPsiAfterEvent(fileImpl,oldLength);
  }
}
