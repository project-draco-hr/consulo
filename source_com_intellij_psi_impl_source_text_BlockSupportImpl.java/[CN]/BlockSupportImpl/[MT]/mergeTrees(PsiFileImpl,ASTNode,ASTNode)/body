{
synchronized (PsiLock.LOCK) {
    if (newRoot instanceof FileElement) {
      ((FileElement)newRoot).setCharTable(file.getTreeElement().getCharTable());
    }
    ChameleonTransforming.transformChildren(newRoot);
    ChameleonTransforming.transformChildren(oldRoot,true);
    final PomModel model=file.getProject().getModel();
    try {
      model.runTransaction(new PomTransactionBase(file,model.getModelAspect(TreeAspect.class)){
        public PomModelEvent runInner() throws IncorrectOperationException {
          final DiffBuilder builder=new DiffBuilder(file);
          DiffTree.diff(new ASTDiffTreeStructure(oldRoot),new ASTDiffTreeStructure(newRoot),new ASTShallowComparator(),builder);
          file.subtreeChanged();
          return new TreeAspectEvent(model,builder.getEvent());
        }
      }
);
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
catch (    Throwable th) {
      LOG.error(th);
    }
 finally {
      ((PsiManagerImpl)file.getManager()).invalidateFile(file);
    }
  }
}
