{
synchronized (PsiLock.LOCK) {
    if (newRoot instanceof FileElement) {
      ((FileElement)newRoot).setCharTable(file.getTreeElement().getCharTable());
    }
    final PomModel model=file.getProject().getModel();
    try {
      newRoot.putUserData(TREE_TO_BE_REPARSED,oldRoot);
      try {
        ChameleonTransforming.transformChildren(newRoot);
      }
 catch (      BlockSupport.ReparsedSuccessfullyException e) {
        return;
      }
      ChameleonTransforming.transformChildren(oldRoot,true);
      model.runTransaction(new PomTransactionBase(file,model.getModelAspect(TreeAspect.class)){
        public PomModelEvent runInner() throws IncorrectOperationException {
          final ASTDiffBuilder builder=new ASTDiffBuilder(file);
          DiffTree.diff(new ASTDiffTreeStructure(oldRoot),new ASTDiffTreeStructure(newRoot),new ASTShallowComparator(),builder);
          file.subtreeChanged();
          return new TreeAspectEvent(model,builder.getEvent());
        }
      }
);
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
catch (    Throwable th) {
      LOG.error(th);
    }
 finally {
      ((PsiManagerImpl)file.getManager()).invalidateFile(file);
    }
  }
}
