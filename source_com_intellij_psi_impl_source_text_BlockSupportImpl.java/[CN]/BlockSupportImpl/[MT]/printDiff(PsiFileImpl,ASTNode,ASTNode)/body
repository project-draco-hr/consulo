{
synchronized (PsiLock.LOCK) {
    RepositoryManager repositoryManager=((PsiManagerImpl)file.getManager()).getRepositoryManager();
    if (repositoryManager != null) {
      repositoryManager.beforeChildAddedOrRemoved(file,oldRoot);
    }
    ((FileElement)newRoot).setCharTable(((FileElement)oldRoot).getCharTable());
    ChameleonTransforming.transformChildren(newRoot);
    final PomModel model=file.getProject().getModel();
    try {
      model.runTransaction(new PomTransactionBase(file,model.getModelAspect(TreeAspect.class)){
        public PomModelEvent runInner() throws IncorrectOperationException {
          final DiffBuilder builder=new DiffBuilder(file);
          DiffTree.diff(new ASTDiffTreeStructure(oldRoot),new ASTDiffTreeStructure(newRoot),new ASTShallowComparator(),builder);
          file.subtreeChanged();
          return new TreeAspectEvent(model,builder.getEvent());
        }
      }
);
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
catch (    Throwable th) {
      LOG.error(th);
    }
 finally {
      if (repositoryManager != null) {
        repositoryManager.beforeChildAddedOrRemoved(file,oldRoot);
      }
      ((PsiManagerImpl)file.getManager()).invalidateFile(file);
    }
  }
}
