{
  Document document=myEditor.getDocument();
  int startOffset=document.getLineStartOffset(line);
  int endOffset=document.getLineEndOffset(line);
  myStorage.removeInRange(startOffset,endOffset);
  if (indentType == IndentType.NONE) {
    TIntArrayList offsets=calculateSoftWrapOffsets(text,startOffset,endOffset,fontType,0);
    registerSoftWraps(offsets,0);
    return;
  }
  int spaceWidth=EditorUtil.getSpaceWidth(fontType,myEditor);
  int indentInColumns=getIndentSize();
  VisualPosition visual=myEditor.offsetToVisualPosition(startOffset);
  int prevLineIndentInColumns=EditorActionUtil.findFirstNonSpaceColumnOnTheLine(myEditor,visual.line);
  int indentInColumnsToUse=0;
  TIntArrayList softWrapOffsetsToUse=null;
  for (; indentInColumns >= 0; indentInColumns--) {
    TIntArrayList offsets=calculateSoftWrapOffsets(text,startOffset,endOffset,fontType,(prevLineIndentInColumns + indentInColumns) * spaceWidth);
    if (softWrapOffsetsToUse == null) {
      softWrapOffsetsToUse=offsets;
      indentInColumnsToUse=indentInColumns;
      continue;
    }
    if (softWrapOffsetsToUse.size() > offsets.size()) {
      softWrapOffsetsToUse=offsets;
      indentInColumnsToUse=indentInColumns;
    }
  }
  if (indentInColumnsToUse <= 0) {
    processLogicalLine(text,line,fontType,IndentType.NONE);
  }
 else {
    registerSoftWraps(softWrapOffsetsToUse,indentInColumnsToUse + prevLineIndentInColumns);
  }
}
