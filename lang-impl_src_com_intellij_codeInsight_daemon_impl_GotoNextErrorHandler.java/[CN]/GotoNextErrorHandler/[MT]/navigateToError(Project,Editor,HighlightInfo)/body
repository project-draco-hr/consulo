{
  int oldOffset=editor.getCaretModel().getOffset();
  final int offset=getNavigationPositionFor(info,editor.getDocument());
  final int endOffset=info.highlighter.getEndOffset();
  final ScrollingModel scrollingModel=editor.getScrollingModel();
  if (offset != oldOffset) {
    ScrollType scrollType=offset > oldOffset ? ScrollType.CENTER_DOWN : ScrollType.CENTER_UP;
    editor.getSelectionModel().removeSelection();
    editor.getCaretModel().moveToOffset(offset);
    scrollingModel.scrollToCaret(scrollType);
  }
  scrollingModel.runActionOnScrollingFinished(new Runnable(){
    public void run(){
      int maxOffset=editor.getDocument().getTextLength() - 1;
      if (maxOffset == -1)       return;
      scrollingModel.scrollTo(editor.offsetToLogicalPosition(Math.min(maxOffset,endOffset)),ScrollType.MAKE_VISIBLE);
      scrollingModel.scrollTo(editor.offsetToLogicalPosition(Math.min(maxOffset,offset)),ScrollType.MAKE_VISIBLE);
    }
  }
);
  IdeDocumentHistory.getInstance(project).includeCurrentCommandAsNavigation();
}
