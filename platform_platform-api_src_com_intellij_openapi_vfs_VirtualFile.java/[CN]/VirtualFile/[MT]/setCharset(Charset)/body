{
  final Charset old=getUserData(CHARSET_KEY);
  putUserData(CHARSET_KEY,charset);
  if (Comparing.equal(charset,old))   return;
  byte[] bom=charset == null ? null : CharsetToolkit.getBom(charset);
  byte[] existingBOM=getBOM();
  if (bom == null && charset != null && CharsetToolkit.canHaveBom(charset,existingBOM)) {
    bom=existingBOM;
  }
  setBOM(bom);
  if (old != null) {
    VirtualFileManager.getInstance().notifyPropertyChanged(this,PROP_ENCODING,old,charset);
  }
}
