{
  final Charset old=getUserData(CHARSET_KEY);
  putUserData(CHARSET_KEY,charset);
  if (Comparing.equal(charset,old))   return;
  byte[] bom=charset == null ? null : CharsetToolkit.getBom(charset);
  byte[] existingBOM=getBOM();
  if (bom == null && charset != null && CharsetToolkit.canHaveBom(charset,existingBOM)) {
    bom=existingBOM;
  }
  setBOM(bom);
  if (old != null) {
    final Application application=ApplicationManager.getApplication();
    application.invokeLater(new Runnable(){
      public void run(){
        if (isValid() && !application.isDisposed()) {
          application.runWriteAction(new Runnable(){
            public void run(){
              List<VFilePropertyChangeEvent> events=Collections.singletonList(new VFilePropertyChangeEvent(this,VirtualFile.this,PROP_ENCODING,old,charset,false));
              BulkFileListener listener=application.getMessageBus().syncPublisher(VirtualFileManager.VFS_CHANGES);
              listener.before(events);
              listener.after(events);
            }
          }
);
        }
      }
    }
,ModalityState.NON_MODAL);
  }
}
