{
  if (isRunning()) {
    throw new IllegalStateException("server already started");
  }
  ServerBootstrap bootstrap=new ServerBootstrap(channelFactory);
  bootstrap.setOption("child.tcpNoDelay",true);
  bootstrap.setPipelineFactory(new ChannelPipelineFactoryImpl(pipelineConsumers,new DefaultHandler(openChannels)));
  for (int i=0, n=tryAnyPort ? portsCount : portsCount + 1; i < n; i++) {
    int port=i == portsCount ? 0 : firstPort + i;
    try {
      openChannels.add(bootstrap.bind(new InetSocketAddress(port)));
      return port;
    }
 catch (    ChannelException e) {
      if (portsCount == 1) {
        throw e;
      }
 else       if (i == (n - 1)) {
        LOG.error(e);
      }
    }
  }
  return -1;
}
