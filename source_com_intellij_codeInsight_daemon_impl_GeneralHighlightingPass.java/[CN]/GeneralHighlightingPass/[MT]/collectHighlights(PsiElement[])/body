{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  Set<PsiElement> skipParentsSet=new THashSet<PsiElement>();
  Set<HighlightInfo> gotHighlights=new THashSet<HighlightInfo>();
  long totalTime=0;
  if (LOG.isDebugEnabled()) {
    totalTime=System.currentTimeMillis();
  }
  List<HighlightVisitor> visitors=new ArrayList<HighlightVisitor>();
  for (  HighlightVisitor visitor : myHighlightVisitors) {
    if (visitor.suitableForFile(myFile))     visitors.add(visitor);
  }
  HighlightInfoFilter[] filters=ApplicationManager.getApplication().getComponents(HighlightInfoFilter.class);
  for (  PsiElement element : elements) {
    ProgressManager.getInstance().checkCanceled();
    if (skipParentsSet.contains(element)) {
      skipParentsSet.add(element.getParent());
      continue;
    }
    HighlightInfoHolder holder=new HighlightInfoHolder(myFile,filters);
    for (int v=0; v < visitors.size(); v++) {
      HighlightVisitor visitor=visitors.get(v);
      visitor.visit(element,holder);
    }
    for (    HighlightInfo info : holder) {
      if (gotHighlights.contains(info))       continue;
      gotHighlights.add(info);
      if (info.getSeverity() == HighlightSeverity.ERROR) {
        skipParentsSet.add(element.getParent());
      }
    }
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("totalTime = " + (System.currentTimeMillis() - totalTime) / (double)1000 + "s for " + elements.length + " elements");
  }
  return gotHighlights;
}
