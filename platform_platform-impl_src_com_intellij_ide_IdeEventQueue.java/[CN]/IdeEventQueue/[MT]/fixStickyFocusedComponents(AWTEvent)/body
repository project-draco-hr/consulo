{
  if (e != null && !(e instanceof InputEvent))   return;
  final KeyboardFocusManager mgr=KeyboardFocusManager.getCurrentKeyboardFocusManager();
  if (Registry.is("actionSystem.fixStickyFocusedWindows")) {
    fixStickyWindow(mgr,mgr.getActiveWindow(),"setGlobalActiveWindow");
    fixStickyWindow(mgr,mgr.getFocusedWindow(),"setGlobalFocusedWindow");
  }
  if (Registry.is("actionSystem.fixNullFocusedComponent")) {
    final Component focusOwner=mgr.getFocusOwner();
    if (focusOwner == null || !focusOwner.isShowing() || focusOwner instanceof JFrame || focusOwner instanceof JDialog) {
      IdeEventQueue queue=IdeEventQueue.getInstance();
      boolean mouseEventsAhead=e instanceof MouseEvent || queue.peekEvent(MouseEvent.MOUSE_PRESSED) != null || queue.peekEvent(MouseEvent.MOUSE_RELEASED) != null || queue.peekEvent(MouseEvent.MOUSE_CLICKED) != null;
      if (!mouseEventsAhead) {
        Window showingWindow=mgr.getActiveWindow();
        if (showingWindow == null) {
          Method getNativeFocusOwner=ReflectionUtil.getDeclaredMethod(KeyboardFocusManager.class,"getNativeFocusOwner");
          if (getNativeFocusOwner != null) {
            getNativeFocusOwner.setAccessible(true);
            try {
              Object owner=getNativeFocusOwner.invoke(mgr);
              if (owner instanceof Component) {
                Component nativeFocusOwner=(Component)owner;
                if (nativeFocusOwner instanceof Window) {
                  showingWindow=(Window)nativeFocusOwner;
                }
 else {
                  showingWindow=SwingUtilities.getWindowAncestor(nativeFocusOwner);
                }
              }
            }
 catch (            Exception e1) {
              LOG.debug(e1);
            }
          }
        }
        if (showingWindow != null) {
          final IdeFocusManager fm=IdeFocusManager.findInstanceByComponent(showingWindow);
          Runnable requestDefaultFocus=new Runnable(){
            public void run(){
              if (UIUtil.isMeaninglessFocusOwner(mgr.getFocusOwner())) {
                if (getPopupManager().requestDefaultFocus(false))                 return;
                final Application app=ApplicationManager.getApplication();
                if (app != null && app.isActive()) {
                  fm.requestDefaultFocus(false);
                }
              }
            }
          }
;
          if (e != null) {
            fm.doWhenFocusSettlesDown(requestDefaultFocus);
          }
 else {
            requestDefaultFocus.run();
          }
        }
      }
    }
  }
}
