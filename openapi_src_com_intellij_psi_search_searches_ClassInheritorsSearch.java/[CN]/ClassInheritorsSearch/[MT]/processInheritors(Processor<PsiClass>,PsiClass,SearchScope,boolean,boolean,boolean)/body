{
  LOG.assertTrue(searchScope != null);
  if (baseClass instanceof PsiAnonymousClass)   return true;
  if (isFinal(baseClass))   return true;
  final Ref<PsiClass> currentBase=Ref.create(null);
  final Stack<PsiClass> stack=new Stack<PsiClass>();
  final Set<PsiClass> processed=new HashSet<PsiClass>();
  final Processor<PsiClass> processor=new Processor<PsiClass>(){
    public boolean process(    final PsiClass candidate){
      final Ref<Boolean> result=new Ref<Boolean>();
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          if (checkInheritance || (checkDeep && !(candidate instanceof PsiAnonymousClass))) {
            if (!candidate.isInheritor(currentBase.get(),false)) {
              result.set(true);
              return;
            }
          }
          if (PsiSearchScopeUtil.isInScope(searchScope,candidate)) {
            if (candidate instanceof PsiAnonymousClass) {
              result.set(consumer.process(candidate));
            }
 else {
              if (!consumer.process(candidate))               result.set(false);
            }
          }
        }
      }
);
      if (!result.isNull())       return result.get();
      if (checkDeep && !(candidate instanceof PsiAnonymousClass) && !isFinal(candidate)) {
        stack.push(candidate);
      }
      return true;
    }
  }
;
  stack.push(baseClass);
  final GlobalSearchScope scope=GlobalSearchScope.allScope(baseClass.getProject());
  while (!stack.isEmpty()) {
    ProgressManager.getInstance().checkCanceled();
    final PsiClass psiClass=stack.pop();
    if (processed.contains(psiClass))     continue;
    processed.add(psiClass);
    currentBase.set(psiClass);
    if (!DirectClassInheritorsSearch.search(psiClass,scope,includeAnonymous).forEach(processor))     return false;
  }
  return true;
}
