{
  final Stack<StartMarker> markers=new Stack<StartMarker>();
  final Stack<CompositeElement> nodes=new Stack<CompositeElement>();
  StartMarker curMarker=rootMarker;
  CompositeElement curNode=rootNode;
  int lexIndex=rootMarker.myLexemeIndex;
  ProductionMarker item=rootMarker.firstChild != null ? rootMarker.firstChild : rootMarker.myDoneMarker;
  while (true) {
    lexIndex=insertLeaves(lexIndex,item.myLexemeIndex,curNode);
    if (item == rootMarker.myDoneMarker)     break;
    if (item instanceof StartMarker) {
      final StartMarker marker=(StartMarker)item;
      if (!marker.myDoneMarker.myCollapse) {
        markers.push(curMarker);
        curMarker=marker;
        final CompositeElement childNode=createComposite(marker);
        curNode.rawAddChildren(childNode);
        nodes.push(curNode);
        curNode=childNode;
        item=marker.firstChild != null ? marker.firstChild : marker.myDoneMarker;
        continue;
      }
 else {
        lexIndex=collapseLeaves(curNode,marker);
      }
    }
 else     if (item instanceof ErrorItem) {
      final PsiErrorElementImpl errorElement=new PsiErrorElementImpl();
      errorElement.setErrorDescription(((ErrorItem)item).myMessage);
      curNode.rawAddChildren(errorElement);
    }
 else     if (item instanceof DoneMarker) {
      curMarker=markers.pop();
      curNode=nodes.pop();
      item=((DoneMarker)item).myStart;
    }
    item=item.next != null ? item.next : curMarker.myDoneMarker;
  }
}
