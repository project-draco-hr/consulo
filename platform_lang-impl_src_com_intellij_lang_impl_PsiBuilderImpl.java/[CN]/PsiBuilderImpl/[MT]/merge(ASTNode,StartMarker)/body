{
  final PsiFileImpl file=(PsiFileImpl)oldNode.getPsi().getContainingFile();
  final PomModel model=PomManager.getModel(file.getProject());
  try {
    model.runTransaction(new PomTransactionBase(file,model.getModelAspect(TreeAspect.class)){
      public PomModelEvent runInner() throws IncorrectOperationException {
        final MyBuilder builder=new MyBuilder(file,newNode);
        MyTreeStructure treeStructure=new MyTreeStructure(newNode,null);
        MyComparator comparator=new MyComparator(getUserDataUnprotected(CUSTOM_COMPARATOR),treeStructure);
        DiffTree.diff(new ASTStructure(oldNode),treeStructure,comparator,builder);
        file.subtreeChanged();
        return new TreeAspectEvent(model,builder.getEvent());
      }
    }
);
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
catch (  Throwable e) {
    throw new RuntimeException(UNBALANCED_MESSAGE,e);
  }
}
