{
  int index=ourModalEntities.indexOf(window);
  if (index < 0) {
    Window owner=window.getOwner();
    if (owner == null)     return (ModalityStateEx)ApplicationManager.getApplication().getNoneModalityState();
    ModalityStateEx ownerState=modalityStateForWindow(owner);
    if (window instanceof Dialog && ((Dialog)window).isModal()) {
      return ownerState.appendEntity(window);
    }
 else {
      return ownerState;
    }
  }
  ArrayList result=new ArrayList();
  for (int i=0; i < ourModalEntities.size(); i++) {
    Object entity=ourModalEntities.get(i);
    if (entity instanceof Window) {
      result.add(entity);
    }
 else     if (entity instanceof ProgressIndicator) {
      if (((ProgressIndicator)entity).isModal()) {
        result.add(entity);
      }
    }
  }
  return new ModalityStateEx(result.toArray());
}
