{
  FoldRegion[] topLevelCollapsed=myFoldingModel.fetchTopLevel();
  if (topLevelCollapsed == null)   return null;
  int start=0;
  int end=topLevelCollapsed.length - 1;
  int i=0;
  while (start <= end) {
    i=(start + end) / 2;
    FoldRegion region=topLevelCollapsed[i];
    LogicalPosition logFoldEnd=offsetToLogicalPosition(region.getEndOffset() - 1);
    VisualPosition visFoldEnd=logicalToVisualPosition(logFoldEnd);
    if (visFoldEnd.line < visual.line) {
      start=i + 1;
    }
 else {
      if (visFoldEnd.line > visual.line) {
        end=i - 1;
      }
 else {
        if (visFoldEnd.column < visual.column) {
          start=i + 1;
        }
 else {
          if (visFoldEnd.column > visual.column) {
            end=i - 1;
          }
 else {
            i--;
            break;
          }
        }
      }
    }
  }
  while (i >= 0 && i < topLevelCollapsed.length) {
    if (topLevelCollapsed[i].isValid())     break;
    i--;
  }
  if (i >= 0 && i < topLevelCollapsed.length) {
    FoldRegion region=topLevelCollapsed[i];
    LogicalPosition logFoldEnd=offsetToLogicalPosition(region.getEndOffset() - 1);
    VisualPosition visFoldEnd=logicalToVisualPosition(logFoldEnd);
    if (visFoldEnd.line > visual.line || visFoldEnd.line == visual.line && visFoldEnd.column > visual.column) {
      i--;
      if (i >= 0) {
        return topLevelCollapsed[i];
      }
 else {
        return null;
      }
    }
    return region;
  }
  return null;
}
