{
  myLastCache=null;
  final int plainSpaceWidth=getSpaceWidth(Font.PLAIN);
  final int boldSpaceWidth=getSpaceWidth(Font.BOLD);
  final int italicSpaceWidth=getSpaceWidth(Font.ITALIC);
  final int boldItalicSpaceWidth=getSpaceWidth(Font.BOLD | Font.ITALIC);
  mySpacesHaveSameWidth=plainSpaceWidth == boldSpaceWidth && plainSpaceWidth == italicSpaceWidth && plainSpaceWidth == boldItalicSpaceWidth;
  int lineHeight=getLineHeight();
  int visibleLineNumber=clip.y / lineHeight;
  int startLineNumber=xyToLogicalPosition(new Point(0,clip.y)).line;
  if (startLineNumber >= myDocument.getLineCount() || startLineNumber < 0) {
    return;
  }
  int start=myDocument.getLineStartOffset(startLineNumber);
  IterationState iterationState=new IterationState(this,start,paintSelection());
  LineIterator lIterator=createLineIterator();
  lIterator.start(start);
  if (lIterator.atEnd()) {
    return;
  }
  TextAttributes attributes=iterationState.getMergedAttributes();
  Color currentColor=attributes.getForegroundColor();
  if (currentColor == null) {
    currentColor=getForegroundColor();
  }
  Color effectColor=attributes.getEffectColor();
  EffectType effectType=attributes.getEffectType();
  int fontType=attributes.getFontType();
  myCurrentFontType=null;
  g.setColor(currentColor);
  Point position=new Point(0,visibleLineNumber * lineHeight);
  final char[] chars=myDocument.getRawChars();
  while (!iterationState.atEnd() && !lIterator.atEnd()) {
    int hEnd=iterationState.getEndOffset();
    int lEnd=lIterator.getEnd();
    if (hEnd >= lEnd) {
      FoldRegion collapsedFolderAt=myFoldingModel.getCollapsedRegionAtOffset(start);
      if (collapsedFolderAt == null) {
        drawString(g,chars,start,lEnd - lIterator.getSeparatorLength(),position,clip,effectColor,effectType,fontType,currentColor);
        position.x=0;
        if (position.y > clip.y + clip.height)         break;
        position.y+=lineHeight;
        start=lEnd;
      }
      lIterator.advance();
    }
 else {
      FoldRegion collapsedFolderAt=iterationState.getCurrentFold();
      if (collapsedFolderAt != null) {
        int foldingXStart=position.x;
        position.x=drawString(g,collapsedFolderAt.getPlaceholderText(),position,clip,effectColor,effectType,fontType,currentColor);
        BorderEffect.paintFoldedEffect(g,foldingXStart,position.y,position.x,getLineHeight(),effectColor,effectType);
      }
 else {
        if (hEnd > lEnd - lIterator.getSeparatorLength()) {
          position.x=drawString(g,chars,start,lEnd - lIterator.getSeparatorLength(),position,clip,effectColor,effectType,fontType,currentColor);
        }
 else {
          position.x=drawString(g,chars,start,hEnd,position,clip,effectColor,effectType,fontType,currentColor);
        }
      }
      iterationState.advance();
      attributes=iterationState.getMergedAttributes();
      currentColor=attributes.getForegroundColor();
      if (currentColor == null) {
        currentColor=getForegroundColor();
      }
      effectColor=attributes.getEffectColor();
      effectType=attributes.getEffectType();
      fontType=attributes.getFontType();
      start=iterationState.getStartOffset();
    }
  }
  FoldRegion collapsedFolderAt=iterationState.getCurrentFold();
  if (collapsedFolderAt != null) {
    int foldingXStart=position.x;
    int foldingXEnd=drawString(g,collapsedFolderAt.getPlaceholderText(),position,clip,effectColor,effectType,fontType,currentColor);
    BorderEffect.paintFoldedEffect(g,foldingXStart,position.y,foldingXEnd,getLineHeight(),effectColor,effectType);
  }
  flushCachedChars(g);
}
