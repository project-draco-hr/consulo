{
  int myTokenEnd=baseLexer.getTokenEnd();
  int lastState=0;
  int lastStart=0;
  final CharSequence buf=baseLexer.getBufferSequence();
  final char[] bufArray=CharArrayUtil.fromSequenceWithoutCopying(buf);
  if (seenTag) {
    FoundEnd:     while (true) {
      FoundEndOfTag:       while (baseLexer.getTokenType() != XmlTokenType.XML_END_TAG_START) {
        if (baseLexer.getTokenType() == XmlTokenType.XML_COMMENT_CHARACTERS) {
          final int end=baseLexer.getTokenEnd();
          for (int i=baseLexer.getTokenStart(); i < end; ++i) {
            if ((bufArray != null ? bufArray[i] : buf.charAt(i)) == '<' && i + 1 < end && (bufArray != null ? bufArray[i + 1] : buf.charAt(i + 1)) == '/') {
              myTokenEnd=i;
              lastStart=i - 1;
              lastState=0;
              break FoundEndOfTag;
            }
          }
        }
        lastState=baseLexer.getState();
        myTokenEnd=baseLexer.getTokenEnd();
        lastStart=baseLexer.getTokenStart();
        if (myTokenEnd == getBufferEnd())         break FoundEnd;
        baseLexer.advance();
      }
      if (baseLexer.getTokenType() != XmlTokenType.XML_END_TAG_START) {
        baseLexer.start(buf,lastStart + 1,getBufferEnd(),lastState);
        baseLexer.getTokenType();
        baseLexer.advance();
      }
 else {
        baseLexer.advance();
      }
      while (XmlTokenType.WHITESPACES.contains(baseLexer.getTokenType())) {
        baseLexer.advance();
      }
      if (baseLexer.getTokenType() == XmlTokenType.XML_NAME) {
        String name=TreeUtil.getTokenText(baseLexer);
        if (caseInsensitive)         name=name.toLowerCase();
        if ((hasSeenScript() && XmlNameHandler.TOKEN_SCRIPT.equals(name)) || (hasSeenStyle() && XmlNameHandler.TOKEN_STYLE.equals(name)) || CompletionUtil.DUMMY_IDENTIFIER_TRIMMED.equalsIgnoreCase(name)) {
          break;
        }
      }
    }
    baseLexer.start(buf,lastStart,getBufferEnd(),lastState);
    baseLexer.getTokenType();
  }
 else   if (seenAttribute) {
    while (true) {
      if (!isValidAttributeValueTokenType(baseLexer.getTokenType()))       break;
      myTokenEnd=baseLexer.getTokenEnd();
      lastState=baseLexer.getState();
      lastStart=baseLexer.getTokenStart();
      if (myTokenEnd == getBufferEnd())       break;
      baseLexer.advance();
    }
    baseLexer.start(buf,lastStart,getBufferEnd(),lastState);
    baseLexer.getTokenType();
  }
  return myTokenEnd;
}
