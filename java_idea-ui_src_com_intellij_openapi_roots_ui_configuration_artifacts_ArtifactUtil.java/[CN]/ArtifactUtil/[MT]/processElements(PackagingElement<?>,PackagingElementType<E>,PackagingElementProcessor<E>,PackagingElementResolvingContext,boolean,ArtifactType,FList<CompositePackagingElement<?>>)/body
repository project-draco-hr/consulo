{
  if (type == null || element.getType().equals(type)) {
    if (!processor.process(parents,(E)element)) {
      return false;
    }
  }
  if (element instanceof CompositePackagingElement<?>) {
    final CompositePackagingElement<?> composite=(CompositePackagingElement<?>)element;
    return processElements(composite.getChildren(),type,processor,resolvingContext,processSubstituions,artifactType,parents.prepend(composite));
  }
 else   if (element instanceof ComplexPackagingElement<?> && processSubstituions) {
    final ComplexPackagingElement<?> complexElement=(ComplexPackagingElement<?>)element;
    if (processor.shouldProcessSubstitution(complexElement)) {
      final List<? extends PackagingElement<?>> substitution=complexElement.getSubstitution(resolvingContext,artifactType);
      if (substitution != null) {
        return processElements(substitution,type,processor,resolvingContext,processSubstituions,artifactType,parents);
      }
    }
  }
  return true;
}
