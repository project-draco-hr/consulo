{
  NotifierBean notifierBean=new NotifierBean();
  ErrorBean errorBean=new ErrorBean();
  errorBean.autoInit();
  errorBean.setLastAction(IdeaLogger.ourLastActionId);
  int threadId=0;
  SubmittedReportInfo.SubmissionStatus submissionStatus=SubmittedReportInfo.SubmissionStatus.FAILED;
  do {
    try {
      ErrorReportSender sender=ErrorReportSender.getInstance();
      sender.prepareError(event.getThrowable());
      EAPSendErrorDialog dlg=new EAPSendErrorDialog();
      dlg.show();
      notifierBean.setItnLogin(ErrorReportConfigurable.getInstance().ITN_LOGIN);
      notifierBean.setItnPassword(ErrorReportConfigurable.getInstance().getPlainItnPassword());
      String description=dlg.getErrorDescription();
      String message=event.getMessage();
      errorBean.setDescription("User description: " + description + "\n"+ (message != null ? "Error message: " + message + "\n" : ""));
      if (dlg.isShouldSend()) {
        threadId=sender.sendError(notifierBean,errorBean);
        if (previousExceptionThreadId != 0) {
          ITNProxy.postNewComment(ErrorReportConfigurable.getInstance().ITN_LOGIN,ErrorReportConfigurable.getInstance().getPlainItnPassword(),threadId,"Previous exception is: " + URL_HEADER + previousExceptionThreadId);
        }
        previousExceptionThreadId=threadId;
        if (wasException) {
          ITNProxy.postNewComment(ErrorReportConfigurable.getInstance().ITN_LOGIN,ErrorReportConfigurable.getInstance().getPlainItnPassword(),threadId,"There was at least one exception before this one.");
        }
        wasException=true;
        submissionStatus=SubmittedReportInfo.SubmissionStatus.NEW_ISSUE;
        if (Messages.showYesNoDialog(parentComponent,"Error report successfuly sent. \nRequest #" + threadId + " created. Do you want to open the related request in ITN?",ReportMessages.ERROR_REPORT,Messages.getQuestionIcon()) == 0) {
          try {
            BrowserUtil.launchBrowser(URL_HEADER + threadId);
          }
 catch (          IllegalThreadStateException e) {
          }
        }
        break;
      }
 else {
        break;
      }
    }
 catch (    NoSuchEAPUserException e) {
      if (ReportMessages.isEAP)       e.printStackTrace();
      if (Messages.showYesNoDialog(parentComponent,"ITN authorization failed. Do you want to try again?",ReportMessages.ERROR_REPORT,Messages.getErrorIcon()) != 0) {
        break;
      }
    }
catch (    InternalEAPException e) {
      if (ReportMessages.isEAP)       e.printStackTrace();
      if (Messages.showYesNoDialog(parentComponent,"ITN posting failed. Do you want to try again?",ReportMessages.ERROR_REPORT,Messages.getErrorIcon()) != 0) {
        break;
      }
    }
catch (    IOException e) {
      if (ReportMessages.isEAP)       e.printStackTrace();
      if (!IOExceptionDialog.showErrorDialog(e,"Error Report","Error report sending failed.")) {
        break;
      }
    }
catch (    NewBuildException e) {
      if (ReportMessages.isEAP)       e.printStackTrace();
      Messages.showMessageDialog(parentComponent,"New EAP build " + e.getMessage() + " is available.","Warning",Messages.getWarningIcon());
      break;
    }
catch (    ThreadClosedException e) {
      submissionStatus=SubmittedReportInfo.SubmissionStatus.DUPLICATE;
      threadId=e.getThreadId();
      if (ReportMessages.isEAP)       e.printStackTrace();
      if (Messages.showYesNoDialog(parentComponent,"This error already closed with status: " + e.getMessage() + "."+ " You don't need to post it, thank you. Do you want to open it in tracker?",ReportMessages.ERROR_REPORT,Messages.getQuestionIcon()) == 0) {
        try {
          BrowserUtil.launchBrowser(URL_HEADER + threadId);
        }
 catch (        IllegalThreadStateException ex) {
        }
      }
      break;
    }
catch (    Exception e) {
      if (ReportMessages.isEAP)       e.printStackTrace();
      if (Messages.showYesNoDialog(parentComponent,"Sending failed. Do you want to try again?",ReportMessages.ERROR_REPORT,Messages.getErrorIcon()) != 0) {
        break;
      }
    }
  }
 while (true);
  return new SubmittedReportInfo(submissionStatus != SubmittedReportInfo.SubmissionStatus.FAILED ? URL_HEADER + threadId : null,String.valueOf(threadId),submissionStatus);
}
