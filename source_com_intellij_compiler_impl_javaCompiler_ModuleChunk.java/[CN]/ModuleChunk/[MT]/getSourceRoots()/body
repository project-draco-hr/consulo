{
  final List<VirtualFile> filteredRoots=new ArrayList<VirtualFile>();
  final Project project=getNodes().iterator().next().getProject();
  final CompilerConfiguration compilerConfiguration=CompilerConfiguration.getInstance(project);
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      final VirtualFile[] roots=getAllSourceRoots();
      for (int idx=0; idx < roots.length; idx++) {
        final VirtualFile root=roots[idx];
        if (mySourcesFilter != ALL_SOURCES) {
          if (fileIndex.isInTestSourceContent(root)) {
            if ((mySourcesFilter & TEST_SOURCES) == 0) {
              continue;
            }
          }
 else {
            if ((mySourcesFilter & SOURCES) == 0) {
              continue;
            }
          }
        }
        if (compilerConfiguration.isExcludedFromCompilation(root)) {
          continue;
        }
        filteredRoots.add(root);
      }
    }
  }
);
  return filteredRoots.toArray(new VirtualFile[filteredRoots.size()]);
}
