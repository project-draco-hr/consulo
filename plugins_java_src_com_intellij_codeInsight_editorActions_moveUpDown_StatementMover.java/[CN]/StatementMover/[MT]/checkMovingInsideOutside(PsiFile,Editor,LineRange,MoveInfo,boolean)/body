{
  final int offset=editor.getCaretModel().getOffset();
  PsiElement elementAtOffset=file.getViewProvider().findElementAt(offset,StdLanguages.JAVA);
  if (elementAtOffset == null)   return false;
  PsiElement guard=elementAtOffset;
  do {
    guard=PsiTreeUtil.getParentOfType(guard,PsiMethod.class,PsiClassInitializer.class,PsiClass.class,PsiComment.class);
  }
 while (guard instanceof PsiAnonymousClass);
  PsiElement brace=itIsTheClosingCurlyBraceWeAreMoving(file,editor);
  if (brace != null) {
    int line=editor.getDocument().getLineNumber(offset);
    final LineRange toMove=new LineRange(line,line + 1);
    toMove.firstElement=toMove.lastElement=brace;
    info.toMove=toMove;
  }
  if (!calcInsertOffset(file,editor,info.toMove,info,down))   return false;
  int insertOffset=down ? getLineStartSafeOffset(editor.getDocument(),info.toMove2.endLine) : editor.getDocument().getLineStartOffset(info.toMove2.startLine);
  PsiElement elementAtInsertOffset=file.getViewProvider().findElementAt(insertOffset,StdLanguages.JAVA);
  PsiElement newGuard=elementAtInsertOffset;
  do {
    newGuard=PsiTreeUtil.getParentOfType(newGuard,PsiMethod.class,PsiClassInitializer.class,PsiClass.class,PsiComment.class);
  }
 while (newGuard instanceof PsiAnonymousClass);
  if (brace != null && PsiTreeUtil.getParentOfType(brace,PsiCodeBlock.class,false) != PsiTreeUtil.getParentOfType(elementAtInsertOffset,PsiCodeBlock.class,false)) {
    info.indentSource=true;
  }
  if (newGuard == guard && isInside(insertOffset,newGuard) == isInside(offset,guard))   return true;
  if (guard instanceof PsiClass && guard.getParent() instanceof PsiClass)   return true;
  if (newGuard instanceof PsiClass && newGuard.getParent() instanceof PsiClass)   return true;
  return false;
}
