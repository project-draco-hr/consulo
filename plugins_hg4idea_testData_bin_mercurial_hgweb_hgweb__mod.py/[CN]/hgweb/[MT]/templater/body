def templater(self, req):
    proto = req.env.get('wsgi.url_scheme')
    if (proto == 'https'):
        proto = 'https'
        default_port = '443'
    else:
        proto = 'http'
        default_port = '80'
    port = req.env['SERVER_PORT']
    port = (((port != default_port) and (':' + port)) or '')
    urlbase = ('%s://%s%s' % (proto, req.env['SERVER_NAME'], port))
    staticurl = (self.config('web', 'staticurl') or (req.url + 'static/'))
    if (not staticurl.endswith('/')):
        staticurl += '/'

    def header(**map):
        yield tmpl('header', encoding=encoding.encoding, **map)

    def footer(**map):
        yield tmpl('footer', **map)

    def motd(**map):
        yield self.config('web', 'motd', '')
    vars = {}
    styles = (req.form.get('style', [None])[0], self.config('web', 'style'), 'paper')
    (style, mapfile) = templater.stylemap(styles, self.templatepath)
    if (style == styles[0]):
        vars['style'] = style
    start = (((req.url[(-1)] == '?') and '&') or '?')
    sessionvars = webutil.sessionvars(vars, start)
    if (not self.reponame):
        self.reponame = (self.config('web', 'name') or req.env.get('REPO_NAME') or req.url.strip('/') or self.repo.root)
    tmpl = templater.templater(mapfile, defaults={'url': req.url, 'staticurl': staticurl, 'urlbase': urlbase, 'repo': self.reponame, 'header': header, 'footer': footer, 'motd': motd, 'sessionvars': sessionvars, })
    return tmpl
