{
  boolean autodetectFailed=false;
  for (  FilePatch patch : myPatches) {
    VirtualFile baseDir=myDetectedBaseDirectory == null ? getBaseDirectory() : LocalFileSystem.getInstance().findFileByPath(myDetectedBaseDirectory.replace(File.separatorChar,'/'));
    int skipTopDirs=myDetectedStripLeadingDirs >= 0 ? myDetectedStripLeadingDirs : 0;
    VirtualFile fileToPatch;
    try {
      fileToPatch=patch.findFileToPatch(new ApplyPatchContext(baseDir,skipTopDirs,false,false));
    }
 catch (    IOException e) {
      myPatchesFailedToLoad.add(patch);
      continue;
    }
    if (fileToPatch == null) {
      boolean success=false;
      if (!autodetectFailed) {
        String oldDetectedBaseDirectory=myDetectedBaseDirectory;
        int oldDetectedStripLeadingDirs=myDetectedStripLeadingDirs;
        success=detectDirectoryByName(patch.getBeforeName());
        if (!success) {
          success=detectDirectoryByName(patch.getAfterName());
        }
        if (success) {
          if ((oldDetectedBaseDirectory != null && !Comparing.equal(oldDetectedBaseDirectory,myDetectedBaseDirectory)) || (oldDetectedStripLeadingDirs >= 0 && oldDetectedStripLeadingDirs != myDetectedStripLeadingDirs)) {
            myDetectedBaseDirectory=null;
            myDetectedStripLeadingDirs=-1;
            autodetectFailed=true;
          }
        }
      }
      if (!success) {
        myPatchesFailedToLoad.add(patch);
      }
    }
  }
}
