{
  TreeMap<PsiElement,TextRange> map=new TreeMap<PsiElement,TextRange>(new Comparator<PsiElement>(){
    public int compare(    PsiElement element,    PsiElement element1){
      int startOffsetDiff=element1.getTextRange().getStartOffset() - element.getTextRange().getStartOffset();
      return startOffsetDiff != 0 ? startOffsetDiff : element1.getTextRange().getEndOffset() - element.getTextRange().getEndOffset();
    }
  }
);
  final Language lang=file.getLanguage();
  if (lang != null) {
    final FoldingBuilder foldingBuilder=lang.getFoldingBuilder();
    if (foldingBuilder != null) {
      final FoldingDescriptor[] foldingDescriptors=foldingBuilder.buildFoldRegions(file.getNode(),document);
      for (int i=0; i < foldingDescriptors.length; i++) {
        FoldingDescriptor descriptor=foldingDescriptors[i];
        map.put(SourceTreeToPsiMap.treeElementToPsi(descriptor.getElement()),descriptor.getRange());
      }
      return map;
    }
  }
  if (file instanceof PsiJavaFile) {
    PsiImportList importList=((PsiJavaFile)file).getImportList();
    if (importList != null) {
      PsiImportStatementBase[] statements=importList.getAllImportStatements();
      if (statements.length > 1) {
        final TextRange rangeToFold=getRangeToFold(importList);
        if (rangeToFold != null) {
          map.put(importList,rangeToFold);
        }
      }
    }
    PsiClass[] classes=((PsiJavaFile)file).getClasses();
    for (int i=0; i < classes.length; i++) {
      ProgressManager.getInstance().checkCanceled();
      addElementsToFold(map,classes[i],document,true);
    }
    TextRange range=getFileHeader((PsiJavaFile)file);
    if (range != null && document.getLineNumber(range.getEndOffset()) > document.getLineNumber(range.getStartOffset())) {
      map.put(file,range);
    }
  }
 else   if (file instanceof XmlFile) {
    XmlDocument xmlDocument=((XmlFile)file).getDocument();
    XmlTag rootTag=xmlDocument == null ? null : xmlDocument.getRootTag();
    if (rootTag != null) {
      addElementsToFold(map,rootTag,document);
    }
  }
  return map;
}
