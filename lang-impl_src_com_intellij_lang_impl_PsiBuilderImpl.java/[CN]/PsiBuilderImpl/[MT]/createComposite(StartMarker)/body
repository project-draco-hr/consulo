{
  final IElementType type=marker.myType;
  if (type == ElementType.ERROR_ELEMENT) {
    CompositeElement childNode=new PsiErrorElementImpl();
    if (marker.myDoneMarker instanceof DoneWithErrorMarker) {
      ((PsiErrorElementImpl)childNode).setErrorDescription(((DoneWithErrorMarker)marker.myDoneMarker).myMessage);
    }
    return childNode;
  }
  if (type instanceof ICompositeElementType) {
    return (CompositeElement)((ICompositeElementType)type).createCompositeNode();
  }
  if (type == null) {
    throw new RuntimeException(UNBALANCED_MESSAGE);
  }
  final ASTFactory factory=LanguageASTFactory.INSTANCE.forLanguage(type.getLanguage());
  return factory.createComposite(type);
}
