{
  for (  AutomaticRenamerFactory renamerFactory : Extensions.getExtensions(AutomaticRenamerFactory.EP_NAME)) {
    if (renamerFactory.isApplicable(elementToRename)) {
      final List<UsageInfo> usages=new ArrayList<UsageInfo>();
      final AutomaticRenamer renamer=renamerFactory.createRenamer(elementToRename,newName,new ArrayList<UsageInfo>());
      if (renamer.hasAnythingToRename()) {
        if (!ApplicationManager.getApplication().isUnitTestMode()) {
          final AutomaticRenamingDialog renamingDialog=new AutomaticRenamingDialog(myProject,renamer);
          renamingDialog.show();
          if (!renamingDialog.isOK())           return;
        }
        final Runnable runnable=new Runnable(){
          public void run(){
            renamer.findUsages(usages,false,false);
          }
        }
;
        if (!ProgressManager.getInstance().runProcessWithProgressSynchronously(runnable,RefactoringBundle.message("searching.for.variables"),true,myProject)) {
          return;
        }
        if (!CommonRefactoringUtil.checkReadOnlyStatus(myProject,PsiUtilBase.toPsiElementArray(renamer.getElements())))         return;
        final UsageInfo[] usageInfos=usages.toArray(new UsageInfo[usages.size()]);
        final MultiMap<PsiElement,UsageInfo> classified=RenameProcessor.classifyUsages(renamer.getElements(),usageInfos);
        for (        final PsiNamedElement element : renamer.getElements()) {
          ApplicationManager.getApplication().runWriteAction(new Runnable(){
            public void run(){
              final String newElementName=renamer.getNewName(element);
              if (newElementName != null) {
                final Collection<UsageInfo> infos=classified.get(element);
                RenameUtil.doRenameGenericNamedElement(element,newElementName,infos.toArray(new UsageInfo[infos.size()]),null);
              }
            }
          }
);
        }
      }
    }
  }
}
