{
  configureFromFileText("Win1251.txt",THREE_NOTORIOUS_RUSSIAN_LETTERS);
  VirtualFile virtualFile=getFile().getVirtualFile();
  assertEquals(CharsetToolkit.UTF8_CHARSET,virtualFile.getCharset());
  Charset WINDOWS_1251=Charset.forName("windows-1251");
  virtualFile.setCharset(WINDOWS_1251);
  FileDocumentManager.getInstance().saveAllDocuments();
  assertEquals(WINDOWS_1251,virtualFile.getCharset());
  assertEquals(THREE_NOTORIOUS_RUSSIAN_LETTERS,new String(virtualFile.contentsToByteArray(),WINDOWS_1251));
  virtualFile.setCharset(CharsetToolkit.UTF8_CHARSET);
  doHighlighting();
  List<HighlightInfo> infos=DaemonCodeAnalyzerImpl.getFileLevelHighlights(getProject(),getFile());
  HighlightInfo info=assertOneElement(infos);
  assertEquals("File was loaded in a wrong encoding: 'UTF-8'",info.description);
}
