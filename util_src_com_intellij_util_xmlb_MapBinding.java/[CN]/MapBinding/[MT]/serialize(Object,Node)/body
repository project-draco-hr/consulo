{
  Map map=(Map)o;
  Document ownerDocument=XmlSerializerImpl.getOwnerDocument(context);
  Element m;
  if (myMapAnnotation == null || myMapAnnotation.surroundWithTag()) {
    m=ownerDocument.createElement(Constants.MAP);
  }
 else {
    m=(Element)context;
  }
  final Set keySet=map.keySet();
  final Object[] keys=keySet.toArray(new Object[keySet.size()]);
  Arrays.sort(keys,KEY_COMPARATOR);
  for (  Object k : keys) {
    Object v=map.get(k);
    Element entry=ownerDocument.createElement(getEntryAttributeName());
    m.appendChild(entry);
    Node kNode=myKeyBinding.serialize(k,entry);
    if (kNode instanceof Text) {
      Text text=(Text)kNode;
      entry.setAttribute(getKeyAttributeValue(),text.getWholeText());
    }
 else {
      if (myMapAnnotation != null && !myMapAnnotation.surroundKeyWithTag()) {
        entry.appendChild(kNode);
      }
 else {
        Element key=ownerDocument.createElement(getKeyAttributeValue());
        entry.appendChild(key);
        key.appendChild(kNode);
      }
    }
    Node vNode=myValueBinding.serialize(v,entry);
    if (vNode instanceof Text) {
      Text text=(Text)vNode;
      entry.setAttribute(getValueAttributeName(),text.getWholeText());
    }
 else {
      if (myMapAnnotation != null && !myMapAnnotation.surroundValueWithTag()) {
        entry.appendChild(vNode);
      }
 else {
        Element value=ownerDocument.createElement(getValueAttributeName());
        entry.appendChild(value);
        value.appendChild(vNode);
      }
    }
  }
  return m;
}
