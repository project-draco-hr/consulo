{
  PsiSubstitutor substitutor=PsiSubstitutor.EMPTY;
  PsiResolveHelper helper=JavaPsiFacade.getInstance(method.getProject()).getResolveHelper();
  final PsiTypeParameter[] typeParameters=method.getTypeParameters();
  for (  PsiTypeParameter typeParameter : typeParameters) {
    PsiType substitution=helper.getSubstitutionForTypeParameter(typeParameter,method.getReturnType(),expected,false,PsiUtil.getLanguageLevel(method));
    if (PsiType.NULL.equals(substitution)) {
      substitution=TypeConversionUtil.typeParameterErasure(typeParameter);
    }
    substitutor=substitutor.put(typeParameter,substitution);
  }
  return substitutor;
}
