{
  myKeepConnection=keepConnection;
  myTunnelProvider=new QuicklyDisposableISVNTunnelProvider(tunnelProvider);
  myAuthManager=new QuicklyDisposableISVNAuthenticationManager(authManager);
  myLog=new ProxySvnLog(SVNDebugLog.getDefaultLog());
  myCanceller=new QuicklyDisposableISVNCanceller(new MyCanceller());
  final ThrowableConvertor<SVNURL,SVNRepository,SVNException> creator=new ThrowableConvertor<SVNURL,SVNRepository,SVNException>(){
    @Override public SVNRepository convert(    SVNURL svnurl) throws SVNException {
      final SVNRepository repos=myCreator != null ? myCreator.convert(svnurl) : SVNRepositoryFactory.create(svnurl,SvnIdeaRepositoryPoolManager.this);
      repos.setAuthenticationManager(myAuthManager);
      repos.setTunnelProvider(myTunnelProvider);
      repos.setDebugLog(myLog);
      repos.setCanceller(myCanceller);
      if (myKeepConnection) {
        repos.addConnectionListener(myListener);
      }
      return repos;
    }
  }
;
  final ThrowableConsumer<Pair<SVNURL,SVNRepository>,SVNException> adjuster=new ThrowableConsumer<Pair<SVNURL,SVNRepository>,SVNException>(){
    @Override public void consume(    Pair<SVNURL,SVNRepository> pair) throws SVNException {
      SVNRepository repository=pair.getSecond();
      SVNURL url=pair.getFirst();
      repository.setLocation(url,false);
      repository.addConnectionListener(myListener);
      repository.setAuthenticationManager(myAuthManager);
      repository.setTunnelProvider(myTunnelProvider);
      repository.setDebugLog(myLog);
      repository.setCanceller(myCanceller);
    }
  }
;
  if (keepConnection) {
    CachingSvnRepositoryPool pool=new CachingSvnRepositoryPool(creator,maxCached,maxConcurrent,adjuster,ourGuard);
    myPool=pool;
    ISVNConnectionListener listener=new ISVNConnectionListener(){
      @Override public void connectionOpened(      SVNRepository repository){
        ourGuard.connectionOpened();
      }
      @Override public void connectionClosed(      SVNRepository repository){
        repository.removeConnectionListener(myListener);
        myPool.returnRepo(repository);
        ourGuard.connectionClosed();
      }
    }
;
    myListener=new QuicklyDisposableISVNConnectionListener(listener);
    ourGuard.addRepositoryPool(pool);
  }
 else {
    myListener=null;
    myPool=new NoKeepConnectionPool(creator);
  }
}
