{
  if (editor.isDisposed()) {
    CompletionServiceImpl.setCompletionPhase(CompletionPhase.NoCompletion);
    return;
  }
  Editor topLevelEditor=InjectedLanguageUtil.getTopLevelEditor(editor);
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(topLevelEditor.getDocument());
  if (file == null) {
    CompletionServiceImpl.setCompletionPhase(CompletionPhase.NoCompletion);
    return;
  }
  PsiFile topLevelFile=InjectedLanguageManager.getInstance(file.getProject()).getTopLevelFile(file);
  if (!PsiDocumentManager.getInstance(project).isCommitted(editor.getDocument())) {
    LOG.error("Non-committed document");
    PsiDocumentManager.getInstance(project).commitAllDocuments();
  }
  Editor newEditor=InjectedLanguageUtil.getEditorForInjectedLanguageNoCommit(topLevelEditor,topLevelFile);
  try {
    new CodeCompletionHandlerBase(completionType,false,autopopup,false).invokeCompletion(project,newEditor,time,false,restart);
  }
 catch (  IndexNotReadyException ignored) {
  }
}
