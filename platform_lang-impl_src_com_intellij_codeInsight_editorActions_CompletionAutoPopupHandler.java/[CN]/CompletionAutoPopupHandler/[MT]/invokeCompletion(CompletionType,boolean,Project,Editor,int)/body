{
  if (editor.isDisposed())   return;
  Editor topLevelEditor=InjectedLanguageUtil.getTopLevelEditor(editor);
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(topLevelEditor.getDocument());
  if (file == null)   return;
  PsiFile topLevelFile=InjectedLanguageUtil.getTopLevelFile(file);
  if (!PsiDocumentManager.getInstance(project).isCommitted(editor.getDocument())) {
    LOG.error("Non-committed document");
    PsiDocumentManager.getInstance(project).commitAllDocuments();
  }
  Editor newEditor=InjectedLanguageUtil.getEditorForInjectedLanguageNoCommit(topLevelEditor,topLevelFile);
  try {
    new CodeCompletionHandlerBase(completionType,false,autopopup).invokeCompletion(project,newEditor,time,false);
  }
 catch (  IndexNotReadyException ignored) {
  }
}
