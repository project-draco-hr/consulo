{
  CompletionPhase oldPhase=CompletionServiceImpl.getCompletionPhase();
  if (oldPhase instanceof CompletionPhase.EmptyAutoPopup && ((CompletionPhase.EmptyAutoPopup)oldPhase).editor != editor) {
    CompletionServiceImpl.setCompletionPhase(CompletionPhase.NoCompletion);
  }
  if (oldPhase instanceof CompletionPhase.CommittingDocuments && ((CompletionPhase.CommittingDocuments)oldPhase).restartCompletion()) {
    return Result.STOP;
  }
  LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(editor);
  if (lookup != null) {
    if (editor.getSelectionModel().hasSelection()) {
      lookup.performGuardedChange(new Runnable(){
        @Override public void run(){
          EditorModificationUtil.deleteSelectedText(editor);
        }
      }
);
    }
    return Result.STOP;
  }
  if (Character.isLetter(charTyped) || charTyped == '_') {
    AutoPopupController.getInstance(project).scheduleAutoPopup(editor,null);
    return Result.STOP;
  }
  if (CompletionServiceImpl.isPhase(CompletionPhase.EmptyAutoPopup.class,CompletionPhase.CommittingDocuments.class)) {
    CompletionServiceImpl.setCompletionPhase(CompletionPhase.NoCompletion);
  }
  return Result.CONTINUE;
}
