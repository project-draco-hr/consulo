{
  if (!CodeInsightSettings.getInstance().AUTO_POPUP_COMPLETION_LOOKUP)   return Result.CONTINUE;
  if (PowerSaveMode.isEnabled())   return Result.CONTINUE;
  if (LookupManager.getActiveLookup(editor) != null) {
    return Result.CONTINUE;
  }
  CompletionPhase oldPhase=CompletionServiceImpl.getCompletionPhase();
  if (oldPhase instanceof CompletionPhase.EmptyAutoPopup && ((CompletionPhase.EmptyAutoPopup)oldPhase).editor != editor) {
    CompletionServiceImpl.setCompletionPhase(CompletionPhase.NoCompletion);
  }
  if (!Character.isLetter(charTyped) && charTyped != '_') {
    if (CompletionServiceImpl.isPhase(CompletionPhase.EmptyAutoPopup.class,CompletionPhase.CommittingDocuments.class)) {
      CompletionServiceImpl.setCompletionPhase(CompletionPhase.NoCompletion);
    }
    return Result.CONTINUE;
  }
  if (!CompletionServiceImpl.isPhase(CompletionPhase.CommittingDocuments.class,CompletionPhase.NoCompletion.getClass())) {
    return Result.CONTINUE;
  }
  AutoPopupController.getInstance(project).scheduleAutoPopup(editor,null);
  return Result.STOP;
}
