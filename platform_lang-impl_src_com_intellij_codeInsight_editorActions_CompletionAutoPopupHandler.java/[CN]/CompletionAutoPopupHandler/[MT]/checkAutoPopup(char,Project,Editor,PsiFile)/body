{
  if (!CodeInsightSettings.getInstance().AUTO_POPUP_COMPLETION_LOOKUP)   return Result.CONTINUE;
  if (!Character.isLetter(charTyped) && charTyped != '_') {
    finishAutopopupCompletion(editor,false);
    return Result.CONTINUE;
  }
  if (getAutoPopupState(editor) != null || LookupManager.getActiveLookup(editor) != null) {
    return Result.CONTINUE;
  }
  final CharSequence text=editor.getDocument().getCharsSequence();
  final int offset=editor.getSelectionModel().hasSelection() ? editor.getSelectionModel().getSelectionEnd() : editor.getCaretModel().getOffset();
  if (text.length() > offset && Character.isUnicodeIdentifierPart(text.charAt(offset))) {
    return Result.CONTINUE;
  }
  final boolean isMainEditor=FileEditorManager.getInstance(project).getSelectedTextEditor() == editor;
  CompletionServiceImpl.setCompletionPhase(new CompletionPhase.AutoPopupAlarm());
  final Runnable request=new Runnable(){
    @Override public void run(){
      if (!CompletionServiceImpl.isPhase(CompletionPhase.AutoPopupAlarm.class))       return;
      if (project.isDisposed() || !file.isValid())       return;
      if (editor.isDisposed() || isMainEditor && FileEditorManager.getInstance(project).getSelectedTextEditor() != editor)       return;
      if (ApplicationManager.getApplication().isWriteAccessAllowed())       return;
      if (DumbService.getInstance(project).isDumb())       return;
      new CodeCompletionHandlerBase(CompletionType.BASIC,false,true).invoke(project,editor);
      final AutoPopupState state=new AutoPopupState(project,editor);
      editor.putUserData(STATE_KEY,state);
      final Lookup lookup=LookupManager.getActiveLookup(editor);
      if (lookup != null) {
        lookup.addLookupListener(new LookupAdapter(){
          @Override public void itemSelected(          LookupEvent event){
            final AutoPopupState state=getAutoPopupState(editor);
            if (state != null) {
              state.stopAutoPopup();
            }
          }
          @Override public void lookupCanceled(          LookupEvent event){
            final AutoPopupState state=getAutoPopupState(editor);
            if (event.isCanceledExplicitly() && state != null) {
              state.stopAutoPopup();
            }
          }
        }
);
      }
    }
  }
;
  if (ourTestingAutopopup) {
    ApplicationManager.getApplication().invokeLater(request);
  }
 else {
    AutoPopupController.getInstance(project).invokeAutoPopupRunnable(request,CodeInsightSettings.getInstance().AUTO_LOOKUP_DELAY);
  }
  return Result.STOP;
}
