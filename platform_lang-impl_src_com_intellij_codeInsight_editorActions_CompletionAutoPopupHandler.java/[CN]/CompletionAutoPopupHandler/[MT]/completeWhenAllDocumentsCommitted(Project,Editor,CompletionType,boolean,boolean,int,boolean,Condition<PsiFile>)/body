{
  final Document document=editor.getDocument();
  final long beforeStamp=document.getModificationStamp();
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  documentManager.cancelAndRunWhenAllCommitted("start completion when all docs committed",new Runnable(){
    @Override public void run(){
      long afterStamp=document.getModificationStamp();
      if (beforeStamp != afterStamp) {
        return;
      }
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          long afterStamp=document.getModificationStamp();
          if (beforeStamp != afterStamp) {
            return;
          }
          PsiFile file=documentManager.getPsiFile(document);
          if (file != null && condition != null && !condition.value(file))           return;
          invokeCompletion(completionType,invokedExplicitly,autopopup,project,editor,time,hasModifiers);
        }
      }
,project.getDisposed());
    }
  }
);
}
