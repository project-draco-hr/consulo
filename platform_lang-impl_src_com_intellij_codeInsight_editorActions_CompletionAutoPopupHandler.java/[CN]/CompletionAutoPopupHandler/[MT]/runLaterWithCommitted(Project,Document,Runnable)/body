{
  final long beforeStamp=document.getModificationStamp();
  PsiDocumentManager.getInstance(project).performWhenAllDocumentsAreCommitted("start completion when all docs committed",new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (beforeStamp != document.getModificationStamp()) {
            runLaterWithCommitted(project,document,runnable);
          }
 else {
            runnable.run();
          }
        }
      }
,project.getDisposed());
    }
  }
);
}
