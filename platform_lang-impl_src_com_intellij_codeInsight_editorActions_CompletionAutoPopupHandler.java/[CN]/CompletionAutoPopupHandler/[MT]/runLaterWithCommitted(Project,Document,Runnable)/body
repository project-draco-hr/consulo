{
  final long beforeStamp=document.getModificationStamp();
  ((PsiDocumentManagerImpl)PsiDocumentManager.getInstance(project)).performWhenAllCommitted(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          if (beforeStamp != document.getModificationStamp()) {
            runLaterWithCommitted(project,document,runnable);
          }
 else {
            runnable.run();
          }
        }
      }
,project.getDisposed());
    }
  }
);
}
