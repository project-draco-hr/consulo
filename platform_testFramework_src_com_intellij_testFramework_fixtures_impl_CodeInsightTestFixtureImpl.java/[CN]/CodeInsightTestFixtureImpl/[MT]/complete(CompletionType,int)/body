{
  assertInitialized();
  myEmptyLookup=false;
  new WriteCommandAction(getProject()){
    protected void run(    Result result) throws Exception {
      final CodeCompletionHandlerBase handler=new CodeCompletionHandlerBase(type){
        protected PsiFile createFileCopy(        final PsiFile file){
          final PsiFile copy=super.createFileCopy(file);
          if (myFileContext != null) {
            final PsiElement contextCopy=myFileContext.copy();
            final PsiFile containingFile=contextCopy.getContainingFile();
            if (containingFile instanceof PsiFileImpl) {
              ((PsiFileImpl)containingFile).setOriginalFile(myFileContext.getContainingFile());
            }
            setContext(copy,contextCopy);
          }
          return copy;
        }
        @Override protected void completionFinished(        final int offset1,        final int offset2,        final CompletionContext context,        final CompletionProgressIndicator indicator,        final LookupElement[] items){
          myEmptyLookup=items.length == 0;
          super.completionFinished(offset1,offset2,context,indicator,items);
        }
      }
;
      Editor editor=getCompletionEditor();
      handler.invokeCompletion(getProject(),editor,PsiUtilBase.getPsiFileInEditor(editor,getProject()),invocationCount);
    }
  }
.execute();
  return getLookupElements();
}
