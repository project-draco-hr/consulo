{
  return new WriteCommandAction<PsiFile>(getProject()){
    @Override protected void run(    Result<PsiFile> result) throws Throwable {
      try {
        if (myTempDirFixture instanceof LightTempDirTestFixtureImpl) {
          final VirtualFile file=myTempDirFixture.createFile(relativePath,fileText);
          result.setResult(PsiManager.getInstance(getProject()).findFile(file));
        }
 else {
          result.setResult(((HeavyIdeaTestFixture)myProjectFixture).addFileToProject(rootPath,relativePath,fileText));
        }
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
 finally {
        ((PsiModificationTrackerImpl)PsiManager.getInstance(getProject()).getModificationTracker()).incCounter();
      }
    }
  }
.execute().getResultObject();
}
