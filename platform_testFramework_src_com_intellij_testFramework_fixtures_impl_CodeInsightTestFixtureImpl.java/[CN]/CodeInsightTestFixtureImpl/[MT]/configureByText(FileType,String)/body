{
  assertInitialized();
  final String extension=fileType.getDefaultExtension();
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  if (fileTypeManager.getFileTypeByExtension(extension) != fileType) {
    new WriteCommandAction(getProject()){
      protected void run(      Result result) throws Exception {
        fileTypeManager.associateExtension(fileType,extension);
      }
    }
.execute();
  }
  final VirtualFile vFile;
  if (myTempDirFixture instanceof LightTempDirTestFixtureImpl) {
    final VirtualFile root=LightPlatformTestCase.getSourceRoot();
    root.refresh(false,false);
    vFile=root.findOrCreateChildData(this,"aaa." + extension);
  }
 else {
    final File tempFile=File.createTempFile("aaa","." + extension,new File(getTempDirPath()));
    vFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(tempFile);
  }
  VfsUtil.saveText(vFile,text);
  configureInner(vFile,SelectionAndCaretMarkupLoader.fromFile(vFile,getProject()));
  return myFile;
}
