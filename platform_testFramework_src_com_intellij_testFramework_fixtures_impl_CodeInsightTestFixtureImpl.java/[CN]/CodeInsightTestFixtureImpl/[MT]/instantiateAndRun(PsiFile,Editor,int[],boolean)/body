{
  Project project=file.getProject();
  ensureIndexesUpToDate(project);
  DaemonCodeAnalyzerImpl codeAnalyzer=(DaemonCodeAnalyzerImpl)DaemonCodeAnalyzer.getInstance(project);
  FileStatusMap fileStatusMap=codeAnalyzer.getFileStatusMap();
  for (  int ignoreId : toIgnore) {
    fileStatusMap.markFileUpToDate(editor.getDocument(),file,ignoreId);
  }
  fileStatusMap.allowDirt(allowDirt);
  try {
    TextEditorBackgroundHighlighter highlighter=(TextEditorBackgroundHighlighter)TextEditorProvider.getInstance().getTextEditor(editor).getBackgroundHighlighter();
    final List<TextEditorHighlightingPass> passes=highlighter.getPasses(toIgnore);
    final ProgressIndicator progress=new DaemonProgressIndicator();
    ProgressManager.getInstance().runProcess(new Runnable(){
      public void run(){
        for (        TextEditorHighlightingPass pass : passes) {
          pass.collectInformation(progress);
          pass.applyInformationToEditor();
        }
      }
    }
,progress);
    List<HighlightInfo> infos=DaemonCodeAnalyzerImpl.getHighlights(editor.getDocument(),project);
    return infos == null ? Collections.<HighlightInfo>emptyList() : new ArrayList<HighlightInfo>(infos);
  }
  finally {
    fileStatusMap.allowDirt(true);
    codeAnalyzer.clearPasses();
  }
}
