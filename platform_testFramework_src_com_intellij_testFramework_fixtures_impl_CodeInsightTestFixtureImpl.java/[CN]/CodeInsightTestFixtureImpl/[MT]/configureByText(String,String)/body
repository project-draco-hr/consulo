{
  assertInitialized();
  new WriteCommandAction(getProject()){
    @Override protected void run(    Result result) throws Throwable {
      final VirtualFile vFile;
      if (myTempDirFixture instanceof LightTempDirTestFixtureImpl) {
        final VirtualFile root=LightPlatformTestCase.getSourceRoot();
        root.refresh(false,false);
        vFile=root.findOrCreateChildData(this,fileName);
      }
 else {
        String prefix=StringUtil.getPackageName(fileName);
        if (prefix.length() < 3) {
          prefix+="___";
        }
        final File tempFile=FileUtil.createTempFile(new File(getTempDirPath()),prefix,"." + StringUtil.getShortName(fileName),true);
        vFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(tempFile);
      }
      final Document document=FileDocumentManager.getInstance().getCachedDocument(vFile);
      if (document != null) {
        FileDocumentManager.getInstance().saveDocument(document);
      }
      VfsUtil.saveText(vFile,text);
      configureInner(vFile,SelectionAndCaretMarkupLoader.fromFile(vFile,getProject()));
    }
  }
.execute();
  return myFile;
}
