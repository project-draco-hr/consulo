{
  final File iprFile=new File(path);
  File ideaDir=new File(iprFile.getParentFile(),DIRECTORY_BASED_PROJECT_DIR);
  File iwsFile=new File(iprFile.getParentFile(),getProjectName(iprFile) + WorkspaceFileType.DOT_DEFAULT_EXTENSION);
  ideaDir.mkdirs();
  File convertXml=new File(ideaDir,"convert.xml");
  FileUtil.copy(iprFile,convertXml);
  if (iwsFile.isFile()) {
    FileUtil.copy(iwsFile,new File(ideaDir,"workspace.xml"));
  }
  LocalFileSystem localFileSystem=LocalFileSystem.getInstance();
  final VirtualFile virtualFile=localFileSystem.refreshAndFindFileByPath(path);
  localFileSystem.refreshAndFindFileByIoFile(ideaDir);
  if (virtualFile == null)   return;
  if (path.endsWith(ProjectFileType.DOT_DEFAULT_EXTENSION)) {
    final ProjectManagerEx projectManager=ProjectManagerEx.getInstanceEx();
    System.setProperty("convert.project.mode","on");
    try {
      final Exception[] ex=new Exception[1];
      ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
        public void run(){
          try {
            final Project project=projectManager.loadProject(iprFile.getParentFile().getPath());
            ExtensionPoint[] points=Extensions.getRootArea().getExtensionPoints();
            for (            ExtensionPoint point : points) {
              point.getExtensions();
            }
            ApplicationManager.getApplication().invokeLater(new Runnable(){
              public void run(){
                project.save();
                projectManager.closeProject(project);
                if (postRunnable != null)                 postRunnable.run();
              }
            }
);
          }
 catch (          Exception e1) {
            ex[0]=e1;
          }
        }
      }
,"Converting Project",false,null);
      if (ex[0] != null)       throw ex[0];
    }
  finally {
      System.setProperty("convert.project.mode","off");
      FileUtil.delete(convertXml);
    }
  }
}
