{
  final PsiManager mgr=reference.getManager();
  final Project project=mgr.getProject();
  final JavaPsiFacade facade=JavaPsiFacade.getInstance(mgr.getProject());
  final PsiElementFactory factory=facade.getElementFactory();
  final GlobalSearchScope scope=GlobalSearchScope.allScope(project);
  final PsiElement insertedElement;
  final PsiElement parent=reference.getParent();
  if (parent instanceof PsiReferenceExpression) {
    final PsiClass aClass=facade.findClass(className,scope);
    if (aClass == null)     return;
    ((PsiReferenceExpression)parent).setQualifierExpression(factory.createReferenceExpression(aClass));
    insertedElement=((PsiReferenceExpression)parent).getQualifierExpression();
  }
 else {
    final PsiJavaCodeReferenceElement newReference=factory.createReferenceElementByFQClassName(className,scope);
    insertedElement=reference.replace(newReference);
  }
  final CodeStyleManager codeStyleManager=CodeStyleManager.getInstance(mgr.getProject());
  final PsiElement shortenedElement=JavaCodeStyleManager.getInstance(mgr.getProject()).shortenClassReferences(insertedElement);
  codeStyleManager.reformat(shortenedElement);
}
