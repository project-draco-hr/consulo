{
  if (expression == null)   return wasLiteral;
  if (expression instanceof PsiBinaryExpression) {
    final PsiType type=expression.getType();
    if (type != null && type.equalsToText("java.lang.String") && ((PsiBinaryExpression)expression).getOperationSign().getTokenType() == JavaTokenType.PLUS) {
      wasLiteral=calculateFormatAndArguments(((PsiBinaryExpression)expression).getLOperand(),formatString,args,argsToCombine,wasLiteral);
      wasLiteral=calculateFormatAndArguments(((PsiBinaryExpression)expression).getROperand(),formatString,args,argsToCombine,wasLiteral);
    }
 else     if (expression instanceof PsiLiteralExpression && ((PsiLiteralExpression)expression).getValue() instanceof String) {
      appendArgument(args,argsToCombine,formatString);
      argsToCombine.clear();
      formatString.append(((PsiLiteralExpression)expression).getValue());
      return true;
    }
 else     if (wasLiteral) {
      appendArgument(args,Collections.singletonList(expression),formatString);
    }
 else {
      argsToCombine.add(expression);
    }
  }
 else   if (expression instanceof PsiLiteralExpression && ((PsiLiteralExpression)expression).getValue() instanceof String) {
    appendArgument(args,argsToCombine,formatString);
    argsToCombine.clear();
    formatString.append(((PsiLiteralExpression)expression).getValue());
    return true;
  }
 else   if (wasLiteral) {
    appendArgument(args,Collections.singletonList(expression),formatString);
  }
 else {
    argsToCombine.add(expression);
  }
  return wasLiteral;
}
