{
  super.setUp();
  initApplication();
  ComponentAdapter component=getApplication().getPicoContainer().getComponentAdapter(ProgressManager.class.getName());
  if (component == null) {
    getApplication().getPicoContainer().registerComponent(new AbstractComponentAdapter(ProgressManager.class.getName(),Object.class){
      @Override public Object getComponentInstance(      PicoContainer container) throws PicoInitializationException, PicoIntrospectionException {
        return new ProgressManagerImpl(getApplication());
      }
      @Override public void verify(      PicoContainer container) throws PicoIntrospectionException {
      }
    }
);
  }
  Extensions.registerAreaClass(ExtensionAreas.IDEA_PROJECT,null);
  myProject=new MockProjectEx(getTestRootDisposable());
  myPsiManager=new MockPsiManager(myProject);
  myFileFactory=new PsiFileFactoryImpl(myPsiManager);
  final MutablePicoContainer appContainer=getApplication().getPicoContainer();
  registerComponentInstance(appContainer,MessageBus.class,MessageBusFactory.newMessageBus(getApplication()));
  registerComponentInstance(appContainer,SchemesManagerFactory.class,new MockSchemesManagerFactory());
  final MockEditorFactory editorFactory=new MockEditorFactory();
  registerComponentInstance(appContainer,EditorFactory.class,editorFactory);
  registerComponentInstance(appContainer,FileDocumentManager.class,new MockFileDocumentManagerImpl(new Function<CharSequence,Document>(){
    @Override public Document fun(    CharSequence charSequence){
      return editorFactory.createDocument(charSequence);
    }
  }
,FileDocumentManagerImpl.DOCUMENT_KEY));
  registerComponentInstance(appContainer,PsiDocumentManager.class,new MockPsiDocumentManager());
  myLanguage=myLanguage == null && myDefinitions.length > 0 ? myDefinitions[0].getFileNodeType().getLanguage() : myLanguage;
  registerComponentInstance(appContainer,FileTypeManager.class,new MockFileTypeManager(new MockLanguageFileType(myLanguage,myFileExt)));
  registerApplicationService(PsiBuilderFactory.class,new PsiBuilderFactoryImpl());
  registerApplicationService(ReferenceProvidersRegistry.class,new ReferenceProvidersRegistryImpl());
  myProject.registerService(CachedValuesManager.class,new CachedValuesManagerImpl(myProject,new PsiCachedValuesFactory(myPsiManager)));
  myProject.registerService(PsiManager.class,myPsiManager);
  myProject.registerService(StartupManager.class,new StartupManagerImpl(myProject));
  registerExtensionPoint(FileTypeFactory.FILE_TYPE_FACTORY_EP,FileTypeFactory.class);
  registerExtensionPoint(ASTLazyFactory.EP.getExtensionPointName(),ASTLazyFactory.class);
  registerExtensionPoint(ASTLeafFactory.EP.getExtensionPointName(),ASTLeafFactory.class);
  registerExtensionPoint(ASTCompositeFactory.EP.getExtensionPointName(),ASTCompositeFactory.class);
  registerExtensionPoint(PsiElementFactory.EP.getExtensionPointName(),PsiElementFactory.class);
  registerExtension(ASTLazyFactory.EP.getExtensionPointName(),new DefaultASTLazyFactory(),LoadingOrder.LAST);
  registerExtension(ASTLeafFactory.EP.getExtensionPointName(),new DefaultASTLeafFactory(),LoadingOrder.LAST);
  registerExtension(ASTCompositeFactory.EP.getExtensionPointName(),new DefaultASTCompositeFactory(),LoadingOrder.LAST);
  registerExtension(PsiElementFactory.EP.getExtensionPointName(),new DefaultPsiElementFactory(),LoadingOrder.LAST);
  for (  ParserDefinition definition : myDefinitions) {
    addExplicitExtension(LanguageParserDefinitions.INSTANCE,definition.getFileNodeType().getLanguage(),definition);
  }
}
