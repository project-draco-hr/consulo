{
  FacetManager facetManager=FacetManager.getInstance(module);
  AndroidFacet facet=facetManager.createFacet(AndroidFacet.getFacetType(),"Android",null);
  final AndroidFacetConfiguration configuration=facet.getConfiguration();
  AndroidSdk sdk=AndroidSdk.parse(sdkPath,new EmptySdkLog());
  IAndroidTarget target=sdk.findTargetByName(testProfile.getAndroidTargetName());
  Library androidLibrary=findAndroidLibrary(module);
  configuration.setAndroidPlatform(new AndroidPlatform(sdk,target,androidLibrary));
  final ModifiableFacetModel model=facetManager.createModifiableModel();
  model.addFacet(facet);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      model.commit();
    }
  }
);
  Disposer.register(module,new Disposable(){
    @Override public void dispose(){
      configuration.setAndroidPlatform(null);
    }
  }
);
  return facet;
}
