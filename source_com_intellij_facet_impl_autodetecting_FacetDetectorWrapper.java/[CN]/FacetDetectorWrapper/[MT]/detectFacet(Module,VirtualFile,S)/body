{
  if (!myAutodetectionFilter.isAutodetectionEnabled(module,myFacetType,virtualFile.getUrl())) {
    LOG.debug("Autodetection disabled for " + myFacetType.getPresentableName() + " facets in module "+ module.getName());
    return null;
  }
  Facet underlyingFacet=null;
  FacetTypeId underlyingFacetType=myFacetType.getUnderlyingFacetType();
  if (underlyingFacetType != null) {
    underlyingFacet=FacetFinder.getInstance(module.getProject()).findFacet(virtualFile,underlyingFacetType);
    if (underlyingFacet == null) {
      LOG.debug("Underlying " + underlyingFacetType + " facet not found for "+ virtualFile.getUrl());
      return null;
    }
  }
  Collection<F> facets=FacetManager.getInstance(module).getFacetsByType(myFacetType.getId());
  Map<C,F> configurations=new HashMap<C,F>();
  for (  F facet : facets) {
    configurations.put(facet.getConfiguration(),facet);
  }
  C result=myFacetDetector.detectFacet(source,Collections.unmodifiableCollection(configurations.keySet()));
  if (result == null) {
    return null;
  }
  if (configurations.containsKey(result)) {
    return configurations.get(result);
  }
  String name=generateName(module);
  final Facet facet=FacetManagerImpl.createFacet(myFacetType,module,name,result,underlyingFacet);
  facet.setImplicit(true);
  new WriteAction(){
    protected void run(    final Result result){
      ModifiableFacetModel model=FacetManager.getInstance(facet.getModule()).createModifiableModel();
      model.addFacet(facet);
      model.commit();
    }
  }
.execute();
  return facet;
}
