{
  if (PING_INTERVAL <= 0L) {
    return;
  }
  final long allowedIdlePeriod=2 * PING_INTERVAL;
  myScheduler.scheduleAtFixedRate(new Runnable(){
    private long myStartTime;
    @Override public void run(){
      final long now=System.currentTimeMillis();
      final long lastPing=myLastPingTime;
      if (lastPing > 0L) {
        final long elapsed=now - lastPing;
        if (elapsed > allowedIdlePeriod) {
          doStop(elapsed);
        }
      }
 else {
        final long start=myStartTime;
        if (start > 0) {
          final long elapsed=now - start;
          if (elapsed > 5 * PING_INTERVAL) {
            doStop(elapsed);
          }
        }
 else {
          myStartTime=now;
        }
      }
    }
    private void doStop(    long elapsedTime){
      if (!myMessageHandler.hasRunningBuilds()) {
        try {
          System.out.println("Stopping compile server; reason: no pings from client received in " + elapsedTime + " ms");
          myMessageHandler.cancelAllBuildsAndClearState();
          stop();
        }
  finally {
          System.exit(0);
        }
      }
    }
  }
,allowedIdlePeriod,allowedIdlePeriod,TimeUnit.MILLISECONDS);
}
