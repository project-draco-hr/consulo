{
  final PsiStatement initialization=forStatement.getInitialization();
  if (!(initialization instanceof PsiDeclarationStatement)) {
    return false;
  }
  final PsiDeclarationStatement declaration=(PsiDeclarationStatement)initialization;
  final PsiElement[] declaredElements=declaration.getDeclaredElements();
  if (declaredElements.length != 1) {
    return false;
  }
  final PsiElement declaredElement=declaredElements[0];
  if (!(declaredElement instanceof PsiVariable)) {
    return false;
  }
  final PsiVariable variable=(PsiVariable)declaredElement;
  if (!TypeUtils.variableHasTypeOrSubtype(variable,CommonClassNames.JAVA_UTIL_ITERATOR,"java.util.ListIterator")) {
    return false;
  }
  final PsiExpression initialValue=variable.getInitializer();
  if (initialValue == null) {
    return false;
  }
  if (!(initialValue instanceof PsiMethodCallExpression)) {
    return false;
  }
  final PsiMethodCallExpression initialCall=(PsiMethodCallExpression)initialValue;
  final PsiReferenceExpression initialMethodExpression=initialCall.getMethodExpression();
  @NonNls final String initialCallName=initialMethodExpression.getReferenceName();
  if (!HardcodedMethodConstants.ITERATOR.equals(initialCallName) && !"listIterator".equals(initialCallName)) {
    return false;
  }
  final PsiExpressionList argumentList=initialCall.getArgumentList();
  final PsiExpression[] arguments=argumentList.getExpressions();
  if (arguments.length != 0) {
    return false;
  }
  final PsiExpression qualifier=initialMethodExpression.getQualifierExpression();
  final PsiClass qualifierClass;
  if (qualifier == null) {
    qualifierClass=ClassUtils.getContainingClass(initialMethodExpression);
    if (ignoreUntypedCollections) {
      final PsiClassType type=(PsiClassType)variable.getType();
      final PsiType[] parameters=type.getParameters();
      if (parameters.length == 0) {
        return false;
      }
    }
  }
 else {
    final PsiType qualifierType=qualifier.getType();
    if (!(qualifierType instanceof PsiClassType)) {
      return false;
    }
    final PsiClassType classType=(PsiClassType)qualifierType;
    qualifierClass=classType.resolve();
    if (ignoreUntypedCollections) {
      final PsiClassType type=(PsiClassType)variable.getType();
      final PsiType[] parameters=type.getParameters();
      final PsiType[] parameters1=classType.getParameters();
      if (parameters.length == 0 && parameters1.length == 0) {
        return false;
      }
    }
  }
  if (qualifierClass == null) {
    return false;
  }
  if (!InheritanceUtil.isInheritor(qualifierClass,CommonClassNames.JAVA_LANG_ITERABLE) && !InheritanceUtil.isInheritor(qualifierClass,CommonClassNames.JAVA_UTIL_COLLECTION)) {
    return false;
  }
  final PsiExpression condition=forStatement.getCondition();
  if (!isHasNext(condition,variable)) {
    return false;
  }
  final PsiStatement update=forStatement.getUpdate();
  if (update != null && !(update instanceof PsiEmptyStatement)) {
    return false;
  }
  final PsiStatement body=forStatement.getBody();
  if (body == null) {
    return false;
  }
  if (calculateCallsToIteratorNext(variable,body) != 1) {
    return false;
  }
  if (isIteratorMethodCalled(variable,body)) {
    return false;
  }
  return !VariableAccessUtils.variableIsReturned(variable,body) && !VariableAccessUtils.variableIsAssigned(variable,body) && !VariableAccessUtils.variableIsPassedAsMethodArgument(variable,body);
}
