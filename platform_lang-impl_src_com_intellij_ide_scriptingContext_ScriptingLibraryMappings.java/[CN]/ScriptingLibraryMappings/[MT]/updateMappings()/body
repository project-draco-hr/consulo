{
  myLibraryManager.reset();
  Map<VirtualFile,ScriptingLibraryTable.LibraryModel> map=getMappings();
  for (  VirtualFile file : map.keySet()) {
    ScriptingLibraryTable.LibraryModel value=getImmediateMapping(file);
    if (value instanceof CompoundLibrary) {
      CompoundLibrary container=(CompoundLibrary)value;
      ScriptingLibraryTable.LibraryModel[] libModels=container.getLibraries().toArray(new ScriptingLibraryTable.LibraryModel[container.getLibraryCount()]);
      CompoundLibrary newContainer=new CompoundLibrary();
      for (      ScriptingLibraryTable.LibraryModel libraryModel : libModels) {
        String libName=libraryModel.getName();
        if (myLibraryManager.getLibraryByName(libName) != null) {
          newContainer.addLibrary(libraryModel);
        }
      }
      newContainer.applyChanges();
      setMapping(file,newContainer.isEmpty() ? null : newContainer);
    }
  }
}
