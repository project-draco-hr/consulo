{
  final PsiElement[] elements=context != null ? LangDataKeys.PSI_ELEMENT_ARRAY.getData(context.getDataContext()) : null;
  if (elements != null && TestNGPatternConfigurationProducer.collectTestMembers(elements).size() > 1) {
    return null;
  }
  PsiClass psiClass=null;
  PsiElement element=location.getPsiElement();
  while (element != null) {
    if (element instanceof PsiClass && isTestNGClass(psiClass)) {
      psiClass=(PsiClass)element;
      break;
    }
 else     if (element instanceof PsiMember) {
      psiClass=((PsiMember)element).getContainingClass();
      if (isTestNGClass(psiClass)) {
        break;
      }
    }
 else     if (element instanceof PsiClassOwner) {
      final PsiClass[] classes=((PsiClassOwner)element).getClasses();
      if (classes.length == 1) {
        psiClass=classes[0];
        break;
      }
    }
    element=element.getParent();
  }
  if (!isTestNGClass(psiClass))   return null;
  myPsiElement=psiClass;
  final Project project=location.getProject();
  RunnerAndConfigurationSettings settings=cloneTemplateConfiguration(project,context);
  final TestNGConfiguration configuration=(TestNGConfiguration)settings.getConfiguration();
  setupConfigurationModule(context,configuration);
  final Module originalModule=configuration.getConfigurationModule().getModule();
  configuration.setClassConfiguration(psiClass);
  PsiMethod method=PsiTreeUtil.getParentOfType(location.getPsiElement(),PsiMethod.class,false);
  while (method != null) {
    if (TestNGUtil.hasTest(method)) {
      configuration.setMethodConfiguration(PsiLocation.fromPsiElement(project,method));
      myPsiElement=method;
    }
    method=PsiTreeUtil.getParentOfType(method,PsiMethod.class);
  }
  configuration.restoreOriginalModule(originalModule);
  settings.setName(configuration.getName());
  JavaRunConfigurationExtensionManager.getInstance().extendCreatedConfiguration(configuration,location);
  return settings;
}
