{
  if (isDummyEnvironment())   return null;
  Window window=findWindowForBalloon(project);
  if (window instanceof IdeFrame) {
    BalloonLayout layout=((IdeFrame)window).getBalloonLayout();
    if (layout == null)     return null;
    final ProjectManager projectManager=ProjectManager.getInstance();
    final boolean noProjects=projectManager.getOpenProjects().length == 0;
    final boolean sticky=NotificationDisplayType.STICKY_BALLOON == displayType || noProjects;
    Ref<Object> layoutDataRef=newEnabled() ? new Ref<Object>() : null;
    if (layoutDataRef != null) {
      if (project == null || project.isDefault()) {
        BalloonLayoutData layoutData=new BalloonLayoutData();
        layoutData.groupId="";
        layoutData.welcomeScreen=layout instanceof WelcomeBalloonLayoutImpl;
        layoutData.type=notification.getType();
        layoutDataRef.set(layoutData);
      }
 else {
        BalloonLayoutData.MergeInfo mergeData=((BalloonLayoutImpl)layout).preMerge(notification);
        if (mergeData != null) {
          BalloonLayoutData layoutData=new BalloonLayoutData();
          layoutData.mergeData=mergeData;
          layoutDataRef.set(layoutData);
        }
      }
    }
    final Balloon balloon=createBalloon((IdeFrame)window,notification,false,false,layoutDataRef,project != null ? project : ApplicationManager.getApplication());
    if (notification.isExpired()) {
      return null;
    }
    layout.add(balloon,layoutDataRef == null ? null : layoutDataRef.get());
    if (layoutDataRef != null && layoutDataRef.get() instanceof BalloonLayoutData) {
      ((BalloonLayoutData)layoutDataRef.get()).project=project;
    }
    ((BalloonImpl)balloon).startFadeoutTimer(0);
    if (NotificationDisplayType.BALLOON == displayType) {
      FrameStateManager.getInstance().getApplicationActive().doWhenDone(new Runnable(){
        @Override public void run(){
          if (balloon.isDisposed()) {
            return;
          }
          if (!sticky) {
            if (newEnabled()) {
              ((BalloonImpl)balloon).startSmartFadeoutTimer(10000);
            }
 else {
              ((BalloonImpl)balloon).startFadeoutTimer(0);
              ((BalloonImpl)balloon).setHideOnClickOutside(true);
            }
          }
 else           if (noProjects && !newEnabled()) {
            projectManager.addProjectManagerListener(new ProjectManagerAdapter(){
              @Override public void projectOpened(              Project project){
                projectManager.removeProjectManagerListener(this);
                if (!balloon.isDisposed()) {
                  ((BalloonImpl)balloon).startFadeoutTimer(300);
                }
              }
            }
);
          }
        }
      }
);
    }
    return balloon;
  }
  return null;
}
