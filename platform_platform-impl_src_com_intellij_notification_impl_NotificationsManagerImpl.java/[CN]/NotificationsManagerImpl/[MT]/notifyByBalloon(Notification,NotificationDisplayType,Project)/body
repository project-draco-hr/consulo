{
  if (ApplicationManager.getApplication().isUnitTestMode())   return null;
  Window window=findWindowForBalloon(project);
  if (window instanceof IdeFrameImpl) {
    final ProjectManager projectManager=ProjectManager.getInstance();
    final boolean noProjects=projectManager.getOpenProjects().length == 0;
    final boolean sticky=NotificationDisplayType.STICKY_BALLOON == displayType || noProjects;
    final Balloon balloon=createBalloon(notification,false,false);
    Disposer.register(project != null ? project : ApplicationManager.getApplication(),balloon);
    if (notification.isExpired()) {
      return null;
    }
    ((IdeFrameImpl)window).getBalloonLayout().add(balloon);
    if (NotificationDisplayType.BALLOON == displayType) {
      FrameStateManager.getInstance().getApplicationActive().doWhenDone(new Runnable(){
        @Override public void run(){
          if (balloon.isDisposed()) {
            return;
          }
          if (!sticky) {
            ((BalloonImpl)balloon).startFadeoutTimer(3000);
          }
 else           if (noProjects) {
            projectManager.addProjectManagerListener(new ProjectManagerAdapter(){
              @Override public void projectOpened(              Project project){
                projectManager.removeProjectManagerListener(this);
                if (!balloon.isDisposed()) {
                  ((BalloonImpl)balloon).startFadeoutTimer(300);
                }
              }
            }
);
          }
        }
      }
);
    }
    return balloon;
  }
  return null;
}
