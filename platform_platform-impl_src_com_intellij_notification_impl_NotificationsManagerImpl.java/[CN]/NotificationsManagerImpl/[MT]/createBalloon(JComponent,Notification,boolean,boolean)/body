{
  final JEditorPane text=new JEditorPane();
  text.setEditorKit(UIUtil.getHTMLEditorKit());
  final HyperlinkListener listener=NotificationsUtil.wrapListener(notification);
  if (listener != null) {
    text.addHyperlinkListener(listener);
  }
  final JLabel label=new JLabel(NotificationsUtil.buildHtml(notification,null));
  text.setText(NotificationsUtil.buildHtml(notification,"width:" + Math.min(JBUI.scale(350),label.getPreferredSize().width) + "px;"));
  text.setEditable(false);
  text.setOpaque(false);
  if (UIUtil.isUnderNimbusLookAndFeel()) {
    text.setBackground(UIUtil.TRANSPARENT_COLOR);
  }
  text.setBorder(null);
  final JPanel content=new NonOpaquePanel(new BorderLayout((int)(label.getIconTextGap() * 1.5),(int)(label.getIconTextGap() * 1.5)));
  if (text.getCaret() != null) {
    text.setCaretPosition(0);
  }
  JScrollPane pane=new JScrollPane(text);
  pane.setBorder(BorderFactory.createEmptyBorder());
  pane.setOpaque(false);
  pane.getViewport().setOpaque(false);
  content.add(pane,BorderLayout.CENTER);
  final NonOpaquePanel north=new NonOpaquePanel(new BorderLayout());
  north.add(new JLabel(NotificationsUtil.getIcon(notification)),BorderLayout.NORTH);
  content.add(north,BorderLayout.WEST);
  content.setBorder(new EmptyBorder(2,4,2,4));
  Dimension preferredSize=text.getPreferredSize();
  text.setSize(preferredSize);
  Dimension paneSize=new Dimension(text.getPreferredSize());
  int maxHeight=JBUI.scale(400);
  int maxWidth=JBUI.scale(600);
  if (windowComponent != null) {
    maxHeight=Math.min(maxHeight,windowComponent.getHeight() - 20);
    maxWidth=Math.min(maxWidth,windowComponent.getWidth() - 20);
  }
  if (paneSize.height > maxHeight) {
    pane.setPreferredSize(new Dimension(Math.min(maxWidth,paneSize.width + UIUtil.getScrollBarWidth()),maxHeight));
  }
 else   if (paneSize.width > maxWidth) {
    pane.setPreferredSize(new Dimension(maxWidth,paneSize.height + UIUtil.getScrollBarWidth()));
  }
  final BalloonBuilder builder=JBPopupFactory.getInstance().createBalloonBuilder(content);
  builder.setFillColor(new JBColor(Gray._234,Gray._92)).setCloseButtonEnabled(true).setShowCallout(showCallout).setShadow(false).setHideOnClickOutside(hideOnClickOutside).setHideOnAction(hideOnClickOutside).setHideOnKeyOutside(hideOnClickOutside).setHideOnFrameResize(false).setBorderColor(new JBColor(Gray._180,Gray._110));
  final Balloon balloon=builder.createBalloon();
  balloon.setAnimationEnabled(false);
  notification.setBalloon(balloon);
  return balloon;
}
