{
  this.editor=editor;
  final PsiActionSupportFactory factory=PsiActionSupportFactory.getInstance();
  copyPasteSupport=factory.createPsiBasedCopyPasteSupport(editor.getProject(),this,new PsiActionSupportFactory.PsiElementSelector(){
    public PsiElement[] getSelectedElements(){
      return (PsiElement[])getData(DataConstants.PSI_ELEMENT_ARRAY);
    }
  }
);
  deleteProvider=factory.createPsiBasedDeleteProvider();
  ImageDocument document=imageComponent.getDocument();
  document.addChangeListener(changeListener);
  TransparencyChessboardOptions chessboardOptions=editorOptions.getTransparencyChessboardOptions();
  GridOptions gridOptions=editorOptions.getGridOptions();
  imageComponent.setTransparencyChessboardCellSize(chessboardOptions.getCellSize());
  imageComponent.setTransparencyChessboardWhiteColor(chessboardOptions.getWhiteColor());
  imageComponent.setTransparencyChessboardBlankColor(chessboardOptions.getBlackColor());
  imageComponent.setGridLineZoomFactor(gridOptions.getLineZoomFactor());
  imageComponent.setGridLineSpan(gridOptions.getLineSpan());
  imageComponent.setGridLineColor(gridOptions.getLineColor());
  ImageContainerPane view=new ImageContainerPane(imageComponent);
  view.addMouseListener(new EditorMouseAdapter());
  view.addMouseListener(new FocusRequester());
  JScrollPane scrollPane=new JScrollPane(view);
  scrollPane.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_AS_NEEDED);
  scrollPane.setHorizontalScrollBarPolicy(JScrollPane.HORIZONTAL_SCROLLBAR_AS_NEEDED);
  scrollPane.addMouseWheelListener(wheelAdapter);
  setLayout(new BorderLayout());
  ActionManager actionManager=ActionManager.getInstance();
  ActionGroup actionGroup=(ActionGroup)actionManager.getAction(ImageEditorActions.GROUP_TOOLBAR);
  ActionToolbar actionToolbar=actionManager.createActionToolbar(ImageEditorActions.ACTION_PLACE,actionGroup,true);
  actionToolbar.setTargetComponent(this);
  JComponent toolbarPanel=actionToolbar.getComponent();
  toolbarPanel.addMouseListener(new FocusRequester());
  JLabel errorLabel=new JLabel(ImagesBundle.message("error.broken.image.file.format"),Messages.getErrorIcon(),JLabel.CENTER);
  JPanel errorPanel=new JPanel(new BorderLayout());
  errorPanel.add(errorLabel,BorderLayout.CENTER);
  contentPanel=new JPanel(new CardLayout());
  contentPanel.add(scrollPane,IMAGE_PANEL);
  contentPanel.add(errorPanel,ERROR_PANEL);
  JPanel topPanel=new JPanel(new BorderLayout());
  topPanel.add(toolbarPanel,BorderLayout.WEST);
  infoLabel=new JLabel((String)null,JLabel.RIGHT);
  topPanel.add(infoLabel,BorderLayout.EAST);
  add(topPanel,BorderLayout.NORTH);
  add(contentPanel,BorderLayout.CENTER);
  updateInfo();
}
