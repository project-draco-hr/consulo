{
  boolean success=true;
  for (  Module module : chunk.getModules()) {
    final AndroidFacet facet=AndroidJpsUtil.getFacet(module);
    if (facet == null || !facet.isLibrary()) {
      continue;
    }
    final ProjectPaths projectPaths=context.getProjectPaths();
    final File outputDirectoryForPackagedFiles=AndroidJpsUtil.getOutputDirectoryForPackagedFiles(projectPaths,module);
    if (outputDirectoryForPackagedFiles == null) {
      context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,"Output directory is not specified for module " + module.getName()));
      success=false;
      continue;
    }
    final File classesDir=projectPaths.getModuleOutputDir(module,false);
    if (classesDir == null || !classesDir.isDirectory()) {
      continue;
    }
    final Set<String> subdirs=new HashSet<String>();
    AndroidJpsUtil.addSubdirectories(classesDir,subdirs);
    if (subdirs.size() > 0) {
      final File outputJarFile=new File(outputDirectoryForPackagedFiles,AndroidCommonUtils.CLASSES_JAR_FILE_NAME);
      try {
        AndroidCommonUtils.packClassFilesIntoJar(ArrayUtil.EMPTY_STRING_ARRAY,ArrayUtil.toStringArray(subdirs),outputJarFile);
      }
 catch (      IOException e) {
        AndroidJpsUtil.reportExceptionError(context,null,e,BUILDER_NAME);
        success=false;
      }
    }
  }
  return success ? ModuleLevelBuilder.ExitCode.OK : ModuleLevelBuilder.ExitCode.ABORT;
}
