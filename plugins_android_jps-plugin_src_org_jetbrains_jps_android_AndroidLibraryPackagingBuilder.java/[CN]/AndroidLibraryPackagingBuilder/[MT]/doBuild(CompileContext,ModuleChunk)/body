{
  boolean success=true;
  boolean doneSomething=false;
  for (  JpsModule module : chunk.getModules()) {
    final JpsAndroidModuleExtension extension=AndroidJpsUtil.getExtension(module);
    if (extension == null || !extension.isLibrary()) {
      continue;
    }
    File outputDir=AndroidJpsUtil.getDirectoryForIntermediateArtifacts(context,module);
    outputDir=AndroidJpsUtil.createDirIfNotExist(outputDir,context,BUILDER_NAME);
    if (outputDir == null) {
      success=false;
      continue;
    }
    final File classesDir=ProjectPaths.getModuleOutputDir(module,false);
    if (classesDir == null || !classesDir.isDirectory()) {
      continue;
    }
    final Set<String> subdirs=new HashSet<String>();
    AndroidJpsUtil.addSubdirectories(classesDir,subdirs);
    if (subdirs.size() > 0) {
      context.processMessage(new ProgressMessage(AndroidJpsBundle.message("android.jps.progress.library.packaging",module.getName())));
      final File outputJarFile=new File(outputDir,AndroidCommonUtils.CLASSES_JAR_FILE_NAME);
      doneSomething=true;
      try {
        AndroidCommonUtils.packClassFilesIntoJar(ArrayUtil.EMPTY_STRING_ARRAY,ArrayUtil.toStringArray(subdirs),outputJarFile);
      }
 catch (      IOException e) {
        AndroidJpsUtil.reportExceptionError(context,null,e,BUILDER_NAME);
        success=false;
      }
    }
  }
  return success ? (doneSomething ? ExitCode.OK : ExitCode.NOTHING_DONE) : ExitCode.ABORT;
}
