{
  PsiManager psiManager=PsiManager.getInstance(myProject);
  final PsiMigration psiMigration=psiManager.startMigration();
  LvcsAction action=LvcsIntegration.checkinFilesBeforeRefactoring(myProject,getCommandName());
  try {
    for (int i=0; i < myMigrationMap.getEntryCount(); i++) {
      MigrationMapEntry entry=myMigrationMap.getEntryAt(i);
      if (entry.getType() == MigrationMapEntry.PACKAGE) {
        MigrationUtil.doPackageMigration(psiManager,psiMigration,entry.getNewName(),usages);
      }
      if (entry.getType() == MigrationMapEntry.CLASS) {
        MigrationUtil.doClassMigration(psiManager,psiMigration,entry.getNewName(),usages);
      }
    }
  }
  finally {
    LvcsIntegration.checkinFilesAfterRefactoring(myProject,action);
    psiMigration.finish();
  }
}
