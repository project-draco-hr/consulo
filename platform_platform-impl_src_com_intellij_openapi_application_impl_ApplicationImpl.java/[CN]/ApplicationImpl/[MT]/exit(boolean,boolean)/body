{
  if (!force && getDefaultModalityState() != ModalityState.NON_MODAL) {
    return;
  }
  Runnable runnable=new Runnable(){
    public void run(){
      if (!force && !showConfirmation()) {
        saveAll();
        myExitCode=0;
        return;
      }
      getMessageBus().syncPublisher(AppLifecycleListener.TOPIC).appClosing();
      myDisposeInProgress=true;
      saveSettings();
      if (allowListenersToCancel && !canExit()) {
        myExitCode=0;
        return;
      }
      final boolean success=disposeSelf(allowListenersToCancel);
      if (!success || isUnitTestMode()) {
        myExitCode=0;
        return;
      }
      System.exit(myExitCode);
    }
  }
;
  if (!isDispatchThread()) {
    invokeLater(runnable,ModalityState.NON_MODAL);
  }
 else {
    runnable.run();
  }
}
