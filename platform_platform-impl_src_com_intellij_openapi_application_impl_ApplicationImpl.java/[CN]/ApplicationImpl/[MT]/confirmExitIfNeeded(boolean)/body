{
  final boolean hasUnsafeBgTasks=ProgressManager.getInstance().hasUnsafeProgressIndicator();
  if (exitConfirmed && !hasUnsafeBgTasks) {
    return true;
  }
  DialogWrapper.DoNotAskOption option=new DialogWrapper.DoNotAskOption(){
    @Override public boolean isToBeShown(){
      return GeneralSettings.getInstance().isConfirmExit() && ProjectManager.getInstance().getOpenProjects().length > 0;
    }
    @Override public void setToBeShown(    boolean value,    int exitCode){
      GeneralSettings.getInstance().setConfirmExit(value);
    }
    @Override public boolean canBeHidden(){
      return !hasUnsafeBgTasks;
    }
    @Override public boolean shouldSaveOptionsOnCancel(){
      return false;
    }
    @NotNull @Override public String getDoNotShowMessage(){
      return "Do not ask me again";
    }
  }
;
  if (hasUnsafeBgTasks || option.isToBeShown()) {
    String message=ApplicationBundle.message(hasUnsafeBgTasks ? "exit.confirm.prompt.tasks" : "exit.confirm.prompt",ApplicationNamesInfo.getInstance().getFullProductName());
    if (MessageDialogBuilder.yesNo(ApplicationBundle.message("exit.confirm.title"),message).yesText(ApplicationBundle.message("command.exit")).noText(CommonBundle.message("button.cancel")).doNotAsk(option).show() != Messages.YES) {
      return false;
    }
  }
  return true;
}
