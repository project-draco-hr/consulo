{
  boolean writeActionPending=myWriteActionPending;
  myWriteActionPending=true;
  try {
    ActivityTracker.getInstance().inc();
    fireBeforeWriteActionStart(clazz);
    try {
      if (!isWriteAccessAllowed()) {
        assertNoPsiLock();
      }
      if (!myLock.writeLock().tryLock()) {
        final AtomicBoolean lockAcquired=new AtomicBoolean(false);
        myLock.writeLock().lockInterruptibly();
        lockAcquired.set(true);
      }
    }
 catch (    InterruptedException e) {
      throw new RuntimeInterruptedException(e);
    }
  }
  finally {
    myWriteActionPending=writeActionPending;
  }
  myWriteActionsStack.push(clazz);
  fireWriteActionStarted(clazz);
}
