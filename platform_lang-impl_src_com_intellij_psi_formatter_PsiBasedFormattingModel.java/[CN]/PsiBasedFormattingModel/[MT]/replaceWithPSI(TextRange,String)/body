{
  final int offset=textRange.getEndOffset();
  ASTNode leafElement=findElementAt(offset);
  if (leafElement != null) {
    if (leafElement.getPsi() instanceof PsiFile) {
      return null;
    }
 else {
      if (!leafElement.getPsi().isValid()) {
        String message="Invalid element found in '\n" + myASTNode.getText() + "\n' at "+ offset+ "("+ myASTNode.getText().substring(offset,Math.min(offset + 10,myASTNode.getTextLength()));
        LOG.error(message);
      }
      return replaceWithPsiInLeaf(textRange,whiteSpace,leafElement);
    }
  }
 else   if (textRange.getEndOffset() == myASTNode.getTextLength()) {
    CodeStyleManager.getInstance(myProject).performActionWithFormatterDisabled(new Runnable(){
      @Override public void run(){
        FormatterUtil.replaceLastWhiteSpace(myASTNode,whiteSpace,textRange);
      }
    }
);
    return whiteSpace;
  }
 else {
    return null;
  }
}
