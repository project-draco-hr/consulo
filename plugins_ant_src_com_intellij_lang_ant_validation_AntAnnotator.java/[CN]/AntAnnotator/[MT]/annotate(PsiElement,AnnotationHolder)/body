{
  if (!(psiElement instanceof AntElement))   return;
  AntElement element=(AntElement)psiElement;
  if (element instanceof AntStructuredElement) {
    final AntStructuredElement se=(AntStructuredElement)element;
    AntElement parent=se.getAntParent();
    AntTypeDefinition def=se.getTypeDefinition();
    final String name=se.getSourceElement().getName();
    final TextRange absoluteRange=new TextRange(0,name.length()).shiftRight(se.getSourceElement().getTextOffset());
    if (def == null) {
      final Annotation annotation=holder.createErrorAnnotation(absoluteRange,AntBundle.message("undefined.element",name));
      boolean defined=false;
      while (parent != null) {
        if (parent instanceof AntTask && ((AntTask)parent).isMacroDefined()) {
          defined=true;
          break;
        }
        parent=parent.getAntParent();
      }
      if (!defined) {
        addDefinitionQuickFixes(annotation,se);
      }
    }
 else {
      checkValidAttributes(se,def,holder);
      if (!se.hasImportedTypeDefinition() && parent instanceof AntStructuredElement) {
        final AntStructuredElement pe=(AntStructuredElement)parent;
        final AntTypeDefinition parentDef=pe.getTypeDefinition();
        if (parentDef != null && parentDef.getNestedClassName(def.getTypeId()) == null) {
          holder.createErrorAnnotation(absoluteRange,AntBundle.message("nested.element.is.not.allowed.here",name));
        }
      }
    }
  }
  checkReferences(element,holder);
}
