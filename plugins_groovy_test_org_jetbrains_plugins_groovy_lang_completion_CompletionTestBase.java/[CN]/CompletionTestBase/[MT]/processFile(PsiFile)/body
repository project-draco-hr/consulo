{
  String result="";
  String fileText=file.getText();
  int offset=fileText.indexOf(CARET_MARKER);
  fileText=removeCaretMarker(fileText);
  myFile=TestUtils.createPseudoPhysicalFile(myProject,fileText);
  myFileEditorManager=FileEditorManager.getInstance(myProject);
  myEditor=myFileEditorManager.openTextEditor(new OpenFileDescriptor(myProject,myFile.getVirtualFile(),0),false);
  myEditor.getCaretModel().moveToOffset(offset);
  final CodeInsightActionHandler handler=getCompetionHandler();
  final CompletionContext context=new CompletionContext(myProject,myEditor,myFile,0,myOffset);
  CompletionData data=CompletionUtil.getCompletionDataByElement(myFile.findElementAt(myOffset),context);
  LookupItem[] items=getAcceptableItems(data);
  try {
    performAction(myProject,new Runnable(){
      public void run(){
        handler.invoke(myProject,myEditor,myFile);
      }
    }
);
    offset=myEditor.getCaretModel().getOffset();
    if (items.length > 0) {
      Arrays.sort(items);
      result="";
      for (      LookupItem item : items) {
        result=result + "\n" + item.getLookupString();
      }
      result=result.trim();
    }
  }
  finally {
    myFileEditorManager.closeFile(myFile.getVirtualFile());
    myEditor=null;
  }
  return result;
}
