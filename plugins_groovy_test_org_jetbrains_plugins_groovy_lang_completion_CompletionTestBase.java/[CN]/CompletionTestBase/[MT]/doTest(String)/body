{
  final List<String> stringList=TestUtils.readInput(getTestDataPath() + "/" + getTestName(true)+ ".test");
  if (directory.length() != 0)   directory+="/";
  final String fileName=directory + getTestName(true) + "."+ getExtension();
  myFixture.addFileToProject(fileName,stringList.get(0));
  myFixture.configureByFile(fileName);
  CompositeCompletionData.restrictCompletion(addReferenceVariants(),addKeywords());
  boolean old=CodeInsightSettings.getInstance().AUTOCOMPLETE_COMMON_PREFIX;
  CodeInsightSettings.getInstance().AUTOCOMPLETE_COMMON_PREFIX=false;
  CodeInsightSettings.getInstance().AUTOCOMPLETE_ON_CODE_COMPLETION=false;
  String result="";
  try {
    myFixture.completeBasic();
    final LookupImpl lookup=(LookupImpl)LookupManager.getActiveLookup(myFixture.getEditor());
    if (lookup != null) {
      List<LookupElement> items=lookup.getItems();
      Collections.sort(items,new Comparator<LookupElement>(){
        public int compare(        LookupElement o1,        LookupElement o2){
          return o1.getLookupString().compareTo(o2.getLookupString());
        }
      }
);
      result="";
      for (      LookupElement item : items) {
        result=result + "\n" + item.getLookupString();
      }
      result=result.trim();
      LookupManager.getInstance(myFixture.getProject()).hideActiveLookup();
    }
  }
  finally {
    CodeInsightSettings.getInstance().AUTOCOMPLETE_ON_CODE_COMPLETION=true;
    CodeInsightSettings.getInstance().AUTOCOMPLETE_COMMON_PREFIX=old;
    CompositeCompletionData.restrictCompletion(true,true);
  }
  assertEquals(stringList.get(1),result);
}
