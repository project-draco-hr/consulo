{
  StubElement stub=parentStub;
  final IElementType elementType=element.getTokenType();
  if (elementType instanceof IStubElementType) {
    if (elementType instanceof ILightStubElementType) {
      final ILightStubElementType lightElementType=(ILightStubElementType)elementType;
      if (lightElementType.shouldCreateStub(tree,element,parentStub)) {
        stub=lightElementType.createStub(tree,element,parentStub);
      }
    }
 else {
      LOG.error("Element is not of ILighterStubElementType: " + elementType + ", "+ element);
    }
  }
  for (  final LighterASTNode child : tree.getChildren(element)) {
    if (!skipChildProcessingWhenBuildingStubs(elementType,child.getTokenType())) {
      buildStubTreeFor(tree,child,stub);
    }
  }
  return stub;
}
