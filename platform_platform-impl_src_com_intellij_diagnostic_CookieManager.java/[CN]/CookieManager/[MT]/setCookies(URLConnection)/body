{
  URL url=conn.getURL();
  String domain=getDomainFromHost(url.getHost());
  String path=url.getPath();
  Map domainStore=(Map)store.get(domain);
  if (domainStore == null)   return;
  StringBuffer cookieStringBuffer=new StringBuffer();
  Iterator cookieNames=domainStore.keySet().iterator();
  while (cookieNames.hasNext()) {
    String cookieName=(String)cookieNames.next();
    Map cookie=(Map)domainStore.get(cookieName);
    if (comparePaths((String)cookie.get(PATH),path) && isNotExpired((String)cookie.get(EXPIRES))) {
      cookieStringBuffer.append(cookieName);
      cookieStringBuffer.append("=");
      cookieStringBuffer.append((String)cookie.get(cookieName));
      if (cookieNames.hasNext())       cookieStringBuffer.append(SET_COOKIE_SEPARATOR);
    }
  }
  try {
    conn.setRequestProperty(COOKIE,cookieStringBuffer.toString());
  }
 catch (  java.lang.IllegalStateException ise) {
    IOException ioe=new IOException("Illegal State! Cookies cannot be set on a URLConnection that is already connected. Only call setCookies(java.net.URLConnection) AFTER calling java.net.URLConnection.connect().");
    throw ioe;
  }
}
