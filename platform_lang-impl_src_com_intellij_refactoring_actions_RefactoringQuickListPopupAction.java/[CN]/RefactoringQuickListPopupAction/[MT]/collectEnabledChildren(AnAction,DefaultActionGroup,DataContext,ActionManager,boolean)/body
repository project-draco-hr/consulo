{
  if (action instanceof DefaultActionGroup) {
    final AnAction[] children=((DefaultActionGroup)action).getChildren(null);
    for (    AnAction child : children) {
      if (child instanceof DefaultActionGroup) {
        final boolean isPopup=((DefaultActionGroup)child).isPopup();
        if (isPopup) {
          destinationGroup.add(new Separator(child.getTemplatePresentation().getText()));
        }
        collectEnabledChildren(child,destinationGroup,dataContext,actionManager,isPopup || popup);
        if (isPopup) {
          destinationGroup.add(Separator.getInstance());
        }
      }
 else       if (child instanceof Separator && !popup) {
        destinationGroup.add(child);
      }
 else {
        if (child instanceof BaseRefactoringAction && ((BaseRefactoringAction)child).hasAvailableHandler(dataContext)) {
          final Presentation presentation=new Presentation();
          final AnActionEvent event=new AnActionEvent(null,dataContext,ActionPlaces.UNKNOWN,presentation,actionManager,0);
          child.update(event);
          if (presentation.isEnabled() && presentation.isVisible()) {
            destinationGroup.add(child);
          }
        }
      }
    }
  }
}
