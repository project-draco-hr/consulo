{
  if (editor == null)   return null;
  if (file == null)   return editor;
  int offset=editor.getCaretModel().getOffset();
  PsiElement element=file.findElementAt(offset);
  PsiLanguageInjectionHost injectionHost=findInjectionHost(element);
  Pair<PsiElement,TextRange> injectedPsi=injectionHost == null ? null : injectionHost.getInjectedPsi();
  if (injectedPsi == null) {
    return editor;
  }
  PsiFile injectedFile=injectedPsi.getFirst().getContainingFile();
  Document document=PsiDocumentManager.getInstance(editor.getProject()).getDocument(injectedFile);
  return new EditorDelegate((DocumentRange)document,(EditorImpl)editor,injectedFile);
}
