{
  Calendar calendar=Calendar.getInstance();
  calendar.setTime(today);
  int todayYear=calendar.get(Calendar.YEAR);
  int todayDayOfYear=calendar.get(Calendar.DAY_OF_YEAR);
  calendar.setTime(date);
  int year=calendar.get(Calendar.YEAR);
  int dayOfYear=calendar.get(Calendar.DAY_OF_YEAR);
  DateFormat defaultDateFormat=SimpleDateFormat.getDateTimeInstance(SimpleDateFormat.SHORT,SimpleDateFormat.SHORT,locale);
  DateFormat timeDefaultFormat=DateFormat.getTimeInstance(SimpleDateFormat.SHORT,locale);
  boolean isYesterdayOnPreviousYear=(todayYear == year + 1) && todayDayOfYear == 1 && dayOfYear == calendar.getActualMaximum(Calendar.DAY_OF_YEAR);
  boolean isYesterday=isYesterdayOnPreviousYear || (todayYear == year && todayDayOfYear == dayOfYear + 1);
  if (isYesterday) {
    return CommonBundle.message("date.format.yesterday") + " " + timeDefaultFormat.format(date);
  }
 else   if (year != todayYear) {
    return defaultDateFormat.format(date);
  }
 else   if (todayDayOfYear == dayOfYear) {
    return CommonBundle.message("date.format.today") + " " + timeDefaultFormat.format(date);
  }
 else {
    return defaultDateFormat.format(date);
  }
}
