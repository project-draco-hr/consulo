{
  if (!CodeInsightUtilBase.preparePsiElementForWrite(element))   return;
  element=findJavaCodeUpThere(element);
  PsiFile file=element.getContainingFile();
  editor=InjectedLanguageFacadeImpl.openEditorFor(file,project);
  int endOffset=element.getTextRange().getEndOffset();
  int line=editor.getDocument().getLineNumber(endOffset);
  int lineEndOffset=editor.getDocument().getLineEndOffset(line);
  PsiComment comment=PsiTreeUtil.findElementOfClassAtOffset(file,lineEndOffset - 1,PsiComment.class,false);
  String prefix="";
  boolean prefixFound=false;
  if (comment != null) {
    IElementType tokenType=comment.getTokenType();
    if (tokenType == JavaTokenType.END_OF_LINE_COMMENT) {
      prefix=StringUtil.trimStart(comment.getText(),"//") + " ";
      prefixFound=true;
    }
  }
  String commentText="//" + prefix + nonNlsCommentPattern;
  if (prefixFound) {
    PsiComment newcom=JavaPsiFacade.getElementFactory(project).createCommentFromText(commentText,element);
    comment.replace(newcom);
  }
 else {
    editor.getDocument().insertString(lineEndOffset," " + commentText);
  }
  DaemonCodeAnalyzer.getInstance(project).restart();
}
