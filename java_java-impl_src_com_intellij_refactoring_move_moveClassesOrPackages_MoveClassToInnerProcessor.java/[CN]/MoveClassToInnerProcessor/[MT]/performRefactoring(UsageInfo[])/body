{
  if (!prepareWritable(usages))   return;
  final List<PsiElement> importStatements=new ArrayList<PsiElement>();
  if (!CodeStyleSettingsManager.getSettings(myProject).INSERT_INNER_CLASS_IMPORTS) {
    usages=filterUsagesInImportStatements(usages,importStatements);
  }
  saveNonCodeUsages(usages);
  final Map<PsiElement,PsiElement> oldToNewElementsMapping=new HashMap<PsiElement,PsiElement>();
  try {
    for (    PsiClass classToMove : myClassesToMove) {
      ChangeContextUtil.encodeContextInfo(classToMove,true);
      PsiClass newClass=(PsiClass)myTargetClass.addBefore(classToMove,myTargetClass.getRBrace());
      PsiUtil.setModifierProperty(newClass,PsiModifier.STATIC,true);
      newClass=(PsiClass)ChangeContextUtil.decodeContextInfo(newClass,null,null);
      oldToNewElementsMapping.put(classToMove,newClass);
    }
    myNonCodeUsages=MoveClassesOrPackagesProcessor.retargetUsages(usages,oldToNewElementsMapping);
    retargetNonCodeUsages(oldToNewElementsMapping);
    retargetClassRefsInMoved(oldToNewElementsMapping);
    JavaCodeStyleManager.getInstance(myProject).removeRedundantImports((PsiJavaFile)myTargetClass.getContainingFile());
    for (    PsiClass classToMove : myClassesToMove) {
      classToMove.delete();
    }
    for (    PsiElement element : importStatements) {
      if (element.isValid()) {
        element.delete();
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
