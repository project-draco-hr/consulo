{
  final ProgressIndicator indicator=getProgressIndicator();
  if (indicator != null) {
    indicator.pushState();
    indicator.setIndeterminate(false);
    indicator.setText(getBuildingIndicesMessage(myFormatChanged));
    myFormatChanged=false;
  }
  final VirtualFile[] files=queryNeededFiles(true,getFileTypesToRefresh());
  for (int i=0; i < files.length; i++) {
    if (indicator != null) {
      indicator.setFraction(((double)i) / files.length);
    }
    doUpdateIndexEntry(files[i]);
  }
  if (indicator != null) {
    indicator.popState();
  }
}
