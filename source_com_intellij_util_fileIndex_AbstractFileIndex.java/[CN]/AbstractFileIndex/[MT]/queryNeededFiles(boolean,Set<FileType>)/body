{
  final List<VirtualFile> files=new ArrayList<VirtualFile>();
  myProjectFileIndex.iterateContent(new ContentIterator(){
    public boolean processFile(    VirtualFile fileOrDir){
      if (belongs(fileOrDir)) {
        files.add(fileOrDir);
      }
      return true;
    }
  }
);
  List<VirtualFile> toUpdate=new ArrayList<VirtualFile>();
  Set<String> toRemove=new THashSet<String>(myFileUrl2IndexEntry.keySet());
  final int size=files.size();
  for (int i=0; i < size; i++) {
    final VirtualFile file=files.get(i);
    final String url=file.getUrl();
    final IndexEntry entry=myFileUrl2IndexEntry.get(url);
    toRemove.remove(url);
    if (entry == null || includeChangedFiles && entry.getTimeStamp() != file.getTimeStamp() || fileTypesToRefresh != null && fileTypesToRefresh.contains(file.getFileType())) {
      toUpdate.add(file);
    }
  }
  for (  String url : toRemove) {
    removeIndexEntry(url);
  }
  return toUpdate.toArray(new VirtualFile[toUpdate.size()]);
}
