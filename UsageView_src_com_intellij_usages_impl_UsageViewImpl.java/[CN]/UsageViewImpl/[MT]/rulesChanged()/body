{
  final ArrayList<UsageState> states=new ArrayList<UsageState>();
  captureUsagesExpandState(new TreePath(myTree.getModel().getRoot()),states);
  final List<Usage> allUsages=new ArrayList<Usage>(myUsageNodes.keySet());
  Collections.sort(allUsages,new Comparator<Usage>(){
    public int compare(    final Usage o1,    final Usage o2){
      if (o1 instanceof Comparable && o2 instanceof Comparable) {
        return ((Comparable)o1).compareTo((Comparable)o2);
      }
      return 0;
    }
  }
);
  reset();
  myBuilder.setGroupingRules(getActiveGroupingRules(myProject));
  myBuilder.setFilteringRules(getActiveFilteringRules(myProject));
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (Iterator<Usage> i=allUsages.iterator(); i.hasNext(); ) {
        Usage usage=i.next();
        if (!usage.isValid()) {
          i.remove();
          continue;
        }
        if (usage instanceof MergeableUsage) {
          ((MergeableUsage)usage).reset();
        }
        appendUsage(usage);
      }
    }
  }
);
  restoreUsageExpandState(states);
}
