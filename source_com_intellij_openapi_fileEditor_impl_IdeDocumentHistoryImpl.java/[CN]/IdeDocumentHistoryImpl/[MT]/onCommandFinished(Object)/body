{
  if (myCommandStartPlace != null) {
    if (myCurrentCommandIsNavigation && myCurrentCommandHasMoves) {
      if (!myBackInProgress) {
        if (commandGroupId == null || !commandGroupId.equals(myLastGroupId)) {
          putLastOrMerge(myBackPlaces,myCommandStartPlace,BACK_QUEUE_LIMIT);
        }
        if (!myForwardInProgress) {
          for (Iterator<PlaceInfo> iterator=myForwardPlaces.iterator(); iterator.hasNext(); ) {
            iterator.next();
          }
          myForwardPlaces.clear();
        }
      }
      removeInvalidFilesFromStacks();
    }
  }
  myLastGroupId=commandGroupId;
  if (myCurrentCommandHasChanges) {
    setCurrentChangePlace();
  }
 else   if (myCurrentCommandHasMoves) {
    pushCurrentChangePlace();
  }
}
