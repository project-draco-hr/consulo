{
  final Facet[] facets=getSortedFacets();
  if (facets.length == 0) {
    throw new WriteExternalException();
  }
  Map<Facet,Element> elements=new HashMap<Facet,Element>();
  elements.put(null,element);
  for (  Facet facet : facets) {
    final Facet underlyingFacet=facet.getUnderlyingFacet();
    final Element parent=elements.get(underlyingFacet);
    Element child=new Element(FACET_ELEMENT);
    child.setAttribute(TYPE_ATTRIBUTE,facet.getType().getStringId());
    final Element config=new Element(CONFIGURATION_ELEMENT);
    facet.getConfiguration().writeExternal(config);
    child.addContent(config);
    parent.addContent(child);
    elements.put(facet,child);
  }
}
