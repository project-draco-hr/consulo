{
  VirtualFile vFile=createFile();
  PsiDocumentManagerImpl documentManager=getPsiDocumentManager();
  long id=System.identityHashCode(documentManager.getDocument(getPsiManager().findFile(vFile)));
  documentManager.commitAllDocuments();
  UIUtil.dispatchAllInvocationEvents();
  UIUtil.dispatchAllInvocationEvents();
  assertEmpty(documentManager.getUncommittedDocuments());
  LeakHunter.checkLeak(documentManager,DocumentImpl.class);
  LeakHunter.checkLeak(documentManager,PsiFileImpl.class,new Processor<PsiFileImpl>(){
    @Override public boolean process(    PsiFileImpl psiFile){
      return psiFile.getViewProvider().getVirtualFile().getFileSystem() instanceof LocalFileSystem;
    }
  }
);
  Reference<Document> reference=vFile.getUserData(FileDocumentManagerImpl.DOCUMENT_KEY);
  assertNotNull(reference);
  for (int i=0; i < 1000; i++) {
    UIUtil.dispatchAllInvocationEvents();
    if (reference.get() == null)     break;
    System.gc();
  }
  assertNull(documentManager.getCachedDocument(getPsiManager().findFile(vFile)));
  Document newDoc=documentManager.getDocument(getPsiManager().findFile(vFile));
  assertTrue(id != System.identityHashCode(newDoc));
}
