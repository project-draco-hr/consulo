{
  GroovyPsiElementFactory factory=GroovyPsiElementFactory.getInstance(myProject);
  PsiType initializerType=mySettings.getSelectedType();
  IntroduceParameterUtil.processUsages(usages,this);
  final boolean methodsToProcessAreDifferent=myContext.methodToReplaceIn != myContext.methodToSearchFor;
  if (mySettings.generateDelegate()) {
    generateDelegate(myContext.methodToReplaceIn);
    if (methodsToProcessAreDifferent) {
      final GrMethod method=generateDelegate(myContext.methodToSearchFor);
      final PsiClass containingClass=method.getContainingClass();
      if (containingClass != null && containingClass.isInterface()) {
        final GrOpenBlock block=method.getBlock();
        if (block != null) {
          block.delete();
        }
      }
    }
  }
  LOG.assertTrue(initializerType == null || initializerType.isValid());
  final FieldConflictsResolver fieldConflictsResolver=new FieldConflictsResolver(mySettings.getName(),myContext.methodToReplaceIn.getBlock());
  IntroduceParameterUtil.changeMethodSignatureAndResolveFieldConflicts(new UsageInfo(myContext.methodToReplaceIn),usages,this);
  if (methodsToProcessAreDifferent) {
    IntroduceParameterUtil.changeMethodSignatureAndResolveFieldConflicts(new UsageInfo(myContext.methodToSearchFor),usages,this);
  }
  if (myContext.var != null)   myContext.var.delete();
  for (  UsageInfo usage : usages) {
    if (usage instanceof ChangedMethodCallInfo) {
      PsiElement element=usage.getElement();
      processChangedMethodCall(element);
    }
 else     if (usage instanceof InternalUsageInfo) {
      PsiElement element=usage.getElement();
      if (element == null)       continue;
      GrExpression newExpr=factory.createExpressionFromText(mySettings.getName());
      if (element instanceof GrExpression) {
        ((GrExpression)element).replaceWithExpression(newExpr,true);
      }
 else {
        element.replace(newExpr);
      }
    }
  }
  if (myContext.var != null && mySettings.removeLocalVariable()) {
    myContext.var.delete();
  }
  fieldConflictsResolver.fix();
}
