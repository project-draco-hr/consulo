{
  final VirtualFile[] children=directory.getChildren();
  if (children != null) {
    for (    VirtualFile child : children) {
      if (copyExcluded) {
        if (fileTypeManager.isFileIgnored(child.getName()))         continue;
      }
 else {
        if (index.isIgnored(child))         continue;
      }
      if ((filter == null || filter.accept(child,myContext.getCompileContext()))) {
        if (!child.isDirectory()) {
          addFileCopyInstruction(child,child.getName());
        }
 else {
          subFolder(child.getName()).collectInstructionsRecursively(child,filter,index,fileTypeManager,copyExcluded);
        }
      }
    }
  }
}
