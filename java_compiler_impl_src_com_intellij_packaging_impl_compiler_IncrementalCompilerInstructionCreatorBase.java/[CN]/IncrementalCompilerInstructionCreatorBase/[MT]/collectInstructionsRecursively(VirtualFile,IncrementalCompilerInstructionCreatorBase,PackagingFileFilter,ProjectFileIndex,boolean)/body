{
  final FileTypeManager fileTypeManager=FileTypeManager.getInstance();
  VfsUtilCore.visitChildrenRecursively(directory,new VirtualFileVisitor(VirtualFileVisitor.SKIP_ROOT){
{
      setValueForChildren(creator);
    }
    @Override public boolean visitFile(    @NotNull VirtualFile child){
      if (copyExcluded) {
        if (fileTypeManager.isFileIgnored(child))         return false;
      }
 else {
        if (index.isIgnored(child))         return false;
      }
      final IncrementalCompilerInstructionCreatorBase creator=getCurrentValue();
      if (filter != null && !filter.accept(child,creator.myContext.getCompileContext())) {
        return false;
      }
      if (!child.isDirectory()) {
        creator.addFileCopyInstruction(child,child.getName());
      }
 else {
        setValueForChildren(creator.subFolder(child.getName()));
      }
      return true;
    }
  }
);
}
