{
  if (items.isEmpty() || !lookup.isFocused()) {
    return 0;
  }
  if (lookup.isSelectionTouched() || !onExplicitAction) {
    LookupElement lastSelection=lookup.getCurrentItem();
    int old=items.indexOf(lastSelection);
    if (old >= 0) {
      return old;
    }
    for (int i=0; i < items.size(); i++) {
      String invariant=PRESENTATION_INVARIANT.get(items.get(i));
      if (invariant != null && invariant.equals(PRESENTATION_INVARIANT.get(lastSelection))) {
        return i;
      }
    }
  }
  String selectedText=lookup.getEditor().getSelectionModel().getSelectedText();
  for (int i=0; i < items.size(); i++) {
    LookupElement item=items.get(i);
    if (isPrefixItem(lookup,item,true) && !isLiveTemplate(item) || item.getLookupString().equals(selectedText)) {
      return i;
    }
  }
  final CompletionPreselectSkipper[] skippers=CompletionPreselectSkipper.EP_NAME.getExtensions();
  for (  CompletionSorterImpl sorter : myClassifiers.keySet()) {
    ProcessingContext context=createContext(true);
    for (    LookupElement element : myClassifiers.get(sorter).classify(inputBySorter.get(sorter),context)) {
      if (!shouldSkip(skippers,element)) {
        return items.indexOf(element);
      }
    }
  }
  return items.size() - 1;
}
