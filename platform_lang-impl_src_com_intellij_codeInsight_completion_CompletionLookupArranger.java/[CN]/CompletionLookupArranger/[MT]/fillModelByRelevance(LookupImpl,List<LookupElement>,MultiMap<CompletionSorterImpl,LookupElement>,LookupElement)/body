{
  Iterator<LookupElement> byRelevance=sortByRelevance(inputBySorter).iterator();
  final LinkedHashSet<LookupElement> model=new LinkedHashSet<LookupElement>();
  addPrefixItems(model);
  addFrozenItems(items,model);
  addSomeItems(model,byRelevance,new Condition<LookupElement>(){
    @Override public boolean value(    LookupElement lastAdded){
      return model.size() >= MAX_PREFERRED_COUNT;
    }
  }
);
  addCurrentlySelectedItemToTop(lookup,items,model);
  freezeTopItems(lookup,model);
  ensureItemAdded(items,model,byRelevance,lookup.getCurrentItem());
  ensureItemAdded(items,model,byRelevance,relevantSelection);
  ensureEverythingVisibleAdded(lookup,model,byRelevance);
  ArrayList<LookupElement> result=new ArrayList<LookupElement>(model);
  if (result.size() > 1) {
    LookupElement first=result.get(0);
    if (isLiveTemplate(first) && isPrefixItem(lookup,first,true) && CompletionServiceImpl.isStartMatch(result.get(1),lookup)) {
      ContainerUtil.swapElements(result,0,1);
    }
  }
  return result;
}
