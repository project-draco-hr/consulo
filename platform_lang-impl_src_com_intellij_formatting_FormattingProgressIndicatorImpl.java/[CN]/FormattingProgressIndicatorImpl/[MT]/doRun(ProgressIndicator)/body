{
  final SequentialTask task=myTask;
  if (task == null) {
    return;
  }
  SwingUtilities.invokeAndWait(new Runnable(){
    @Override public void run(){
      myDocumentModificationStampBefore=myDocument.getModificationStamp();
      task.prepare();
    }
  }
);
  final Lock lock=new ReentrantLock();
  final Condition condition=lock.newCondition();
  myIndicator=indicator;
  while (myRunning && !myTask.isDone()) {
    lock.lock();
    try {
      SwingUtilities.invokeLater(new Runnable(){
        @Override public void run(){
          long start=System.currentTimeMillis();
          while (System.currentTimeMillis() - start < ITERATION_MIN_TIMES_MILLIS.get(myLastState)) {
            task.iteration();
          }
          lock.lock();
          try {
            condition.signal();
          }
  finally {
            lock.unlock();
          }
        }
      }
);
      condition.await();
    }
  finally {
      lock.unlock();
    }
  }
}
