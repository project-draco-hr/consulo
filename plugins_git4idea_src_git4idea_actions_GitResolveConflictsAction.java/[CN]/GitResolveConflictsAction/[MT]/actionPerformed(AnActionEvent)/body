{
  final Project project=event.getProject();
  if (project == null) {
    return;
  }
  final Set<VirtualFile> conflictedFiles=new TreeSet<VirtualFile>(new Comparator<VirtualFile>(){
    @Override public int compare(    @NotNull VirtualFile f1,    @NotNull VirtualFile f2){
      return f1.getPresentableUrl().compareTo(f2.getPresentableUrl());
    }
  }
);
  for (  Change change : ChangeListManager.getInstance(project).getAllChanges()) {
    if (change.getFileStatus() != FileStatus.MERGED_WITH_CONFLICTS) {
      continue;
    }
    final ContentRevision before=change.getBeforeRevision();
    final ContentRevision after=change.getAfterRevision();
    if (before != null) {
      final VirtualFile file=before.getFile().getVirtualFile();
      if (file != null) {
        conflictedFiles.add(file);
      }
    }
    if (after != null) {
      final VirtualFile file=after.getFile().getVirtualFile();
      if (file != null) {
        conflictedFiles.add(file);
      }
    }
  }
  AbstractVcsHelper.getInstance(project).showMergeDialog(new ArrayList<VirtualFile>(conflictedFiles),GitVcs.getInstance(project).getMergeProvider());
  for (  VirtualFile conflictedFile : conflictedFiles) {
    final GitRepository repo=GitUtil.getRepositoryManager(project).getRepositoryForFile(conflictedFile);
    if (repo != null) {
      repo.update();
    }
  }
}
