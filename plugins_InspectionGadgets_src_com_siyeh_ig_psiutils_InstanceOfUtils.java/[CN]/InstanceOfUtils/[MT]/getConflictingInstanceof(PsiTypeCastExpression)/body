{
  final PsiType castType=expression.getType();
  if (!(castType instanceof PsiClassType)) {
    return null;
  }
  final PsiClassType classType=(PsiClassType)castType;
  final PsiClassType rawType=classType.rawType();
  final PsiExpression operand=expression.getOperand();
  if (!(operand instanceof PsiReferenceExpression)) {
    return null;
  }
  final PsiReferenceExpression referenceExpression=(PsiReferenceExpression)operand;
  final InstanceofChecker checker=new InstanceofChecker(referenceExpression,rawType,false);
  PsiElement parent=PsiTreeUtil.getParentOfType(expression,PsiIfStatement.class,PsiConditionalExpression.class,PsiPolyadicExpression.class);
  while (parent != null) {
    parent.accept(checker);
    if (checker.hasAgreeingInstanceof()) {
      return null;
    }
    parent=PsiTreeUtil.getParentOfType(parent,PsiPolyadicExpression.class,PsiIfStatement.class,PsiConditionalExpression.class);
  }
  if (checker.hasAgreeingInstanceof()) {
    return null;
  }
  return checker.getConflictingInstanceof();
}
