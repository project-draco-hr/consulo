{
  PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  final PsiFile psiFile=documentManager.getCachedPsiFile(hostEditor.getDocument());
  documentManager.commitAllDocuments();
  hostEditor.getCaretModel().runForEachCaret(new CaretAction(){
    @Override public void perform(    Caret caret){
      Editor editor=hostEditor;
      if (psiFile != null) {
        Caret injectedCaret=InjectedLanguageUtil.getCaretForInjectedLanguageNoCommit(caret,psiFile);
        if (injectedCaret != null) {
          caret=injectedCaret;
          editor=caret.getEditor();
        }
      }
      final PsiFile file=PsiUtilBase.getPsiFileInEditor(caret,project);
      if (file != null) {
        handler.invoke(project,editor,caret,file);
      }
    }
  }
);
}
