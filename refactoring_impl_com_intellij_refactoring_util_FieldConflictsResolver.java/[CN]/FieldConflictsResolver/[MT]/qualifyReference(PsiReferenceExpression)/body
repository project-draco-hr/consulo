{
  PsiManager manager=referenceExpression.getManager();
  PsiReferenceExpression expressionFromText;
  final PsiElementFactory factory=manager.getElementFactory();
  if (myQualifyingClass == null) {
    final PsiClass parentClass=PsiTreeUtil.getParentOfType(referenceExpression,PsiClass.class);
    final PsiClass containingClass=myField.getContainingClass();
    if (parentClass != null && !InheritanceUtil.isInheritorOrSelf(parentClass,containingClass,true)) {
      expressionFromText=(PsiReferenceExpression)factory.createExpressionFromText("A.this." + myField.getName(),null);
      final PsiJavaCodeReferenceElement classQualifier=((PsiThisExpression)expressionFromText.getQualifierExpression()).getQualifier();
      classQualifier.replace(factory.createClassReferenceElement(containingClass));
    }
 else {
      expressionFromText=(PsiReferenceExpression)factory.createExpressionFromText("this." + myField.getName(),null);
    }
  }
 else {
    expressionFromText=(PsiReferenceExpression)factory.createExpressionFromText("A." + myField.getName(),null);
    final PsiReferenceExpression qualifier=factory.createReferenceExpression(myQualifyingClass);
    expressionFromText.getQualifierExpression().replace(qualifier);
  }
  CodeStyleManager codeStyleManager=manager.getCodeStyleManager();
  expressionFromText=(PsiReferenceExpression)codeStyleManager.reformat(expressionFromText);
  return (PsiReferenceExpression)referenceExpression.replace(expressionFromText);
}
