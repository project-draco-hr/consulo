{
  Charset charset=null;
  Trinity<Charset,CharsetToolkit.GuessedEncoding,byte[]> guessed=guessFromContent(virtualFile,content,content.length);
  if (guessed != null && guessed.first != null) {
    charset=guessed.first;
  }
 else {
    String charsetName=fileType.getCharset(virtualFile,content);
    if (charsetName == null) {
      Charset specifiedExplicitly=EncodingRegistry.getInstance().getEncoding(virtualFile,true);
      if (specifiedExplicitly != null) {
        charset=specifiedExplicitly;
      }
    }
 else {
      charset=CharsetToolkit.forName(charsetName);
    }
  }
  charset=charset == null ? EncodingRegistry.getInstance().getDefaultCharset() : charset;
  if (EncodingRegistry.getInstance().isNative2Ascii(virtualFile)) {
    charset=Native2AsciiCharset.wrap(charset);
  }
  virtualFile.setCharset(charset);
  return charset;
}
