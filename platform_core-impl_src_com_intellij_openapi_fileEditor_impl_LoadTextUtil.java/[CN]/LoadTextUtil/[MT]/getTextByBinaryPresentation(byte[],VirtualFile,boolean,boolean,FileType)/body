{
  Pair<Charset,byte[]> pair=doDetectCharsetAndSetBOM(virtualFile,bytes,saveBOM,fileType);
  Charset charset=pair.getFirst();
  byte[] bom=pair.getSecond();
  int offset=bom == null ? 0 : bom.length;
  Pair<CharSequence,String> result=convertBytes(bytes,charset,offset);
  if (saveDetectedSeparators) {
    virtualFile.setDetectedLineSeparator(result.getSecond());
  }
  return result.getFirst();
}
