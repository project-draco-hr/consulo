{
  Charset charset=virtualFile.isCharsetSet() ? virtualFile.getCharset() : detectCharset(virtualFile,content,fileType);
  Pair<Charset,byte[]> bomAndCharset=getBOMAndCharset(content,charset);
  final byte[] bom=bomAndCharset.second;
  if (saveBOM && bom != null && bom.length != 0) {
    virtualFile.setBOM(bom);
    setCharsetWasDetectedFromBytes(virtualFile,AUTO_DETECTED_FROM_BOM);
  }
  return bomAndCharset;
}
