{
  EncodingRegistry settings=EncodingRegistry.getInstance();
  boolean shouldGuess=settings != null && settings.isUseUTFGuessing(virtualFile);
  CharsetToolkit toolkit=shouldGuess ? new CharsetToolkit(content,EncodingRegistry.getInstance().getDefaultCharset()) : null;
  setCharsetWasDetectedFromBytes(virtualFile,false);
  if (shouldGuess) {
    toolkit.setEnforce8Bit(true);
    Charset charset=toolkit.guessFromBOM();
    if (charset != null) {
      setCharsetWasDetectedFromBytes(virtualFile,true);
      byte[] bom=CharsetToolkit.getBom(charset);
      if (bom == null)       bom=CharsetToolkit.UTF8_BOM;
      return Trinity.create(charset,null,bom);
    }
    CharsetToolkit.GuessedEncoding guessed=toolkit.guessFromContent(length);
    if (guessed == CharsetToolkit.GuessedEncoding.VALID_UTF8) {
      setCharsetWasDetectedFromBytes(virtualFile,true);
      return Trinity.create(CharsetToolkit.UTF8_CHARSET,null,null);
    }
    return Trinity.create(null,guessed,null);
  }
  return null;
}
