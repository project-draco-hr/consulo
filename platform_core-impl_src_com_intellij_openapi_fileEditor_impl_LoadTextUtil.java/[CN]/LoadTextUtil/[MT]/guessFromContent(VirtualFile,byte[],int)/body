{
  EncodingRegistry settings=EncodingRegistry.getInstance();
  boolean shouldGuess=settings != null && settings.isUseUTFGuessing(virtualFile);
  CharsetToolkit toolkit=shouldGuess ? new CharsetToolkit(content,EncodingRegistry.getInstance().getDefaultCharset()) : null;
  String detectedFromBytes=null;
  try {
    if (shouldGuess) {
      toolkit.setEnforce8Bit(true);
      Charset charset=toolkit.guessFromBOM();
      if (charset != null) {
        detectedFromBytes=AUTO_DETECTED_FROM_BOM;
        byte[] bom=CharsetToolkit.getMandatoryBom(charset);
        if (bom == null)         bom=CharsetToolkit.UTF8_BOM;
        return Trinity.create(charset,null,bom);
      }
      CharsetToolkit.GuessedEncoding guessed=toolkit.guessFromContent(length);
      if (guessed == CharsetToolkit.GuessedEncoding.VALID_UTF8) {
        detectedFromBytes="auto-detected from bytes";
        return Trinity.create(CharsetToolkit.UTF8_CHARSET,guessed,null);
      }
      return Trinity.create(null,guessed,null);
    }
    return null;
  }
  finally {
    setCharsetWasDetectedFromBytes(virtualFile,detectedFromBytes);
  }
}
