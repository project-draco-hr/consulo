{
  Pair<Charset,byte[]> pair=doDetectCharsetAndSetBOM(virtualFile,bytes,saveBOM);
  final Charset charset=pair.getFirst();
  byte[] bom=pair.getSecond();
  int offset=bom == null ? 0 : bom.length;
  final Pair<CharSequence,String> result=convertBytes(bytes,charset,offset);
  if (saveDetectedSeparators) {
    virtualFile.putUserData(DETECTED_LINE_SEPARATOR_KEY,result.getSecond());
  }
  return result.getFirst();
}
