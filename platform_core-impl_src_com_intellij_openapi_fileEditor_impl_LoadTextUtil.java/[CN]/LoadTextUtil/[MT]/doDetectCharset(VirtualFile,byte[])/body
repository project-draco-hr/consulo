{
  Trinity<Charset,CharsetToolkit.GuessedEncoding,byte[]> guessed=guessFromContent(virtualFile,content,content.length);
  if (guessed != null && guessed.first != null)   return guessed.first;
  FileType fileType=virtualFile.getFileType();
  String charsetName=fileType.getCharset(virtualFile,content);
  if (charsetName == null) {
    Charset specifiedExplicitly=EncodingRegistry.getInstance().getEncoding(virtualFile,true);
    if (specifiedExplicitly != null)     return specifiedExplicitly;
  }
  return CharsetToolkit.forName(charsetName);
}
