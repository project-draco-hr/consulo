{
  EncodingRegistry settings=EncodingRegistry.getInstance();
  boolean shouldGuess=settings != null && settings.isUseUTFGuessing(virtualFile);
  CharsetToolkit toolkit=shouldGuess ? new CharsetToolkit(content,EncodingRegistry.getInstance().getDefaultCharset()) : null;
  setCharsetWasDetectedFromBytes(virtualFile,false);
  if (shouldGuess) {
    toolkit.setEnforce8Bit(true);
    Charset charset=toolkit.guessFromBOM();
    if (charset != null) {
      setCharsetWasDetectedFromBytes(virtualFile,true);
      return charset;
    }
    CharsetToolkit.GuessedEncoding guessed=toolkit.guessFromContent(content.length);
    if (guessed == CharsetToolkit.GuessedEncoding.VALID_UTF8) {
      setCharsetWasDetectedFromBytes(virtualFile,true);
      return CharsetToolkit.UTF8_CHARSET;
    }
  }
  FileType fileType=virtualFile.getFileType();
  String charsetName=fileType.getCharset(virtualFile,content);
  if (charsetName == null) {
    Charset saved=EncodingRegistry.getInstance().getEncoding(virtualFile,true);
    if (saved != null)     return saved;
  }
  return CharsetToolkit.forName(charsetName);
}
