{
  if (virtualFile.isCharsetSet())   return virtualFile.getCharset();
  Charset charset=doDetectCharset(virtualFile,content);
  charset=charset == null ? EncodingRegistry.getInstance().getDefaultCharset() : charset;
  if (EncodingRegistry.getInstance().isNative2Ascii(virtualFile)) {
    charset=Native2AsciiCharset.wrap(charset);
  }
  virtualFile.setCharset(charset);
  return charset;
}
