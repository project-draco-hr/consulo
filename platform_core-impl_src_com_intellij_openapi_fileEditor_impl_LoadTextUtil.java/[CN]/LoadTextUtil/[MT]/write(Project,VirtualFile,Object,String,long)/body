{
  Charset existing=virtualFile.getCharset();
  Pair<Charset,byte[]> chosen=charsetForWriting(project,virtualFile,text,existing);
  Charset charset=chosen.first;
  byte[] buffer=chosen.second;
  if (charset != null) {
    if (!charset.equals(existing)) {
      virtualFile.setCharset(charset);
    }
  }
  setDetectedFromBytesFlagBack(virtualFile,buffer);
  virtualFile.putUserData(DETECTED_LINE_SEPARATOR_KEY,null);
  OutputStream outputStream=virtualFile.getOutputStream(requestor,newModificationStamp,-1);
  try {
    outputStream.write(buffer);
  }
  finally {
    outputStream.close();
  }
}
