{
  Charset existing=virtualFile.getCharset();
  Charset specified=extractCharsetFromFileContent(project,virtualFile,text);
  Charset charset=chooseMostlyHarmlessCharset(existing,specified,text);
  if (charset != null) {
    if (!charset.equals(existing)) {
      virtualFile.setCharset(charset);
    }
    setDetectedFromBytesFlagBack(virtualFile,charset,text);
  }
  byte[] bom=virtualFile.getBOM();
  Charset fromBom=bom == null ? null : CharsetToolkit.guessFromBOM(bom);
  if (fromBom != null)   charset=fromBom;
  OutputStream outputStream=virtualFile.getOutputStream(requestor,newModificationStamp,-1);
  OutputStreamWriter writer=charset == null ? new OutputStreamWriter(outputStream) : new OutputStreamWriter(outputStream,charset);
  Writer w=outputStream instanceof ByteArrayOutputStream ? writer : new BufferedWriter(writer);
  try {
    w.write(text);
  }
  finally {
    w.close();
  }
}
