{
  final PsiType variableType=variable.getType();
  if (!(variableType instanceof PsiClassType)) {
    return null;
  }
  final PsiClassType variableClassType=(PsiClassType)variableType;
  final PsiClass variableClass=variableClassType.resolve();
  final PsiManager manager=variable.getManager();
  final PsiElementFactory factory=manager.getElementFactory();
  final GlobalSearchScope scope=variable.getResolveScope();
  PsiClassType weakestType=PsiType.getJavaLangObject(manager,scope);
  PsiClass weakestTypeClass=weakestType.resolve();
  if (weakestTypeClass == null) {
    return null;
  }
  final Query<PsiReference> query=ReferencesSearch.search(variable);
  final Collection<PsiReference> references=query.findAll();
  for (  PsiReference reference : references) {
    if (weakestType.equals(variableClass)) {
      return null;
    }
    final PsiElement referenceElement=reference.getElement();
    final PsiElement referenceParent=referenceElement.getParent();
    final PsiElement referenceGrandParent=referenceParent.getParent();
    if (referenceParent instanceof PsiExpressionList) {
      if (!(referenceGrandParent instanceof PsiMethodCallExpression)) {
        return null;
      }
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)referenceGrandParent;
      final PsiReferenceExpression methodExpression=methodCallExpression.getMethodExpression();
      final PsiElement methodElement=methodExpression.resolve();
      if (!(methodElement instanceof PsiMethod)) {
        return null;
      }
      final PsiMethod method=(PsiMethod)methodElement;
      if (!(referenceElement instanceof PsiExpression)) {
        return null;
      }
      final PsiExpression expression=(PsiExpression)referenceElement;
      final PsiExpressionList expressionList=(PsiExpressionList)referenceParent;
      final int index=getExpressionIndex(expression,expressionList);
      final PsiParameterList parameterList=method.getParameterList();
      final PsiParameter[] parameters=parameterList.getParameters();
      final PsiParameter parameter=parameters[index];
      final PsiType type=parameter.getType();
      if (!(type instanceof PsiClassType)) {
        return null;
      }
      final PsiClassType classType=(PsiClassType)type;
      final PsiClass aClass=classType.resolve();
      if (aClass == null || weakestType.equals(aClass)) {
        return null;
      }
      if (aClass.isInheritor(weakestTypeClass,true)) {
        weakestTypeClass=aClass;
        weakestType=classType;
      }
    }
 else     if (referenceGrandParent instanceof PsiMethodCallExpression) {
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)referenceGrandParent;
      final PsiReferenceExpression methodExpression=methodCallExpression.getMethodExpression();
      final PsiElement methodElement=methodExpression.resolve();
      if (!(methodElement instanceof PsiMethod)) {
        return null;
      }
      PsiMethod method=(PsiMethod)methodElement;
      final PsiMethod[] superMethods=method.findDeepestSuperMethods();
      if (superMethods.length > 0) {
        method=superMethods[0];
      }
      final PsiClass containingClass=method.getContainingClass();
      if (containingClass.equals(weakestType)) {
        return null;
      }
      if (containingClass.isInheritor(weakestTypeClass,true)) {
        weakestType=factory.createType(containingClass);
        weakestTypeClass=containingClass;
      }
    }
 else     if (referenceParent instanceof PsiAssignmentExpression) {
      final PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)referenceParent;
      final PsiExpression lhs=assignmentExpression.getLExpression();
      final PsiExpression rhs=assignmentExpression.getRExpression();
      if (referenceElement.equals(lhs) && rhs != null) {
        final PsiType type=rhs.getType();
        if (!(type instanceof PsiClassType)) {
          return null;
        }
        final PsiClassType classType=(PsiClassType)type;
        final PsiClass aClass=classType.resolve();
        if (aClass == null || weakestType.equals(aClass)) {
          return null;
        }
        if (aClass.isInheritor(weakestTypeClass,true)) {
          weakestTypeClass=aClass;
          weakestType=classType;
        }
      }
 else       if (referenceElement.equals(rhs)) {
        final PsiType type=lhs.getType();
        if (!(type instanceof PsiClassType)) {
          return null;
        }
        final PsiClassType classType=(PsiClassType)type;
        final PsiClass aClass=classType.resolve();
        if (aClass == null || weakestType.equals(aClass)) {
          return null;
        }
        if (aClass.isInheritor(weakestTypeClass,true)) {
          weakestTypeClass=aClass;
          weakestType=classType;
        }
      }
    }
  }
  return weakestType;
}
