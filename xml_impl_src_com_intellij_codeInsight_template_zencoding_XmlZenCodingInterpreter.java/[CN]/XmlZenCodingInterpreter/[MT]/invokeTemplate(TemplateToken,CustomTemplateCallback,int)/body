{
  List<Pair<String,String>> attr2value=new ArrayList<Pair<String,String>>(token.getAttribute2Value());
  if (token.getTemplate() != null) {
    if (attr2value.size() > 0 || XmlZenCodingTemplate.isTrueXml(callback)) {
      TemplateImpl modifiedTemplate=token.getTemplate().copy();
      XmlTag tag=token.myTag;
      if (tag != null) {
        for (Iterator<Pair<String,String>> iterator=attr2value.iterator(); iterator.hasNext(); ) {
          Pair<String,String> pair=iterator.next();
          if (tag.getAttribute(pair.first) != null) {
            tag.setAttribute(pair.first,getValue(pair,numberInIteration));
            iterator.remove();
          }
        }
        modifiedTemplate.setString(filter(tag,callback));
        removeVariablesWhichHasNoSegment(modifiedTemplate);
        Map<String,String> predefinedValues=buildPredefinedValues(attr2value,numberInIteration);
        callback.expandTemplate(modifiedTemplate,predefinedValues);
        return;
      }
    }
    callback.expandTemplate(token.getTemplate(),null);
  }
 else {
    Map<String,String> predefinedValues=buildPredefinedValues(attr2value,numberInIteration);
    callback.expandTemplate(token.getKey(),predefinedValues);
  }
}
