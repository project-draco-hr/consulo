{
  super(new BorderLayout(0,0));
  myFindModel=findModel;
  GRADIENT_C1=getBackground();
  GRADIENT_C2=new Color(Math.max(0,GRADIENT_C1.getRed() - 0x18),Math.max(0,GRADIENT_C1.getGreen() - 0x18),Math.max(0,GRADIENT_C1.getBlue() - 0x18));
  myProject=project;
  myEditor=editor;
  mySearchResults=new SearchResults(myEditor);
  myLivePreview=new LivePreview(mySearchResults);
  myLivePreviewController=new MyLivePreviewController();
  mySearchResults.addListener(this);
  setMatchesLimit(MATCHES_LIMIT);
  final JPanel leadPanel=createLeadPane();
  add(leadPanel,BorderLayout.WEST);
  mySearchField=createTextField();
  leadPanel.add(mySearchField);
  mySearchField.putClientProperty("AuxEditorComponent",Boolean.TRUE);
  myDefaultBackground=mySearchField.getBackground();
  DefaultActionGroup group=new DefaultActionGroup("search bar",false);
  group.add(new ShowHistoryAction());
  group.add(new PrevOccurrenceAction());
  group.add(new NextOccurrenceAction());
  group.add(new FindAllAction());
  final ActionToolbar tb=ActionManager.getInstance().createActionToolbar("SearchBar",group,true);
  tb.setLayoutPolicy(ActionToolbar.NOWRAP_LAYOUT_POLICY);
  myToolbarComponent=tb.getComponent();
  myToolbarComponent.setBorder(null);
  myToolbarComponent.setOpaque(false);
  leadPanel.add(myToolbarComponent);
  myCbMatchCase=new NonFocusableCheckBox("Case sensitive");
  myCbWholeWords=new NonFocusableCheckBox("Match whole words only");
  myCbRegexp=new NonFocusableCheckBox("Regex");
  myCbInComments=new NonFocusableCheckBox("Search in comments only");
  myCbInLiterals=new NonFocusableCheckBox("Search in literals only");
  myOptionsPane=new JPanel();
  myOptionsPane.setLayout(new BoxLayout(myOptionsPane,BoxLayout.Y_AXIS));
  leadPanel.add(myCbMatchCase);
  myOptionsPane.add(myCbWholeWords);
  leadPanel.add(myCbRegexp);
  if (FindManagerImpl.ourHasSearchInCommentsAndLiterals) {
    myOptionsPane.add(myCbInComments);
    myOptionsPane.add(myCbInLiterals);
  }
  myMoreOptionsButton=new LinkLabel("More options",null,new LinkListener(){
    @Override public void linkSelected(    LinkLabel aSource,    Object aLinkData){
      if (myOptionsBalloon == null || myOptionsBalloon.isDisposed()) {
        BalloonBuilder balloonBuilder=JBPopupFactory.getInstance().createBalloonBuilder(myOptionsPane);
        balloonBuilder.setFillColor(myOptionsPane.getBackground());
        Point point=new Point((int)(myMoreOptionsButton.getX() + myMoreOptionsButton.getBounds().getWidth() / 2),(int)(myMoreOptionsButton.getY() + myMoreOptionsButton.getBounds().getHeight() / 2));
        myOptionsBalloon=balloonBuilder.createBalloon();
        myOptionsBalloon.show(new RelativePoint(leadPanel,point),Balloon.Position.below);
      }
    }
  }
);
  leadPanel.add(myMoreOptionsButton);
  myFindModel.addObserver(new FindModel.FindModelObserver(){
    @Override public void findModelChanged(    FindModel findModel){
      syncFindModels(FindManager.getInstance(myProject).getFindInFileModel(),myFindModel);
      String stringToFind=myFindModel.getStringToFind();
      if (!wholeWordsApplicable(stringToFind)) {
        myFindModel.setWholeWordsOnly(false);
      }
      updateUIWithFindModel();
      updateResults(true);
    }
  }
);
  FindManager.getInstance(myProject).getFindInFileModel().addObserver(this);
  updateUIWithFindModel();
  myCbMatchCase.setMnemonic('C');
  myCbWholeWords.setMnemonic('M');
  myCbRegexp.setMnemonic('e');
  myCbInComments.setMnemonic('o');
  myCbInLiterals.setMnemonic('l');
  setSmallerFontAndOpaque(myCbWholeWords);
  setSmallerFontAndOpaque(myCbMatchCase);
  setSmallerFontAndOpaque(myCbRegexp);
  setSmallerFontAndOpaque(myCbInComments);
  setSmallerFontAndOpaque(myCbInLiterals);
  myCbMatchCase.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      final boolean b=myCbMatchCase.isSelected();
      FindManager.getInstance(myProject).getFindInFileModel().setCaseSensitive(b);
      FindSettings.getInstance().setLocalCaseSensitive(b);
    }
  }
);
  myCbWholeWords.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      final boolean b=myCbWholeWords.isSelected();
      FindManager.getInstance(myProject).getFindInFileModel().setWholeWordsOnly(b);
      FindSettings.getInstance().setLocalWholeWordsOnly(b);
    }
  }
);
  myCbRegexp.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      final boolean b=myCbRegexp.isSelected();
      FindManager.getInstance(myProject).getFindInFileModel().setRegularExpressions(b);
    }
  }
);
  myCbInComments.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      final boolean b=myCbInComments.isSelected();
      FindManager.getInstance(myProject).getFindInFileModel().setInCommentsOnly(b);
    }
  }
);
  myCbInLiterals.addActionListener(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      final boolean b=myCbInLiterals.isSelected();
      FindManager.getInstance(myProject).getFindInFileModel().setInStringLiteralsOnly(b);
    }
  }
);
  JPanel tailPanel=new NonOpaquePanel(new BorderLayout(5,0));
  JPanel tailContainer=new NonOpaquePanel(new BorderLayout(5,0));
  tailContainer.add(tailPanel,BorderLayout.EAST);
  add(tailContainer,BorderLayout.CENTER);
  myMatchInfoLabel=new JLabel();
  setSmallerFontAndOpaque(myMatchInfoLabel);
  myClickToHighlightLabel=new LinkLabel("Click to highlight",null,new LinkListener(){
    @Override public void linkSelected(    LinkLabel aSource,    Object aLinkData){
      setMatchesLimit(Integer.MAX_VALUE);
      updateResults(true);
    }
  }
);
  setSmallerFontAndOpaque(myClickToHighlightLabel);
  myClickToHighlightLabel.setVisible(false);
  JLabel closeLabel=new JLabel(" ",IconLoader.getIcon("/actions/cross.png"),SwingConstants.RIGHT);
  closeLabel.addMouseListener(new MouseAdapter(){
    public void mousePressed(    final MouseEvent e){
      close();
    }
  }
);
  closeLabel.setToolTipText("Close search bar (Escape)");
  JPanel labelsPanel=new NonOpaquePanel(new FlowLayout());
  labelsPanel.add(myMatchInfoLabel);
  labelsPanel.add(myClickToHighlightLabel);
  tailPanel.add(labelsPanel,BorderLayout.CENTER);
  tailPanel.add(closeLabel,BorderLayout.EAST);
  configureTextField(mySearchField);
  mySearchField.getDocument().addDocumentListener(new DocumentAdapter(){
    protected void textChanged(    final DocumentEvent e){
      setMatchesLimit(MATCHES_LIMIT);
      String text=mySearchField.getText();
      if (!StringUtil.isEmpty(text)) {
        myFindModel.setStringToFind(text);
        updateResults(true);
      }
    }
  }
);
  setSmallerFont(mySearchField);
  mySearchField.registerKeyboardAction(new ActionListener(){
    public void actionPerformed(    final ActionEvent e){
      if ("".equals(mySearchField.getText())) {
        close();
      }
 else {
        requestFocus(myEditor.getContentComponent());
        addCurrentTextToRecents();
      }
    }
  }
,KeyStroke.getKeyStroke(KeyEvent.VK_ENTER,SystemInfo.isMac ? InputEvent.META_DOWN_MASK : InputEvent.CTRL_DOWN_MASK),JComponent.WHEN_FOCUSED);
  final String initialText=myFindModel.getStringToFind();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      setInitialText(initialText);
    }
  }
);
  new VariantsCompletionAction();
}
