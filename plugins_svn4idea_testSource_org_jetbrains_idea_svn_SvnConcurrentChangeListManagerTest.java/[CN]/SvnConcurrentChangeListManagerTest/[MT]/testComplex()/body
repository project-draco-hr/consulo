{
  enableSilentOperation(VcsConfiguration.StandardConfirmation.ADD);
  final VirtualFile file=createFileInCommand("a.txt","old content");
  final VirtualFile fileB=createFileInCommand("b.txt","old content");
  final VirtualFile fileC=createFileInCommand("c.txt","old content");
  final VirtualFile fileD=createFileInCommand("d.txt","old content");
  final ChangeListManager changeListManager=ChangeListManager.getInstance(myProject);
  final LocalChangeList list=changeListManager.addChangeList("test",null);
  final LocalChangeList toBeDeletedList=changeListManager.addChangeList("toBeDeletedList",null);
  changeListManager.moveChangesTo(list,new Change[]{changeListManager.getChange(file),changeListManager.getChange(fileB)});
  changeListManager.moveChangesTo(toBeDeletedList,new Change[]{changeListManager.getChange(fileC),changeListManager.getChange(fileD)});
  changeListManager.ensureUpToDate(false);
  final String targetName="target";
  final String finalName="final list name";
  doTest(changeListManager,new Runnable(){
    public void run(){
      final LocalChangeList target=changeListManager.addChangeList(targetName,null);
      changeListManager.moveChangesTo(target,new Change[]{changeListManager.getChange(file),changeListManager.getChange(fileB)});
      checkFilesAreInList(new VirtualFile[]{file,fileB},targetName,changeListManager);
      changeListManager.editName(targetName,finalName);
      checkFilesAreInList(new VirtualFile[]{file,fileB},finalName,changeListManager);
      changeListManager.removeChangeList(toBeDeletedList);
      checkFilesAreInList(new VirtualFile[]{fileC,fileD},myDefaulListName,changeListManager);
      changeListManager.moveChangesTo(LocalChangeList.createEmptyChangeList(myProject,finalName),new Change[]{changeListManager.getChange(fileC)});
      checkFilesAreInList(new VirtualFile[]{file,fileB,fileC},finalName,changeListManager);
      checkFilesAreInList(new VirtualFile[]{fileD},myDefaulListName,changeListManager);
    }
  }
);
  checkFilesAreInList(new VirtualFile[]{file,fileB,fileC},finalName,changeListManager);
  checkFilesAreInList(new VirtualFile[]{fileD},myDefaulListName,changeListManager);
  changeListManager.ensureUpToDate(false);
  checkFilesAreInList(new VirtualFile[]{file,fileB,fileC},finalName,changeListManager);
  checkFilesAreInList(new VirtualFile[]{fileD},myDefaulListName,changeListManager);
}
