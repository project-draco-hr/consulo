{
  final RunConfiguration runConfiguration=settings.getConfiguration();
  final RunManagerImpl runManager=RunManagerImpl.getInstanceImpl(runConfiguration.getProject());
  myStepsBeforeLaunch=runManager.getBeforeRunTasks(runConfiguration);
  myStepBeforeLaunchRows.clear();
  final BeforeRunTaskProvider<BeforeRunTask>[] providers=Extensions.getExtensions(BeforeRunTaskProvider.EXTENSION_POINT_NAME,runConfiguration.getProject());
  myStepsPanel.removeAll();
  if (runConfiguration instanceof UnknownRunConfiguration) {
    myStepsPanel.setVisible(false);
  }
 else {
    List<StepBeforeLaunchRow> stepsRows=new ArrayList<StepBeforeLaunchRow>();
    for (    BeforeRunTaskProvider<BeforeRunTask> provider : providers) {
      final BeforeRunTask task=myStepsBeforeLaunch.get(provider.getId());
      if (task != null) {
        final StepBeforeLaunchRow stepRow=new StepBeforeLaunchRow(runConfiguration,provider,task);
        myStepBeforeLaunchRows.put(provider.getId(),stepRow);
        stepsRows.add(stepRow);
      }
    }
    int maxStepRowWidth=0;
    for (    StepBeforeLaunchRow stepRow : stepsRows) {
      maxStepRowWidth=Math.max(maxStepRowWidth,stepRow.getPreferredSize().width);
    }
    if (maxStepRowWidth * 3 < getComponent().getPreferredSize().width || maxStepRowWidth < 200) {
      myStepsPanel.setLayout(new GridLayout(0,3,UIUtil.DEFAULT_HGAP,UIUtil.DEFAULT_VGAP));
    }
 else     if (maxStepRowWidth * 2 < getComponent().getPreferredSize().width || maxStepRowWidth < 300) {
      myStepsPanel.setLayout(new GridLayout(0,2,UIUtil.DEFAULT_HGAP,UIUtil.DEFAULT_VGAP));
    }
 else {
      myStepsPanel.setLayout(new GridLayout(0,1,UIUtil.DEFAULT_HGAP,UIUtil.DEFAULT_VGAP));
    }
    for (    StepBeforeLaunchRow stepRow : stepsRows) {
      myStepsPanel.add(stepRow);
    }
  }
  myEditBeforeRun=settings.isEditBeforeRun();
  myShowSettingsBeforeRunCheckBox=new JCheckBox(ExecutionBundle.message("configuration.edit.before.run"));
  myShowSettingsBeforeRunCheckBox.setEnabled(!(runConfiguration instanceof UnknownRunConfiguration));
  myShowSettingsBeforeRunCheckBox.setSelected(myEditBeforeRun);
  myShowSettingsBeforeRunCheckBox.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    ActionEvent e){
      myEditBeforeRun=myShowSettingsBeforeRunCheckBox.isSelected();
    }
  }
);
  myShowSettingsBeforeRunCheckBox.setVisible(!settings.isTemplate());
  myStepsPanel.add(myShowSettingsBeforeRunCheckBox);
  myStoreProjectConfiguration=runManager.isConfigurationShared(settings);
  myCbStoreProjectConfiguration.setEnabled(!(runConfiguration instanceof UnknownRunConfiguration));
  myCbStoreProjectConfiguration.setSelected(myStoreProjectConfiguration);
  myCbStoreProjectConfiguration.addActionListener(new ActionListener(){
    public void actionPerformed(    ActionEvent e){
      myStoreProjectConfiguration=myCbStoreProjectConfiguration.isSelected();
    }
  }
);
  myCbStoreProjectConfiguration.setVisible(!settings.isTemplate());
}
