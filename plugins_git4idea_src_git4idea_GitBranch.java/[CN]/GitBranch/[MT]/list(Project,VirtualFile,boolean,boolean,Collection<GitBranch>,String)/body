{
  final GitSimpleHandler handler=new GitSimpleHandler(project,root,GitCommand.BRANCH);
  handler.setNoSSH(true);
  handler.setSilent(true);
  handler.addParameters("--no-color");
  boolean remoteOnly=false;
  if (remoteWanted && localWanted) {
    handler.addParameters("-a");
    remoteOnly=false;
  }
 else   if (remoteWanted) {
    handler.addParameters("-r");
    remoteOnly=true;
  }
  if (containingCommit != null) {
    handler.addParameters("--contains",containingCommit);
  }
  final String output=handler.run();
  if (output.trim().length() == 0) {
    String head;
    try {
      head=new String(FileUtil.loadFileText(new File(root.getPath(),".git/HEAD"),GitUtil.UTF8_ENCODING)).trim();
      final String prefix="ref: refs/heads/";
      return head.startsWith(prefix) ? new GitBranch(head.substring(prefix.length()),true,false) : null;
    }
 catch (    IOException e) {
      return null;
    }
  }
  final String[] split=output.split("\n");
  GitBranch currentBranch=null;
  for (  String b : split) {
    boolean current=b.charAt(0) == '*';
    b=b.substring(2).trim();
    if (b.equals(NO_BRANCH_NAME)) {
      continue;
    }
    String remotePrefix=null;
    if (b.startsWith("remotes/")) {
      remotePrefix="remotes/";
    }
 else     if (b.startsWith(REFS_REMOTES_PREFIX)) {
      remotePrefix=REFS_REMOTES_PREFIX;
    }
    boolean isRemote=remotePrefix != null || remoteOnly;
    if (isRemote && !remoteOnly) {
      b=b.substring(remotePrefix.length());
    }
    final GitBranch branch=new GitBranch(b,current,isRemote);
    if (current) {
      currentBranch=branch;
    }
    if (branches != null && ((isRemote && remoteWanted) || (!isRemote && localWanted))) {
      branches.add(branch);
    }
  }
  return currentBranch;
}
