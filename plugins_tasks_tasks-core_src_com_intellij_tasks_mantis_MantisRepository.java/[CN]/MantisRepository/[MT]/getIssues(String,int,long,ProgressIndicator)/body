{
  MantisConnectPortType soap=createSoap();
  List<Task> tasks=new ArrayList<Task>(max);
  int page=1;
  int issuesOnPage=StringUtils.isEmpty(query) ? max : max * query.length() * 5;
  while (true) {
    cancelled.checkCanceled();
    final List<Task> issuesFromPage=getIssues(page,issuesOnPage,soap);
    final List<Task> filteredTasks=TaskSearchSupport.filterTasks(query != null ? query : "",issuesFromPage);
    tasks.addAll(filteredTasks);
    if (issuesFromPage.size() < issuesOnPage || tasks.size() >= max) {
      break;
    }
    page++;
  }
  tasks=tasks.subList(0,Math.min(max,tasks.size()));
  return tasks.toArray(new Task[tasks.size()]);
}
