{
  final List<PluginDownloader> downloaded=new ArrayList<PluginDownloader>();
  final Set<String> failed=new HashSet<String>();
  for (  String host : getPluginHosts(hostsConfigurable)) {
    try {
      checkPluginsHost(host,downloaded);
    }
 catch (    Exception e) {
      LOG.info(e);
      failed.add(host);
    }
  }
  final Map<String,IdeaPluginDescriptor> toUpdate=new HashMap<String,IdeaPluginDescriptor>();
  final IdeaPluginDescriptor[] installedPlugins=PluginManager.getPlugins();
  for (  IdeaPluginDescriptor installedPlugin : installedPlugins) {
    if (!installedPlugin.isBundled() && ((IdeaPluginDescriptorImpl)installedPlugin).isEnabled()) {
      toUpdate.put(installedPlugin.getPluginId().getIdString(),installedPlugin);
    }
  }
  if (!toUpdate.isEmpty()) {
    try {
      final ArrayList<IdeaPluginDescriptor> process=RepositoryHelper.process(null);
      for (      IdeaPluginDescriptor loadedPlugin : process) {
        final String idString=loadedPlugin.getPluginId().getIdString();
        final IdeaPluginDescriptor installedPlugin=toUpdate.get(idString);
        if (installedPlugin != null) {
          if (StringUtil.compareVersionNumbers(loadedPlugin.getVersion(),installedPlugin.getVersion()) > 0) {
            final PluginDownloader downloader=PluginDownloader.createDownloader(loadedPlugin);
            if (downloader.prepareToInstall()) {
              downloaded.add(downloader);
            }
          }
        }
      }
    }
 catch (    Exception e) {
      showErrorMessage(showErrorDialog,e.getMessage());
    }
  }
  if (!failed.isEmpty()) {
    showErrorMessage(showErrorDialog,IdeBundle.message("connection.failed.message",StringUtil.join(failed,",")));
  }
  return downloaded.isEmpty() ? null : downloaded;
}
