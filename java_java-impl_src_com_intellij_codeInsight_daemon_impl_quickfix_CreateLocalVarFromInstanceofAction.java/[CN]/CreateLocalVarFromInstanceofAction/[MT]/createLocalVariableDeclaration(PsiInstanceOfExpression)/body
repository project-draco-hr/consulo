{
  PsiElementFactory factory=JavaPsiFacade.getInstance(instanceOfExpression.getProject()).getElementFactory();
  PsiTypeCastExpression cast=(PsiTypeCastExpression)factory.createExpressionFromText("(a)b",instanceOfExpression);
  PsiType castType=instanceOfExpression.getCheckType().getType();
  cast.getCastType().replace(factory.createTypeElement(castType));
  cast.getOperand().replace(instanceOfExpression.getOperand());
  PsiDeclarationStatement decl=factory.createVariableDeclarationStatement("xxx",castType,cast);
  final Boolean createFinals=JavaRefactoringSettings.getInstance().INTRODUCE_LOCAL_CREATE_FINALS;
  if (createFinals != null) {
    final PsiElement[] declaredElements=decl.getDeclaredElements();
    LOG.assertTrue(declaredElements.length == 1);
    LOG.assertTrue(declaredElements[0] instanceof PsiLocalVariable);
    final PsiModifierList modifierList=((PsiLocalVariable)declaredElements[0]).getModifierList();
    LOG.assertTrue(modifierList != null);
    modifierList.setModifierProperty(PsiModifier.FINAL,createFinals.booleanValue());
  }
  PsiDeclarationStatement element=(PsiDeclarationStatement)insertAtAnchor(instanceOfExpression,decl);
  return CodeInsightUtilBase.forcePsiPostprocessAndRestoreElement(element);
}
