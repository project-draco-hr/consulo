{
  final Application app=ApplicationManager.getApplication();
  app.assertIsDispatchThread();
  if (myBackgroundIndexing) {
    final List<Runnable> dumbAware=CollectionFactory.arrayList();
    for (Iterator<Runnable> iterator=myPostStartupActivities.iterator(); iterator.hasNext(); ) {
      Runnable runnable=iterator.next();
      if (runnable instanceof DumbAware) {
        dumbAware.add(runnable);
        iterator.remove();
      }
    }
    runActivities(dumbAware);
    DumbService.getInstance().runWhenSmart(new Runnable(){
      public void run(){
        if (myProject.isDisposed())         return;
        runActivities(myPostStartupActivities);
        myPostStartupActivities.clear();
        myPostStartupActivityPassed=true;
      }
    }
);
  }
 else {
    runActivities(myPostStartupActivities);
    myPostStartupActivities.clear();
    myPostStartupActivityPassed=true;
  }
  if (app.isUnitTestMode())   return;
  VirtualFileManager.getInstance().refresh(!app.isHeadlessEnvironment());
}
