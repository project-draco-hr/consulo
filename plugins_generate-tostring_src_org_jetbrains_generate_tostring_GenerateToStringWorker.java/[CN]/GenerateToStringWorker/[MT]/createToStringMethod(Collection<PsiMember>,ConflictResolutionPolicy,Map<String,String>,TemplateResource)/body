{
  String body=velocityGenerateCode(selectedMembers,params,template.getMethodBody());
  if (logger.isDebugEnabled())   logger.debug("Method body generated from Velocity:\n" + body);
  body=StringUtil.convertLineSeparators(body);
  final JVMElementFactory topLevelFactory=JVMElementFactories.getFactory(clazz.getLanguage(),clazz.getProject());
  PsiMethod newMethod=topLevelFactory.createMethodFromText(template.getMethodSignature() + " { " + body+ " }",clazz);
  CodeStyleManager.getInstance(clazz.getProject()).reformat(newMethod);
  PsiMethod existingMethod=clazz.findMethodBySignature(newMethod,false);
  PsiMethod toStringMethod=policy.applyMethod(clazz,existingMethod,newMethod,editor);
  if (toStringMethod == null) {
    return null;
  }
  if (hasOverrideAnnotation) {
    toStringMethod.getModifierList().addAnnotation("java.lang.Override");
  }
  String existingJavaDoc=params.get("existingJavaDoc");
  String newJavaDoc=template.getJavaDoc();
  if (existingJavaDoc != null || newJavaDoc != null) {
    newJavaDoc=velocityGenerateCode(selectedMembers,params,newJavaDoc);
    if (logger.isDebugEnabled())     logger.debug("JavaDoc body generated from Velocity:\n" + newJavaDoc);
    applyJavaDoc(toStringMethod,existingJavaDoc,newJavaDoc);
  }
  return toStringMethod;
}
