{
  if (namespacesToChooseFrom.length > 1 && !ApplicationManager.getApplication().isUnitTestMode()) {
    final JList list=new JList(namespacesToChooseFrom);
    list.setCellRenderer(new FQNameCellRenderer());
    Runnable runnable=new Runnable(){
      public void run(){
        final int index=list.getSelectedIndex();
        if (index < 0)         return;
        PsiDocumentManager.getInstance(project).commitAllDocuments();
        CommandProcessor.getInstance().executeCommand(project,new Runnable(){
          public void run(){
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                try {
                  onSelection.doSomethingWithGivenStringToProduceXmlAttributeNowPlease(namespacesToChooseFrom[index]);
                }
 catch (                IncorrectOperationException ex) {
                  throw new RuntimeException(ex);
                }
              }
            }
);
          }
        }
,requestor.getText(),requestor.getFamilyName());
      }
    }
;
    new PopupChooserBuilder(list).setTitle(title).setItemChoosenCallback(runnable).createPopup().showInBestPositionFor(editor);
  }
 else {
    String defaultNs=ApplicationManager.getApplication().isUnitTestMode() ? defaultValueForTestingWhenNoVariants : "";
    final TextRange textRange=onSelection.doSomethingWithGivenStringToProduceXmlAttributeNowPlease(namespacesToChooseFrom.length > 0 ? namespacesToChooseFrom[0] : defaultNs);
    if (namespacesToChooseFrom.length == 0) {
      CommandProcessor.getInstance().executeCommand(project,new Runnable(){
        public void run(){
          if (textRange.getLength() != 0) {
            editor.getSelectionModel().setSelection(textRange.getStartOffset(),textRange.getEndOffset());
          }
          editor.getCaretModel().moveToOffset(textRange.getStartOffset());
        }
      }
,requestor.getText(),requestor.getFamilyName());
    }
  }
}
