{
  if (SystemProperties.getBooleanProperty("idea.skip.wm.patching",false))   return;
  if (!"sun.awt.X11.XToolkit".equals(Toolkit.getDefaultToolkit().getClass().getName()))   return;
  try {
    final Class<?> xwmClass=Class.forName("sun.awt.X11.XWM");
    final Method getWM=xwmClass.getDeclaredMethod("getWM");
    getWM.setAccessible(true);
    final Object xwm=getWM.invoke(null);
    if (xwm == null)     return;
    final Method getNetProtocol=xwmClass.getDeclaredMethod("getNETProtocol");
    getNetProtocol.setAccessible(true);
    final Object netProtocol=getNetProtocol.invoke(xwm);
    if (netProtocol == null)     return;
    final Method getWMName=netProtocol.getClass().getDeclaredMethod("getWMName");
    getWMName.setAccessible(true);
    final String wmName=(String)getWMName.invoke(netProtocol);
    LOG.info("WM detected: " + wmName);
    if (wmName == null)     return;
    if (wmName.startsWith("Mutter") || "Muffin".equals(wmName) || "GNOME Shell".equals(wmName)) {
      try {
        setWM(xwm,"MUTTER_WM");
      }
 catch (      NoSuchFieldException e) {
        setWM(xwm,"METACITY_WM");
      }
    }
 else     if ("Marco".equals(wmName)) {
      setWM(xwm,"METACITY_WM");
    }
 else     if ("awesome".equals(wmName)) {
      try {
        xwmClass.getDeclaredField("OTHER_NONREPARENTING_WM");
        if (System.getenv("_JAVA_AWT_WM_NONREPARENTING") == null) {
          setWM(xwm,"OTHER_NONREPARENTING_WM");
        }
      }
 catch (      NoSuchFieldException e) {
        setWM(xwm,"LG3D_WM");
      }
    }
  }
 catch (  Throwable e) {
    LOG.warn(e);
  }
}
