def update(self, bugid, ctx):
    'update bugzilla bug with reference to changeset.'

    def webroot(root):
        'strip leading prefix of repo root and turn into\n            url-safe path.'
        count = int(self.ui.config('bugzilla', 'strip', 0))
        root = util.pconvert(root)
        while (count > 0):
            c = root.find('/')
            if (c == (-1)):
                break
            root = root[(c + 1):]
            count -= 1
        return root
    mapfile = self.ui.config('bugzilla', 'style')
    tmpl = self.ui.config('bugzilla', 'template')
    t = cmdutil.changeset_templater(self.ui, self.repo, False, None, mapfile, False)
    if ((not mapfile) and (not tmpl)):
        tmpl = _('changeset {node|short} in repo {root} refers to bug {bug}.\ndetails:\n\t{desc|tabindent}')
    if tmpl:
        tmpl = templater.parsestring(tmpl, quoted=False)
        t.use_template(tmpl)
    self.ui.pushbuffer()
    t.show(ctx, changes=ctx.changeset(), bug=str(bugid), hgweb=self.ui.config('web', 'baseurl'), root=self.repo.root, webroot=webroot(self.repo.root))
    data = self.ui.popbuffer()
    self.add_comment(bugid, data, util.email(ctx.user()))
