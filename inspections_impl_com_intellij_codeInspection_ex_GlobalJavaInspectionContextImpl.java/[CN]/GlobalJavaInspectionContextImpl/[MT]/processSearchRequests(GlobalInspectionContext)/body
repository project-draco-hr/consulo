{
  final RefManager refManager=context.getRefManager();
  final AnalysisScope scope=refManager.getScope();
  final SearchScope searchScope=new GlobalSearchScope(refManager.getProject()){
    public boolean contains(    VirtualFile file){
      return !scope.contains(file) || file.getFileType() != StdFileTypes.JAVA;
    }
    public int compare(    VirtualFile file1,    VirtualFile file2){
      return 0;
    }
    public boolean isSearchInModuleContent(    @NotNull Module aModule){
      return true;
    }
    public boolean isSearchInLibraries(){
      return false;
    }
  }
;
  if (myDerivedClassesRequests != null) {
    List<SmartPsiElementPointer> sortedIDs=getSortedIDs(myDerivedClassesRequests);
    for (    SmartPsiElementPointer sortedID : sortedIDs) {
      final PsiClass psiClass=(PsiClass)sortedID.getElement();
      ((GlobalInspectionContextImpl)context).incrementJobDoneAmount(GlobalInspectionContextImpl.FIND_EXTERNAL_USAGES,ApplicationManager.getApplication().runReadAction(new Computable<String>(){
        public String compute(){
          return psiClass.getQualifiedName();
        }
      }
));
      final List<DerivedClassesProcessor> processors=myDerivedClassesRequests.get(sortedID);
      ClassInheritorsSearch.search(psiClass,searchScope,false).forEach(new PsiElementProcessorAdapter<PsiClass>(new PsiElementProcessor<PsiClass>(){
        public boolean execute(        PsiClass inheritor){
          if (scope.contains(inheritor))           return true;
          DerivedClassesProcessor[] processorsArrayed=processors.toArray(new DerivedClassesProcessor[processors.size()]);
          for (          DerivedClassesProcessor processor : processorsArrayed) {
            if (!processor.process(inheritor)) {
              processors.remove(processor);
            }
          }
          return !processors.isEmpty();
        }
      }
));
    }
    myDerivedClassesRequests=null;
  }
  if (myDerivedMethodsRequests != null) {
    List<SmartPsiElementPointer> sortedIDs=getSortedIDs(myDerivedMethodsRequests);
    for (    SmartPsiElementPointer sortedID : sortedIDs) {
      final PsiMethod psiMethod=(PsiMethod)sortedID.getElement();
      final RefMethod refMethod=(RefMethod)refManager.getReference(psiMethod);
      ((GlobalInspectionContextImpl)context).incrementJobDoneAmount(GlobalInspectionContextImpl.FIND_EXTERNAL_USAGES,refManager.getQualifiedName(refMethod));
      final List<DerivedMethodsProcessor> processors=myDerivedMethodsRequests.get(sortedID);
      OverridingMethodsSearch.search(psiMethod,searchScope,true).forEach(new PsiElementProcessorAdapter<PsiMethod>(new PsiElementProcessor<PsiMethod>(){
        public boolean execute(        PsiMethod derivedMethod){
          if (scope.contains(derivedMethod))           return true;
          DerivedMethodsProcessor[] processorsArrayed=processors.toArray(new DerivedMethodsProcessor[processors.size()]);
          for (          DerivedMethodsProcessor processor : processorsArrayed) {
            if (!processor.process(derivedMethod)) {
              processors.remove(processor);
            }
          }
          return !processors.isEmpty();
        }
      }
));
    }
    myDerivedMethodsRequests=null;
  }
  if (myFieldUsagesRequests != null) {
    List<SmartPsiElementPointer> sortedIDs=getSortedIDs(myFieldUsagesRequests);
    for (    SmartPsiElementPointer sortedID : sortedIDs) {
      final PsiField psiField=(PsiField)sortedID.getElement();
      final List<UsagesProcessor> processors=myFieldUsagesRequests.get(sortedID);
      ((GlobalInspectionContextImpl)context).incrementJobDoneAmount(GlobalInspectionContextImpl.FIND_EXTERNAL_USAGES,refManager.getQualifiedName(refManager.getReference(psiField)));
      ReferencesSearch.search(psiField,searchScope,false).forEach(new PsiReferenceProcessorAdapter(createReferenceProcessor(processors,context)));
    }
    myFieldUsagesRequests=null;
  }
  if (myClassUsagesRequests != null) {
    List<SmartPsiElementPointer> sortedIDs=getSortedIDs(myClassUsagesRequests);
    for (    SmartPsiElementPointer sortedID : sortedIDs) {
      final PsiClass psiClass=(PsiClass)sortedID.getElement();
      final List<UsagesProcessor> processors=myClassUsagesRequests.get(sortedID);
      ((GlobalInspectionContextImpl)context).incrementJobDoneAmount(GlobalInspectionContextImpl.FIND_EXTERNAL_USAGES,ApplicationManager.getApplication().runReadAction(new Computable<String>(){
        public String compute(){
          return psiClass.getQualifiedName();
        }
      }
));
      ReferencesSearch.search(psiClass,searchScope,false).forEach(new PsiReferenceProcessorAdapter(createReferenceProcessor(processors,context)));
    }
    myClassUsagesRequests=null;
  }
  if (myMethodUsagesRequests != null) {
    List<SmartPsiElementPointer> sortedIDs=getSortedIDs(myMethodUsagesRequests);
    for (    SmartPsiElementPointer sortedID : sortedIDs) {
      final PsiMethod psiMethod=(PsiMethod)sortedID.getElement();
      final List<UsagesProcessor> processors=myMethodUsagesRequests.get(sortedID);
      ((GlobalInspectionContextImpl)context).incrementJobDoneAmount(GlobalInspectionContextImpl.FIND_EXTERNAL_USAGES,refManager.getQualifiedName(refManager.getReference(psiMethod)));
      MethodReferencesSearch.search(psiMethod,searchScope,true).forEach(new PsiReferenceProcessorAdapter(createReferenceProcessor(processors,context)));
    }
    myMethodUsagesRequests=null;
  }
}
