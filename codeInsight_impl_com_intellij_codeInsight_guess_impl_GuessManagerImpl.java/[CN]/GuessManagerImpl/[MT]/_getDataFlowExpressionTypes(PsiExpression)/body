{
  PsiElement scope=forPlace.getParent();
  PsiElement lastScope=scope;
  while (true) {
    if (scope == null || scope instanceof PsiFile)     break;
    scope=scope.getParent();
    if (scope instanceof PsiCodeBlock || scope instanceof PsiFile && PsiUtil.isInJspFile(scope)) {
      lastScope=scope;
    }
  }
  final ExpressionTypeInstructionFactory factory=new ExpressionTypeInstructionFactory(forPlace);
  DataFlowRunner runner=new DataFlowRunner(factory){
    protected DfaMemoryState createMemoryState(){
      return new ExpressionTypeMemoryState(getFactory());
    }
  }
;
  if (runner.analyzeMethod(lastScope) == RunnerResult.OK) {
    final Map<PsiExpression,PsiType> map=factory.getResult();
    if (map != null) {
      return map;
    }
  }
  return Collections.emptyMap();
}
