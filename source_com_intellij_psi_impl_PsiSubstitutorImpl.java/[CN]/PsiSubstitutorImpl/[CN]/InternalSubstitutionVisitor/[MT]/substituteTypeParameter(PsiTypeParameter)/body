{
  PsiType substituted=mySubstitutionMap.get(typeParameter);
  if (typeParameter.getUserData(PREVENT_RECURSION_KEY) != null)   return PsiWildcardType.createUnbounded(typeParameter.getManager());
  if (substituted instanceof PsiWildcardType && !((PsiWildcardType)substituted).isSuper()) {
    PsiType originalBound=((PsiWildcardType)substituted).getBound();
    PsiManager manager=typeParameter.getManager();
    final PsiType[] boundTypes=typeParameter.getExtendsListTypes();
    for (    PsiType boundType : boundTypes) {
      PsiType substitutedBoundType;
synchronized (PsiLock.LOCK) {
        try {
          typeParameter.putUserData(PREVENT_RECURSION_KEY,Boolean.TRUE);
          substitutedBoundType=boundType.accept(this);
        }
  finally {
          typeParameter.putUserData(PREVENT_RECURSION_KEY,null);
        }
      }
      PsiWildcardType wildcardType=(PsiWildcardType)substituted;
      if (substitutedBoundType != null && !(substitutedBoundType instanceof PsiWildcardType) && !substitutedBoundType.equalsToText("java.lang.Object")) {
        if (originalBound == null || !substitutedBoundType.isAssignableFrom(originalBound)) {
          if (wildcardType.isExtends()) {
            final PsiType glb=GenericsUtil.getGreatestLowerBound(wildcardType.getBound(),substitutedBoundType);
            if (glb != null) {
              substituted=PsiWildcardType.createExtends(manager,glb);
            }
          }
 else {
            substituted=PsiWildcardType.createExtends(manager,substitutedBoundType);
          }
        }
      }
    }
  }
  return substituted;
}
