{
  if (elementType != null && marker != null) {
    if ((frame.modifiers & _COLLAPSE_) != 0) {
      LighterASTNode last=result || pinned ? builder_.getLatestDoneMarker() : null;
      if (last != null && last.getStartOffset() == frame.offset && state.typeExtends(last.getTokenType(),elementType)) {
        marker.drop();
        return;
      }
    }
    if (result || pinned) {
      if ((frame.modifiers & _LEFT_INNER_) != 0 && frame.leftMarker != null) {
        marker.done(elementType);
        frame.leftMarker.precede().done(((LighterASTNode)frame.leftMarker).getTokenType());
        frame.leftMarker.drop();
      }
 else       if ((frame.modifiers & _LEFT_) != 0 && frame.leftMarker != null) {
        marker.drop();
        frame.leftMarker.precede().done(elementType);
      }
 else {
        marker.done(elementType);
      }
    }
 else {
      close_marker_impl_(frame,marker,null,false);
    }
  }
 else   if (result || pinned) {
    if (marker != null) {
      marker.drop();
    }
    if ((frame.modifiers & _LEFT_INNER_) != 0 && frame.leftMarker != null) {
      frame.leftMarker.precede().done(((LighterASTNode)frame.leftMarker).getTokenType());
      frame.leftMarker.drop();
    }
  }
 else {
    close_marker_impl_(frame,marker,null,false);
  }
}
