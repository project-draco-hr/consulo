{
  myContext=context;
  List<GenerationItem> generationItems=new ArrayList<GenerationItem>();
  GenerationItem item;
  for (  VirtualFile file : getGroovyFilesToGenerate(context)) {
    if (CompilerManager.getInstance(myProject).isExcludedFromCompilation(file))     continue;
    if (CompilerConfiguration.getInstance(myProject).isResourceFile(file.getName()))     continue;
    final GroovyFileBase psiFile=findPsiFile(file);
    boolean isInTestSources=ModuleRootManager.getInstance(getModuleByFile(context,file)).getFileIndex().isInTestSourceContent(file);
    GrTopStatement[] statements=getTopStatementsInReadAction(psiFile);
    boolean needCreateTopLevelClass=!needsCreateClassFromFileName(statements);
    String prefix="";
    if (statements.length > 0 && statements[0] instanceof GrPackageDefinition) {
      prefix=getJavaClassPackage((GrPackageDefinition)statements[0]);
    }
    final Module module=getModuleByFile(context,file);
    if (module != null) {
      final GroovyFacet facet=GroovyFacet.getInstance(module);
      if (facet != null && !facet.getConfiguration().isCompileGroovyFiles()) {
        continue;
      }
    }
    if (needCreateTopLevelClass) {
      generationItems.add(new GenerationItemImpl(prefix + file.getNameWithoutExtension() + "."+ "java",module,new TimestampValidityState(file.getTimeStamp()),isInTestSources,file));
    }
    GrTypeDefinition[] typeDefinitions=ApplicationManager.getApplication().runReadAction(new Computable<GrTypeDefinition[]>(){
      public GrTypeDefinition[] compute(){
        return psiFile.getTypeDefinitions();
      }
    }
);
    for (    GrTypeDefinition typeDefinition : typeDefinitions) {
      item=new GenerationItemImpl(prefix + typeDefinition.getName() + "."+ "java",module,new TimestampValidityState(file.getTimeStamp()),isInTestSources,file);
      generationItems.add(item);
    }
  }
  return generationItems.toArray(new GenerationItem[generationItems.size()]);
}
