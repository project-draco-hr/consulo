{
  myContext=context;
  List<GenerationItem> generationItems=new ArrayList<GenerationItem>();
  GenerationItem item;
  for (  VirtualFile file : getGroovyFilesToGenerate(context)) {
    final GroovyFile psiFile=findPsiFile(file);
    boolean isInTestSources=ProjectRootManager.getInstance(myProject).getFileIndex().isInTestSourceContent(file);
    GrTopStatement[] statements=getTopStatementsInReadAction(psiFile);
    boolean needCreateTopLevelClass=!needsCreateClassFromFileName(statements);
    String prefix="";
    if (statements.length > 0 && statements[0] instanceof GrPackageDefinition) {
      prefix=getJavaClassPackage((GrPackageDefinition)statements[0]);
    }
    final Module module=getModuleByFile(context,file);
    if (needCreateTopLevelClass) {
      generationItems.add(new GenerationItemImpl(prefix + file.getNameWithoutExtension() + "."+ "java",module,new TimestampValidityState(file.getTimeStamp()),isInTestSources));
    }
    GrTypeDefinition[] typeDefinitions=ApplicationManager.getApplication().runReadAction(new Computable<GrTypeDefinition[]>(){
      public GrTypeDefinition[] compute(){
        return psiFile.getTypeDefinitions();
      }
    }
);
    for (    GrTypeDefinition typeDefinition : typeDefinitions) {
      item=new GenerationItemImpl(prefix + typeDefinition.getName() + "."+ "java",module,new TimestampValidityState(file.getTimeStamp()),isInTestSources);
      generationItems.add(item);
    }
  }
  return generationItems.toArray(new GenerationItem[generationItems.size()]);
}
