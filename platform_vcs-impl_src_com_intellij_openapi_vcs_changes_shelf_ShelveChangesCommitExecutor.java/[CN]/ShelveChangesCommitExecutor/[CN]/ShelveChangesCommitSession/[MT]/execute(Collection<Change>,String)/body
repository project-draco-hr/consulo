{
  if (changes.size() > 0 && !ChangesUtil.hasFileChanges(changes)) {
    WaitForProgressToShow.runOrInvokeLaterAboveProgress(new Runnable(){
      public void run(){
        Messages.showErrorDialog(myProject,VcsBundle.message("shelve.changes.only.directories"),VcsBundle.message("shelve.changes.action"));
      }
    }
,null,myProject);
    return;
  }
  try {
    final ShelvedChangeList list=ShelveChangesManager.getInstance(myProject).shelveChanges(changes,commitMessage,true);
    ShelvedChangesViewManager.getInstance(myProject).activateView(list);
    Change[] changesArray=changes.toArray(new Change[changes.size()]);
    ChangeList changeList=ChangesUtil.getChangeListIfOnlyOne(myProject,changesArray);
    if (changeList instanceof LocalChangeList) {
      LocalChangeList localChangeList=(LocalChangeList)changeList;
      if (localChangeList.getChanges().size() == changes.size() && !localChangeList.isReadOnly() && (!localChangeList.isDefault())) {
        ChangeListManager.getInstance(myProject).removeChangeList(localChangeList.getName());
      }
    }
  }
 catch (  final Exception ex) {
    LOG.info(ex);
    WaitForProgressToShow.runOrInvokeLaterAboveProgress(new Runnable(){
      public void run(){
        Messages.showErrorDialog(myProject,VcsBundle.message("create.patch.error.title",ex.getMessage()),CommonBundle.getErrorTitle());
      }
    }
,ModalityState.NON_MODAL,myProject);
  }
}
