{
  final PropertyChangeListener myListener=new PropertyChangeListener(){
    public void propertyChange(    final PropertyChangeEvent evt){
      String propertyName=evt.getPropertyName();
      if (EncodingManager.PROP_NATIVE2ASCII_SWITCH.equals(propertyName) || EncodingManager.PROP_PROPERTIES_FILES_ENCODING.equals(propertyName)) {
        DumbService.getInstance(myProject).smartInvokeLater(new Runnable(){
          public void run(){
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                if (myProject.isDisposed())                 return;
                Collection<VirtualFile> filesToRefresh=FileBasedIndex.getInstance().getContainingFiles(FileTypeIndex.NAME,PropertiesFileType.INSTANCE,GlobalSearchScope.allScope(myProject));
                VirtualFile[] virtualFiles=VfsUtil.toVirtualFileArray(filesToRefresh);
                FileDocumentManager.getInstance().saveAllDocuments();
                for (                VirtualFile virtualFile : virtualFiles) {
                  virtualFile.setCharset(null);
                }
                FileDocumentManager.getInstance().reloadFiles(virtualFiles);
              }
            }
);
          }
        }
);
      }
    }
  }
;
  EncodingManager.getInstance().addPropertyChangeListener(myListener,myProject);
}
