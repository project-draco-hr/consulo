{
  EncodingManager.getInstance().addPropertyChangeListener(new PropertyChangeListener(){
    public void propertyChange(    final PropertyChangeEvent evt){
      if (EncodingManager.PROP_NATIVE2ASCII_SWITCH.equals(evt.getPropertyName()) || EncodingManager.PROP_PROPERTIES_FILES_ENCODING.equals(evt.getPropertyName())) {
        DumbService.getInstance().smartInvokeLater(new Runnable(){
          public void run(){
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                if (ApplicationManager.getApplication().isDisposed())                 return;
                Collection<VirtualFile> filesToRefresh=new THashSet<VirtualFile>(getAllPropertiesFiles());
                VirtualFile[] virtualFiles=filesToRefresh.toArray(new VirtualFile[filesToRefresh.size()]);
                FileDocumentManager.getInstance().saveAllDocuments();
                for (                VirtualFile virtualFile : virtualFiles) {
                  virtualFile.setCharset(null);
                }
                FileDocumentManager.getInstance().reloadFiles(virtualFiles);
              }
            }
);
          }
        }
);
      }
    }
  }
);
}
