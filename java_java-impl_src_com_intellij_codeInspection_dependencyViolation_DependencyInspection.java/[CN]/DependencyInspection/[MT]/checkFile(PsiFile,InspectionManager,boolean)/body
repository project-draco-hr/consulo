{
  if (file == null)   return null;
  if (file.getViewProvider().getPsi(StdLanguages.JAVA) == null)   return null;
  final DependencyValidationManager validationManager=DependencyValidationManager.getInstance(file.getProject());
  if (!validationManager.hasRules())   return null;
  if (validationManager.getApplicableRules(file).length == 0)   return null;
  final ArrayList<ProblemDescriptor> problems=new ArrayList<ProblemDescriptor>();
  ForwardDependenciesBuilder builder=new ForwardDependenciesBuilder(file.getProject(),new AnalysisScope(file));
  builder.analyzeFileDependencies(file,new DependenciesBuilder.DependencyProcessor(){
    public void process(    PsiElement place,    PsiElement dependency){
      PsiFile dependencyFile=dependency.getContainingFile();
      if (dependencyFile != null && dependencyFile.isPhysical() && dependencyFile.getVirtualFile() != null) {
        final DependencyRule[] rule=validationManager.getViolatorDependencyRules(file,dependencyFile);
        for (        DependencyRule dependencyRule : rule) {
          StringBuffer message=new StringBuffer();
          message.append(MessageFormat.format(InspectionsBundle.message("inspection.dependency.violator.problem.descriptor"),dependencyRule.getDisplayText()));
          problems.add(manager.createProblemDescriptor(place,message.toString(),isOnTheFly,new LocalQuickFix[]{new EditDependencyRulesAction(dependencyRule)},ProblemHighlightType.GENERIC_ERROR_OR_WARNING));
        }
      }
    }
  }
);
  return problems.isEmpty() ? null : problems.toArray(new ProblemDescriptor[problems.size()]);
}
