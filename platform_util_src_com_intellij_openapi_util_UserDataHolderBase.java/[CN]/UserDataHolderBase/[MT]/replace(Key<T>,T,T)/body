{
  while (true) {
    try {
      ConcurrentMap<Key,Object> map=getOrCreateMap();
      if (oldValue == null) {
        return newValue == null || map.putIfAbsent(key,newValue) == null;
      }
      if (newValue == null) {
        boolean removed=map.remove(key,oldValue);
        if (removed) {
          nullifyMapFieldIfEmpty();
        }
        return removed;
      }
      return map.replace(key,oldValue,newValue);
    }
 catch (    ConcurrentModificationException ignored) {
    }
  }
}
