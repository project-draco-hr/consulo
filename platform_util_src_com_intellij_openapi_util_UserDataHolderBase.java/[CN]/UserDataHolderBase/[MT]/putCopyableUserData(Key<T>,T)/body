{
  while (true) {
    SmartFMap<Key,Object> map=myUserMap;
    @SuppressWarnings("unchecked") SmartFMap<Key,Object> copyableMap=(SmartFMap<Key,Object>)map.get(COPYABLE_USER_MAP_KEY);
    if (copyableMap == null) {
      copyableMap=SmartFMap.emptyMap();
    }
    SmartFMap<Key,Object> newCopyableMap=value == null ? copyableMap.minus(key) : copyableMap.plus(key,value);
    SmartFMap<Key,Object> newMap=newCopyableMap.isEmpty() ? map.minus(COPYABLE_USER_MAP_KEY) : map.plus(COPYABLE_USER_MAP_KEY,newCopyableMap);
    if (newMap == map || updater.compareAndSet(this,map,newMap)) {
      return;
    }
  }
}
