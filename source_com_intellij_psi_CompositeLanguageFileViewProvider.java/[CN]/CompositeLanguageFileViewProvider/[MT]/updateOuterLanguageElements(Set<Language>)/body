{
  for (  Map.Entry<Language,PsiFile> entry : myRoots.entrySet()) {
    final PsiFile psiFile=entry.getValue();
    final Language updatedLanguage=entry.getKey();
    if (reparsedRoots.contains(updatedLanguage))     continue;
    final Set<WeakReference<OuterLanguageElement>> list=myOuterLanguageElements.get(psiFile);
    if (list == null)     continue;
    try {
      myRootsInUpdate.add(psiFile);
      final Iterator<WeakReference<OuterLanguageElement>> iterator=list.iterator();
      XmlText prevText=null;
      while (iterator.hasNext()) {
        WeakReference<OuterLanguageElement> reference=iterator.next();
        final OuterLanguageElement outerElement=reference.get();
        if (outerElement == null) {
          iterator.remove();
          continue;
        }
        final FileElement file=TreeUtil.getFileElement(outerElement);
        if (file == null || file.getPsi() != psiFile) {
          iterator.remove();
          continue;
        }
        final XmlText nextText=outerElement.getFollowingText();
        final TextRange textRange=new TextRange(prevText != null ? prevText.getTextRange().getEndOffset() : 0,nextText != null ? nextText.getTextRange().getStartOffset() : getContents().length());
        if (!textRange.equals(outerElement.getTextRange())) {
          outerElement.setRange(textRange);
        }
        prevText=nextText;
      }
    }
  finally {
      myRootsInUpdate.remove(psiFile);
      checkConsistensy(psiFile);
    }
  }
}
