{
  for (  Map.Entry<Language,PsiFile> entry : myRoots.entrySet()) {
    final PsiFile psiFile=entry.getValue();
    final Language updatedLanguage=entry.getKey();
    if (reparsedRoots.contains(updatedLanguage))     continue;
    SoftReference<Set<OuterLanguageElement>> outerSet=myOuterLanguageElements.get(psiFile);
    if (outerSet == null) {
      continue;
    }
    try {
      myRootsInUpdate.add(psiFile);
      Set<OuterLanguageElement> languageElements=outerSet.get();
      if (languageElements == null) {
        psiFile.accept(new PsiElementVisitor(){
          public void visitReferenceExpression(          PsiReferenceExpression expression){
          }
          public void visitElement(          PsiElement element){
            if (element instanceof OuterLanguageElement) {
              registerOuterLanguageElement((OuterLanguageElement)element,psiFile);
            }
 else             element.acceptChildren(this);
          }
        }
);
        outerSet=myOuterLanguageElements.get(psiFile);
        languageElements=outerSet.get();
      }
      final Iterator<OuterLanguageElement> iterator=languageElements.iterator();
      XmlText prevText=null;
      while (iterator.hasNext()) {
        final OuterLanguageElement outerElement=iterator.next();
        if (outerElement == null) {
          iterator.remove();
          continue;
        }
        final FileElement file=TreeUtil.getFileElement(outerElement);
        if (file == null || file.getPsi() != psiFile) {
          iterator.remove();
          continue;
        }
        final XmlText nextText=outerElement.getFollowingText();
        final TextRange textRange=new TextRange(prevText != null ? prevText.getTextRange().getEndOffset() : 0,nextText != null ? nextText.getTextRange().getStartOffset() : getContents().length());
        if (!textRange.equals(outerElement.getTextRange())) {
          outerElement.setRange(textRange);
        }
        prevText=nextText;
      }
    }
  finally {
      myRootsInUpdate.remove(psiFile);
      checkConsistensy(psiFile);
    }
  }
}
