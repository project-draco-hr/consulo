{
  final CompositeLanguageFileViewProvider viewProvider=cloneInner();
  final PsiFileImpl psiFile=(PsiFileImpl)viewProvider.getPsi(getBaseLanguage());
  final FileElement treeClone=(FileElement)psiFile.calcTreeElement().clone();
  psiFile.setTreeElementPointer(treeClone);
  treeClone.setPsiElement(psiFile);
  final XmlText[] xmlTexts=JspImplUtil.gatherTexts((XmlFile)psiFile);
  for (  Map.Entry<Language,PsiFile> entry : myRoots.entrySet()) {
    final PsiFile root=entry.getValue();
    if (root != psiFile) {
      if (root instanceof PsiFileImpl) {
        final PsiFileImpl copy=(PsiFileImpl)viewProvider.getPsi(entry.getKey());
        if (copy == null)         continue;
        JspImplUtil.copyRoot((PsiFileImpl)root,xmlTexts,copy);
      }
 else {
        if (root instanceof LightPsiFileImpl) {
          final LightPsiFileImpl lightFile=(LightPsiFileImpl)root;
          final LightPsiFileImpl clone=lightFile.copyLight(viewProvider);
          clone.setOriginalFile(root);
          viewProvider.myRoots.put(entry.getKey(),clone);
        }
      }
    }
  }
  return viewProvider;
}
