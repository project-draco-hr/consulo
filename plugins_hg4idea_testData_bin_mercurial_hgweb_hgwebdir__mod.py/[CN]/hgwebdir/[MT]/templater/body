def templater(self, req):

    def header(**map):
        yield tmpl('header', encoding=encoding.encoding, **map)

    def footer(**map):
        yield tmpl('footer', **map)

    def motd(**map):
        if (self.motd is not None):
            yield self.motd
        else:
            yield config('web', 'motd', '')

    def config(section, name, default=None, untrusted=True):
        return self.ui.config(section, name, default, untrusted)
    self.updatereqenv(req.env)
    url = req.env.get('SCRIPT_NAME', '')
    if (not url.endswith('/')):
        url += '/'
    vars = {}
    styles = (req.form.get('style', [None])[0], config('web', 'style'), 'paper')
    (style, mapfile) = templater.stylemap(styles)
    if (style == styles[0]):
        vars['style'] = style
    start = (((url[(-1)] == '?') and '&') or '?')
    sessionvars = webutil.sessionvars(vars, start)
    staticurl = (config('web', 'staticurl') or (url + 'static/'))
    if (not staticurl.endswith('/')):
        staticurl += '/'
    tmpl = templater.templater(mapfile, defaults={'header': header, 'footer': footer, 'motd': motd, 'url': url, 'staticurl': staticurl, 'sessionvars': sessionvars, })
    return tmpl
