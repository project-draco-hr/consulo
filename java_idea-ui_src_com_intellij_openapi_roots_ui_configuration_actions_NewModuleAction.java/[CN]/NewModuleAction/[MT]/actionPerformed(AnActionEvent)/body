{
  final Project project=getEventProject(e);
  if (project == null) {
    return;
  }
  Object dataFromContext=prepareDataFromContext(e);
  String defaultPath=null;
  final VirtualFile virtualFile=e.getData(PlatformDataKeys.VIRTUAL_FILE);
  if (virtualFile != null && virtualFile.isDirectory()) {
    defaultPath=virtualFile.getPath();
  }
  final AddModuleWizard wizard=new AddModuleWizard(project,new DefaultModulesProvider(project),defaultPath);
  wizard.show();
  if (wizard.isOK()) {
    final ProjectBuilder builder=wizard.getProjectBuilder();
    if (builder instanceof ModuleBuilder) {
      final ModuleBuilder moduleBuilder=(ModuleBuilder)builder;
      if (moduleBuilder.getName() == null) {
        moduleBuilder.setName(wizard.getProjectName());
      }
      if (moduleBuilder.getModuleFilePath() == null) {
        moduleBuilder.setModuleFilePath(wizard.getModuleFilePath());
      }
    }
    if (!builder.validate(project,project)) {
      return;
    }
    if (builder instanceof ModuleBuilder) {
      Module module=((ModuleBuilder)builder).commitModule(project,null);
      if (module != null) {
        processCreatedModule(module,dataFromContext);
      }
    }
 else {
      builder.commit(project,null,new DefaultModulesProvider(project));
      if (builder.isOpenProjectSettingsAfter()) {
        ModulesConfigurator.showDialog(project,null,null);
      }
    }
    project.save();
  }
}
