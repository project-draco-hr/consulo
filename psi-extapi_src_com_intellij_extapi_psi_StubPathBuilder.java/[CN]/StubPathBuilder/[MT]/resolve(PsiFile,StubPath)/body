{
  PsiFileImpl fileImpl=(PsiFileImpl)file;
  StubTree tree=fileImpl.getStubTree();
  boolean foreign=(tree == null);
  if (foreign) {
    tree=fileImpl.calcStubTree();
  }
  StubElement stub=resolveStub(tree,path);
  if (foreign) {
    final PsiElement cachedPsi=((StubBase)stub).getCachedPsi();
    if (cachedPsi != null)     return cachedPsi;
    final ASTNode ast=fileImpl.findTreeForStub(tree,stub);
    return ast != null ? ast.getPsi() : null;
  }
 else {
    return stub != null ? stub.getPsi() : null;
  }
}
