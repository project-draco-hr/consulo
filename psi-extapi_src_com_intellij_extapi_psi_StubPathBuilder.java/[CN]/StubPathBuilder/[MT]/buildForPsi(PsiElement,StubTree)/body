{
  if (psi instanceof PsiFile) {
    return new Pair<StubPath,StubElement>(null,tree.getRoot());
  }
  if (psi instanceof StubBasedPsiElement) {
    final IStubElementType type=((StubBasedPsiElement)psi).getElementType();
    if (type.shouldCreateStub(psi.getNode())) {
      final Pair<StubPath,StubElement> parentPair=buildForPsi(psi.getParent(),tree);
      final StubElement parentStub=parentPair.getSecond();
      final List<StubElement> childrenStubs=parentStub.getChildrenStubs();
      for (      StubElement childStub : childrenStubs) {
        if (childStub.getPsi() == psi) {
          return new Pair<StubPath,StubElement>(new StubPath(parentPair.getFirst(),buildPathElement(childStub)),childStub);
        }
      }
      return new Pair<StubPath,StubElement>(null,null);
    }
  }
  return buildForPsi(psi.getParent(),tree);
}
