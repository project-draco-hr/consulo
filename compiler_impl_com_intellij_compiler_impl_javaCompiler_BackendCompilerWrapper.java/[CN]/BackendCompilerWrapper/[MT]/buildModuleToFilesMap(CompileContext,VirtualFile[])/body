{
  final Map<Module,Set<VirtualFile>> map=new HashMap<Module,Set<VirtualFile>>();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (      VirtualFile file : files) {
        final Module module=context.getModuleByFile(file);
        if (module == null) {
          continue;
        }
        Set<VirtualFile> moduleFiles=map.get(module);
        if (moduleFiles == null) {
          moduleFiles=new HashSet<VirtualFile>();
          map.put(module,moduleFiles);
        }
        moduleFiles.add(file);
      }
    }
  }
);
  return map;
}
