{
  final Map<Module,List<VirtualFile>> map=new THashMap<Module,List<VirtualFile>>();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (      VirtualFile file : files) {
        final Module module=context.getModuleByFile(file);
        if (module == null) {
          continue;
        }
        List<VirtualFile> moduleFiles=map.get(module);
        if (moduleFiles == null) {
          moduleFiles=new ArrayList<VirtualFile>();
          map.put(module,moduleFiles);
        }
        moduleFiles.add(file);
      }
    }
  }
);
  return map;
}
