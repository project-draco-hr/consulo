{
  if (!CompilerConfiguration.MAKE_ENABLED) {
    return Collections.emptyList();
  }
  myCompileContext.getProgressIndicator().setText(CompilerBundle.message("progress.checking.dependencies"));
  final DependencyCache dependencyCache=myCompileContext.getDependencyCache();
  final long start=System.currentTimeMillis();
  final Pair<int[],Set<VirtualFile>> deps=dependencyCache.findDependentClasses(myCompileContext,myProject,mySuccesfullyCompiledJavaFiles,myCompiler.getDependencyProcessor());
  CompilerUtil.logDuration("Dependent classes marking",System.currentTimeMillis() - start);
  final TIntHashSet currentDeps=new TIntHashSet(deps.getFirst());
  currentDeps.removeAll(myProcessedNames.toArray());
  final int[] depQNames=currentDeps.toArray();
  myProcessedNames.addAll(deps.getFirst());
  final Set<VirtualFile> depFiles=new HashSet<VirtualFile>(deps.getSecond());
  depFiles.removeAll(myProcessedFiles);
  myProcessedFiles.addAll(deps.getSecond());
  final Set<VirtualFile> dependentFiles=new HashSet<VirtualFile>();
  final CacheCorruptedException[] _ex={null};
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      try {
        CompilerConfiguration compilerConfiguration=CompilerConfiguration.getInstance(myProject);
        SourceFileFinder sourceFileFinder=new SourceFileFinder(myProject,myCompileContext);
        final Cache cache=dependencyCache.getCache();
        for (        final int infoQName : depQNames) {
          final String qualifiedName=dependencyCache.resolve(infoQName);
          final VirtualFile file=sourceFileFinder.findSourceFile(qualifiedName,cache.getSourceFileName(infoQName));
          if (file != null) {
            if (!compilerConfiguration.isExcludedFromCompilation(file)) {
              dependentFiles.add(file);
              if (ApplicationManager.getApplication().isUnitTestMode()) {
                LOG.assertTrue(file.isValid());
                CompilerManagerImpl.addRecompiledPath(file.getPath());
              }
            }
          }
 else {
            if (LOG.isDebugEnabled()) {
              LOG.debug("No source file for " + dependencyCache.resolve(infoQName) + " found");
            }
          }
        }
        for (        final VirtualFile file : depFiles) {
          if (!compilerConfiguration.isExcludedFromCompilation(file)) {
            dependentFiles.add(file);
            if (ApplicationManager.getApplication().isUnitTestMode()) {
              LOG.assertTrue(file.isValid());
              CompilerManagerImpl.addRecompiledPath(file.getPath());
            }
          }
        }
      }
 catch (      CacheCorruptedException e) {
        _ex[0]=e;
      }
    }
  }
);
  if (_ex[0] != null) {
    throw _ex[0];
  }
  myCompileContext.getProgressIndicator().setText(CompilerBundle.message("progress.found.dependent.files",dependentFiles.size()));
  CompilerUtil.logDuration("Finding dependent files in total",System.currentTimeMillis() - start);
  return dependentFiles;
}
