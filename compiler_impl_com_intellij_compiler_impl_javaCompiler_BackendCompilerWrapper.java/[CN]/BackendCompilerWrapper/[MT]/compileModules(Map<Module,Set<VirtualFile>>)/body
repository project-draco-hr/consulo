{
  final List<ModuleChunk> chunks=getModuleChunks(moduleToFilesMap);
  for (  final ModuleChunk chunk : chunks) {
    runTransformingCompilers(chunk);
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        final Module[] modules=chunk.getModules();
        final StringBuilder names=StringBuilderSpinAllocator.alloc();
        try {
          for (int idx=0; idx < modules.length; idx++) {
            final Module module=modules[idx];
            if (idx > 0) {
              names.append(", ");
            }
            names.append(module.getName());
            if (names.length() > 128 && idx + 1 < modules.length) {
              names.append("...");
              break;
            }
          }
          myModuleName=names.toString();
        }
  finally {
          StringBuilderSpinAllocator.dispose(names);
        }
      }
    }
);
    File fileToDelete=null;
    final List<OutputDir> pairs=new ArrayList<OutputDir>();
    if (chunk.getModuleCount() == 1) {
      final Module module=chunk.getModules()[0];
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          final String sourcesOutputDir=getOutputDir(module);
          if (shouldCompileTestsSeparately(module)) {
            if (sourcesOutputDir != null) {
              pairs.add(new OutputDir(sourcesOutputDir,ModuleChunk.SOURCES));
            }
            final String testsOutputDir=getTestsOutputDir(module);
            if (testsOutputDir == null) {
              LOG.error("Tests output dir is null for module \"" + module.getName() + "\"");
            }
 else {
              pairs.add(new OutputDir(testsOutputDir,ModuleChunk.TEST_SOURCES));
            }
          }
 else {
            if (sourcesOutputDir == null) {
              LOG.error("Sources output dir is null for module \"" + module.getName() + "\"");
            }
 else {
              pairs.add(new OutputDir(sourcesOutputDir,ModuleChunk.ALL_SOURCES));
            }
          }
        }
      }
);
    }
 else {
      final File outputDir=FileUtil.createTempDirectory("compile","output");
      fileToDelete=outputDir;
      pairs.add(new OutputDir(outputDir.getPath(),ModuleChunk.ALL_SOURCES));
    }
    try {
      for (      final OutputDir outputDir : pairs) {
        doCompile(chunk,outputDir.getPath(),outputDir.getKind());
        if (myCompileContext.getMessageCount(CompilerMessageCategory.ERROR) > 0) {
          return;
        }
      }
    }
  finally {
      if (fileToDelete != null) {
        FileUtil.asyncDelete(fileToDelete);
      }
    }
  }
}
