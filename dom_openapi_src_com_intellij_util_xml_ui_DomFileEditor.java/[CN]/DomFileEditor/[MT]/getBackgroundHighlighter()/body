{
  final DomManager domManager=DomManager.getDomManager(getProject());
  final DomElementAnnotationsManager annotationsManager=DomElementAnnotationsManager.getInstance(getProject());
  final WolfTheProblemSolver wolf=WolfTheProblemSolver.getInstance(getProject());
  return new BackgroundEditorHighlighter(){
    public HighlightingPass[] createPassesForEditor(){
      return ContainerUtil.map2Array(getDocuments(),HighlightingPass.class,new Function<Document,HighlightingPass>(){
        public HighlightingPass fun(        final Document document){
          return new TextEditorHighlightingPass(getProject(),document){
            public void doCollectInformation(            ProgressIndicator progress){
              if (myUserActivityListener != null && myUserActivityListener.isWaiting())               return;
              final PsiFile file=getDocumentManager().getPsiFile(document);
              if (file instanceof XmlFile) {
                final XmlFile xmlFile=(XmlFile)file;
                final DomFileElement<DomElement> element=domManager.getFileElement(xmlFile);
                if (element != null) {
                  annotationsManager.getProblemHolder(element);
                }
              }
            }
            public void doApplyInformationToEditor(){
              if (myUserActivityListener != null && myUserActivityListener.isWaiting())               return;
              final PsiFile file=getDocumentManager().getPsiFile(document);
              if (file instanceof XmlFile) {
                final DomFileElement<DomElement> element=domManager.getFileElement((XmlFile)file);
                if (!annotationsManager.getCachedProblemHolder(element).getProblems(element,true,true).isEmpty()) {
                  wolf.weHaveGotProblem(new Problem(){
                    public VirtualFile getVirtualFile(){
                      return file.getVirtualFile();
                    }
                  }
);
                }
              }
              if (isInitialised()) {
                reset();
              }
            }
          }
;
        }
      }
);
    }
    public HighlightingPass[] createPassesForVisibleArea(){
      return createPassesForEditor();
    }
  }
;
}
