{
  if (myFilesToRefresh.isEmpty()) {
    return;
  }
  Map<ProjectSystemId,Set<String>> copy=ContainerUtilRt.newHashMap();
  Lock fileLock=myVfsLock.writeLock();
  fileLock.lock();
  try {
    copy.putAll(myFilesToRefresh);
    myFilesToRefresh.clear();
  }
  finally {
    fileLock.unlock();
  }
  FileDocumentManager fileDocumentManager=FileDocumentManager.getInstance();
  LocalFileSystem fileSystem=LocalFileSystem.getInstance();
  Lock documentLock=myDocumentLock.writeLock();
  documentLock.lock();
  try {
    for (    Set<String> paths : copy.values()) {
      for (      String path : paths) {
        VirtualFile file=fileSystem.findFileByPath(path);
        if (file != null) {
          Document document=fileDocumentManager.getCachedDocument(file);
          if (document != null) {
            myDocumentsToSave.remove(document);
          }
        }
      }
    }
  }
  finally {
    documentLock.unlock();
  }
  for (  Map.Entry<ProjectSystemId,Set<String>> entry : copy.entrySet()) {
    for (    String path : entry.getValue()) {
      ExternalSystemUtil.refreshProject(myProject,entry.getKey(),path,myRefreshCallback,true,false,false);
    }
  }
}
