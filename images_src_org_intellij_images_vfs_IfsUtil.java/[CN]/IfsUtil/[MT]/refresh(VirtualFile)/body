{
  Long loadedTimeStamp=file.getUserData(TIMESTAMP_KEY);
  SoftReference<BufferedImage> imageRef=file.getUserData(BUFFERED_IMAGE_REF_KEY);
  if (loadedTimeStamp == null || loadedTimeStamp.longValue() != file.getTimeStamp() || imageRef == null || imageRef.get() == null) {
    try {
      final byte[] content=file.contentsToByteArray();
      InputStream inputStream=new ByteArrayInputStream(content,0,content.length);
      ImageInputStream imageInputStream=ImageIO.createImageInputStream(inputStream);
      try {
        Iterator<ImageReader> imageReaders=ImageIO.getImageReaders(imageInputStream);
        if (imageReaders.hasNext()) {
          ImageReader imageReader=imageReaders.next();
          try {
            file.putUserData(FORMAT_KEY,imageReader.getFormatName());
            ImageReadParam param=imageReader.getDefaultReadParam();
            imageReader.setInput(imageInputStream,true,true);
            int minIndex=imageReader.getMinIndex();
            BufferedImage image=imageReader.read(minIndex,param);
            file.putUserData(BUFFERED_IMAGE_REF_KEY,new SoftReference<BufferedImage>(image));
            return true;
          }
  finally {
            imageReader.dispose();
          }
        }
      }
  finally {
        imageInputStream.close();
      }
    }
  finally {
      file.putUserData(TIMESTAMP_KEY,file.getTimeStamp());
    }
  }
  return false;
}
