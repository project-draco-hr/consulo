{
  FoldingStack localFoldingStack=isCustomFoldingRoot(node) || foldingStack == null ? new FoldingStack(node) : foldingStack;
  for (ASTNode child=node.getFirstChildNode(); child != null; child=child.getTreeNext()) {
    if (isCustomRegionStart(child)) {
      localFoldingStack.push(child);
    }
 else     if (isCustomRegionEnd(child)) {
      if (!localFoldingStack.isEmpty()) {
        ASTNode startNode=localFoldingStack.pop();
        int startOffset=startNode.getTextRange().getStartOffset();
        TextRange range=new TextRange(startOffset,child.getTextRange().getEndOffset());
        descriptors.add(new FoldingDescriptor(localFoldingStack.getOwner(),range));
      }
    }
 else {
      addCustomFoldingRegionsRecursively(localFoldingStack,child,descriptors);
    }
  }
}
