def diff(self, ctx, ref=None):
    maxdiff = int(self.ui.config('notify', 'maxdiff', 300))
    prev = ctx.parents()[0].node()
    ref = ((ref and ref.node()) or ctx.node())
    chunks = patch.diff(self.repo, prev, ref, opts=patch.diffopts(self.ui))
    difflines = ''.join(chunks).splitlines()
    if self.ui.configbool('notify', 'diffstat', True):
        s = patch.diffstat(difflines)
        if s:
            self.ui.write(('\ndiffstat:\n\n%s' % s))
    if (maxdiff == 0):
        return
    elif ((maxdiff > 0) and (len(difflines) > maxdiff)):
        msg = _('\ndiffs (truncated from %d to %d lines):\n\n')
        self.ui.write((msg % (len(difflines), maxdiff)))
        difflines = difflines[:maxdiff]
    elif difflines:
        self.ui.write((_('\ndiffs (%d lines):\n\n') % len(difflines)))
    self.ui.write('\n'.join(difflines))
