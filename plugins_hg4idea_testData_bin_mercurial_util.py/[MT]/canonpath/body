def canonpath(root, cwd, myname):
    'return the canonical path of myname, given cwd and root'
    if endswithsep(root):
        rootsep = root
    else:
        rootsep = (root + os.sep)
    name = myname
    if (not os.path.isabs(name)):
        name = os.path.join(root, cwd, name)
    name = os.path.normpath(name)
    audit_path = path_auditor(root)
    if ((name != rootsep) and name.startswith(rootsep)):
        name = name[len(rootsep):]
        audit_path(name)
        return pconvert(name)
    elif (name == root):
        return ''
    else:
        root_st = os.stat(root)
        rel = []
        while True:
            try:
                name_st = os.stat(name)
            except OSError:
                break
            if samestat(name_st, root_st):
                if (not rel):
                    return ''
                rel.reverse()
                name = os.path.join(*rel)
                audit_path(name)
                return pconvert(name)
            (dirname, basename) = os.path.split(name)
            rel.append(basename)
            if (dirname == name):
                break
            name = dirname
        raise Abort(('%s not under root' % myname))
