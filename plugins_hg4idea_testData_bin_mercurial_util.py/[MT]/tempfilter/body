def tempfilter(s, cmd):
    'filter string S through a pair of temporary files with CMD.\n    CMD is used as a template to create the real command to be run,\n    with the strings INFILE and OUTFILE replaced by the real names of\n    the temporary files generated.'
    (inname, outname) = (None, None)
    try:
        (infd, inname) = tempfile.mkstemp(prefix='hg-filter-in-')
        fp = os.fdopen(infd, 'wb')
        fp.write(s)
        fp.close()
        (outfd, outname) = tempfile.mkstemp(prefix='hg-filter-out-')
        os.close(outfd)
        cmd = cmd.replace('INFILE', inname)
        cmd = cmd.replace('OUTFILE', outname)
        code = os.system(cmd)
        if ((sys.platform == 'OpenVMS') and (code & 1)):
            code = 0
        if code:
            raise Abort((_("command '%s' failed: %s") % (cmd, explain_exit(code))))
        return open(outname, 'rb').read()
    finally:
        try:
            if inname:
                os.unlink(inname)
        except:
            pass
        try:
            if outname:
                os.unlink(outname)
        except:
            pass
