def copyfiles(src, dst, hardlink=None):
    'Copy a directory tree using hardlinks if possible'
    if (hardlink is None):
        hardlink = (os.stat(src).st_dev == os.stat(os.path.dirname(dst)).st_dev)
    if os.path.isdir(src):
        os.mkdir(dst)
        for (name, kind) in osutil.listdir(src):
            srcname = os.path.join(src, name)
            dstname = os.path.join(dst, name)
            copyfiles(srcname, dstname, hardlink)
    elif hardlink:
        try:
            os_link(src, dst)
        except (IOError, OSError):
            hardlink = False
            shutil.copy(src, dst)
    else:
        shutil.copy(src, dst)
