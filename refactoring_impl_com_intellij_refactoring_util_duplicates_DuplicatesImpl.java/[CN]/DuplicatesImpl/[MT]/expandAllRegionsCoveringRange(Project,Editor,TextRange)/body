{
  final FoldRegion[] foldRegions=CodeFoldingManager.getInstance(project).getFoldRegionsAtOffset(editor,textRange.getStartOffset());
  boolean anyCollapsed=false;
  for (int i=0; i < foldRegions.length; i++) {
    final FoldRegion foldRegion=foldRegions[i];
    if (!foldRegion.isExpanded()) {
      anyCollapsed=true;
      break;
    }
  }
  if (anyCollapsed) {
    editor.getFoldingModel().runBatchFoldingOperation(new Runnable(){
      public void run(){
        for (int i=0; i < foldRegions.length; i++) {
          final FoldRegion foldRegion=foldRegions[i];
          if (!foldRegion.isExpanded()) {
            foldRegion.setExpanded(true);
          }
        }
      }
    }
);
  }
}
