{
  final FormattingDocumentModel docModel=model.getDocumentModel();
  final Block block=model.getRootBlock();
  final FormatProcessor processor=new FormatProcessor(docModel,block,settings,indentOptions,affectedRange);
  final WhiteSpace whiteSpace=processor.getWhiteSpaceBefore(offset);
  if (whiteSpace == null)   return offset;
  boolean wsContainsCaret=whiteSpace.getTextRange().getStartOffset() <= offset && whiteSpace.getTextRange().getEndOffset() > offset;
  final String text=model.getDocumentModel().getText();
  int lineStartOffset=offset;
  lineStartOffset=CharArrayUtil.shiftBackwardUntil(text,lineStartOffset," \t\n");
  if (lineStartOffset > whiteSpace.getTextRange().getStartOffset()) {
    if (text.charAt(lineStartOffset) == '\n') {
      lineStartOffset--;
    }
    lineStartOffset=CharArrayUtil.shiftBackward(text,lineStartOffset,"\t ");
    if (lineStartOffset != offset && text.charAt(lineStartOffset) == '\n') {
      lineStartOffset++;
    }
  }
  processor.setAllWhiteSpacesAreReadOnly();
  if (whiteSpace == null) {
    return offset;
  }
  whiteSpace.setLineFeedsAreReadOnly(true);
  final IndentInfo indent;
  if (docModel.getLineNumber(offset) == docModel.getLineNumber(whiteSpace.getTextRange().getEndOffset())) {
    whiteSpace.setReadOnly(false);
    processor.formatWithoutRealModifications();
    indent=new IndentInfo(0,whiteSpace.getIndentOffset(),whiteSpace.getSpaces());
  }
 else {
    indent=processor.getIndentAt(offset);
  }
  final String newWS=whiteSpace.generateWhiteSpace(indentOptions,lineStartOffset,indent);
  model.replaceWhiteSpace(whiteSpace.getTextRange(),newWS,block.getTextRange().getLength());
  if (wsContainsCaret) {
    return whiteSpace.getTextRange().getStartOffset() + CharArrayUtil.shiftForward(newWS.toCharArray(),lineStartOffset - whiteSpace.getTextRange().getStartOffset()," \t");
  }
 else {
    return offset - whiteSpace.getTextRange().getLength() + newWS.length();
  }
}
