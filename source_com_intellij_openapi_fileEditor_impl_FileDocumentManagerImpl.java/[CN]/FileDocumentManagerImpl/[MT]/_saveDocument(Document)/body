{
  boolean committed=false;
  try {
    VirtualFile file=getFile(document);
    if (file == null || !file.isValid() || file instanceof LightVirtualFile) {
      myUnsavedDocuments.remove(document);
      LOG.assertTrue(!myUnsavedDocuments.contains(document));
      return;
    }
    if (!isFileModified(file)) {
      myUnsavedDocuments.remove(document);
      LOG.assertTrue(!myUnsavedDocuments.contains(document));
      return;
    }
    if (needsRefresh(file)) {
      file.refresh(false,false);
      if (!myUnsavedDocuments.contains(document))       return;
      if (!file.isValid())       return;
    }
    try {
      for (      FileDocumentSynchronizationVetoListener listener : myVetoDispatcher.getListeners()) {
        listener.beforeDocumentSaving(document);
      }
    }
 catch (    VetoDocumentSavingException e) {
      return;
    }
    myBus.syncPublisher(AppTopics.FILE_DOCUMENT_SYNC).beforeDocumentSaving(document);
    LOG.assertTrue(file.isValid());
    Writer writer=null;
    try {
      String text=document.getText();
      String lineSeparator=getLineSeparator(document,file);
      if (!lineSeparator.equals("\n")) {
        text=StringUtil.convertLineSeparators(text,lineSeparator);
      }
      Project project=VfsUtil.guessProjectForFile(file);
      writer=LoadTextUtil.getWriter(project,file,this,text,document.getModificationStamp());
      writer.write(text);
      committed=true;
    }
  finally {
      if (writer != null) {
        writer.close();
      }
    }
  }
 catch (  IOException e) {
    reportErrorOnSave(e);
    committed=false;
  }
 finally {
    if (committed) {
      myUnsavedDocuments.remove(document);
      LOG.assertTrue(!myUnsavedDocuments.contains(document));
      ((DocumentEx)document).clearLineModificationFlags();
    }
  }
}
