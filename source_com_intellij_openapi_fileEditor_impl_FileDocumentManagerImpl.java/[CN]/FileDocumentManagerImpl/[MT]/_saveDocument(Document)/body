{
  boolean commited=false;
  try {
    Writer writer=null;
    VirtualFile file=getFile(document);
    if (file == null || !file.isValid()) {
      myUnsavedDocuments.remove(document);
      LOG.assertTrue(!myUnsavedDocuments.contains(document));
      return;
    }
    if (file.getModificationStamp() == document.getModificationStamp()) {
      myUnsavedDocuments.remove(document);
      LOG.assertTrue(!myUnsavedDocuments.contains(document));
      return;
    }
    if (file.getTimeStamp() != file.getActualTimeStamp()) {
      file.refresh(false,false);
      if (!myUnsavedDocuments.contains(document))       return;
      if (!file.isValid())       return;
    }
    try {
      myEventDispatcher.getMulticaster().beforeDocumentSaving(document);
    }
 catch (    VetoDocumentSavingException e) {
      return;
    }
    LOG.assertTrue(file.isValid());
    try {
      String text=document.getText();
      String lineSeparator=getLineSeparator(document,file);
      if (!lineSeparator.equals("\n")) {
        text=StringUtil.convertLineSeparators(text,lineSeparator);
      }
      writer=file.getWriter(this,document.getModificationStamp(),-1);
      writer.write(text);
      commited=true;
    }
  finally {
      if (writer != null) {
        writer.close();
      }
    }
  }
 catch (  IOException e) {
    reportErrorOnSave(e);
    commited=false;
  }
 finally {
    if (commited) {
      myUnsavedDocuments.remove(document);
      LOG.assertTrue(!myUnsavedDocuments.contains(document));
    }
  }
}
