{
  FileChooserDescriptor descriptor=FileChooserDescriptorFactory.createMultipleJavaPathDescriptor();
  descriptor.setTitle(ProjectBundle.message("library.attach.sources.action"));
  descriptor.setDescription(ProjectBundle.message("library.attach.sources.description"));
  final Library firstLibrary=libraries.get(0).getLibrary();
  VirtualFile[] roots=firstLibrary != null ? firstLibrary.getFiles(OrderRootType.CLASSES) : VirtualFile.EMPTY_ARRAY;
  VirtualFile[] candidates=FileChooser.chooseFiles(descriptor,myProject,roots.length == 0 ? null : PathUtil.getLocalFile(roots[0]));
  final VirtualFile[] files=PathUIUtils.scanAndSelectDetectedJavaSourceRoots(myParentComponent,candidates);
  if (files.length == 0) {
    return new ActionCallback.Rejected();
  }
  final Map<Library,LibraryOrderEntry> librariesToAppendSourcesTo=new HashMap<Library,LibraryOrderEntry>();
  for (  LibraryOrderEntry library : libraries) {
    librariesToAppendSourcesTo.put(library.getLibrary(),library);
  }
  if (librariesToAppendSourcesTo.size() == 1) {
    appendSources(firstLibrary,files);
  }
 else {
    librariesToAppendSourcesTo.put(null,null);
    final Collection<LibraryOrderEntry> orderEntries=librariesToAppendSourcesTo.values();
    JBPopupFactory.getInstance().createListPopup(new BaseListPopupStep<LibraryOrderEntry>("<html><body>Multiple libraries contain file.<br> Choose libraries to attach sources to</body></html>",orderEntries.toArray(new LibraryOrderEntry[orderEntries.size()])){
      @Override public ListSeparator getSeparatorAbove(      LibraryOrderEntry value){
        return value == null ? new ListSeparator() : null;
      }
      @NotNull @Override public String getTextFor(      LibraryOrderEntry value){
        if (value != null) {
          return value.getPresentableName() + " (" + value.getOwnerModule().getName()+ ")";
        }
 else {
          return "All";
        }
      }
      @Override public PopupStep onChosen(      LibraryOrderEntry libraryOrderEntry,      boolean finalChoice){
        if (libraryOrderEntry != null) {
          appendSources(libraryOrderEntry.getLibrary(),files);
        }
 else {
          for (          Library libOrderEntry : librariesToAppendSourcesTo.keySet()) {
            if (libOrderEntry != null) {
              appendSources(libOrderEntry,files);
            }
          }
        }
        return FINAL_CHOICE;
      }
    }
).showCenteredInCurrentWindow(myProject);
  }
  return new ActionCallback.Done();
}
