{
  if (seq instanceof CharSequenceBackedByArray) {
    return ((CharSequenceBackedByArray)seq).getChars();
  }
  if (seq instanceof CharBuffer) {
    final CharBuffer buffer=(CharBuffer)seq;
    if (buffer.hasArray() && !buffer.isReadOnly() && buffer.arrayOffset() == 0) {
      final char[] bufArray=buffer.array();
      return bufArray;
    }
    new Throwable("allocating chars 1").printStackTrace();
    char[] chars=new char[seq.length()];
    buffer.position(0);
    buffer.get(chars);
    buffer.position(0);
    return chars;
  }
  if (seq instanceof StringBuffer) {
    new Throwable("allocating chars 2").printStackTrace();
    char[] chars=new char[seq.length()];
    ((StringBuffer)seq).getChars(0,seq.length(),chars,0);
    return chars;
  }
  if (seq instanceof String) {
    new Throwable("allocating chars 3" + seq).printStackTrace();
    char[] chars=new char[seq.length()];
    ((String)seq).getChars(0,seq.length(),chars,0);
    return chars;
  }
  new Throwable("allocating chars 4:" + seq).printStackTrace();
  return seq.toString().toCharArray();
}
