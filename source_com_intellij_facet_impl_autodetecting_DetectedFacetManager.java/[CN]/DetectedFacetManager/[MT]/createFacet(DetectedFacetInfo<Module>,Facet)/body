{
  final Module module=info.getModule();
  FacetType<?,?> type=info.getFacetType();
  final Facet facet=createFacet(info,module,underlyingFacet,type);
  ModifiableFacetModel model=FacetManager.getInstance(module).createModifiableModel();
  ModifiableRootModel rootModel=ModuleRootManager.getInstance(module).getModifiableModel();
  final FacetDetector detector=myAutodetectingManager.findDetector(info.getDetectorId());
  if (detector != null) {
    detector.beforeFacetAdded(facet,model,rootModel);
  }
  model.addFacet(facet);
  if (rootModel.isChanged()) {
    rootModel.commit();
  }
 else {
    rootModel.dispose();
  }
  model.commit();
  myAutodetectingManager.getFileIndex().updateIndexEntryForCreatedFacet(info,facet);
  myAutodetectingManager.getDetectedFacetSet().removeFacetInfo(info);
  if (detector != null) {
    detector.afterFacetAdded(facet);
  }
  return facet;
}
