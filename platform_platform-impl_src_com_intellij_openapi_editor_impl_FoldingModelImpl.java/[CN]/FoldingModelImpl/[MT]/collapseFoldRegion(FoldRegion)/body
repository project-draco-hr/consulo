{
  assertIsDispatchThreadForEditor();
  if (!region.isExpanded())   return;
  if (!myIsBatchFoldingProcessing) {
    LOG.error("Fold regions must be collapsed or expanded inside batchFoldProcessing() only.");
  }
  LogicalPosition caretPosition=myEditor.getCaretModel().getLogicalPosition();
  int caretOffset=myEditor.logicalPositionToOffset(caretPosition);
  if (FoldRegionsTree.contains(region,caretOffset)) {
    if (myDoNotCollapseCaret)     return;
    if (!myCaretPositionSaved) {
      mySavedCaretX=caretPosition.column;
      mySavedCaretY=caretPosition.line;
      myCaretPositionSaved=true;
    }
  }
  int selectionStart=myEditor.getSelectionModel().getSelectionStart();
  int selectionEnd=myEditor.getSelectionModel().getSelectionEnd();
  if (FoldRegionsTree.contains(region,selectionStart - 1) || FoldRegionsTree.contains(region,selectionEnd))   myEditor.getSelectionModel().removeSelection();
  myFoldRegionsProcessed=true;
  ((FoldRegionImpl)region).setExpandedInternal(false);
  notifyListenersOnFoldRegionStateChange(region);
}
