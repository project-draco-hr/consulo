{
  assertIsDispatchThreadForEditor();
  boolean oldDontCollapseCaret=myDoNotCollapseCaret;
  myDoNotCollapseCaret|=dontCollapseCaret;
  boolean oldBatchFlag=myIsBatchFoldingProcessing;
  if (!oldBatchFlag) {
    ((ScrollingModelImpl)myEditor.getScrollingModel()).finishAnimation();
    mySavedCaretShift=myEditor.visibleLineToY(myEditor.getCaretModel().getVisualPosition().line) - myEditor.getScrollingModel().getVerticalScrollOffset();
  }
  myIsBatchFoldingProcessing=true;
  try {
    operation.run();
  }
  finally {
    if (!oldBatchFlag) {
      if (myFoldRegionsProcessed) {
        notifyBatchFoldingProcessingDone(moveCaret);
        myFoldRegionsProcessed=false;
      }
      myIsBatchFoldingProcessing=false;
    }
    myDoNotCollapseCaret=oldDontCollapseCaret;
  }
}
