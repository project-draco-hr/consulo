{
  assertIsDispatchThreadForEditor();
  if (region.isExpanded() || region.shouldNeverExpand())   return;
  if (!myIsBatchFoldingProcessing) {
    LOG.error("Fold regions must be collapsed or expanded inside batchFoldProcessing() only.");
  }
  if (myCaretPositionSaved) {
    int savedOffset=myEditor.logicalPositionToOffset(new LogicalPosition(mySavedCaretY,mySavedCaretX));
    FoldRegion[] allCollapsed=myFoldTree.fetchCollapsedAt(savedOffset);
    if (allCollapsed.length == 1 && allCollapsed[0] == region) {
      LogicalPosition pos=new LogicalPosition(mySavedCaretY,mySavedCaretX);
      myEditor.getCaretModel().moveToLogicalPosition(pos);
    }
  }
  myFoldRegionsProcessed=true;
  ((FoldRegionImpl)region).setExpandedInternal(true);
  notifyListenersOnFoldRegionStateChange(region);
}
