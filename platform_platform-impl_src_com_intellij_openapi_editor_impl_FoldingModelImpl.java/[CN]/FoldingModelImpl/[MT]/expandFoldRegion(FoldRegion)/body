{
  assertIsDispatchThreadForEditor();
  if (region.isExpanded() || region.shouldNeverExpand())   return;
  if (!myIsBatchFoldingProcessing) {
    LOG.error("Fold regions must be collapsed or expanded inside batchFoldProcessing() only.");
  }
  for (  Caret caret : myEditor.getCaretModel().getAllCarets()) {
    LogicalPosition savedPosition=caret.getUserData(SAVED_CARET_POSITION);
    if (savedPosition != null) {
      int savedOffset=myEditor.logicalPositionToOffset(savedPosition);
      FoldRegion[] allCollapsed=myFoldTree.fetchCollapsedAt(savedOffset);
      if (allCollapsed.length == 1 && allCollapsed[0] == region) {
        caret.moveToLogicalPosition(savedPosition);
      }
    }
  }
  myFoldRegionsProcessed=true;
  ((FoldRegionImpl)region).setExpandedInternal(true);
  notifyListenersOnFoldRegionStateChange(region);
}
