{
synchronized (PsiLock.LOCK) {
    if (newRoot instanceof FileElement) {
      ((FileElement)newRoot).setCharTable(file.getTreeElement().getCharTable());
    }
    try {
      newRoot.putUserData(TREE_TO_BE_REPARSED,oldRoot);
      final ASTNode childNode;
      try {
        childNode=newRoot.getFirstChildNode();
      }
 catch (      ReparsedSuccessfullyException e) {
        return;
      }
      final boolean childTooDeep=isTooDeep(childNode);
      if (isTooDeep(file) || childTooDeep) {
        replaceElementWithEvents(file,(CompositeElement)oldRoot,(CompositeElement)newRoot);
        if (childTooDeep) {
          childNode.putUserData(TREE_DEPTH_LIMIT_EXCEEDED,null);
          file.putUserData(TREE_DEPTH_LIMIT_EXCEEDED,Boolean.TRUE);
        }
        return;
      }
      TreeUtil.ensureParsedRecursively(oldRoot);
      final PomModel model=PomManager.getModel(file.getProject());
      model.runTransaction(new PomTransactionBase(file,model.getModelAspect(TreeAspect.class)){
        public PomModelEvent runInner(){
          final ASTDiffBuilder builder=new ASTDiffBuilder(file);
          DiffTree.diff(new ASTStructure(oldRoot),new ASTStructure(newRoot),new ASTShallowComparator(),builder);
          file.subtreeChanged();
          return new TreeAspectEvent(model,builder.getEvent());
        }
      }
);
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
catch (    Throwable th) {
      LOG.error(th);
    }
 finally {
      ((PsiManagerEx)file.getManager()).invalidateFile(file);
    }
  }
}
