{
  file.getViewProvider().beforeContentsSynchronized();
  final PsiFileImpl fileImpl=(PsiFileImpl)file;
  Project project=fileImpl.getProject();
  final CharTable charTable=fileImpl.getTreeElement().getCharTable();
  final int textLength=file.getTextLength() + lengthShift;
  final FileElement treeFileElement=fileImpl.getTreeElement();
  if (treeFileElement.getElementType() instanceof ITemplateDataElementType || isTooDeep(file)) {
    makeFullParse(treeFileElement,newFileText,textLength,fileImpl);
    return;
  }
  final ASTNode leafAtStart=treeFileElement.findLeafElementAt(startOffset);
  final ASTNode leafAtEnd=treeFileElement.findLeafElementAt(endOffset);
  ASTNode node=leafAtStart != null && leafAtEnd != null ? TreeUtil.findCommonParent(leafAtStart,leafAtEnd) : treeFileElement;
  Language baseLanguage=file.getViewProvider().getBaseLanguage();
  while (node != null && !(node instanceof FileElement)) {
    IElementType elementType=node.getElementType();
    if (elementType instanceof IReparseableElementType) {
      final TextRange textRange=node.getTextRange();
      final IReparseableElementType reparseable=(IReparseableElementType)elementType;
      if (reparseable.getLanguage() == baseLanguage) {
        CharSequence newTextStr=newFileText.subSequence(textRange.getStartOffset(),textRange.getStartOffset() + textRange.getLength() + lengthShift);
        if (reparseable.isParsable(newTextStr,project)) {
          ASTNode chameleon=reparseable.createNode(newTextStr);
          if (chameleon != null) {
            DummyHolder holder=DummyHolderFactory.createHolder(fileImpl.getManager(),null,node.getPsi(),charTable);
            holder.getTreeElement().rawAddChildren((TreeElement)chameleon);
            mergeTrees(fileImpl,node,chameleon);
            return;
          }
        }
      }
    }
    node=node.getTreeParent();
  }
  makeFullParse(node,newFileText,textLength,fileImpl);
}
