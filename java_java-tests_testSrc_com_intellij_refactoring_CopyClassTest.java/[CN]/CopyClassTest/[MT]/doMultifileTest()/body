{
  String root=JavaTestUtil.getJavaTestDataPath() + "/refactoring/copyClass/multifile/" + getTestName(true);
  String rootBefore=root + "/before";
  PsiTestUtil.removeAllRoots(myModule,JavaSdkImpl.getMockJdk("java 1.4"));
  VirtualFile rootDir=PsiTestUtil.createTestProjectStructure(myProject,myModule,rootBefore,myFilesToDelete);
  final HashMap<PsiFile,PsiClass[]> map=new HashMap<PsiFile,PsiClass[]>();
  final VirtualFile sourceDir=rootDir.findChild("p1");
  for (  VirtualFile file : sourceDir.getChildren()) {
    final PsiFile psiFile=myPsiManager.findFile(file);
    if (psiFile instanceof PsiJavaFile) {
      map.put(psiFile,((PsiJavaFile)psiFile).getClasses());
    }
  }
  final VirtualFile targetVDir=rootDir.findChild("p2");
  CopyClassesHandler.doCopyClasses(map,null,myPsiManager.findDirectory(targetVDir),myProject);
  String rootAfter=root + "/after";
  VirtualFile rootDir2=LocalFileSystem.getInstance().findFileByPath(rootAfter.replace(File.separatorChar,'/'));
  myProject.getComponent(PostprocessReformattingAspect.class).doPostponedFormatting();
  IdeaTestUtil.assertDirectoriesEqual(rootDir2,rootDir,IdeaTestUtil.CVS_FILE_FILTER);
}
