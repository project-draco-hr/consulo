{
  extend(CompletionType.CLASS_NAME,psiElement(),new CompletionProvider<CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet _result){
      if (shouldShowSecondSmartCompletionHint(parameters) && CompletionUtil.shouldShowFeature(parameters,CodeCompletionFeatures.SECOND_CLASS_NAME_COMPLETION)) {
        CompletionService.getCompletionService().setAdvertisementText(CompletionBundle.message("completion.class.name.hint.2",getActionShortcut(IdeActions.ACTION_CLASS_NAME_COMPLETION)));
      }
      final CompletionResultSet result=JavaCompletionSorting.addJavaSorting(parameters,_result);
      final PsiElement insertedElement=parameters.getPosition();
      final ElementFilter filter=or(JavaSmartCompletionContributor.AFTER_THROW_NEW,JavaCompletionContributor.INSIDE_METHOD_THROWS_CLAUSE,JavaCompletionContributor.IN_CATCH_TYPE).accepts(insertedElement) ? new AssignableFromFilter(CommonClassNames.JAVA_LANG_THROWABLE) : IN_TYPE_PARAMETER.accepts(insertedElement) ? new ExcludeDeclaredFilter(new ClassFilter(PsiTypeParameter.class)) : TrueFilter.INSTANCE;
      final boolean inJavaContext=parameters.getPosition() instanceof PsiIdentifier;
      if (AFTER_NEW.accepts(insertedElement)) {
        final PsiExpression expr=PsiTreeUtil.getContextOfType(insertedElement,PsiExpression.class,true);
        for (        final ExpectedTypeInfo info : ExpectedTypesProvider.getExpectedTypes(expr,true)) {
          final PsiType type=info.getType();
          final PsiClass psiClass=PsiUtil.resolveClassInType(type);
          if (psiClass != null) {
            result.addElement(createClassLookupItem(psiClass,inJavaContext));
          }
          final PsiType defaultType=info.getDefaultType();
          if (!defaultType.equals(type)) {
            final PsiClass defClass=PsiUtil.resolveClassInType(defaultType);
            if (defClass != null) {
              result.addElement(createClassLookupItem(defClass,inJavaContext));
            }
          }
        }
      }
      final boolean lookingForAnnotations=PsiJavaPatterns.psiElement().afterLeaf("@").accepts(insertedElement);
      AllClassesGetter.processJavaClasses(parameters,result.getPrefixMatcher(),parameters.getInvocationCount() <= 1,new Consumer<PsiClass>(){
        @Override public void consume(        PsiClass psiClass){
          if (lookingForAnnotations && !psiClass.isAnnotationType())           return;
          if (filter.isAcceptable(psiClass,insertedElement)) {
            result.addElement(createClassLookupItem(psiClass,inJavaContext));
          }
        }
      }
);
    }
  }
);
}
