{
  if (!CommonRefactoringUtil.checkReadOnlyStatus(project,file))   return;
  String localName=local.getName();
  final PsiExpression initializer=local.getInitializer();
  if (initializer == null) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("variable.has.no.initializer",localName));
    CommonRefactoringUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.REPLACE_TEMP_WITH_QUERY,project);
    return;
  }
  PsiSearchHelper searchHelper=PsiManager.getInstance(project).getSearchHelper();
  final PsiReference[] refs=searchHelper.findReferences(local,GlobalSearchScope.projectScope(project),false);
  if (refs.length == 0) {
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("variable.is.never.used",localName));
    CommonRefactoringUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.REPLACE_TEMP_WITH_QUERY,project);
    return;
  }
  final HighlightManager highlightManager=HighlightManager.getInstance(project);
  ArrayList<PsiReference> array=new ArrayList<PsiReference>();
  EditorColorsManager manager=EditorColorsManager.getInstance();
  final TextAttributes attributes=manager.getGlobalScheme().getAttributes(EditorColors.SEARCH_RESULT_ATTRIBUTES);
  for (  PsiReference ref : refs) {
    PsiElement refElement=ref.getElement();
    if (PsiUtil.isAccessedForWriting((PsiExpression)refElement)) {
      array.add(ref);
    }
    if (array.size() > 0) {
      PsiReference[] refsForWriting=array.toArray(new PsiReference[array.size()]);
      highlightManager.addOccurrenceHighlights(editor,refsForWriting,attributes,true,null);
      String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("variable.is.accessed.for.writing",localName));
      CommonRefactoringUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.REPLACE_TEMP_WITH_QUERY,project);
      WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
      return;
    }
  }
  final ExtractMethodProcessor processor=new ExtractMethodProcessor(project,editor,new PsiElement[]{initializer},local.getType(),REFACTORING_NAME,localName,HelpID.REPLACE_TEMP_WITH_QUERY);
  try {
    if (!processor.prepare())     return;
  }
 catch (  PrepareFailedException e) {
    CommonRefactoringUtil.showErrorMessage(REFACTORING_NAME,e.getMessage(),HelpID.REPLACE_TEMP_WITH_QUERY,project);
    ExtractMethodHandler.highlightPrepareError(e,file,editor,project);
    return;
  }
  final PsiClass targetClass=processor.getTargetClass();
  if (targetClass != null && targetClass.isInterface()) {
    String message=RefactoringBundle.message("cannot.replace.temp.with.query.in.interface");
    CommonRefactoringUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.REPLACE_TEMP_WITH_QUERY,project);
    return;
  }
  if (processor.showDialog()) {
    CommandProcessor.getInstance().executeCommand(project,new Runnable(){
      public void run(){
        final Runnable action=new Runnable(){
          public void run(){
            try {
              processor.doRefactoring();
              local.normalizeDeclaration();
              PsiExpression initializer=local.getInitializer();
              PsiExpression[] exprs=new PsiExpression[refs.length];
              for (int idx=0; idx < refs.length; idx++) {
                PsiElement ref=refs[idx].getElement();
                exprs[idx]=(PsiExpression)ref.replace(initializer);
              }
              PsiDeclarationStatement declaration=(PsiDeclarationStatement)local.getParent();
              declaration.delete();
              highlightManager.addOccurrenceHighlights(editor,exprs,attributes,true,null);
            }
 catch (            IncorrectOperationException e) {
              LOG.error(e);
            }
          }
        }
;
        ApplicationManager.getApplication().runWriteAction(action);
      }
    }
,REFACTORING_NAME,null);
    DuplicatesImpl.processDuplicates(processor,project,editor,REFACTORING_NAME);
  }
  WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
}
