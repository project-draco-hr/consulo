{
  KeyboardFocusManager focusManager=KeyboardFocusManager.getCurrentKeyboardFocusManager();
  Component component=focusManager.getFocusOwner();
  JComponent focusOwner=component instanceof JComponent ? (JComponent)component : null;
  if (focusOwner == null) {
    Project project=DataKeys.PROJECT.getData(dataContext);
    IdeFrameImpl frame=project == null ? null : ((WindowManagerEx)WindowManager.getInstance()).getFrame(project);
    focusOwner=frame == null ? null : frame.getRootPane();
    if (focusOwner == null) {
      throw new IllegalArgumentException("focusOwner cannot be null");
    }
  }
  Editor editor=DataKeys.EDITOR.getData(dataContext);
  if (editor != null && focusOwner == editor.getContentComponent()) {
    return guessBestPopupLocation(editor);
  }
 else {
    return guessBestPopupLocation(focusOwner);
  }
}
