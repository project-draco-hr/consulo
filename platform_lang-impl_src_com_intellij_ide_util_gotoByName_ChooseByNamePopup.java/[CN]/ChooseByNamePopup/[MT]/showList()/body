{
  final JLayeredPane layeredPane=myTextField.getRootPane().getLayeredPane();
  Rectangle bounds=new Rectangle(myTextFieldPanel.getLocationOnScreen(),myTextField.getSize());
  bounds.y+=myTextFieldPanel.getHeight() + (SystemInfo.isMac ? 3 : 1);
  final Dimension preferredScrollPaneSize=myListScrollPane.getPreferredSize();
  if (myList.getModel().getSize() == 0) {
    preferredScrollPaneSize.height=UIManager.getFont("Label.font").getSize();
  }
  preferredScrollPaneSize.width=Math.max(myTextFieldPanel.getWidth(),preferredScrollPaneSize.width);
  Rectangle prefferedBounds=new Rectangle(bounds.x,bounds.y,preferredScrollPaneSize.width,preferredScrollPaneSize.height);
  Rectangle original=new Rectangle(prefferedBounds);
  ScreenUtil.fitToScreen(prefferedBounds);
  if (original.width > prefferedBounds.width) {
    int height=myListScrollPane.getHorizontalScrollBar().getPreferredSize().height;
    prefferedBounds.height+=height;
  }
  myListScrollPane.setVisible(true);
  myListScrollPane.setBorder(null);
  String adText=myMayRequestCurrentWindow ? "Press " + KeymapUtil.getKeystrokeText(KeyStroke.getKeyStroke(KeyEvent.VK_ENTER,KeyEvent.SHIFT_MASK)) + " to open in current window" : null;
  if (myDropdownPopup == null) {
    ComponentPopupBuilder builder=JBPopupFactory.getInstance().createComponentPopupBuilder(myListScrollPane,myListScrollPane);
    builder.setFocusable(false).setRequestFocus(false).setCancelKeyEnabled(false).setFocusOwners(new JComponent[]{myTextField}).setBelongsToGlobalPopupStack(false).setForceHeavyweight(true).setModalContext(false).setAdText(adText).setMayBeParent(true);
    builder.setCancelCallback(new Computable<Boolean>(){
      @Override public Boolean compute(){
        return Boolean.TRUE;
      }
    }
);
    myDropdownPopup=builder.createPopup();
    myDropdownPopup.setLocation(prefferedBounds.getLocation());
    myDropdownPopup.setSize(prefferedBounds.getSize());
    myDropdownPopup.show(layeredPane);
  }
 else {
    myDropdownPopup.setLocation(prefferedBounds.getLocation());
    myDropdownPopup.setSize(prefferedBounds.getSize());
  }
}
