{
  if (dependency instanceof Reference) {
    final Object original=((Reference)dependency).get();
    if (original == null)     return -1;
    return getTimeStamp(original);
  }
  if (dependency instanceof Ref) {
    final Object original=((Ref)dependency).get();
    if (original == null)     return -1;
    return getTimeStamp(original);
  }
  if (dependency instanceof ModificationTracker) {
    return ((ModificationTracker)dependency).getModificationCount();
  }
  if (dependency instanceof PsiDirectory) {
    return myManager.getModificationTracker().getOutOfCodeBlockModificationCount();
  }
  if (dependency instanceof PsiElement) {
    PsiElement element=(PsiElement)dependency;
    if (!element.isValid())     return -1;
    PsiFile containingFile=element.getContainingFile();
    if (containingFile == null)     return -1;
    return containingFile.getModificationStamp();
  }
  if (dependency == PsiModificationTracker.MODIFICATION_COUNT) {
    return myManager.getModificationTracker().getModificationCount();
  }
 else   if (dependency == PsiModificationTracker.OUT_OF_CODE_BLOCK_MODIFICATION_COUNT) {
    return myManager.getModificationTracker().getOutOfCodeBlockModificationCount();
  }
 else   if (dependency instanceof Document) {
    return ((Document)dependency).getModificationStamp();
  }
 else {
    LOG.error("Wrong dependency type: " + dependency.getClass());
    return -1;
  }
}
