{
  PsiReferenceExpression reference=null;
  if (expression instanceof PsiAssignmentExpression) {
    final PsiExpression left=((PsiAssignmentExpression)expression).getLExpression();
    if (left instanceof PsiReferenceExpression) {
      reference=(PsiReferenceExpression)left;
    }
  }
 else   if (expression instanceof PsiPostfixExpression) {
    final PsiExpression operand=((PsiPostfixExpression)expression).getOperand();
    final IElementType sign=((PsiPostfixExpression)expression).getOperationSign().getTokenType();
    if (operand instanceof PsiReferenceExpression && (sign == JavaTokenType.PLUSPLUS || sign == JavaTokenType.MINUSMINUS)) {
      reference=(PsiReferenceExpression)operand;
    }
  }
 else   if (expression instanceof PsiPrefixExpression) {
    final PsiExpression operand=((PsiPrefixExpression)expression).getOperand();
    final IElementType sign=((PsiPrefixExpression)expression).getOperationSign().getTokenType();
    if (operand instanceof PsiReferenceExpression && (sign == JavaTokenType.PLUSPLUS || sign == JavaTokenType.MINUSMINUS)) {
      reference=(PsiReferenceExpression)operand;
    }
  }
  final PsiElement resolved=reference == null ? null : reference.resolve();
  PsiVariable variable=resolved instanceof PsiVariable ? (PsiVariable)resolved : null;
  if (variable == null || !variable.hasModifierProperty(PsiModifier.FINAL))   return null;
  if (!canWriteToFinal(variable,expression,reference)) {
    final String name=variable.getName();
    String description=JavaErrorMessages.message("assignment.to.final.variable",name);
    final HighlightInfo highlightInfo=HighlightInfo.createHighlightInfo(HighlightInfoType.ERROR,expression,description);
    final PsiClass innerClass=getInnerClassVariableReferencedFrom(variable,expression);
    if (innerClass == null || variable instanceof PsiField) {
      IntentionAction fix=QUICK_FIX_FACTORY.createModifierListFix(variable,PsiModifier.FINAL,false,false);
      QuickFixAction.registerQuickFixAction(highlightInfo,fix);
    }
 else {
      QuickFixAction.registerQuickFixAction(highlightInfo,new VariableAccessFromInnerClassFix(variable,innerClass));
    }
    return highlightInfo;
  }
  return null;
}
