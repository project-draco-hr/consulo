{
  final String url=findUrl(file,offset,uri);
  final Project project=file.getProject();
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    return;
  }
  ProgressManager.getInstance().run(new Task.Backgroundable(project,XmlBundle.message("fetching.resource.title")){
    @Override public void run(    @NotNull ProgressIndicator indicator){
      while (true) {
        try {
          HttpConfigurable.getInstance().prepareURL(url);
          fetchDtd(project,uri,url,indicator);
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            @Override public void run(){
              DaemonCodeAnalyzer.getInstance(project).restart(file);
            }
          }
);
          return;
        }
 catch (        IOException ex) {
          LOG.info(ex);
          @SuppressWarnings("InstanceofCatchParameter") String problemUrl=ex instanceof FetchingResourceIOException ? ((FetchingResourceIOException)ex).url : url;
          String message=XmlBundle.message("error.fetching.title");
          if (!url.equals(problemUrl)) {
            message=XmlBundle.message("error.fetching.dependent.resource.title");
          }
          if (!IOExceptionDialog.showErrorDialog(message,XmlBundle.message("error.fetching.resource",problemUrl))) {
            break;
          }
        }
      }
    }
  }
);
}
