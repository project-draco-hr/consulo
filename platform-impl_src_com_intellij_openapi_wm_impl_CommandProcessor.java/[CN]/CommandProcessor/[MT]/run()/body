{
synchronized (myLock) {
    final Bulk bulk=getNextCommandBulk();
    if (bulk == null)     return;
    final Condition bulkExpire=myCommandToExpire.get(bulk);
    if (bulk.myList.size() > 0) {
      final FinalizableCommand command=(FinalizableCommand)bulk.myList.remove(0);
      myCommandCount--;
      final Condition expire=command.getExpired() != null ? command.getExpired() : bulkExpire;
      if (LOG.isDebugEnabled()) {
        LOG.debug("CommandProcessor.run " + command);
      }
      final boolean queueNext=myCommandCount > 0;
      ApplicationManager.getApplication().getInvokator().invokeLater(command,ModalityState.NON_MODAL,expire == null ? Condition.FALSE : expire).doWhenDone(new Runnable(){
        public void run(){
          if (queueNext) {
            CommandProcessor.this.run();
          }
        }
      }
);
    }
  }
}
