{
synchronized (myLock) {
    final CommandGroup commandGroup=getNextCommandGroup();
    if (commandGroup == null) {
      return;
    }
    final Condition conditionForGroup=commandGroup.getExpireCondition();
    if (!commandGroup.isEmpty()) {
      final FinalizableCommand command=commandGroup.takeNextCommand();
      myCommandCount--;
      final Condition expire=command.getExpireCondition() != null ? command.getExpireCondition() : conditionForGroup;
      if (LOG.isDebugEnabled()) {
        LOG.debug("CommandProcessor.run " + command);
      }
      final boolean queueNext=myCommandCount > 0;
      if (queueNext) {
        ApplicationManager.getApplication().getInvokator().invokeLater(command,ModalityState.NON_MODAL,expire == null ? Condition.FALSE : expire).doWhenDone(new Runnable(){
          public void run(){
            CommandProcessor.this.run();
          }
        }
);
      }
    }
  }
}
