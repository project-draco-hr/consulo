{
  PsiClass parentClass=refClass.getContainingClass();
  if (parentClass != null) {
    JavaPsiFacade facade=JavaPsiFacade.getInstance(parentClass.getProject());
    final PsiResolveHelper resolveHelper=facade.getResolveHelper();
    if (resolveHelper.isAccessible(refClass,reference,null) && isSafeToShortenReference(reference.getReferenceName(),reference,refClass)) {
      return reference;
    }
    if (!CodeStyleSettingsManager.getSettings(reference.getProject()).INSERT_INNER_CLASS_IMPORTS) {
      final PsiElement qualifier=reference.getQualifier();
      if (qualifier instanceof PsiQualifiedReference) {
        return getClassReferenceToShorten(parentClass,addImports,(PsiQualifiedReference)qualifier);
      }
      return null;
    }
  }
  if (addImports && !((PsiImportHolder)reference.getContainingFile()).importClass(refClass))   return null;
  if (!isSafeToShortenReference(reference,refClass))   return null;
  return reference;
}
