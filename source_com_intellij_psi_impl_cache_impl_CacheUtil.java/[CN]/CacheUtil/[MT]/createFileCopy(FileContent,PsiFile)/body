{
  VirtualFile vFile=psiFile.getVirtualFile();
  if (vFile == null)   return psiFile;
  PsiFile fileCopy;
  if (psiFile instanceof ClsFileImpl) {
    ClsFileImpl implFile=(ClsFileImpl)psiFile;
    if (implFile.isContentsLoaded()) {
      fileCopy=implFile;
    }
 else {
      fileCopy=new ClsFileImpl((PsiManagerImpl)psiFile.getManager(),vFile);
      ((ClsFileImpl)fileCopy).setRepositoryId(-1);
    }
  }
 else   if (psiFile instanceof PsiFileImpl) {
    PsiFileImpl implFile=(PsiFileImpl)psiFile;
    if (implFile.isContentsLoaded()) {
      fileCopy=implFile;
    }
 else {
      CharSequence text;
      Document document=FileDocumentManager.getInstance().getDocument(vFile);
      text=document.getCharsSequence();
      FileType fileType=psiFile.getFileType();
      PsiElementFactoryImpl factory=(PsiElementFactoryImpl)psiFile.getManager().getElementFactory();
      char[] chars=CharArrayUtil.fromSequence(text);
      fileCopy=factory.createDummyFileFromText(psiFile.getName(),fileType,chars,0,text.length());
    }
    fileCopy.setModificationStamp(psiFile.getModificationStamp());
  }
 else {
    fileCopy=psiFile;
  }
  return fileCopy;
}
