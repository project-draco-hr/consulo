{
  final VirtualFile myFile=e.getData(PlatformDataKeys.VIRTUAL_FILE);
  if (myFile == null)   return;
  Pair<Document,String> pair=checkEnabled(myFile);
  if (pair == null)   return;
  final Document document=pair.first;
  final Editor editor=e.getData(PlatformDataKeys.EDITOR);
  final byte[] bytes;
  try {
    bytes=myFile.contentsToByteArray();
  }
 catch (  IOException e1) {
    return;
  }
  DefaultActionGroup group=new ChooseFileEncodingAction(myFile){
    @Override public void update(    final AnActionEvent e){
    }
    @NotNull @Override protected DefaultActionGroup createPopupActionGroup(    JComponent button){
      return createGroup(null,myFile.getCharset(),new Function<Charset,String>(){
        @Override public String fun(        Charset charset){
          return isCompatibleCharset(myFile,bytes,document.getText(),charset);
        }
      }
);
    }
    @Override protected void chosen(    @Nullable VirtualFile virtualFile,    @NotNull Charset charset){
      if (virtualFile != null) {
        ReloadFileInOtherEncodingAction.this.chosen(document,editor,virtualFile,bytes,charset);
      }
    }
  }
.createPopupActionGroup(null);
  final ListPopup popup=JBPopupFactory.getInstance().createActionGroupPopup(getTemplatePresentation().getText(),group,e.getDataContext(),JBPopupFactory.ActionSelectionAid.SPEEDSEARCH,false);
  popup.showInBestPositionFor(e.getDataContext());
}
