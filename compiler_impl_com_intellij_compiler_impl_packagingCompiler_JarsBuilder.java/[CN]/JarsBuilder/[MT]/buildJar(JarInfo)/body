{
  myContext.getProgressIndicator().setText(CompilerBundle.message("packaging.compiler.message.building.0",jar.getPresentableDestination()));
  File jarFile=createTempFile();
  myBuiltJars.put(jar,jarFile);
  Manifest manifest=createManifest(jar);
  DeploymentUtilImpl.setManifestAttributes(manifest.getMainAttributes(),jar.getClasspath());
  final JarOutputStream jarOutputStream=createJarOutputStream(jarFile,manifest);
  try {
    final THashSet<String> writtenPaths=new THashSet<String>();
    writtenPaths.add(JarFile.MANIFEST_NAME);
    for (    Pair<String,VirtualFile> pair : jar.getContent()) {
      File file=VfsUtil.virtualToIoFile(pair.getSecond());
      String relativePath=pair.getFirst();
      if (!JarFile.MANIFEST_NAME.equals(relativePath)) {
        addFileToJar(jarOutputStream,file,relativePath,writtenPaths);
      }
    }
    final Collection<Pair<String,JarInfo>> nestedJars=myNestedJars.get(jar);
    if (nestedJars != null) {
      for (      Pair<String,JarInfo> nestedJar : nestedJars) {
        File nestedJarFile=myBuiltJars.get(nestedJar.getSecond());
        addFileToJar(jarOutputStream,nestedJarFile,nestedJar.getFirst(),writtenPaths);
      }
    }
  }
  finally {
    jarOutputStream.close();
  }
}
