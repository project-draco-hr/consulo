{
  if (type.isOnlyOneFacetAllowed() && (underlyingFacet == null && !model.getFacetsByType(type.getId()).isEmpty() || underlyingFacet != null && !model.getFacetsByType(underlyingFacet,type.getId()).isEmpty())) {
    LOG.info("'" + state.getName() + "' facet removed from module "+ myModule.getName()+ ", because only one "+ type.getPresentableName()+ " facet allowed");
    return;
  }
  final C configuration=type.createDefaultConfiguration();
  final Element config=state.getConfiguration();
  FacetUtil.loadFacetConfiguration(configuration,config);
  String name=state.getName();
  final Facet facet=createFacet(type,name,configuration,underlyingFacet);
  if (facet instanceof JDOMExternalizable) {
    ((JDOMExternalizable)facet).readExternal(config);
  }
  model.addFacet(facet);
  addFacets(state.getSubFacets(),facet,model);
}
