{
  final Module module=moduleStructureConfigurable.getSelectedModule();
  if (module == null)   return Collections.emptyList();
  final List<AnAction> actions=new ArrayList<AnAction>();
  for (  CustomLibraryCreator creator : CustomLibraryCreator.EP_NAME.getExtensions()) {
    List<Library> libraries=new ArrayList<Library>();
    Collections.addAll(libraries,context.getProjectLibrariesProvider().getModifiableModel().getLibraries());
    Collections.addAll(libraries,context.getGlobalLibrariesProvider().getModifiableModel().getLibraries());
    final LibraryFilter condition=creator.getDescription().getSuitableLibraryFilter();
    Predicate<Library> suitablePredicate=new Predicate<Library>(){
      @Override public boolean apply(      Library input){
        return condition.isSuitableLibrary(Arrays.asList(context.getLibraryFiles(input,OrderRootType.CLASSES)),((LibraryEx)input).getType());
      }
    }
;
    final Predicate<Library> notAddedLibrariesCondition=LibraryEditingUtil.getNotAddedLibrariesCondition(context.getModulesConfigurator().getRootModel(module));
    final Collection<Library> librariesToAdd=Collections2.filter(libraries,Predicates.and(suitablePredicate,notAddedLibrariesCondition));
    if (librariesToAdd.isEmpty()) {
      actions.add(new CreateCustomLibraryAction(creator.getDisplayName(),creator,context,moduleStructureConfigurable,module));
    }
 else {
      final DefaultActionGroup group=new DefaultActionGroup(creator.getDisplayName(),true);
      group.getTemplatePresentation().setIcon(creator.getIcon());
      group.add(new CreateCustomLibraryAction("New...",creator,context,moduleStructureConfigurable,module));
      for (      Library library : librariesToAdd) {
        Icon icon=LibraryPresentationManager.getInstance().getNamedLibraryIcon(library,context);
        group.add(new AddExistingCustomLibraryAction(library,icon,creator,context,moduleStructureConfigurable,module));
      }
      actions.add(group);
    }
  }
  return actions;
}
