{
  if (isClassRef(ref))   ref=((GrReferenceExpression)ref).getQualifier();
  if (ref instanceof GrReferenceExpression) {
    PsiElement resolved=((GrReferenceExpression)ref).resolve();
    if (resolved instanceof PsiClass) {
      PsiType type=ref.getType();
      LOG.assertTrue(type instanceof PsiClassType,"reference resolved into PsiClass should have PsiClassType");
      return ((PsiClassType)type);
    }
  }
  return null;
}
