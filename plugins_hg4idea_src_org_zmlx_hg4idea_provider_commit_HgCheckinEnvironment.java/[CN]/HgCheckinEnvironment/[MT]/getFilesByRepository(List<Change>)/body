{
  Map<VirtualFile,List<HgFile>> result=new HashMap<VirtualFile,List<HgFile>>();
  for (  Change change : changes) {
    ContentRevision afterRevision=change.getAfterRevision();
    ContentRevision beforeRevision=change.getBeforeRevision();
    FilePath filePath=null;
    if (afterRevision != null) {
      filePath=afterRevision.getFile();
    }
 else     if (beforeRevision != null) {
      filePath=beforeRevision.getFile();
    }
    if (filePath == null) {
      continue;
    }
    VirtualFile repo=VcsUtil.getVcsRootFor(project,filePath);
    if (repo == null || filePath.isDirectory()) {
      continue;
    }
    List<HgFile> hgFiles=result.get(repo);
    if (hgFiles == null) {
      hgFiles=new LinkedList<HgFile>();
      result.put(repo,hgFiles);
    }
    hgFiles.add(new HgFile(repo,filePath));
  }
  return result;
}
