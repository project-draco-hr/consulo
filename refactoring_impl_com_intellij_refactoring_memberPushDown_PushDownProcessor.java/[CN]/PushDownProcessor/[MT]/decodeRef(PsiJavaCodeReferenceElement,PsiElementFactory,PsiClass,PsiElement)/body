{
  try {
    if (toGet.getCopyableUserData(REMOVE_QUALIFIER_KEY) != null) {
      toGet.putCopyableUserData(REMOVE_QUALIFIER_KEY,null);
      final PsiElement qualifier=ref.getQualifier();
      if (qualifier != null)       qualifier.delete();
    }
 else {
      PsiClass psiClass=toGet.getCopyableUserData(REPLACE_QUALIFIER_KEY);
      if (psiClass != null) {
        toGet.putCopyableUserData(REPLACE_QUALIFIER_KEY,null);
        final PsiElement qualifier=ref.getQualifier();
        if (qualifier != null) {
          if (psiClass == myClass) {
            psiClass=targetClass;
          }
 else           if (psiClass.getContainingClass() == myClass) {
            psiClass=targetClass.findInnerClassByName(psiClass.getName(),false);
            LOG.assertTrue(psiClass != null);
          }
          if (ref instanceof PsiReferenceExpression) {
            ((PsiReferenceExpression)ref).setQualifierExpression(factory.createReferenceExpression(psiClass));
          }
 else {
            qualifier.replace(factory.createReferenceElementByType(factory.createType(psiClass)));
          }
        }
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
