{
  final SubTree tree=new SubTree(myWorkingCopyDir);
  checkin();
  disableSilentOperation(VcsConfiguration.StandardConfirmation.ADD);
  final VirtualFile unv=createFileInCommand(tree.mySourceDir,"unv.txt","***");
  final File wasUnversioned=new File(unv.getPath());
  moveFileInCommand(myProject,tree.mySourceDir,tree.myTargetDir);
  myDirtyScopeManager.markEverythingDirty();
  myChangeListManager.ensureUpToDate(false);
  final Change change=assertMovedChange(tree.mySourceDir);
  final Change s1Change=assertMovedChange(tree.myS1File);
  final Change s2Change=assertMovedChange(tree.myS2File);
  Assert.assertTrue(unv != null);
  Assert.assertTrue(unv.isValid());
  Assert.assertTrue(!FileUtil.filesEqual(new File(unv.getPath()),wasUnversioned));
  Assert.assertTrue(!wasUnversioned.exists());
  rollbackIMpl(Arrays.asList(change,s2Change),Collections.<Change>emptyList());
  Assert.assertTrue(wasUnversioned.exists());
}
