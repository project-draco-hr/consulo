{
  if (SystemInfo.isWindows) {
    newName=newName.replace('\\','/');
  }
  if (newName.contains("/")) {
    final List<String> subDirs=StringUtil.split(newName,"/");
    newName=subDirs.remove(subDirs.size() - 1);
    boolean firstToken=true;
    for (    String dir : subDirs) {
      if (firstToken && "~".equals(dir)) {
        final VirtualFile userHomeDir=VfsUtil.getUserHomeDir();
        if (userHomeDir == null)         throw new IncorrectOperationException("User home directory not found");
        final PsiDirectory directory1=directory.getManager().findDirectory(userHomeDir);
        if (directory1 == null)         throw new IncorrectOperationException("User home directory not found");
        directory=directory1;
      }
 else       if ("..".equals(dir)) {
        final PsiDirectory parentDirectory=directory.getParentDirectory();
        if (parentDirectory == null)         throw new IncorrectOperationException("Not a valid directory");
        directory=parentDirectory;
      }
 else       if (!".".equals(dir)) {
        final PsiDirectory sub=directory.findSubdirectory(dir);
        directory=sub == null ? directory.createSubdirectory(dir) : sub;
      }
      firstToken=false;
    }
  }
  this.newName=newName;
  this.directory=directory;
}
