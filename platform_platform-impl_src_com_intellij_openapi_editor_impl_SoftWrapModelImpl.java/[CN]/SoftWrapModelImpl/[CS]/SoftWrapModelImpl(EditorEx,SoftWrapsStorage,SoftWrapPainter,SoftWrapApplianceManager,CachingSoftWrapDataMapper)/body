{
  myEditor=editor;
  myStorage=storage;
  myPainter=painter;
  myApplianceManager=applianceManager;
  myDataMapper=dataMapper;
  myFoldBasedApplianceStrategy=new SoftWrapFoldBasedApplianceStrategy(editor);
  myVisualSizeManager=new SoftWrapAwareVisualSizeManager(painter);
  myDocumentListeners.add(myApplianceManager);
  myFoldListeners.add(myApplianceManager);
  applianceManager.addListener(myVisualSizeManager);
  applianceManager.addListener(new SoftWrapAwareDocumentParsingListenerAdapter(){
    @Override public void onCacheUpdateStart(    @NotNull IncrementalCacheUpdateEvent event){
      for (      SoftWrapChangeListener listener : mySoftWrapListeners) {
        listener.recalculationStarts();
      }
    }
    @Override public void onRecalculationEnd(    @NotNull IncrementalCacheUpdateEvent event,    boolean normal){
      for (      SoftWrapChangeListener listener : mySoftWrapListeners) {
        listener.recalculationEnds();
      }
    }
  }
);
  EditorSettings settings=myEditor.getSettings();
  myUseSoftWraps=settings.isUseSoftWraps();
  editor.addPropertyChangeListener(this);
}
