{
  int lineFeedsAtNewWrap=StringUtil.countNewLines(softWrap.getText());
  if (lineFeedsAtNewWrap <= 0) {
    return;
  }
  Map<VisualPosition,LogicalPosition> updated=new HashMap<VisualPosition,LogicalPosition>();
  boolean shouldUpdate=false;
  for (  Map.Entry<VisualPosition,LogicalPosition> entry : myLogicalPositionsByVisual.entrySet()) {
    if (myEditor.logicalPositionToOffset(entry.getValue()) <= softWrap.getStart()) {
      updated.put(entry.getKey(),entry.getValue());
      continue;
    }
    shouldUpdate=true;
    VisualPosition oldVisual=entry.getKey();
    LogicalPosition oldLogical=entry.getValue();
    VisualPosition newVisual=new VisualPosition(oldVisual.line + lineFeedsAtNewWrap,oldVisual.column);
    LogicalPosition newLogical=new LogicalPosition(oldLogical.line,oldLogical.column,oldLogical.softWrapLines + lineFeedsAtNewWrap,oldLogical.linesFromActiveSoftWrap,oldLogical.softWrapColumns);
    updated.put(newVisual,newLogical);
  }
  if (shouldUpdate) {
    myLogicalPositionsByVisual.clear();
    myLogicalPositionsByVisual.putAll(updated);
  }
}
