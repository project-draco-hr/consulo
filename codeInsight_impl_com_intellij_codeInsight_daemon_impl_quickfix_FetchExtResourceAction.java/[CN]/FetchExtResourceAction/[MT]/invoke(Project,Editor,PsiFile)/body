{
  int offset=editor.getCaretModel().getOffset();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final String uri=findUri(file,offset);
  if (uri == null)   return;
  final String url=findUrl(file,offset,uri);
  final ProgressWindow progressWindow=new ProgressWindow(true,project);
  progressWindow.setTitle(QuickFixBundle.message("fetching.resource.title"));
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    new Thread(new Runnable(){
      public void run(){
        while (true) {
          try {
            ProgressManager.getInstance().runProcess(new Runnable(){
              public void run(){
                try {
                  HttpConfigurable.getInstance().prepareURL(url);
                  fetchDtd(project,uri,url);
                }
 catch (                IOException ex) {
                  FetchingResourceIOException exceptionDescribingIOProblem;
                  if (ex instanceof FetchingResourceIOException) {
                    exceptionDescribingIOProblem=(FetchingResourceIOException)ex;
                  }
 else {
                    exceptionDescribingIOProblem=new FetchingResourceIOException(ex,url);
                  }
                  throw new FetchingResourceProblemRuntimeWrapper(exceptionDescribingIOProblem);
                }
              }
            }
,progressWindow);
          }
 catch (          FetchingResourceProblemRuntimeWrapper e) {
            String message=QuickFixBundle.message("error.fetching.title");
            FetchingResourceIOException ioproblem=(FetchingResourceIOException)e.getCause();
            if (!url.equals(ioproblem.url)) {
              message=QuickFixBundle.message("error.fetching.dependent.resource.title");
            }
            if (!IOExceptionDialog.showErrorDialog((IOException)ioproblem.getCause(),message,QuickFixBundle.message("error.fetching.resource",ioproblem.url))) {
              break;
            }
 else {
              continue;
            }
          }
          break;
        }
      }
    }
,FETCHING_THREAD_ID).start();
  }
}
