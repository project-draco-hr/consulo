{
  int offset=editor.getCaretModel().getOffset();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final String uri=findUri(file,offset);
  if (uri == null)   return;
  final String url=findUrl(file,offset,uri);
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
      public void run(){
        while (true) {
          try {
            final ProgressWindow[] result=new ProgressWindow[1];
            ApplicationManager.getApplication().invokeAndWait(new Runnable(){
              public void run(){
                final ProgressWindow progressWindow=new ProgressWindow(true,project);
                progressWindow.setTitle(QuickFixBundle.message("fetching.resource.title"));
                result[0]=progressWindow;
              }
            }
,ModalityState.defaultModalityState());
            ProgressManager.getInstance().runProcess(new Runnable(){
              public void run(){
                try {
                  HttpConfigurable.getInstance().prepareURL(url);
                  fetchDtd(project,uri,url);
                }
 catch (                IOException ex) {
                  FetchingResourceIOException exceptionDescribingIOProblem;
                  if (ex instanceof FetchingResourceIOException) {
                    exceptionDescribingIOProblem=(FetchingResourceIOException)ex;
                  }
 else {
                    exceptionDescribingIOProblem=new FetchingResourceIOException(ex,url);
                  }
                  throw new FetchingResourceProblemRuntimeWrapper(exceptionDescribingIOProblem);
                }
              }
            }
,result[0]);
          }
 catch (          FetchingResourceProblemRuntimeWrapper e) {
            String message=QuickFixBundle.message("error.fetching.title");
            FetchingResourceIOException ioproblem=(FetchingResourceIOException)e.getCause();
            if (!url.equals(ioproblem.url)) {
              message=QuickFixBundle.message("error.fetching.dependent.resource.title");
            }
            final IOException cause=(IOException)ioproblem.getCause();
            LOG.info(cause);
            if (!IOExceptionDialog.showErrorDialog(cause,message,QuickFixBundle.message("error.fetching.resource",ioproblem.url))) {
              break;
            }
 else {
              continue;
            }
          }
          break;
        }
      }
    }
);
  }
}
