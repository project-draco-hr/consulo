{
  final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  final String extResourcesPath=getExternalResourcesPath();
  final File extResources=new File(extResourcesPath);
  final boolean alreadyExists=extResources.exists();
  extResources.mkdirs();
  LOG.assertTrue(extResources.exists());
  final PsiManager psiManager=PsiManager.getInstance(project);
  ApplicationManager.getApplication().invokeAndWait(new Runnable(){
    public void run(){
      Runnable action=new Runnable(){
        public void run(){
          VirtualFile vFile=LocalFileSystem.getInstance().refreshAndFindFileByPath(extResources.getAbsolutePath().replace(File.separatorChar,'/'));
          LOG.assertTrue(vFile != null);
          PsiDirectory directory=psiManager.findDirectory(vFile);
          directory.getFiles();
          if (!alreadyExists)           LocalFileSystem.getInstance().addRootToWatch(vFile.getPath(),true);
        }
      }
;
      ApplicationManager.getApplication().runWriteAction(action);
    }
  }
,indicator.getModalityState());
  final List<String> downloadedResources=new LinkedList<String>();
  final List<String> resourceUrls=new LinkedList<String>();
  final IOException[] nestedException=new IOException[1];
  try {
    final String resPath=fetchOneFile(indicator,url,project,extResourcesPath,null);
    if (resPath == null)     return;
    resourceUrls.add(dtdUrl);
    downloadedResources.add(resPath);
    ApplicationManager.getApplication().invokeAndWait(new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            ExternalResourceManagerImpl.getInstance().addResource(dtdUrl,resPath);
            VirtualFile virtualFile=LocalFileSystem.getInstance().refreshAndFindFileByPath(resPath.replace(File.separatorChar,'/'));
            Set<String> linksToProcess=new HashSet<String>();
            Set<String> processedLinks=new HashSet<String>();
            Map<String,String> baseUrls=new HashMap<String,String>();
            VirtualFile contextFile=virtualFile;
            linksToProcess.addAll(extractEmbeddedFileReferences(virtualFile,null,psiManager));
            while (!linksToProcess.isEmpty()) {
              String s=linksToProcess.iterator().next();
              linksToProcess.remove(s);
              processedLinks.add(s);
              final boolean absoluteUrl=s.startsWith(HTTP_PROTOCOL);
              String resourceUrl;
              if (absoluteUrl) {
                resourceUrl=s;
              }
 else {
                String baseUrl=baseUrls.get(s);
                if (baseUrl == null)                 baseUrl=url;
                resourceUrl=baseUrl.substring(0,baseUrl.lastIndexOf('/') + 1) + s;
              }
              String resourcePath;
              try {
                resourcePath=fetchOneFile(indicator,resourceUrl,project,extResourcesPath,s.substring(s.lastIndexOf('/') + 1));
              }
 catch (              IOException e) {
                nestedException[0]=new FetchingResourceIOException(e,resourceUrl);
                break;
              }
              virtualFile=LocalFileSystem.getInstance().refreshAndFindFileByPath(resourcePath.replace(File.separatorChar,'/'));
              downloadedResources.add(resourcePath);
              if (absoluteUrl) {
                ExternalResourceManagerImpl.getInstance().addResource(s,resourcePath);
                resourceUrls.add(s);
              }
              final List<String> newLinks=extractEmbeddedFileReferences(virtualFile,contextFile,psiManager);
              for (              String u : newLinks) {
                baseUrls.put(u,resourceUrl);
                if (!processedLinks.contains(u))                 linksToProcess.add(u);
              }
            }
          }
        }
);
      }
    }
,indicator.getModalityState());
  }
 catch (  IOException ex) {
    nestedException[0]=ex;
  }
  if (nestedException[0] != null) {
    cleanup(resourceUrls,downloadedResources);
    throw nestedException[0];
  }
}
