{
  PsiElement currentElement=file.findElementAt(offset);
  PsiElement element=PsiTreeUtil.getParentOfType(currentElement,XmlDoctype.class);
  if (element != null) {
    return ((XmlDoctype)element).getDtdUri();
  }
  XmlAttribute attribute=PsiTreeUtil.getParentOfType(currentElement,XmlAttribute.class);
  if (attribute == null)   return null;
  if (attribute.isNamespaceDeclaration()) {
    String uri=attribute.getValue();
    PsiElement parent=attribute.getParent();
    if (uri != null && parent instanceof XmlTag && ((XmlTag)parent).getNSDescriptor(uri,true) == null) {
      XmlTag tag=(XmlTag)parent;
      final String prefix=tag.getPrefixByNamespace(XmlUtil.XML_SCHEMA_INSTANCE_URI);
      if (prefix != null) {
        final String attrValue=tag.getAttributeValue(XmlUtil.SCHEMA_LOCATION_ATT,XmlUtil.XML_SCHEMA_INSTANCE_URI);
        if (attrValue != null) {
          final StringTokenizer tokenizer=new StringTokenizer(attrValue);
          while (tokenizer.hasMoreElements()) {
            if (uri.equals(tokenizer.nextToken())) {
              if (!tokenizer.hasMoreElements())               return uri;
              final String url=tokenizer.nextToken();
              return url.startsWith(HTTP_PROTOCOL) ? url : uri;
            }
            tokenizer.nextToken();
          }
        }
      }
      return uri;
    }
  }
 else   if (attribute.getNamespace().equals(XmlUtil.XML_SCHEMA_INSTANCE_URI)) {
    String location=attribute.getValue();
    if (attribute.getLocalName().equals(XmlUtil.NO_NAMESPACE_SCHEMA_LOCATION_ATT)) {
      if (XmlUtil.findXmlFile(file,location) == null)       return location;
    }
 else     if (attribute.getLocalName().equals(XmlUtil.SCHEMA_LOCATION_ATT)) {
      StringTokenizer tokenizer=new StringTokenizer(location);
      int offsetInAttr=offset - attribute.getValueElement().getTextOffset();
      while (tokenizer.hasMoreElements()) {
        tokenizer.nextToken();
        if (!tokenizer.hasMoreElements())         return null;
        String url=tokenizer.nextToken();
        int index=location.indexOf(url);
        if (index <= offsetInAttr && index + url.length() >= offsetInAttr) {
          return url;
        }
      }
    }
  }
  return null;
}
