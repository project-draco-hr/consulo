{
  Map<VirtualFile,Set<String>> result=new HashMap<VirtualFile,Set<String>>();
  try {
    MavenEmbedder e=MavenEmbedderFactory.createEmbedderForRead(getCoreState());
    MavenProjectReader r=new MavenProjectReader(e);
    for (    VirtualFile f : files) {
      MavenProjectHolder holder=r.readProject(f.getPath(),new ArrayList<String>());
      if (!holder.isValid())       continue;
      Set<String> profiles=new LinkedHashSet<String>();
      ProjectUtil.collectProfileIds(holder.getMavenProject().getModel(),profiles);
      if (!profiles.isEmpty())       result.put(f,profiles);
    }
    MavenEmbedderFactory.releaseEmbedder(e);
  }
 catch (  CanceledException e) {
  }
  return result;
}
