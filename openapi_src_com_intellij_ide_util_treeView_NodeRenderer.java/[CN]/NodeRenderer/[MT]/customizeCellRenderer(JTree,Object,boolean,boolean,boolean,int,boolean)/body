{
  Color color=null;
  if (value instanceof DefaultMutableTreeNode) {
    DefaultMutableTreeNode node=(DefaultMutableTreeNode)value;
    Object userObject=node.getUserObject();
    if (userObject instanceof NodeDescriptor) {
      NodeDescriptor descriptor=(NodeDescriptor)userObject;
      color=descriptor.getColor();
      if (expanded) {
        setIcon(descriptor.getOpenIcon());
      }
 else {
        setIcon(descriptor.getClosedIcon());
      }
    }
  }
  final Object valueToGetText=value instanceof AbstractTreeNode ? ((AbstractTreeNode)value).toString() : value;
  String text=tree.convertValueToText(valueToGetText,selected,expanded,leaf,row,hasFocus);
  if (text == null)   text="";
  SimpleTextAttributes simpleTextAttributes=getSimpleTextAttributes(value);
  if (color != null) {
    final TextAttributes textAttributes=simpleTextAttributes.toTextAttributes();
    textAttributes.setForegroundColor(color);
    simpleTextAttributes=SimpleTextAttributes.fromTextAttributes(textAttributes);
  }
  append(text,simpleTextAttributes);
  if (value instanceof DefaultMutableTreeNode) {
    DefaultMutableTreeNode node=(DefaultMutableTreeNode)value;
    Object userObject=node.getUserObject();
    if (userObject instanceof AbstractTreeNode) {
      AbstractTreeNode treeNode=(AbstractTreeNode)userObject;
      String locationString=treeNode.getPresentation().getLocationString();
      if (locationString != null && locationString.length() > 0) {
        append(" (" + locationString + ")",SimpleTextAttributes.GRAY_ATTRIBUTES);
      }
      final String toolTip=treeNode.getToolTip();
      setToolTipText(toolTip);
    }
  }
}
