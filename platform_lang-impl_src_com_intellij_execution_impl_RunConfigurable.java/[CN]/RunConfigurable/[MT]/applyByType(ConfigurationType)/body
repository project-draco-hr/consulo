{
  RunnerAndConfigurationSettings selectedSettings=getSelectedSettings();
  int indexToMove=-1;
  DefaultMutableTreeNode typeNode=getConfigurationTypeNode(type);
  final RunManagerImpl manager=getRunManager();
  final ArrayList<RunConfigurationBean> stableConfigurations=new ArrayList<RunConfigurationBean>();
  if (typeNode != null) {
    final Set<String> names=new HashSet<String>();
    for (int i=0; i < typeNode.getChildCount(); i++) {
      final DefaultMutableTreeNode node=(DefaultMutableTreeNode)typeNode.getChildAt(i);
      final Object userObject=node.getUserObject();
      RunConfigurationBean configurationBean=null;
      RunnerAndConfigurationSettings settings=null;
      if (userObject instanceof SingleConfigurationConfigurable) {
        final SingleConfigurationConfigurable configurable=(SingleConfigurationConfigurable)userObject;
        settings=(RunnerAndConfigurationSettings)configurable.getSettings();
        if (manager.isTemporary(settings)) {
          applyConfiguration(typeNode,configurable);
        }
        configurationBean=new RunConfigurationBean(configurable);
      }
 else       if (userObject instanceof RunnerAndConfigurationSettingsImpl) {
        settings=(RunnerAndConfigurationSettings)userObject;
        configurationBean=new RunConfigurationBean(settings,manager.isConfigurationShared(settings),manager.getBeforeRunTasks(settings.getConfiguration()));
      }
      if (configurationBean != null) {
        final SingleConfigurationConfigurable configurable=configurationBean.getConfigurable();
        final String nameText=configurable != null ? configurable.getNameText() : configurationBean.getSettings().getName();
        if (!names.add(nameText)) {
          TreeUtil.selectNode(myTree,node);
          throw new ConfigurationException("Configuration with name \'" + nameText + "\' already exists");
        }
        stableConfigurations.add(configurationBean);
        if (settings == selectedSettings) {
          indexToMove=stableConfigurations.size() - 1;
        }
      }
    }
  }
  for (  RunConfigurationBean bean : stableConfigurations) {
    final SingleConfigurationConfigurable configurable=bean.getConfigurable();
    if (configurable != null) {
      applyConfiguration(typeNode,configurable);
    }
  }
  Set<RunnerAndConfigurationSettings> toDeleteSettings=new THashSet<RunnerAndConfigurationSettings>();
  for (  RunConfiguration each : manager.getConfigurations(type)) {
    ContainerUtil.addIfNotNull(toDeleteSettings,manager.getSettings(each));
  }
  int shift=0;
  if (selectedSettings != null && selectedSettings.getType() == type) {
    shift=adjustOrder();
  }
  if (shift != 0 && indexToMove != -1) {
    stableConfigurations.add(indexToMove - shift,stableConfigurations.remove(indexToMove));
  }
  for (  RunConfigurationBean each : stableConfigurations) {
    toDeleteSettings.remove(each.getSettings());
    manager.addConfiguration(each.getSettings(),each.isShared(),each.getStepsBeforeLaunch(),false);
  }
  for (  RunnerAndConfigurationSettings each : toDeleteSettings) {
    manager.removeConfiguration(each);
  }
}
