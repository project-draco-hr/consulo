{
  ConcurrentMap<K,Object> map=(ConcurrentMap<K,Object>)myMap;
  Object[] newArray=ArrayUtil.toObjectArray(newValue);
  Object newValueToPut=newArray.length == 0 ? null : newArray.length == 1 ? newArray[0] : newArray;
  Object oldValue=map.get(key);
  List<V> oldCollection=rawValueToCollection(oldValue);
  if (!oldCollection.equals(expectedValue))   return false;
  if (oldValue == null) {
    return newValueToPut == null || map.putIfAbsent(key,newValueToPut) == newValueToPut;
  }
  if (newValueToPut == null) {
    return map.remove(key,oldValue);
  }
  return map.replace(key,oldValue,newValueToPut);
}
