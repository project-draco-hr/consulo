{
  if (editor.isViewer())   return;
  if (dataContext != null) {
    Project project=PlatformDataKeys.PROJECT.getData(dataContext);
    if (project != null && !FileDocumentManager.getInstance().requestWriting(editor.getDocument(),project))     return;
  }
  ApplicationManager.getApplication().runWriteAction(new DocumentRunnable(editor.getDocument(),editor.getProject()){
    public void run(){
      final Document doc=editor.getDocument();
      final SelectionModel selectionModel=editor.getSelectionModel();
      if (selectionModel.hasBlockSelection()) {
        RangeMarker guard=selectionModel.getBlockSelectionGuard();
        if (guard != null) {
          DocumentEvent evt=new MockDocumentEvent(editor.getDocument(),editor.getCaretModel().getOffset());
          ReadOnlyFragmentModificationException e=new ReadOnlyFragmentModificationException(evt,guard);
          EditorActionManager.getInstance().getReadonlyFragmentModificationHandler(doc).handle(e);
          return;
        }
      }
      doc.startGuardedBlockChecking();
      try {
        executeWriteAction(editor,dataContext);
      }
 catch (      ReadOnlyFragmentModificationException e) {
        EditorActionManager.getInstance().getReadonlyFragmentModificationHandler(doc).handle(e);
      }
 finally {
        doc.stopGuardedBlockChecking();
      }
    }
  }
);
}
