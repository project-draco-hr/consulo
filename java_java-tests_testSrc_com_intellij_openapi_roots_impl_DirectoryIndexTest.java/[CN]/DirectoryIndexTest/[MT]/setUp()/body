{
  super.setUp();
  final File root=createTempDirectory();
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      try {
        myRootVFile=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(root);
        assertNotNull(myRootVFile);
        myFileLibDir=myRootVFile.createChildDirectory(DirectoryIndexTest.this,"lib");
        myFileLibSrc=myFileLibDir.createChildData(DirectoryIndexTest.this,"file.src");
        myFileLibCls=myFileLibDir.createChildData(DirectoryIndexTest.this,"file.cls");
        myModule1Dir=myRootVFile.createChildDirectory(DirectoryIndexTest.this,"module1");
        mySrcDir1=myModule1Dir.createChildDirectory(DirectoryIndexTest.this,"src1");
        myPack1Dir=mySrcDir1.createChildDirectory(DirectoryIndexTest.this,"pack1");
        myTestSrc1=mySrcDir1.createChildDirectory(DirectoryIndexTest.this,"testSrc");
        myPack2Dir=myTestSrc1.createChildDirectory(DirectoryIndexTest.this,"pack2");
        myLibDir=myModule1Dir.createChildDirectory(DirectoryIndexTest.this,"lib");
        myLibSrcDir=myLibDir.createChildDirectory(DirectoryIndexTest.this,"src");
        myLibClsDir=myLibDir.createChildDirectory(DirectoryIndexTest.this,"cls");
        myModule2Dir=myModule1Dir.createChildDirectory(DirectoryIndexTest.this,"module2");
        mySrcDir2=myModule2Dir.createChildDirectory(DirectoryIndexTest.this,"src2");
        myCvsDir=mySrcDir2.createChildDirectory(DirectoryIndexTest.this,"CVS");
        myExcludeDir=mySrcDir2.createChildDirectory(DirectoryIndexTest.this,"excluded");
        myModule3Dir=myRootVFile.createChildDirectory(DirectoryIndexTest.this,"module3");
        myOutputDir=myRootVFile.createChildDirectory(DirectoryIndexTest.this,"out");
        myModule1OutputDir=myOutputDir.createChildDirectory(DirectoryIndexTest.this,"module1");
        getCompilerProjectExtension().setCompilerOutputUrl(myOutputDir.getUrl());
        ModuleManager moduleManager=ModuleManager.getInstance(myProject);
{
          ModuleRootModificationUtil.setModuleSdk(myModule,null);
          PsiTestUtil.addContentRoot(myModule,myModule1Dir);
          PsiTestUtil.addSourceRoot(myModule,mySrcDir1);
          PsiTestUtil.addSourceRoot(myModule,myTestSrc1,true);
          ModuleRootModificationUtil.addModuleLibrary(myModule,"lib.js",singletonList(myFileLibCls.getUrl()),singletonList(myFileLibSrc.getUrl()));
        }
{
          VirtualFile moduleFile=myModule2Dir.createChildData(DirectoryIndexTest.this,"module2.iml");
          myModule2=moduleManager.newModule(moduleFile.getPath(),StdModuleTypes.JAVA.getId());
          PsiTestUtil.addContentRoot(myModule2,myModule2Dir);
          PsiTestUtil.addSourceRoot(myModule2,mySrcDir2);
          PsiTestUtil.addExcludedRoot(myModule2,myExcludeDir);
          ModuleRootModificationUtil.addModuleLibrary(myModule2,"lib",singletonList(myLibClsDir.getUrl()),singletonList(myLibSrcDir.getUrl()));
        }
{
          VirtualFile moduleFile=myModule3Dir.createChildData(DirectoryIndexTest.this,"module3.iml");
          myModule3=moduleManager.newModule(moduleFile.getPath(),StdModuleTypes.JAVA.getId());
          PsiTestUtil.addContentRoot(myModule3,myModule3Dir);
          ModuleRootModificationUtil.addDependency(myModule3,myModule2);
        }
      }
 catch (      IOException e) {
        LOG.error(e);
      }
    }
  }
);
  myIndex=DirectoryIndex.getInstance(myProject);
  VirtualFileManager.getInstance().syncRefresh();
}
