{
  validateContext();
  if (!hasSelection() && !hasBlockSelection())   return null;
  CharSequence text=myEditor.getDocument().getCharsSequence();
  if (hasBlockSelection()) {
    int[] starts=getBlockSelectionStarts();
    int[] ends=getBlockSelectionEnds();
    int width=Math.abs(myBlockEnd.column - myBlockStart.column);
    final StringBuffer buf=new StringBuffer();
    for (int i=0; i < starts.length; i++) {
      if (i > 0)       buf.append('\n');
      final int len=ends[i] - starts[i];
      appendCharSequence(buf,text,starts[i],len);
      for (int j=len; j < width; j++)       buf.append(' ');
    }
    return buf.toString();
  }
  int selectionStart=getSelectionStart();
  int selectionEnd=getSelectionEnd();
  return text.subSequence(selectionStart,selectionEnd).toString();
}
