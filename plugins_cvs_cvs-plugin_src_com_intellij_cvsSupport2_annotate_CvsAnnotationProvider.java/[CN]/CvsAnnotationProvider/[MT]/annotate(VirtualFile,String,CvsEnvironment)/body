{
  boolean hasLocalFile=false;
  File cvsFile=new File(cvsVirtualFile.getPath());
  if (cvsFile.isAbsolute()) {
    hasLocalFile=true;
    cvsFile=new File(CvsUtil.getModuleName(cvsVirtualFile));
  }
  final AnnotateOperation annotateOperation=new AnnotateOperation(cvsFile,revision,environment);
  CvsOperationExecutor executor=new CvsOperationExecutor(myProject);
  executor.performActionSync(new CommandCvsHandler(CvsBundle.getAnnotateOperationName(),annotateOperation),CvsOperationExecutorCallback.EMPTY);
  if (executor.getResult().hasNoErrors()) {
    final List<VcsFileRevision> revisions;
    final Annotation[] lineAnnotations=annotateOperation.getLineAnnotations();
    if (hasLocalFile) {
      final CvsVcs2 cvsVcs2=CvsVcs2.getInstance(myProject);
      final CvsHistoryProvider historyProvider=(CvsHistoryProvider)cvsVcs2.getVcsHistoryProvider();
      final FilePath filePath=VcsContextFactory.SERVICE.getInstance().createFilePathOn(cvsVirtualFile);
      revisions=historyProvider.createRevisions(filePath);
      adjustAnnotation(revisions,lineAnnotations);
    }
 else {
      revisions=new ArrayList<VcsFileRevision>();
      final Set<String> usedRevisions=new HashSet<String>();
      for (      Annotation annotation : lineAnnotations) {
        if (!usedRevisions.contains(annotation.getRevision())) {
          revisions.add(new RevisionPresentation(annotation.getRevision(),annotation.getUserName(),annotation.getDate()));
          usedRevisions.add(annotation.getRevision());
        }
      }
    }
    return new CvsFileAnnotation(annotateOperation.getContent(),lineAnnotations,revisions,cvsVirtualFile);
  }
 else {
    throw executor.getResult().composeError();
  }
}
