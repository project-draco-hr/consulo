{
  boolean hasLocalFile=false;
  File cvsFile=new File(cvsVirtualFile.getPath());
  if (cvsFile.isAbsolute()) {
    hasLocalFile=true;
    cvsFile=new File(CvsUtil.getModuleName(cvsVirtualFile));
  }
  final boolean binary=annotateBinary(cvsVirtualFile,environment);
  final AnnotateOperation annotateOperation=executeOperation(cvsFile,revision,environment,binary,true);
  final Annotation[] lineAnnotations=annotateOperation.getLineAnnotations();
  final List<VcsFileRevision> revisions;
  if (hasLocalFile) {
    final FilePath filePath=VcsContextFactory.SERVICE.getInstance().createFilePathOn(cvsVirtualFile);
    revisions=myCvsHistoryProvider.createRevisions(filePath);
    adjustAnnotation(revisions,lineAnnotations);
  }
 else {
    revisions=new ArrayList<VcsFileRevision>();
    final Set<String> usedRevisions=new HashSet<String>();
    for (    Annotation annotation : lineAnnotations) {
      if (!usedRevisions.contains(annotation.getRevision())) {
        revisions.add(new RevisionPresentation(annotation.getRevision(),annotation.getUserName(),annotation.getDate()));
        usedRevisions.add(annotation.getRevision());
      }
    }
  }
  return new CvsFileAnnotation(annotateOperation.getContent(),lineAnnotations,revisions,cvsVirtualFile);
}
