{
  super.update(event);
  Presentation presentation=event.getPresentation();
  if (!presentation.isEnabled()) {
    return;
  }
  DataContext dataContext=event.getDataContext();
  presentation.setVisible(false);
  Project project=PlatformDataKeys.PROJECT.getData(dataContext);
  if (project == null) {
    presentation.setEnabled(false);
    return;
  }
  if (CompilerWorkspaceConfiguration.getInstance(project).useOutOfProcessBuild()) {
    presentation.setEnabled(false);
    return;
  }
  final CompilerConfiguration compilerConfiguration=CompilerConfiguration.getInstance(project);
  final Module module=LangDataKeys.MODULE.getData(dataContext);
  final Module moduleContext=LangDataKeys.MODULE_CONTEXT.getData(dataContext);
  if (module == null) {
    presentation.setEnabled(false);
    return;
  }
  final AnnotationProcessingConfiguration profile=compilerConfiguration.getAnnotationProcessingConfiguration(module);
  if (!profile.isEnabled() || (!profile.isObtainProcessorsFromClasspath() && profile.getProcessors().isEmpty())) {
    presentation.setEnabled(false);
    return;
  }
  presentation.setVisible(true);
  presentation.setText(createPresentationText(""),true);
  final FileSetCompileScope scope=getCompilableFiles(project,PlatformDataKeys.VIRTUAL_FILE_ARRAY.getData(dataContext));
  if (moduleContext == null && scope == null) {
    presentation.setEnabled(false);
    return;
  }
  String elementDescription=null;
  if (moduleContext != null) {
    elementDescription=CompilerBundle.message("action.compile.description.module",moduleContext.getName());
  }
 else {
    PsiPackage aPackage=null;
    final Collection<VirtualFile> files=scope.getRootFiles();
    if (files.size() == 1) {
      final PsiDirectory directory=PsiManager.getInstance(project).findDirectory(files.iterator().next());
      if (directory != null) {
        aPackage=JavaDirectoryService.getInstance().getPackage(directory);
      }
    }
 else {
      PsiElement element=LangDataKeys.PSI_ELEMENT.getData(dataContext);
      if (element instanceof PsiPackage) {
        aPackage=(PsiPackage)element;
      }
    }
    if (aPackage != null) {
      String name=aPackage.getQualifiedName();
      if (name.length() == 0) {
        name="<default>";
      }
      elementDescription="'" + name + "'";
    }
 else     if (files.size() == 1) {
      final VirtualFile file=files.iterator().next();
      FileType fileType=file.getFileType();
      if (CompilerManager.getInstance(project).isCompilableFileType(fileType)) {
        elementDescription="'" + file.getName() + "'";
      }
 else {
        if (!ActionPlaces.MAIN_MENU.equals(event.getPlace())) {
          presentation.setEnabled(false);
          presentation.setVisible(false);
          return;
        }
      }
    }
 else {
      elementDescription=CompilerBundle.message("action.compile.description.selected.files");
    }
  }
  if (elementDescription == null) {
    presentation.setEnabled(false);
    return;
  }
  presentation.setText(createPresentationText(elementDescription),true);
  presentation.setEnabled(true);
}
