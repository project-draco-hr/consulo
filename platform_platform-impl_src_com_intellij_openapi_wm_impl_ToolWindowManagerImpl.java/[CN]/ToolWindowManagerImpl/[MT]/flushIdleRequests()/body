{
  try {
    myFlushingIdleRequestsEntryCount++;
    final KeyEvent[] events=myToDispatchOnDone.toArray(new KeyEvent[myToDispatchOnDone.size()]);
    IdeEventQueue.getInstance().getKeyEventDispatcher().resetState();
    boolean keyWasPressed=false;
    for (int i=0; i < events.length; i++) {
      KeyEvent each=events[i];
      if (!isFocusTransferReady())       break;
      if (!keyWasPressed) {
        if (each.getID() == KeyEvent.KEY_PRESSED) {
          keyWasPressed=true;
        }
 else {
          myToDispatchOnDone.remove(each);
          continue;
        }
      }
      final Component owner=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusOwner();
      if (owner != null && SwingUtilities.getWindowAncestor(owner) != null) {
        myToDispatchOnDone.remove(each);
        IdeEventQueue.getInstance().dispatchEvent(new KeyEvent(owner,each.getID(),each.getWhen(),each.getModifiersEx(),each.getKeyCode(),each.getKeyChar(),each.getKeyLocation()));
      }
 else {
        break;
      }
    }
    if (isPendingKeyEventsRedispatched()) {
      final Runnable[] all=myIdleRequests.toArray(new Runnable[myIdleRequests.size()]);
      myIdleRequests.clear();
      for (      Runnable each : all) {
        each.run();
      }
    }
  }
  finally {
    myFlushingIdleRequestsEntryCount--;
    if (!isIdleQueueEmpty()) {
      restartIdleAlarm();
    }
  }
}
