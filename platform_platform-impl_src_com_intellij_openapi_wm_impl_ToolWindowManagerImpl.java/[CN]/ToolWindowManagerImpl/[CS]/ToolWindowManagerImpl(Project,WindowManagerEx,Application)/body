{
  myApp=app;
  myQueue=IdeEventQueue.getInstance();
  myProject=project;
  myWindowManager=windowManagerEx;
  myListenerList=new EventListenerList();
  myLayout=new DesktopLayout();
  myLayout.copyFrom(windowManagerEx.getLayout());
  myId2InternalDecorator=new HashMap<String,InternalDecorator>();
  myId2FloatingDecorator=new HashMap<String,FloatingDecorator>();
  myId2StripeButton=new HashMap<String,StripeButton>();
  myId2FocusWatcher=new HashMap<String,FocusWatcher>();
  myEditorComponentFocusWatcher=new EditorComponentFocusWatcher();
  myToolWindowPropertyChangeListener=new MyToolWindowPropertyChangeListener();
  myInternalDecoratorListener=new MyInternalDecoratorListener();
  myEditorComponentActive=false;
  myActiveStack=new ActiveStack();
  mySideStack=new SideStack();
  myFocusedComponentAlaram=new EdtAlarm(project);
  myForcedFocusRequestsAlarm=new EdtAlarm(project);
  myIdleAlarm=new EdtAlarm(project);
  final AppListener myAppListener=new AppListener();
  app.addApplicationListener(myAppListener);
  Disposer.register(project,new Disposable(){
    public void dispose(){
      app.removeApplicationListener(myAppListener);
    }
  }
);
  IdeEventQueue.getInstance().addDispatcher(new IdeEventQueue.EventDispatcher(){
    public boolean dispatch(    AWTEvent e){
      if (e instanceof FocusEvent) {
        final FocusEvent fe=(FocusEvent)e;
        final Component c=fe.getComponent();
        final IdeFrameImpl frame=myWindowManager.getFrame(myProject);
        if (c instanceof Window || c == null || frame == null)         return false;
        if (isProjectComponent(c)) {
          if (fe.getID() == FocusEvent.FOCUS_GAINED) {
            myLastFocusedProjectComponent=new WeakReference<Component>(c);
          }
        }
      }
      return false;
    }
  }
,myProject);
}
