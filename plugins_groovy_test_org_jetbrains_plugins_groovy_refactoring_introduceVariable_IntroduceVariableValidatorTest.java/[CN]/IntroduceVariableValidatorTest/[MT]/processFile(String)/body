{
  String result="";
  int startOffset=fileText.indexOf(TestUtils.BEGIN_MARKER);
  if (startOffset < 0) {
    startOffset=fileText.indexOf(ALL_MARKER);
    replaceAllOccurences=true;
    fileText=IntroduceVariableTest.removeAllMarker(fileText);
  }
 else {
    replaceAllOccurences=false;
    fileText=TestUtils.removeBeginMarker(fileText);
  }
  int endOffset=fileText.indexOf(TestUtils.END_MARKER);
  fileText=TestUtils.removeEndMarker(fileText);
  myFixture.configureByText(GroovyFileType.GROOVY_FILE_TYPE,fileText);
  Editor myEditor=myFixture.getEditor();
  myEditor.getSelectionModel().setSelection(startOffset,endOffset);
  GroovyIntroduceVariableBase introduceVariableBase=new GroovyIntroduceVariableHandler();
  GrExpression selectedExpr=GroovyRefactoringUtil.findElementInRange(((GroovyFileBase)myFixture.getFile()),startOffset,endOffset,GrExpression.class);
  Assert.assertNotNull("Selected expression reference points to null",selectedExpr);
  final PsiElement tempContainer=GroovyRefactoringUtil.getEnclosingContainer(selectedExpr);
  Assert.assertTrue(tempContainer instanceof GroovyPsiElement);
  PsiElement[] occurences=GroovyRefactoringUtil.getExpressionOccurrences(GroovyRefactoringUtil.getUnparenthesizedExpr(selectedExpr),tempContainer);
  String varName="preved";
  GroovyVariableValidator validator=new GroovyVariableValidator(introduceVariableBase,getProject(),selectedExpr,occurences,(GroovyPsiElement)tempContainer);
  result=validator.isOKTest(varName,replaceAllOccurences);
  return result;
}
