{
  Diff.Change change=reBuildDiffIfNeeded();
  if (change == null)   return line;
  int newLine=line;
  while (change != null) {
    if (line < change.line0)     break;
    if (line >= change.line0 + change.deleted) {
      newLine+=change.inserted - change.deleted;
    }
 else {
      int delta=Math.min(change.inserted,line - change.line0);
      newLine=change.line1 + delta;
      break;
    }
    change=change.link;
  }
  return newLine;
}
