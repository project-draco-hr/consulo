{
  Map<String,Object> style=state.getStyle();
  double scale=canvas.getScale();
  String imgAlign=mxUtils.getString(style,mxConstants.STYLE_IMAGE_ALIGN,mxConstants.ALIGN_LEFT);
  String imgValign=mxUtils.getString(style,mxConstants.STYLE_IMAGE_VERTICAL_ALIGN,mxConstants.ALIGN_MIDDLE);
  int imgWidth=(int)(mxUtils.getInt(style,mxConstants.STYLE_IMAGE_WIDTH,mxConstants.DEFAULT_IMAGESIZE) * scale);
  int imgHeight=(int)(mxUtils.getInt(style,mxConstants.STYLE_IMAGE_HEIGHT,mxConstants.DEFAULT_IMAGESIZE) * scale);
  int spacing=(int)(mxUtils.getInt(style,mxConstants.STYLE_SPACING,2) * scale);
  mxRectangle imageBounds=new mxRectangle(state);
  if (imgAlign.equals(mxConstants.ALIGN_CENTER)) {
    imageBounds.setX(imageBounds.getX() + (imageBounds.getWidth() - imgWidth) / 2);
  }
 else   if (imgAlign.equals(mxConstants.ALIGN_RIGHT)) {
    imageBounds.setX(imageBounds.getX() + imageBounds.getWidth() - imgWidth - spacing - 2);
  }
 else {
    imageBounds.setX(imageBounds.getX() + spacing + 4);
  }
  if (imgValign.equals(mxConstants.ALIGN_TOP)) {
    imageBounds.setY(imageBounds.getY() + spacing);
  }
 else   if (imgValign.equals(mxConstants.ALIGN_BOTTOM)) {
    imageBounds.setY(imageBounds.getY() + imageBounds.getHeight() - imgHeight - spacing);
  }
 else {
    imageBounds.setY(imageBounds.getY() + (imageBounds.getHeight() - imgHeight) / 2);
  }
  imageBounds.setWidth(imgWidth);
  imageBounds.setHeight(imgHeight);
  return imageBounds.getRectangle();
}
