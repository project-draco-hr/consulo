{
  final FileType fileType=myHelper.getFileType();
  final PsiElement psiElement=SourceTreeToPsiMap.treeElementToPsi(element);
  final FormattingModelBuilder builder=SourceTreeToPsiMap.treeElementToPsi(element).getContainingFile().getLanguage().getFormattingModelBuilder();
  if (builder != null) {
    TextRange range=formatComments(element,startOffset,endOffset);
    final SmartPsiElementPointer pointer=SmartPointerManager.getInstance(psiElement.getProject()).createSmartPsiElementPointer(psiElement);
    final PsiFile containingFile=psiElement.getContainingFile();
    final FormattingModel model=builder.createModel(containingFile,mySettings);
    if (containingFile.getTextLength() > 0) {
      try {
        Formatter.getInstance().format(model,mySettings,mySettings.getIndentOptions(fileType),range);
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
    return SourceTreeToPsiMap.psiElementToTree(pointer.getElement());
  }
  if (useNewFormatter(fileType)) {
    PseudoTextBuilder pseudoTextBuilder=((LanguageFileType)fileType).getLanguage().getFormatter();
    if (pseudoTextBuilder == null) {
      return element;
    }
 else {
      try {
        final PseudoText pseudoText=pseudoTextBuilder.build(myHelper.getProject(),mySettings,psiElement);
        GeneralCodeFormatter.createSimpleInstance(pseudoText,mySettings,fileType,startOffset,endOffset,null).format();
      }
 catch (      ProcessCanceledException processCanceledException) {
        throw processCanceledException;
      }
catch (      Exception e) {
        LOG.error(e);
      }
      formatComments(element,startOffset,endOffset);
      return element;
    }
  }
  final TextRange range=element.getTextRange();
  final int elementStartOffset=range.getStartOffset();
  return processRange(element,new int[]{startOffset - elementStartOffset,endOffset - elementStartOffset});
}
