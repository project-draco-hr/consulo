{
  TextRange result=range;
  PsiElement psi;
  if (element instanceof RepositoryTreeElement && (psi=element.getPsi()) instanceof PsiDocCommentOwner) {
    final TextRange elementRange=element.getTextRange();
    if (range.contains(elementRange)) {
      myCommentFormatter.process(element);
      final TextRange newRange=element.getTextRange();
      result=new TextRange(range.getStartOffset(),range.getEndOffset() + newRange.getLength() - elementRange.getLength());
    }
    if (psi instanceof PsiField || psi instanceof PsiMethod || range.getEndOffset() < elementRange.getStartOffset()) {
      return result;
    }
  }
  if (element instanceof CompositeElement) {
    ASTNode current=element.getFirstChildNode();
    while (current != null) {
      if (current instanceof ChameleonElement) {
        ASTNode next=current.getTreeNext();
        final ASTNode astNode=ChameleonTransforming.transform((ChameleonElement)element);
        if (astNode == null)         current=next;
 else         current=astNode;
      }
      result=formatCommentsInner(current,result);
      current=current.getTreeNext();
    }
  }
  return result;
}
