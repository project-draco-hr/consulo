{
  final FormattingModel original=builder.createModel(containingFile,mySettings);
  final Project project=containingFile.getProject();
  final Document document=PsiDocumentManager.getInstance(project).getDocument(containingFile);
  if (document != null && document.getUserData(CodeStyleManagerEx.USE_DOCUMENT_TO_REFORMAT) == Boolean.TRUE) {
    return new DocumentBasedFormattingModel(original.getRootBlock(),document,project,mySettings,containingFile.getFileType());
  }
 else {
    return original;
  }
}
