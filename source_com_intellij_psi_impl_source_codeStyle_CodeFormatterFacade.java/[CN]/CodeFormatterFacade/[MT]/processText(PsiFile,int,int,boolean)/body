{
  final FileType fileType=myHelper.getFileType();
  final FormattingModelBuilder builder=file.getLanguage().getEffectiveFormattingModelBuilder(file);
  if (builder != null) {
    if (file.getTextLength() > 0) {
      try {
        TextRange range=formatComments(file.getNode(),new TextRange(startOffset,endOffset));
        final PostprocessReformattingAspect component=file.getProject().getComponent(PostprocessReformattingAspect.class);
        component.doPostponedFormatting(file.getViewProvider());
        Block rootBlock=builder.createModel(file,mySettings).getRootBlock();
        Project project=file.getProject();
        final FormattingModel model=new DocumentBasedFormattingModel(rootBlock,PsiDocumentManager.getInstance(project).getDocument(file),project,mySettings,fileType,file);
        FormatterEx.getInstanceEx().format(model,mySettings,mySettings.getIndentOptions(fileType),range,headWhitespace);
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
}
