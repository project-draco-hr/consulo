{
  if (!psiElement.isValid())   return;
  final PsiFile containingFile=psiElement.getContainingFile();
  if (containingFile != null && containingFile.getVirtualFile() == null)   return;
  psiElement=psiElement.getOriginalElement();
  PsiElement resultElement=psiElement;
  if (containingFile != null) {
    if (!(psiElement instanceof PsiClass)) {
      resultElement=containingFile;
    }
    final PsiDirectory containingDirectory=containingFile.getContainingDirectory();
    if (containingDirectory != null) {
      traverseToRoot(containingDirectory,roots);
    }
  }
 else   if (psiElement instanceof PsiDirectory) {
    final PsiDirectory psiDirectory=(PsiDirectory)psiElement;
    final PsiDirectory parentDirectory=psiDirectory.getParentDirectory();
    if (!roots.contains(psiDirectory.getVirtualFile()) && parentDirectory != null) {
      traverseToRoot(parentDirectory,roots);
    }
  }
 else   if (psiElement instanceof PsiPackage) {
    final PsiPackage psiPackage=(PsiPackage)psiElement;
    final PsiPackage parentPackage=psiPackage.getParentPackage();
    if (parentPackage != null) {
      final String qualifiedName=parentPackage.getQualifiedName();
      if (qualifiedName.length() > 0) {
        traverseToRoot(parentPackage,roots);
      }
    }
  }
  addElement(resultElement);
}
