{
  Extensions.cleanRootArea(parentDisposable);
  myFileTypeRegistry=new CoreFileTypeRegistry();
  myEncodingRegistry=new CoreEncodingRegistry();
  myApplication=new MockApplication(parentDisposable);
  ApplicationManager.setApplication(myApplication,new StaticGetter<FileTypeRegistry>(myFileTypeRegistry),new StaticGetter<EncodingRegistry>(myEncodingRegistry),parentDisposable);
  myLocalFileSystem=new CoreLocalFileSystem();
  myJarFileSystem=new CoreJarFileSystem();
  Extensions.registerAreaClass("IDEA_PROJECT",null);
  myProject=new MockProject(myApplication.getPicoContainer(),parentDisposable);
  final MutablePicoContainer appContainer=myApplication.getPicoContainer();
  registerComponentInstance(appContainer,FileDocumentManager.class,new MockFileDocumentManagerImpl(new Function<CharSequence,Document>(){
    @Override public Document fun(    CharSequence charSequence){
      return new DocumentImpl(charSequence);
    }
  }
,null));
  registerComponentInstance(appContainer,VirtualFileManager.class,new VirtualFileManagerImpl(new VirtualFileSystem[]{myLocalFileSystem,myJarFileSystem},new MessageBusImpl(myApplication,null),new FileSystemPersistence(){
    @Override public void refresh(    boolean asynchronous,    Runnable postAction,    @NotNull ModalityState modalityState){
    }
    @Override public int getCheapFileSystemModificationCount(){
      return 0;
    }
  }
));
  myApplication.registerService(DefaultASTFactory.class,new CoreASTFactory());
  myApplication.registerService(PsiBuilderFactory.class,new PsiBuilderFactoryImpl());
  myApplication.registerService(ReferenceProvidersRegistry.class,new MockReferenceProvidersRegistry());
  myApplication.registerService(StubTreeLoader.class,new CoreStubTreeLoader());
  myApplication.registerService(PsiReferenceService.class,new PsiReferenceServiceImpl());
  registerExtensionPoint(Extensions.getRootArea(),ContentBasedFileSubstitutor.EP_NAME,ContentBasedFileSubstitutor.class);
  registerExtensionPoint(Extensions.getRootArea(),BinaryFileStubBuilders.EP_NAME,FileTypeExtensionPoint.class);
  myFileIndexFacade=new MockFileIndexFacade(myProject);
  final MutablePicoContainer projectContainer=myProject.getPicoContainer();
  PsiModificationTrackerImpl modificationTracker=new PsiModificationTrackerImpl(myProject);
  myProject.registerService(PsiModificationTracker.class,modificationTracker);
  myProject.registerService(FileIndexFacade.class,myFileIndexFacade);
  myProject.registerService(ResolveScopeManager.class,new MockResolveScopeManager(myProject));
  myProject.registerService(ResolveCache.class,new ResolveCache(null));
  registerProjectExtensionPoint(PsiTreeChangePreprocessor.EP_NAME,PsiTreeChangePreprocessor.class);
  myPsiManager=new PsiManagerImpl(myProject,null,null,myFileIndexFacade,null,modificationTracker);
  ((FileManagerImpl)myPsiManager.getFileManager()).markInitialized();
  registerComponentInstance(projectContainer,PsiManager.class,myPsiManager);
  myProject.registerService(PsiFileFactory.class,new PsiFileFactoryImpl(myPsiManager));
  myProject.registerService(CachedValuesManager.class,new CachedValuesManagerImpl(myProject,new PsiCachedValuesFactory(myPsiManager)));
  myProject.registerService(PsiDirectoryFactory.class,new PsiDirectoryFactoryImpl(myPsiManager));
  myProject.registerService(ProjectScopeBuilder.class,new CoreProjectScopeBuilder(myProject,myFileIndexFacade));
  myProject.registerService(DumbService.class,new MockDumbService(myProject));
  ProgressIndicatorProvider.ourInstance=new ProgressIndicatorProvider(){
    @Override public ProgressIndicator getProgressIndicator(){
      return new EmptyProgressIndicator();
    }
    @Override protected void doCheckCanceled() throws ProcessCanceledException {
    }
    @Override public NonCancelableSection startNonCancelableSection(){
      return new NonCancelableSection(){
        @Override public void done(){
        }
      }
;
    }
  }
;
}
