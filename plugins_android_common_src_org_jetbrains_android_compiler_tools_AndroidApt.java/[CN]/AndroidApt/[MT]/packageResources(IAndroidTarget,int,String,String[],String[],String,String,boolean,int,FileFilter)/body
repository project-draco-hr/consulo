{
  for (  String resDirPath : resPaths) {
    if (FileUtil.isAncestor(resDirPath,outputPath,false)) {
      throw new IOException("Resource directory " + FileUtil.toSystemDependentName(resDirPath) + " contains output "+ FileUtil.toSystemDependentName(outputPath));
    }
  }
  for (  String assetsDirPath : osAssetDirPaths) {
    if (FileUtil.isAncestor(assetsDirPath,outputPath,false)) {
      throw new IOException("Assets directory " + FileUtil.toSystemDependentName(assetsDirPath) + " contains output "+ FileUtil.toSystemDependentName(outputPath));
    }
  }
  final ArrayList<String> args=new ArrayList<String>();
  args.add(target.getPath(IAndroidTarget.AAPT));
  args.add(COMMAND_PACKAGE);
  for (  String path : resPaths) {
    args.add("-S");
    args.add(path);
  }
  args.add("-f");
  if (platformToolsRevision < 0 || platformToolsRevision > 7) {
    args.add("--no-crunch");
  }
  if (resPaths.length > 1) {
    args.add("--auto-add-overlay");
  }
  if (debugMode) {
    args.add("--debug-mode");
  }
  if (versionCode > 0) {
    args.add("--version-code");
    args.add(Integer.toString(versionCode));
  }
  if (configFilter != null) {
    args.add("-c");
    args.add(configFilter);
  }
  args.add("-M");
  args.add(manifestPath);
  File tempDir=null;
  try {
    if (osAssetDirPaths.length > 0) {
      final String[] nonEmptyAssetDirs=getNonEmptyExistingDirs(osAssetDirPaths);
      if (nonEmptyAssetDirs.length > 0) {
        if (nonEmptyAssetDirs.length == 1) {
          args.add("-A");
          args.add(nonEmptyAssetDirs[0]);
        }
 else {
          tempDir=FileUtil.createTempDirectory("android_combined_assets","tmp");
          for (int i=nonEmptyAssetDirs.length - 1; i >= 0; i--) {
            final String assetDir=nonEmptyAssetDirs[i];
            FileUtil.copyDir(new File(assetDir),tempDir,assetsFilter);
          }
          args.add("-A");
          args.add(tempDir.getPath());
        }
      }
    }
    args.add("-I");
    args.add(target.getPath(IAndroidTarget.ANDROID_JAR));
    args.add("-F");
    args.add(outputPath);
    LOG.info(AndroidCommonUtils.command2string(args));
    return AndroidExecutionUtil.doExecute(ArrayUtil.toStringArray(args));
  }
  finally {
    if (tempDir != null) {
      FileUtil.delete(tempDir);
    }
  }
}
