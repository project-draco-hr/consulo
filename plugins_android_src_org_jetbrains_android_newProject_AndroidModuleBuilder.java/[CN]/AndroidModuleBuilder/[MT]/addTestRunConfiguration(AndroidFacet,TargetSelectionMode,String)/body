{
  Project project=facet.getModule().getProject();
  RunManagerEx runManager=RunManagerEx.getInstanceEx(project);
  Module module=facet.getModule();
  RunnerAndConfigurationSettings settings=runManager.createRunConfiguration(module.getName(),AndroidTestRunConfigurationType.getInstance().getFactory());
  AndroidTestRunConfiguration configuration=(AndroidTestRunConfiguration)settings.getConfiguration();
  configuration.setModule(module);
  configuration.setTargetSelectionMode(mode);
  if (preferredAvd != null) {
    configuration.PREFERRED_AVD=preferredAvd;
  }
  runManager.addConfiguration(settings,false);
  runManager.setActiveConfiguration(settings);
}
