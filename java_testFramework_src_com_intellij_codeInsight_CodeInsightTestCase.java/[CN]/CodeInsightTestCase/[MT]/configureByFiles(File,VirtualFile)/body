{
  myFile=null;
  myEditor=null;
  final ModuleRootManager rootManager=ModuleRootManager.getInstance(myModule);
  final ModifiableRootModel rootModel=rootManager.getModifiableModel();
  if (clearModelBeforeConfiguring()) {
    rootModel.clear();
  }
  File toDirIO=createTempDirectory();
  VirtualFile toDir=getVirtualFile(toDirIO);
  vFiles=ArrayUtil.reverseArray(vFiles);
  final LinkedHashMap<VirtualFile,EditorInfo> editorInfos;
  if (rawProjectRoot != null) {
    final File projectRoot=rawProjectRoot.getCanonicalFile();
    FileUtil.copyDir(projectRoot,toDirIO);
    VirtualFile fromDir=getVirtualFile(projectRoot);
    editorInfos=copyFilesFillingEditorInfos(fromDir,toDir,ContainerUtil.map2Array(vFiles,String.class,new Function<VirtualFile,String>(){
      public String fun(      final VirtualFile s){
        return s.getPath().substring(projectRoot.getPath().length());
      }
    }
));
    VirtualFileManager.getInstance().refresh(false);
  }
 else {
    editorInfos=new LinkedHashMap<VirtualFile,EditorInfo>();
    for (    final VirtualFile vFile : vFiles) {
      editorInfos.putAll(copyFilesFillingEditorInfos(vFile.getParent(),toDir,vFile.getName()));
    }
  }
  boolean sourceRootAdded=false;
  if (isAddDirToContentRoot()) {
    final ContentEntry contentEntry=rootModel.addContentEntry(toDir);
    if (isAddDirToSource()) {
      sourceRootAdded=true;
      contentEntry.addSourceFolder(toDir,false);
    }
  }
  doCommitModel(rootModel);
  if (sourceRootAdded) {
    sourceRootAdded(toDir);
  }
  openEditorsAndActivateLast(editorInfos);
  return toDir;
}
