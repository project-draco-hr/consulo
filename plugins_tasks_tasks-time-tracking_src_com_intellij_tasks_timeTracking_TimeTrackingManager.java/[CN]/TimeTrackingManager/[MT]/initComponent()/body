{
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    myTimeTrackingTimer=UIUtil.createNamedTimer("TaskManager time tracking",TIME_TRACKING_TIME_UNIT,new ActionListener(){
      @Override public void actionPerformed(      final ActionEvent e){
        final LocalTask activeTask=myTaskManager.getActiveTask();
        if (myLastActiveTask != activeTask) {
          activeTask.addWorkItem(new WorkItem(new Date()));
        }
        if (getState().autoMode) {
          final WorkItem lastWorkItem=activeTask.getWorkItems().get(activeTask.getWorkItems().size() - 1);
          lastWorkItem.duration+=TIME_TRACKING_TIME_UNIT;
          getState().totallyTimeSpent+=TIME_TRACKING_TIME_UNIT;
        }
 else {
          if (activeTask.isRunning()) {
            final WorkItem lastWorkItem=activeTask.getWorkItems().get(activeTask.getWorkItems().size() - 1);
            lastWorkItem.duration+=TIME_TRACKING_TIME_UNIT;
            getState().totallyTimeSpent+=TIME_TRACKING_TIME_UNIT;
          }
        }
        myLastActiveTask=activeTask;
      }
    }
);
    StartupManager.getInstance(myProject).registerStartupActivity(new Runnable(){
      public void run(){
        ApplicationManager.getApplication().invokeLater(new Runnable(){
          @Override public void run(){
            startTimeTrackingTimer();
          }
        }
);
      }
    }
);
    myIdleAlarm=new Alarm(Alarm.ThreadToUse.SWING_THREAD);
    myActivityListener=new Runnable(){
      @Override public void run(){
        final IdeFrame frame=IdeFocusManager.getGlobalInstance().getLastFocusedFrame();
        if (frame == null)         return;
        final Project project=frame.getProject();
        if (project == null || !myProject.equals(project))         return;
        startTimeTrackingTimer();
      }
    }
;
    if (getState().autoMode) {
      IdeEventQueue.getInstance().addActivityListener(myActivityListener,myProject);
    }
  }
}
