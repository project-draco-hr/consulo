{
  if (!shouldLoadPlugins()) {
    ourPlugins=new IdeaPluginDescriptor[0];
    return;
  }
  configureExtensions();
  final IdeaPluginDescriptor[] pluginDescriptors=loadDescriptors();
  final Map<PluginId,IdeaPluginDescriptor> idToDescriptorMap=new HashMap<PluginId,IdeaPluginDescriptor>();
  for (  final IdeaPluginDescriptor descriptor : pluginDescriptors) {
    idToDescriptorMap.put(descriptor.getPluginId(),descriptor);
  }
  Arrays.sort(pluginDescriptors,getPluginDescriptorComparator(idToDescriptorMap));
  final Class callerClass=Reflection.getCallerClass(1);
  final ClassLoader parentLoader=callerClass.getClassLoader();
  for (  final IdeaPluginDescriptor pluginDescriptor : pluginDescriptors) {
    final List<File> classPath=pluginDescriptor.getClassPath();
    final PluginId[] dependentPluginIds=pluginDescriptor.getDependentPluginIds();
    final ClassLoader[] parentLoaders=dependentPluginIds.length > 0 ? getParentLoaders(idToDescriptorMap,dependentPluginIds) : new ClassLoader[]{parentLoader};
    final IdeaClassLoader pluginClassLoader=createPluginClassLoader(classPath.toArray(new File[classPath.size()]),pluginDescriptor.getPluginId(),parentLoaders,pluginDescriptor.getPath());
    pluginDescriptor.setLoader(pluginClassLoader);
    pluginDescriptor.registerExtensions();
  }
  ourPlugins=pluginDescriptors;
}
