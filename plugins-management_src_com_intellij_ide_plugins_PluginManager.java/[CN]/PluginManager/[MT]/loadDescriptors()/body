{
  if (isLoadingOfExternalPluginsDisabled()) {
    return IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  final List<IdeaPluginDescriptorImpl> result=new ArrayList<IdeaPluginDescriptorImpl>();
  loadDescriptors(PathManager.getPluginsPath(),result);
  loadDescriptors(PathManager.getPreinstalledPluginsPath(),result);
  loadDescriptorsFromProperty(result);
  if (Boolean.valueOf(System.getProperty(IdeaApplication.IDEA_IS_INTERNAL_PROPERTY)).booleanValue()) {
    loadDescriptorsFromClassPath(result);
  }
  String errorMessage=filterBadPlugins(result);
  IdeaPluginDescriptorImpl[] pluginDescriptors=result.toArray(new IdeaPluginDescriptorImpl[result.size()]);
  try {
    Arrays.sort(pluginDescriptors,new PluginDescriptorComparator(pluginDescriptors));
  }
 catch (  Exception e) {
    errorMessage=IdeBundle.message("error.plugins.were.not.loaded",e.getMessage());
    pluginDescriptors=IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  if (errorMessage != null) {
    JOptionPane.showMessageDialog(null,errorMessage,IdeBundle.message("title.plugin.error"),JOptionPane.ERROR_MESSAGE);
  }
  return pluginDescriptors;
}
