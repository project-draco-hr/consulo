{
  if (isLoadingOfExternalPluginsDisabled()) {
    return IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  final List<IdeaPluginDescriptorImpl> result=new ArrayList<IdeaPluginDescriptorImpl>();
  loadDescriptors(PathManager.getPluginsPath(),result);
  loadDescriptors(PathManager.getPreinstalledPluginsPath(),result);
  loadDescriptorsFromProperty(result);
  loadDescriptorsFromClassPath(result);
  String errorMessage=filterBadPlugins(result);
  IdeaPluginDescriptorImpl[] pluginDescriptors=result.toArray(new IdeaPluginDescriptorImpl[result.size()]);
  try {
    Arrays.sort(pluginDescriptors,new PluginDescriptorComparator(pluginDescriptors));
  }
 catch (  Exception e) {
    errorMessage=IdeBundle.message("error.plugins.were.not.loaded",e.getMessage());
    getLogger().info(e);
    pluginDescriptors=IdeaPluginDescriptorImpl.EMPTY_ARRAY;
  }
  if (errorMessage != null) {
    if (!Main.isHeadless()) {
      myPluginError=errorMessage;
    }
 else {
      getLogger().error(errorMessage);
    }
  }
  return pluginDescriptors;
}
