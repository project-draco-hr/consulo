{
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  Map<Document,List<UsageOffset>> docsToOffsetsMap=new HashMap<Document,List<UsageOffset>>();
  final PsiDocumentManager psiDocumentManager=PsiDocumentManager.getInstance(project);
  for (  NonCodeUsageInfo usage : usages) {
    PsiElement element=usage.getElement();
    if (element == null)     continue;
    element=CodeInsightUtilBase.forcePsiPostprocessAndRestoreElement(element,true);
    if (element == null)     continue;
    final ProperTextRange rangeInElement=usage.getRangeInElement();
    if (rangeInElement == null)     continue;
    final PsiFile containingFile=element.getContainingFile();
    final Document document=psiDocumentManager.getDocument(containingFile);
    final Segment segment=usage.getSegment();
    LOG.assertTrue(segment != null);
    int fileOffset=segment.getStartOffset();
    List<UsageOffset> list=docsToOffsetsMap.get(document);
    if (list == null) {
      list=new ArrayList<UsageOffset>();
      docsToOffsetsMap.put(document,list);
    }
    list.add(new UsageOffset(fileOffset,fileOffset + rangeInElement.getLength(),usage.newText));
  }
  for (  Document document : docsToOffsetsMap.keySet()) {
    List<UsageOffset> list=docsToOffsetsMap.get(document);
    LOG.assertTrue(list != null,document);
    UsageOffset[] offsets=list.toArray(new UsageOffset[list.size()]);
    Arrays.sort(offsets);
    for (int i=offsets.length - 1; i >= 0; i--) {
      UsageOffset usageOffset=offsets[i];
      document.replaceString(usageOffset.startOffset,usageOffset.endOffset,usageOffset.newText);
    }
    PsiDocumentManager.getInstance(project).commitDocument(document);
  }
  PsiDocumentManager.getInstance(project).commitAllDocuments();
}
