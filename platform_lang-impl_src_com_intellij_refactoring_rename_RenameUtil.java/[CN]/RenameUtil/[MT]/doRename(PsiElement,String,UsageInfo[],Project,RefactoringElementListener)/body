{
  final RenamePsiElementProcessor processor=RenamePsiElementProcessor.forElement(element);
  final String fqn=element instanceof PsiFile ? ((PsiFile)element).getVirtualFile().getPath() : CopyReferenceAction.elementToFqn(element);
  if (fqn != null) {
    UndoableAction action=new BasicUndoableAction(){
      public void undo() throws UnexpectedUndoException {
        if (listener instanceof UndoRefactoringElementListener) {
          ((UndoRefactoringElementListener)listener).undoElementMovedOrRenamed(element,fqn);
        }
      }
      @Override public void redo() throws UnexpectedUndoException {
      }
    }
;
    UndoManager.getInstance(project).undoableActionPerformed(action);
  }
  try {
    processor.renameElement(element,newName,usages,listener);
  }
 catch (  final IncorrectOperationException e) {
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      throw new RuntimeException(e);
    }
    ApplicationManager.getApplication().invokeLater(new Runnable(){
      public void run(){
        CommonRefactoringUtil.showErrorMessage(RefactoringBundle.message("rename.title"),e.getMessage(),processor.getHelpID(element),project);
      }
    }
);
  }
}
