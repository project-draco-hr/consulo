{
  if (!(file.getFileType() instanceof NativeFileType) && !(file.getFileType() instanceof UnknownFileType)) {
    return null;
  }
  final String ext=file.getExtension();
  final String filePath=file.getPath();
  Icon icon;
synchronized (myIconCache) {
    if (!myCustomIconExtensions.contains(ext)) {
      icon=ext != null ? myIconCache.get(ext) : null;
    }
 else {
      icon=filePath != null ? myCustomIconCache.get(filePath) : null;
    }
  }
  if (icon != null) {
    return icon;
  }
  return new DeferredIconImpl<VirtualFile>(file.getFileType().getIcon(),file,false,new Function<VirtualFile,Icon>(){
    public Icon fun(    VirtualFile virtualFile){
      final File f=new File(filePath);
      if (!f.exists()) {
        return null;
      }
      Icon icon;
      try {
        icon=myFileChooser.getIcon(f);
      }
 catch (      Exception e) {
        return null;
      }
      if (ext != null) {
synchronized (myIconCache) {
          if (!myCustomIconExtensions.contains(ext)) {
            myIconCache.put(ext,icon);
          }
 else           if (filePath != null) {
            myCustomIconCache.put(filePath,icon);
          }
        }
      }
      return icon;
    }
  }
);
}
