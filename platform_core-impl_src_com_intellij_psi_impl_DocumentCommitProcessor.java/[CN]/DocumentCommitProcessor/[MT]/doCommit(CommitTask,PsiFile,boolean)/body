{
  Document document=task.document;
  final long startDocModificationTimeStamp=document.getModificationStamp();
  final FileElement myTreeElementBeingReparsedSoItWontBeCollected=((PsiFileImpl)file).calcTreeElement();
  final CharSequence chars=document.getImmutableCharSequence();
  final TextRange changedPsiRange=getChangedPsiRange(file,myTreeElementBeingReparsedSoItWontBeCollected,chars);
  if (changedPsiRange == null) {
    return null;
  }
  final Boolean data=document.getUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY);
  if (data != null) {
    document.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,null);
    file.putUserData(BlockSupport.DO_NOT_REPARSE_INCREMENTALLY,data);
  }
  BlockSupport blockSupport=BlockSupport.getInstance(file.getProject());
  final DiffLog diffLog=blockSupport.reparseRange(file,changedPsiRange,chars,task.indicator,task.myLastCommittedText);
  return new Processor<Document>(){
    @Override public boolean process(    Document document){
      ApplicationManager.getApplication().assertWriteAccessAllowed();
      log("Finishing",task,synchronously,document.getModificationStamp(),startDocModificationTimeStamp);
      if (document.getModificationStamp() != startDocModificationTimeStamp || ((PsiDocumentManagerBase)PsiDocumentManager.getInstance(file.getProject())).getCachedViewProvider(document) != file.getViewProvider()) {
        return false;
      }
      doActualPsiChange(file,diffLog);
      assertAfterCommit(document,file,myTreeElementBeingReparsedSoItWontBeCollected);
      return true;
    }
  }
;
}
