{
  super.beforeMove(editor);
  if (statementToSurroundWithCodeBlock != null) {
    try {
      final Document document=PsiDocumentManager.getInstance(statementToSurroundWithCodeBlock.getProject()).getDocument(statementToSurroundWithCodeBlock.getContainingFile());
      int startOffset=document.getLineStartOffset(toMove.startLine);
      int endOffset=getLineStartSafeOffset(document,toMove.endLine);
      if (document.getText().charAt(endOffset - 1) == '\n')       endOffset--;
      final RangeMarker lineRangeMarker=document.createRangeMarker(startOffset,endOffset);
      final PsiElementFactory factory=statementToSurroundWithCodeBlock.getManager().getElementFactory();
      PsiCodeBlock codeBlock=factory.createCodeBlock();
      codeBlock.add(statementToSurroundWithCodeBlock);
      final PsiBlockStatement blockStatement=(PsiBlockStatement)factory.createStatementFromText("{}",statementToSurroundWithCodeBlock);
      blockStatement.getCodeBlock().replace(codeBlock);
      PsiBlockStatement newStatement=(PsiBlockStatement)statementToSurroundWithCodeBlock.replace(blockStatement);
      newStatement=CodeInsightUtil.forcePsiPostprocessAndRestoreElement(newStatement);
      toMove=new LineRange(document.getLineNumber(lineRangeMarker.getStartOffset()),document.getLineNumber(lineRangeMarker.getEndOffset()) + 1);
      PsiCodeBlock newCodeBlock=newStatement.getCodeBlock();
      if (isDown) {
        PsiElement blockChild=firstNonWhiteElement(newCodeBlock.getFirstBodyElement(),true);
        if (blockChild == null)         blockChild=newCodeBlock.getRBrace();
        toMove2=new LineRange(toMove2.startLine,document.getLineNumber(blockChild.getTextRange().getStartOffset()));
      }
 else {
        int start=document.getLineNumber(newCodeBlock.getRBrace().getTextRange().getStartOffset());
        int end=toMove.startLine;
        if (start > end)         end=start;
        toMove2=new LineRange(start,end);
      }
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
  }
}
