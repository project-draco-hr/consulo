{
  if (!isFoldingEnabled()) {
    return;
  }
  if (myCachedVisible == null) {
    rebuild();
    return;
  }
  for (  FoldRegion foldRegion : myCachedVisible) {
    if (!foldRegion.isValid()) {
      rebuild();
      return;
    }
  }
  int length=myCachedTopLevelRegions.length;
  if (myCachedEndOffsets == null || myCachedEndOffsets.length != length) {
    if (length != 0) {
      myCachedEndOffsets=new int[length];
      myCachedStartOffsets=new int[length];
      myCachedFoldedLines=new int[length];
    }
 else {
      myCachedEndOffsets=ArrayUtil.EMPTY_INT_ARRAY;
      myCachedStartOffsets=ArrayUtil.EMPTY_INT_ARRAY;
      myCachedFoldedLines=ArrayUtil.EMPTY_INT_ARRAY;
    }
  }
  int sum=0;
  for (int i=0; i < length; i++) {
    FoldRegion region=myCachedTopLevelRegions[i];
    myCachedStartOffsets[i]=region.getStartOffset();
    myCachedEndOffsets[i]=region.getEndOffset() - 1;
    Document document=region.getDocument();
    sum+=document.getLineNumber(region.getEndOffset()) - document.getLineNumber(region.getStartOffset());
    myCachedFoldedLines[i]=sum;
  }
}
