{
  ArrayList<FoldRegion> topLevels=new ArrayList<FoldRegion>(myRegions.size() / 2);
  ArrayList<FoldRegion> visible=new ArrayList<FoldRegion>(myRegions.size());
  FoldRegion[] regions=toFoldArray(myRegions);
  FoldRegion currentCollapsed=null;
  for (  FoldRegion region : regions) {
    if (!region.isValid()) {
      continue;
    }
    if (currentCollapsed == null || !contains(currentCollapsed,region)) {
      visible.add(region);
    }
    if (!region.isExpanded()) {
      if (currentCollapsed == null || currentCollapsed.getEndOffset() < region.getStartOffset()) {
        currentCollapsed=region;
        topLevels.add(region);
      }
    }
  }
  myCachedTopLevelRegions=toFoldArray(topLevels);
  myCachedVisible=toFoldArray(visible);
  Arrays.sort(myCachedTopLevelRegions,BY_END_OFFSET);
  Arrays.sort(myCachedVisible,BY_END_OFFSET_REVERSE);
  updateCachedOffsets();
}
