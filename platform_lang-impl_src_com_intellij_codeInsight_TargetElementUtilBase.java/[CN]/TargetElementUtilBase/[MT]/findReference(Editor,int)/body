{
  Project project=editor.getProject();
  if (project == null)   return null;
  Document document=editor.getDocument();
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
  if (file == null)   return null;
  if (ApplicationManager.getApplication().isDispatchThread()) {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
  }
  offset=adjustOffset(document,offset);
  if (file instanceof PsiCompiledFile) {
    return ((PsiCompiledFile)file).getDecompiledPsiFile().findReferenceAt(offset);
  }
  return file.findReferenceAt(offset);
}
