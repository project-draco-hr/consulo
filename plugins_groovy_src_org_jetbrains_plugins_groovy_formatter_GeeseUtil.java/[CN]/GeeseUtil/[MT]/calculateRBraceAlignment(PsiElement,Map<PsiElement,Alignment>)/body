{
  int leadingBraceCount=0;
  PsiElement next=psi;
  while (isClosureRBrace(next=getPreviousNonWhitespaceToken(next))) {
    leadingBraceCount++;
  }
  PsiElement cur=psi;
  while (isClosureRBrace(next=getNextNonWhitespaceToken(cur))) {
    cur=next;
  }
  for (; leadingBraceCount > 0; leadingBraceCount--) {
    cur=getPreviousNonWhitespaceToken(cur);
  }
  PsiElement parent=cur.getParent();
  LOG.assertTrue(parent instanceof GrClosableBlock);
  cur=parent;
  while (!PsiUtil.isNewLine(next=PsiTreeUtil.prevLeaf(cur,true))) {
    if (next == null)     break;
    cur=next;
  }
  Alignment alignment=alignments.get(cur);
  if (alignment == null) {
    alignment=Alignment.createAlignment(true);
    alignments.put(cur,alignment);
  }
  return alignment;
}
