{
  int leadingBraceCount=0;
  PsiElement next=psi;
  while (isClosureRBrace(next=getPreviousNonWhitespaceToken(next))) {
    leadingBraceCount++;
  }
  PsiElement cur=psi;
  while (isClosureRBrace(next=getNextNonWhitespaceToken(cur))) {
    cur=next;
  }
  for (; leadingBraceCount > 0; leadingBraceCount--) {
    cur=getPreviousNonWhitespaceToken(cur);
  }
  PsiElement parent=cur.getParent();
  LOG.assertTrue(parent instanceof GrClosableBlock);
  cur=parent;
  if (cur.getParent() instanceof GrMethodCall) {
    GrMethodCall call=(GrMethodCall)cur.getParent();
    GrExpression invoked=call.getInvokedExpression();
    if (invoked instanceof GrReferenceExpression && ((GrReferenceExpression)invoked).getReferenceNameElement() != null) {
      cur=((GrReferenceExpression)invoked).getReferenceNameElement();
    }
 else {
      cur=call;
    }
  }
  cur=PsiTreeUtil.getDeepestFirst(cur);
  while (!PsiUtil.isNewLine(next=PsiTreeUtil.prevLeaf(cur,true))) {
    if (next == null)     break;
    cur=next;
  }
  Alignment alignment=alignments.get(cur);
  if (alignment == null) {
    alignment=Alignment.createAlignment(true);
    alignments.put(cur,alignment);
  }
  return alignment;
}
