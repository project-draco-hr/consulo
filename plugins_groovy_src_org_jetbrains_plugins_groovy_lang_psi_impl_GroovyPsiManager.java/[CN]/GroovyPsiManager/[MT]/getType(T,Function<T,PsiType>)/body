{
  PsiType type=myCalculatedTypes.get(element);
  if (type == null) {
    RecursionGuard.StackStamp stamp=ourGuard.markStack();
    type=calculator.fun(element);
    if (type == null) {
      type=UNKNOWN_TYPE;
    }
    if (stamp.mayCacheNow()) {
      type=ConcurrencyUtil.cacheOrGet(myCalculatedTypes,element,type);
    }
 else {
      final PsiType alreadyInferred=myCalculatedTypes.get(element);
      if (alreadyInferred != null) {
        type=alreadyInferred;
      }
    }
  }
  if (!type.isValid()) {
    LOG.error("Type is invalid: " + type + "; element: "+ element+ " of class "+ element.getClass());
  }
  return UNKNOWN_TYPE == type ? null : type;
}
