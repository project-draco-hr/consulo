{
  Action[] actions=filter(createActions());
  Action[] leftSideActions=createLeftSideActions();
  Map<Action,JButton> buttonMap=new LinkedHashMap<>();
  boolean hasHelpToMoveToLeftSide=false;
  if (UIUtil.isUnderAquaLookAndFeel() && Arrays.asList(actions).contains(getHelpAction())) {
    hasHelpToMoveToLeftSide=true;
    actions=ArrayUtil.remove(actions,getHelpAction());
  }
  if (SystemInfo.isMac) {
    for (    Action action : actions) {
      if (action instanceof MacOtherAction) {
        leftSideActions=ArrayUtil.append(leftSideActions,action);
        actions=ArrayUtil.remove(actions,action);
        break;
      }
    }
  }
 else   if (UIUtil.isUnderGTKLookAndFeel() && Arrays.asList(actions).contains(getHelpAction())) {
    leftSideActions=ArrayUtil.append(leftSideActions,getHelpAction());
    actions=ArrayUtil.remove(actions,getHelpAction());
  }
  JPanel panel=new JPanel(new BorderLayout());
  final JPanel lrButtonsPanel=new JPanel(new GridBagLayout());
  final Insets insets=SystemInfo.isMacOSLeopard ? new Insets(0,0,0,0) : new Insets(8,0,0,0);
  if (actions.length > 0 || leftSideActions.length > 0) {
    int gridX=0;
    if (leftSideActions.length > 0) {
      JPanel buttonsPanel=createButtons(leftSideActions,buttonMap);
      if (actions.length > 0) {
        buttonsPanel.setBorder(BorderFactory.createEmptyBorder(0,0,0,20));
      }
      lrButtonsPanel.add(buttonsPanel,new GridBagConstraints(gridX++,0,1,1,0,0,GridBagConstraints.CENTER,GridBagConstraints.NONE,insets,0,0));
    }
    lrButtonsPanel.add(Box.createHorizontalGlue(),new GridBagConstraints(gridX++,0,1,1,1,0,GridBagConstraints.CENTER,GridBagConstraints.HORIZONTAL,insets,0,0));
    if (actions.length > 0) {
      if (SystemInfo.isMac) {
        int okNdx=ArrayUtil.indexOf(actions,getOKAction());
        if (okNdx >= 0 && okNdx != actions.length - 1) {
          actions=ArrayUtil.append(ArrayUtil.remove(actions,getOKAction()),getOKAction());
        }
        int cancelNdx=ArrayUtil.indexOf(actions,getCancelAction());
        if (cancelNdx > 0) {
          actions=ArrayUtil.mergeArrays(new Action[]{getCancelAction()},ArrayUtil.remove(actions,getCancelAction()));
        }
      }
      JPanel buttonsPanel=createButtons(actions,buttonMap);
      lrButtonsPanel.add(buttonsPanel,new GridBagConstraints(gridX++,0,1,1,0,0,GridBagConstraints.CENTER,GridBagConstraints.NONE,insets,0,0));
    }
    if (SwingConstants.CENTER == myButtonAlignment) {
      lrButtonsPanel.add(Box.createHorizontalGlue(),new GridBagConstraints(gridX,0,1,1,1,0,GridBagConstraints.CENTER,GridBagConstraints.HORIZONTAL,insets,0,0));
    }
    myButtonMap.clear();
    myButtonMap.putAll(buttonMap);
  }
  if (hasHelpToMoveToLeftSide) {
    JButton helpButton=new JButton(getHelpAction());
    if (!UIUtil.isUnderDarcula()) {
      helpButton.putClientProperty("JButton.buttonType","help");
      helpButton.setText("");
    }
    helpButton.setMargin(insets);
    helpButton.setToolTipText(ActionsBundle.actionDescription("HelpTopics"));
    panel.add(helpButton,BorderLayout.WEST);
  }
  panel.add(lrButtonsPanel,BorderLayout.CENTER);
  final DoNotAskOption askOption=myDoNotAsk;
  if (askOption != null) {
    myCheckBoxDoNotShowDialog=new JCheckBox(askOption.getDoNotShowMessage());
    JComponent southPanel=panel;
    if (!askOption.canBeHidden()) {
      return southPanel;
    }
    final JPanel withCB=addDoNotShowCheckBox(southPanel,myCheckBoxDoNotShowDialog);
    myCheckBoxDoNotShowDialog.setSelected(!askOption.isToBeShown());
    DialogUtil.registerMnemonic(myCheckBoxDoNotShowDialog,'&');
    panel=withCB;
  }
  panel.setBorder(IdeBorderFactory.createEmptyBorder(JBUI.insetsTop(8)));
  return panel;
}
