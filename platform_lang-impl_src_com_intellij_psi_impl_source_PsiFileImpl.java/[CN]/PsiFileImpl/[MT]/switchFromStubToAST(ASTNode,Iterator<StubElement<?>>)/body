{
  final IElementType contentElementType=getContentElementType();
  if (!(contentElementType instanceof IStubFileElementType)) {
    final VirtualFile vFile=getVirtualFile();
    throw new AssertionError("A stub in a non-stub file '" + vFile + "'; isValid()="+ (vFile != null ? vFile.isValid() : "null")+ " type: "+ contentElementType+ "; content:<<<\n"+ StringUtil.first(getViewProvider().getContents(),200,true)+ "\n>>>; stubs="+ ContainerUtil.collect(stubs));
  }
  final StubBuilder builder=((IStubFileElementType)contentElementType).getBuilder();
  ((TreeElement)root).acceptTree(new RecursiveTreeElementWalkingVisitor(){
    @Override protected void visitNode(    TreeElement tree){
      final IElementType type=tree.getElementType();
      final CompositeElement treeParent=tree.getTreeParent();
      if (treeParent != null && builder.skipChildProcessingWhenBuildingStubs(treeParent.getElementType(),type)) {
        return;
      }
      if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(tree)) {
        if (!stubs.hasNext()) {
          rebuildStub();
          LOG.error("Stub list in " + getName() + " has fewer elements than PSI. Last AST element: "+ tree.getElementType()+ " "+ tree);
          stopWalking();
          return;
        }
        final StubElement stub=stubs.next();
        if (stub.getStubType() != tree.getElementType()) {
          rebuildStub();
          LOG.error("Stub and PSI element type mismatch in " + getName() + ": stub "+ stub+ ", AST "+ tree.getElementType()+ "; "+ tree);
          stopWalking();
          return;
        }
        final PsiElement psi=stub.getPsi();
        ((CompositeElement)tree).setPsi(psi);
        final StubBasedPsiElementBase<?> base=(StubBasedPsiElementBase)psi;
        base.setNode(tree);
        base.setStub(null);
      }
      super.visitNode(tree);
    }
  }
);
}
