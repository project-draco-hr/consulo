{
  ((TreeElement)root).acceptTree(new RecursiveTreeElementWalkingVisitor(){
    @Override protected void visitNode(    TreeElement tree){
      final IElementType type=tree.getElementType();
      if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(tree)) {
        if (!stubs.hasNext()) {
          LOG.error("Stub list in" + this + " "+ getName()+ " has fewer elements than PSI. Last AST element: "+ tree.getElementType()+ " "+ tree);
        }
        final StubElement stub=stubs.next();
        if (stub.getStubType() != tree.getElementType()) {
          rebuildStub();
          LOG.error("Stub and PSI element type mismatch in " + getName() + ": stub "+ stub+ ", AST "+ tree.getElementType()+ "; "+ tree);
        }
        final PsiElement psi=stub.getPsi();
        ((CompositeElement)tree).setPsi(psi);
        final StubBasedPsiElementBase<?> base=(StubBasedPsiElementBase)psi;
        base.setNode(tree);
        base.setStub(null);
      }
      super.visitNode(tree);
    }
  }
);
}
