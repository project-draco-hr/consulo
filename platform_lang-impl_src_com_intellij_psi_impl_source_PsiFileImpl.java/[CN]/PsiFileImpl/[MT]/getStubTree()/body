{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  if (Boolean.TRUE.equals(getUserData(BUILDING_STUB)))   return null;
  final StubTree derefd=derefStub();
  if (derefd != null)   return derefd;
  if (getTreeElementNoLock() != null)   return null;
  final VirtualFile vFile=getVirtualFile();
  if (!(vFile instanceof VirtualFileWithId))   return null;
  StubTree stubHolder=StubTree.readOrBuild(getProject(),vFile);
  if (stubHolder == null)   return null;
  final IElementType contentElementType=getContentElementType();
  if (!(contentElementType instanceof IStubFileElementType)) {
    final FileViewProvider viewProvider=getViewProvider();
    throw new AssertionError("A stub in a non-stub file '" + vFile + "'; isValid()="+ vFile.isValid()+ "; IndexStamp="+ IndexingStamp.getIndexStamp(vFile,StubUpdatingIndex.INDEX_ID)+ "; Type: "+ contentElementType+ "; "+ "Psi roots: "+ viewProvider.getAllFiles()+ "; "+ " StubUpdatingIndex.canHaveStub(vFile)="+ StubUpdatingIndex.canHaveStub(vFile)+ " content:<<<\n"+ StringUtil.first(viewProvider.getContents(),200,true)+ "\n>>>; stubs="+ stubHolder.getPlainList());
  }
synchronized (myStubLock) {
    if (getTreeElementNoLock() != null)     return null;
    final StubTree derefdOnLock=derefStub();
    if (derefdOnLock != null)     return derefdOnLock;
    myStub=new SoftReference<StubTree>(stubHolder);
    StubBase<PsiFile> base=(StubBase)stubHolder.getRoot();
    base.setPsi(this);
    base.putUserData(STUB_TREE_IN_PARSED_TREE,stubHolder);
    return stubHolder;
  }
}
