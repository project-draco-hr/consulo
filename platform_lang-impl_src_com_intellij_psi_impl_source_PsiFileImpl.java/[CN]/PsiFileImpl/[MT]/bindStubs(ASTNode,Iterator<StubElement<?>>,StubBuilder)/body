{
  final IElementType type=tree.getElementType();
  if (type instanceof IStubElementType && ((IStubElementType)type).shouldCreateStub(tree)) {
    final StubElement stub=stubs.next();
    if (stub.getStubType() != tree.getElementType()) {
      rebuildStub();
      throw new BindingFailedException("Stub and PSI element type mismatch in " + getName() + ": stub:"+ stub+ ", AST:"+ tree.getElementType());
    }
    ((StubBase)stub).setPsi(tree.getPsi());
  }
  for (  ASTNode node : tree.getChildren(null)) {
    if (!builder.skipChildProcessingWhenBuildingStubs(type,node.getElementType())) {
      bindStubs(node,stubs,builder);
    }
  }
}
