{
  ValueContainerImpl<Value> merged=myMerged;
  if (merged != null) {
    return merged;
  }
synchronized (myInitializer.getLock()) {
    merged=myMerged;
    if (merged != null) {
      return merged;
    }
    final ValueContainerImpl<Value> newMerged=new ValueContainerImpl<Value>();
    final ValueContainer<Value> fromDisk=myInitializer.compute();
    final ContainerAction<Value> addAction=new ContainerAction<Value>(){
      public void perform(      final int id,      final Value value){
        newMerged.addValue(id,value);
      }
    }
;
    final ContainerAction<Value> removeAction=new ContainerAction<Value>(){
      public void perform(      final int id,      final Value value){
        newMerged.removeValue(id,value);
      }
    }
;
    fromDisk.forEach(addAction);
    myInvalidated.forEach(new TIntProcedure(){
      public boolean execute(      int inputId){
        newMerged.removeAllValues(inputId);
        return true;
      }
    }
);
    myRemoved.forEach(removeAction);
    myAdded.forEach(addAction);
    setNeedsCompacting(fromDisk.needsCompacting());
    myMerged=newMerged;
    return newMerged;
  }
}
