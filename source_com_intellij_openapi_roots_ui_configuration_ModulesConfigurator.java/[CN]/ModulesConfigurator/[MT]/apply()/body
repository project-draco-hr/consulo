{
  final ProjectRootManagerImpl projectRootManager=ProjectRootManagerImpl.getInstanceImpl(myProject);
  final ConfigurationException[] ex=new ConfigurationException[1];
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      try {
        final List<ModifiableRootModel> models=new ArrayList<ModifiableRootModel>(myModuleEditors.size());
        for (        final ModuleEditor moduleEditor : myModuleEditors) {
          final ModifiableRootModel model=moduleEditor.applyAndDispose();
          if (model != null) {
            models.add(model);
          }
        }
        myFacetsConfigurator.applyEditors();
        final ModifiableRootModel[] rootModels=models.toArray(new ModifiableRootModel[models.size()]);
        projectRootManager.multiCommit(myModuleModel,rootModels);
        myFacetsConfigurator.commitFacets();
      }
 catch (      ConfigurationException e) {
        ex[0]=e;
      }
 finally {
        myFacetsConfigurator.disposeEditors();
        ModuleStructureConfigurable.getInstance(myProject).getFacetEditorFacade().clearMaps();
        myFacetsConfigurator=createFacetsConfigurator();
        myModuleModel=ModuleManager.getInstance(myProject).getModifiableModel();
      }
      ApplicationManager.getApplication().saveAll();
    }
  }
);
  if (ex[0] != null) {
    throw ex[0];
  }
  ApplicationManager.getApplication().saveAll();
  myModified=false;
}
