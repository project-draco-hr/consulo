{
  ApplicationManager.getApplication().assertIsDispatchThread();
  final Ref<IOException> exc=Ref.create(null);
  final VirtualFile file=new WriteAction<VirtualFile>(){
    protected void run(    final Result<VirtualFile> result){
      VirtualFile dir=directory;
      try {
        if (!dir.getName().equals(MANIFEST_DIR_NAME)) {
          dir=VfsUtil.createDirectoryIfMissing(dir,MANIFEST_DIR_NAME);
        }
        final VirtualFile file=dir.createChildData(this,MANIFEST_FILE_NAME);
        final OutputStream output=file.getOutputStream(this);
        try {
          final Manifest manifest=new Manifest();
          ManifestBuilder.setVersionAttribute(manifest.getMainAttributes());
          manifest.write(output);
        }
  finally {
          output.close();
        }
        result.setResult(file);
      }
 catch (      IOException e) {
        exc.set(e);
      }
    }
  }
.execute().getResultObject();
  final IOException exception=exc.get();
  if (exception != null) {
    LOG.info(exception);
    Messages.showErrorDialog(project,exception.getMessage(),CommonBundle.getErrorTitle());
    return null;
  }
  return file;
}
