{
  final String projectPath=getWorkDir() + File.separator + ".idea";
  final Project project=new Project();
  final Sdk jdk=project.createSdk("JavaSDK","IDEA jdk","1.6",System.getProperty("java.home"),null);
  final List<String> paths=new LinkedList<String>();
  paths.add(FileUtil.toSystemIndependentName(ClasspathBootstrap.getResourcePath(Object.class).getCanonicalPath()));
  jdk.setClasspath(paths);
  IdeaProjectLoader.loadFromPath(project,projectPath,"");
  final File dataStorageRoot=Utils.getDataStorageRoot(project);
  final TestJavaBuilderLogger javaBuilderLogger=new TestJavaBuilderLogger(FileUtil.toSystemIndependentName(getWorkDir() + File.separator));
  final ProjectDescriptor projectDescriptor=new ProjectDescriptor(project,new BuildFSState(true),new ProjectTimestamps(dataStorageRoot),new BuildDataManager(dataStorageRoot,true),new BuildLoggingManager(new ArtifactBuilderLoggerImpl(),javaBuilderLogger));
  try {
    new IncProjectBuilder(projectDescriptor,BuilderRegistry.getInstance(),Collections.<String,String>emptyMap(),CanceledStatus.NULL,null).build(new AllProjectScope(project,Collections.<Artifact>emptySet(),true),false,true,false);
    modify();
    if (SystemInfo.isUnix) {
      Thread.sleep(1000L);
    }
    final IncProjectBuilder makeBuilder=new IncProjectBuilder(projectDescriptor,BuilderRegistry.getInstance(),Collections.<String,String>emptyMap(),CanceledStatus.NULL,null);
class MH implements MessageHandler {
      boolean myErrors=false;
      @Override public void processMessage(      final BuildMessage msg){
        if (msg.getKind() == BuildMessage.Kind.ERROR)         myErrors=true;
      }
    }
    final MH handler=new MH();
    makeBuilder.addMessageHandler(handler);
    makeBuilder.build(new AllProjectScope(project,Collections.<Artifact>emptySet(),false),true,false,false);
    final ByteArrayOutputStream makeDump=new ByteArrayOutputStream();
    if (!handler.myErrors) {
      projectDescriptor.dataManager.getMappings().toStream(new PrintStream(makeDump));
    }
    makeDump.close();
    final String expected=StringUtil.convertLineSeparators(FileUtil.loadFile(new File(getBaseDir() + ".log")));
    final String actual=javaBuilderLogger.myLog.toString();
    assertEquals(expected,actual);
    if (!handler.myErrors) {
      new IncProjectBuilder(projectDescriptor,BuilderRegistry.getInstance(),Collections.<String,String>emptyMap(),CanceledStatus.NULL,null).build(new AllProjectScope(project,Collections.<Artifact>emptySet(),true),false,true,false);
      final ByteArrayOutputStream rebuildDump=new ByteArrayOutputStream();
      projectDescriptor.dataManager.getMappings().toStream(new PrintStream(rebuildDump));
      rebuildDump.close();
      assertEquals(rebuildDump.toString(),makeDump.toString());
    }
  }
  finally {
    projectDescriptor.release();
  }
}
