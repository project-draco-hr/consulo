{
  final String removedSuffix=stage == 0 ? ".remove" : ".remove" + stage;
  final String newSuffix=stage == 0 ? ".new" : ".new" + stage;
  FileUtil.processFilesRecursively(baseDir,new Processor<File>(){
    @Override public boolean process(    File file){
      if (file.getName().endsWith(removedSuffix)) {
        FileUtil.delete(getTargetFile(file,removedSuffix));
      }
      return true;
    }
  }
);
  FileUtil.processFilesRecursively(baseDir,new Processor<File>(){
    @Override public boolean process(    File file){
      try {
        if (file.getName().endsWith(newSuffix)) {
          FileUtil.copyContent(file,getTargetFile(file,newSuffix));
        }
      }
 catch (      IOException e) {
        throw new RuntimeException(e);
      }
      return true;
    }
  }
);
  if (Utils.TIMESTAMP_ACCURACY > 1) {
    try {
      Thread.sleep(Utils.TIMESTAMP_ACCURACY);
    }
 catch (    InterruptedException ignored) {
    }
  }
}
