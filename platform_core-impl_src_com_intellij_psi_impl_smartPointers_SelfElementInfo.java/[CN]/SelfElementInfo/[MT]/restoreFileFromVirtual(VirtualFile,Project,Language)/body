{
  if (virtualFile == null)   return null;
  return ApplicationManager.getApplication().runReadAction(new NullableComputable<PsiFile>(){
    @Override public PsiFile compute(){
      VirtualFile child;
      if (virtualFile.isValid()) {
        child=virtualFile;
      }
 else {
        VirtualFile vParent=virtualFile.getParent();
        if (vParent == null || !vParent.isDirectory())         return null;
        String name=virtualFile.getName();
        child=vParent.findChild(name);
      }
      if (child == null || !child.isValid())       return null;
      PsiFile file=PsiManager.getInstance(project).findFile(child);
      if (file != null && language != null) {
        return file.getViewProvider().getPsi(language);
      }
      return file;
    }
  }
);
}
