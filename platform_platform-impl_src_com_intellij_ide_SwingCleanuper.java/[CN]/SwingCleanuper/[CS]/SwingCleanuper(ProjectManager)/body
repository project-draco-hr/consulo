{
  myAlarm=new Alarm();
  projectManager.addProjectManagerListener(new ProjectManagerAdapter(){
    public void projectOpened(    final Project project){
      myAlarm.cancelAllRequests();
    }
    public void projectClosed(    final Project project){
      myAlarm.cancelAllRequests();
      myAlarm.addRequest(new Runnable(){
        public void run(){
          final IdeFrameImpl frame;
          final Window window=KeyboardFocusManager.getCurrentKeyboardFocusManager().getFocusedWindow();
          if (window instanceof IdeFrameImpl) {
            frame=(IdeFrameImpl)window;
          }
 else {
            frame=(IdeFrameImpl)SwingUtilities.getAncestorOfClass(IdeFrameImpl.class,window);
          }
          if (frame != null) {
            final Application app=ApplicationManager.getApplication();
            if (app != null && app.isActive()) {
              ((JComponent)frame.getStatusBar()).requestFocus();
            }
          }
          SwingUtilities.invokeLater(new Runnable(){
            public void run(){
              resetStaticField(KeyboardFocusManager.class,"newFocusOwner");
              final KeyboardFocusManager focusManager=KeyboardFocusManager.getCurrentKeyboardFocusManager();
              resetField(focusManager,Component.class,"realOppositeComponent");
              resetField(focusManager,Window.class,"realOppositeWindow");
              try {
                final Object helperObject=ReflectionUtil.getField(BasicPopupMenuUI.class,null,Object.class,"menuKeyboardHelper");
                if (null != helperObject) {
                  resetField(helperObject,Component.class,"lastFocused");
                }
              }
 catch (              Exception e) {
              }
              try {
                final Field recognizerField=TransferHandler.class.getDeclaredField("recognizer");
                recognizerField.setAccessible(true);
                final Object recognizerObject=recognizerField.get(null);
                if (recognizerObject != null) {
                  final Method setComponentMethod=DragGestureRecognizer.class.getDeclaredMethod("setComponent",Component.class);
                  setComponentMethod.invoke(recognizerObject,new Object[]{null});
                }
              }
 catch (              Exception e) {
              }
              try {
                fixJTextComponentMemoryLeak();
              }
 catch (              NoSuchFieldException e) {
              }
catch (              Exception e) {
              }
              focusManager.setGlobalCurrentFocusCycleRoot(null);
              try {
                final Method m=KeyboardFocusManager.class.getDeclaredMethod("setGlobalFocusOwner",Component.class);
                m.setAccessible(true);
                m.invoke(focusManager,new Object[]{null});
              }
 catch (              Exception e) {
              }
              resetStaticField(KeyboardFocusManager.class,"newFocusOwner");
              resetStaticField(KeyboardFocusManager.class,"permanentFocusOwner");
              resetStaticField(KeyboardFocusManager.class,"currentFocusCycleRoot");
            }
          }
);
        }
      }
,2500);
    }
  }
);
  Toolkit.getDefaultToolkit().addAWTEventListener(new AWTEventListener(){
    @Override public void eventDispatched(    AWTEvent event){
      if (!SystemInfo.isMac || !Registry.is("ide.mac.fix.accessibleLeak"))       return;
      HierarchyEvent he=(HierarchyEvent)event;
      if ((he.getChangeFlags() & HierarchyEvent.SHOWING_CHANGED) > 0) {
        if (he.getComponent() != null && !he.getComponent().isShowing()) {
          Component c=he.getComponent();
          if (c instanceof JTextComponent) {
            JTextComponent textComponent=(JTextComponent)c;
            CaretListener[] carets=textComponent.getListeners(CaretListener.class);
            for (            CaretListener each : carets) {
              if (isCAccessibleListener(each)) {
                textComponent.removeCaretListener(each);
              }
            }
            Document document=textComponent.getDocument();
            if (document instanceof AbstractDocument) {
              DocumentListener[] documentListeners=((AbstractDocument)document).getDocumentListeners();
              for (              DocumentListener each : documentListeners) {
                if (isCAccessibleListener(each)) {
                  document.removeDocumentListener(each);
                }
              }
            }
          }
 else           if (c instanceof JProgressBar) {
            JProgressBar bar=(JProgressBar)c;
            ChangeListener[] changeListeners=bar.getChangeListeners();
            for (            ChangeListener each : changeListeners) {
              if (isCAccessibleListener(each)) {
                bar.removeChangeListener(each);
              }
            }
          }
 else           if (c instanceof JSlider) {
            JSlider slider=(JSlider)c;
            ChangeListener[] changeListeners=slider.getChangeListeners();
            for (            ChangeListener each : changeListeners) {
              if (isCAccessibleListener(each)) {
                slider.removeChangeListener(each);
              }
            }
          }
          AccessibleContext ac=c.getAccessibleContext();
          if (ac != null) {
            try {
              Field field=ReflectionUtil.findField(ac.getClass(),Object.class,"nativeAXResource");
              field.setAccessible(true);
              Object resource=field.get(ac);
              if (resource != null && resource.getClass().getName().equals("apple.awt.CAccessible")) {
                Field accessible=ReflectionUtil.findField(resource.getClass(),Accessible.class,"accessible");
                accessible.setAccessible(true);
                accessible.set(resource,null);
              }
            }
 catch (            Exception ignored) {
            }
          }
        }
      }
    }
  }
,AWTEvent.HIERARCHY_EVENT_MASK);
}
