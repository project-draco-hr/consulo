{
  int index=ourModalEntities.indexOf(window);
  if (index < 0) {
    Window owner=window.getOwner();
    if (owner == null)     return (ModalityStateEx)ApplicationManager.getApplication().getNoneModalityState();
    ModalityStateEx ownerState=modalityStateForWindow(owner);
    if (window instanceof Dialog && ((Dialog)window).isModal()) {
      return ownerState.appendEnitity(window);
    }
 else {
      return ownerState;
    }
  }
  ArrayList<Window> result=new ArrayList<Window>();
  for (int i=0; i < ourModalEntities.size(); i++) {
    Object entity=ourModalEntities.get(i);
    if (entity instanceof Window) {
      result.add((Window)entity);
    }
  }
  return new ModalityStateEx(result.toArray());
}
