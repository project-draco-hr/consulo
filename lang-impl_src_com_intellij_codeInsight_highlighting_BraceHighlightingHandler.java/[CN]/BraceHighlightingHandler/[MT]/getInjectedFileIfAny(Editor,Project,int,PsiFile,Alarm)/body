{
  Document document=editor.getDocument();
  if (!PsiDocumentManager.getInstance(project).isUncommited(document)) {
    PsiFile injected=InjectedLanguageUtil.findInjectedPsiAt(psiFile,offset);
    if (injected != null) {
      return injected;
    }
  }
 else   if (alarm != null) {
    ourAlarm.cancelAllRequests();
    ourAlarm.addRequest(new Runnable(){
      public void run(){
        if (!project.isDisposed() && !editor.isDisposed()) {
          PsiDocumentManager.getInstance(project).commitAllDocuments();
          BraceHighlighter.updateBraces(editor,alarm);
        }
      }
    }
,300,ModalityState.stateForComponent(editor.getComponent()));
  }
  return psiFile;
}
