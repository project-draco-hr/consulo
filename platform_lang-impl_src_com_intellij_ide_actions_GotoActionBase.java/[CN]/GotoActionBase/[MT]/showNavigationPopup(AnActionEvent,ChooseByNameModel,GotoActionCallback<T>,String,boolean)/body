{
  final Project project=e.getData(PlatformDataKeys.PROJECT);
  boolean mayRequestOpenInCurrentWindow=model.willOpenEditor() && FileEditorManagerEx.getInstanceEx(project).hasSplitOrUndockedWindows();
  final Class startedAction=myInAction;
  LOG.assertTrue(startedAction != null);
  Pair<String,Integer> start=getInitialText(useSelectionFromEditor,e);
  final ChooseByNamePopup popup=ChooseByNamePopup.createPopup(project,model,getPsiContext(e),start.first,mayRequestOpenInCurrentWindow,start.second);
  popup.setCheckBoxShortcut(getShortcutSet());
  popup.setFindUsagesTitle(findUsagesTitle);
  final ChooseByNameFilter<T> filter=callback.createFilter(popup);
  popup.invoke(new ChooseByNamePopupComponent.Callback(){
    @Override public void onClose(){
      ourLastStrings.put(myInAction,Pair.create(popup.getEnteredText(),popup.getSelectedIndex()));
      if (startedAction.equals(myInAction)) {
        myInAction=null;
      }
      if (filter != null) {
        filter.close();
      }
    }
    @Override public void elementChosen(    Object element){
      callback.elementChosen(popup,element);
    }
  }
,ModalityState.current(),true);
}
