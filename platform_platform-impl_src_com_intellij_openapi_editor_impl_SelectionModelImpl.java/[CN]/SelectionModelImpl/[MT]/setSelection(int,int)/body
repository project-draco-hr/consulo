{
  validateContext(true);
  removeBlockSelection();
  Document doc=myEditor.getDocument();
  if (startOffset < 0 || startOffset > doc.getTextLength()) {
    LOG.error("Wrong startOffset: " + startOffset);
  }
  if (endOffset < 0 || endOffset > doc.getTextLength()) {
    LOG.error("Wrong endOffset: " + endOffset);
  }
  myLastSelectionStart=startOffset;
  if (startOffset == endOffset) {
    removeSelection();
    return;
  }
  if (startOffset > endOffset) {
    int tmp=startOffset;
    startOffset=endOffset;
    endOffset=tmp;
  }
  int oldSelectionStart;
  int oldSelectionEnd;
  if (hasSelection()) {
    oldSelectionStart=getSelectionStart();
    oldSelectionEnd=getSelectionEnd();
    if (oldSelectionStart == startOffset && oldSelectionEnd == endOffset)     return;
  }
 else {
    oldSelectionStart=oldSelectionEnd=myEditor.getCaretModel().getOffset();
  }
  MyRangeMarker marker=mySelectionMarker.get();
  if (marker != null) {
    marker.release();
  }
  mySelectionMarker.set(new MyRangeMarker((DocumentEx)doc,startOffset,endOffset));
  fireSelectionChanged(oldSelectionStart,oldSelectionEnd,startOffset,endOffset);
  updateSystemSelection();
}
