{
  validateContext(false);
  int caretOffset=myEditor.getCaretModel().getOffset();
  if (hasSelection()) {
    MyRangeMarker marker=mySelectionMarker.get();
    if (marker != null) {
      int startOffset=marker.getStartOffset();
      int endOffset=marker.getEndOffset();
      if (caretOffset == endOffset) {
        return startOffset;
      }
 else {
        return endOffset;
      }
    }
  }
  return caretOffset;
}
