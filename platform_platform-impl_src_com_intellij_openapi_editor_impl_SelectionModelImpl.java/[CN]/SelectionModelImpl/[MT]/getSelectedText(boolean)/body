{
  validateContext(false);
  if (hasBlockSelection()) {
    CharSequence text=myEditor.getDocument().getCharsSequence();
    int[] starts=getBlockSelectionStarts();
    int[] ends=getBlockSelectionEnds();
    int width=myEditor.getCaretModel().supportsMultipleCarets() ? 0 : Math.abs(myBlockEnd.column - myBlockStart.column);
    final StringBuilder buf=new StringBuilder();
    for (int i=0; i < starts.length; i++) {
      if (i > 0)       buf.append('\n');
      final int len=ends[i] - starts[i];
      appendCharSequence(buf,text,starts[i],len);
      for (int j=len; j < width; j++)       buf.append(' ');
    }
    return buf.toString();
  }
 else   if (myEditor.getCaretModel().supportsMultipleCarets() && allCarets) {
    final StringBuilder buf=new StringBuilder();
    String separator="";
    for (    Caret caret : myEditor.getCaretModel().getAllCarets()) {
      buf.append(separator);
      String caretSelectedText=caret.getSelectedText();
      if (caretSelectedText != null) {
        buf.append(caretSelectedText);
      }
      separator="\n";
    }
    return buf.toString();
  }
 else {
    return myEditor.getCaretModel().getCurrentCaret().getSelectedText();
  }
}
