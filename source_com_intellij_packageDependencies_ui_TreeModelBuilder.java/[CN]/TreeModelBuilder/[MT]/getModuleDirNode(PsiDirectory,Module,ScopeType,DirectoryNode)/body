{
  if (psiDirectory == null) {
    return getModuleNode(module,scopeType);
  }
  PackageDependenciesNode directoryNode=getMap(myModuleDirNodes,scopeType).get(psiDirectory);
  if (directoryNode != null) {
    if (myCompactEmptyMiddlePackages) {
      DirectoryNode nestedNode=((DirectoryNode)directoryNode).getCompactedDirNode();
      if (nestedNode != null) {
        DirectoryNode parentWrapper=nestedNode.getWrapper();
        while (parentWrapper.getWrapper() != null) {
          parentWrapper=parentWrapper.getWrapper();
        }
        for (int i=parentWrapper.getChildCount() - 1; i >= 0; i--) {
          nestedNode.add((MutableTreeNode)parentWrapper.getChildAt(i));
        }
        ((DirectoryNode)directoryNode).setCompactedDirNode(null);
        parentWrapper.add(nestedNode);
        nestedNode.removeUpReference();
        return parentWrapper;
      }
      if (directoryNode.getParent() == null) {
        DirectoryNode parentWrapper=((DirectoryNode)directoryNode).getWrapper();
        if (parentWrapper != null) {
          while (parentWrapper.getWrapper() != null) {
            parentWrapper=parentWrapper.getWrapper();
          }
          return parentWrapper;
        }
      }
    }
    return directoryNode;
  }
  directoryNode=new DirectoryNode(psiDirectory,myCompactEmptyMiddlePackages,myFlattenPackages);
  ((DirectoryNode)directoryNode).setCompactedDirNode(childNode);
  getMap(myModuleDirNodes,scopeType).put(psiDirectory,(DirectoryNode)directoryNode);
  final PsiDirectory directory=psiDirectory.getParentDirectory();
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
  if (!myFlattenPackages && directory != null) {
    if (fileIndex.getModuleForFile(directory.getVirtualFile()) == module) {
      DirectoryNode parentDirectoryNode=getMap(myModuleDirNodes,scopeType).get(directory);
      if (parentDirectoryNode != null || !myCompactEmptyMiddlePackages) {
        getModuleDirNode(directory,module,scopeType,(DirectoryNode)directoryNode).add(directoryNode);
      }
 else {
        directoryNode=getModuleDirNode(directory,module,scopeType,(DirectoryNode)directoryNode);
      }
    }
 else {
      getModuleNode(module,scopeType).add(directoryNode);
    }
  }
 else {
    final VirtualFile virtualFile=psiDirectory.getVirtualFile();
    final VirtualFile contentRoot=fileIndex.getContentRootForFile(virtualFile);
    if (contentRoot == virtualFile) {
      getModuleNode(module,scopeType).add(directoryNode);
    }
 else {
      final VirtualFile sourceRoot=fileIndex.getSourceRootForFile(virtualFile);
      final PsiDirectory root;
      if (sourceRoot != virtualFile && sourceRoot != null) {
        root=myPsiManager.findDirectory(sourceRoot);
      }
 else       if (contentRoot != null) {
        root=myPsiManager.findDirectory(contentRoot);
      }
 else {
        root=null;
      }
      if (root != null) {
        getModuleDirNode(root,module,scopeType,null).add(directoryNode);
      }
    }
  }
  return directoryNode;
}
