{
  if (psiDirectory == null) {
    return getModuleNode(module,scopeType);
  }
  Pair<Module,PsiDirectory> descriptor=new Pair<Module,PsiDirectory>(myShowModules ? module : null,psiDirectory);
  DirectoryNode node=getMap(myModuleDirNodes,scopeType).get(descriptor);
  if (node != null)   return node;
  node=new DirectoryNode(psiDirectory);
  getMap(myModuleDirNodes,scopeType).put(descriptor,node);
  final PsiDirectory directory=psiDirectory.getParentDirectory();
  final VirtualFile contentRoot=ProjectRootManager.getInstance(myProject).getFileIndex().getContentRootForFile(directory.getParentDirectory().getVirtualFile());
  if (contentRoot != null) {
    getModuleDirNode(directory,module,scopeType).add(node);
  }
 else {
    getModuleNode(module,scopeType).add(node);
  }
  return node;
}
