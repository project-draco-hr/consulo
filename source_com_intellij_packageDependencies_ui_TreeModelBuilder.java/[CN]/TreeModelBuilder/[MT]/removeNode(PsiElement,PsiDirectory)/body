{
  Module module=myFileIndex.getModuleForFile(parent.getVirtualFile());
  if (element instanceof PsiDirectory && myFlattenPackages) {
    final PackageDependenciesNode moduleNode=getModuleNode(module,ScopeType.SOURCE);
    final PsiDirectory psiDirectory=(PsiDirectory)element;
    final VirtualFile virtualFile=psiDirectory.getVirtualFile();
    final PackageDependenciesNode dirNode=getModuleDirNode(psiDirectory,myFileIndex.getModuleForFile(virtualFile),getFileScopeType(virtualFile),null);
    dirNode.removeFromParent();
    return moduleNode;
  }
  DefaultMutableTreeNode dirNode=getModuleDirNode(parent,module,ScopeType.SOURCE,null);
  if (dirNode == null)   return null;
  final PackageDependenciesNode[] classOrDirNodes=findNodeForPsiElement((PackageDependenciesNode)dirNode,element);
  if (classOrDirNodes != null) {
    for (    PackageDependenciesNode classNode : classOrDirNodes) {
      classNode.removeFromParent();
    }
  }
  DefaultMutableTreeNode node=dirNode;
  DefaultMutableTreeNode parentNode=(DefaultMutableTreeNode)node.getParent();
  while (node != null && node.getChildCount() == 0) {
    PsiDirectory directory=parent.getParentDirectory();
    parentNode=(DefaultMutableTreeNode)node.getParent();
    node.removeFromParent();
    if (node instanceof DirectoryNode) {
      while (node != null) {
        getMap(myModuleDirNodes,ScopeType.SOURCE).put((PsiDirectory)((DirectoryNode)node).getPsiElement(),null);
        node=((DirectoryNode)node).getCompactedDirNode();
      }
    }
 else     if (parentNode instanceof ModuleNode) {
      getMap(myModuleNodes,ScopeType.SOURCE).put(((ModuleNode)parentNode).getModule(),null);
    }
 else     if (parentNode instanceof ModuleGroupNode) {
      getMap(myModuleGroupNodes,ScopeType.SOURCE).put(((ModuleGroupNode)parentNode).getModuleGroupName(),null);
    }
    node=parentNode;
    parent=directory;
  }
  if (myCompactEmptyMiddlePackages && node instanceof DirectoryNode && node.getChildCount() == 1) {
    final TreeNode treeNode=node.getChildAt(0);
    if (treeNode instanceof DirectoryNode) {
      node.removeAllChildren();
      for (int i=treeNode.getChildCount() - 1; i >= 0; i--) {
        node.add((MutableTreeNode)treeNode.getChildAt(i));
      }
      ((DirectoryNode)node).setCompactedDirNode((DirectoryNode)treeNode);
    }
  }
  return parentNode;
}
