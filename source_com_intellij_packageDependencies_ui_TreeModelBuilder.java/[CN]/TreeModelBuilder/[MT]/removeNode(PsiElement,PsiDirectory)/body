{
  if (element != null && element.isValid()) {
    boolean isMarked=false;
    if (element instanceof PsiFile) {
      isMarked=myMarker.isMarked((PsiFile)element);
    }
 else     if (element instanceof PsiDirectory) {
      final PsiDirectory psiDirectory=(PsiDirectory)element;
      final PsiFile[] psiFiles=psiDirectory.getFiles();
      for (      PsiFile psiFile : psiFiles) {
        isMarked|=myMarker.isMarked(psiFile);
      }
    }
    if (!isMarked)     return null;
  }
  PackageDependenciesNode dirNode=getModuleDirNode(parent,myFileIndex.getModuleForFile(parent.getVirtualFile()),ScopeType.SOURCE,null);
  if (dirNode != null) {
    final PackageDependenciesNode[] classOrDirNodes=findNodeForPsiElement(dirNode,element);
    if (classOrDirNodes != null) {
      for (      PackageDependenciesNode classNode : classOrDirNodes) {
        classNode.removeFromParent();
      }
    }
    if (dirNode.getChildCount() == 0) {
      final TreeNode treeNode=dirNode.getParent();
      dirNode.removeFromParent();
      getMap(myModuleDirNodes,ScopeType.SOURCE).put(parent,null);
      dirNode=(PackageDependenciesNode)treeNode;
    }
    if (myCompactEmptyMiddlePackages && dirNode instanceof DirectoryNode && dirNode.getChildCount() == 1) {
      final TreeNode treeNode=dirNode.getChildAt(0);
      if (treeNode instanceof DirectoryNode) {
        dirNode.removeAllChildren();
        for (int i=treeNode.getChildCount() - 1; i >= 0; i--) {
          dirNode.add((MutableTreeNode)treeNode.getChildAt(i));
        }
        ((DirectoryNode)dirNode).setCompactedDirNode((DirectoryNode)treeNode);
      }
    }
  }
  return dirNode;
}
