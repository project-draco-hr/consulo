{
  boolean isMarked=myMarker != null && myMarker.isMarked(file);
  if (!isMarked)   return null;
  final VirtualFile vFile=file.getVirtualFile();
  LOG.assertTrue(vFile != null);
  PsiDirectory dirToReload=file.getContainingDirectory();
  final ScopeType scopeType=getFileScopeType(vFile);
  PackageDependenciesNode rootToReload=getMap(myModuleDirNodes,scopeType).get(dirToReload);
  if (rootToReload == null && myFlattenPackages) {
    final Module module=myFileIndex.getModuleForFile(vFile);
    final boolean moduleNodeExist=getMap(myModuleNodes,scopeType).get(module) != null;
    rootToReload=getModuleNode(module,scopeType);
    if (!moduleNodeExist) {
      rootToReload=null;
    }
  }
 else {
    while (rootToReload == null && dirToReload != null) {
      dirToReload=dirToReload.getParentDirectory();
      rootToReload=getMap(myModuleDirNodes,scopeType).get(dirToReload);
    }
  }
  PackageDependenciesNode dirNode=getFileParentNode(file);
  dirNode.add(new FileNode(file,isMarked));
  return rootToReload;
}
