{
  Set<VirtualFile> roots=new HashSet<VirtualFile>();
  final Module[] modules=ModuleManager.getInstance(project).getModules();
  for (  Module module : modules) {
    final ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(module);
    roots.addAll(Arrays.asList(moduleRootManager.getFiles(OrderRootType.SOURCES)));
    final OrderEntry[] orderEntries=moduleRootManager.getOrderEntries();
    for (    OrderEntry entry : orderEntries) {
      if (entry instanceof LibraryOrderEntry) {
        final Library library=((LibraryOrderEntry)entry).getLibrary();
        if (library != null) {
          VirtualFile[] files=library.getFiles(OrderRootType.SOURCES);
          if (files == null || files.length == 0) {
            files=library.getFiles(OrderRootType.CLASSES);
          }
          roots.addAll(Arrays.asList(files));
        }
      }
 else       if (entry instanceof JdkOrderEntry) {
        VirtualFile[] files=entry.getFiles(OrderRootType.SOURCES);
        if (files.length == 0) {
          files=entry.getFiles(OrderRootType.CLASSES);
        }
        roots.addAll(Arrays.asList(files));
      }
    }
  }
  return roots.toArray(new VirtualFile[roots.size()]);
}
