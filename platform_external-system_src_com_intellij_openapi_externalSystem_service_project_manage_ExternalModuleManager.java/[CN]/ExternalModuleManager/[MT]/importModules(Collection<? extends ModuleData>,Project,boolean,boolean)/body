{
  if (modules.isEmpty()) {
    return;
  }
  if (!project.isInitialized()) {
    myAlarm.addRequest(new ImportModulesTask(project,modules,recursive,synchronous),PROJECT_INITIALISATION_DELAY_MS);
    return;
  }
  Runnable task=new Runnable(){
    @Override public void run(){
      removeExistingModulesConfigs(modules,project);
      Application application=ApplicationManager.getApplication();
      final Map<ModuleData,Module> moduleMappings=new HashMap<ModuleData,Module>();
      application.runWriteAction(new Runnable(){
        @Override public void run(){
          final ModuleManager moduleManager=ModuleManager.getInstance(project);
          final ProjectEntityChangeListener publisher=project.getMessageBus().syncPublisher(ProjectEntityChangeListener.TOPIC);
          for (          ModuleData module : modules) {
            publisher.onChangeStart(module,module.getOwner());
            try {
              importModule(moduleManager,module);
            }
  finally {
              publisher.onChangeEnd(module,module.getOwner());
            }
          }
        }
        private void importModule(        @NotNull ModuleManager moduleManager,        @NotNull ModuleData module){
          final Module created=moduleManager.newModule(module.getModuleFilePath(),StdModuleTypes.JAVA.getId());
          ModuleRootManager moduleRootManager=ModuleRootManager.getInstance(created);
          final ModifiableRootModel moduleRootModel=moduleRootManager.getModifiableModel();
          moduleRootModel.inheritSdk();
          RootPolicy<Object> visitor=new RootPolicy<Object>(){
            @Override public Object visitLibraryOrderEntry(            LibraryOrderEntry libraryOrderEntry,            Object value){
              moduleRootModel.removeOrderEntry(libraryOrderEntry);
              return value;
            }
            @Override public Object visitModuleOrderEntry(            ModuleOrderEntry moduleOrderEntry,            Object value){
              moduleRootModel.removeOrderEntry(moduleOrderEntry);
              return value;
            }
          }
;
          try {
            for (            OrderEntry orderEntry : moduleRootModel.getOrderEntries()) {
              orderEntry.accept(visitor,null);
            }
          }
  finally {
            moduleRootModel.commit();
          }
          moduleMappings.put(module,created);
        }
      }
);
      if (!recursive) {
        return;
      }
      for (      ModuleData gradleModule : modules) {
        final Module intellijModule=moduleMappings.get(gradleModule);
        myContentRootImporter.importContentRoots(gradleModule.getContentRoots(),intellijModule,synchronous);
        myDependencyImporter.importDependencies(gradleModule.getDependencies(),intellijModule,synchronous);
      }
    }
  }
;
  if (synchronous) {
    UIUtil.invokeAndWaitIfNeeded(task);
  }
 else {
    UIUtil.invokeLaterIfNeeded(task);
  }
}
