{
synchronized (PsiLock.LOCK) {
    FileElement existing=derefTreeElement();
    if (existing != null) {
      return existing;
    }
    if (stub != derefStub()) {
      return null;
    }
    if (stub != null) {
      treeElement.putUserData(STUB_TREE_IN_PARSED_TREE,new SoftReference<StubTree>(stub));
      putUserData(ObjectStubTree.LAST_STUB_TREE_HASH,stub.hashCode());
    }
    switchFromStubToAst(bindings);
    myStub=null;
    myTreeElementPointer=createTreeElementPointer(treeElement);
    myAstLoaded=true;
    if (LOG.isDebugEnabled() && viewProvider.isPhysical()) {
      LOG.debug("Loaded text for file " + viewProvider.getVirtualFile().getPresentableUrl());
    }
    return treeElement;
  }
}
