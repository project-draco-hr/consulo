{
  FileElement treeElement=derefTreeElement();
  if (treeElement != null) {
    return treeElement;
  }
  final FileViewProvider viewProvider=getViewProvider();
  if (viewProvider.isPhysical() && myManager.isAssertOnFileLoading(viewProvider.getVirtualFile())) {
    LOG.error("Access to tree elements not allowed in tests. path='" + viewProvider.getVirtualFile().getPresentableUrl() + "'");
  }
  final Document document=viewProvider.isEventSystemEnabled() ? viewProvider.getDocument() : null;
  treeElement=createFileElement(viewProvider.getContents());
  if (document != null) {
    treeElement.putUserData(HARD_REFERENCE_TO_DOCUMENT,document);
  }
  treeElement.setPsi(this);
  StubTree stub=derefStub();
  if (stub != null) {
    ApplicationManager.getApplication().assertReadAccessAllowed();
    final Iterator<StubElement<?>> stubs=stub.getPlainList().iterator();
    stubs.next();
synchronized (PsiLock.LOCK) {
      switchFromStubToAST(treeElement,stubs);
    }
    myStub=null;
  }
  myTreeElementPointer=createTreeElementPointer(treeElement);
  if (LOG.isDebugEnabled() && getViewProvider().isPhysical()) {
    LOG.debug("Loaded text for file " + getViewProvider().getVirtualFile().getPresentableUrl());
  }
  if (document != null && isPhysical()) {
    TextBlock.get(this).clear();
  }
  return treeElement;
}
