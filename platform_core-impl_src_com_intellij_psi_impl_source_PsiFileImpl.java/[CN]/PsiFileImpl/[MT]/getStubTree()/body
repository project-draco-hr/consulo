{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  if (Boolean.TRUE.equals(getUserData(BUILDING_STUB)))   return null;
  final StubTree derefd=derefStub();
  if (derefd != null)   return derefd;
  if (getTreeElement() != null)   return null;
  if (!(getContentElementType() instanceof IStubFileElementType))   return null;
  final VirtualFile vFile=getVirtualFile();
  if (!(vFile instanceof VirtualFileWithId))   return null;
  final PsiFile stubBindingRoot=getViewProvider().getStubBindingRoot();
  if (stubBindingRoot != this) {
    LOG.error("Attempted to create stubs for non-root file: " + this + ", stub binding root: "+ stubBindingRoot);
    return null;
  }
  ObjectStubTree tree=StubTreeLoader.getInstance().readOrBuild(getProject(),vFile,this);
  if (!(tree instanceof StubTree))   return null;
  StubTree stubHolder=(StubTree)tree;
synchronized (PsiLock.LOCK) {
    if (getTreeElement() != null)     return null;
    final StubTree derefdOnLock=derefStub();
    if (derefdOnLock != null)     return derefdOnLock;
    ((StubBase)stubHolder.getRoot()).setPsi(this);
    myStub=new SoftReference<StubTree>(stubHolder);
    return stubHolder;
  }
}
