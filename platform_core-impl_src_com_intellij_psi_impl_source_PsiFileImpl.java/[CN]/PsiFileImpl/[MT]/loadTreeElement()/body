{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  final FileViewProvider viewProvider=getViewProvider();
  if (viewProvider.isPhysical() && myManager.isAssertOnFileLoading(viewProvider.getVirtualFile())) {
    LOG.error("Access to tree elements not allowed in tests. path='" + viewProvider.getVirtualFile().getPresentableUrl() + "'");
  }
  final Document document=viewProvider.isEventSystemEnabled() ? viewProvider.getDocument() : null;
  FileElement treeElement=createFileElement(viewProvider.getContents());
  if (document != null) {
    treeElement.putUserData(HARD_REFERENCE_TO_DOCUMENT,document);
  }
  treeElement.setPsi(this);
synchronized (PsiLock.LOCK) {
    FileElement existing=derefTreeElement();
    if (existing != null) {
      return existing;
    }
    NonCancelableSection section=ProgressIndicatorProvider.startNonCancelableSectionIfSupported();
    try {
      switchFromStubToAST(treeElement);
      myStub=null;
      myTreeElementPointer=createTreeElementPointer(treeElement);
      if (document != null && isPhysical()) {
        TextBlock.get(this).clear();
      }
      if (LOG.isDebugEnabled() && viewProvider.isPhysical()) {
        LOG.debug("Loaded text for file " + viewProvider.getVirtualFile().getPresentableUrl());
      }
      return treeElement;
    }
  finally {
      section.done();
    }
  }
}
