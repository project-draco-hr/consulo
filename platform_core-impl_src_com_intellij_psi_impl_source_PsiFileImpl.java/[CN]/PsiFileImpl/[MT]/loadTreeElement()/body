{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  final FileViewProvider viewProvider=getViewProvider();
  if (viewProvider.isPhysical() && myManager.isAssertOnFileLoading(viewProvider.getVirtualFile())) {
    LOG.error("Access to tree elements not allowed in tests. path='" + viewProvider.getVirtualFile().getPresentableUrl() + "'");
  }
  Document cachedDocument=FileDocumentManager.getInstance().getCachedDocument(getViewProvider().getVirtualFile());
  FileElement treeElement=createFileElement(viewProvider.getContents());
  treeElement.setPsi(this);
  final StubTree stub=derefStub();
  List<Pair<StubBasedPsiElementBase,CompositeElement>> bindings=calcStubAstBindings(treeElement,cachedDocument,stub);
synchronized (PsiLock.LOCK) {
    FileElement existing=derefTreeElement();
    if (existing != null) {
      return existing;
    }
    if (stub != null) {
      treeElement.putUserData(STUB_TREE_IN_PARSED_TREE,new SoftReference<StubTree>(stub));
    }
    switchFromStubToAst(bindings);
    myStub=null;
    myTreeElementPointer=createTreeElementPointer(treeElement);
    if (LOG.isDebugEnabled() && viewProvider.isPhysical()) {
      LOG.debug("Loaded text for file " + viewProvider.getVirtualFile().getPresentableUrl());
    }
    return treeElement;
  }
}
