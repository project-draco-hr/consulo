{
  final FileElement fileElement=calcTreeElement();
synchronized (PsiLock.LOCK) {
    StubTree tree=fileElement.getUserData(STUB_TREE_IN_PARSED_TREE);
    if (tree == null) {
      IElementType contentElementType=getContentElementType();
      if (!(contentElementType instanceof IStubFileElementType)) {
        VirtualFile vFile=getVirtualFile();
        @NonNls String builder="ContentElementType: " + contentElementType + "; file: "+ this+ "\n\t"+ "Boolean.TRUE.equals(getUserData(BUILDING_STUB)) = "+ Boolean.TRUE.equals(getUserData(BUILDING_STUB))+ "\n\t"+ "getTreeElement() = "+ getTreeElement()+ "\n\t"+ "vFile instanceof VirtualFileWithId = "+ (vFile instanceof VirtualFileWithId)+ "\n\t"+ "StubUpdatingIndex.canHaveStub(vFile) = "+ StubTreeLoader.getInstance().canHaveStub(vFile);
        LOG.error(builder);
      }
      final StubElement currentStubTree=((IStubFileElementType)contentElementType).getBuilder().buildStubTree(this);
      tree=new StubTree((PsiFileStub)currentStubTree);
      bindFakeStubsToTree(tree);
      fileElement.putUserData(STUB_TREE_IN_PARSED_TREE,tree);
    }
    return tree;
  }
}
