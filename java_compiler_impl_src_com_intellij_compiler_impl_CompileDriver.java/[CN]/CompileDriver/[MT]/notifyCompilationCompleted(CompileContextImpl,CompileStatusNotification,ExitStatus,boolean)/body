{
  final long duration=System.currentTimeMillis() - compileContext.getStartCompilationStamp();
  if (refreshOutputRoots) {
    final Set<File> outputs=new HashSet<File>();
    for (    final String path : CompilerPathsEx.getOutputPaths(ModuleManager.getInstance(myProject).getModules())) {
      outputs.add(new File(path));
    }
    if (!outputs.isEmpty()) {
      LocalFileSystem.getInstance().refreshIoFiles(outputs,false,false,null);
    }
  }
  SwingUtilities.invokeLater(new Runnable(){
    public void run(){
      int errorCount=0;
      int warningCount=0;
      try {
        errorCount=compileContext.getMessageCount(CompilerMessageCategory.ERROR);
        warningCount=compileContext.getMessageCount(CompilerMessageCategory.WARNING);
        if (!myProject.isDisposed()) {
          final String statusMessage=createStatusMessage(_status,warningCount,errorCount,duration);
          final MessageType messageType=errorCount > 0 ? MessageType.ERROR : warningCount > 0 ? MessageType.WARNING : MessageType.INFO;
          if (duration > ONE_MINUTE_MS) {
            ToolWindowManager.getInstance(myProject).notifyByBalloon(ToolWindowId.MESSAGES_WINDOW,messageType,statusMessage);
          }
          CompilerManager.NOTIFICATION_GROUP.createNotification(statusMessage,messageType).notify(myProject);
          if (_status != ExitStatus.UP_TO_DATE && compileContext.getMessageCount(null) > 0) {
            compileContext.addMessage(CompilerMessageCategory.INFORMATION,statusMessage,null,-1,-1);
          }
        }
      }
  finally {
        if (callback != null) {
          callback.finished(_status == ExitStatus.CANCELLED,errorCount,warningCount,compileContext);
        }
      }
    }
  }
);
  return duration;
}
