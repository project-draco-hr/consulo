{
  DocumentEventImpl event=(DocumentEventImpl)e;
  if (PersistentRangeMarkerUtil.shouldTranslateViaDiff(event,this)) {
    myStartLine=event.translateLineViaDiffStrict(myStartLine);
    if (myStartLine < 0 || myStartLine >= getDocument().getLineCount()) {
      invalidate();
    }
 else {
      myStart=getDocument().getLineStartOffset(myStartLine) + myStartColumn;
    }
    myEndLine=event.translateLineViaDiffStrict(myEndLine);
    if (myEndLine < 0 || myEndLine >= getDocument().getLineCount()) {
      invalidate();
    }
 else {
      myEnd=getDocument().getLineStartOffset(myEndLine) + myEndColumn;
    }
  }
 else {
    super.changedUpdateImpl(e);
    if (isValid()) {
      storeLinesAndCols();
    }
  }
  if (myEnd < myStart || myEnd > getDocument().getTextLength()) {
    invalidate();
  }
}
