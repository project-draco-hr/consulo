def _format(self, expr, get, map):
    (key, format) = expr.split('%')
    v = get(key)
    if (not hasattr(v, '__iter__')):
        raise SyntaxError((_("error expanding '%s%%%s'") % (key, format)))
    lm = map.copy()
    for i in v:
        if isinstance(i, dict):
            lm.update(i)
            yield self.process(format, lm)
        else:
            yield i
