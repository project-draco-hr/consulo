{
  extend(CompletionType.CLASS_NAME,psiElement(),new CompletionProvider<CompletionParameters>(true,false){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet result){
      PsiElement insertedElement=parameters.getPosition();
      String prefix=result.getPrefixMatcher().getPrefix();
      final PsiFile file=parameters.getOriginalFile();
      final Project project=file.getProject();
      AllClassesGetter getter=new AllClassesGetter(TrueFilter.INSTANCE);
      boolean afterNew=AFTER_NEW.accepts(insertedElement);
      if (AFTER_THROW_NEW.accepts(insertedElement)) {
        getter=new AllClassesGetter(new AssignableFromFilter("java.lang.Throwable"));
      }
 else       if (IN_TYPE_PARAMETER.accepts(insertedElement)) {
        getter=new AllClassesGetter(new ExcludeDeclaredFilter(new ClassFilter(PsiTypeParameter.class)));
      }
 else       if (INSIDE_METHOD_THROWS_CLAUSE.accepts(insertedElement)) {
        getter=new AllClassesGetter(new ThisOrAnyInnerFilter(new AssignableFromFilter("java.lang.Throwable")));
      }
      final StatisticsInfo[] infos=StatisticsManager.getInstance().getAllValues(JavaCompletionStatistician.CLASS_NAME_COMPLETION_PREFIX + StringUtil.capitalsOnly(prefix));
      for (      final StatisticsInfo info : infos) {
        final PsiClass[] classes=ApplicationManager.getApplication().runReadAction(new Computable<PsiClass[]>(){
          public PsiClass[] compute(){
            return JavaPsiFacade.getInstance(project).findClasses(info.getValue(),file.getResolveScope());
          }
        }
);
        for (        final PsiClass psiClass : classes) {
          result.addElement(AllClassesGetter.createLookupItem(psiClass));
        }
      }
      if (afterNew) {
        final PsiExpression expr=PsiTreeUtil.getContextOfType(insertedElement,PsiExpression.class,true);
        if (expr != null) {
          final ExpectedTypeInfo[] expectedInfos=ApplicationManager.getApplication().runReadAction(new Computable<ExpectedTypeInfo[]>(){
            public ExpectedTypeInfo[] compute(){
              return ExpectedTypesProvider.getInstance(project).getExpectedTypes(expr,true);
            }
          }
);
          for (          final ExpectedTypeInfo info : expectedInfos) {
            final PsiType type=info.getType();
            final PsiClass psiClass=ApplicationManager.getApplication().runReadAction(new Computable<PsiClass>(){
              public PsiClass compute(){
                return PsiUtil.resolveClassInType(type);
              }
            }
);
            if (psiClass != null) {
              result.addElement(AllClassesGetter.createLookupItem(psiClass));
            }
            final PsiType defaultType=info.getDefaultType();
            if (!defaultType.equals(type)) {
              final PsiClass defClass=ApplicationManager.getApplication().runReadAction(new Computable<PsiClass>(){
                public PsiClass compute(){
                  return PsiUtil.resolveClassInType(defaultType);
                }
              }
);
              if (defClass != null) {
                result.addElement(AllClassesGetter.createLookupItem(defClass));
              }
            }
          }
        }
      }
      getter.getClasses(insertedElement,result,parameters.getOffset(),parameters.getInvocationCount() == 1);
    }
  }
);
}
