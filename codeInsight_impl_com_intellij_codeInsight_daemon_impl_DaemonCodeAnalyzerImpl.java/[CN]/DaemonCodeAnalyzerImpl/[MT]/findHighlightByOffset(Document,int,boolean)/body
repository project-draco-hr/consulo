{
  HighlightInfo[] highlights=getHighlights(document,myProject);
  if (highlights == null)   return null;
  List<HighlightInfo> foundInfoList=new SmartList<HighlightInfo>();
  for (  HighlightInfo info : highlights) {
    if (info.highlighter == null || !info.highlighter.isValid())     continue;
    int startOffset=info.highlighter.getStartOffset();
    int endOffset=info.highlighter.getEndOffset();
    if (info.isAfterEndOfLine) {
      startOffset+=1;
      endOffset+=1;
    }
    if (startOffset > offset || offset > endOffset) {
      if (!includeFixRange)       continue;
      if (info.fixMarker == null || !info.fixMarker.isValid())       continue;
      startOffset=info.fixMarker.getStartOffset();
      endOffset=info.fixMarker.getEndOffset();
      if (info.isAfterEndOfLine) {
        startOffset+=1;
        endOffset+=1;
      }
      if (startOffset > offset || offset > endOffset)       continue;
    }
    if (!foundInfoList.isEmpty()) {
      HighlightInfo foundInfo=foundInfoList.get(0);
      if (SeverityRegistrar.getInstance(myProject).compare(foundInfo.getSeverity(),info.getSeverity()) < 0) {
        foundInfoList.clear();
      }
 else       if (SeverityRegistrar.getInstance(myProject).compare(info.getSeverity(),foundInfo.getSeverity()) < 0) {
        continue;
      }
    }
    foundInfoList.add(info);
  }
  if (foundInfoList.isEmpty())   return null;
  if (foundInfoList.size() == 1)   return foundInfoList.get(0);
  return new HighlightInfoComposite(foundInfoList);
}
