{
  @SuppressWarnings("deprecation") final String dxJarPath=FileUtil.toSystemDependentName(platform.getTarget().getPath(IAndroidTarget.DX_JAR));
  final File dxJar=new File(dxJarPath);
  if (!dxJar.isFile()) {
    context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,AndroidJpsBundle.message("android.jps.cannot.find.file",dxJarPath)));
    return false;
  }
  final String outFilePath=outputDir + File.separatorChar + AndroidCommonUtils.CLASSES_FILE_NAME;
  final List<String> programParamList=new ArrayList<String>();
  programParamList.add(dxJarPath);
  programParamList.add(outFilePath);
  final JpsAndroidDexCompilerConfiguration configuration=JpsAndroidExtensionService.getInstance().getDexCompilerConfiguration(module.getProject());
  final List<String> vmOptions;
  if (configuration != null) {
    vmOptions=new ArrayList<String>();
    vmOptions.addAll(ParametersListUtil.parse(configuration.getVmOptions()));
    if (!AndroidCommonUtils.hasXmxParam(vmOptions)) {
      vmOptions.add("-Xmx" + configuration.getMaxHeapSize() + "M");
    }
    programParamList.addAll(Arrays.asList("--optimize",Boolean.toString(configuration.isOptimize())));
  }
 else {
    vmOptions=Collections.singletonList("-Xmx1024M");
  }
  programParamList.addAll(Arrays.asList(compileTargets));
  programParamList.add("--exclude");
  final List<String> classPath=new ArrayList<String>();
  classPath.add(ClasspathBootstrap.getResourcePath(AndroidDxRunner.class).getPath());
  classPath.add(ClasspathBootstrap.getResourcePath(FileUtilRt.class).getPath());
  final File outFile=new File(outFilePath);
  if (outFile.exists() && !outFile.delete()) {
    context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.WARNING,AndroidJpsBundle.message("android.jps.cannot.delete.file",outFilePath)));
  }
  final JpsSdk<JpsSimpleElement<JpsAndroidSdkProperties>> sdk=platform.getSdk();
  final String jdkName=sdk.getSdkProperties().getData().getJdkName();
  final JpsLibrary javaSdk=context.getProjectDescriptor().getModel().getGlobal().getLibraryCollection().findLibrary(jdkName);
  if (javaSdk == null || !javaSdk.getType().equals(JpsJavaSdkType.INSTANCE)) {
    context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,AndroidJpsBundle.message("android.jps.errors.java.sdk.not.specified",jdkName)));
    return false;
  }
  final List<String> commandLine=ExternalProcessUtil.buildJavaCommandLine(JpsJavaSdkType.getJavaExecutable((JpsSdk<?>)javaSdk.getProperties()),AndroidDxRunner.class.getName(),Collections.<String>emptyList(),classPath,vmOptions,programParamList,true);
  LOG.info(AndroidCommonUtils.command2string(commandLine));
  final Process process=Runtime.getRuntime().exec(ArrayUtil.toStringArray(commandLine));
  final HashMap<AndroidCompilerMessageKind,List<String>> messages=new HashMap<AndroidCompilerMessageKind,List<String>>(3);
  messages.put(AndroidCompilerMessageKind.ERROR,new ArrayList<String>());
  messages.put(AndroidCompilerMessageKind.WARNING,new ArrayList<String>());
  messages.put(AndroidCompilerMessageKind.INFORMATION,new ArrayList<String>());
  AndroidCommonUtils.handleDexCompilationResult(process,outFilePath,messages);
  AndroidJpsUtil.addMessages(context,messages,BUILDER_NAME,module.getName());
  return messages.get(AndroidCompilerMessageKind.ERROR).size() == 0;
}
