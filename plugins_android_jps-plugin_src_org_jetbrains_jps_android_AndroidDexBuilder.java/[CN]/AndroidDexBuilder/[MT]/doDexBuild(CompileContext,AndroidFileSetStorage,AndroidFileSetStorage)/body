{
  boolean success=true;
  for (  Module module : context.getProject().getModules().values()) {
    final AndroidFacet facet=AndroidJpsUtil.getFacet(module);
    if (facet == null || facet.getLibrary()) {
      continue;
    }
    final Pair<AndroidSdk,IAndroidTarget> pair=AndroidJpsUtil.getAndroidPlatform(module,context,BUILDER_NAME);
    if (pair == null) {
      success=false;
      continue;
    }
    final AndroidSdk androidSdk=pair.getFirst();
    final IAndroidTarget target=pair.getSecond();
    final ProjectPaths projectPaths=context.getProjectPaths();
    final File dexOutputDir=AndroidJpsUtil.getOutputDirectoryForPackagedFiles(projectPaths,module);
    if (dexOutputDir == null) {
      context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.ERROR,AndroidJpsBundle.message("android.jps.errors.output.dir.not.specified",module.getName())));
      success=false;
      continue;
    }
    final File classesDir=projectPaths.getModuleOutputDir(module,false);
    if (classesDir == null || !classesDir.isDirectory()) {
      context.processMessage(new CompilerMessage(BUILDER_NAME,BuildMessage.Kind.INFO,AndroidJpsBundle.message("android.jps.warnings.dex.no.compiled.files",module.getName())));
      continue;
    }
    final Set<String> externalLibraries=AndroidJpsUtil.getExternalLibraries(projectPaths,module);
    final String proguardCfgPath=context.getBuilderParameter(AndroidCommonUtils.PROGUARD_CFG_PATH_OPTION);
    final Set<String> fileSet;
    try {
      if (proguardCfgPath != null) {
        final String outputJarPath=FileUtil.toSystemDependentName(dexOutputDir.getPath() + '/' + AndroidCommonUtils.PROGUARD_OUTPUT_JAR_NAME);
        if (!runProguardIfNecessary(facet,classesDir,androidSdk,target,externalLibraries,context,outputJarPath,proguardCfgPath,proguardStateStorage)) {
          success=false;
          continue;
        }
        fileSet=Collections.singleton(outputJarPath);
      }
 else {
        fileSet=new HashSet<String>();
        AndroidJpsUtil.addSubdirectories(classesDir,fileSet);
        fileSet.addAll(externalLibraries);
        for (        String filePath : AndroidJpsUtil.getClassdirsOfDependentModulesAndPackagesLibraries(projectPaths,module)) {
          if (!classesDir.getPath().equals(filePath)) {
            fileSet.add(filePath);
          }
        }
        if (facet.isPackTestCode()) {
          final File testsClassDir=projectPaths.getModuleOutputDir(module,true);
          if (testsClassDir != null && testsClassDir.isDirectory()) {
            AndroidJpsUtil.addSubdirectories(testsClassDir,fileSet);
          }
        }
      }
      final AndroidFileSetState newState=new AndroidFileSetState(fileSet,AndroidJpsUtil.CLASSES_AND_JARS_FILTER,true);
      if (context.isMake()) {
        final AndroidFileSetState oldState=dexStateStorage.getState(module.getName());
        if (oldState != null && oldState.equalsTo(newState)) {
          continue;
        }
      }
      if (fileSet.size() == 0) {
        continue;
      }
      final String[] files=new String[fileSet.size()];
      int i=0;
      for (      String filePath : fileSet) {
        files[i++]=FileUtil.toSystemDependentName(filePath);
      }
      context.processMessage(new ProgressMessage(AndroidJpsBundle.message("android.jps.progress.dex",module.getName())));
      if (!runDex(androidSdk,target,dexOutputDir.getPath(),files,context)) {
        success=false;
        dexStateStorage.update(module.getName(),null);
      }
 else {
        dexStateStorage.update(module.getName(),newState);
      }
    }
 catch (    IOException e) {
      AndroidJpsUtil.reportExceptionError(context,null,e,BUILDER_NAME);
      return false;
    }
  }
  return success;
}
