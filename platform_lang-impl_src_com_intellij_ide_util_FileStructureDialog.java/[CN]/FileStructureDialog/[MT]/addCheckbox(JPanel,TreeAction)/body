{
  String text=action instanceof FileStructureFilter ? ((FileStructureFilter)action).getCheckBoxText() : action instanceof FileStructureNodeProvider ? ((FileStructureNodeProvider)action).getCheckBoxText() : null;
  if (text == null)   return;
  Shortcut[] shortcuts=action instanceof FileStructureFilter ? ((FileStructureFilter)action).getShortcut() : ((FileStructureNodeProvider)action).getShortcut();
  final JCheckBox chkFilter=new JCheckBox();
  chkFilter.addActionListener(new ActionListener(){
    @Override public void actionPerformed(    final ActionEvent e){
      ProjectListBuilder builder=(ProjectListBuilder)myCommanderPanel.getBuilder();
      PsiElement currentParent=null;
      if (builder != null) {
        final AbstractTreeNode parentNode=builder.getParentNode();
        final Object value=parentNode.getValue();
        if (value instanceof StructureViewTreeElement) {
          final Object elementValue=((StructureViewTreeElement)value).getValue();
          if (elementValue instanceof PsiElement) {
            currentParent=(PsiElement)elementValue;
          }
        }
      }
      final boolean state=chkFilter.isSelected();
      myTreeActionsOwner.setActionIncluded(action,action instanceof FileStructureFilter ? !state : state);
      myTreeStructure.rebuildTree();
      if (builder != null) {
        if (currentParent != null) {
          boolean oldNarrowDown=myShouldNarrowDown;
          myShouldNarrowDown=false;
          try {
            builder.enterElement(currentParent,PsiUtilBase.getVirtualFile(currentParent));
          }
  finally {
            myShouldNarrowDown=oldNarrowDown;
          }
        }
        builder.updateList(true);
      }
      if (SpeedSearchBase.hasActiveSpeedSearch(myCommanderPanel.getList())) {
        final SpeedSearchSupply supply=SpeedSearchBase.getSupply(myCommanderPanel.getList());
        if (supply != null && supply.isPopupActive())         supply.refreshSelection();
      }
    }
  }
);
  chkFilter.setFocusable(false);
  if (shortcuts.length > 0) {
    text+=" (" + KeymapUtil.getShortcutText(shortcuts[0]) + ")";
    new AnAction(){
      @Override public void actionPerformed(      final AnActionEvent e){
        chkFilter.doClick();
      }
    }
.registerCustomShortcutSet(new CustomShortcutSet(shortcuts),myCommanderPanel);
  }
  chkFilter.setText(text);
  panel.add(chkFilter);
}
