{
  if (!CodeInsightUtil.prepareFileForWrite(file))   return;
  ASTNode treeElement=SourceTreeToPsiMap.psiElementToTree(myTag);
  PsiElement anchor=SourceTreeToPsiMap.treeElementToPsi(XmlChildRole.EMPTY_TAG_END_FINDER.findChild(treeElement));
  if (anchor == null) {
    anchor=SourceTreeToPsiMap.treeElementToPsi(XmlChildRole.START_TAG_END_FINDER.findChild(treeElement));
  }
  if (anchor == null)   return;
  final Template template=TemplateManager.getInstance(project).createTemplate("","");
  template.addTextSegment(" " + myAttrName + "=\"");
  Expression expression=new Expression(){
    TextResult result=new TextResult("");
    public Result calculateResult(    ExpressionContext context){
      return result;
    }
    public Result calculateQuickResult(    ExpressionContext context){
      return null;
    }
    public LookupItem[] calculateLookupItems(    ExpressionContext context){
      final LookupItem items[]=new LookupItem[(myValues != null) ? myValues.length : 0];
      if (myValues != null) {
        for (int i=0; i < items.length; i++) {
          items[i]=LookupItemUtil.objectToLookupItem(myValues[i]);
        }
      }
      return items;
    }
  }
;
  template.addVariable("name",expression,expression,true);
  template.addTextSegment("\"");
  final PsiElement anchor1=anchor;
  final Runnable runnable=new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          int textOffset=anchor1.getTextOffset();
          editor.getCaretModel().moveToOffset(textOffset);
          TemplateManager.getInstance(project).startTemplate(editor,template,null);
        }
      }
);
    }
  }
;
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    Runnable commandRunnable=new Runnable(){
      public void run(){
        CommandProcessor.getInstance().executeCommand(project,runnable,getText(),getFamilyName());
      }
    }
;
    ApplicationManager.getApplication().invokeLater(commandRunnable);
  }
 else {
    runnable.run();
  }
}
