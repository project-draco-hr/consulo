{
  boolean isInCaretRow=myEditor.getCaretModel().getLogicalPosition().line >= myDocument.getLineCount() - 1;
  Color caret=isInCaretRow && myCaretRowAttributes != null ? myCaretRowAttributes.getBackgroundColor() : null;
  if (myCurrentHighlighters.size() > 1) {
    Collections.sort(myCurrentHighlighters,new Comparator(){
      public int compare(      Object o1,      Object o2){
        RangeHighlighter h1=(RangeHighlighter)o1;
        RangeHighlighter h2=(RangeHighlighter)o2;
        return h2.getLayer() - h1.getLayer();
      }
    }
);
  }
  for (int i=0; i < myCurrentHighlighters.size(); i++) {
    RangeHighlighterImpl highlighter=myCurrentHighlighters.get(i);
    if (caret != null && highlighter.getLayer() < HighlighterLayer.CARET_ROW) {
      return caret;
    }
    if (highlighter.getTargetArea() != HighlighterTargetArea.LINES_IN_RANGE || myDocument.getLineNumber(highlighter.getEndOffset()) < myDocument.getLineCount() - 1)     continue;
    TextAttributes textAttributes=highlighter.getTextAttributes();
    if (textAttributes != null) {
      Color backgroundColor=textAttributes.getBackgroundColor();
      if (backgroundColor != null)       return backgroundColor;
    }
  }
  return caret;
}
