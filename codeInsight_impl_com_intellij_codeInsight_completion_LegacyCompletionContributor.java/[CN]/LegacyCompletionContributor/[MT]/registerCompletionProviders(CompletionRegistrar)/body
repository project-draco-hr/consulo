{
  final PsiElementPattern._PsiElementPattern<PsiElement> everywhere=StandardPatterns.psiElement();
  registrar.extendBasicCompletion(everywhere).onPriority(Double.POSITIVE_INFINITY).withProvider(new CompletionProvider<LookupElement,CompletionParameters>(){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final MatchingContext matchingContext,    @NotNull final QueryResultSet<LookupElement> result){
      CompletionContext context=parameters.getPosition().getUserData(CompletionContext.COMPLETION_CONTEXT_KEY);
      final PsiFile file=context.file;
      final PsiElement lastElement=file.findElementAt(context.startOffset - 1);
      PsiElement insertedElement=parameters.getPosition();
      CompletionData completionData=CompletionUtil.getCompletionDataByElement(lastElement,context);
      context.setPrefix(insertedElement,context.startOffset,completionData);
      if (completionData == null) {
        completionData=CompletionUtil.getCompletionDataByElement(lastElement,context);
      }
      if (completionData == null)       return;
      if (insertedElement == null)       return;
      final Set<LookupItem> lookupSet=new LinkedHashSet<LookupItem>();
      final PsiReference ref=insertedElement.getContainingFile().findReferenceAt(context.offset);
      if (ref != null) {
        completionData.completeReference(ref,lookupSet,context,insertedElement);
      }
      if (lookupSet.isEmpty() || !CodeInsightUtil.isAntFile(file)) {
        final Set<CompletionVariant> keywordVariants=new HashSet<CompletionVariant>();
        completionData.addKeywordVariants(keywordVariants,context,insertedElement);
        CompletionData.completeKeywordsBySet(lookupSet,keywordVariants,context,insertedElement);
        CompletionUtil.highlightMembersOfContainer(lookupSet);
      }
      result.addAllElements(lookupSet);
    }
  }
);
}
