{
  if (unsigned) {
    return filterUsingKeystoreMessages(finalPackage(project,dexPath,sourceRoots,externalJars,nativeLibsFolders,finalApk,resPackagePath,customKeystorePath,false));
  }
  final Map<CompilerMessageCategory,List<String>> map=new HashMap<CompilerMessageCategory,List<String>>();
  final String zipAlignPath=sdkPath + File.separator + AndroidUtils.toolPath(SdkConstants.FN_ZIPALIGN);
  boolean withAlignment=new File(zipAlignPath).exists();
  String unalignedApk=finalApk + UNALIGNED_SUFFIX;
  Map<CompilerMessageCategory,List<String>> map2=filterUsingKeystoreMessages(finalPackage(project,dexPath,sourceRoots,externalJars,nativeLibsFolders,withAlignment ? unalignedApk : finalApk,resPackagePath,customKeystorePath,true));
  map.putAll(map2);
  if (withAlignment && map.get(ERROR).size() == 0) {
    map2=AndroidCompileUtil.execute(zipAlignPath,"-f","4",unalignedApk,finalApk);
    map.putAll(map2);
  }
  return map;
}
