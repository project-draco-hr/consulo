{
  String unsignedApk=finalApk + UNSIGNED_SUFFIX;
  Map<CompilerMessageCategory,List<String>> map;
  if (generateUnsignedApk) {
    map=filterUsingKeystoreMessages(finalPackage(resPackagePath,dexPath,sourceRoots,externalJars,nativeLibsFolders,unsignedApk,false));
  }
 else {
    map=new HashMap<CompilerMessageCategory,List<String>>();
  }
  final String zipAlignPath=sdkPath + File.separator + AndroidUtils.toolPath(SdkConstants.FN_ZIPALIGN);
  boolean withAlignment=new File(zipAlignPath).exists();
  String unalignedApk=finalApk + UNALIGNED_SUFFIX;
  Map<CompilerMessageCategory,List<String>> map2=filterUsingKeystoreMessages(finalPackage(resPackagePath,dexPath,sourceRoots,externalJars,nativeLibsFolders,withAlignment ? unalignedApk : finalApk,true));
  map.putAll(map2);
  if (withAlignment && map.get(ERROR).size() == 0) {
    map2=ExecutionUtil.execute(zipAlignPath,"-f","4",unalignedApk,finalApk);
    map.putAll(map2);
  }
  return map;
}
