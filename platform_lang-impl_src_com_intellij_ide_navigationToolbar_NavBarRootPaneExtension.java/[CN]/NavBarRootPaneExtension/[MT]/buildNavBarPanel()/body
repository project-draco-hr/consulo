{
  final Ref<JPanel> panel=new Ref<JPanel>(null);
  final Runnable updater=new Runnable(){
    String laf;
    @Override public void run(){
      if (LafManager.getInstance().getCurrentLookAndFeel().getName().equals(laf))       return;
      laf=LafManager.getInstance().getCurrentLookAndFeel().getName();
      panel.get().removeAll();
      myScrollPane=null;
      myCloseIcon=null;
      if (myNavigationBar != null && !Disposer.isDisposed(myNavigationBar)) {
        Disposer.dispose(myNavigationBar);
      }
      myNavigationBar=new NavBarPanel(myProject);
      myWrapperPanel.putClientProperty("NavBarPanel",myNavigationBar);
      myNavigationBar.getModel().setFixedComponent(true);
      myScrollPane=ScrollPaneFactory.createScrollPane(myNavigationBar);
      myScrollPane.setVerticalScrollBarPolicy(ScrollPaneConstants.VERTICAL_SCROLLBAR_NEVER);
      myScrollPane.setHorizontalScrollBar(null);
      myScrollPane.setBorder(null);
      myScrollPane.setOpaque(false);
      myScrollPane.getViewport().setOpaque(false);
      panel.get().setOpaque(!UIUtil.isUnderAquaLookAndFeel() || UISettings.getInstance().SHOW_MAIN_TOOLBAR);
      panel.get().setBorder(new NavBarBorder(true,0));
      myNavigationBar.setBorder(null);
      panel.get().add(myScrollPane,BorderLayout.CENTER);
    }
  }
;
  panel.set(new JPanel(new BorderLayout()){
    @Override public void updateUI(){
      super.updateUI();
      if (UISettings.getInstance().SHOW_NAVIGATION_BAR) {
        SwingUtilities.invokeLater(updater);
      }
    }
    @Override protected void paintComponent(    Graphics g){
      super.paintComponent(g);
      final Rectangle r=getBounds();
      final Graphics2D g2d=(Graphics2D)g;
      if (!isMainToolbarVisible() && UIUtil.isUnderAquaLookAndFeel()) {
        final Dimension d=getPreferredSize();
        final int topOffset=UIUtil.isUnderAquaLookAndFeel() ? (r.height - d.height) / 2 + 2 : 0;
        UIUtil.drawDoubleSpaceDottedLine(g2d,topOffset,topOffset + d.height - 1,r.width - 1,Color.GRAY,false);
      }
 else {
        final boolean undocked=isUndocked();
        final Color startColor=UIUtil.isUnderAquaLookAndFeel() ? new Color(240,240,240) : UIUtil.getControlColor();
        final Color endColor=ColorUtil.shift(startColor,7.0d / 8.0d);
        g2d.setPaint(new GradientPaint(0,0,startColor,0,r.height,endColor));
        g.fillRect(0,0,r.width,r.height);
        if (!undocked) {
          g.setColor(new Color(255,255,255,220));
          g.drawLine(0,1,r.width,1);
        }
        g.setColor(UIUtil.getBorderColor());
        if (!undocked)         g.drawLine(0,0,r.width,0);
        g.drawLine(0,r.height - 1,r.width,r.height - 1);
        if (!isMainToolbarVisible()) {
          UIUtil.drawDottedLine(g2d,r.width - 1,0,r.width - 1,r.height,null,Color.GRAY);
        }
      }
    }
    @Override public void doLayout(){
      final Rectangle r=getBounds();
      final Insets insets=getInsets();
      int x=insets.left;
      if (myScrollPane == null)       return;
      final Component navBar=myScrollPane;
      final Component closeLabel=myCloseIcon;
      final Dimension preferredSize=navBar.getPreferredSize();
      final Dimension closePreferredSize=closeLabel == null ? new Dimension() : closeLabel.getPreferredSize();
      navBar.setBounds(x,insets.top + ((r.height - preferredSize.height - insets.top- insets.bottom) / 2),r.width - insets.left - insets.right- closePreferredSize.width,preferredSize.height);
      if (closeLabel != null) {
        closeLabel.setBounds(x + r.width - insets.left - insets.right - closePreferredSize.width,insets.top + ((r.height - closePreferredSize.height - insets.top- insets.bottom) / 2),closePreferredSize.width,closePreferredSize.height);
      }
    }
  }
);
  updater.run();
  final JPanel main=new JPanel(new BorderLayout());
  main.setOpaque(false);
  main.add(panel.get(),BorderLayout.NORTH);
  return main;
}
