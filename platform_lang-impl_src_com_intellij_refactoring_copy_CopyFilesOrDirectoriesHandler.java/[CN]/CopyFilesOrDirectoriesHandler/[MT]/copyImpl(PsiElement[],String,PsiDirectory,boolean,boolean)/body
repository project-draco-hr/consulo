{
  if (doClone && elements.length != 1) {
    throw new IllegalArgumentException("invalid number of elements to clone:" + elements.length);
  }
  if (newName != null && elements.length != 1) {
    throw new IllegalArgumentException("no new name should be set; number of elements is: " + elements.length);
  }
  final Project project=targetDirectory.getProject();
  Runnable command=new Runnable(){
    @Override public void run(){
      final Runnable action=new Runnable(){
        @Override public void run(){
          try {
            PsiFile firstFile=null;
            final int[] choice=elements.length > 1 || elements[0] instanceof PsiDirectory ? new int[]{-1} : null;
            for (            PsiElement element : elements) {
              PsiFile f=copyToDirectory((PsiFileSystemItem)element,newName,targetDirectory,choice);
              if (firstFile == null) {
                firstFile=f;
              }
            }
            if (firstFile != null) {
              CopyHandler.updateSelectionInActiveProjectView(firstFile,project,doClone);
              if (!(firstFile instanceof PsiBinaryFile) && openInEditor) {
                EditorHelper.openInEditor(firstFile);
                ApplicationManager.getApplication().invokeLater(new Runnable(){
                  @Override public void run(){
                    ToolWindowManager.getInstance(project).activateEditorComponent();
                  }
                }
);
              }
            }
          }
 catch (          final IncorrectOperationException ex) {
            ApplicationManager.getApplication().invokeLater(new Runnable(){
              @Override public void run(){
                Messages.showErrorDialog(project,ex.getMessage(),RefactoringBundle.message("error.title"));
              }
            }
);
          }
catch (          final IOException ex) {
            ApplicationManager.getApplication().invokeLater(new Runnable(){
              @Override public void run(){
                Messages.showErrorDialog(project,ex.getMessage(),RefactoringBundle.message("error.title"));
              }
            }
);
          }
        }
      }
;
      ApplicationManager.getApplication().runWriteAction(action);
    }
  }
;
  String title=RefactoringBundle.message(doClone ? "copy,handler.clone.files.directories" : "copy.handler.copy.files.directories");
  CommandProcessor.getInstance().executeCommand(project,command,title,null);
}
