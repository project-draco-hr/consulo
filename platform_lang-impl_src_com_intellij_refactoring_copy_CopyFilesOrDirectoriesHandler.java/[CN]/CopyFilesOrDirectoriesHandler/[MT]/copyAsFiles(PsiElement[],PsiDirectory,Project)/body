{
  PsiDirectory targetDirectory=null;
  String newName=null;
  if (ApplicationManager.getApplication().isUnitTestMode()) {
    targetDirectory=defaultTargetDirectory;
  }
 else {
    CopyFilesOrDirectoriesDialog dialog=new CopyFilesOrDirectoriesDialog(elements,defaultTargetDirectory,project,false);
    dialog.show();
    if (dialog.isOK()) {
      newName=elements.length == 1 ? dialog.getNewName() : null;
      targetDirectory=dialog.getTargetDirectory();
    }
  }
  if (targetDirectory != null) {
    try {
      for (      PsiElement element : elements) {
        PsiFileSystemItem psiElement=(PsiFileSystemItem)element;
        if (psiElement.isDirectory()) {
          MoveFilesOrDirectoriesUtil.checkIfMoveIntoSelf(psiElement,targetDirectory);
        }
      }
    }
 catch (    IncorrectOperationException e) {
      CommonRefactoringUtil.showErrorHint(project,null,e.getMessage(),CommonBundle.getErrorTitle(),null);
      return;
    }
    copyImpl(elements,newName,targetDirectory,false);
  }
}
