{
  if (defaultTargetDirectory == null) {
    defaultTargetDirectory=getCommonParentDirectory(elements);
  }
  Project project=elements[0].getProject();
  CopyFilesOrDirectoriesDialog dialog=new CopyFilesOrDirectoriesDialog(elements,defaultTargetDirectory,project,false);
  dialog.show();
  if (dialog.isOK()) {
    String newName=elements.length == 1 ? dialog.getNewName() : null;
    final PsiManager psiManager=PsiManager.getInstance(project);
    try {
      for (      PsiElement element : elements) {
        final PsiFileSystemItem psiElement=(PsiFileSystemItem)element.copy();
        if (newName != null) {
          psiElement.setName(newName);
        }
        psiManager.checkMove(psiElement,dialog.getTargetDirectory());
      }
    }
 catch (    IncorrectOperationException e) {
      CommonRefactoringUtil.showErrorHint(project,null,e.getMessage(),CommonBundle.getErrorTitle(),null);
      return;
    }
    copyImpl(elements,newName,dialog.getTargetDirectory(),false);
  }
}
