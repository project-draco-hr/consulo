{
  if (defaultTargetDirectory == null) {
    defaultTargetDirectory=getCommonParentDirectory(elements);
  }
  Project project=defaultTargetDirectory != null ? defaultTargetDirectory.getProject() : elements[0].getProject();
  final Boolean showDirsChooser=defaultTargetDirectory.getCopyableUserData(CopyPasteDelegator.SHOW_CHOOSER_KEY);
  if (showDirsChooser != null && showDirsChooser.booleanValue()) {
    final PsiDirectoryContainer directoryContainer=PsiDirectoryFactory.getInstance(project).getDirectoryContainer(defaultTargetDirectory);
    defaultTargetDirectory=MoveFilesOrDirectoriesUtil.resolveToDirectory(project,directoryContainer);
    if (defaultTargetDirectory == null)     return;
  }
  CopyFilesOrDirectoriesDialog dialog=new CopyFilesOrDirectoriesDialog(elements,defaultTargetDirectory,project,false);
  dialog.show();
  if (dialog.isOK()) {
    final String newName=elements.length == 1 ? dialog.getNewName() : null;
    final PsiDirectory targetDirectory=dialog.getTargetDirectory();
    try {
      for (      PsiElement element : elements) {
        PsiFileSystemItem psiElement=(PsiFileSystemItem)element;
        if (psiElement.isDirectory()) {
          MoveFilesOrDirectoriesUtil.checkIfMoveIntoSelf(psiElement,targetDirectory);
        }
      }
    }
 catch (    IncorrectOperationException e) {
      CommonRefactoringUtil.showErrorHint(project,null,e.getMessage(),CommonBundle.getErrorTitle(),null);
      return;
    }
    copyImpl(elements,newName,targetDirectory,false);
  }
}
