{
  ArrayList<PsiFile> result=new ArrayList<PsiFile>();
  PsiManager psiManager=PsiManager.getInstance(project);
  VirtualFile projectFileDir=null;
  final StorageScheme storageScheme=((ProjectEx)project).getStateStore().getStorageScheme();
  if (StorageScheme.DIRECTORY_BASED.equals(storageScheme)) {
    VirtualFile baseDir=project.getBaseDir();
    if (baseDir != null) {
      projectFileDir=baseDir.findChild(Project.DIRECTORY_STORE_FOLDER);
    }
  }
  for (  VirtualFile file : selectedFiles) {
    if (file.isValid()) {
      if (isUnderProjectFileDir(projectFileDir,file) || !isFileUnderSourceRoot(project,file)) {
        continue;
      }
      PsiFile psiFile=psiManager.findFile(file);
      if (psiFile != null)       result.add(psiFile);
    }
  }
  return PsiUtilCore.toPsiFileArray(result);
}
