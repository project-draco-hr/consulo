{
  ChangeContextUtil.encodeContextInfo(myMethod,true);
  try {
    final PsiManager manager=myMethod.getManager();
    final PsiElementFactory factory=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory();
    final PsiCodeBlock body=myMethod.getBody();
    if (body != null) {
      final Map<PsiElement,PsiElement> replaceMap=new HashMap<PsiElement,PsiElement>();
      body.accept(new JavaRecursiveElementVisitor(){
        @Override public void visitThisExpression(        PsiThisExpression expression){
          final PsiClass classReferencedByThis=MoveInstanceMembersUtil.getClassReferencedByThis(expression);
          if (classReferencedByThis != null && !PsiTreeUtil.isAncestor(myMethod,classReferencedByThis,false)) {
            final PsiElementFactory factory=JavaPsiFacade.getInstance(myProject).getElementFactory();
            String paramName=getParameterNameToCreate(classReferencedByThis);
            try {
              final PsiExpression refExpression=factory.createExpressionFromText(paramName,null);
              replaceMap.put(expression,refExpression);
            }
 catch (            IncorrectOperationException e) {
              LOG.error(e);
            }
          }
        }
        @Override public void visitReferenceExpression(        PsiReferenceExpression expression){
          try {
            final PsiExpression qualifier=expression.getQualifierExpression();
            final PsiElement resolved=expression.resolve();
            if (qualifier instanceof PsiReferenceExpression && ((PsiReferenceExpression)qualifier).isReferenceTo(myTargetVariable)) {
              if (resolved instanceof PsiField) {
                for (                PsiParameter parameter : myMethod.getParameterList().getParameters()) {
                  if (Comparing.strEqual(parameter.getName(),((PsiField)resolved).getName())) {
                    qualifier.replace(factory.createExpressionFromText("this",null));
                    return;
                  }
                }
              }
              qualifier.delete();
              return;
            }
            if (myTargetVariable.equals(resolved)) {
              PsiThisExpression thisExpression=(PsiThisExpression)factory.createExpressionFromText("this",null);
              replaceMap.put(expression,thisExpression);
              return;
            }
 else             if (myMethod.equals(resolved)) {
            }
 else {
              PsiClass classReferencedByThis=MoveInstanceMembersUtil.getClassReferencedByThis(expression);
              if (classReferencedByThis != null) {
                final String paramName=getParameterNameToCreate(classReferencedByThis);
                if (paramName != null) {
                  PsiReferenceExpression newQualifier=(PsiReferenceExpression)factory.createExpressionFromText(paramName,null);
                  expression.setQualifierExpression(newQualifier);
                  return;
                }
              }
            }
            super.visitReferenceExpression(expression);
          }
 catch (          IncorrectOperationException e) {
            LOG.error(e);
          }
        }
        @Override public void visitNewExpression(        PsiNewExpression expression){
          try {
            final PsiExpression qualifier=expression.getQualifier();
            if (qualifier instanceof PsiReferenceExpression && ((PsiReferenceExpression)qualifier).isReferenceTo(myTargetVariable)) {
              qualifier.delete();
            }
 else {
              final PsiClass classReferencedByThis=MoveInstanceMembersUtil.getClassReferencedByThis(expression);
              if (classReferencedByThis != null) {
                if (qualifier != null)                 qualifier.delete();
                final String paramName=getParameterNameToCreate(classReferencedByThis);
                final PsiExpression newExpression=factory.createExpressionFromText(paramName + "." + expression.getText(),null);
                replaceMap.put(expression,newExpression);
              }
            }
            super.visitNewExpression(expression);
          }
 catch (          IncorrectOperationException e) {
            LOG.error(e);
          }
        }
        @Override public void visitMethodCallExpression(        PsiMethodCallExpression expression){
          correctMethodCall(expression,true);
          super.visitMethodCallExpression(expression);
        }
      }
);
      for (      PsiElement element : replaceMap.keySet()) {
        final PsiElement replacement=replaceMap.get(element);
        element.replace(replacement);
      }
    }
    final PsiMethod methodCopy=getPatternMethod();
    final List<PsiParameter> newParameters=Arrays.asList(methodCopy.getParameterList().getParameters());
    RefactoringUtil.fixJavadocsForParams(methodCopy,new HashSet<PsiParameter>(newParameters));
    return methodCopy;
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
    return myMethod;
  }
}
