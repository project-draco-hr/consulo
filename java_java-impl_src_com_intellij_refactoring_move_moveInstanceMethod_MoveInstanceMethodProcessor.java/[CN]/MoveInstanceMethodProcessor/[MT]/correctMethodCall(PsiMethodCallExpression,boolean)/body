{
  try {
    final PsiManager manager=myMethod.getManager();
    PsiReferenceExpression methodExpression=expression.getMethodExpression();
    if (!methodExpression.isReferenceTo(myMethod))     return;
    final PsiExpression oldQualifier=methodExpression.getQualifierExpression();
    PsiExpression newQualifier=null;
    final PsiClass classReferencedByThis=MoveInstanceMembersUtil.getClassReferencedByThis(methodExpression);
    if (myTargetVariable instanceof PsiParameter) {
      final int index=myMethod.getParameterList().getParameterIndex((PsiParameter)myTargetVariable);
      final PsiExpression[] arguments=expression.getArgumentList().getExpressions();
      if (index < arguments.length) {
        newQualifier=(PsiExpression)arguments[index].copy();
        arguments[index].delete();
      }
    }
 else {
      VisibilityUtil.escalateVisibility((PsiField)myTargetVariable,expression);
      String newQualifierName=myTargetVariable.getName();
      if (myTargetVariable instanceof PsiField && oldQualifier != null) {
        final PsiClass aClass=PsiUtil.resolveClassInClassTypeOnly(oldQualifier.getType());
        if (aClass == ((PsiField)myTargetVariable).getContainingClass()) {
          newQualifierName=oldQualifier.getText() + "." + newQualifierName;
        }
      }
      newQualifier=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory().createExpressionFromText(newQualifierName,null);
    }
    PsiExpression newArgument=null;
    if (classReferencedByThis != null) {
      @NonNls String thisArgumentText=null;
      if (manager.areElementsEquivalent(myMethod.getContainingClass(),classReferencedByThis)) {
        if (myOldClassParameterNames.containsKey(myMethod.getContainingClass())) {
          thisArgumentText="this";
        }
      }
 else {
        thisArgumentText=classReferencedByThis.getName() + ".this";
      }
      if (thisArgumentText != null) {
        newArgument=JavaPsiFacade.getInstance(manager.getProject()).getElementFactory().createExpressionFromText(thisArgumentText,null);
      }
    }
 else {
      if (!isInternalCall && oldQualifier != null) {
        final PsiType type=oldQualifier.getType();
        if (type instanceof PsiClassType) {
          final PsiClass resolved=((PsiClassType)type).resolve();
          if (resolved != null && getParameterNameToCreate(resolved) != null) {
            newArgument=replaceRefsToTargetVariable(oldQualifier);
          }
        }
      }
    }
    if (newArgument != null) {
      expression.getArgumentList().add(newArgument);
    }
    if (newQualifier != null) {
      if (newQualifier instanceof PsiThisExpression && ((PsiThisExpression)newQualifier).getQualifier() == null) {
        if (oldQualifier != null)         oldQualifier.delete();
      }
 else {
        final PsiReferenceExpression refExpr=(PsiReferenceExpression)JavaPsiFacade.getInstance(manager.getProject()).getElementFactory().createExpressionFromText("q." + myMethod.getName(),null);
        refExpr.getQualifierExpression().replace(newQualifier);
        methodExpression.replace(refExpr);
      }
    }
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
