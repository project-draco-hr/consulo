{
  if (!myJavaClassReferenceSet.getElement().isValid())   return JavaResolveResult.EMPTY;
  final String elementText=getElement().getText();
  if (isStaticClassReference(elementText)) {
    final PsiElement psiElement=myJavaClassReferenceSet.getReferences()[myIndex - 1].resolve();
    if (psiElement instanceof PsiClass) {
      final PsiClass psiClass=((PsiClass)psiElement).findInnerClassByName(getCanonicalText(),false);
      if (psiClass != null)       return new ClassCandidateInfo(psiClass,PsiSubstitutor.EMPTY,false,myJavaClassReferenceSet.getElement());
      return JavaResolveResult.EMPTY;
    }
  }
  String qName=elementText.substring(myJavaClassReferenceSet.getReference(0).getRangeInElement().getStartOffset(),getRangeInElement().getEndOffset());
  PsiManager manager=myJavaClassReferenceSet.getElement().getManager();
  if (myIndex == myJavaClassReferenceSet.getReferences().length - 1) {
    final PsiClass aClass=manager.findClass(qName,GlobalSearchScope.allScope(myJavaClassReferenceSet.getElement().getProject()));
    if (aClass != null) {
      return new ClassCandidateInfo(aClass,PsiSubstitutor.EMPTY,false,myJavaClassReferenceSet.getElement());
    }
 else {
      final Boolean value=JavaClassReferenceProvider.RESOLVE_ONLY_CLASSES.getValue(getOptions());
      if (value != null && value.booleanValue()) {
        return JavaResolveResult.EMPTY;
      }
    }
  }
  PsiElement resolveResult=manager.findPackage(qName);
  if (resolveResult == null) {
    resolveResult=manager.findClass(qName,GlobalSearchScope.allScope(myJavaClassReferenceSet.getElement().getProject()));
  }
  if (myInStaticImport && resolveResult == null) {
    resolveResult=resolveMember(qName,manager,getElement().getResolveScope());
  }
  if (resolveResult == null) {
    PsiFile containingFile=myJavaClassReferenceSet.getElement().getContainingFile();
    if (containingFile instanceof PsiJavaFile) {
      if (containingFile instanceof JspFile) {
        containingFile=containingFile.getViewProvider().getPsi(StdLanguages.JAVA);
        if (containingFile == null)         return JavaResolveResult.EMPTY;
      }
      final ClassResolverProcessor processor=new ClassResolverProcessor(getCanonicalText(),myJavaClassReferenceSet.getElement());
      containingFile.processDeclarations(processor,PsiSubstitutor.EMPTY,null,myJavaClassReferenceSet.getElement());
      if (processor.getResult().length == 1) {
        final JavaResolveResult javaResolveResult=processor.getResult()[0];
        if (javaResolveResult != JavaResolveResult.EMPTY && getOptions() != null) {
          final Boolean value=JavaClassReferenceProvider.RESOLVE_QUALIFIED_CLASS_NAME.getValue(getOptions());
          final PsiClass psiClass=(PsiClass)javaResolveResult.getElement();
          if (value != null && value.booleanValue() && psiClass != null) {
            final String qualifiedName=psiClass.getQualifiedName();
            if (!qName.equals(qualifiedName)) {
              return JavaResolveResult.EMPTY;
            }
          }
        }
        return javaResolveResult;
      }
    }
  }
  return resolveResult != null ? new CandidateInfo(resolveResult,PsiSubstitutor.EMPTY,false,false,myJavaClassReferenceSet.getElement()) : JavaResolveResult.EMPTY;
}
