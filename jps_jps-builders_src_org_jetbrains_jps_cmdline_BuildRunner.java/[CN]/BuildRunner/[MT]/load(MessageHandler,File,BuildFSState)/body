{
  if (!dataStorageRoot.exists()) {
    myBuildType=BuildType.PROJECT_REBUILD;
  }
  final boolean inMemoryMappingsDelta=System.getProperty(GlobalOptions.USE_MEMORY_TEMP_CACHE_OPTION) != null;
  ProjectTimestamps projectTimestamps=null;
  BuildDataManager dataManager=null;
  try {
    projectTimestamps=new ProjectTimestamps(dataStorageRoot);
    dataManager=new BuildDataManager(dataStorageRoot,inMemoryMappingsDelta);
    if (dataManager.versionDiffers()) {
      myForceCleanCaches=true;
      msgHandler.processMessage(new CompilerMessage("build",BuildMessage.Kind.INFO,"Dependency data format has changed, project rebuild required"));
    }
  }
 catch (  Exception e) {
    LOG.info(e);
    if (projectTimestamps != null) {
      projectTimestamps.close();
    }
    if (dataManager != null) {
      dataManager.close();
    }
    myForceCleanCaches=true;
    FileUtil.delete(dataStorageRoot);
    projectTimestamps=new ProjectTimestamps(dataStorageRoot);
    dataManager=new BuildDataManager(dataStorageRoot,inMemoryMappingsDelta);
    msgHandler.processMessage(new CompilerMessage("build",BuildMessage.Kind.INFO,"Project rebuild forced: " + e.getMessage()));
  }
  final JpsModel jpsModel=loadJpsModel();
  final Project project=loadProject();
  return new ProjectDescriptor(project,jpsModel,fsState,projectTimestamps,dataManager,BuildLoggingManager.DEFAULT);
}
