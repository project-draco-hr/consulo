{
  StopWatch sw=StopWatch.start("refresh");
  PermanentGraph<Integer> permanentGraph=myCurrentDataPack.isFull() ? myCurrentDataPack.getPermanentGraph() : null;
  Map<VirtualFile,CompressedRefs> currentRefs=myCurrentDataPack.getRefsModel().getAllRefsByRoot();
  try {
    if (permanentGraph != null) {
      int commitCount=myRecentCommitCount;
      for (int attempt=0; attempt <= 1; attempt++) {
        loadLogAndRefs(roots,currentRefs,commitCount);
        List<? extends GraphCommit<Integer>> compoundLog=multiRepoJoin(myLoadedInfo.getCommits());
        Map<VirtualFile,CompressedRefs> allNewRefs=getAllNewRefs(myLoadedInfo,currentRefs);
        List<GraphCommit<Integer>> joinedFullLog=join(compoundLog,permanentGraph.getAllCommits(),currentRefs,allNewRefs);
        if (joinedFullLog == null) {
          commitCount*=5;
        }
 else {
          return DataPack.build(joinedFullLog,allNewRefs,myProviders,myHashMap,true);
        }
      }
      LOG.info("Couldn't join " + commitCount / 5 + " recent commits to the log (" + permanentGraph.getAllCommits().size() + " commits)");
    }
    return loadFullLog();
  }
 catch (  Exception e) {
    myExceptionHandler.consume(e);
    return DataPack.EMPTY;
  }
 finally {
    sw.report();
  }
}
