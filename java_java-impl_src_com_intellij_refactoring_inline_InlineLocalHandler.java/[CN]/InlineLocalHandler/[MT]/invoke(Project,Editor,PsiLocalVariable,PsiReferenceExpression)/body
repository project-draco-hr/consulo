{
  if (!CommonRefactoringUtil.checkReadOnlyStatus(project,local))   return;
  final HighlightManager highlightManager=HighlightManager.getInstance(project);
  final String localName=local.getName();
  final Query<PsiReference> query=ReferencesSearch.search(local,GlobalSearchScope.allScope(project),false);
  if (query.findFirst() == null) {
    LOG.assertTrue(refExpr == null);
    String message=RefactoringBundle.message("variable.is.never.used",localName);
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
    return;
  }
  final PsiClass containingClass=PsiTreeUtil.getParentOfType(local,PsiClass.class);
  final List<PsiClass> innerClassesWithUsages=Collections.synchronizedList(new ArrayList<PsiClass>());
  final List<PsiElement> innerClassUsages=Collections.synchronizedList(new ArrayList<PsiElement>());
  query.forEach(new Processor<PsiReference>(){
    public boolean process(    final PsiReference psiReference){
      final PsiElement element=psiReference.getElement();
      PsiClass psiClass=PsiTreeUtil.getParentOfType(element,PsiClass.class);
      while (psiClass != containingClass && psiClass != null) {
        final PsiClass parentPsiClass=PsiTreeUtil.getParentOfType(psiClass,PsiClass.class,true);
        if (parentPsiClass == containingClass) {
          innerClassesWithUsages.add(psiClass);
          innerClassUsages.add(element);
        }
        psiClass=parentPsiClass;
      }
      return true;
    }
  }
);
  final PsiCodeBlock containerBlock=PsiTreeUtil.getParentOfType(local,PsiCodeBlock.class);
  LOG.assertTrue(containerBlock != null,local);
  final PsiExpression defToInline=innerClassesWithUsages.isEmpty() ? getDefToInline(local,refExpr,containerBlock) : getDefToInline(local,innerClassesWithUsages.get(0),containerBlock);
  if (defToInline == null) {
    final String key=refExpr == null ? "variable.has.no.initializer" : "variable.has.no.dominating.definition";
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message(key,localName));
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
    return;
  }
  final List<PsiElement> refsToInlineList=new ArrayList<PsiElement>();
  Collections.addAll(refsToInlineList,DefUseUtil.getRefs(containerBlock,local,defToInline));
  for (  PsiElement innerClassUsage : innerClassUsages) {
    if (!refsToInlineList.contains(innerClassUsage)) {
      refsToInlineList.add(innerClassUsage);
    }
  }
  if (refsToInlineList.size() == 0) {
    String message=RefactoringBundle.message("variable.is.never.used.before.modification",localName);
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
    return;
  }
  final PsiElement[] refsToInline=PsiUtilBase.toPsiElementArray(refsToInlineList);
  EditorColorsManager manager=EditorColorsManager.getInstance();
  final TextAttributes attributes=manager.getGlobalScheme().getAttributes(EditorColors.SEARCH_RESULT_ATTRIBUTES);
  final TextAttributes writeAttributes=manager.getGlobalScheme().getAttributes(EditorColors.WRITE_SEARCH_RESULT_ATTRIBUTES);
  if (refExpr != null && PsiUtil.isAccessedForReading(refExpr) && ArrayUtil.find(refsToInline,refExpr) < 0) {
    final PsiElement[] defs=DefUseUtil.getDefs(containerBlock,local,refExpr);
    LOG.assertTrue(defs.length > 0);
    highlightManager.addOccurrenceHighlights(editor,defs,attributes,true,null);
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("variable.is.accessed.for.writing",localName));
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
    WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
    return;
  }
  PsiFile workingFile=local.getContainingFile();
  for (  PsiElement ref : refsToInline) {
    final PsiFile otherFile=ref.getContainingFile();
    if (!otherFile.equals(workingFile)) {
      String message=RefactoringBundle.message("variable.is.referenced.in.multiple.files",localName);
      CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
      return;
    }
  }
  for (  final PsiElement ref : refsToInline) {
    final PsiElement[] defs=DefUseUtil.getDefs(containerBlock,local,ref);
    boolean isSameDefinition=true;
    for (    PsiElement def : defs) {
      isSameDefinition&=isSameDefinition(def,defToInline);
    }
    if (!isSameDefinition) {
      highlightManager.addOccurrenceHighlights(editor,defs,writeAttributes,true,null);
      highlightManager.addOccurrenceHighlights(editor,new PsiElement[]{ref},attributes,true,null);
      String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("variable.is.accessed.for.writing.and.used.with.inlined",localName));
      CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
      WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
      return;
    }
  }
  final PsiElement writeAccess=checkRefsInAugmentedAssignmentOrUnaryModified(refsToInline);
  if (writeAccess != null) {
    HighlightManager.getInstance(project).addOccurrenceHighlights(editor,new PsiElement[]{writeAccess},writeAttributes,true,null);
    String message=RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("variable.is.accessed.for.writing",localName));
    CommonRefactoringUtil.showErrorHint(project,editor,message,REFACTORING_NAME,HelpID.INLINE_VARIABLE);
    WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
    return;
  }
  if (editor != null && !ApplicationManager.getApplication().isUnitTestMode()) {
    highlightManager.addOccurrenceHighlights(editor,refsToInline,attributes,true,null);
    int occurrencesCount=refsToInline.length;
    String occurencesString=RefactoringBundle.message("occurences.string",occurrencesCount);
    final String promptKey=isInliningVariableInitializer(defToInline) ? "inline.local.variable.prompt" : "inline.local.variable.definition.prompt";
    final String question=RefactoringBundle.message(promptKey,localName) + " " + occurencesString;
    RefactoringMessageDialog dialog=new RefactoringMessageDialog(REFACTORING_NAME,question,HelpID.INLINE_VARIABLE,"OptionPane.questionIcon",true,project);
    dialog.show();
    if (!dialog.isOK()) {
      WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
      return;
    }
  }
  final Runnable runnable=new Runnable(){
    public void run(){
      try {
        PsiExpression[] exprs=new PsiExpression[refsToInline.length];
        for (int idx=0; idx < refsToInline.length; idx++) {
          PsiJavaCodeReferenceElement refElement=(PsiJavaCodeReferenceElement)refsToInline[idx];
          exprs[idx]=InlineUtil.inlineVariable(local,defToInline,refElement);
        }
        if (!isInliningVariableInitializer(defToInline)) {
          defToInline.getParent().delete();
        }
 else {
          defToInline.delete();
        }
        if (ReferencesSearch.search(local).findFirst() == null) {
          QuickFixFactory.getInstance().createRemoveUnusedVariableFix(local).invoke(project,editor,local.getContainingFile());
        }
        if (editor != null && !ApplicationManager.getApplication().isUnitTestMode()) {
          highlightManager.addOccurrenceHighlights(editor,exprs,attributes,true,null);
          WindowManager.getInstance().getStatusBar(project).setInfo(RefactoringBundle.message("press.escape.to.remove.the.highlighting"));
        }
        for (        final PsiExpression expr : exprs) {
          InlineUtil.tryToInlineArrayCreationForVarargs(expr);
        }
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
;
  CommandProcessor.getInstance().executeCommand(project,new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(runnable);
    }
  }
,RefactoringBundle.message("inline.command",localName),null);
}
