{
  LinkedHashSet<TemplateContextType> set=new LinkedHashSet<TemplateContextType>();
  LinkedList<TemplateContextType> contexts=buildOrderedContextTypes();
  for (  TemplateContextType contextType : contexts) {
    if (fileType == null ? contextType.isInContext(file,offset) : contextType.isInContext(fileType)) {
      set.add(contextType);
    }
  }
  removeBases:   while (true) {
    for (    TemplateContextType type : set) {
      if (set.remove(type.getBaseContextType())) {
        continue removeBases;
      }
    }
    return set.iterator().next();
  }
}
