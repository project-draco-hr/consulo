{
  final int caretOffset=editor.getCaretModel().getOffset();
  final TemplateState templateState=initTemplateState(editor);
  CommandProcessor commandProcessor=CommandProcessor.getInstance();
  commandProcessor.executeCommand(myProject,new Runnable(){
    public void run(){
      editor.getDocument().deleteString(templateStart,caretOffset);
      editor.getCaretModel().moveToOffset(templateStart);
      editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
      editor.getSelectionModel().removeSelection();
      templateState.start(template,processor,argument);
    }
  }
,CodeInsightBundle.message("insert.code.template.command"),null);
}
