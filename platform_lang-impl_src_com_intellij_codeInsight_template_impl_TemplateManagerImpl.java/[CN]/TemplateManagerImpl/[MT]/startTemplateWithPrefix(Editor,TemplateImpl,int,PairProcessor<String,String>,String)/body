{
  final int caretOffset=editor.getCaretModel().getOffset();
  final TemplateState templateState=initTemplateState(editor);
  CommandProcessor commandProcessor=CommandProcessor.getInstance();
  commandProcessor.executeCommand(myProject,new Runnable(){
    @Override public void run(){
      editor.getDocument().deleteString(templateStart,caretOffset);
      editor.getCaretModel().moveToOffset(templateStart);
      editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
      editor.getSelectionModel().removeSelection();
      Map<String,String> predefinedVarValues=null;
      if (argument != null) {
        predefinedVarValues=new HashMap<String,String>();
        predefinedVarValues.put(TemplateImpl.ARG,argument);
      }
      templateState.start(template,processor,predefinedVarValues);
    }
  }
,CodeInsightBundle.message("insert.code.template.command"),null);
}
