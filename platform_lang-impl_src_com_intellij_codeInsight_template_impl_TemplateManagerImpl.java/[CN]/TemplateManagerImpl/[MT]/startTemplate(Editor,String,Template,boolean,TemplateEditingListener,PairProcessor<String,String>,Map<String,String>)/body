{
  final TemplateState templateState=initTemplateState(editor);
  templateState.getProperties().put(ExpressionContext.SELECTION,selectionString);
  if (listener != null) {
    templateState.addTemplateStateListener(listener);
  }
  Runnable r=new Runnable(){
    @Override public void run(){
      if (selectionString != null) {
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          @Override public void run(){
            EditorModificationUtil.deleteSelectedText(editor);
          }
        }
);
      }
 else {
        editor.getSelectionModel().removeSelection();
      }
      templateState.start((TemplateImpl)template,processor,predefinedVarValues);
    }
  }
;
  if (inSeparateCommand) {
    CommandProcessor.getInstance().executeCommand(myProject,r,CodeInsightBundle.message("insert.code.template.command"),null);
  }
 else {
    r.run();
  }
  if (shouldSkipInTests()) {
    if (!templateState.isFinished())     templateState.gotoEnd();
  }
}
