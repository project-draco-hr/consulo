{
  Set<TemplateContextType> result=getDirectlyApplicableContextTypes(file,offset,null);
  Language baseLanguage=file.getViewProvider().getBaseLanguage();
  if (baseLanguage != file.getLanguage()) {
    PsiFile basePsi=file.getViewProvider().getPsi(baseLanguage);
    if (basePsi != null) {
      result.addAll(getDirectlyApplicableContextTypes(basePsi,offset,null));
    }
  }
  final Language baseLanguageForBaseLanguage=baseLanguage.getBaseLanguage();
  if (baseLanguageForBaseLanguage != null) {
    final LanguageFileType associatedFileType=baseLanguageForBaseLanguage.getAssociatedFileType();
    if (associatedFileType != null && associatedFileType != file.getFileType()) {
      for (      TemplateContextType contextType : getDirectlyApplicableContextTypes(null,0,associatedFileType)) {
        if (!(contextType instanceof EverywhereContextType)) {
          result.add(contextType);
        }
      }
    }
  }
  Language languageAtOffset=PsiUtilBase.getLanguageAtOffset(file,offset);
  if (languageAtOffset != file.getLanguage() && languageAtOffset != baseLanguage) {
    PsiFile basePsi=file.getViewProvider().getPsi(languageAtOffset);
    if (basePsi != null) {
      result.addAll(getDirectlyApplicableContextTypes(basePsi,offset,null));
    }
  }
  return result;
}
