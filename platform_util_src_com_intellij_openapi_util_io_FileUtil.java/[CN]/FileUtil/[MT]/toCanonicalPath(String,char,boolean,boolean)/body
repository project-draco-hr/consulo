{
  if (path == null || path.isEmpty()) {
    return path;
  }
  if (StringUtil.startsWithChar(path,'.')) {
    if (path.length() == 1) {
      return "";
    }
    char c=path.charAt(1);
    if (c == '/' || c == separatorChar) {
      path=path.substring(2);
    }
  }
  path=path.replace(separatorChar,'/');
  int index=-1;
  do {
    index=path.indexOf('/',index + 1);
    char next=index == path.length() - 1 ? 0 : path.charAt(index + 1);
    if (next == '.' || next == '/') {
      break;
    }
  }
 while (index != -1);
  if (index == -1) {
    if (removeLastSlash) {
      int start=processRoot(path,NullAppendable.INSTANCE);
      int slashIndex=path.lastIndexOf('/');
      return slashIndex != -1 && slashIndex > start ? StringUtil.trimEnd(path,'/') : path;
    }
    return path;
  }
  final String finalPath=path;
  NotNullProducer<String> realCanonicalPath=resolveSymlinks ? new NotNullProducer<String>(){
    @NotNull @Override public String produce(){
      try {
        return new File(finalPath).getCanonicalPath().replace(separatorChar,'/');
      }
 catch (      IOException ignore) {
        return toCanonicalPath(finalPath,separatorChar,removeLastSlash,false);
      }
    }
  }
 : null;
  StringBuilder result=new StringBuilder(path.length());
  int start=processRoot(path,result);
  int dots=0;
  boolean separator=true;
  for (int i=start; i < path.length(); ++i) {
    char c=path.charAt(i);
    if (c == '/') {
      if (!separator) {
        if (!processDots(result,dots,start,resolveSymlinks)) {
          return realCanonicalPath.produce();
        }
        dots=0;
      }
      separator=true;
    }
 else     if (c == '.') {
      if (separator || dots > 0) {
        ++dots;
      }
 else {
        result.append('.');
      }
      separator=false;
    }
 else {
      if (dots > 0) {
        StringUtil.repeatSymbol(result,'.',dots);
        dots=0;
      }
      result.append(c);
      separator=false;
    }
  }
  if (dots > 0) {
    if (!processDots(result,dots,start,resolveSymlinks)) {
      return realCanonicalPath.produce();
    }
  }
  int lastChar=result.length() - 1;
  if (removeLastSlash && lastChar >= 0 && result.charAt(lastChar) == '/' && lastChar > start) {
    result.deleteCharAt(lastChar);
  }
  return result.toString();
}
