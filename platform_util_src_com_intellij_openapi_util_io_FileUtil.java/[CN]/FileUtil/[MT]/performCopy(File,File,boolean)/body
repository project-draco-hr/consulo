{
  FileOutputStream fos;
  try {
    fos=new FileOutputStream(toFile);
  }
 catch (  FileNotFoundException e) {
    File parentFile=toFile.getParentFile();
    if (parentFile == null) {
      final IOException ioException=new IOException("parent file is null for " + toFile.getPath());
      ioException.initCause(e);
      throw ioException;
    }
    createParentDirs(toFile);
    fos=new FileOutputStream(toFile);
  }
  if (Patches.FILE_CHANNEL_TRANSFER_BROKEN || fromFile.length() > CHANNELS_COPYING_LIMIT) {
    FileInputStream fis=new FileInputStream(fromFile);
    try {
      copy(fis,fos);
    }
  finally {
      fis.close();
      fos.close();
    }
  }
 else {
    FileChannel fromChannel=new FileInputStream(fromFile).getChannel();
    FileChannel toChannel=fos.getChannel();
    try {
      fromChannel.transferTo(0,Long.MAX_VALUE,toChannel);
    }
  finally {
      fromChannel.close();
      toChannel.close();
    }
  }
  if (syncTimestamp) {
    final long timeStamp=fromFile.lastModified();
    if (timeStamp < 0) {
      LOG.warn("Invalid timestamp " + timeStamp + " of '"+ fromFile+ "'");
    }
 else     if (!toFile.setLastModified(timeStamp)) {
      LOG.warn("Unable to set timestamp " + timeStamp + " to '"+ toFile+ "'");
    }
  }
  if (SystemInfo.isUnix && fromFile.canExecute()) {
    final int oldPermissions=FileSystemUtil.getPermissions(fromFile);
    final int newPermissions=FileSystemUtil.getPermissions(toFile);
    if (oldPermissions != -1 && newPermissions != -1) {
      FileSystemUtil.setPermissions(toFile,oldPermissions | newPermissions);
    }
  }
}
