{
  if (elements.length != 1 || !(elements[0] instanceof PsiMethod))   return;
  final PsiMethod method=((PsiMethod)elements[0]);
  if (!method.hasModifierProperty(PsiModifier.STATIC)) {
    String message=RefactoringBundle.message("convertToInstanceMethod.method.is.not.static",method.getName());
    RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,message,HelpID.CONVERT_TO_INSTANCE_METHOD,project);
    return;
  }
  final PsiParameter[] parameters=method.getParameterList().getParameters();
  List<PsiParameter> suitableParameters=new ArrayList<PsiParameter>();
  boolean classTypesFound=false;
  boolean resolvableClassesFound=false;
  boolean classesInProjectFound=false;
  for (  final PsiParameter parameter : parameters) {
    final PsiType type=parameter.getType();
    if (type instanceof PsiClassType) {
      classTypesFound=true;
      final PsiClass psiClass=((PsiClassType)type).resolve();
      if (psiClass != null && !(psiClass instanceof PsiTypeParameter)) {
        resolvableClassesFound=true;
        final boolean inProject=method.getManager().isInProject(psiClass);
        if (inProject) {
          classesInProjectFound=true;
          suitableParameters.add(parameter);
        }
      }
    }
  }
  if (suitableParameters.isEmpty()) {
    String message=null;
    if (!classTypesFound) {
      message=RefactoringBundle.message("convertToInstanceMethod.no.parameters.with.reference.type");
    }
 else     if (!resolvableClassesFound) {
      message=RefactoringBundle.message("convertToInstanceMethod.all.reference.type.parametres.have.unknown.types");
    }
 else     if (!classesInProjectFound) {
      message=RefactoringBundle.message("convertToInstanceMethod.all.reference.type.parameters.are.not.in.project");
    }
    LOG.assertTrue(message != null);
    RefactoringMessageUtil.showErrorMessage(REFACTORING_NAME,RefactoringBundle.getCannotRefactorMessage(message),HelpID.CONVERT_TO_INSTANCE_METHOD,project);
    return;
  }
  new ConvertToInstanceMethodDialog(method,suitableParameters.toArray(new PsiParameter[suitableParameters.size()])).show();
}
