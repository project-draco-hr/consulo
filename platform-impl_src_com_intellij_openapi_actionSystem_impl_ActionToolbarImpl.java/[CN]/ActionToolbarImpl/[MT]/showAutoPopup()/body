{
  if (isPopupShowing())   return;
  final ActionGroup group;
  if (myOrientation == SwingConstants.HORIZONTAL) {
    group=myActionGroup;
  }
 else {
    final DefaultActionGroup outside=new DefaultActionGroup();
    for (int i=myFirstOusideIndex; i < myVisibleActions.size(); i++) {
      outside.add(myVisibleActions.get(i));
    }
    group=outside;
  }
  PopupToolbar popupToolbar=new PopupToolbar(myPlace,group,true,myDataManager,myActionManager,myKeymapManager){
    protected void onOtherActionPerformed(){
      hidePopup();
    }
    protected DataContext getDataContext(){
      return ActionToolbarImpl.this.getDataContext();
    }
  }
;
  popupToolbar.setLayoutPolicy(NOWRAP_LAYOUT_POLICY);
  Point location;
  if (myOrientation == SwingConstants.HORIZONTAL) {
    location=getLocationOnScreen();
  }
 else {
    location=getLocationOnScreen();
    location.y=location.y + getHeight() - popupToolbar.getPreferredSize().height;
  }
  final ComponentPopupBuilder builder=JBPopupFactory.getInstance().createComponentPopupBuilder(popupToolbar,null);
  builder.setResizable(false).setRequestFocus(false).setTitle(null).setCancelOnClickOutside(true).setCancelOnOtherWindowOpen(true).setCancelCallback(new Computable<Boolean>(){
    public Boolean compute(){
      return myActionManager.isActionPopupStackEmpty();
    }
  }
).setCancelOnMouseOutCallback(new MouseChecker(){
    public boolean check(    final MouseEvent event){
      return myAutoPopupRec != null && myActionManager.isActionPopupStackEmpty() && !new RelativeRectangle(ActionToolbarImpl.this,myAutoPopupRec).contains(new RelativePoint(event));
    }
  }
);
  builder.addListener(new JBPopupListener(){
    public void onClosed(    final JBPopup popup){
      processClosed();
    }
  }
);
  myPopup=builder.createPopup();
  Disposer.register(myPopup,popupToolbar);
  myPopup.showInScreenCoordinates(this,location);
  final Window window=SwingUtilities.getWindowAncestor(this);
  if (window != null) {
    final ComponentAdapter componentAdapter=new ComponentAdapter(){
      public void componentResized(      final ComponentEvent e){
        hidePopup();
      }
      public void componentMoved(      final ComponentEvent e){
        hidePopup();
      }
      public void componentShown(      final ComponentEvent e){
        hidePopup();
      }
      public void componentHidden(      final ComponentEvent e){
        hidePopup();
      }
    }
;
    window.addComponentListener(componentAdapter);
    Disposer.register(popupToolbar,new Disposable(){
      public void dispose(){
        window.removeComponentListener(componentAdapter);
      }
    }
);
  }
}
