{
  if (virtualFile.isDirectory()) {
    return Pair.create(null,"file is a directory");
  }
  FileDocumentManager documentManager=FileDocumentManager.getInstance();
  Document document=documentManager.getDocument(virtualFile);
  if (document == null)   return Pair.create(null,"binary file");
  Charset charsetFromContent=((EncodingManagerImpl)EncodingManager.getInstance()).computeCharsetFromContent(virtualFile);
  Charset existing=charsetFromContent;
  String failReason=LoadTextUtil.wasCharsetDetectedFromBytes(virtualFile);
  if (failReason != null) {
    existing=virtualFile.getCharset();
  }
 else   if (charsetFromContent != null) {
    failReason="hard coded in text";
  }
 else {
    Pair<Charset,String> fileTypeCheck=checkHardcodedCharsetFileType(virtualFile);
    if (fileTypeCheck.second != null) {
      failReason=fileTypeCheck.second;
      existing=fileTypeCheck.first;
    }
  }
  if (failReason != null) {
    return Pair.create(existing,failReason);
  }
  return Pair.create(virtualFile.getCharset(),null);
}
