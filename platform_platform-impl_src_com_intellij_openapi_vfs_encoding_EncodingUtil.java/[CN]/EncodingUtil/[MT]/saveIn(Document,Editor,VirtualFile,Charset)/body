{
  FileDocumentManager documentManager=FileDocumentManager.getInstance();
  documentManager.saveDocument(document);
  final Project project=ProjectLocator.getInstance().guessProjectForFile(virtualFile);
  boolean writable=project == null ? virtualFile.isWritable() : ReadonlyStatusHandler.ensureFilesWritable(project,virtualFile);
  if (!writable) {
    CommonRefactoringUtil.showErrorHint(project,editor,"Cannot save the file " + virtualFile.getPresentableUrl(),"Unable to Save",null);
    return;
  }
  virtualFile.setCharset(charset);
  try {
    LoadTextUtil.write(project,virtualFile,virtualFile,document.getText(),document.getModificationStamp());
  }
 catch (  IOException io) {
    Messages.showErrorDialog(project,io.getMessage(),"Error Writing File");
  }
  EncodingProjectManagerImpl.suppressReloadDuring(new Runnable(){
    @Override public void run(){
      EncodingManager.getInstance().setEncoding(virtualFile,charset);
    }
  }
);
}
