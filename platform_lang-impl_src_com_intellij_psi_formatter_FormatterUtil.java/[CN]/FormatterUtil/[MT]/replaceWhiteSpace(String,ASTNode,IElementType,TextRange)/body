{
  final CharTable charTable=SharedImplUtil.findCharTableByTree(leafElement);
  if (textRange != null && textRange.getStartOffset() > leafElement.getTextRange().getStartOffset() && textRange.getEndOffset() < leafElement.getTextRange().getEndOffset()) {
    StringBuilder newText=createNewLeafChars(leafElement,textRange,whiteSpace);
    LeafElement newElement=Factory.createSingleLeafElement(leafElement.getElementType(),newText,charTable,leafElement.getPsi().getManager());
    leafElement.getTreeParent().replaceChild(leafElement,newElement);
    return;
  }
  ASTNode treePrev=findPreviousWhiteSpace(leafElement,whiteSpaceToken);
  if (treePrev == null) {
    treePrev=getWsCandidate(leafElement);
  }
  if (treePrev != null && treePrev.getText().trim().length() == 0 && treePrev.getElementType() != whiteSpaceToken && treePrev.getTextLength() > 0 && whiteSpace.length() > 0) {
    LeafElement whiteSpaceElement=Factory.createSingleLeafElement(treePrev.getElementType(),whiteSpace,charTable,SharedImplUtil.getManagerByTree(leafElement));
    ASTNode treeParent=treePrev.getTreeParent();
    treeParent.replaceChild(treePrev,whiteSpaceElement);
  }
 else {
    LeafElement whiteSpaceElement=Factory.createSingleLeafElement(whiteSpaceToken,whiteSpace,charTable,SharedImplUtil.getManagerByTree(leafElement));
    if (treePrev == null) {
      if (whiteSpace.length() > 0) {
        addWhiteSpace(leafElement,whiteSpaceElement);
      }
    }
 else {
      if (!(treePrev.getElementType() == whiteSpaceToken)) {
        if (whiteSpace.length() > 0) {
          addWhiteSpace(treePrev,whiteSpaceElement);
        }
      }
 else {
        if (treePrev.getElementType() == whiteSpaceToken) {
          final CompositeElement treeParent=(CompositeElement)treePrev.getTreeParent();
          if (whiteSpace.length() > 0) {
            treeParent.replaceChild(treePrev,whiteSpaceElement);
          }
 else {
            treeParent.removeChild(treePrev);
          }
          ASTNode removeCandidate=findPreviousWhiteSpace(whiteSpaceElement,whiteSpaceToken);
          while (textRange != null && removeCandidate != null && removeCandidate.getStartOffset() >= textRange.getStartOffset()) {
            treePrev=findPreviousWhiteSpace(removeCandidate,whiteSpaceToken);
            removeCandidate.getTreeParent().removeChild(removeCandidate);
            removeCandidate=treePrev;
          }
        }
      }
    }
  }
}
