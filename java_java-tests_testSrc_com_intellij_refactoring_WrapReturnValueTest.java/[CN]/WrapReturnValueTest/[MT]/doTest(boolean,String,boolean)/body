{
  try {
    doTest(new PerformAction(){
      public void performAction(      final VirtualFile rootDir,      final VirtualFile rootAfter) throws Exception {
        PsiClass aClass=myJavaFacade.findClass("Test",GlobalSearchScope.projectScope(getProject()));
        assertNotNull("Class Test not found",aClass);
        final PsiMethod method=aClass.findMethodsByName("foo",false)[0];
        @NonNls final String wrapperClassName="Wrapper";
        final PsiClass wrapperClass=myJavaFacade.findClass(wrapperClassName,GlobalSearchScope.projectScope(getProject()));
        assertTrue(!existing || wrapperClass != null);
        final PsiField delegateField=existing ? wrapperClass.findFieldByName("myField",false) : null;
        WrapReturnValueProcessor processor=new WrapReturnValueProcessor(wrapperClassName,"",method,existing,createInnerClass,delegateField);
        processor.run();
      }
    }
);
  }
 catch (  BaseRefactoringProcessor.ConflictsInTestsException e) {
    if (exceptionMessage != null) {
      assertEquals(exceptionMessage,e.getMessage());
      return;
    }
    throw e;
  }
  if (exceptionMessage != null) {
    fail("Conflict was not found");
  }
}
