{
  final Project project=file.getProject();
  FileStatus status=FileStatusManager.getInstance(project).getStatus(file.getVirtualFile());
  final String oldText=getUnmodifiedDocument(file.getVirtualFile(),project);
  final List<T> elements=new ArrayList<T>();
  final List<T> oldElements=new ArrayList<T>();
  final PsiFile oldFile=oldText == null ? null : PsiFileFactory.getInstance(project).createFileFromText(file.getName(),file.getLanguage(),oldText,false,true);
  file.accept(new MyVisitor<T>(filter,elements));
  final HashMap<T,FileStatus> result=new HashMap<T,FileStatus>();
  if (status == FileStatus.ADDED || status == FileStatus.DELETED || status == FileStatus.DELETED_FROM_FS || status == FileStatus.UNKNOWN) {
    for (    T element : elements) {
      result.put(element,status);
    }
    return result;
  }
  if (oldFile == null)   return result;
  oldFile.accept(new MyVisitor<T>(filter,oldElements));
  calculateStatuses(elements,oldElements,result);
  return result;
}
