{
  if (ApplicationManager.getApplication().isUnitTestMode())   return new Point();
  final int offset=editor.getCaretModel().getOffset();
  final LogicalPosition pos=editor.offsetToLogicalPosition(offset);
  int line=pos.line;
  final Point position=editor.logicalPositionToXY(new LogicalPosition(line,0));
  LOG.assertTrue(editor.getComponent().isDisplayable());
  JComponent convertComponent=editor.getContentComponent();
  Point realPoint;
  final boolean oneLineEditor=editor.isOneLineMode();
  if (oneLineEditor) {
    final JComponent contentComponent=editor.getContentComponent();
    Container ancestorOfClass=SwingUtilities.getAncestorOfClass(JComboBox.class,contentComponent);
    if (ancestorOfClass != null) {
      convertComponent=(JComponent)ancestorOfClass;
    }
 else {
      ancestorOfClass=SwingUtilities.getAncestorOfClass(JTextField.class,contentComponent);
      if (ancestorOfClass != null) {
        convertComponent=(JComponent)ancestorOfClass;
      }
    }
    realPoint=new Point(-(ourIntentionIcon.getIconWidth() / 2) - 4,-(ourIntentionIcon.getIconHeight() / 2));
  }
 else {
    final int yShift=(ourIntentionIcon.getIconHeight() - editor.getLineHeight() - 1) / 2 - 1;
    final int xShift=ourIntentionIcon.getIconWidth();
    Rectangle visibleArea=editor.getScrollingModel().getVisibleArea();
    realPoint=new Point(Math.max(0,visibleArea.x - xShift),position.y + yShift - LIGHTBULB_OFFSET);
  }
  Point location=SwingUtilities.convertPoint(convertComponent,realPoint,editor.getComponent().getRootPane().getLayeredPane());
  return new Point(location.x,location.y);
}
