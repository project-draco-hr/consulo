{
  int lastLbraceOffset=-1;
  Stack<IElementType> braceStack=new Stack<IElementType>();
  for (; !iterator.atEnd(); iterator.retreat()) {
    final IElementType tokenType=iterator.getTokenType();
    if (isLBraceToken(iterator,fileText,fileType)) {
      if (!braceStack.isEmpty()) {
        IElementType topToken=braceStack.pop();
        if (!isPairBraces(tokenType,topToken,fileType)) {
          break;
        }
      }
 else {
        if (tokenType == lparenTokenType) {
          lastLbraceOffset=iterator.getStart();
        }
 else {
          break;
        }
      }
    }
 else     if (isRBraceToken(iterator,fileText,fileType)) {
      braceStack.push(iterator.getTokenType());
    }
  }
  return lastLbraceOffset;
}
