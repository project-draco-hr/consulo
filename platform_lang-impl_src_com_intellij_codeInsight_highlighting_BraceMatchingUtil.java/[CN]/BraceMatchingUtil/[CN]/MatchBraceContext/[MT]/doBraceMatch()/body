{
  myBraceStack.clear();
  myTagNameStack.clear();
  myBraceStack.push(brace1Token);
  if (isStrict) {
    myTagNameStack.push(brace1TagName);
  }
  boolean matched=false;
  while (true) {
    if (!forward) {
      iterator.retreat();
    }
 else {
      iterator.advance();
    }
    if (iterator.atEnd()) {
      break;
    }
    IElementType tokenType=iterator.getTokenType();
    if (getTokenGroup(tokenType,fileType) != group) {
      continue;
    }
    String tagName=myMatcher == null ? null : getTagName(myMatcher,fileText,iterator);
    if (!isStrict && !Comparing.equal(brace1TagName,tagName,isCaseSensitive))     continue;
    if (isStructural && (forward ? isRBraceToken(iterator,fileText,fileType) && !isPairBraces(brace1Token,tokenType,fileType) : isLBraceToken(iterator,fileText,fileType) && !isPairBraces(brace1Token,tokenType,fileType))) {
      if (!myBraceStack.isEmpty() && myMatcher != null && shouldStopMatching(tokenType)) {
        return false;
      }
    }
    if (forward ? isLBraceToken(iterator,fileText,fileType) : isRBraceToken(iterator,fileText,fileType)) {
      myBraceStack.push(tokenType);
      if (isStrict) {
        myTagNameStack.push(tagName);
      }
    }
 else     if (forward ? isRBraceToken(iterator,fileText,fileType) : isLBraceToken(iterator,fileText,fileType)) {
      IElementType topTokenType=myBraceStack.pop();
      String topTagName=null;
      if (isStrict) {
        topTagName=myTagNameStack.pop();
      }
      if (!isStrict && myMatcher != null && myBraceStack.contains(myMatcher.getOppositeBraceTokenType(tokenType))) {
        while (!isPairBraces(topTokenType,tokenType,fileType) && !myBraceStack.empty()) {
          topTokenType=myBraceStack.pop();
        }
      }
      if (!isPairBraces(topTokenType,tokenType,fileType) || isStrict && !Comparing.equal(topTagName,tagName,isCaseSensitive)) {
        matched=false;
        break;
      }
      if (myBraceStack.isEmpty()) {
        matched=true;
        break;
      }
    }
  }
  return matched;
}
