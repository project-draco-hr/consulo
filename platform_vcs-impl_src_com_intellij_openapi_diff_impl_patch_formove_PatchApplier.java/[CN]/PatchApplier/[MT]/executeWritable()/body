{
  final Application application=ApplicationManager.getApplication();
  final Ref<ApplyPatchStatus> refStatus=new Ref<ApplyPatchStatus>(ApplyPatchStatus.FAILURE);
  CommandProcessor.getInstance().executeCommand(myProject,new Runnable(){
    public void run(){
      final Boolean result=application.runWriteAction(new Computable<Boolean>(){
        @Override public Boolean compute(){
          return myVerifier.execute();
        }
      }
);
      if (!result) {
        return;
      }
      if (!makeWritable(myVerifier.getWritableFiles())) {
        return;
      }
      final List<Pair<VirtualFile,ApplyTextFilePatch>> textPatches=myVerifier.getTextPatches();
      if (!fileTypesAreOk(textPatches)) {
        return;
      }
      try {
        markInternalOperation(textPatches,true);
        final ApplyPatchStatus status=actualApply(myVerifier,myCommitContext);
        if (status != null) {
          refStatus.set(status);
        }
      }
  finally {
        markInternalOperation(textPatches,false);
      }
    }
  }
,VcsBundle.message("patch.apply.command"),null);
  return refStatus.get();
}
