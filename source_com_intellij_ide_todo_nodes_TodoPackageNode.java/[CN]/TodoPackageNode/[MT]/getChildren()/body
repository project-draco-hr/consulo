{
  ArrayList<AbstractTreeNode> children=new ArrayList<AbstractTreeNode>();
  final ProjectFileIndex projectFileIndex=ProjectRootManager.getInstance(getProject()).getFileIndex();
  final PsiPackage psiPackage=getValue().getPackage();
  final Module module=getValue().getModule();
  if (!getStructure().getIsFlattenPackages() || psiPackage == null) {
    final Iterator<PsiFile> iterator=myBuilder.getFiles(getValue());
    while (iterator.hasNext()) {
      final PsiFile psiFile=iterator.next();
      final Module psiFileModule=projectFileIndex.getModuleForFile(psiFile.getVirtualFile());
      if (module != null && psiFileModule != null && !module.equals(psiFileModule)) {
        continue;
      }
      final PsiDirectory containingDirectory=psiFile.getContainingDirectory();
      TodoFileNode todoFileNode=new TodoFileNode(getProject(),psiFile,myBuilder,false);
      if (ArrayUtil.find(psiPackage.getDirectories(),containingDirectory) > -1 && !children.contains(todoFileNode)) {
        children.add(todoFileNode);
        continue;
      }
      PsiDirectory _dir=psiFile.getContainingDirectory();
      while (_dir != null) {
        final PsiDirectory parentDirectory=_dir.getParentDirectory();
        if (parentDirectory != null) {
          PsiPackage _package=_dir.getPackage();
          TodoPackageNode todoPackageNode=new TodoPackageNode(getProject(),new PackageElement(module,_package,false),myBuilder);
          if (_package != null && _package.getParentPackage() != null && psiPackage.equals(_package.getParentPackage()) && !children.contains(todoPackageNode)) {
            children.add(todoPackageNode);
            break;
          }
        }
        _dir=parentDirectory;
      }
    }
    Collections.sort(children,TodoFileDirComparator.ourInstance);
  }
 else {
    final Iterator<PsiFile> iterator=myBuilder.getFiles(getValue());
    while (iterator.hasNext()) {
      final PsiFile psiFile=iterator.next();
      final Module psiFileModule=projectFileIndex.getModuleForFile(psiFile.getVirtualFile());
      if (module != null && psiFileModule != null && !module.equals(psiFileModule)) {
        continue;
      }
      final PsiDirectory _dir=psiFile.getContainingDirectory();
      TodoFileNode todoFileNode=new TodoFileNode(getProject(),psiFile,myBuilder,false);
      if (ArrayUtil.find(psiPackage.getDirectories(),_dir) > -1 && !children.contains(todoFileNode)) {
        children.add(todoFileNode);
        continue;
      }
      PsiPackage _package=_dir.getPackage();
      final PackageElement element=new PackageElement(module,_package,false);
      if (_package != null && !TodoPackageUtil.isPackageEmpty(element,myBuilder,getProject())) {
        TodoPackageNode todoPackageNode=new TodoPackageNode(getProject(),element,myBuilder);
        if (PsiTreeUtil.isAncestor(psiPackage,_package,true) && !children.contains(todoPackageNode)) {
          children.add(todoPackageNode);
          continue;
        }
      }
    }
    Collections.sort(children,TodoFileDirComparator.ourInstance);
  }
  return children;
}
