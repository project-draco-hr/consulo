{
  if (CodeInsightSettings.getInstance().SURROUND_SELECTION_ON_QUOTE_TYPED && editor.getSelectionModel().hasSelection() && isDelimiter(c)) {
    String selectedText=editor.getSelectionModel().getSelectedText();
    if (selectedText.length() < 1) {
      return super.checkAutoPopup(c,project,editor,psiFile);
    }
    if (selectedText.length() > 1) {
      final char firstChar=selectedText.charAt(0);
      if (isSimilarDelimiters(firstChar,c) && selectedText.charAt(selectedText.length() - 1) == getMatchingDelimiter(firstChar) && (isQuote(firstChar) || firstChar != c) && !shouldSkipReplacementOfQuotesOrBraces(psiFile,editor,selectedText,c)) {
        selectedText=selectedText.substring(1,selectedText.length() - 1);
      }
    }
    final int caretOffset=editor.getSelectionModel().getSelectionStart();
    final char c2=getMatchingDelimiter(c);
    final String newText=String.valueOf(c) + selectedText + c2;
    EditorModificationUtil.insertStringAtCaret(editor,newText);
    if (Registry.is("editor.smarterSelectionQuoting")) {
      myReplacedTextRange=new TextRange(caretOffset + 1,caretOffset + newText.length() - 1);
    }
 else {
      myReplacedTextRange=new TextRange(caretOffset,caretOffset + newText.length());
    }
    return Result.STOP;
  }
  return super.checkAutoPopup(c,project,editor,psiFile);
}
