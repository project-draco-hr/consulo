{
  LOG.assertTrue(myState == STATE_INITIAL,"State is invalid " + myState);
  DebuggerManagerThreadImpl.assertIsManagerThread();
  myPositionManager=createPositionManager();
  if (LOG.isDebugEnabled()) {
    LOG.debug("*******************VM attached******************");
  }
  checkVirtualMachineVersion(vm);
  myVirtualMachineProxy=new VirtualMachineProxyImpl(this,vm);
  myCanRedefineClasses=myVirtualMachineProxy.canRedefineClasses();
  myCanWatchFieldModification=myVirtualMachineProxy.canWatchFieldModification();
  String trace=System.getProperty("idea.debugger.trace");
  if (trace != null) {
    int mask=0;
    StringTokenizer tokenizer=new StringTokenizer(trace);
    while (tokenizer.hasMoreTokens()) {
      String token=tokenizer.nextToken();
      if ("SENDS".compareToIgnoreCase(token) == 0) {
        mask|=VirtualMachine.TRACE_SENDS;
      }
 else       if ("RECEIVES".compareToIgnoreCase(token) == 0) {
        mask|=VirtualMachine.TRACE_RECEIVES;
      }
 else       if ("EVENTS".compareToIgnoreCase(token) == 0) {
        mask|=VirtualMachine.TRACE_EVENTS;
      }
 else       if ("REFTYPES".compareToIgnoreCase(token) == 0) {
        mask|=VirtualMachine.TRACE_REFTYPES;
      }
 else       if ("OBJREFS".compareToIgnoreCase(token) == 0) {
        mask|=VirtualMachine.TRACE_OBJREFS;
      }
 else       if ("ALL".compareToIgnoreCase(token) == 0) {
        mask|=VirtualMachine.TRACE_ALL;
      }
    }
    vm.setDebugTraceMode(mask);
  }
}
