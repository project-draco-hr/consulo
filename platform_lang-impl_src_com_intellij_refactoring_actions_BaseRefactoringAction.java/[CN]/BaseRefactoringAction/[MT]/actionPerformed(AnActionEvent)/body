{
  DataContext dataContext=e.getDataContext();
  final Project project=e.getData(PlatformDataKeys.PROJECT);
  if (project == null)   return;
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  final Editor editor=e.getData(PlatformDataKeys.EDITOR);
  final PsiElement[] elements=getPsiElementArray(dataContext);
  int eventCount=IdeEventQueue.getInstance().getEventCount();
  RefactoringActionHandler handler;
  try {
    handler=getHandler(dataContext);
  }
 catch (  ProcessCanceledException e1) {
    return;
  }
  if (handler == null) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactoringBundle.getCannotRefactorMessage(RefactoringBundle.message("error.wrong.caret.position.symbol.to.refactor")),RefactoringBundle.getCannotRefactorMessage(null),null);
    return;
  }
  if (!InplaceRefactoring.canStartAnotherRefactoring(editor,project,handler,elements)) {
    InplaceRefactoring.unableToStartWarning(project,editor);
    return;
  }
  IdeEventQueue.getInstance().setEventCount(eventCount);
  if (editor != null) {
    final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return;
    DaemonCodeAnalyzer.getInstance(project).autoImportReferenceAtCursor(editor,file);
    handler.invoke(project,editor,file,dataContext);
  }
 else {
    handler.invoke(project,elements,dataContext);
  }
}
