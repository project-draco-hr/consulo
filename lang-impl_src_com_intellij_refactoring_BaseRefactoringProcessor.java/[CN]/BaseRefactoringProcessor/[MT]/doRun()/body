{
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  final Ref<UsageInfo[]> refUsages=new Ref<UsageInfo[]>();
  final Ref<Language> refErrorLanguage=new Ref<Language>();
  final Runnable findUsagesRunnable=new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          try {
            refUsages.set(findUsages());
          }
 catch (          UnknownReferenceTypeException e) {
            refErrorLanguage.set(e.getElementLanguage());
          }
        }
      }
);
    }
  }
;
  if (!ProgressManager.getInstance().runProcessWithProgressSynchronously(findUsagesRunnable,RefactoringBundle.message("progress.text"),true,myProject)) {
    return;
  }
  if (!refErrorLanguage.isNull()) {
    Messages.showErrorDialog(myProject,RefactoringBundle.message("unsupported.refs.found",refErrorLanguage.get().getDisplayName()),RefactoringBundle.message("error.title"));
    return;
  }
  if (!preprocessUsages(refUsages))   return;
  final UsageInfo[] usages=refUsages.get();
  UsageViewDescriptor descriptor=createUsageViewDescriptor(usages);
  boolean isPreview=isPreviewUsages(usages);
  if (!isPreview) {
    isPreview=!ensureElementsWritable(usages,descriptor) || UsageViewUtil.hasReadOnlyUsages(usages);
    if (isPreview) {
      WindowManager.getInstance().getStatusBar(myProject).setInfo(RefactoringBundle.message("readonly.occurences.found"));
    }
  }
  if (isPreview) {
    previewRefactoring(usages);
  }
 else {
    execute(usages);
  }
}
