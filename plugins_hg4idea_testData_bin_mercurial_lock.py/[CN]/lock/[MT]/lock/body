def lock(self):
    timeout = self.timeout
    while 1:
        try:
            self.trylock()
            return 1
        except error.LockHeld as inst:
            if (timeout != 0):
                time.sleep(1)
                if (timeout > 0):
                    timeout -= 1
                continue
            raise error.LockHeld(errno.ETIMEDOUT, inst.filename, self.desc, inst.locker)
