def checkinlinesize(self, tr, fp=None):
    if ((not self._inline) or ((self.start((-2)) + self.length((-2))) < _maxinline)):
        return
    trinfo = tr.find(self.indexfile)
    if (trinfo is None):
        raise RevlogError((_('%s not found in the transaction') % self.indexfile))
    trindex = trinfo[2]
    dataoff = self.start(trindex)
    tr.add(self.datafile, dataoff)
    if fp:
        fp.flush()
        fp.close()
    df = self.opener(self.datafile, 'w')
    try:
        for r in self:
            df.write(self._chunkraw(r, r))
    finally:
        df.close()
    fp = self.opener(self.indexfile, 'w', atomictemp=True)
    self.version &= (~ REVLOGNGINLINEDATA)
    self._inline = False
    for i in self:
        e = self._io.packentry(self.index[i], self.node, self.version, i)
        fp.write(e)
    fp.rename()
    tr.replace(self.indexfile, (trindex * self._io.size))
    self._chunkclear()
