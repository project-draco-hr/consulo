{
  final Holder<Object> defaultValue=new Holder<Object>();
  processSignature(signature);
  return new MethodVisitor(Opcodes.ASM4){
    @Override public void visitEnd(){
      if ((access & Opcodes.ACC_SYNTHETIC) == 0 || (access & Opcodes.ACC_BRIDGE) > 0) {
        methods.add(new MethodRepr(context,access,context.get(n),context.get(signature),desc,exceptions,defaultValue.get()));
      }
    }
    @Override public AnnotationVisitor visitAnnotation(    String desc,    boolean visible){
      return new AnnotationCrawler((TypeRepr.ClassType)TypeRepr.getType(context,context.get(desc)),"<init>".equals(n) ? ElemType.CONSTRUCTOR : ElemType.METHOD);
    }
    @Override public AnnotationVisitor visitAnnotationDefault(){
      return new AnnotationVisitor(Opcodes.ASM4){
        public void visit(        String name,        Object value){
          defaultValue.set(value);
        }
      }
;
    }
    @Override public AnnotationVisitor visitParameterAnnotation(    int parameter,    String desc,    boolean visible){
      return new AnnotationCrawler((TypeRepr.ClassType)TypeRepr.getType(context,context.get(desc)),ElemType.PARAMETER);
    }
    @Override public void visitLdcInsn(    Object cst){
      if (cst instanceof Type) {
        usages.addUsage(context.get(classNameHolder.get()),UsageRepr.createClassUsage(context,context.get(((Type)cst).getInternalName())));
      }
      super.visitLdcInsn(cst);
    }
    @Override public void visitMultiANewArrayInsn(    String desc,    int dims){
      final TypeRepr.ArrayType typ=(TypeRepr.ArrayType)TypeRepr.getType(context,context.get(desc));
      final TypeRepr.AbstractType element=typ.getDeepElementType();
      if (element instanceof TypeRepr.ClassType) {
        final int residence=context.get(classNameHolder.get());
        final int className=((TypeRepr.ClassType)element).className;
        usages.addUsage(residence,UsageRepr.createClassUsage(context,className));
        usages.addUsage(residence,UsageRepr.createClassNewUsage(context,className));
      }
      typ.updateClassUsages(context,name,usages);
      super.visitMultiANewArrayInsn(desc,dims);
    }
    @Override public void visitLocalVariable(    String n,    String desc,    String signature,    Label start,    Label end,    int index){
      processSignature(signature);
      TypeRepr.getType(context,context.get(desc)).updateClassUsages(context,name,usages);
      super.visitLocalVariable(n,desc,signature,start,end,index);
    }
    @Override public void visitTryCatchBlock(    Label start,    Label end,    Label handler,    String type){
      if (type != null) {
        TypeRepr.createClassType(context,context.get(type)).updateClassUsages(context,name,usages);
      }
      super.visitTryCatchBlock(start,end,handler,type);
    }
    @Override public void visitTypeInsn(    int opcode,    String type){
      final TypeRepr.AbstractType typ=type.startsWith("[") ? TypeRepr.getType(context,context.get(type)) : TypeRepr.createClassType(context,context.get(type));
      if (opcode == Opcodes.NEW) {
        final int residence=context.get(classNameHolder.get());
        usages.addUsage(residence,UsageRepr.createClassUsage(context,((TypeRepr.ClassType)typ).className));
        usages.addUsage(residence,UsageRepr.createClassNewUsage(context,((TypeRepr.ClassType)typ).className));
      }
 else       if (opcode == Opcodes.ANEWARRAY) {
        if (typ instanceof TypeRepr.ClassType) {
          final int residence=context.get(classNameHolder.get());
          usages.addUsage(residence,UsageRepr.createClassUsage(context,((TypeRepr.ClassType)typ).className));
          usages.addUsage(residence,UsageRepr.createClassNewUsage(context,((TypeRepr.ClassType)typ).className));
        }
      }
      typ.updateClassUsages(context,name,usages);
      super.visitTypeInsn(opcode,type);
    }
    @Override public void visitFieldInsn(    int opcode,    String owner,    String name,    String desc){
      final int residence=context.get(classNameHolder.get());
      final int fieldName=context.get(name);
      final int fieldOwner=context.get(owner);
      final int descr=context.get(desc);
      if (opcode == Opcodes.PUTFIELD || opcode == Opcodes.PUTSTATIC) {
        usages.addUsage(residence,UsageRepr.createFieldAssignUsage(context,fieldName,fieldOwner,descr));
      }
      usages.addUsage(residence,UsageRepr.createFieldUsage(context,fieldName,fieldOwner,descr));
      super.visitFieldInsn(opcode,owner,name,desc);
    }
    @Override public void visitMethodInsn(    int opcode,    String owner,    String name,    String desc){
      final int residence=context.get(classNameHolder.get());
      final int methodName=context.get(name);
      final int methodOwner=context.get(owner);
      usages.addUsage(residence,UsageRepr.createMethodUsage(context,methodName,methodOwner,desc));
      usages.addUsage(residence,UsageRepr.createMetaMethodUsage(context,methodName,methodOwner,desc));
      super.visitMethodInsn(opcode,owner,name,desc);
    }
  }
;
}
