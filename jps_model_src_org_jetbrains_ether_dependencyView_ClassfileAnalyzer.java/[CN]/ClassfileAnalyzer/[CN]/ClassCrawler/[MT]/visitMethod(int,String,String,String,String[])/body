{
  final Holder<Object> defaultValue=new Holder<Object>();
  processSignature(signature);
  return new MethodVisitor(Opcodes.ASM4){
    @Override public void visitEnd(){
      if ((access & Opcodes.ACC_SYNTHETIC) == 0 || (access & Opcodes.ACC_BRIDGE) > 0) {
        myMethods.add(new MethodRepr(myContext,access,myContext.get(n),myContext.get(signature),desc,exceptions,defaultValue.get()));
      }
    }
    @Override public AnnotationVisitor visitAnnotation(    String desc,    boolean visible){
      return new AnnotationCrawler((TypeRepr.ClassType)TypeRepr.getType(myContext,myContext.get(desc)),"<init>".equals(n) ? ElemType.CONSTRUCTOR : ElemType.METHOD);
    }
    @Override public AnnotationVisitor visitAnnotationDefault(){
      return new AnnotationVisitor(Opcodes.ASM4){
        public void visit(        String name,        Object value){
          defaultValue.set(value);
        }
      }
;
    }
    @Override public AnnotationVisitor visitParameterAnnotation(    int parameter,    String desc,    boolean visible){
      return new AnnotationCrawler((TypeRepr.ClassType)TypeRepr.getType(myContext,myContext.get(desc)),ElemType.PARAMETER);
    }
    @Override public void visitLdcInsn(    Object cst){
      if (cst instanceof Type) {
        myUsages.addUsage(myContext.get(myClassNameHolder.get()),UsageRepr.createClassUsage(myContext,myContext.get(((Type)cst).getInternalName())));
      }
      super.visitLdcInsn(cst);
    }
    @Override public void visitMultiANewArrayInsn(    String desc,    int dims){
      final TypeRepr.ArrayType typ=(TypeRepr.ArrayType)TypeRepr.getType(myContext,myContext.get(desc));
      final TypeRepr.AbstractType element=typ.getDeepElementType();
      if (element instanceof TypeRepr.ClassType) {
        final int residence=myContext.get(myClassNameHolder.get());
        final int className=((TypeRepr.ClassType)element).className;
        myUsages.addUsage(residence,UsageRepr.createClassUsage(myContext,className));
        myUsages.addUsage(residence,UsageRepr.createClassNewUsage(myContext,className));
      }
      typ.updateClassUsages(myContext,myName,myUsages);
      super.visitMultiANewArrayInsn(desc,dims);
    }
    @Override public void visitLocalVariable(    String n,    String desc,    String signature,    Label start,    Label end,    int index){
      processSignature(signature);
      TypeRepr.getType(myContext,myContext.get(desc)).updateClassUsages(myContext,myName,myUsages);
      super.visitLocalVariable(n,desc,signature,start,end,index);
    }
    @Override public void visitTryCatchBlock(    Label start,    Label end,    Label handler,    String type){
      if (type != null) {
        TypeRepr.createClassType(myContext,myContext.get(type)).updateClassUsages(myContext,myName,myUsages);
      }
      super.visitTryCatchBlock(start,end,handler,type);
    }
    @Override public void visitTypeInsn(    int opcode,    String type){
      final TypeRepr.AbstractType typ=type.startsWith("[") ? TypeRepr.getType(myContext,myContext.get(type)) : TypeRepr.createClassType(myContext,myContext.get(type));
      if (opcode == Opcodes.NEW) {
        final int residence=myContext.get(myClassNameHolder.get());
        myUsages.addUsage(residence,UsageRepr.createClassUsage(myContext,((TypeRepr.ClassType)typ).className));
        myUsages.addUsage(residence,UsageRepr.createClassNewUsage(myContext,((TypeRepr.ClassType)typ).className));
      }
 else       if (opcode == Opcodes.ANEWARRAY) {
        if (typ instanceof TypeRepr.ClassType) {
          final int residence=myContext.get(myClassNameHolder.get());
          myUsages.addUsage(residence,UsageRepr.createClassUsage(myContext,((TypeRepr.ClassType)typ).className));
          myUsages.addUsage(residence,UsageRepr.createClassNewUsage(myContext,((TypeRepr.ClassType)typ).className));
        }
      }
      typ.updateClassUsages(myContext,myName,myUsages);
      super.visitTypeInsn(opcode,type);
    }
    @Override public void visitFieldInsn(    int opcode,    String owner,    String name,    String desc){
      final int residence=myContext.get(myClassNameHolder.get());
      final int fieldName=myContext.get(name);
      final int fieldOwner=myContext.get(owner);
      final int descr=myContext.get(desc);
      if (opcode == Opcodes.PUTFIELD || opcode == Opcodes.PUTSTATIC) {
        myUsages.addUsage(residence,UsageRepr.createFieldAssignUsage(myContext,fieldName,fieldOwner,descr));
      }
      myUsages.addUsage(residence,UsageRepr.createFieldUsage(myContext,fieldName,fieldOwner,descr));
      super.visitFieldInsn(opcode,owner,name,desc);
    }
    @Override public void visitMethodInsn(    int opcode,    String owner,    String name,    String desc){
      final int residence=myContext.get(myClassNameHolder.get());
      final int methodName=myContext.get(name);
      final int methodOwner=myContext.get(owner);
      myUsages.addUsage(residence,UsageRepr.createMethodUsage(myContext,methodName,methodOwner,desc));
      myUsages.addUsage(residence,UsageRepr.createMetaMethodUsage(myContext,methodName,methodOwner,desc));
      super.visitMethodInsn(opcode,owner,name,desc);
    }
  }
;
}
