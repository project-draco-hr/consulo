{
  VirtualFile vFile=file.getVirtualFile();
  FileType fileType;
  if (file instanceof PsiCodeFragment) {
    fileType=StdFileTypes.JAVA;
  }
 else {
    fileType=FileTypeManager.getInstance().getFileTypeByFile(vFile);
  }
  if (fileType == StdFileTypes.XML) {
    return TemplateContext.XML_CONTEXT;
  }
  if (fileType == StdFileTypes.HTML) {
    return TemplateContext.HTML_CONTEXT;
  }
  if (fileType == StdFileTypes.JSP || fileType == StdFileTypes.JSPX) {
    return TemplateContext.JSP_CONTEXT;
  }
  if (fileType == StdFileTypes.JAVA) {
    PsiElement element=file.findElementAt(offset);
    if (isInComment(element)) {
      return TemplateContext.JAVA_COMMENT_CONTEXT;
    }
    if (element instanceof PsiJavaToken) {
      if (((PsiJavaToken)element).getTokenType() == JavaTokenType.STRING_LITERAL) {
        return TemplateContext.JAVA_STRING_CONTEXT;
      }
    }
    return TemplateContext.JAVA_CODE_CONTEXT;
  }
  return TemplateContext.OTHER_CONTEXT;
}
