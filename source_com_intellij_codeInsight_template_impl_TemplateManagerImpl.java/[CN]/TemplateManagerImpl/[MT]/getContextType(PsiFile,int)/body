{
  VirtualFile vFile=file.getVirtualFile();
  FileType fileType;
  if (file instanceof PsiCodeFragment) {
    fileType=StdFileTypes.JAVA;
  }
 else {
    fileType=FileTypeManager.getInstance().getFileTypeByFile(vFile);
  }
  if (fileType == StdFileTypes.XML) {
    return TemplateContext.XML_CONTEXT;
  }
  if (fileType == StdFileTypes.HTML) {
    return TemplateContext.HTML_CONTEXT;
  }
  if (fileType == StdFileTypes.PLAIN_TEXT) {
    return TemplateContext.OTHER_CONTEXT;
  }
  PsiElement element=file.findElementAt(offset);
  if (fileType == StdFileTypes.JSP) {
    PsiElement parent=element;
    while (parent != null && !(parent instanceof JspExpression) && !(parent instanceof JspDeclaration)) {
      parent=parent.getParent();
    }
    if (parent == null && JspUtil.getContainingScriptletStart(element) == null) {
      return TemplateContext.JSP_CONTEXT;
    }
  }
  if (isInComment(element)) {
    return TemplateContext.JAVA_COMMENT_CONTEXT;
  }
  if (element instanceof PsiJavaToken) {
    if (((PsiJavaToken)element).getTokenType() == JavaTokenType.STRING_LITERAL) {
      return TemplateContext.JAVA_STRING_CONTEXT;
    }
  }
  return TemplateContext.JAVA_CODE_CONTEXT;
}
