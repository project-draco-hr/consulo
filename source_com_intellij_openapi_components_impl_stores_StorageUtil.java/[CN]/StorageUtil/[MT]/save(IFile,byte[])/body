{
  final String filePath=file.getCanonicalPath();
  try {
    final Ref<IOException> refIOException=Ref.create(null);
    if (file.exists()) {
      final byte[] bytes=file.loadBytes();
      if (Arrays.equals(bytes,text))       return;
      IFile backupFile=deleteBackup(filePath);
      file.renameTo(backupFile);
    }
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        if (!file.exists()) {
          file.createParentDirs();
        }
        try {
          getOrCreateVirtualFile(file,file).setBinaryContent(text);
        }
 catch (        IOException e) {
          refIOException.set(e);
        }
        deleteBackup(filePath);
      }
    }
);
    if (refIOException.get() != null) {
      throw new StateStorage.StateStorageException(refIOException.get());
    }
  }
 catch (  StateStorage.StateStorageException e) {
    throw new StateStorage.StateStorageException(e);
  }
catch (  IOException e) {
    throw new StateStorage.StateStorageException(e);
  }
}
