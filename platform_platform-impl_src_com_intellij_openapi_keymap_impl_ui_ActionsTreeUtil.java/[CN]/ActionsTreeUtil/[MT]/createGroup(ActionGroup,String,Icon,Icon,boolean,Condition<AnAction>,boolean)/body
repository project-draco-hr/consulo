{
  ActionManager actionManager=ActionManager.getInstance();
  Group group=new Group(groupName,actionManager.getId(actionGroup),icon);
  AnAction[] children=actionGroup instanceof DefaultActionGroup ? ((DefaultActionGroup)actionGroup).getChildActionsOrStubs() : actionGroup.getChildren(null);
  for (int i=0; i < children.length; i++) {
    AnAction action=children[i];
    LOG.assertTrue(action != null,groupName + " contains null actions");
    if (action instanceof ActionGroup) {
      Group subGroup=createGroup((ActionGroup)action,getName(action),null,null,ignore,filtered,normalizeSeparators);
      if (subGroup.getSize() > 0) {
        if (!ignore && !((ActionGroup)action).isPopup()) {
          group.addAll(subGroup);
        }
 else {
          group.addGroup(subGroup);
        }
      }
 else       if (filtered == null || filtered.value(actionGroup)) {
        group.addGroup(subGroup);
      }
    }
 else     if (action instanceof AnSeparator) {
      group.addSeparator();
    }
 else     if (action != null) {
      String id=action instanceof ActionStub ? ((ActionStub)action).getId() : actionManager.getId(action);
      if (id != null) {
        if (id.startsWith(TOOL_ACTION_PREFIX))         continue;
        if (filtered == null || filtered.value(action)) {
          group.addActionId(id);
        }
      }
    }
  }
  if (normalizeSeparators)   group.normalizeSeparators();
  return group;
}
