{
  final ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  final String presentableUrl=libraryInfo.getPresentableUrl();
  final String url=libraryInfo.getDownloadUrl();
  if (url.startsWith(LIB_SCHEMA)) {
    indicator.setText2(IdeBundle.message("progress.locate.jar.text",getExpectedFileName(libraryInfo)));
    final String path=url.substring(LIB_SCHEMA.length()).replace('/',File.separatorChar);
    final File file=PathManager.findFileInLibDirectory(path);
    downloadedFiles.add(Pair.create(libraryInfo,file));
  }
 else   if (url.startsWith(LocalFileSystem.PROTOCOL_PREFIX)) {
    String path=url.substring(LocalFileSystem.PROTOCOL_PREFIX.length()).replace('/',File.separatorChar).replace('\\',File.separatorChar);
    File file=new File(path);
    if (file.exists())     downloadedFiles.add(Pair.create(libraryInfo,file));
  }
 else {
    indicator.setText2(IdeBundle.message("progress.connecting.to.dowload.jar.text",presentableUrl));
    indicator.setIndeterminate(true);
    HttpURLConnection connection=(HttpURLConnection)new URL(url).openConnection();
    connection.setConnectTimeout(CONNECTION_TIMEOUT);
    connection.setReadTimeout(READ_TIMEOUT);
    InputStream input=null;
    BufferedOutputStream output=null;
    boolean deleteFile=true;
    File tempFile=null;
    try {
      final int responseCode=connection.getResponseCode();
      if (responseCode != HttpURLConnection.HTTP_OK) {
        throw new IOException(IdeBundle.message("error.connection.failed.with.http.code.N",responseCode));
      }
      final int size=connection.getContentLength();
      if (size != -1 && size == existingFileSize) {
        return false;
      }
      tempFile=FileUtil.createTempFile("downloaded","jar");
      input=UrlConnectionUtil.getConnectionInputStreamWithException(connection,indicator);
      output=new BufferedOutputStream(new FileOutputStream(tempFile));
      indicator.setText2(IdeBundle.message("progress.download.jar.text",getExpectedFileName(libraryInfo),presentableUrl));
      indicator.setIndeterminate(size == -1);
      int len;
      final byte[] buf=new byte[1024];
      int count=0;
      while ((len=input.read(buf)) > 0) {
        indicator.checkCanceled();
        count+=len;
        if (size > 0) {
          indicator.setFraction((double)count / size);
        }
        output.write(buf,0,len);
      }
      deleteFile=false;
      downloadedFiles.add(Pair.create(libraryInfo,tempFile));
    }
  finally {
      if (input != null) {
        input.close();
      }
      if (output != null) {
        output.close();
      }
      if (deleteFile && tempFile != null) {
        FileUtil.delete(tempFile);
      }
      connection.disconnect();
    }
  }
  return true;
}
