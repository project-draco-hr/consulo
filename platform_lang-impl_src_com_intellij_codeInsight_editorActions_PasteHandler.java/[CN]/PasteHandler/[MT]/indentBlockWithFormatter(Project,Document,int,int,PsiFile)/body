{
  CharSequence chars=document.getCharsSequence();
  final int firstLine=document.getLineNumber(startOffset);
  final int firstLineStart=document.getLineStartOffset(firstLine);
  boolean saveLastLineIndent=false;
  for (int i=endOffset - 1; i >= startOffset; i--) {
    final char c=chars.charAt(i);
    if (c == '\n') {
      saveLastLineIndent=true;
      break;
    }
    if (c != ' ' && c != '\t') {
      break;
    }
  }
  final int lastLine;
  if (saveLastLineIndent) {
    lastLine=document.getLineNumber(endOffset) - 1;
    int start=document.getLineStartOffset(lastLine + 1);
    if (start < endOffset) {
      int i=CharArrayUtil.shiftForward(chars,start," \t");
      if (i > start) {
        i=Math.min(i,endOffset);
        document.deleteString(start,i);
      }
    }
    int indentToKeepEndOffset=Math.min(startOffset,CharArrayUtil.shiftForward(chars,firstLineStart," \t"));
    if (indentToKeepEndOffset > firstLineStart) {
      document.insertString(start,chars.subSequence(firstLineStart,indentToKeepEndOffset));
    }
  }
 else {
    lastLine=document.getLineNumber(endOffset);
  }
  final int i=CharArrayUtil.shiftBackward(chars,startOffset - 1," \t");
  if (chars.charAt(startOffset) != '\n' && i > 0 && chars.charAt(i) != '\n') {
    int firstNonWsOffset=CharArrayUtil.shiftForward(chars,firstLineStart," \t");
    if (firstNonWsOffset > firstLineStart) {
      CharSequence toInsert=chars.subSequence(firstLineStart,firstNonWsOffset);
      for (int line=firstLine + 1; line <= lastLine; line++) {
        document.insertString(document.getLineStartOffset(line),toInsert);
      }
    }
    return;
  }
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  if (file == null) {
    return;
  }
  CodeStyleManager codeStyleManager=CodeStyleManager.getInstance(project);
  final int j=CharArrayUtil.shiftForward(chars,startOffset," \t\n");
  if (j >= endOffset) {
    return;
  }
  final int anchorLine=document.getLineNumber(j);
  final int anchorLineStart=document.getLineStartOffset(anchorLine);
  codeStyleManager.adjustLineIndent(file,j);
  if (anchorLine == firstLine && j == startOffset) {
    int indentOffset=CharArrayUtil.shiftForward(chars,firstLineStart," \t");
    if (indentOffset > firstLineStart) {
      CharSequence toInsert=chars.subSequence(firstLineStart,indentOffset);
      for (int line=firstLine + 1; line <= lastLine; line++) {
        document.insertString(document.getLineStartOffset(line),toInsert);
      }
    }
    return;
  }
  final int firstNonWsOffset=CharArrayUtil.shiftForward(chars,anchorLineStart," \t");
  final int diff=firstNonWsOffset - j;
  if (diff == 0) {
    return;
  }
  if (diff > 0) {
    CharSequence toInsert=chars.subSequence(anchorLineStart,anchorLineStart + diff);
    for (int line=anchorLine + 1; line <= lastLine; line++) {
      document.insertString(document.getLineStartOffset(line),toInsert);
    }
    return;
  }
  if (anchorLine == firstLine && -diff == startOffset - firstLineStart) {
    return;
  }
  if (anchorLine != firstLine || -diff > startOffset - firstLineStart) {
    final int desiredSymbolsToRemove;
    if (anchorLine == firstLine) {
      desiredSymbolsToRemove=-diff - (startOffset - firstLineStart);
    }
 else {
      desiredSymbolsToRemove=-diff;
    }
    for (int line=anchorLine + 1; line <= lastLine; line++) {
      int currentLineStart=document.getLineStartOffset(line);
      int currentLineIndentOffset=CharArrayUtil.shiftForward(chars,currentLineStart," \t");
      int symbolsToRemove=Math.min(currentLineIndentOffset - currentLineStart,desiredSymbolsToRemove);
      if (symbolsToRemove > 0) {
        document.deleteString(currentLineStart,currentLineStart + symbolsToRemove);
      }
    }
  }
 else {
    CharSequence toInsert=chars.subSequence(anchorLineStart,j + diff);
    for (int line=anchorLine + 1; line <= lastLine; line++) {
      document.insertString(document.getLineStartOffset(line),toInsert);
    }
  }
}
