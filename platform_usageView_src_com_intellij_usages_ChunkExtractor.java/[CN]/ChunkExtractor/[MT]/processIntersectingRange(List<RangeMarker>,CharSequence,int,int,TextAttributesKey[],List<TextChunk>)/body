{
  TextAttributes originalAttrs=convertAttributes(tokenHighlights);
  int lastOffset=hiStart;
  for (  RangeMarker rangeMarker : markers) {
    int usageStart=rangeMarker.getStartOffset();
    int usageEnd=rangeMarker.getEndOffset();
    if (rangeMarker.isValid() && rangeIntersect(lastOffset,hiEnd,usageStart,usageEnd)) {
      addChunk(chars,lastOffset,Math.max(lastOffset,usageStart),originalAttrs,false,result);
      addChunk(chars,Math.max(lastOffset,usageStart),Math.min(hiEnd,usageEnd),originalAttrs,true,result);
      if (usageEnd > hiEnd) {
        return;
      }
      lastOffset=usageEnd;
    }
  }
  if (lastOffset < hiEnd) {
    addChunk(chars,lastOffset,hiEnd,originalAttrs,false,result);
  }
}
