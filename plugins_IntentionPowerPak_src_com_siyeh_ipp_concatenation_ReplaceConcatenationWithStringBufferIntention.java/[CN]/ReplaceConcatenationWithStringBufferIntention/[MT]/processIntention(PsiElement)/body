{
  PsiBinaryExpression exp=(PsiBinaryExpression)element;
  PsiElement parent=exp.getParent();
  while (ConcatenationUtils.isConcatenation(parent)) {
    exp=(PsiBinaryExpression)parent;
    parent=exp.getParent();
  }
  final String text=exp.getText();
  final StringBuffer expString=new StringBuffer(text.length() * 3);
  if (isPartOfStringBufferAppend(exp)) {
    final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)parent.getParent();
    final PsiReferenceExpression methodExpression=methodCallExpression.getMethodExpression();
    final PsiExpression qualifierExpression=methodExpression.getQualifierExpression();
    final String qualifierText=qualifierExpression.getText();
    expString.append(qualifierText);
    turnExpressionIntoChainedAppends(exp,expString);
    final String newExpression=expString.toString();
    replaceExpression(newExpression,methodCallExpression);
  }
 else {
    final PsiManager manager=exp.getManager();
    final LanguageLevel languageLevel=manager.getEffectiveLanguageLevel();
    if (languageLevel.equals(LanguageLevel.JDK_1_3) || languageLevel.equals(LanguageLevel.JDK_1_4)) {
      expString.append("new StringBuffer()");
    }
 else {
      expString.append("new StringBuilder()");
    }
    turnExpressionIntoChainedAppends(exp,expString);
    expString.append(".toString()");
    final String newExpression=expString.toString();
    replaceExpression(newExpression,exp);
  }
}
