{
  int lineStartOffset=document.getLineStartOffset(line);
  int lineEndOffset=document.getLineEndOffset(line);
  if (columnCache == null) {
    int result=lineStartOffset + logicalColumn;
    return result < 0 || result > lineEndOffset ? lineEndOffset : result;
  }
  int pos=Arrays.binarySearch(columnCache,logicalColumn);
  if (pos >= 0)   return lineStartOffset + (pos + 1) * CACHE_FREQUENCY;
  int startOffset=lineStartOffset + (-pos - 1) * CACHE_FREQUENCY;
  int column=pos == -1 ? 0 : columnCache[-pos - 2];
  CharSequence text=document.getImmutableCharSequence();
  for (int i=startOffset; i < lineEndOffset; i++) {
    if (text.charAt(i) == '\t') {
      column=(column / tabSize + 1) * tabSize;
    }
 else {
      column++;
    }
    if (logicalColumn < column)     return i;
  }
  return lineEndOffset;
}
