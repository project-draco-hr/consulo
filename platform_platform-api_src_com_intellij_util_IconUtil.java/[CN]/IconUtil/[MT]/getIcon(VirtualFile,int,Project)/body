{
  Icon lastIcon=file.getUserData(LAST_FILE_ICON);
  return IconDeferrer.getInstance().defer(lastIcon != null ? lastIcon : file.getIcon(),new FileIconKey(file,project,flags),new Function<FileIconKey,Icon>(){
    public Icon fun(    final FileIconKey key){
      VirtualFile file=key.getFile();
      int flags=key.getFlags();
      Project project=key.getProject();
      if (!file.isValid() || project != null && project.isDisposed())       return null;
      Icon providersIcon=getProvidersIcon(file,flags,project);
      Icon icon=providersIcon == null ? file.getIcon() : providersIcon;
      final boolean dumb=project != null && DumbService.getInstance(project).isDumb();
      for (      FileIconPatcher patcher : getPatchers()) {
        if (dumb && !(patcher instanceof DumbAware)) {
          continue;
        }
        icon=patcher.patchIcon(icon,file,flags,project);
      }
      if ((flags & Iconable.ICON_FLAG_READ_STATUS) != 0 && !file.isWritable()) {
        icon=new LayeredIcon(icon,Icons.LOCKED_ICON);
      }
      file.putUserData(LAST_FILE_ICON,icon);
      return icon;
    }
  }
);
}
