def fill(text, width):
    'fill many paragraphs.'
    global para_re, space_re
    if (para_re is None):
        para_re = re.compile('(\n\n|\n\\s*[-*]\\s*)', re.M)
        space_re = re.compile('  +')

    def findparas():
        start = 0
        while True:
            m = para_re.search(text, start)
            if (not m):
                w = len(text)
                while ((w > start) and text[(w - 1)].isspace()):
                    w -= 1
                yield (text[start:w], text[w:])
                break
            yield (text[start:m.start(0)], m.group(1))
            start = m.end(1)
    return ''.join([(space_re.sub(' ', textwrap.fill(para, width)) + rest) for (para, rest) in findparas()])
