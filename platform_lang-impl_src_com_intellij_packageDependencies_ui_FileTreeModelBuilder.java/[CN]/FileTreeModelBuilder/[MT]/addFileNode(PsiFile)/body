{
  boolean isMarked=myMarker != null && myMarker.isMarked(file);
  if (!isMarked)   return null;
  final VirtualFile vFile=file.getVirtualFile();
  LOG.assertTrue(vFile != null);
  PsiDirectory dirToReload=file.getContainingDirectory();
  PackageDependenciesNode rootToReload=myModuleDirNodes.get(dirToReload);
  if (rootToReload == null && myFlattenPackages) {
    final Module module=myFileIndex.getModuleForFile(vFile);
    final boolean moduleNodeExist=myModuleNodes.get(module) != null;
    rootToReload=getModuleNode(module);
    if (!moduleNodeExist) {
      rootToReload=null;
    }
  }
 else {
    while (rootToReload == null && dirToReload != null) {
      dirToReload=dirToReload.getParentDirectory();
      rootToReload=myModuleDirNodes.get(dirToReload);
    }
  }
  PackageDependenciesNode dirNode=getFileParentNode(file);
  dirNode.add(new FileNode(file,isMarked));
  return rootToReload;
}
