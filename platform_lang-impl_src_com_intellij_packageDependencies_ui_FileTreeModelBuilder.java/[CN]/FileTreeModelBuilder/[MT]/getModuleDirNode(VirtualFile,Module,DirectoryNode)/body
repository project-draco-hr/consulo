{
  if (virtualFile == null) {
    return getModuleNode(module);
  }
  PackageDependenciesNode directoryNode=myModuleDirNodes.get(virtualFile);
  if (directoryNode != null) {
    if (myCompactEmptyMiddlePackages) {
      DirectoryNode nestedNode=((DirectoryNode)directoryNode).getCompactedDirNode();
      if (nestedNode != null) {
        DirectoryNode parentWrapper=nestedNode.getWrapper();
        while (parentWrapper.getWrapper() != null) {
          parentWrapper=parentWrapper.getWrapper();
        }
        for (int i=parentWrapper.getChildCount() - 1; i >= 0; i--) {
          nestedNode.add((MutableTreeNode)parentWrapper.getChildAt(i));
        }
        ((DirectoryNode)directoryNode).setCompactedDirNode(null);
        parentWrapper.add(nestedNode);
        nestedNode.removeUpReference();
        return parentWrapper;
      }
      if (directoryNode.getParent() == null) {
        DirectoryNode parentWrapper=((DirectoryNode)directoryNode).getWrapper();
        if (parentWrapper != null) {
          while (parentWrapper.getWrapper() != null) {
            parentWrapper=parentWrapper.getWrapper();
          }
          return parentWrapper;
        }
      }
    }
    return directoryNode;
  }
  final ProjectFileIndex fileIndex=ProjectRootManager.getInstance(myProject).getFileIndex();
  final VirtualFile sourceRoot=fileIndex.getSourceRootForFile(virtualFile);
  final VirtualFile contentRoot=fileIndex.getContentRootForFile(virtualFile);
  directoryNode=new DirectoryNode(virtualFile,myProject,myCompactEmptyMiddlePackages,myFlattenPackages);
  myModuleDirNodes.put(virtualFile,(DirectoryNode)directoryNode);
  final VirtualFile directory=virtualFile.getParent();
  if (!myFlattenPackages && directory != null) {
    if (myCompactEmptyMiddlePackages && sourceRoot != virtualFile && contentRoot != virtualFile) {
      ((DirectoryNode)directoryNode).setCompactedDirNode(childNode);
    }
    if (fileIndex.getModuleForFile(directory) == module) {
      DirectoryNode parentDirectoryNode=myModuleDirNodes.get(directory);
      if (parentDirectoryNode != null || !myCompactEmptyMiddlePackages || directory == sourceRoot || directory == contentRoot) {
        getModuleDirNode(directory,module,(DirectoryNode)directoryNode).add(directoryNode);
      }
 else {
        directoryNode=getModuleDirNode(directory,module,(DirectoryNode)directoryNode);
      }
    }
 else {
      getModuleNode(module).add(directoryNode);
    }
  }
 else {
    if (contentRoot == virtualFile) {
      getModuleNode(module).add(directoryNode);
    }
 else {
      final VirtualFile root;
      if (sourceRoot != virtualFile && sourceRoot != null) {
        root=sourceRoot;
      }
 else       if (contentRoot != null) {
        root=contentRoot;
      }
 else {
        root=null;
      }
      if (root != null) {
        getModuleDirNode(root,module,null).add(directoryNode);
      }
    }
  }
  return directoryNode;
}
