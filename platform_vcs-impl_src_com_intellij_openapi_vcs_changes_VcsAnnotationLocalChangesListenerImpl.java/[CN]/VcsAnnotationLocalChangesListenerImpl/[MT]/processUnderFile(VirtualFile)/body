{
  final MultiMap<VirtualFile,FileAnnotation> annotations=new MultiMap<>();
synchronized (myLock) {
    for (    VirtualFile virtualFile : myFileAnnotationMap.keySet()) {
      if (VfsUtilCore.isAncestor(file,virtualFile,true)) {
        final Collection<FileAnnotation> values=myFileAnnotationMap.get(virtualFile);
        for (        FileAnnotation value : values) {
          annotations.putValue(virtualFile,value);
        }
      }
    }
  }
  if (!annotations.isEmpty()) {
    for (    Map.Entry<VirtualFile,Collection<FileAnnotation>> entry : annotations.entrySet()) {
      final VirtualFile key=entry.getKey();
      final VcsRevisionNumber number=fromDiffProvider(key);
      if (number == null)       continue;
      final Collection<FileAnnotation> fileAnnotations=entry.getValue();
      for (      FileAnnotation annotation : fileAnnotations) {
        if (annotation.isBaseRevisionChanged(number)) {
          annotation.close();
        }
      }
    }
  }
}
