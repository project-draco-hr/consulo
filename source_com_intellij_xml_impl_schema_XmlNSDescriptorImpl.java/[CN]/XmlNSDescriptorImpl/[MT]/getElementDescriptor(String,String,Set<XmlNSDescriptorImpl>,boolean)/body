{
  if (visited.contains(this))   return null;
  final Pair<String,String> pair=new Pair<String,String>(namespace,localName);
  final CachedValue<XmlElementDescriptor> descriptor=myDescriptorsMap.get(pair);
  if (descriptor != null) {
    final XmlElementDescriptor value=descriptor.getValue();
    if (value == null || value.getDeclaration().isValid())     return value;
  }
  final XmlTag rootTag=myTag;
  if (rootTag == null)   return null;
  XmlTag[] tags=rootTag.getSubTags();
  visited.add(this);
  for (  final XmlTag tag : tags) {
    if (equalsToSchemaName(tag,ELEMENT_TAG_NAME)) {
      String name=tag.getAttributeValue("name");
      if (name != null) {
        if (checkElementNameEquivalence(localName,namespace,name,tag)) {
          final CachedValue<XmlElementDescriptor> cachedValue=tag.getManager().getCachedValuesManager().createCachedValue(new CachedValueProvider<XmlElementDescriptor>(){
            public Result<XmlElementDescriptor> compute(){
              final String name=tag.getAttributeValue("name");
              if (name != null && !name.equals(pair.second)) {
                myDescriptorsMap.remove(pair);
                return new Result<XmlElementDescriptor>(null);
              }
              final XmlElementDescriptor xmlElementDescriptor=createElementDescriptor(tag);
              return new Result<XmlElementDescriptor>(xmlElementDescriptor,xmlElementDescriptor.getDependences());
            }
          }
,false);
          myDescriptorsMap.put(pair,cachedValue);
          return cachedValue.getValue();
        }
      }
    }
 else     if (equalsToSchemaName(tag,"include") || (reference && equalsToSchemaName(tag,"import") && namespace.equals(tag.getAttributeValue("namespace")))) {
      final XmlAttribute schemaLocation=tag.getAttribute("schemaLocation",tag.getNamespace());
      if (schemaLocation != null) {
        final XmlFile xmlFile=XmlUtil.findXmlFile(rootTag.getContainingFile(),schemaLocation.getValue());
        if (xmlFile != null) {
          final XmlDocument includedDocument=xmlFile.getDocument();
          if (includedDocument != null) {
            final PsiMetaDataBase data=includedDocument.getMetaData();
            if (data instanceof XmlNSDescriptorImpl) {
              final XmlElementDescriptor elementDescriptor=((XmlNSDescriptorImpl)data).getElementDescriptor(localName,namespace,visited,reference);
              if (elementDescriptor != null) {
                return elementDescriptor;
              }
            }
          }
        }
      }
    }
  }
  return null;
}
