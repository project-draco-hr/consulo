{
  PsiElement parent=tag.getParent();
  final String namespace=tag.getNamespace();
  while (parent instanceof XmlTag && !namespace.equals(((XmlTag)parent).getNamespace()))   parent=parent.getContext();
  if (parent instanceof XmlTag) {
    final XmlTag parentTag=(XmlTag)parent;
    final XmlElementDescriptor parentDescriptor=parentTag.getDescriptor();
    if (parentDescriptor != null) {
      return parentDescriptor.getElementDescriptor(tag);
    }
 else {
      return null;
    }
  }
 else {
    XmlElementDescriptor elementDescriptor=getElementDescriptor(tag.getLocalName(),tag.getNamespace());
    if (elementDescriptor == null) {
      parent=tag.getParent();
      if (parent instanceof XmlTag) {
        final XmlElementDescriptor descriptor=((XmlTag)parent).getDescriptor();
        if (descriptor != null)         elementDescriptor=descriptor.getElementDescriptor(tag);
      }
    }
    return elementDescriptor;
  }
}
