{
  PsiElement parent=tag.getParent();
  final String namespace=tag.getNamespace();
  while (parent instanceof XmlTag && !namespace.equals(((XmlTag)parent).getNamespace()))   parent=parent.getContext();
  if (parent instanceof XmlTag) {
    final XmlTag parentTag=(XmlTag)parent;
    final XmlElementDescriptor parentDescriptor=parentTag.getDescriptor();
    if (parentDescriptor != null) {
      final XmlElementDescriptor elementDescriptorFromParent=parentDescriptor.getElementDescriptor(tag);
      if (elementDescriptorFromParent instanceof AnyXmlElementDescriptor) {
        final XmlElementDescriptor elementDescriptor=getElementDescriptor(tag.getLocalName(),namespace);
        if (elementDescriptor != null)         return elementDescriptor;
      }
      return elementDescriptorFromParent;
    }
 else {
      return null;
    }
  }
 else {
    XmlElementDescriptor elementDescriptor=getElementDescriptor(tag.getLocalName(),tag.getNamespace());
    if (elementDescriptor == null) {
      parent=tag.getParent();
      if (parent instanceof XmlTag) {
        final XmlElementDescriptor descriptor=((XmlTag)parent).getDescriptor();
        if (descriptor != null)         elementDescriptor=descriptor.getElementDescriptor(tag);
      }
    }
    return elementDescriptor;
  }
}
