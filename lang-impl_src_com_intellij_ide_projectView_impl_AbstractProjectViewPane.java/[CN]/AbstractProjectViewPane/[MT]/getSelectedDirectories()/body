{
  final PsiElement[] elements=getSelectedPSIElements();
  if (elements.length == 1) {
    final PsiElement element=elements[0];
    if (element instanceof PsiDirectory) {
      return new PsiDirectory[]{(PsiDirectory)element};
    }
 else     if (element instanceof PsiDirectoryContainer) {
      return ((PsiDirectoryContainer)element).getDirectories();
    }
 else {
      final PsiFile containingFile=element.getContainingFile();
      if (containingFile != null) {
        final PsiDirectory psiDirectory=containingFile.getContainingDirectory();
        return psiDirectory != null ? new PsiDirectory[]{psiDirectory} : PsiDirectory.EMPTY_ARRAY;
      }
    }
  }
 else {
    final DefaultMutableTreeNode selectedNode=getSelectedNode();
    if (selectedNode != null) {
      return getSelectedDirectoriesInAmbiguousCase(selectedNode);
    }
  }
  return PsiDirectory.EMPTY_ARRAY;
}
