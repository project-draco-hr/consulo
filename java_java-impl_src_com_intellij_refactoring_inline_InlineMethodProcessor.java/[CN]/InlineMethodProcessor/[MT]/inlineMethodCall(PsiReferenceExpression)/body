{
  InlineUtil.TailCallType tailCall=InlineUtil.getTailCallType(ref);
  ChangeContextUtil.encodeContextInfo(myMethod,false);
  myMethodCopy=(PsiMethod)myMethod.copy();
  ChangeContextUtil.clearContextInfo(myMethod);
  PsiMethodCallExpression methodCall=(PsiMethodCallExpression)ref.getParent();
  PsiSubstitutor callSubstitutor=getCallSubstitutor(methodCall);
  BlockData blockData=prepareBlock(ref,callSubstitutor,methodCall.getArgumentList(),tailCall);
  solveVariableNameConflicts(blockData.block,ref);
  if (callSubstitutor != PsiSubstitutor.EMPTY) {
    substituteMethodTypeParams(blockData.block,callSubstitutor);
  }
  addParmAndThisVarInitializers(blockData,methodCall);
  PsiElement anchor=RefactoringUtil.getParentStatement(methodCall,true);
  if (anchor == null) {
    PsiEnumConstant enumConstant=PsiTreeUtil.getParentOfType(methodCall,PsiEnumConstant.class);
    if (enumConstant != null) {
      PsiExpression returnExpr=getSimpleReturnedExpression(myMethod);
      if (returnExpr != null) {
        methodCall.replace(returnExpr);
      }
    }
    return;
  }
  PsiElement anchorParent=anchor.getParent();
  PsiLocalVariable thisVar=null;
  PsiLocalVariable[] parmVars=new PsiLocalVariable[blockData.parmVars.length];
  PsiLocalVariable resultVar=null;
  PsiStatement[] statements=blockData.block.getStatements();
  if (statements.length > 0) {
    int last=statements.length - 1;
    if (statements.length > 0 && statements[statements.length - 1] instanceof PsiReturnStatement && tailCall != InlineUtil.TailCallType.Return) {
      last--;
    }
    int first=0;
    if (first <= last) {
      final PsiElement rBraceOrReturnStatement=PsiTreeUtil.skipSiblingsForward(statements[last],PsiWhiteSpace.class,PsiComment.class);
      LOG.assertTrue(rBraceOrReturnStatement != null);
      final PsiElement beforeRBraceStatement=rBraceOrReturnStatement.getPrevSibling();
      LOG.assertTrue(beforeRBraceStatement != null);
      PsiElement firstAdded=anchorParent.addRangeBefore(statements[first],beforeRBraceStatement,anchor);
      PsiElement current=firstAdded.getPrevSibling();
      LOG.assertTrue(current != null);
      if (blockData.thisVar != null) {
        PsiDeclarationStatement statement=PsiTreeUtil.getNextSiblingOfType(current,PsiDeclarationStatement.class);
        thisVar=(PsiLocalVariable)statement.getDeclaredElements()[0];
        current=statement;
      }
      for (int i=0; i < parmVars.length; i++) {
        PsiDeclarationStatement statement=PsiTreeUtil.getNextSiblingOfType(current,PsiDeclarationStatement.class);
        parmVars[i]=(PsiLocalVariable)statement.getDeclaredElements()[0];
        current=statement;
      }
      if (blockData.resultVar != null) {
        PsiDeclarationStatement statement=PsiTreeUtil.getNextSiblingOfType(current,PsiDeclarationStatement.class);
        resultVar=(PsiLocalVariable)statement.getDeclaredElements()[0];
      }
    }
    if (statements.length > 0) {
      final PsiStatement lastStatement=statements[statements.length - 1];
      if (lastStatement instanceof PsiReturnStatement && tailCall != InlineUtil.TailCallType.Return) {
        final PsiExpression returnValue=((PsiReturnStatement)lastStatement).getReturnValue();
        if (returnValue != null && PsiUtil.isStatement(returnValue)) {
          PsiExpressionStatement exprStatement=(PsiExpressionStatement)myFactory.createStatementFromText("a;",null);
          exprStatement.getExpression().replace(returnValue);
          anchorParent.addBefore(exprStatement,anchor);
        }
      }
    }
  }
  PsiClass thisClass=myMethod.getContainingClass();
  PsiExpression thisAccessExpr;
  if (thisVar != null) {
    if (!canInlineParmOrThisVariable(thisVar)) {
      thisAccessExpr=myFactory.createExpressionFromText(thisVar.getName(),null);
    }
 else {
      thisAccessExpr=thisVar.getInitializer();
    }
  }
 else {
    thisAccessExpr=null;
  }
  ChangeContextUtil.decodeContextInfo(anchorParent,thisClass,thisAccessExpr);
  if (methodCall.getParent() instanceof PsiExpressionStatement || tailCall == InlineUtil.TailCallType.Return) {
    methodCall.getParent().delete();
  }
 else {
    if (blockData.resultVar != null) {
      PsiExpression expr=myFactory.createExpressionFromText(blockData.resultVar.getName(),null);
      methodCall.replace(expr);
    }
 else {
    }
  }
  if (thisVar != null) {
    inlineParmOrThisVariable(thisVar,false);
  }
  final PsiParameter[] parameters=myMethod.getParameterList().getParameters();
  for (int i=0; i < parmVars.length; i++) {
    final PsiParameter parameter=parameters[i];
    final boolean strictlyFinal=parameter.hasModifierProperty(PsiModifier.FINAL) && isStrictlyFinal(parameter);
    inlineParmOrThisVariable(parmVars[i],strictlyFinal);
  }
  if (resultVar != null) {
    inlineResultVariable(resultVar);
  }
  ChangeContextUtil.clearContextInfo(anchorParent);
}
