{
  Object componentKey=componentAdapter.getComponentKey();
  if (componentKeyToAdapterCache.containsKey(componentKey)) {
    throw new DuplicateComponentKeyRegistrationException(componentKey);
  }
  if (componentAdapter instanceof AssignableToComponentAdapter) {
    String classKey=((AssignableToComponentAdapter)componentAdapter).getAssignableToClassName();
    classNameToAdapter.put(classKey,componentAdapter);
  }
 else {
    do {
      FList<ComponentAdapter> oldList=nonAssignableComponentAdapters.get();
      FList<ComponentAdapter> newList=oldList.prepend(componentAdapter);
      if (nonAssignableComponentAdapters.compareAndSet(oldList,newList)) {
        break;
      }
    }
 while (true);
  }
  componentAdapters.add(componentAdapter);
  componentKeyToAdapterCache.put(componentKey,componentAdapter);
  return componentAdapter;
}
