{
  final CachedRefs refs=new CachedRefs();
  final GitRepository repositoryForRoot=GitRepositoryManager.getInstance(myProject).getRepositoryForRoot(myRoot);
  final GitBranchesCollection branches;
  if (repositoryForRoot != null) {
    branches=repositoryForRoot.getBranches();
  }
 else {
    final File child=new File(myRoot.getPath(),".git");
    if (!child.exists()) {
      throw new VcsException("No git repository in " + myRoot.getPath());
    }
    GitRepository repository=GitRepository.getLightInstance(myRoot,myProject,myProject);
    repository.getBranches();
    branches=repository.getBranches();
  }
  refs.setCollection(branches);
  final GitBranch current=branches.getCurrentBranch();
  if (current != null) {
    GitBranch tracked=current.tracked(myProject,myRoot);
    String fullName=tracked == null ? null : tracked.getFullName();
    fullName=fullName != null && fullName.startsWith(GitBranch.REFS_REMOTES_PREFIX) ? fullName.substring(GitBranch.REFS_REMOTES_PREFIX.length()) : fullName;
    refs.setTrackedRemoteName(fullName);
  }
  refs.setUsername(GitConfigUtil.getValue(myProject,myRoot,GitConfigUtil.USER_NAME));
  final VcsRevisionNumber head=GitHistoryUtils.getCurrentRevision(myProject,new FilePathImpl(myRoot),"HEAD",true);
  refs.setHeadHash(AbstractHash.create(head.asString()));
  return refs;
}
