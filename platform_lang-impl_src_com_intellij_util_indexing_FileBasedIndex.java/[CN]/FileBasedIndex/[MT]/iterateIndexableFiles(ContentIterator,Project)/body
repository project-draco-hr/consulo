{
  if (project.isDisposed()) {
    return;
  }
  final ProjectFileIndex projectFileIndex=ProjectRootManager.getInstance(project).getFileIndex();
  projectFileIndex.iterateContent(processor);
  if (project.isDisposed()) {
    return;
  }
  ProgressIndicator indicator=ProgressManager.getInstance().getProgressIndicator();
  Set<VirtualFile> visitedRoots=new HashSet<VirtualFile>();
  for (  IndexedRootsProvider provider : Extensions.getExtensions(IndexedRootsProvider.EP_NAME)) {
    if (project.isDisposed()) {
      return;
    }
    for (    VirtualFile root : IndexableSetContributor.getRootsToIndex(provider,project)) {
      if (visitedRoots.add(root)) {
        iterateRecursively(root,processor,indicator);
      }
    }
  }
  if (project.isDisposed()) {
    return;
  }
  for (  Module module : ModuleManager.getInstance(project).getModules()) {
    if (module.isDisposed()) {
      return;
    }
    OrderEntry[] orderEntries=ModuleRootManager.getInstance(module).getOrderEntries();
    for (    OrderEntry orderEntry : orderEntries) {
      if (orderEntry instanceof LibraryOrderEntry || orderEntry instanceof JdkOrderEntry) {
        if (orderEntry.isValid()) {
          final VirtualFile[] libSources=orderEntry.getFiles(OrderRootType.SOURCES);
          final VirtualFile[] libClasses=orderEntry.getFiles(OrderRootType.CLASSES);
          for (          VirtualFile[] roots : new VirtualFile[][]{libSources,libClasses}) {
            for (            VirtualFile root : roots) {
              if (visitedRoots.add(root)) {
                iterateRecursively(root,processor,indicator);
              }
            }
          }
        }
      }
    }
  }
}
