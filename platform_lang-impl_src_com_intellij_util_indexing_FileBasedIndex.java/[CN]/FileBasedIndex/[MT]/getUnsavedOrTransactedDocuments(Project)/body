{
  Set<Document> docs=new HashSet<Document>(Arrays.asList(myFileDocumentManager.getUnsavedDocuments()));
synchronized (myTransactionMap) {
    docs.addAll(myTransactionMap.keySet());
  }
  if (project != null) {
    Iterator<Document> iterator=docs.iterator();
    ProjectLocator projectLocator=ProjectLocator.getInstance();
    while (iterator.hasNext()) {
      Document document=iterator.next();
      VirtualFile virtualFile=myFileDocumentManager.getFile(document);
      if (virtualFile == null)       continue;
      Project guessed=projectLocator.guessProjectForFile(virtualFile);
      if (guessed != null && guessed != project) {
        iterator.remove();
      }
    }
  }
  return docs;
}
