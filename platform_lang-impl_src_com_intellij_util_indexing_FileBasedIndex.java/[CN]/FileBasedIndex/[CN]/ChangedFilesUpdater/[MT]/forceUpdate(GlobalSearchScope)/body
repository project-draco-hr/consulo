{
  myChangedFilesUpdater.ensureAllInvalidateTasksCompleted();
  final VirtualFile[] files=queryNeededFiles();
  if (files.length > 0) {
    for (    VirtualFile file : files) {
      if (filter == null || filter.accept(file)) {
        try {
          myForceUpdateSemaphore.down();
          processFileImpl(new com.intellij.ide.startup.FileContent(file));
        }
  finally {
          myForceUpdateSemaphore.up();
        }
      }
    }
  }
  while (!myForceUpdateSemaphore.waitFor(500)) {
    if (Thread.holdsLock(PsiLock.LOCK)) {
      break;
    }
  }
}
