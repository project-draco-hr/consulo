def getfile(self, name, rev):
    cmd = ('p4 -G print "%s#%s"' % (self.depotname[name], rev))
    stdout = util.popen(cmd, mode='rb')
    mode = None
    contents = ''
    keywords = None
    for d in loaditer(stdout):
        code = d['code']
        data = d.get('data')
        if (code == 'error'):
            raise IOError(d['generic'], data)
        elif (code == 'stat'):
            p4type = self.re_type.match(d['type'])
            if p4type:
                mode = ''
                flags = ((p4type.group(1) or '') + (p4type.group(3) or ''))
                if ('x' in flags):
                    mode = 'x'
                if (p4type.group(2) == 'symlink'):
                    mode = 'l'
                if ('ko' in flags):
                    keywords = self.re_keywords_old
                elif ('k' in flags):
                    keywords = self.re_keywords
        elif ((code == 'text') or (code == 'binary')):
            contents += data
    if (mode is None):
        raise IOError(0, 'bad stat')
    self.modecache[(name, rev)] = mode
    if keywords:
        contents = keywords.sub('$\\1$', contents)
    if ((mode == 'l') and contents.endswith('\n')):
        contents = contents[:(-1)]
    return contents
