{
  final String targetPackageName=getTargetPackageName();
  final JavaPsiFacade psiFacade=JavaPsiFacade.getInstance(myProject);
  final PsiFile containingFile=mySourceClass.getContainingFile();
  final boolean fromDefaultPackage=containingFile instanceof PsiClassOwner && ((PsiClassOwner)containingFile).getPackageName().isEmpty();
  if (!(fromDefaultPackage && StringUtil.isEmpty(targetPackageName)) && !psiFacade.getNameHelper().isQualifiedName(targetPackageName)) {
    throw new OperationFailedException("Invalid package name: " + targetPackageName);
  }
  final PsiJavaPackage aPackage=psiFacade.findPackage(targetPackageName);
  if (aPackage != null) {
    final PsiDirectory[] directories=aPackage.getDirectories(mySourceClass.getResolveScope());
    if (directories.length >= 1) {
      myTargetDirectory=getDirUnderSameSourceRoot(directories);
    }
  }
  final MoveDestination moveDestination=myDestinationFolderComboBox.selectDirectory(new PackageWrapper(PsiManager.getInstance(myProject),targetPackageName),false);
  if (moveDestination == null)   return;
  myTargetDirectory=myTargetDirectory != null ? ApplicationManager.getApplication().runWriteAction(new Computable<PsiDirectory>(){
    @Override public PsiDirectory compute(){
      return moveDestination.getTargetDirectory(myTargetDirectory);
    }
  }
) : null;
  if (myTargetDirectory == null) {
    throw new OperationFailedException("");
  }
  String error=RefactoringMessageUtil.checkCanCreateClass(myTargetDirectory,getExtractedSuperName());
  if (error != null) {
    throw new OperationFailedException(error);
  }
}
