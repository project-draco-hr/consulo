{
  Charset charset;
  if (isCharsetSet()) {
    charset=super.getCharset();
  }
 else {
    if (isDirectory()) {
      Charset configured=EncodingManager.getInstance().getEncoding(this,true);
      charset=configured == null ? Charset.defaultCharset() : configured;
    }
 else {
      try {
        final byte[] content;
        try {
          content=contentsToByteArray();
        }
 catch (        FileNotFoundException e) {
          return super.getCharset();
        }
        charset=LoadTextUtil.detectCharset(this,content);
      }
 catch (      FileTooBigException e) {
        return super.getCharset();
      }
catch (      IOException e) {
        throw new RuntimeException(e);
      }
    }
    setCharset(charset);
  }
  return charset;
}
