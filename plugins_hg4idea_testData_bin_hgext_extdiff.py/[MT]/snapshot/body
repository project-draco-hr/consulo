def snapshot(ui, repo, files, node, tmproot):
    'snapshot files as of some revision\n    if not using snapshot, -I/-X does not work and recursive diff\n    in tools like kdiff3 and meld displays too many files.'
    dirname = os.path.basename(repo.root)
    if (dirname == ''):
        dirname = 'root'
    if (node is not None):
        dirname = ('%s.%s' % (dirname, short(node)))
    base = os.path.join(tmproot, dirname)
    os.mkdir(base)
    if (node is not None):
        ui.note((_('making snapshot of %d files from rev %s\n') % (len(files), short(node))))
    else:
        ui.note((_('making snapshot of %d files from working directory\n') % len(files)))
    wopener = util.opener(base)
    fns_and_mtime = []
    ctx = repo[node]
    for fn in files:
        wfn = util.pconvert(fn)
        if (not (wfn in ctx)):
            continue
        ui.note(('  %s\n' % wfn))
        dest = os.path.join(base, wfn)
        fctx = ctx[wfn]
        data = repo.wwritedata(wfn, fctx.data())
        if ('l' in fctx.flags()):
            wopener.symlink(data, wfn)
        else:
            wopener(wfn, 'w').write(data)
            if ('x' in fctx.flags()):
                util.set_flags(dest, False, True)
        if (node is None):
            fns_and_mtime.append((dest, repo.wjoin(fn), os.path.getmtime(dest)))
    return (dirname, fns_and_mtime)
