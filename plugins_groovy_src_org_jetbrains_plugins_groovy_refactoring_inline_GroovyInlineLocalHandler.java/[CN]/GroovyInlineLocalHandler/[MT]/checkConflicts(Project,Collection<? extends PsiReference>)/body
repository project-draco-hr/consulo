{
  final MultiMap<PsiElement,String> conflicts=new MultiMap<PsiElement,String>();
  for (  PsiReference reference : allReferences) {
    collectConflicts(reference,conflicts);
  }
  if (!conflicts.isEmpty()) {
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      throw new BaseRefactoringProcessor.ConflictsInTestsException(conflicts.values());
    }
 else {
      final ConflictsDialog conflictsDialog=new ConflictsDialog(project,conflicts);
      conflictsDialog.show();
      if (!conflictsDialog.isOK()) {
        return true;
      }
    }
  }
  return false;
}
