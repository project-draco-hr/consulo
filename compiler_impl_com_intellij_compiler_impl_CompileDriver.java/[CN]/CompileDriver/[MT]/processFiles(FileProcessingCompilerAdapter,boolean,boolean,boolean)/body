{
  final CompileContext context=adapter.getCompileContext();
  final FileProcessingCompilerStateCache cache=getFileProcessingCompilerCache(adapter.getCompiler());
  final FileProcessingCompiler.ProcessingItem[] items=adapter.getProcessingItems();
  if (context.getMessageCount(CompilerMessageCategory.ERROR) > 0) {
    return false;
  }
  final CompileScope scope=context.getCompileScope();
  final List<FileProcessingCompiler.ProcessingItem> toProcess=new ArrayList<FileProcessingCompiler.ProcessingItem>();
  final Set<String> allUrls=new HashSet<String>();
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      for (      FileProcessingCompiler.ProcessingItem item : items) {
        final VirtualFile file=item.getFile();
        if (file == null) {
          LOG.assertTrue(false,"FileProcessingCompiler.ProcessingItem.getFile() must not return null: compiler " + adapter.getCompiler().getDescription());
        }
        final String url=file.getUrl();
        allUrls.add(url);
        if (!forceCompile && cache.getTimestamp(url) == file.getTimeStamp()) {
          final ValidityState state=cache.getExtState(url);
          final ValidityState itemState=item.getValidityState();
          if (state != null ? state.equalsTo(itemState) : itemState == null) {
            continue;
          }
        }
        if (LOG.isDebugEnabled()) {
          LOG.debug("Adding item to process: " + url + "; saved ts= "+ cache.getTimestamp(url)+ "; VFS ts="+ file.getTimeStamp());
        }
        toProcess.add(item);
      }
    }
  }
);
  final String[] urls=cache.getUrls();
  final List<String> urlsToRemove=new ArrayList<String>();
  if (urls.length > 0) {
    context.getProgressIndicator().pushState();
    context.getProgressIndicator().setText(CompilerBundle.message("progress.processing.outdated.files"));
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        for (        final String url : urls) {
          if (!allUrls.contains(url)) {
            if (!checkScope || scope.belongs(url)) {
              urlsToRemove.add(url);
            }
          }
        }
      }
    }
);
    if (!onlyCheckStatus && !urlsToRemove.isEmpty()) {
      for (      final String url : urlsToRemove) {
        adapter.processOutdatedItem(context,url,cache.getExtState(url));
        cache.remove(url);
      }
    }
    context.getProgressIndicator().popState();
  }
  if (onlyCheckStatus) {
    if (urlsToRemove.isEmpty() && toProcess.isEmpty()) {
      return false;
    }
    if (LOG.isDebugEnabled()) {
      if (!urlsToRemove.isEmpty()) {
        LOG.debug("Found urls to remove, compiler " + adapter.getCompiler().getDescription());
        for (        String url : urlsToRemove) {
          LOG.debug("\t" + url);
        }
      }
      if (!toProcess.isEmpty()) {
        LOG.debug("Found items to compile, compiler " + adapter.getCompiler().getDescription());
        for (        FileProcessingCompiler.ProcessingItem item : toProcess) {
          LOG.debug("\t" + item.getFile().getPresentableUrl());
        }
      }
    }
    throw new ExitException(ExitStatus.CANCELLED);
  }
  if (toProcess.isEmpty()) {
    return false;
  }
  context.getProgressIndicator().pushState();
  final FileProcessingCompiler.ProcessingItem[] processed=adapter.process(toProcess.toArray(new FileProcessingCompiler.ProcessingItem[toProcess.size()]));
  context.getProgressIndicator().popState();
  if (processed.length > 0) {
    context.getProgressIndicator().pushState();
    context.getProgressIndicator().setText(CompilerBundle.message("progress.updating.caches"));
    try {
      List<VirtualFile> vFiles=new ArrayList<VirtualFile>(processed.length);
      for (      FileProcessingCompiler.ProcessingItem aProcessed : processed) {
        final VirtualFile file=aProcessed.getFile();
        vFiles.add(file);
        if (LOG.isDebugEnabled()) {
          LOG.debug("File processed by " + adapter.getCompiler().getDescription());
          LOG.debug("\tFile processed " + file.getPresentableUrl() + "; ts="+ file.getTimeStamp());
        }
      }
      LocalFileSystem.getInstance().refreshFiles(vFiles);
      if (LOG.isDebugEnabled()) {
        LOG.debug("Files after VFS refresh:");
        for (        VirtualFile file : vFiles) {
          LOG.debug("\t" + file.getPresentableUrl() + "; ts="+ file.getTimeStamp());
        }
      }
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          for (          FileProcessingCompiler.ProcessingItem item : processed) {
            cache.update(item.getFile(),item.getValidityState());
          }
        }
      }
);
    }
  finally {
      if (cache.isDirty()) {
        context.getProgressIndicator().setText(CompilerBundle.message("progress.saving.caches"));
        cache.save();
      }
      context.getProgressIndicator().popState();
    }
  }
  return true;
}
