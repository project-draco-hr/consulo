{
  final List<String> toRemove=new ArrayList<String>();
  final CompileScope scope=context.getCompileScope();
  for (Iterator<String> it=cache.getOutputUrlsIterator(); it.hasNext(); ) {
    final String outputPath=it.next();
    final String sourceUrl=cache.getSourceUrl(outputPath);
    final VirtualFile sourceFile=snapshot.getFileByUrl(sourceUrl);
    boolean needRecompile=false;
    boolean shouldDelete;
    if (myOutputFilesOnDisk.contains(outputPath)) {
      if (sourceFile == null) {
        shouldDelete=scope.belongs(sourceUrl);
      }
 else {
        if (toCompile.contains(sourceFile)) {
          shouldDelete=!FileUtil.pathsEqual(outputPath,VirtualFileManager.extractPath(sourceUrl));
        }
 else {
          final String currentOutputDir=getModuleOutputDirForFile(context,sourceFile);
          if (currentOutputDir != null) {
            final String className=cache.getClassName(outputPath);
            if (className == null || isUnderOutputDir(currentOutputDir,outputPath,className)) {
              shouldDelete=false;
            }
 else {
              shouldDelete=true;
              needRecompile=true;
            }
          }
 else {
            shouldDelete=true;
          }
        }
      }
    }
 else {
      needRecompile=true;
      shouldDelete=true;
    }
    if (shouldDelete) {
      toDelete.add(outputPath);
    }
    if (needRecompile) {
      if (sourceFile != null && scope.belongs(sourceUrl)) {
        if (!compilerConfiguration.isExcludedFromCompilation(sourceFile)) {
          toCompile.add(sourceFile);
          toRemove.add(outputPath);
        }
      }
    }
    if (sourceFile == null) {
      urlsWithSourceRemoved.add(outputPath);
    }
  }
  for (  final String aToRemove : toRemove) {
    cache.remove(aToRemove);
  }
}
