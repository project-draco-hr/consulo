{
  CompileScope scope=originalScope;
  final Set<Module> affected=new HashSet<Module>(Arrays.asList(originalScope.getAffectedModules()));
  for (  Map.Entry<Pair<IntermediateOutputCompiler,Module>,Pair<VirtualFile,VirtualFile>> entry : myGenerationCompilerModuleToOutputDirMap.entrySet()) {
    final Module module=entry.getKey().getSecond();
    if (affected.contains(module)) {
      final Pair<VirtualFile,VirtualFile> outputs=entry.getValue();
      scope=new CompositeScope(scope,new FileSetCompileScope(Arrays.asList(outputs.getFirst(),outputs.getSecond()),new Module[]{module}));
    }
  }
  final AdditionalCompileScopeProvider[] scopeProviders=Extensions.getExtensions(AdditionalCompileScopeProvider.EXTENSION_POINT_NAME);
  CompileScope baseScope=scope;
  for (  AdditionalCompileScopeProvider scopeProvider : scopeProviders) {
    final CompileScope additionalScope=scopeProvider.getAdditionalScope(baseScope);
    if (additionalScope != null) {
      scope=new CompositeScope(scope,additionalScope);
    }
  }
  return scope;
}
