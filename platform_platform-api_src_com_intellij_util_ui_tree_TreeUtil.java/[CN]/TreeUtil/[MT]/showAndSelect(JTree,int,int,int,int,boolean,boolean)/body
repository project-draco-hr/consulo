{
  final TreePath path=tree.getPathForRow(row);
  if (path == null)   return new ActionCallback.Done();
  final int size=tree.getRowCount();
  if (size == 0) {
    tree.clearSelection();
    return new ActionCallback.Done();
  }
  if (top < 0) {
    top=0;
  }
  if (bottom >= size) {
    bottom=size - 1;
  }
  if (row >= tree.getRowCount())   return new ActionCallback.Done();
  if (tree.isShowing()) {
    if (!tree.isValid()) {
      tree.validate();
    }
  }
 else {
    return new ActionCallback.Done();
  }
  final Rectangle rowBounds=tree.getRowBounds(row);
  if (rowBounds == null)   return new ActionCallback.Done();
  Rectangle topBounds=tree.getRowBounds(top);
  if (topBounds == null) {
    topBounds=rowBounds;
  }
  Rectangle bottomBounds=tree.getRowBounds(bottom);
  if (bottomBounds == null) {
    bottomBounds=rowBounds;
  }
  Rectangle bounds=topBounds.union(bottomBounds);
  bounds.x=rowBounds.x;
  bounds.width=rowBounds.width;
  final Rectangle visible=tree.getVisibleRect();
  if (visible.contains(bounds)) {
    bounds=null;
  }
 else {
    final Component comp=tree.getCellRenderer().getTreeCellRendererComponent(tree,path.getLastPathComponent(),true,true,false,row,false);
    if (comp instanceof SimpleColoredComponent) {
      final SimpleColoredComponent renderer=((SimpleColoredComponent)comp);
      final Dimension scrollableSize=renderer.computePreferredSize(true);
      bounds.width=scrollableSize.width;
    }
  }
  final ActionCallback callback=new ActionCallback();
  if (!tree.isRowSelected(row)) {
    if (addToSelection) {
      tree.getSelectionModel().addSelectionPath(tree.getPathForRow(row));
    }
 else {
      tree.setSelectionRow(row);
    }
  }
  if (bounds != null) {
    final Range<Integer> range=getExpandControlRange(tree,path);
    if (range != null) {
      int delta=bounds.x - range.getFrom().intValue();
      bounds.x-=delta;
      bounds.width-=delta;
    }
    if (visible.width < bounds.width) {
      bounds.width=visible.width;
    }
    final Rectangle b1=bounds;
    final Runnable runnable=new Runnable(){
      public void run(){
        if (scroll) {
          AbstractTreeBuilder builder=AbstractTreeBuilder.getBuilderFor(tree);
          if (builder != null) {
            builder.getReady(TreeUtil.class).doWhenDone(new Runnable(){
              public void run(){
                tree.scrollRectToVisible(b1);
              }
            }
);
          }
 else {
            tree.scrollRectToVisible(b1);
          }
        }
        callback.setDone();
      }
    }
;
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      runnable.run();
    }
 else {
      SwingUtilities.invokeLater(runnable);
    }
  }
 else {
    callback.setDone();
  }
  return callback;
}
