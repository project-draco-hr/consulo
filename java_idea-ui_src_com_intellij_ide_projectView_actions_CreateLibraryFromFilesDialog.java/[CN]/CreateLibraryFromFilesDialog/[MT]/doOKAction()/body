{
  final LibrariesContainer.LibraryLevel level=myNameAndLevelPanel.getLibraryLevel();
  AccessToken token=WriteAction.start();
  try {
    final Module module=myModulesCombobox.getSelectedModule();
    final String libraryName=myNameAndLevelPanel.getLibraryName();
    if (level == LibrariesContainer.LibraryLevel.MODULE) {
      final ModifiableRootModel modifiableModel=ModuleRootManager.getInstance(module).getModifiableModel();
      LibrariesContainerFactory.createContainer(modifiableModel).createLibrary(libraryName,level,myRoots);
      modifiableModel.commit();
    }
 else {
      final Library library=LibrariesContainerFactory.createContainer(myProject).createLibrary(libraryName,level,myRoots);
      if (module != null) {
        final ModifiableRootModel model=ModuleRootManager.getInstance(module).getModifiableModel();
        model.addLibraryEntry(library);
        model.commit();
      }
    }
  }
  finally {
    token.finish();
  }
  super.doOKAction();
}
