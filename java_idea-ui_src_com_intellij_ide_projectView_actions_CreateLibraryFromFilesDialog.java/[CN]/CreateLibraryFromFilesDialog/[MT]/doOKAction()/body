{
  final LibrariesContainer.LibraryLevel level=myNameAndLevelPanel.getLibraryLevel();
  AccessToken token=WriteAction.start();
  try {
    final Library library=myLibrariesContainer.createLibrary(myNameAndLevelPanel.getLibraryName(),level,myRoots);
    if (myModifiableModel != null) {
      if (level == LibrariesContainer.LibraryLevel.MODULE) {
        myModifiableModel.commit();
      }
 else {
        myModifiableModel.dispose();
      }
    }
    final Module module=myModulesCombobox.getSelectedModule();
    if (module != null && level != LibrariesContainer.LibraryLevel.MODULE) {
      final ModifiableRootModel model=ModuleRootManager.getInstance(module).getModifiableModel();
      model.addLibraryEntry(library);
      model.commit();
    }
  }
  finally {
    token.finish();
  }
  super.doOKAction();
}
