{
  final VirtualFile[] roots=myRoots.toArray(new VirtualFile[myRoots.size()]);
  final LibrariesContainer.LibraryLevel level=myNameAndLevelPanel.getLibraryLevel();
  AccessToken token=WriteAction.start();
  try {
    final Library library=myLibrariesContainer.createLibrary(myNameAndLevelPanel.getLibraryName(),level,roots,VirtualFile.EMPTY_ARRAY);
    if (level == LibrariesContainer.LibraryLevel.MODULE) {
      myModifiableModel.commit();
    }
 else {
      myModifiableModel.dispose();
    }
    final Module module=myModulesCombobox.getSelectedModule();
    if (module != null && level != LibrariesContainer.LibraryLevel.MODULE) {
      final ModifiableRootModel model=ModuleRootManager.getInstance(module).getModifiableModel();
      model.addLibraryEntry(library);
      model.commit();
    }
  }
  finally {
    token.finish();
  }
  super.doOKAction();
}
