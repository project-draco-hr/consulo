{
  if (usages == null && usageTargets == null) {
    return null;
  }
  final Set<VirtualFile> result=new THashSet<VirtualFile>();
  if (usages != null) {
    for (    Usage usage : usages) {
      if (usage instanceof UsageInFile) {
        VirtualFile file=((UsageInFile)usage).getFile();
        if (file != null && file.isValid()) {
          result.add(file);
        }
      }
      if (usage instanceof UsageInFiles) {
        VirtualFile[] files=((UsageInFiles)usage).getFiles();
        for (        VirtualFile file : files) {
          if (file.isValid()) {
            result.add(file);
          }
        }
      }
    }
  }
  if (usageTargets != null) {
    for (    UsageTarget usageTarget : usageTargets) {
      if (usageTarget.isValid()) {
        final VirtualFile[] files=usageTarget.getFiles();
        if (files != null) {
          ContainerUtil.addAll(result,files);
        }
      }
    }
  }
  return VfsUtil.toVirtualFileArray(result);
}
