{
  try {
    ProgressManager.getInstance().run(new Task.Backgroundable(null,IdeBundle.message("progress.download.plugins"),true,PluginManagerUISettings.getInstance()){
      @Override public void run(      @NotNull ProgressIndicator indicator){
        Set<PluginNode> set=null;
        try {
          set=PluginInstaller.prepareToInstall(plugins,allPlugins);
          if (set != null) {
            onSuccess.consume(set);
          }
        }
  finally {
          if (cleanup != null)           cleanup.consume(set);
        }
      }
    }
);
  }
 catch (  RuntimeException e) {
    if (e.getCause() != null && e.getCause() instanceof IOException) {
      throw (IOException)e.getCause();
    }
 else {
      throw e;
    }
  }
}
