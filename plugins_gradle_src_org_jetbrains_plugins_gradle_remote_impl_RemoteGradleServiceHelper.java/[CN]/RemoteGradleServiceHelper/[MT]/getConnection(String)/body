{
  File projectFile=new File(projectPath);
  if (!projectFile.isFile()) {
    throw new IllegalArgumentException(ExternalSystemBundle.message("gradle.import.text.error.invalid.path",projectPath));
  }
  File projectDir=projectFile.getParentFile();
  GradleConnector connector=GradleConnector.newConnector();
  RemoteGradleProcessSettings settings=mySettings.get();
  if (settings != null) {
    if (!settings.isUseWrapper()) {
      String gradleHome=settings.getGradleHome();
      if (gradleHome != null) {
        try {
          connector.useInstallation(new File(gradleHome).getCanonicalFile());
        }
 catch (        IOException e) {
          connector.useInstallation(new File(settings.getGradleHome()));
        }
      }
    }
    String serviceDirectory=settings.getServiceDirectory();
    if (serviceDirectory != null) {
      connector.useGradleUserHomeDir(new File(serviceDirectory));
    }
    if (settings.isVerboseApi() && connector instanceof DefaultGradleConnector) {
      ((DefaultGradleConnector)connector).setVerboseLogging(true);
    }
    long ttl=settings.getTtlInMs();
    if (ttl > 0 && connector instanceof DefaultGradleConnector) {
      ((DefaultGradleConnector)connector).daemonMaxIdleTime((int)ttl,TimeUnit.MILLISECONDS);
    }
  }
  connector.forProjectDirectory(projectDir);
  ProjectConnection connection=connector.connect();
  if (connection == null) {
    throw new IllegalStateException(String.format("Can't create connection to the target project via gradle tooling api. Project path: '%s'",projectPath));
  }
  return connection;
}
