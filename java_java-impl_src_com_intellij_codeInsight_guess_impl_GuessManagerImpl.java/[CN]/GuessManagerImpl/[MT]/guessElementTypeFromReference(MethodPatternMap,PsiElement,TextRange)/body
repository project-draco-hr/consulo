{
  PsiElement refParent=ref.getParent();
  if (refParent instanceof PsiReferenceExpression) {
    PsiReferenceExpression parentExpr=(PsiReferenceExpression)refParent;
    if (ref.equals(parentExpr.getQualifierExpression()) && parentExpr.getParent() instanceof PsiMethodCallExpression) {
      String methodName=parentExpr.getReferenceName();
      PsiMethodCallExpression methodCall=(PsiMethodCallExpression)parentExpr.getParent();
      PsiExpression[] args=methodCall.getArgumentList().getExpressions();
      MethodPattern pattern=methodPatternMap.findPattern(methodName,args.length);
      if (pattern != null) {
        if (pattern.parameterIndex < 0) {
          if (methodCall.getParent() instanceof PsiTypeCastExpression && (rangeToIgnore == null || !rangeToIgnore.contains(methodCall.getTextRange()))) {
            final PsiTypeElement castType=((PsiTypeCastExpression)methodCall.getParent()).getCastType();
            return castType == null ? null : castType.getType();
          }
        }
 else {
          return args[pattern.parameterIndex].getType();
        }
      }
    }
  }
  return null;
}
