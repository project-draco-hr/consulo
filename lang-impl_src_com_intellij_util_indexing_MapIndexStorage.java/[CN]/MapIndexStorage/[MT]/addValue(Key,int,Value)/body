{
  myFlushingLock.lock();
  final ValueContainerImpl<Value> container=myCache.get(key);
  try {
    if (container != null) {
      container.addValue(inputId,value);
    }
 else {
      myMap.appendData(key,new PersistentHashMap.ValueDataAppender(){
        public void append(        final DataOutput out) throws IOException {
          myValueExternalizer.save(out,value);
          out.writeInt(-inputId);
        }
      }
);
    }
  }
 catch (  IOException e) {
    throw new StorageException(e);
  }
 finally {
    myFlushingLock.unlock();
  }
}
