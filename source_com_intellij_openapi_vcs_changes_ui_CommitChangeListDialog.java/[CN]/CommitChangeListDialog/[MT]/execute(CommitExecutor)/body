{
  if (!checkComment()) {
    return;
  }
  VcsConfiguration.getInstance(myProject).saveCommitMessage(getCommitMessage());
  saveState();
  final CommitSession session=commitExecutor.createCommitSession();
  boolean isOK=true;
  if (session.getAdditionalConfigurationUI() != null) {
    DialogWrapper sessionDialog=new SessionDialog(commitExecutor.getActionText(),getProject(),session,getIncludedChanges(),getCommitMessage());
    sessionDialog.show();
    isOK=sessionDialog.isOK();
  }
  if (isOK) {
    runBeforeCommitHandlers(new Runnable(){
      public void run(){
        try {
          final boolean completed=ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable(){
            public void run(){
              session.execute(getIncludedChanges(),getCommitMessage());
            }
          }
,commitExecutor.getActionText(),true,getProject());
          if (completed) {
            for (            CheckinHandler handler : myHandlers) {
              handler.checkinSuccessful();
            }
            close(OK_EXIT_CODE);
          }
 else {
            session.executionCanceled();
          }
        }
 catch (        Throwable e) {
          Messages.showErrorDialog(VcsBundle.message("error.executing.commit",commitExecutor.getActionText(),e.getLocalizedMessage()),commitExecutor.getActionText());
          for (          CheckinHandler handler : myHandlers) {
            handler.checkinFailed(Arrays.asList(new VcsException[]{new VcsException(e)}));
          }
        }
      }
    }
);
  }
 else {
    session.executionCanceled();
  }
}
