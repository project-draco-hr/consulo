{
  if (mySession != null) {
    return new Runnable(){
      public void run(){
        mySession.execute(myBrowser.getCurrentIncludedChanges(),getCommitMessage());
      }
    }
;
  }
  return new Runnable(){
    public void run(){
      try {
        final List<FilePath> pathsToRefresh=new ArrayList<FilePath>();
        ChangesUtil.processChangesByVcs(myProject,myBrowser.getCurrentIncludedChanges(),new ChangesUtil.ChangesProcessor(){
          public void processChanges(          AbstractVcs vcs,          List<Change> changes){
            final CheckinEnvironment environment=vcs.getCheckinEnvironment();
            if (environment != null) {
              List<FilePath> paths=new ArrayList<FilePath>();
              for (              Change change : changes) {
                paths.add(ChangesUtil.getFilePath(change));
              }
              pathsToRefresh.addAll(paths);
              final List<VcsException> exceptions=environment.commit(paths.toArray(new FilePath[paths.size()]),myProject,getCommitMessage());
              if (exceptions.size() > 0) {
                vcsExceptions.addAll(exceptions);
                changesFailedToCommit.addAll(changes);
              }
            }
          }
        }
);
        final LvcsAction lvcsAction=LocalVcs.getInstance(myProject).startAction(myActionName,"",true);
        VirtualFileManager.getInstance().refresh(true,new Runnable(){
          public void run(){
            lvcsAction.finish();
            FileStatusManager.getInstance(myProject).fileStatusesChanged();
            for (            FilePath path : pathsToRefresh) {
              VcsDirtyScopeManager.getInstance(myProject).fileDirty(path);
            }
          }
        }
);
        AbstractVcsHelper.getInstance(myProject).showErrors(vcsExceptions,myActionName);
      }
  finally {
        commitCompleted(vcsExceptions,changesFailedToCommit,VcsConfiguration.getInstance(myProject),myHandlers,getCommitMessage());
      }
    }
  }
;
}
