{
  myProject=project;
  myDaemonCodeAnalyzer=daemonCodeAnalyzer;
  final MessageBusConnection connection=myProject.getMessageBus().connect();
  EditorEventMulticaster eventMulticaster=EditorFactory.getInstance().getEventMulticaster();
  myDocumentListener=new DocumentAdapter(){
    public void beforeDocumentChange(    final DocumentEvent e){
      if (!worthBothering(e.getDocument())) {
        return;
      }
      stopDaemon(true);
      UpdateHighlightersUtil.updateHighlightersByTyping(myProject,e);
    }
  }
;
  eventMulticaster.addDocumentListener(myDocumentListener);
  myCaretListener=new CaretListener(){
    public void caretPositionChanged(    CaretEvent e){
      Editor editor=e.getEditor();
      if (!worthBothering(editor.getDocument())) {
        return;
      }
      stopDaemon(true);
      myDaemonCodeAnalyzer.setLastIntentionHint(null);
    }
  }
;
  eventMulticaster.addCaretListener(myCaretListener);
  eventMulticaster.addEditorMouseMotionListener(myEditorMouseMotionListener);
  eventMulticaster.addEditorMouseListener(myEditorMouseListener);
  myEditorTracker=editorTracker;
  myEditorTrackerListener=new EditorTrackerListener(){
    public void activeEditorsChanged(    List<Editor> editors){
      if (!editors.isEmpty()) {
        stopDaemon(true);
      }
    }
  }
;
  myEditorTracker.addEditorTrackerListener(myEditorTrackerListener);
  myEditorFactoryListener=new EditorFactoryAdapter(){
    public void editorCreated(    EditorFactoryEvent event){
      Editor editor=event.getEditor();
      Document document=editor.getDocument();
      if (!worthBothering(document)) {
        return;
      }
      myDaemonCodeAnalyzer.repaintErrorStripeRenderer(editor);
    }
  }
;
  EditorFactory.getInstance().addEditorFactoryListener(myEditorFactoryListener);
  PsiManager.getInstance(myProject).addPsiTreeChangeListener(new PsiChangeHandler(myProject,daemonCodeAnalyzer,connection));
  connection.subscribe(ProjectTopics.PROJECT_ROOTS,new ModuleRootListener(){
    public void beforeRootsChange(    ModuleRootEvent event){
    }
    public void rootsChanged(    ModuleRootEvent event){
      final FileEditor[] editors=FileEditorManager.getInstance(myProject).getSelectedEditors();
      if (editors.length == 0)       return;
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        public void run(){
          if (myProject.isDisposed())           return;
          for (          FileEditor fileEditor : editors) {
            if (fileEditor instanceof TextEditor) {
              myDaemonCodeAnalyzer.repaintErrorStripeRenderer(((TextEditor)fileEditor).getEditor());
            }
          }
        }
      }
,ModalityState.stateForComponent(editors[0].getComponent()));
    }
  }
);
  CommandProcessor.getInstance().addCommandListener(myCommandListener);
  ApplicationManager.getApplication().addApplicationListener(myApplicationListener);
  EditorColorsManager.getInstance().addEditorColorsListener(myEditorColorsListener);
  InspectionProfileManager.getInstance().addProfileChangeListener(myProfileChangeListener);
  TodoConfiguration.getInstance().addPropertyChangeListener(myTodoListener);
  ActionManagerEx.getInstanceEx().addAnActionListener(myAnActionListener);
  myVirtualFileListener=new VirtualFileAdapter(){
    public void propertyChanged(    VirtualFilePropertyEvent event){
      if (VirtualFile.PROP_NAME.equals(event.getPropertyName())) {
        myDaemonCodeAnalyzer.restart();
        PsiFile psiFile=PsiManager.getInstance(myProject).findFile(event.getFile());
        if (psiFile != null && !myDaemonCodeAnalyzer.isHighlightingAvailable(psiFile)) {
          Document document=FileDocumentManager.getInstance().getCachedDocument(event.getFile());
          if (document != null) {
            UpdateHighlightersUtil.setHighlightersToEditor(myProject,document,0,document.getTextLength(),Collections.<HighlightInfo>emptyList(),Pass.UPDATE_ALL);
          }
        }
      }
    }
  }
;
  VirtualFileManager.getInstance().addVirtualFileListener(myVirtualFileListener);
  myErrorStripeHandler=new ErrorStripeHandler(myProject);
  ((EditorEventMulticasterEx)eventMulticaster).addErrorStripeListener(myErrorStripeHandler);
  final NamedScopesHolder[] holders=NamedScopesHolder.getAllNamedScopeHolders(project);
  NamedScopesHolder.ScopeListener scopeListener=new NamedScopesHolder.ScopeListener(){
    public void scopesChanged(){
      myDaemonCodeAnalyzer.reloadScopes();
    }
  }
;
  for (  NamedScopesHolder holder : holders) {
    holder.addScopeListener(scopeListener);
  }
  myModalityStateListener=new ModalityStateListener(){
    public void beforeModalityStateChanged(){
      stopDaemon(LaterInvocator.isInModalContext());
    }
  }
;
  LaterInvocator.addModalityStateListener(myModalityStateListener);
}
