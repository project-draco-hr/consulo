{
  final List<CompletionVariant> variants=new ArrayList<CompletionVariant>();
  PsiElement scope=position;
  if (scope == null) {
    scope=context.file;
  }
  while (scope != null) {
    boolean breakFlag=false;
    if (isScopeAcceptable(scope)) {
      final Iterator<CompletionVariant> iter=myCompletionVariants.iterator();
      while (iter.hasNext()) {
        final CompletionVariant variant=iter.next();
        if (variant.isVariantApplicable(position,scope) && !variants.contains(variant)) {
          variants.add(variant);
          if (variant.isScopeFinal(scope))           breakFlag=true;
        }
      }
    }
    if (breakFlag || isScopeFinal(scope.getClass()))     break;
    scope=scope.getContext();
    if (scope instanceof PsiDirectory)     break;
  }
  return variants.toArray(new CompletionVariant[variants.size()]);
}
