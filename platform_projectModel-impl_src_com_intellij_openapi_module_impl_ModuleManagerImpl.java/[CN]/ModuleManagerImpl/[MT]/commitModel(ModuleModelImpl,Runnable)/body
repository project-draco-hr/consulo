{
  myModuleModel.myModulesCache=null;
  myModificationCount++;
  ApplicationManager.getApplication().assertWriteAccessAllowed();
  final Collection<Module> oldModules=myModuleModel.myPathToModule.values();
  final Collection<Module> newModules=moduleModel.myPathToModule.values();
  final List<Module> removedModules=new ArrayList<Module>(oldModules);
  removedModules.removeAll(newModules);
  final List<Module> addedModules=new ArrayList<Module>(newModules);
  addedModules.removeAll(oldModules);
  ProjectRootManagerEx.getInstanceEx(myProject).makeRootsChange(new Runnable(){
    public void run(){
      for (      Module removedModule : removedModules) {
        fireBeforeModuleRemoved(removedModule);
        cleanCachedStuff();
      }
      List<Module> neverAddedModules=new ArrayList<Module>(moduleModel.myModulesToDispose);
      neverAddedModules.removeAll(myModuleModel.myPathToModule.values());
      for (      final Module neverAddedModule : neverAddedModules) {
        ModuleImpl module=(ModuleImpl)neverAddedModule;
        module.putUserData(DISPOSED_MODULE_NAME,module.getName());
        Disposer.dispose(module);
      }
      if (runnable != null) {
        runnable.run();
      }
      final Map<Module,String> modulesToNewNamesMap=moduleModel.myModuleToNewName;
      final Set<Module> modulesToBeRenamed=modulesToNewNamesMap.keySet();
      modulesToBeRenamed.removeAll(moduleModel.myModulesToDispose);
      final List<Module> modules=new ArrayList<Module>();
      for (      final Module aModulesToBeRenamed : modulesToBeRenamed) {
        ModuleImpl module=(ModuleImpl)aModulesToBeRenamed;
        moduleModel.myPathToModule.remove(module.getModuleFilePath());
        modules.add(module);
        module.rename(modulesToNewNamesMap.get(module));
        moduleModel.myPathToModule.put(module.getModuleFilePath(),module);
      }
      moduleModel.myIsWritable=false;
      myModuleModel=moduleModel;
      for (      Module module : removedModules) {
        fireModuleRemoved(module);
        cleanCachedStuff();
        Disposer.dispose(module);
        cleanCachedStuff();
      }
      for (      Module addedModule : addedModules) {
        ((ModuleImpl)addedModule).moduleAdded();
        cleanCachedStuff();
        fireModuleAdded(addedModule);
        cleanCachedStuff();
      }
      cleanCachedStuff();
      fireModulesRenamed(modules);
      cleanCachedStuff();
    }
  }
,false,true);
}
