{
  final VirtualFile moduleFile=StandardFileSystems.local().findFileByPath(filePath);
  if (moduleFile == null) {
    throw new IOException(ProjectBundle.message("module.file.does.not.exist.error",filePath));
  }
  filePath=resolveShortWindowsName(filePath);
  final String name=moduleFile.getName();
  if (progressIndicator != null) {
    progressIndicator.setText2(FileUtil.getNameWithoutExtension(name));
  }
  if (name.endsWith(IML_EXTENSION)) {
    final String moduleName=name.substring(0,name.length() - 4);
    for (    Module module : myPathToModule.values()) {
      if (module.getName().equals(moduleName)) {
        throw new ModuleWithNameAlreadyExists(ProjectBundle.message("module.already.exists.error",moduleName),moduleName);
      }
    }
  }
  if (!moduleFile.exists()) {
    throw new IOException(ProjectBundle.message("module.file.does.not.exist.error",moduleFile.getPath()));
  }
  ModuleEx module=getModuleByFilePath(filePath);
  if (module == null) {
    final VirtualFile moduleVFile=StandardFileSystems.local().refreshAndFindFileByPath(FileUtil.toSystemIndependentName(filePath));
    if (moduleVFile != null) {
      moduleVFile.refresh(false,false);
    }
    module=createAndLoadModule(filePath);
    module.loadModuleComponents();
    initModule(module);
  }
  return module;
}
