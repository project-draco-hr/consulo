{
  LiveTemplateBuilder builder=new LiveTemplateBuilder();
  int end=-1;
  TemplateInvokation parentInvokation=invokeTemplate(myTemplateToken,callback,myNumberInIteration,null,myChildren.size() == 0 && myToInsertChildren ? surroundedText : null);
  int offset=builder.insertTemplate(0,parentInvokation.getTemplate(),parentInvokation.getPredefinedValues());
  int newOffset=gotoChild(callback.getProject(),builder.getText(),offset,0,builder.length());
  if (offset < builder.length() && newOffset != offset) {
    end=offset;
  }
  offset=newOffset;
  if (end == -1 && offset < builder.length() && myChildren.size() == 0) {
    end=offset;
  }
  LiveTemplateBuilder.Marker marker=offset < builder.length() ? builder.createMarker(offset) : null;
  for (int i=0, myChildrenSize=myChildren.size(); i < myChildrenSize; i++) {
    GenerationNode child=myChildren.get(i);
    TemplateInvokation childInvokation=child.generate(callback,surroundedText);
    boolean blockTag=child.isBlockTag();
    if (blockTag && !isNewLineBefore(builder.getText(),offset)) {
      builder.insertText(offset++,"\n");
    }
    int e=builder.insertTemplate(offset,childInvokation.getTemplate(),childInvokation.getPredefinedValues());
    offset=marker != null ? marker.getEndOffset() : builder.length();
    if (blockTag && !isNewLineAfter(builder.getText(),offset)) {
      builder.insertText(offset++,"\n");
    }
    if (end == -1 && e < offset) {
      end=e;
    }
  }
  if (end != -1) {
    builder.insertVariableSegment(end,TemplateImpl.END);
  }
  return new TemplateInvokation(builder.buildTemplate(),builder.getPredefinedValues());
}
