{
  String actionId=myActionsTree.getSelectedActionId();
  if (actionId == null) {
    return;
  }
  if (!createKeymapCopyIfNeeded())   return;
  MouseShortcut mouseShortcut=shortcut instanceof MouseShortcut ? (MouseShortcut)shortcut : null;
  MouseShortcutDialog dialog=new MouseShortcutDialog(this,mouseShortcut,mySelectedKeymap,actionId,myActionsTree.getMainGroup(),restrictions);
  dialog.show();
  if (!dialog.isOK()) {
    return;
  }
  mouseShortcut=dialog.getMouseShortcut();
  if (mouseShortcut == null) {
    return;
  }
  String[] actionIds=mySelectedKeymap.getActionIds(mouseShortcut);
  if (actionIds.length > 1 || (actionIds.length == 1 && !actionId.equals(actionIds[0]))) {
    int result=Messages.showYesNoCancelDialog(this,KeyMapBundle.message("conflict.shortcut.dialog.message"),KeyMapBundle.message("conflict.shortcut.dialog.title"),KeyMapBundle.message("conflict.shortcut.dialog.remove.button"),KeyMapBundle.message("conflict.shortcut.dialog.leave.button"),KeyMapBundle.message("conflict.shortcut.dialog.cancel.button"),Messages.getWarningIcon());
    if (result == Messages.YES) {
      for (      String id : actionIds) {
        mySelectedKeymap.removeShortcut(id,mouseShortcut);
      }
    }
 else     if (result != Messages.NO) {
      return;
    }
  }
  Shortcut[] shortcuts=mySelectedKeymap.getShortcuts(actionId);
  for (  Shortcut shortcut1 : shortcuts) {
    if (shortcut1.equals(mouseShortcut)) {
      return;
    }
  }
  mySelectedKeymap.addShortcut(actionId,mouseShortcut);
  if (StringUtil.startsWithChar(actionId,'$')) {
    mySelectedKeymap.addShortcut(KeyMapBundle.message("editor.shortcut",actionId.substring(1)),mouseShortcut);
  }
  repaintLists();
  processCurrentKeymapChanged(getCurrentQuickListIds());
}
