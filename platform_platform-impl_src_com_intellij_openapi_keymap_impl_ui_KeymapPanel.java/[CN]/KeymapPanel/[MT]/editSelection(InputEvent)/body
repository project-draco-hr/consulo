{
  final String actionId=myActionsTree.getSelectedActionId();
  if (actionId == null)   return;
  DefaultActionGroup group=new DefaultActionGroup();
  final Shortcut[] shortcuts=mySelectedKeymap.getShortcuts(actionId);
  final Set<String> abbreviations=AbbreviationManager.getInstance().getAbbreviations(actionId);
  final ShortcutRestrictions restrictions=ActionShortcutRestrictions.getForActionId(actionId);
  if (restrictions.allowKeyboardShortcut) {
    group.add(new DumbAwareAction("Add Keyboard Shortcut"){
      @Override public void actionPerformed(      AnActionEvent e){
        Shortcut firstKeyboard=null;
        for (        Shortcut shortcut : shortcuts) {
          if (shortcut instanceof KeyboardShortcut) {
            firstKeyboard=shortcut;
            break;
          }
        }
        addKeyboardShortcut(firstKeyboard);
      }
    }
);
  }
  if (restrictions.allowMouseShortcut) {
    group.add(new DumbAwareAction("Add Mouse Shortcut"){
      @Override public void actionPerformed(      AnActionEvent e){
        Shortcut firstMouse=null;
        for (        Shortcut shortcut : shortcuts) {
          if (shortcut instanceof MouseShortcut) {
            firstMouse=shortcut;
            break;
          }
        }
        addMouseShortcut(firstMouse,restrictions);
      }
    }
);
  }
  if (restrictions.allowAbbreviation) {
    group.add(new DumbAwareAction("Add Abbreviation"){
      @Override public void actionPerformed(      AnActionEvent e){
        final String abbr=Messages.showInputDialog("Enter new abbreviation:","Abbreviation",null);
        if (abbr != null) {
          String actionId=myActionsTree.getSelectedActionId();
          AbbreviationManager.getInstance().register(abbr,actionId);
          repaintLists();
        }
      }
      @Override public void update(      AnActionEvent e){
        final boolean enabled=myActionsTree.getSelectedActionId() != null;
        e.getPresentation().setEnabledAndVisible(enabled);
      }
    }
);
  }
  group.addSeparator();
  for (  final Shortcut shortcut : shortcuts) {
    group.add(new DumbAwareAction("Remove " + KeymapUtil.getShortcutText(shortcut)){
      @Override public void actionPerformed(      AnActionEvent e){
        removeShortcut(shortcut);
      }
    }
);
  }
  for (  final String abbreviation : abbreviations) {
    group.addAction(new DumbAwareAction("Remove Abbreviation '" + abbreviation + "'"){
      @Override public void actionPerformed(      AnActionEvent e){
        AbbreviationManager.getInstance().remove(abbreviation,actionId);
        repaintLists();
      }
      @Override public void update(      AnActionEvent e){
        super.update(e);
      }
    }
);
  }
  if (e instanceof MouseEvent && ((MouseEvent)e).isPopupTrigger()) {
    final ActionPopupMenu popupMenu=ActionManager.getInstance().createActionPopupMenu(ActionPlaces.UNKNOWN,group);
    popupMenu.getComponent().show(e.getComponent(),((MouseEvent)e).getX(),((MouseEvent)e).getY());
  }
 else {
    final DataContext dataContext=DataManager.getInstance().getDataContext(this);
    final ListPopup popup=JBPopupFactory.getInstance().createActionGroupPopup("Edit Shortcuts",group,dataContext,JBPopupFactory.ActionSelectionAid.SPEEDSEARCH,true);
    if (e instanceof MouseEvent) {
      popup.show(new RelativePoint((MouseEvent)e));
    }
 else {
      popup.showInBestPositionFor(dataContext);
    }
  }
}
