{
  final boolean languageWithWSSignificant=SurroundWithHandler.isLanguageWithWSSignificant(elements[0]);
  final int startOffset=languageWithWSSignificant ? editor.getSelectionModel().getSelectionStart() : elements[0].getTextRange().getStartOffset();
  final int endOffset=languageWithWSSignificant ? editor.getSelectionModel().getSelectionEnd() : elements[elements.length - 1].getTextRange().getEndOffset();
  editor.getCaretModel().moveToOffset(startOffset);
  editor.getSelectionModel().setSelection(startOffset,endOffset);
  String text=editor.getDocument().getText().substring(startOffset,endOffset);
  if (!languageWithWSSignificant)   text=text.trim();
  final String text1=text;
  final Runnable action=new Runnable(){
    public void run(){
      TemplateManager.getInstance(project).startTemplate(editor,text1,myTemplate);
    }
  }
;
  if (languageWithWSSignificant) {
    PsiManager.getInstance(project).performActionWithFormatterDisabled(action);
  }
 else {
    action.run();
  }
  return null;
}
