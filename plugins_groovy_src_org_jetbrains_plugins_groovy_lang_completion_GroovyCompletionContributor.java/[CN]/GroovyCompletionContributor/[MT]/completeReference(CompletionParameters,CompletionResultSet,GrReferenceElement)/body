{
  final PsiElement position=parameters.getPosition();
  final InheritorsHolder inheritors=new InheritorsHolder(position,result);
  if (GroovySmartCompletionContributor.AFTER_NEW.accepts(position)) {
    GroovySmartCompletionContributor.generateInheritorVariants(parameters,result.getPrefixMatcher(),inheritors);
  }
  final int invocationCount=parameters.getInvocationCount();
  final boolean secondCompletionInvoked=invocationCount > 1;
  final String prefix=result.getPrefixMatcher().getPrefix();
  final boolean skipAccessors=!secondCompletionInvoked && !prefix.startsWith(GET_PREFIX) && !prefix.startsWith(SET_PREFIX)&& !prefix.startsWith(IS_PREFIX);
  result.restartCompletionOnPrefixChange(GET_PREFIX);
  result.restartCompletionOnPrefixChange(SET_PREFIX);
  result.restartCompletionOnPrefixChange(IS_PREFIX);
  final Map<PsiModifierListOwner,LookupElement> staticMembers=hashMap();
  final PsiElement qualifier=reference.getQualifier();
  final PsiType qualifierType=qualifier instanceof GrExpression ? ((GrExpression)qualifier).getType() : null;
  final ElementFilter classFilter=getClassFilter(position);
  reference.processVariants(new Consumer<Object>(){
    public void consume(    Object element){
      if (element instanceof PsiClass && inheritors.alreadyProcessed((PsiClass)element)) {
        return;
      }
      if (element instanceof LookupElement && inheritors.alreadyProcessed((LookupElement)element)) {
        return;
      }
      final LookupElement lookupElement=element instanceof PsiClass ? GroovyCompletionUtil.createClassLookupItem((PsiClass)element) : GroovyCompletionUtil.getLookupElement(element);
      Object object=lookupElement.getObject();
      PsiSubstitutor substitutor=null;
      GroovyResolveResult resolveResult=null;
      if (object instanceof GroovyResolveResult) {
        resolveResult=(GroovyResolveResult)object;
        substitutor=resolveResult.getSubstitutor();
        object=((GroovyResolveResult)object).getElement();
      }
      final boolean autopopup=parameters.getInvocationCount() == 0;
      if (!secondCompletionInvoked && object instanceof GrGdkMethod && GroovyCompletionUtil.skipDefGroovyMethod((GrGdkMethod)object,substitutor,qualifierType)) {
        if (!autopopup) {
          showInfo();
        }
        return;
      }
      if (!secondCompletionInvoked && object instanceof PsiMethod && GroovyCompletionUtil.OPERATOR_METHOD_NAMES.contains(((PsiMethod)object).getName())) {
        if (!checkForIterator((PsiMethod)object)) {
          if (!autopopup) {
            showInfo();
          }
          return;
        }
      }
      if (skipAccessors && object instanceof PsiMethod && GroovyPropertyUtils.isSimplePropertyAccessor((PsiMethod)object)) {
        if (!autopopup) {
          showInfo();
        }
        return;
      }
      if (!secondCompletionInvoked && resolveResult != null && !resolveResult.isAccessible()) {
        if (!autopopup) {
          showInfo();
        }
        return;
      }
      if ((object instanceof PsiMethod || object instanceof PsiField) && ((PsiModifierListOwner)object).hasModifierProperty(PsiModifier.STATIC)) {
        if (lookupElement.getLookupString().equals(((PsiMember)object).getName())) {
          staticMembers.put((PsiModifierListOwner)object,lookupElement);
          return;
        }
      }
      if (object instanceof PsiClass && !classFilter.isAcceptable(object,position)) {
        return;
      }
      result.addElement(JavaCompletionUtil.highlightIfNeeded(qualifierType,lookupElement,object));
    }
  }
);
  if (qualifier == null) {
    completeStaticMembers(position).processMembersOfRegisteredClasses(null,new PairConsumer<PsiMember,PsiClass>(){
      @Override public void consume(      PsiMember member,      PsiClass psiClass){
        if (member instanceof GrAccessorMethod) {
          member=((GrAccessorMethod)member).getProperty();
        }
        final String name=member.getName();
        if (name == null || !result.getPrefixMatcher().prefixMatches(name)) {
          staticMembers.remove(member);
          return;
        }
        staticMembers.put(member,new JavaGlobalMemberLookupElement(member,psiClass,QUALIFIED_METHOD_INSERT_HANDLER,STATIC_IMPORT_INSERT_HANDLER,true));
      }
    }
);
    if (StringUtil.isCapitalized(result.getPrefixMatcher().getPrefix()) || parameters.getInvocationCount() >= 2 || parameters.relaxMatching()) {
      addAllClasses(parameters,result,inheritors);
    }
  }
  result.addAllElements(staticMembers.values());
}
