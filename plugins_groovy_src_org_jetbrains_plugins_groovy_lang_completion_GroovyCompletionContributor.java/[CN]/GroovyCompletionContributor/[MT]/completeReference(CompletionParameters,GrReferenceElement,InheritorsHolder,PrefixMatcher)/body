{
  final PsiElement position=parameters.getPosition();
  final Map<PsiModifierListOwner,LookupElement> staticMembers=hashMap();
  final PsiElement qualifier=reference.getQualifier();
  final PsiType qualifierType=qualifier instanceof GrExpression ? ((GrExpression)qualifier).getType() : null;
  LinkedHashSet<LookupElement> result=new LinkedHashSet<LookupElement>();
  final Set<String> unresolvedProps;
  if (reference instanceof GrReferenceExpression && (qualifier instanceof GrExpression || qualifier == null)) {
    unresolvedProps=CompleteReferenceExpression.getVariantsWithSameQualifier(matcher,(GrExpression)qualifier,(GrReferenceExpression)reference);
    for (    String string : unresolvedProps) {
      result.add(GroovyCompletionUtil.getLookupElement(string));
    }
    if (parameters.getInvocationCount() < 2 && qualifier != null && qualifierType == null && !(qualifier instanceof GrReferenceExpression && ((GrReferenceExpression)qualifier).resolve() instanceof PsiPackage)) {
      if (parameters.getInvocationCount() == 1) {
        showInfo();
      }
      return result;
    }
  }
 else {
    unresolvedProps=Collections.emptySet();
  }
  final ElementFilter classFilter=getClassFilter(position);
  final boolean afterNew=JavaClassNameCompletionContributor.AFTER_NEW.accepts(position);
  final List<LookupElement> items=arrayList();
  reference.processVariants(matcher,parameters,new Consumer<Object>(){
    public void consume(    Object element){
      List<? extends LookupElement> lookupElements;
      if (element instanceof PsiClass) {
        if (!matcher.prefixMatches(((PsiClass)element).getName())) {
          return;
        }
        lookupElements=JavaClassNameCompletionContributor.createClassLookupItems((PsiClass)element,afterNew,new GroovyClassNameInsertHandler(),Condition.TRUE);
      }
 else {
        lookupElements=Arrays.asList(GroovyCompletionUtil.getLookupElement(element));
      }
      for (      LookupElement lookupElement : lookupElements) {
        if (!matcher.prefixMatches(lookupElement)) {
          continue;
        }
        Object object=lookupElement.getObject();
        if (object instanceof GroovyResolveResult) {
          object=((GroovyResolveResult)object).getElement();
        }
        if (object instanceof PsiClass && inheritorsHolder.alreadyProcessed((PsiClass)object) || object instanceof LookupElement && inheritorsHolder.alreadyProcessed((LookupElement)object)) {
          continue;
        }
        if (object instanceof GrReferenceExpression && unresolvedProps.contains(((GrReferenceExpression)object).getName())) {
          continue;
        }
        if (object instanceof PsiMember && JavaCompletionUtil.isInExcludedPackage((PsiMember)object,true)) {
          continue;
        }
        int priority=assignPriority(lookupElement,qualifierType);
        lookupElement=JavaCompletionUtil.highlightIfNeeded(qualifierType,PrioritizedLookupElement.withPriority(lookupElement,priority),object);
        if ((object instanceof PsiMethod || object instanceof PsiField) && ((PsiModifierListOwner)object).hasModifierProperty(PsiModifier.STATIC)) {
          if (lookupElement.getLookupString().equals(((PsiMember)object).getName())) {
            staticMembers.put((PsiModifierListOwner)object,lookupElement);
            continue;
          }
        }
        if (object instanceof PsiClass && !classFilter.isAcceptable(object,position)) {
          continue;
        }
        items.add(lookupElement);
      }
    }
  }
);
  if (qualifier == null) {
    completeStaticMembers(parameters).processMembersOfRegisteredClasses(null,new PairConsumer<PsiMember,PsiClass>(){
      @Override public void consume(      PsiMember member,      PsiClass psiClass){
        if (member instanceof GrAccessorMethod) {
          member=((GrAccessorMethod)member).getProperty();
        }
        final String name=member.getName();
        if (name == null || !matcher.prefixMatches(name)) {
          staticMembers.remove(member);
          return;
        }
        staticMembers.put(member,createGlobalMemberElement(member,psiClass,true));
      }
    }
);
  }
  items.addAll(staticMembers.values());
  for (Iterator<LookupElement> iterator=items.iterator(); iterator.hasNext(); ) {
    LookupElement element=iterator.next();
    PrioritizedLookupElement prio=element.as(PrioritizedLookupElement.CLASS_CONDITION_KEY);
    if (prio == null || prio.getPriority() >= 0) {
      result.add(element);
      iterator.remove();
    }
  }
  result.addAll(items);
  return result;
}
