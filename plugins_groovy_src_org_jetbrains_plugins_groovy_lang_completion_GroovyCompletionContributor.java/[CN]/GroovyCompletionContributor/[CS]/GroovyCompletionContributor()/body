{
  extend(CompletionType.SMART,AFTER_NEW,new CompletionProvider<CompletionParameters>(false){
    public void addCompletions(    @NotNull final CompletionParameters parameters,    final ProcessingContext matchingContext,    @NotNull final CompletionResultSet result){
      final PsiElement identifierCopy=parameters.getPosition();
      final PsiFile file=parameters.getOriginalFile();
      final List<PsiClassType> expectedClassTypes=new SmartList<PsiClassType>();
      final List<PsiArrayType> expectedArrayTypes=new ArrayList<PsiArrayType>();
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          PsiType psiType=((GrVariable)identifierCopy.getParent().getParent().getParent()).getTypeGroovy();
          if (psiType instanceof PsiClassType) {
            PsiType type=JavaCompletionUtil.eliminateWildcards(JavaCompletionUtil.originalize(psiType));
            final PsiClassType classType=(PsiClassType)type;
            if (classType.resolve() != null) {
              expectedClassTypes.add(classType);
            }
          }
 else           if (psiType instanceof PsiArrayType) {
            expectedArrayTypes.add((PsiArrayType)psiType);
          }
        }
      }
);
      for (      final PsiArrayType type : expectedArrayTypes) {
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            final LookupItem item=LookupItemUtil.objectToLookupItem(JavaCompletionUtil.eliminateWildcards(type));
            item.setAttribute(LookupItem.DONT_CHECK_FOR_INNERS,"");
            if (item.getObject() instanceof PsiClass) {
              JavaAwareCompletionData.setShowFQN(item);
            }
            item.setInsertHandler(new ArrayInsertHandler());
            result.addElement(item);
          }
        }
);
      }
      JavaSmartCompletionContributor.processInheritors(parameters,identifierCopy,file,expectedClassTypes,new Consumer<PsiType>(){
        public void consume(        final PsiType type){
          addExpectedType(result,type,identifierCopy);
        }
      }
,result.getPrefixMatcher());
    }
  }
);
}
