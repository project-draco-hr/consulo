{
synchronized (PsiLock.LOCK) {
    fillCache();
    VirtualFile[] vFiles=getFiles(myFileNameToFilesMap,name);
    int originalSize=vFiles.length;
    ArrayList<PsiFile> files=new ArrayList<PsiFile>(vFiles.length);
    for (int i=0; i < vFiles.length; i++) {
      VirtualFile vFile=vFiles[i];
      if (!vFile.isValid() || myManager.findFile(vFile) == null) {
        VirtualFile[] newFiles=new VirtualFile[vFiles.length - 1];
        System.arraycopy(vFiles,0,newFiles,0,i);
        System.arraycopy(vFiles,i + 1,newFiles,i,newFiles.length - i);
        vFiles=newFiles;
        i--;
        continue;
      }
      PsiFile file=myManager.findFile(vFile);
      files.add(file);
    }
    if (vFiles.length < originalSize) {
      putFiles(myFileNameToFilesMap,name,vFiles);
      if (vFiles.length == 0) {
        return PsiFile.EMPTY_ARRAY;
      }
    }
    return files.toArray(new PsiFile[files.size()]);
  }
}
