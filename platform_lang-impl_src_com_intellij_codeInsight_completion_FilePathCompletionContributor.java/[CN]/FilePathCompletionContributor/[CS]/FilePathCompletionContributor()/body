{
  extend(CompletionType.BASIC,psiElement(),new CompletionProvider<CompletionParameters>(){
    @Override protected void addCompletions(    @NotNull CompletionParameters parameters,    ProcessingContext context,    @NotNull CompletionResultSet result){
      final PsiReference psiReference=parameters.getPosition().getContainingFile().findReferenceAt(parameters.getOffset());
      if (getReference(psiReference) != null) {
        final String shortcut=getActionShortcut(IdeActions.ACTION_CLASS_NAME_COMPLETION);
        final CompletionService service=CompletionService.getCompletionService();
        if (shortcut != null) {
          service.setAdvertisementText(CodeInsightBundle.message("class.completion.file.path",shortcut));
        }
      }
    }
  }
);
  extend(CompletionType.CLASS_NAME,psiElement(),new CompletionProvider<CompletionParameters>(false){
    @Override protected void addCompletions(    @NotNull final CompletionParameters parameters,    ProcessingContext context,    @NotNull final CompletionResultSet _result){
      @NotNull final CompletionResultSet result=_result.caseInsensitive();
      final PsiElement e=parameters.getPosition();
      final Project project=e.getProject();
      final PsiReference psiReference=ApplicationManager.getApplication().runReadAction(new Computable<PsiReference>(){
        public PsiReference compute(){
          return parameters.getPosition().getContainingFile().findReferenceAt(parameters.getOffset());
        }
      }
);
      final Pair<FileReference,Boolean> fileReferencePair=getReference(psiReference);
      if (fileReferencePair != null) {
        final FileReference first=fileReferencePair.getFirst();
        if (first == null)         return;
        final FileReferenceSet set=first.getFileReferenceSet();
        String prefix=set.getPathString().substring(0,parameters.getOffset() - set.getElement().getTextRange().getStartOffset() - set.getStartInElement());
        final List<String>[] pathPrefixParts=new List[]{null};
        int lastSlashIndex;
        if ((lastSlashIndex=prefix.lastIndexOf('/')) != -1) {
          pathPrefixParts[0]=StringUtil.split(prefix.substring(0,lastSlashIndex),"/");
          prefix=prefix.substring(lastSlashIndex + 1);
        }
        final CompletionResultSet __result=result.withPrefixMatcher(prefix).caseInsensitive();
        final PsiFile originalFile=parameters.getOriginalFile();
        final VirtualFile contextFile=originalFile.getVirtualFile();
        if (contextFile != null) {
          final String[] fileNames=getAllNames(project);
          final Set<String> resultNames=new TreeSet<String>();
          for (          String fileName : fileNames) {
            if (filenameMatchesPrefixOrType(fileName,prefix,set.getSuitableFileTypes(),parameters.getInvocationCount())) {
              resultNames.add(fileName);
            }
          }
          final ProjectFileIndex index=ProjectRootManager.getInstance(project).getFileIndex();
          final Module contextModule=index.getModuleForFile(contextFile);
          if (contextModule != null) {
            final FileReferenceHelper contextHelper=FileReferenceHelperRegistrar.getNotNullHelper(originalFile);
            final GlobalSearchScope scope=ProjectScope.getProjectScope(project);
            for (            final String name : resultNames) {
              ProgressManager.checkCanceled();
              final PsiFile[] files=ApplicationManager.getApplication().runReadAction(new Computable<PsiFile[]>(){
                public PsiFile[] compute(){
                  return FilenameIndex.getFilesByName(project,name,scope);
                }
              }
);
              if (files.length > 0) {
                for (                final PsiFile file : files) {
                  ProgressManager.checkCanceled();
                  ApplicationManager.getApplication().runReadAction(new Runnable(){
                    public void run(){
                      final VirtualFile virtualFile=file.getVirtualFile();
                      if (virtualFile != null && virtualFile.isValid() && virtualFile != contextFile) {
                        if (contextHelper.isMine(project,virtualFile)) {
                          if (pathPrefixParts[0] == null || fileMatchesPathPrefix(contextHelper.getPsiFileSystemItem(project,virtualFile),pathPrefixParts[0])) {
                            __result.addElement(new FilePathLookupItem(file,contextHelper));
                          }
                        }
                      }
                    }
                  }
);
                }
              }
            }
          }
        }
        if (set.getSuitableFileTypes().length > 0 && parameters.getInvocationCount() == 1) {
          final String shortcut=getActionShortcut(IdeActions.ACTION_CLASS_NAME_COMPLETION);
          final CompletionService service=CompletionService.getCompletionService();
          if (shortcut != null) {
            service.setAdvertisementText(CodeInsightBundle.message("class.completion.file.path.all.variants",shortcut));
          }
        }
        if (fileReferencePair.getSecond())         result.stopHere();
      }
    }
  }
);
}
