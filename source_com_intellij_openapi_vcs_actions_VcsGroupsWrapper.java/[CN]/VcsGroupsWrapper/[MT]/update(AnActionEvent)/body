{
  VcsContext dataContext=VcsContextWrapper.createInstanceOn(e);
  if (myChildren == null) {
    DefaultActionGroup vcsGroupsGroup=(DefaultActionGroup)ActionManager.getInstance().getAction("VcsGroup");
    ArrayList<AnAction> validChildren=new ArrayList<AnAction>();
    AnAction[] children=vcsGroupsGroup.getChildren(new AnActionEvent(null,e.getDataContext(),e.getPlace(),myPresentationFactory.getPresentation(vcsGroupsGroup),ActionManager.getInstance(),0));
    for (int i=0; i < children.length; i++) {
      AnAction child=children[i];
      if (!(child instanceof StandardVcsGroup)) {
        LOG.assertTrue(false,"Any version control group should extends com.intellij.openapi.vcs.actions.StandardVcsGroup class. Groupd class: " + child.getClass().getName() + ", group ID: "+ ActionManager.getInstance().getId(child));
      }
      validChildren.add(child);
    }
    myChildren=validChildren.toArray(new AnAction[validChildren.size()]);
  }
  Project project=dataContext.getProject();
  Presentation presentation=e.getPresentation();
  if (project == null) {
    presentation.setVisible(false);
    return;
  }
  Collection<AbstractVcs> currentVcses=new HashSet<AbstractVcs>();
  VirtualFile[] selectedFiles=dataContext.getSelectedFiles();
  ProjectLevelVcsManager projectLevelVcsManager=ProjectLevelVcsManager.getInstance(project);
  Map<AbstractVcs,AnAction> vcsToActionMap=new HashMap<AbstractVcs,AnAction>();
  for (int i=0; i < myChildren.length; i++) {
    StandardVcsGroup child=(StandardVcsGroup)myChildren[i];
    AbstractVcs vcs=child.getVcs(project);
    vcsToActionMap.put(vcs,child);
  }
  if (selectedFiles != null) {
    for (int i=0; i < selectedFiles.length; i++) {
      VirtualFile selectedFile=selectedFiles[i];
      AbstractVcs vcs=projectLevelVcsManager.getVcsFor(selectedFile);
      if (vcs != null) {
        currentVcses.add(vcs);
      }
    }
  }
  if (currentVcses.size() == 1 && vcsToActionMap.containsKey(currentVcses.iterator().next())) {
    updateFromAction(vcsToActionMap.get(currentVcses.iterator().next()),presentation);
  }
 else {
    DefaultActionGroup composite=new DefaultActionGroup(VcsBundle.message("group.name.version.control"),true);
    for (int i=0; i < myChildren.length; i++) {
      StandardVcsGroup child=(StandardVcsGroup)myChildren[i];
      AbstractVcs vcs=child.getVcs(project);
      if (currentVcses.contains(vcs)) {
        composite.add(child);
      }
    }
    updateFromAction(composite,presentation);
    if (currentVcses.size() == 0)     e.getPresentation().setVisible(false);
  }
  super.update(e);
}
