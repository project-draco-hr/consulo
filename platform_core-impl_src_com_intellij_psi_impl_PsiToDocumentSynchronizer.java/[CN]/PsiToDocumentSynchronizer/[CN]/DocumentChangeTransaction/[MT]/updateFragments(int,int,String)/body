{
  int docStart=psiToDocumentOffset(start);
  int docEnd=psiToDocumentOffset(end);
  TextRange startRange=findFragment(docStart);
  TextRange endRange=findFragment(docEnd);
  myPsiText=myPsiText.delete(start,end).insert(start,replace);
  TextRange newFragment=new TextRange(startRange != null ? startRange.getStartOffset() : docStart,endRange != null ? endRange.getEndOffset() : docEnd);
  CharSequence newReplacement=myPsiText.subSequence(documentToPsiOffset(newFragment.getStartOffset(),false),documentToPsiOffset(newFragment.getEndOffset(),true) + replace.length() - (end - start));
  for (Iterator<TextRange> iterator=myAffectedFragments.keySet().iterator(); iterator.hasNext(); ) {
    if (iterator.next().intersects(newFragment)) {
      iterator.remove();
    }
  }
  myAffectedFragments.put(newFragment,newReplacement);
}
