{
  int delta=0;
  for (  Map.Entry<TextRange,CharSequence> entry : myAffectedFragments.entrySet()) {
    int lengthAfter=entry.getValue().length();
    TextRange range=entry.getKey();
    if (range.containsOffset(offset)) {
      return range.getStartOffset() + delta + (greedyRight ? lengthAfter : 0);
    }
    if (range.getStartOffset() > offset) {
      break;
    }
    delta+=lengthAfter - range.getLength();
  }
  return offset + delta;
}
