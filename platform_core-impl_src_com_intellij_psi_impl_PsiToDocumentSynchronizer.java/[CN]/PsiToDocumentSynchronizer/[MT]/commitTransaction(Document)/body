{
  ApplicationManager.getApplication().assertIsDispatchThread();
  final DocumentChangeTransaction documentChangeTransaction=removeTransaction(document);
  if (documentChangeTransaction == null)   return false;
  final PsiElement changeScope=documentChangeTransaction.myChangeScope;
  try {
    mySyncDocument=document;
    final PsiTreeChangeEventImpl fakeEvent=new PsiTreeChangeEventImpl(changeScope.getManager());
    fakeEvent.setParent(changeScope);
    fakeEvent.setFile(changeScope.getContainingFile());
    checkPsiModificationAllowed(fakeEvent);
    doSync(fakeEvent,true,new DocSyncAction(){
      @Override public void syncDocument(      @NotNull Document document,      @NotNull PsiTreeChangeEventImpl event){
        doCommitTransaction(document,documentChangeTransaction);
      }
    }
);
    myBus.syncPublisher(PsiDocumentTransactionListener.TOPIC).transactionCompleted(document,(PsiFile)changeScope);
  }
  finally {
    mySyncDocument=null;
  }
  return true;
}
