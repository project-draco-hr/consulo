{
  final boolean isAbsolute=SystemInfo.isUnix && StringUtil.startsWithChar(link,'/') || SystemInfo.isWindows && link.matches("^[c-zC-Z]:[/\\\\].*$");
  final File linkFile=isAbsolute ? new File(link) : new File(FileUtil.getTempDirectory(),link);
  assertTrue(link,!linkFile.exists() || linkFile.delete());
  final File parentDir=linkFile.getParentFile();
  assertTrue("link=" + link + ", parent="+ parentDir,parentDir != null && (parentDir.isDirectory() || parentDir.mkdirs()));
  final ProcessBuilder command;
  if (SystemInfo.isWindows) {
    command=new File(target).isDirectory() ? new ProcessBuilder("cmd","/C","mklink","/D",linkFile.getAbsolutePath(),target) : new ProcessBuilder("cmd","/C","mklink",linkFile.getAbsolutePath(),target);
  }
 else {
    command=new ProcessBuilder("ln","-s",target,linkFile.getAbsolutePath());
  }
  final int res=runCommand(command);
  assertEquals(command.command().toString(),0,res);
  final File targetFile=new File(target);
  final boolean shouldExist=targetFile.exists() || SystemInfo.isWindows && SystemInfo.JAVA_VERSION.startsWith("1.6");
  assertEquals("target=" + target + ", link="+ linkFile,shouldExist,linkFile.exists());
  return linkFile;
}
