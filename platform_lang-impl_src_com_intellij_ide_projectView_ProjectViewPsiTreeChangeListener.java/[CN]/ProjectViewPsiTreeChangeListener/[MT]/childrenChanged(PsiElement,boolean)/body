{
  if (parent instanceof PsiDirectory && isFlattenPackages()) {
    getUpdater().addSubtreeToUpdate(getRootNode());
    return;
  }
  long newModificationCount=myModificationTracker.getOutOfCodeBlockModificationCount();
  if (newModificationCount == myOutOfCodeBlockModificationCount)   return;
  if (stopProcessingForThisModificationCount) {
    myOutOfCodeBlockModificationCount=newModificationCount;
  }
  while (true) {
    if (parent == null)     break;
    if (parent instanceof PsiFile) {
      VirtualFile virtualFile=((PsiFile)parent).getVirtualFile();
      if (virtualFile != null && virtualFile.getFileType() != FileTypes.PLAIN_TEXT) {
        parent=((PsiFile)parent).getContainingDirectory();
        if (parent == null)         break;
      }
    }
    if (getUpdater().addSubtreeToUpdateByElement(parent)) {
      break;
    }
    if (parent instanceof PsiFile || parent instanceof PsiDirectory)     break;
    parent=parent.getParent();
  }
}
