{
  ApplicationManager.getApplication().assertReadAccessAllowed();
  String fullPath=getRootPath(rootType) + "/" + pathName;
  if (option != Option.create_new_always) {
    VirtualFile file=LocalFileSystem.getInstance().findFileByPath(fullPath);
    if (file != null && !file.isDirectory())     return file;
    if (option == Option.existing_only)     return null;
  }
  String ext=PathUtil.getFileExtension(pathName);
  String fileNameExt=PathUtil.getFileName(pathName);
  String fileName=StringUtil.trimEnd(fileNameExt,ext == null ? "" : "." + ext);
  AccessToken token=ApplicationManager.getApplication().acquireWriteActionLock(getClass());
  try {
    VirtualFile dir=VfsUtil.createDirectories(PathUtil.getParentPath(fullPath));
    if (option == Option.create_new_always) {
      return VfsUtil.createChildSequent(LocalFileSystem.getInstance(),dir,fileName,StringUtil.notNullize(ext));
    }
 else {
      return dir.createChildData(LocalFileSystem.getInstance(),fileNameExt);
    }
  }
  finally {
    token.finish();
  }
}
