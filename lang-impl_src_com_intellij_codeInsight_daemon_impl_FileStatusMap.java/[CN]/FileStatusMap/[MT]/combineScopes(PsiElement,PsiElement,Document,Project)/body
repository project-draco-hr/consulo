{
  if (scope1 == null)   return scope2;
  if (scope2 == null)   return scope1;
  final PsiDocumentManager documentManager=PsiDocumentManager.getInstance(project);
  if (!scope1.isValid() || !scope2.isValid())   return documentManager.getPsiFile(document);
  final PsiElement commonParent=PsiTreeUtil.findCommonParent(scope1,scope2);
  return commonParent == null || commonParent instanceof PsiDirectory ? documentManager.getPsiFile(document) : commonParent;
}
