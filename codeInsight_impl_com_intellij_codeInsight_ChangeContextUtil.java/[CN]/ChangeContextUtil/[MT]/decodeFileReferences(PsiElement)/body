{
  final PsiFile file=element.getContainingFile();
  element.accept(new PsiRecursiveElementVisitor(){
    @Override public void visitElement(    PsiElement element){
      final PsiFileSystemItem item=element.getCopyableUserData(REF_FILE_SYSTEM_ITEM_KEY);
      element.putCopyableUserData(REF_FILE_SYSTEM_ITEM_KEY,null);
      if (item != null && item.isValid()) {
        PsiReference[] refs=element.getReferences();
        if (refs.length > 0) {
          try {
            element=refs[refs.length - 1].bindToElement(item);
          }
 catch (          IncorrectOperationException e) {
            LOG.error(e);
          }
        }
      }
      if (element != null) {
        element.acceptChildren(this);
      }
    }
  }
);
}
