{
  List<VcsException> exceptions=new LinkedList<VcsException>();
  final VirtualFile repo=mergeDialog.getRepository();
  progressIndicator.setText(HgVcsMessages.message("hg4idea.progress.integrating",repo.getPath()));
  HgMergeCommand hgMergeCommand=new HgMergeCommand(project,repo);
  HgRevisionNumber incomingRevision=null;
  HgTagBranch branch=mergeDialog.getBranch();
  if (branch != null) {
    hgMergeCommand.setBranch(branch.getName());
    incomingRevision=branch.getHead();
  }
  HgTagBranch tag=mergeDialog.getTag();
  if (tag != null) {
    hgMergeCommand.setRevision(tag.getName());
    incomingRevision=tag.getHead();
  }
  String revision=mergeDialog.getRevision();
  if (revision != null) {
    hgMergeCommand.setRevision(revision);
    incomingRevision=HgRevisionNumber.getLocalInstance(revision);
  }
  HgRevisionNumber otherHead=mergeDialog.getOtherHead();
  if (otherHead != null) {
    hgMergeCommand.setRevision(otherHead.getRevision());
    incomingRevision=otherHead;
  }
  if (incomingRevision != null) {
    try {
      progressIndicator.setText2(HgVcsMessages.message("hg4idea.progress.merging"));
      String warnings=new HgHeadMerger(project,hgMergeCommand).merge(repo,updatedFiles,incomingRevision).getWarnings();
      if (!StringUtils.isBlank(warnings)) {
        VcsException warning=new VcsException(warnings);
        warning.setIsWarning(true);
        exceptions.add(warning);
      }
      ApplicationManager.getApplication().invokeAndWait(new Runnable(){
        public void run(){
          new HgConflictResolver(project,updatedFiles).resolve(repo);
        }
      }
,ModalityState.defaultModalityState());
    }
 catch (    VcsException e) {
      exceptions.add(e);
    }
  }
 else {
    exceptions.add(new VcsException(HgVcsMessages.message("hg4idea.error.invalidTarget")));
  }
  return new UpdateSessionAdapter(exceptions,false);
}
