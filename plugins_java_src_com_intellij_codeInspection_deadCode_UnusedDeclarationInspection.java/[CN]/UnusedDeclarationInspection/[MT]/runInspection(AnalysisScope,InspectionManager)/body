{
  getRefManager().iterate(new RefJavaVisitor(){
    @Override public void visitElement(    @NotNull final RefEntity refEntity){
      if (refEntity instanceof RefJavaElement) {
        final RefElementImpl refElement=(RefElementImpl)refEntity;
        if (!refElement.isSuspicious())         return;
        PsiFile file=refElement.getContainingFile();
        if (file == null)         return;
        final boolean isSuppressed=refElement.isSuppressed(getShortName(),ALTERNATIVE_ID);
        if (!getContext().isToCheckFile(file,UnusedDeclarationInspection.this) || isSuppressed) {
          if (isSuppressed || !scope.contains(file)) {
            getEntryPointsManager().addEntryPoint(refElement,false);
          }
          return;
        }
        refElement.accept(new RefJavaVisitor(){
          @Override public void visitMethod(          @NotNull RefMethod method){
            if (isAddMainsEnabled() && method.isAppMain()) {
              getEntryPointsManager().addEntryPoint(method,false);
            }
          }
          @Override public void visitClass(          @NotNull RefClass aClass){
            if (isAddAppletEnabled() && aClass.isApplet() || isAddServletEnabled() && aClass.isServlet()) {
              getEntryPointsManager().addEntryPoint(aClass,false);
            }
          }
        }
);
      }
    }
  }
);
  if (isAddNonJavaUsedEnabled()) {
    checkForReachables();
    ProgressManager.getInstance().runProcess(new Runnable(){
      @Override public void run(){
        final RefFilter filter=new StrictUnreferencedFilter(UnusedDeclarationInspection.this);
        final PsiSearchHelper helper=PsiSearchHelper.SERVICE.getInstance(getRefManager().getProject());
        getRefManager().iterate(new RefJavaVisitor(){
          @Override public void visitElement(          @NotNull final RefEntity refEntity){
            if (refEntity instanceof RefClass && filter.accepts((RefClass)refEntity)) {
              findExternalClassReferences((RefClass)refEntity);
            }
 else             if (refEntity instanceof RefMethod) {
              RefMethod refMethod=(RefMethod)refEntity;
              if (refMethod.isConstructor() && filter.accepts(refMethod)) {
                findExternalClassReferences(refMethod.getOwnerClass());
              }
            }
          }
          private void findExternalClassReferences(          final RefClass refElement){
            PsiClass psiClass=refElement.getElement();
            String qualifiedName=psiClass.getQualifiedName();
            if (qualifiedName != null) {
              helper.processUsagesInNonJavaFiles(qualifiedName,new PsiNonJavaFileReferenceProcessor(){
                @Override public boolean process(                PsiFile file,                int startOffset,                int endOffset){
                  getEntryPointsManager().addEntryPoint(refElement,false);
                  return false;
                }
              }
,GlobalSearchScope.projectScope(getContext().getProject()));
            }
          }
        }
);
      }
    }
,null);
  }
  myProcessedSuspicious=new HashSet<RefElement>();
  myPhase=1;
}
