{
  final Ref<Pair<CompletionContext,PsiElement>> ref=Ref.create(null);
  CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          ref.set(insertDummyIdentifier(context,patcher,context.file,context.editor));
        }
      }
);
    }
  }
);
  final PsiElement insertedElement=ref.get().getSecond();
  final CompletionContext newContext=ref.get().getFirst();
  insertedElement.putUserData(CompletionContext.COMPLETION_CONTEXT_KEY,newContext);
  final int offset=newContext.getStartOffset();
  LOG.assertTrue(insertedElement.getContainingFile().findElementAt(offset) == insertedElement,"wrong offset");
  LOG.assertTrue(insertedElement.getContainingFile().getText().substring(insertedElement.getTextRange().getStartOffset(),insertedElement.getTextRange().getEndOffset()).equals(insertedElement.getText()),"wrong text");
  return new CompletionParameters(insertedElement,newContext.file,myCompletionType,offset,invocationCount);
}
