{
  final Ref<Pair<CompletionContext,PsiElement>> ref=Ref.create(null);
  CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          ref.set(insertDummyIdentifier(context,patcher,context.file,context.editor));
        }
      }
);
    }
  }
);
  final PsiElement insertedElement=ref.get().getSecond();
  final CompletionContext newContext=ref.get().getFirst();
  insertedElement.putUserData(CompletionContext.COMPLETION_CONTEXT_KEY,newContext);
  return new CompletionParameters(insertedElement,newContext.file,myCompletionType,newContext.getStartOffset(),invocationCount);
}
