{
  final ApplicationAdapter listener=new ApplicationAdapter(){
    @Override public void beforeWriteActionStart(    Object action){
      indicator.cancelByWriteAction();
    }
  }
;
  ApplicationManager.getApplication().addApplicationListener(listener);
  final Semaphore startSemaphore=new Semaphore();
  startSemaphore.down();
  startSemaphore.down();
  final Semaphore offsets=new Semaphore();
  offsets.down();
  spawnProcess(ProgressWrapper.wrap(indicator),new Runnable(){
    public void run(){
      try {
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            startSemaphore.up();
            ProgressManager.checkCanceled();
            if (!initContext.getOffsetMap().wasModified(CompletionInitializationContext.IDENTIFIER_END_OFFSET)) {
              try {
                final int selectionEndOffset=initContext.getSelectionEndOffset();
                final PsiReference reference=initContext.getFile().findReferenceAt(selectionEndOffset);
                if (reference != null) {
                  initContext.setReplacementOffset(findReplacementOffset(selectionEndOffset,reference));
                }
              }
 catch (              IndexNotReadyException ignored) {
              }
            }
          }
        }
);
      }
 catch (      ProcessCanceledException ignored) {
      }
 finally {
        offsets.up();
      }
    }
  }
);
  final AtomicReference<LookupElement[]> data=new AtomicReference<LookupElement[]>(null);
  spawnProcess(indicator,new Runnable(){
    public void run(){
      try {
        ApplicationManager.getApplication().runReadAction(new Runnable(){
          public void run(){
            try {
              startSemaphore.up();
              ProgressManager.checkCanceled();
              final LookupElement[] result=CompletionService.getCompletionService().performCompletion(parameters,new Consumer<LookupElement>(){
                public void consume(                final LookupElement lookupElement){
                  indicator.addItem(lookupElement);
                }
              }
);
              offsets.waitFor();
              data.set(result);
            }
  finally {
              ApplicationManager.getApplication().removeApplicationListener(listener);
            }
          }
        }
);
      }
 catch (      ProcessCanceledException ignored) {
      }
    }
  }
);
  startSemaphore.waitFor();
  return data;
}
