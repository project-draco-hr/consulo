{
  final Semaphore startSemaphore=new Semaphore();
  startSemaphore.down();
  final AtomicReference<LookupElement[]> data=new AtomicReference<LookupElement[]>(null);
  final Runnable computeRunnable=new Runnable(){
    public void run(){
      ProgressManager.getInstance().runProcess(new Runnable(){
        @Override public void run(){
          try {
            ApplicationManager.getApplication().runReadAction(new Runnable(){
              public void run(){
                startSemaphore.up();
                ProgressManager.checkCanceled();
                indicator.duringCompletion(initContext);
                ProgressManager.checkCanceled();
                final List<LookupElement> items=new ArrayList<LookupElement>();
                CompletionService.getCompletionService().performCompletion(parameters,new Consumer<CompletionResult>(){
                  public void consume(                  final CompletionResult result){
                    indicator.addItem(result);
                    items.add(result.getLookupElement());
                  }
                }
);
                indicator.processDelayQueue();
                data.set(items.toArray(new LookupElement[items.size()]));
              }
            }
);
          }
 catch (          ProcessCanceledException ignored) {
          }
        }
      }
,indicator);
    }
  }
;
  if (ApplicationManager.getApplication().isUnitTestMode() && !CompletionAutoPopupHandler.ourTestingAutopopup) {
    computeRunnable.run();
  }
 else {
    ApplicationManager.getApplication().executeOnPooledThread(computeRunnable);
  }
  startSemaphore.waitFor();
  return data;
}
