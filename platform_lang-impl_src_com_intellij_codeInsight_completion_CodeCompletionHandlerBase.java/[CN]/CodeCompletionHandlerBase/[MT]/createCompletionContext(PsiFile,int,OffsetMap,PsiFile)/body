{
  CompletionAssertions.assertHostInfo(hostCopy,hostMap);
  InjectedLanguageManager injectedLanguageManager=InjectedLanguageManager.getInstance(hostCopy.getProject());
  CompletionContext context;
  PsiFile injected=InjectedLanguageUtil.findInjectedPsiNoCommit(hostCopy,hostStartOffset);
  if (injected != null) {
    if (injected instanceof PsiFileImpl && injectedLanguageManager.isInjectedFragment(originalFile)) {
      ((PsiFileImpl)injected).setOriginalFile(originalFile);
    }
    DocumentWindow documentWindow=InjectedLanguageUtil.getDocumentWindow(injected);
    CompletionAssertions.assertInjectedOffsets(hostStartOffset,injectedLanguageManager,injected,documentWindow);
    context=new CompletionContext(injected,translateOffsetMapToInjected(hostMap,documentWindow));
  }
 else {
    context=new CompletionContext(hostCopy,hostMap);
  }
  CompletionAssertions.assertFinalOffsets(originalFile,context,injected);
  return context;
}
