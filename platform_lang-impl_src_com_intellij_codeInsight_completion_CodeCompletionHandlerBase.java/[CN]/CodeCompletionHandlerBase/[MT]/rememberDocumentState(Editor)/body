{
  final Editor editor=InjectedLanguageFacadeImpl.getTopLevelEditor(_editor);
  final String documentText=editor.getDocument().getText();
  final int caret=editor.getCaretModel().getOffset();
  final int selStart=editor.getSelectionModel().getSelectionStart();
  final int selEnd=editor.getSelectionModel().getSelectionEnd();
  final int vOffset=editor.getScrollingModel().getVerticalScrollOffset();
  final int hOffset=editor.getScrollingModel().getHorizontalScrollOffset();
  return new Runnable(){
    @Override public void run(){
      DocumentEx document=(DocumentEx)editor.getDocument();
      document.replaceString(0,document.getTextLength(),documentText);
      editor.getCaretModel().moveToOffset(caret);
      editor.getSelectionModel().setSelection(selStart,selEnd);
      editor.getScrollingModel().scrollHorizontally(hOffset);
      editor.getScrollingModel().scrollVertically(vOffset);
    }
  }
;
}
