{
  if (context.getHandler().autopopup) {
    FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_BASIC);
  }
  final Editor editor=context.getEditor();
  final PsiFile file=context.getParameters().getOriginalFile();
  final InsertionContext context1=new InsertionContext(context.getOffsetMap(),completionChar,items.toArray(new LookupElement[items.size()]),file,editor);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      final int idEndOffset=context.getIdentifierEndOffset();
      if (idEndOffset != context.getSelectionEndOffset() && CompletionUtil.isOverwrite(item,completionChar)) {
        editor.getDocument().deleteString(context.getSelectionEndOffset(),idEndOffset);
      }
      PsiDocumentManager.getInstance(context.getProject()).commitAllDocuments();
      item.handleInsert(context1);
      PostprocessReformattingAspect.getInstance(context.getProject()).doPostponedFormatting();
      final int tailOffset=context1.getTailOffset();
      if (tailOffset >= 0) {
        if (context1.shouldAddCompletionChar() && completionChar != Lookup.AUTO_INSERT_SELECT_CHAR && completionChar != Lookup.REPLACE_SELECT_CHAR && completionChar != Lookup.NORMAL_SELECT_CHAR && completionChar != Lookup.COMPLETE_STATEMENT_SELECT_CHAR) {
          TailType.insertChar(editor,tailOffset,completionChar);
        }
      }
 else {
        LOG.error("tailOffset<0 after inserting " + item + " of "+ item.getClass());
      }
      editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
    }
  }
);
  final Runnable runnable=context1.getLaterRunnable();
  if (runnable != null) {
    final Runnable runnable1=new Runnable(){
      public void run(){
        final Project project=context1.getProject();
        if (project.isDisposed())         return;
        runnable.run();
      }
    }
;
    if (!ApplicationManager.getApplication().isUnitTestMode()) {
      ApplicationManager.getApplication().invokeLater(runnable1);
    }
 else {
      runnable1.run();
    }
  }
}
