{
  final Ref<CompletionContext> ref=Ref.create(null);
  CommandProcessor.getInstance().runUndoTransparentAction(new Runnable(){
    @Override public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          ref.set(insertDummyIdentifier(initContext));
        }
      }
);
    }
  }
);
  final CompletionContext newContext=ref.get();
  final int offset=newContext.getStartOffset();
  final PsiFile fileCopy=newContext.file;
  final PsiElement insertedElement=newContext.file.findElementAt(newContext.getStartOffset());
  if (insertedElement == null) {
    throw new AssertionError("offset " + newContext.getStartOffset() + " at:\n text=\""+ fileCopy.getText()+ "\"\n instance="+ fileCopy);
  }
  insertedElement.putUserData(CompletionContext.COMPLETION_CONTEXT_KEY,newContext);
  LOG.assertTrue(fileCopy.findElementAt(offset) == insertedElement,"wrong offset");
  final TextRange range=insertedElement.getTextRange();
  if (!range.substring(fileCopy.getText()).equals(insertedElement.getText())) {
    LOG.error("wrong text: copy='" + fileCopy.getText() + "'; element='"+ insertedElement.getText()+ "'; range="+ range);
  }
  return new CompletionParameters(insertedElement,fileCopy.getOriginalFile(),myCompletionType,offset,invocationCount,invocationCount >= 2);
}
