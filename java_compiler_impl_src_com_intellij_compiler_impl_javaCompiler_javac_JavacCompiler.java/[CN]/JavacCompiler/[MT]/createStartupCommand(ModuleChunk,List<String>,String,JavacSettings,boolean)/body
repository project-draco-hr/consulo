{
  final Sdk jdk=getJdkForStartupCommand(chunk);
  final String versionString=jdk.getVersionString();
  JavaSdkVersion version=JavaSdk.getInstance().getVersion(jdk);
  if (versionString == null || version == null || !(jdk.getSdkType() instanceof JavaSdkType)) {
    throw new IllegalArgumentException(CompilerBundle.message("javac.error.unknown.jdk.version",jdk.getName()));
  }
  final boolean isVersion1_0=version == JavaSdkVersion.JDK_1_0;
  final boolean isVersion1_1=version == JavaSdkVersion.JDK_1_1;
  JavaSdkType sdkType=(JavaSdkType)jdk.getSdkType();
  final String toolsJarPath=sdkType.getToolsPath(jdk);
  if (toolsJarPath == null) {
    throw new IllegalArgumentException(CompilerBundle.message("javac.error.tools.jar.missing",jdk.getName()));
  }
  final String vmExePath=sdkType.getVMExecutablePath(jdk);
  commandLine.add(vmExePath);
  if (version.isAtLeast(JavaSdkVersion.JDK_1_2)) {
    commandLine.add("-Xmx" + javacSettings.MAXIMUM_HEAP_SIZE + "m");
  }
 else {
    commandLine.add("-mx" + javacSettings.MAXIMUM_HEAP_SIZE + "m");
  }
  final List<String> additionalOptions=addAdditionalSettings(commandLine,javacSettings,myAnnotationProcessorMode,version,chunk,annotationProcessorsEnabled);
  CompilerUtil.addLocaleOptions(commandLine,false);
  commandLine.add("-classpath");
  if (isVersion1_0) {
    commandLine.add(sdkType.getToolsPath(jdk));
  }
 else {
    commandLine.add(sdkType.getToolsPath(jdk) + File.pathSeparator + JavaSdkUtil.getIdeaRtJarPath());
    commandLine.add(JavacRunner.class.getName());
    commandLine.add("\"" + versionString + "\"");
  }
  if (version.isAtLeast(JavaSdkVersion.JDK_1_3)) {
    commandLine.add(JAVAC_MAIN_CLASS);
  }
 else {
    commandLine.add(JAVAC_MAIN_CLASS_OLD);
  }
  addCommandLineOptions(chunk,commandLine,outputPath,jdk,isVersion1_0,isVersion1_1,myTempFiles,true,true,myAnnotationProcessorMode);
  commandLine.addAll(additionalOptions);
  final List<VirtualFile> files=chunk.getFilesToCompile();
  if (isVersion1_0) {
    for (    VirtualFile file : files) {
      String path=file.getPath();
      if (LOG.isDebugEnabled()) {
        LOG.debug("Adding path for compilation " + path);
      }
      commandLine.add(CompilerUtil.quotePath(path));
    }
  }
 else {
    File sourcesFile=FileUtil.createTempFile("javac",".tmp");
    sourcesFile.deleteOnExit();
    myTempFiles.add(sourcesFile);
    final PrintWriter writer=new PrintWriter(new BufferedWriter(new FileWriter(sourcesFile)));
    try {
      for (      final VirtualFile file : files) {
        final String path=version.isAtLeast(JavaSdkVersion.JDK_1_5) ? file.getPath().replace('/',File.separatorChar) : file.getPath();
        if (LOG.isDebugEnabled()) {
          LOG.debug("Adding path for compilation " + path);
        }
        writer.println(isVersion1_1 ? path : CompilerUtil.quotePath(path));
      }
    }
  finally {
      writer.close();
    }
    commandLine.add("@" + sourcesFile.getAbsolutePath());
  }
}
