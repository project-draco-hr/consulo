{
  final PsiType variableOrMethodType;
  if (variableOrMethod instanceof PsiVariable) {
    final PsiVariable variable=(PsiVariable)variableOrMethod;
    variableOrMethodType=variable.getType();
  }
 else   if (variableOrMethod instanceof PsiMethod) {
    final PsiMethod method=(PsiMethod)variableOrMethod;
    variableOrMethodType=method.getReturnType();
    if (variableOrMethodType == PsiType.VOID) {
      return Collections.EMPTY_LIST;
    }
  }
 else {
    throw new IllegalArgumentException("PsiMethod or PsiVariable expected: " + variableOrMethod);
  }
  if (!(variableOrMethodType instanceof PsiClassType)) {
    return Collections.EMPTY_LIST;
  }
  final PsiClassType variableOrMethodClassType=(PsiClassType)variableOrMethodType;
  final PsiClass variableOrMethodClass=variableOrMethodClassType.resolve();
  if (variableOrMethodClass == null) {
    return Collections.EMPTY_LIST;
  }
  final PsiManager manager=variableOrMethod.getManager();
  final GlobalSearchScope scope=variableOrMethod.getResolveScope();
  Set<PsiClass> weakestTypeClasses=new HashSet();
  final PsiClass javaLangObjectClass=manager.findClass("java.lang.Object",scope);
  if (javaLangObjectClass == null || variableOrMethodClass.equals(javaLangObjectClass)) {
    return Collections.EMPTY_LIST;
  }
  weakestTypeClasses.add(javaLangObjectClass);
  final Query<PsiReference> query=ReferencesSearch.search(variableOrMethod);
  boolean hasUsages=false;
  for (  PsiReference reference : query) {
    if (reference == null) {
      continue;
    }
    hasUsages=true;
    PsiElement referenceElement=reference.getElement();
    PsiElement referenceParent=referenceElement.getParent();
    if (referenceParent instanceof PsiMethodCallExpression) {
      referenceElement=referenceParent;
      referenceParent=referenceElement.getParent();
    }
    final PsiElement referenceGrandParent=referenceParent.getParent();
    if (referenceParent instanceof PsiExpressionList) {
      if (!(referenceGrandParent instanceof PsiMethodCallExpression)) {
        return Collections.EMPTY_LIST;
      }
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)referenceGrandParent;
      final PsiReferenceExpression methodExpression=methodCallExpression.getMethodExpression();
      final PsiElement methodElement=methodExpression.resolve();
      if (!(methodElement instanceof PsiMethod)) {
        return Collections.EMPTY_LIST;
      }
      final PsiMethod method=(PsiMethod)methodElement;
      if (!(referenceElement instanceof PsiExpression)) {
        return Collections.EMPTY_LIST;
      }
      final PsiExpression expression=(PsiExpression)referenceElement;
      final PsiExpressionList expressionList=(PsiExpressionList)referenceParent;
      final int index=getExpressionIndex(expression,expressionList);
      final PsiParameterList parameterList=method.getParameterList();
      if (parameterList.getParametersCount() == 0) {
        return Collections.EMPTY_LIST;
      }
      final PsiParameter[] parameters=parameterList.getParameters();
      final PsiParameter parameter;
      if (index < parameters.length) {
        parameter=parameters[index];
      }
 else {
        parameter=parameters[parameters.length - 1];
      }
      final PsiType type=parameter.getType();
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.EMPTY_LIST;
      }
    }
 else     if (referenceGrandParent instanceof PsiMethodCallExpression) {
      final PsiMethodCallExpression methodCallExpression=(PsiMethodCallExpression)referenceGrandParent;
      final PsiReferenceExpression methodExpression=methodCallExpression.getMethodExpression();
      final PsiElement target=methodExpression.resolve();
      if (!(target instanceof PsiMethod)) {
        return Collections.EMPTY_LIST;
      }
      final PsiMethod method=(PsiMethod)target;
      final PsiMethod[] superMethods=method.findDeepestSuperMethods();
      boolean checked=false;
      if (superMethods.length > 0) {
        final PsiType expectedType=ExpectedTypeUtils.findExpectedType(methodCallExpression,false);
        for (        PsiMethod superMethod : superMethods) {
          final PsiType returnType=superMethod.getReturnType();
          if (expectedType != null && !expectedType.isAssignableFrom(returnType)) {
            continue;
          }
          final PsiClass containingClass=superMethod.getContainingClass();
          checkClass(containingClass,weakestTypeClasses);
          checked=true;
        }
      }
      if (!checked) {
        final PsiType returnType=method.getReturnType();
        if (returnType instanceof PsiClassType) {
          final PsiClassType classType=(PsiClassType)returnType;
          final PsiClass aClass=classType.resolve();
          if (aClass instanceof PsiTypeParameter) {
            return Collections.EMPTY_LIST;
          }
        }
        final PsiClass containingClass=method.getContainingClass();
        checkClass(containingClass,weakestTypeClasses);
      }
    }
 else     if (referenceParent instanceof PsiAssignmentExpression) {
      final PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)referenceParent;
      final PsiExpression lhs=assignmentExpression.getLExpression();
      final PsiExpression rhs=assignmentExpression.getRExpression();
      final PsiType lhsType=lhs.getType();
      if (referenceElement.equals(rhs)) {
        if (!checkType(lhsType,weakestTypeClasses)) {
          return Collections.EMPTY_LIST;
        }
      }
 else       if (useRighthandTypeAsWeakestTypeInAssignments) {
        if (rhs == null) {
          return Collections.EMPTY_LIST;
        }
        if (!(rhs instanceof PsiNewExpression) || !(rhs instanceof PsiTypeCastExpression)) {
          final PsiType rhsType=rhs.getType();
          if (lhsType.equals(rhsType)) {
            return Collections.EMPTY_LIST;
          }
        }
      }
    }
 else     if (referenceParent instanceof PsiVariable) {
      final PsiVariable variable=(PsiVariable)referenceParent;
      final PsiType type=variable.getType();
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.EMPTY_LIST;
      }
    }
 else     if (referenceParent instanceof PsiForeachStatement) {
      final PsiForeachStatement foreachStatement=(PsiForeachStatement)referenceParent;
      if (foreachStatement.getIteratedValue() != referenceElement) {
        return Collections.EMPTY_LIST;
      }
      final PsiClass javaLangIterableClass=manager.findClass("java.lang.Iterable",scope);
      if (javaLangIterableClass == null) {
        return Collections.EMPTY_LIST;
      }
      checkClass(javaLangIterableClass,weakestTypeClasses);
    }
 else     if (referenceParent instanceof PsiReturnStatement) {
      final PsiMethod containingMethod=PsiTreeUtil.getParentOfType(referenceParent,PsiMethod.class);
      if (containingMethod == null) {
        return Collections.EMPTY_LIST;
      }
      final PsiType type=containingMethod.getReturnType();
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.EMPTY_LIST;
      }
    }
 else     if (referenceParent instanceof PsiReferenceExpression) {
      final PsiReferenceExpression referenceExpression=(PsiReferenceExpression)referenceParent;
      final PsiElement target=referenceExpression.resolve();
      if (!(target instanceof PsiField)) {
        return Collections.EMPTY_LIST;
      }
      final PsiField field=(PsiField)target;
      final PsiClass containingClass=field.getContainingClass();
      checkClass(containingClass,weakestTypeClasses);
    }
 else     if (referenceParent instanceof PsiArrayInitializerExpression) {
      final PsiArrayInitializerExpression arrayInitializerExpression=(PsiArrayInitializerExpression)referenceParent;
      final PsiType type=arrayInitializerExpression.getType();
      if (!(type instanceof PsiArrayType)) {
        return Collections.EMPTY_LIST;
      }
      final PsiArrayType arrayType=(PsiArrayType)type;
      final PsiType componentType=arrayType.getComponentType();
      if (!checkType(componentType,weakestTypeClasses)) {
        return Collections.EMPTY_LIST;
      }
    }
 else     if (referenceParent instanceof PsiThrowStatement) {
      final PsiThrowStatement throwStatement=(PsiThrowStatement)referenceParent;
      final PsiClassType runtimeExceptionType=PsiType.getJavaLangRuntimeException(manager,throwStatement.getResolveScope());
      final PsiClass runtimeExceptionClass=runtimeExceptionType.resolve();
      if (runtimeExceptionClass != null && InheritanceUtil.isInheritorOrSelf(variableOrMethodClass,runtimeExceptionClass,true)) {
        if (!checkType(runtimeExceptionType,weakestTypeClasses)) {
          return Collections.EMPTY_LIST;
        }
      }
 else {
        final PsiMethod method=PsiTreeUtil.getParentOfType(throwStatement,PsiMethod.class);
        final PsiReferenceList throwsList=method.getThrowsList();
        final PsiClassType[] referencedTypes=throwsList.getReferencedTypes();
        boolean checked=false;
        for (        PsiClassType referencedType : referencedTypes) {
          final PsiClass throwableClass=referencedType.resolve();
          if (throwableClass == null || !InheritanceUtil.isInheritorOrSelf(variableOrMethodClass,throwableClass,true)) {
            continue;
          }
          if (!checkType(referencedType,weakestTypeClasses)) {
            continue;
          }
          checked=true;
        }
        if (!checked) {
          return Collections.EMPTY_LIST;
        }
      }
    }
 else     if (referenceParent instanceof PsiConditionalExpression) {
      final PsiConditionalExpression conditionalExpression=(PsiConditionalExpression)referenceParent;
      final PsiType type=ExpectedTypeUtils.findExpectedType(conditionalExpression,true);
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.EMPTY_LIST;
      }
    }
 else     if (referenceParent instanceof PsiBinaryExpression) {
      final PsiBinaryExpression binaryExpression=(PsiBinaryExpression)referenceParent;
      final PsiType type=binaryExpression.getType();
      if (!checkType(type,weakestTypeClasses)) {
        return Collections.EMPTY_LIST;
      }
    }
    if (weakestTypeClasses.contains(variableOrMethodClass) || weakestTypeClasses.isEmpty()) {
      return Collections.EMPTY_LIST;
    }
  }
  if (!hasUsages) {
    return Collections.EMPTY_LIST;
  }
  weakestTypeClasses=filterVisibleClasses(weakestTypeClasses,variableOrMethod);
  return Collections.unmodifiableCollection(weakestTypeClasses);
}
