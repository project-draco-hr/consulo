{
  final boolean forceClean=Boolean.TRUE == ourForcedClean.getAndSet(Boolean.FALSE);
  final StubIndexExtension<?,?>[] extensions=Extensions.getExtensions(StubIndexExtension.EP_NAME);
  boolean needRebuild=false;
  for (  StubIndexExtension extension : extensions) {
    needRebuild|=registerIndexer(extension,forceClean);
  }
  if (needRebuild) {
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      requestRebuild();
    }
 else {
      final Throwable e=new Throwable();
      ApplicationManager.getApplication().invokeLater(new Runnable(){
        @Override public void run(){
          forceRebuild(e);
        }
      }
);
    }
  }
  dropUnregisteredIndices();
  myStubProcessingHelper=new StubProcessingHelper(fileBasedIndex);
}
