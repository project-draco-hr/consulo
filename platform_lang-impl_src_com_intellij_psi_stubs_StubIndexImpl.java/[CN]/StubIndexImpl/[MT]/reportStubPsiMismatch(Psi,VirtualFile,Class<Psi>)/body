{
  if (file == null) {
    super.reportStubPsiMismatch(psi,file,requiredClass);
    return;
  }
  StringWriter writer=new StringWriter();
  PrintWriter out=new PrintWriter(writer);
  out.print("Invalid stub element type in index:");
  out.printf("\nfile: %s\npsiElement: %s\nrequiredClass: %s\nactualClass: %s",file,psi,requiredClass,psi.getClass());
  out.printf("\nvirtualFile: size:%s; stamp:%s; modCount:%s",file.getLength(),file.getModificationStamp(),file.getModificationCount());
  Document document=FileDocumentManager.getInstance().getCachedDocument(file);
  if (document != null) {
    boolean committed=PsiDocumentManager.getInstance(psi.getProject()).isCommitted(document);
    boolean saved=!FileDocumentManager.getInstance().isDocumentUnsaved(document);
    out.printf("\ndocument: size:%s; stamp:%s; committed:%s; saved:%s",document.getTextLength(),document.getModificationStamp(),committed,saved);
  }
  PsiFile psiFile=psi.getManager().findFile(file);
  if (psiFile != null) {
    out.printf("\npsiFile: size:%s; stamp:%s; class:%s",psiFile.getTextLength(),psiFile.getViewProvider().getModificationStamp(),psiFile.getClass().getName());
  }
  StubTree stub=psiFile instanceof PsiFileWithStubSupport ? ((PsiFileWithStubSupport)psiFile).getStubTree() : null;
  FileElement treeElement=stub == null && psiFile instanceof PsiFileImpl ? ((PsiFileImpl)psiFile).getTreeElement() : null;
  if (stub != null) {
    out.printf("\nstubInfo: " + stub.getDebugInfo());
  }
 else   if (treeElement != null) {
    out.printf("\nfileAST: size:%s; parsed:%s",treeElement.getTextLength(),treeElement.isParsed());
  }
  out.printf("\nindexing info: " + StubUpdatingIndex.getIndexingStampInfo(file));
  LOG.error(writer.toString());
}
