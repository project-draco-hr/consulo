{
  if (editor.isViewer())   return;
  Document doc=editor.getDocument();
  if (!doc.isWritable()) {
    if (!FileDocumentManager.fileForDocumentCheckedOutSuccessfully(doc,DataKeys.PROJECT.getData(dataContext))) {
      return;
    }
  }
  Project project=editor.getProject();
  doc.startGuardedBlockChecking();
  if (project != null)   PsiManager.getInstance(project).addPsiTreeChangeListener(myCommitLogger);
  try {
    final String str=String.valueOf(charTyped);
    CommandProcessor.getInstance().setCurrentCommandName(EditorBundle.message("typing.in.editor.command.name"));
    EditorModificationUtil.typeInStringAtCaretHonorBlockSelection(editor,str,true);
  }
 catch (  ReadOnlyFragmentModificationException e) {
    EditorActionManager.getInstance().getReadonlyFragmentModificationHandler().handle(e);
  }
 finally {
    if (project != null)     PsiManager.getInstance(project).removePsiTreeChangeListener(myCommitLogger);
    doc.stopGuardedBlockChecking();
  }
}
