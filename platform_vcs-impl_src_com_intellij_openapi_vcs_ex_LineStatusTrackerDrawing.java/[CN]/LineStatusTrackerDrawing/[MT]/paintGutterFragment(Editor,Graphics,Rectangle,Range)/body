{
  final EditorGutterComponentEx gutter=((EditorEx)editor).getGutterComponentEx();
  Color gutterColor=getDiffGutterColor(range);
  Color borderColor=getDiffGutterBorderColor();
  final int x=r.x + r.width - 3;
  final int endX=gutter.getWhitespaceSeparatorOffset();
  if (range.getInnerRanges() == null) {
    if (r.height > 0) {
      paintRect(g,gutterColor,borderColor,x,r.y,endX,r.y + r.height);
    }
 else {
      paintTriangle(g,gutterColor,borderColor,x,endX,r.y);
    }
  }
 else {
    if (range.getType() == Range.DELETED) {
      final int y=lineToY(editor,range.getLine1());
      paintTriangle(g,gutterColor,borderColor,x,endX,y);
    }
 else {
      final int y=lineToY(editor,range.getLine1());
      int endY=lineToY(editor,range.getLine2());
      List<Range.InnerRange> innerRanges=range.getInnerRanges();
      for (      Range.InnerRange innerRange : innerRanges) {
        if (innerRange.getType() == Range.DELETED)         continue;
        int start=lineToY(editor,innerRange.getLine1());
        int end=lineToY(editor,innerRange.getLine2());
        paintRect(g,getDiffColor(innerRange),null,x,start,endX,end);
      }
      for (int i=0; i < innerRanges.size(); i++) {
        Range.InnerRange innerRange=innerRanges.get(i);
        if (innerRange.getType() != Range.DELETED)         continue;
        int start;
        int end;
        if (i == 0) {
          start=lineToY(editor,innerRange.getLine1());
          end=lineToY(editor,innerRange.getLine2()) + 5;
        }
 else         if (i == innerRanges.size() - 1) {
          start=lineToY(editor,innerRange.getLine1()) - 5;
          end=lineToY(editor,innerRange.getLine2());
        }
 else {
          start=lineToY(editor,innerRange.getLine1()) - 3;
          end=lineToY(editor,innerRange.getLine2()) + 3;
        }
        paintRect(g,getDiffColor(innerRange),null,x,start,endX,end);
      }
      paintRect(g,null,borderColor,x,y,endX,endY);
    }
  }
}
