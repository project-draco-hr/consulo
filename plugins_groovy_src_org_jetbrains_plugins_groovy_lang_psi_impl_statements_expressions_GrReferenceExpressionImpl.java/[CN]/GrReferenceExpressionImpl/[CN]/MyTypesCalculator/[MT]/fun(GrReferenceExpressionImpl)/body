{
  final PsiType inferred=GroovyPsiManager.getInstance(refExpr.getProject()).getTypeInferenceHelper().getInferredType(refExpr);
  final PsiType nominal=refExpr.getNominalTypeImpl();
  if (inferred == null && nominal == null && refExpr.getQualifierExpression() == null) {
    return TypesUtil.getTypeForContextSpecificReferenceExpression(refExpr);
  }
  if (inferred == null)   return nominal;
  if (nominal == null)   return inferred;
  if (!nominal.isAssignableFrom(inferred)) {
    final PsiElement resolved=refExpr.resolve();
    if (resolved instanceof GrVariable && ((GrVariable)resolved).getTypeElementGroovy() != null) {
      return nominal;
    }
  }
  return inferred;
}
