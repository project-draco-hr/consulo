{
  final PsiType inferred=GroovyPsiManager.getInstance(refExpr.getProject()).getTypeInferenceHelper().getInferredType(refExpr);
  final PsiType nominal=refExpr.getNominalTypeImpl();
  if (inferred == null || PsiType.NULL.equals(inferred)) {
    if (nominal == null) {
      final PsiElement resolved=refExpr.resolve();
      if (resolved instanceof GrVariableBase)       return ((GrVariableBase)resolved).getTypeGroovy();
    }
    return nominal;
  }
  if (nominal == null)   return inferred;
  if (!TypeConversionUtil.isAssignable(nominal,inferred,false)) {
    final PsiElement resolved=refExpr.resolve();
    if (resolved instanceof GrVariable && ((GrVariable)resolved).getTypeElementGroovy() != null) {
      return nominal;
    }
  }
  return inferred;
}
