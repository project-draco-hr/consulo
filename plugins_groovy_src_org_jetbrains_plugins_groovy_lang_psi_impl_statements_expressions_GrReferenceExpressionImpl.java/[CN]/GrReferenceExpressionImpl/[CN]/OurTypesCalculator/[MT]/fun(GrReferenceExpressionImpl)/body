{
  final PsiType inferred=TypeInferenceHelper.getInferredType(refExpr);
  final PsiType nominal=refExpr.getNominalType();
  if (inferred == null || PsiType.NULL.equals(inferred)) {
    if (nominal == null) {
      if (!refExpr.isValid()) {
        throw new AssertionError("invalid reference");
      }
      final PsiElement resolved=refExpr.resolve();
      if (resolved instanceof GrVariable) {
        if (!resolved.isValid()) {
          throw new AssertionError("Invalid target of a valid reference");
        }
        return ((GrVariable)resolved).getTypeGroovy();
      }
    }
    return nominal;
  }
  if (nominal == null)   return inferred;
  if (!TypeConversionUtil.isAssignable(nominal,inferred,false)) {
    final PsiElement resolved=refExpr.resolve();
    if (resolved instanceof GrVariable && ((GrVariable)resolved).getTypeElementGroovy() != null) {
      return nominal;
    }
  }
  return inferred;
}
