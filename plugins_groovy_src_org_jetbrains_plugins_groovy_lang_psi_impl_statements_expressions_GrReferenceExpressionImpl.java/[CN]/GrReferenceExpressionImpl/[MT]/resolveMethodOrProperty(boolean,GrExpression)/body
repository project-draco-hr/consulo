{
  String name=getReferenceName();
  if (name == null)   return GroovyResolveResult.EMPTY_ARRAY;
  PropertyResolverProcessor propertyResolver=new PropertyResolverProcessor(name,this);
  resolveImpl(propertyResolver);
  final GroovyResolveResult[] propertyCandidates=propertyResolver.getCandidates();
  if (!allVariants) {
    for (    GroovyResolveResult candidate : propertyCandidates) {
      if (candidate.getElement() instanceof GrVariable && !(candidate.getElement() instanceof GrField)) {
        return propertyResolver.getCandidates();
      }
    }
  }
  final PsiType[] argTypes=PsiUtil.getArgumentTypes(this,false,upToArgument);
  MethodResolverProcessor methodResolver=runMethodResolverProcessor(name,argTypes,allVariants);
  if (!allVariants && methodResolver.hasApplicableCandidates()) {
    return methodResolver.getCandidates();
  }
  if (!isQualified() && getContext() instanceof GrMethodCall) {
    boolean resolve=false;
    for (PsiElement e=this.getContext(); !resolve && e != null; e=e.getContext()) {
      if (e instanceof GrClosableBlock) {
        ResolveState state=ResolveState.initial().put(ResolverProcessor.RESOLVE_CONTEXT,(GrClosableBlock)e);
        for (        ClosureMissingMethodContributor contributor : ClosureMissingMethodContributor.EP_NAME.getExtensions()) {
          if (!contributor.processMembers((GrClosableBlock)e,methodResolver,this,state)) {
            resolve=true;
            break;
          }
        }
      }
    }
    if (!allVariants && methodResolver.hasApplicableCandidates()) {
      return methodResolver.getCandidates();
    }
  }
  if (!allVariants) {
    for (    GroovyResolveResult candidate : propertyCandidates) {
      final PsiElement element=candidate.getElement();
      if (element instanceof GrField) {
        final PsiClass containingClass=((PsiField)element).getContainingClass();
        if (containingClass != null && PsiTreeUtil.isContextAncestor(containingClass,this,true))         return propertyCandidates;
      }
    }
  }
  List<GroovyResolveResult> allCandidates=new ArrayList<GroovyResolveResult>();
  ContainerUtil.addAll(allCandidates,propertyCandidates);
  ContainerUtil.addAll(allCandidates,methodResolver.getCandidates());
  for (  String getterName : GroovyPropertyUtils.suggestGettersName(name)) {
    AccessorResolverProcessor getterResolver=new AccessorResolverProcessor(getterName,this,true);
    resolveImpl(getterResolver);
    final GroovyResolveResult[] candidates=getterResolver.getCandidates();
    if (!allVariants && candidates.length == 1) {
      return candidates;
    }
    ContainerUtil.addAll(allCandidates,candidates);
  }
  if (allCandidates.size() > 0) {
    return allCandidates.toArray(new GroovyResolveResult[allCandidates.size()]);
  }
  return GroovyResolveResult.EMPTY_ARRAY;
}
