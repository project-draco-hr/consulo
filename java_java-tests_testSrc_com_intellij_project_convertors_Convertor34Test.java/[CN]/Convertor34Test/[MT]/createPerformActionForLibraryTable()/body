{
  return new PerformAction(){
    @Override public void performAction(    VirtualFile rootDir,    VirtualFile rootAfter) throws Exception {
      final VirtualFile libFile=rootDir.findChild("library.table.xml");
      final ExpandMacroToPathMap macros=new ExpandMacroToPathMap();
      macros.addMacroExpand("DIR",rootDir.getPath());
      final Document oldTable=JDOMUtil.loadDocument(VfsUtil.loadText(libFile));
      macros.substitute(oldTable.getRootElement(),true);
      Convertor34.convertLibraryTable34(oldTable.getRootElement(),libFile.getPath());
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          LocalFileSystem.getInstance().refresh(false);
        }
      }
);
      final VirtualFile applicationLibraries=rootDir.findChild("applicationLibraries.xml");
      assertNotNull(applicationLibraries);
      final Document newTable=JDOMUtil.loadDocument(VfsUtil.loadText(applicationLibraries));
      final Document goldenNewTable=JDOMUtil.loadDocument(VfsUtil.loadText(rootAfter.findChild("applicationLibraries.xml")));
      macros.substitute(goldenNewTable.getRootElement(),true);
      assertElementsEqual(goldenNewTable.getRootElement(),newTable.getRootElement());
    }
  }
;
}
