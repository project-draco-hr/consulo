{
  DiffFragment[] fragments=new ByWord(myComparisonPolicy).buildFragments(text1,text2);
  fragments=DiffCorrection.ConnectSingleSideToChange.INSTANCE.correct(fragments);
  fragments=UniteSameType.INSTANCE.correct(fragments);
  fragments=PreferWholeLines.INSTANCE.correct(fragments);
  fragments=UniteSameType.INSTANCE.correct(fragments);
  DiffFragment[][] lines=Util.splitByUnchangedLines(fragments);
  lines=Util.uniteFormattingOnly(lines);
  LineFragmentsCollector collector=new LineFragmentsCollector();
  for (  DiffFragment[] line : lines) {
    DiffFragment[][] subLines=LineBlockDivider.SINGLE_SIDE.divide(line);
    subLines=Util.uniteFormattingOnly(subLines);
    for (    DiffFragment[] subLineFragments : subLines) {
      LineFragment subLine=collector.addDiffFragment(Util.concatenate(subLineFragments));
      if (!subLine.isOneSide()) {
        subLine.setChildren(processInlineFragments(subLineFragments));
      }
    }
  }
  return collector.getFragments();
}
