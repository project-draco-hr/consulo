{
  final Project project=(Project)e.getDataContext().getData(DataConstants.PROJECT);
  Change[] changes=(Change[])e.getDataContext().getData(DataConstants.CHANGES);
  List<VirtualFile> unversionedFiles=(List<VirtualFile>)e.getDataContext().getData(ChangesListView.UNVERSIONED_FILES_KEY);
  final List<VirtualFile> changedFiles=new ArrayList<VirtualFile>();
  boolean activateChangesView=false;
  if (project != null && changes == null && unversionedFiles == null) {
    unversionedFiles=new ArrayList<VirtualFile>();
    changes=getChangesForSelectedFiles(project,changes,unversionedFiles,changedFiles,e);
    activateChangesView=true;
  }
  if (changes == null)   return;
  if (!askAndMove(project,changes,unversionedFiles))   return;
  if (activateChangesView) {
    ToolWindow window=ToolWindowManager.getInstance(project).getToolWindow(ChangesViewManager.TOOLWINDOW_ID);
    if (!window.isVisible()) {
      window.activate(new Runnable(){
        public void run(){
          if (changedFiles.size() > 0) {
            ChangesViewManager.getInstance(project).selectFile(changedFiles.get(0));
          }
        }
      }
);
    }
  }
}
