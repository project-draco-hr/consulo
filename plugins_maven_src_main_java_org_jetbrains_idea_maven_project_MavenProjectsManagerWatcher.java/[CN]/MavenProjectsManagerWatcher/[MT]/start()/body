{
  final MessageBusConnection myBusConnection=myProject.getMessageBus().connect(myChangedDocumentsQueue);
  myBusConnection.subscribe(VirtualFileManager.VFS_CHANGES,new MyFileChangeListener());
  myBusConnection.subscribe(ProjectTopics.PROJECT_ROOTS,new MyRootChangesListener());
  myChangedDocumentsQueue.makeUserAware(myProject);
  myChangedDocumentsQueue.activate();
  myBusConnection.subscribe(ProjectTopics.MODULES,new ModuleAdapter(){
    @Override public void moduleRemoved(    Project project,    Module module){
      MavenProject mavenProject=myManager.findProject(module);
      if (mavenProject != null)       myManager.setIgnoredState(Collections.singletonList(mavenProject),true);
    }
    @Override public void moduleAdded(    final Project project,    final Module module){
      if (myManager.isMavenizedModule(module)) {
        MavenProject mavenProject=myManager.findProject(module);
        if (mavenProject != null)         myManager.setIgnoredState(Collections.singletonList(mavenProject),false);
      }
    }
  }
);
  DocumentAdapter myDocumentListener=new DocumentAdapter(){
    @Override public void documentChanged(    DocumentEvent event){
      Document doc=event.getDocument();
      VirtualFile file=FileDocumentManager.getInstance().getFile(doc);
      if (file == null)       return;
      boolean isMavenFile=file.getName().equals(MavenConstants.POM_XML) || file.getName().equals(MavenConstants.PROFILES_XML) || isSettingsFile(file);
      if (!isMavenFile)       return;
synchronized (myChangedDocuments) {
        myChangedDocuments.add(doc);
      }
      myChangedDocumentsQueue.queue(new Update(MavenProjectsManagerWatcher.this){
        @Override public void run(){
          final Document[] copy;
synchronized (myChangedDocuments) {
            copy=myChangedDocuments.toArray(new Document[myChangedDocuments.size()]);
            myChangedDocuments.clear();
          }
          MavenUtil.invokeLater(myProject,new Runnable(){
            @Override public void run(){
              new WriteAction(){
                @Override protected void run(                Result result) throws Throwable {
                  for (                  Document each : copy) {
                    PsiDocumentManager.getInstance(myProject).commitDocument(each);
                    FileDocumentManager.getInstance().saveDocument(each);
                  }
                }
              }
.execute();
            }
          }
);
        }
      }
);
    }
  }
;
  EditorFactory.getInstance().getEventMulticaster().addDocumentListener(myDocumentListener,myBusConnection);
  final MavenGeneralSettings.Listener mySettingsPathsChangesListener=new MavenGeneralSettings.Listener(){
    @Override public void changed(){
      updateSettingsFilePointers();
      onSettingsChange();
    }
  }
;
  myGeneralSettings.addListener(mySettingsPathsChangesListener);
  Disposer.register(myChangedDocumentsQueue,new Disposable(){
    @Override public void dispose(){
      myGeneralSettings.removeListener(mySettingsPathsChangesListener);
      mySettingsFilesPointers.clear();
    }
  }
);
  updateSettingsFilePointers();
}
