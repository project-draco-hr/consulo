{
  PsiElement parent=tag.getParent();
  final String namespace=tag.getNamespace();
  while (parent instanceof XmlTag && !namespace.equals(((XmlTag)parent).getNamespace()))   parent=parent.getContext();
  if (parent instanceof XmlTag) {
    final XmlTag parentTag=(XmlTag)parent;
    final XmlElementDescriptor parentDescriptor=parentTag.getDescriptor();
    if (parentDescriptor != null) {
      XmlElementDescriptor elementDescriptorFromParent=parentDescriptor.getElementDescriptor(tag,parentTag);
      if (elementDescriptorFromParent == null) {
        elementDescriptorFromParent=getDescriptorFromParent(tag,elementDescriptorFromParent);
      }
      if (elementDescriptorFromParent instanceof AnyXmlElementDescriptor) {
        final XmlElementDescriptor elementDescriptor=getElementDescriptor(tag.getLocalName(),namespace);
        if (elementDescriptor != null)         return elementDescriptor;
      }
      return elementDescriptorFromParent;
    }
 else {
      return null;
    }
  }
 else {
    XmlElementDescriptor elementDescriptor=getElementDescriptor(tag.getLocalName(),tag.getNamespace());
    if (elementDescriptor == null) {
      elementDescriptor=getDescriptorFromParent(tag,elementDescriptor);
    }
    return elementDescriptor;
  }
}
