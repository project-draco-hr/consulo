{
  if (!myShouldNarrowDown)   return true;
  String filter=mySpeedSearch != null && !StringUtil.isEmpty(mySpeedSearch.getEnteredPrefix()) ? mySpeedSearch.getEnteredPrefix() : null;
  if (!StringUtil.equals(myLastFilter,filter)) {
    myVisibleParents.clear();
    myLastFilter=filter;
  }
  if (filter != null) {
    if (myVisibleParents.contains(value)) {
      return true;
    }
    final String text=getText(value);
    if (text == null)     return false;
    final Iterable<TextRange> ranges=mySpeedSearch.matchingFragments(text);
    boolean matches=ranges != null && ranges.iterator().hasNext();
    if (matches) {
      Object o=value;
      while (o instanceof FilteringTreeStructure.FilteringNode && (o=((FilteringTreeStructure.FilteringNode)o).getParent()) != null) {
        myVisibleParents.add(o);
      }
      return true;
    }
 else {
      return false;
    }
  }
  return true;
}
