{
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    @Override public void run(){
      vcs.beginChangeSet();
      for (      Document d : FileDocumentManager.getInstance().getUnsavedDocuments()) {
        VirtualFile f=getFile(d);
        if (!shouldRegisterDocument(f))         continue;
        registerDocumentContents(vcs,f,d);
      }
      vcs.endChangeSet(null);
    }
  }
);
}
