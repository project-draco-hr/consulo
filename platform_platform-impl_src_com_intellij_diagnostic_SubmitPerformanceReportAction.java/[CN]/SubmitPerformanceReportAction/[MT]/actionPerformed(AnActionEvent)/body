{
  String reportFileName="perf_" + ApplicationInfo.getInstance().getBuild().asString() + "_"+ SystemProperties.getUserName()+ "_"+ myDateFormat.format(new Date())+ ".zip";
  final File reportPath=new File(SystemProperties.getUserHome(),reportFileName);
  final File logDir=new File(PathManager.getSystemPath(),"log");
  final Project project=e.getData(PlatformDataKeys.PROJECT);
  try {
    ZipOutputStream zip=new ZipOutputStream(new FileOutputStream(reportPath));
    ZipUtil.addDirToZipRecursively(zip,reportPath,logDir,"",new FileFilter(){
      public boolean accept(      final File pathname){
        if (logDir.equals(pathname.getParentFile())) {
          return pathname.getPath().contains("threadDumps");
        }
        return true;
      }
    }
,null);
    zip.close();
  }
 catch (  IOException ex) {
    Messages.showErrorDialog(project,"Failed to create performance report archive: " + ex.getMessage(),"Submit Performance Report");
    return;
  }
  int rc=Messages.showYesNoDialog(project,"The performance report has been saved to " + reportPath + "\nWould you like to submit it to JetBrains?","Submit Performance Report",Messages.getInformationIcon());
  if (rc == 0) {
    ProgressManager.getInstance().run(new Task.Backgroundable(project,"Uploading Performance Report"){
      public void run(      @NotNull final ProgressIndicator indicator){
        final String error=uploadFileToFTP(reportPath,"ftp.intellij.net",".uploads",indicator);
        if (error != null) {
          ApplicationManager.getApplication().invokeLater(new Runnable(){
            public void run(){
              Messages.showErrorDialog(project,error,"Submit Performance Report");
            }
          }
);
        }
      }
    }
);
  }
}
