{
  try {
    myProgressIndicator=ProgressManager.getInstance().getProgressIndicator();
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        final PsiManager psiManager=PsiManager.getInstance(myProject);
        try {
          psiManager.startBatchFilesProcessingMode();
          ((RefManagerImpl)getRefManager()).inspectionReadActionStarted();
          EntryPointsManager.getInstance(getProject()).resolveEntryPoints(getRefManager());
          List<InspectionTool> needRepeatSearchRequest=new ArrayList<InspectionTool>();
          runTools(needRepeatSearchRequest,scope,manager);
        }
 catch (        ProcessCanceledException e) {
          ((InspectionManagerEx)manager).closeRunningContext(GlobalInspectionContextImpl.this);
          for (          Set<Pair<InspectionTool,InspectionProfile>> tools : myTools.values()) {
            for (            Pair<InspectionTool,InspectionProfile> tool : tools) {
              tool.first.finalCleanup();
            }
          }
          myTools.clear();
          cleanup();
          throw e;
        }
catch (        Exception e) {
          LOG.error(e);
        }
 finally {
          psiManager.finishBatchFilesProcessingMode();
        }
      }
    }
);
  }
  finally {
    if (myRefManager != null) {
      ((RefManagerImpl)getRefManager()).inspectionReadActionFinished();
    }
  }
}
