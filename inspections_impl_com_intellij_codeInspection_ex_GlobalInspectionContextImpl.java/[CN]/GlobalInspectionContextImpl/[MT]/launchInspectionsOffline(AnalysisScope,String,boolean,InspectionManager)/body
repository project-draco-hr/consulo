{
  cleanup();
  myCurrentScope=scope;
  ApplicationManager.getApplication().runReadAction(new Runnable(){
    public void run(){
      performInspectionsWithProgress(scope,runWithEditorSettings,manager,outputPath);
      @NonNls final String ext=".xml";
      for (      String toolName : myTools.keySet()) {
        final Element root=new Element(InspectionsBundle.message("inspection.problems"));
        final Document doc=new Document(root);
        final Set<InspectionTool> sameTools=myTools.get(toolName);
        boolean hasProblems=false;
        boolean isLocalTool=false;
        boolean isDescriptorProvider=false;
        for (        InspectionTool tool : sameTools) {
          if (tool instanceof DescriptorProviderInspection) {
            hasProblems=new File(outputPath,toolName + ext).exists();
            isLocalTool=tool instanceof LocalInspectionToolWrapper;
            isDescriptorProvider=true;
          }
 else           if (tool.hasReportedProblems()) {
            hasProblems=true;
            tool.exportResults(root);
          }
        }
        @NonNls final String isLocalToolAttribute="is_local_tool";
        root.setAttribute(isLocalToolAttribute,String.valueOf(isLocalTool));
        if (!hasProblems)         continue;
        OutputStream outStream=null;
        try {
          new File(outputPath).mkdirs();
          final File file=new File(outputPath,toolName + ext);
          if (isDescriptorProvider) {
            outStream=descriptorProviderFilePreparations(file,outStream,isLocalToolAttribute,isLocalTool);
          }
 else {
            ((ProjectEx)getProject()).getMacroReplacements().substitute(doc.getRootElement(),SystemInfo.isFileSystemCaseSensitive);
            outStream=new BufferedOutputStream(new FileOutputStream(file));
            JDOMUtil.writeDocument(doc,outStream,"\n");
          }
        }
 catch (        IOException e) {
          LOG.error(e);
        }
 finally {
          if (outStream != null) {
            try {
              outStream.close();
            }
 catch (            IOException e) {
              LOG.error(e);
            }
          }
        }
      }
    }
  }
);
}
