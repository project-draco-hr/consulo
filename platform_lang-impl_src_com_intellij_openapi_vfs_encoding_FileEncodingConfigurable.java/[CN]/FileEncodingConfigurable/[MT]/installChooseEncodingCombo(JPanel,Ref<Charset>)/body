{
  ChooseFileEncodingAction myAction=new ChooseFileEncodingAction(null){
    @RequiredDispatchThread @Override public void update(    @NotNull final AnActionEvent e){
      getTemplatePresentation().setEnabled(true);
      Charset charset=selected.get();
      getTemplatePresentation().setText(charset == null ? IdeBundle.message("encoding.name.system.default",CharsetToolkit.getDefaultSystemCharset().displayName()) : charset.displayName());
    }
    @Override protected void chosen(    final VirtualFile virtualFile,    @NotNull final Charset charset){
      selected.set(charset == NO_ENCODING ? null : charset);
      update(null);
    }
    @NotNull @Override protected DefaultActionGroup createPopupActionGroup(    JComponent button){
      return createCharsetsActionGroup("<System Default>",selected.get(),new Function<Charset,String>(){
        @Override public String fun(        Charset charset){
          return "Choose encoding '" + charset + "'";
        }
      }
);
    }
  }
;
  parentPanel.removeAll();
  Presentation templatePresentation=myAction.getTemplatePresentation();
  parentPanel.add(myAction.createCustomComponent(templatePresentation),BorderLayout.CENTER);
  myAction.update(null);
  return myAction;
}
