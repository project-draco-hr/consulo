{
  ChooseFileEncodingAction myAction=new ChooseFileEncodingAction(null){
    @Override public void update(    final AnActionEvent e){
      getTemplatePresentation().setEnabled(true);
      Charset charset=selected.get();
      getTemplatePresentation().setText(charset == null ? SYSTEM_DEFAULT : charset.displayName());
    }
    @Override protected void chosen(    final VirtualFile virtualFile,    @NotNull final Charset charset){
      selected.set(charset == NO_ENCODING ? null : charset);
      update(null);
    }
    @NotNull @Override protected DefaultActionGroup createPopupActionGroup(    JComponent button){
      return createGroup("<System Default>",null,"Choose encoding ''{1}''",selected.get());
    }
  }
;
  parentPanel.removeAll();
  Presentation templatePresentation=myAction.getTemplatePresentation();
  parentPanel.add(myAction.createCustomComponent(templatePresentation),BorderLayout.CENTER);
  myAction.update(null);
  return myAction;
}
