{
  final ProgressIndicator indicator=new DelegatingProgressIndicator();
  final Semaphore startSemaphore=new Semaphore();
  final Semaphore endSemaphore=new Semaphore();
  startSemaphore.down();
  endSemaphore.down();
  ChangeListManagerImpl.getInstanceImpl(myProject).executeOnUpdaterThread(new Runnable(){
    @Override public void run(){
      startSemaphore.up();
      indicator.setText("Performing VCS commit...");
      try {
        ProgressManager.getInstance().runProcess(new Runnable(){
          @Override public void run(){
            indicator.checkCanceled();
            generalCommit(processor);
          }
        }
,indicator);
      }
  finally {
        endSemaphore.up();
      }
    }
  }
);
  indicator.setText("Waiting for VCS background tasks to finish...");
  while (!startSemaphore.waitFor(20)) {
    indicator.checkCanceled();
  }
  while (!endSemaphore.waitFor(20)) {
    indicator.checkCanceled();
  }
}
