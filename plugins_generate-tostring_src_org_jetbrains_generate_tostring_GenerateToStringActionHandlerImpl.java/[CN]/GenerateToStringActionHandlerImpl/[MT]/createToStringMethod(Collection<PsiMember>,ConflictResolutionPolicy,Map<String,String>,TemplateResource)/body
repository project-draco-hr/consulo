{
  String body=velocityGenerateCode(selectedMembers,params,template,template.getMethodBody());
  if (logger.isDebugEnabled())   logger.debug("Method body generated from Velocity:\n" + body);
  body=StringUtil.fixLineBreaks(body);
  PsiMethod newMethod=elementFactory.createMethodFromText(template.getMethodSignature() + " { " + body+ " }",null);
  codeStyleManager.reformat(newMethod);
  PsiMethod existingMethod=psi.findMethodByName(clazz,template.getTargetMethodName());
  boolean operationExectued=policy.applyMethod(clazz,existingMethod,newMethod);
  if (!operationExectued)   return null;
  if (template.hasAnnotations()) {
    PsiMethod toStringMethod=psi.findMethodByName(clazz,template.getTargetMethodName());
    String[] annotations=template.getAnnotations();
    for (int i=annotations.length - 1; i > -1; i--) {
      String text=annotations[i];
      psi.addAnnotationToMethod(elementFactory,toStringMethod,text);
    }
  }
  String existingJavaDoc=params.get("existingJavaDoc");
  String newJavaDoc=template.getJavaDoc();
  if (existingJavaDoc != null || newJavaDoc != null) {
    PsiMethod toStringMethod=psi.findMethodByName(clazz,template.getTargetMethodName());
    newJavaDoc=velocityGenerateCode(selectedMembers,params,template,newJavaDoc);
    if (logger.isDebugEnabled())     logger.debug("JavaDoc body generated from Velocity:\n" + newJavaDoc);
    policy.applyJavaDoc(clazz,toStringMethod,elementFactory,codeStyleManager,existingJavaDoc,newJavaDoc);
  }
  codeStyleManager.reformat(newMethod);
  return newMethod;
}
