{
  while (len > 0) {
    int bytes=Math.min(segmentLength - bytesWritten,len);
    System.arraycopy(b,off,buffer,bytesWritten,bytes);
    off+=bytes;
    len-=bytes;
    bytesWritten+=bytes;
    if (bytesWritten == segmentLength) {
      flush();
    }
  }
}
