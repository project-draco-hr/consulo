{
  final DataContext dataContext=e.getDataContext();
  final Component component=(Component)dataContext.getData(DataConstantsEx.CONTEXT_COMPONENT);
  final String path=ChooseComponentsToExportDialog.chooseSettingsFile(PathManager.getConfigPath(),component,IdeBundle.message("title.import.file.location"),IdeBundle.message("prompt.choose.import.file.path"));
  if (path == null)   return;
  final File saveFile=new File(path);
  try {
    if (!saveFile.exists()) {
      Messages.showErrorDialog(IdeBundle.message("error.cannot.find.file",presentableFileName(saveFile)),IdeBundle.message("title.file.not.found"));
      return;
    }
    final ZipFile zipFile=new ZipFile(saveFile);
    final ZipEntry magicEntry=zipFile.getEntry(ExportSettingsAction.SETTINGS_JAR_MARKER);
    if (magicEntry == null) {
      Messages.showErrorDialog(IdeBundle.message("error.file.contains.no.settings.to.import",presentableFileName(saveFile),promptLocationMessage()),IdeBundle.message("title.invalid.file"));
      return;
    }
    final ArrayList<ExportableApplicationComponent> registeredComponents=new ArrayList<ExportableApplicationComponent>();
    final Map<File,Set<ExportableApplicationComponent>> filesToComponents=ExportSettingsAction.getRegisteredComponentsAndFiles(registeredComponents);
    List<ExportableApplicationComponent> components=getComponentsStored(saveFile,registeredComponents);
    final ChooseComponentsToExportDialog dialog=new ChooseComponentsToExportDialog(components,filesToComponents,false,IdeBundle.message("title.select.components.to.import"),IdeBundle.message("prompt.check.components.to.import"));
    dialog.show();
    if (!dialog.isOK())     return;
    final Set<ExportableApplicationComponent> chosenComponents=dialog.getExportableComponents();
    Set<String> relativeNamesToExtract=new HashSet<String>();
    for (Iterator iterator=chosenComponents.iterator(); iterator.hasNext(); ) {
      ExportableApplicationComponent chosenComponent=(ExportableApplicationComponent)iterator.next();
      final File[] exportFiles=chosenComponent.getExportFiles();
      for (int j=0; j < exportFiles.length; j++) {
        File exportFile=exportFiles[j];
        final File configPath=new File(PathManager.getConfigPath());
        final String relativePath=FileUtil.toSystemIndependentName(FileUtil.getRelativePath(configPath,exportFile));
        relativeNamesToExtract.add(relativePath);
      }
    }
    final File tempFile=new File(PathManagerEx.getPluginTempPath() + "/" + saveFile.getName());
    FileUtil.copy(saveFile,tempFile);
    File outDir=new File(PathManager.getConfigPath());
    final MyFilenameFilter filenameFilter=new MyFilenameFilter(relativeNamesToExtract);
    StartupActionScriptManager.ActionCommand unzip=new StartupActionScriptManager.UnzipCommand(tempFile,outDir,filenameFilter);
    StartupActionScriptManager.addActionCommand(unzip);
    StartupActionScriptManager.ActionCommand deleteTemp=new StartupActionScriptManager.DeleteCommand(tempFile);
    StartupActionScriptManager.addActionCommand(deleteTemp);
    final int ret=Messages.showOkCancelDialog(IdeBundle.message("message.settings.imported.successfully",ApplicationNamesInfo.getInstance().getProductName(),ApplicationNamesInfo.getInstance().getFullProductName()),IdeBundle.message("title.restart.needed"),Messages.getQuestionIcon());
    if (ret == 0) {
      ApplicationManager.getApplication().exit();
    }
  }
 catch (  ZipException e1) {
    Messages.showErrorDialog(IdeBundle.message("error.reading.settings.file",presentableFileName(saveFile),e1.getMessage(),promptLocationMessage()),IdeBundle.message("title.invalid.file"));
  }
catch (  IOException e1) {
    Messages.showErrorDialog(IdeBundle.message("error.reading.settings.file.2",presentableFileName(saveFile),e1.getMessage()),IdeBundle.message("title.error.reading.file"));
  }
}
