{
  if (element instanceof PsiComment)   return null;
  PsiFile containingFile=element.getContainingFile();
  List<PsiLanguageInjectionHost> otherHosts=new SmartList<PsiLanguageInjectionHost>();
  boolean commentOrSpaces=false;
  PsiElement prev=element, e=prevOrParent(element,containingFile);
  for (int counter=0; e != null && counter < 100; prev=e, e=prevOrParent(e,containingFile), counter++) {
    if (e instanceof PsiComment) {
      commentOrSpaces=true;
      PsiComment comment=(PsiComment)e;
      if (!checkDepth(otherHosts,element,comment))       continue;
      T value=processor.fun(comment);
      if (value != null)       return value;
    }
 else     if (e instanceof PsiWhiteSpace) {
      commentOrSpaces=true;
    }
 else     if (e instanceof PsiLanguageInjectionHost) {
      commentOrSpaces=StringUtil.isEmptyOrSpaces(e.getText());
      if (!commentOrSpaces)       otherHosts.add((PsiLanguageInjectionHost)e);
    }
 else {
      commentOrSpaces=false;
    }
  }
  if (commentOrSpaces) {
    for (e=prevOrParent(prev,containingFile); e != null; e=e.getPrevSibling()) {
      if (e instanceof PsiComment) {
        PsiComment comment=(PsiComment)e;
        if (!checkDepth(otherHosts,element,comment))         continue;
        T value=processor.fun(comment);
        if (value != null)         return value;
      }
 else       if (!(e instanceof PsiWhiteSpace)) {
        break;
      }
    }
  }
  return null;
}
