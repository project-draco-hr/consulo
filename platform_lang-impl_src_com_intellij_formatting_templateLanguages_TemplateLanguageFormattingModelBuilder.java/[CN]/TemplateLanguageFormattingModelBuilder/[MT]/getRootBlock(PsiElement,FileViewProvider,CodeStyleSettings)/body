{
  ASTNode node=element.getNode();
  if (node == null) {
    return createDummyBlock(node);
  }
  final Language dataLanguage=((TemplateLanguageFileViewProvider)viewProvider).getTemplateDataLanguage();
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forLanguage(dataLanguage);
  if (builder instanceof DelegatingFormattingModelBuilder && ((DelegatingFormattingModelBuilder)builder).dontFormatMyModel()) {
    return createDummyBlock(node);
  }
  if (builder == null) {
    return createTemplateLanguageBlock(node,Collections.<DataLanguageBlockWrapper>emptyList());
  }
  final FormattingModel model=builder.createModel(viewProvider.getPsi(dataLanguage),settings);
  List<DataLanguageBlockWrapper> childWrappers=buildChildWrappers(model.getRootBlock());
  if (childWrappers.size() == 1) {
    childWrappers=buildChildWrappers(childWrappers.get(0).getOriginal());
  }
  return createTemplateLanguageBlock(node,filterBlocksByRange(childWrappers,node.getTextRange()));
}
