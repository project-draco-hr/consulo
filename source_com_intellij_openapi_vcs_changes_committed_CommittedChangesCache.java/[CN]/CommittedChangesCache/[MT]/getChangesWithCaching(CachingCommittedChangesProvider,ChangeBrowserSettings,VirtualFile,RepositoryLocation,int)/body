{
  ChangesCacheFile cacheFile=getCacheFile(provider,root,location);
  if (cacheFile.isEmpty()) {
    List<CommittedChangeList> changes=provider.getCommittedChanges(provider.createDefaultSettings(),location,myInitialCount);
    cacheFile.writeChanges(changes,true);
    if (changes.size() < myInitialCount) {
      cacheFile.setHaveCompleteHistory(true);
    }
    if (canGetFromCache(provider,settings,root,location,maxCount)) {
      settings.filterChanges(changes);
      return trimToSize(changes,maxCount);
    }
    return provider.getCommittedChanges(settings,location,maxCount);
  }
 else {
    List<CommittedChangeList> changes=cacheFile.readChanges(settings,maxCount);
    List<CommittedChangeList> newChanges=refreshCache(cacheFile);
    settings.filterChanges(newChanges);
    changes.addAll(newChanges);
    return trimToSize(changes,maxCount);
  }
}
