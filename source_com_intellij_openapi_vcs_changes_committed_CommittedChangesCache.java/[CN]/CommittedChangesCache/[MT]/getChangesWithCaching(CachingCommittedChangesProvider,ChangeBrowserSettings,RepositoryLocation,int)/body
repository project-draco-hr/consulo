{
  ChangesCacheFile cacheFile=getCacheFile(provider,location);
  if (cacheFile.isEmpty()) {
    List<CommittedChangeList> changes=provider.getCommittedChanges(provider.createDefaultSettings(),location,myInitialCount);
    cacheFile.writeChanges(changes);
    if (changes.size() < myInitialCount) {
      cacheFile.setHaveCompleteHistory(true);
    }
    if (canGetFromCache(provider,settings,location,maxCount)) {
      settings.filterChanges(changes);
      return trimToSize(changes,maxCount);
    }
    return provider.getCommittedChanges(settings,location,maxCount);
  }
 else {
    List<CommittedChangeList> changes=cacheFile.readChanges(settings,maxCount);
    final Date date=cacheFile.getLastCachedDate();
    final ChangeBrowserSettings defaultSettings=provider.createDefaultSettings();
    defaultSettings.setDateAfter(date);
    List<CommittedChangeList> newChanges=provider.getCommittedChanges(defaultSettings,location,0);
    newChanges=cacheFile.writeChanges(newChanges);
    settings.filterChanges(newChanges);
    changes.addAll(newChanges);
    return trimToSize(changes,maxCount);
  }
}
