{
  final CachingCommittedChangesProvider provider=cacheFile.getProvider();
  final RepositoryLocation location=cacheFile.getLocation();
  final ChangeBrowserSettings defaultSettings=provider.createDefaultSettings();
  int maxCount=0;
  if (provider.refreshCacheByNumber()) {
    final long number=cacheFile.getLastCachedChangelist();
    LOG.info("Refreshing cache for " + location + " since #"+ number);
    if (number >= 0) {
      defaultSettings.CHANGE_AFTER=Long.toString(number);
      defaultSettings.USE_CHANGE_AFTER_FILTER=true;
    }
 else {
      maxCount=myState.getInitialCount();
    }
  }
 else {
    final Date date=cacheFile.getLastCachedDate();
    LOG.info("Refreshing cache for " + location + " since "+ date);
    defaultSettings.setDateAfter(date);
    defaultSettings.USE_DATE_AFTER_FILTER=true;
  }
  final List<CommittedChangeList> newChanges=provider.getCommittedChanges(defaultSettings,location,maxCount);
  LOG.info("Loaded " + newChanges.size() + " new changelists");
  final List<CommittedChangeList> savedChanges=writeChangesInReadAction(cacheFile,newChanges);
  if (savedChanges.size() > 0) {
    myBus.syncPublisher(COMMITTED_TOPIC).changesLoaded(location,savedChanges);
  }
  return savedChanges;
}
