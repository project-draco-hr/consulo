{
  if (ApplicationManager.getApplication().isUnitTestMode() && project.toString().contains("lighttemp")) {
    throw new AssertionError("must not open light project");
  }
  if (myOpenProjects.contains(project))   return false;
  if (!ApplicationManager.getApplication().isUnitTestMode() && !((ProjectEx)project).getStateStore().checkVersion())   return false;
  myOpenProjects.add(project);
  cacheOpenProjects();
  if (ApplicationManager.getApplication().isDispatchThread()) {
    fireProjectOpened(project);
  }
 else {
    ApplicationManager.getApplication().invokeAndWait(new Runnable(){
      @Override public void run(){
        fireProjectOpened(project);
      }
    }
,ModalityState.defaultModalityState());
  }
  final StartupManagerImpl startupManager=(StartupManagerImpl)StartupManager.getInstance(project);
  boolean ok;
  ProgressIndicator indicator=myProgressManager.getProgressIndicator();
  if (indicator == null) {
    ok=myProgressManager.runProcessWithProgressSynchronously(new Runnable(){
      public void run(){
        startupManager.runStartupActivities();
      }
    }
,ProjectBundle.message("project.load.progress"),true,project);
  }
 else {
    try {
      startupManager.runStartupActivities();
      ok=true;
    }
 catch (    Throwable e) {
      ok=false;
    }
  }
  if (!ok) {
    closeProject(project,false,false);
    notifyProjectOpenFailed();
    return false;
  }
  startupManager.runPostStartupActivitiesNew();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      startupManager.runPostStartupActivities();
    }
  }
);
  startupManager.startCacheUpdate();
  if (!ApplicationManager.getApplication().isHeadlessEnvironment() && !ApplicationManager.getApplication().isUnitTestMode()) {
    StartupManager.getInstance(project).runWhenProjectIsInitialized(new Runnable(){
      public void run(){
        final TrackingPathMacroSubstitutor macroSubstitutor=((ProjectEx)project).getStateStore().getStateStorageManager().getMacroSubstitutor();
        if (macroSubstitutor != null) {
          StorageUtil.notifyUnknownMacros(macroSubstitutor,project,null);
        }
      }
    }
);
  }
  return true;
}
