{
  if (isLight(project)) {
    throw new AssertionError("must not close light project");
  }
  if (!isProjectOpened(project))   return true;
  if (checkCanClose && !canClose(project))   return false;
  final ShutDownTracker shutDownTracker=ShutDownTracker.getInstance();
  shutDownTracker.registerStopperThread(Thread.currentThread());
  try {
    if (save) {
      FileDocumentManager.getInstance().saveAllDocuments();
      project.save();
    }
    if (checkCanClose && !ensureCouldCloseIfUnableToSave(project)) {
      return false;
    }
    fireProjectClosing(project);
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
synchronized (myOpenProjects) {
          myOpenProjects.remove(project);
          cacheOpenProjects();
        }
        myCurrentTestProject=null;
        myChangedProjectFiles.remove(project);
        fireProjectClosed(project);
        if (dispose) {
          Disposer.dispose(project);
        }
      }
    }
);
  }
  finally {
    shutDownTracker.unregisterStopperThread(Thread.currentThread());
  }
  return true;
}
