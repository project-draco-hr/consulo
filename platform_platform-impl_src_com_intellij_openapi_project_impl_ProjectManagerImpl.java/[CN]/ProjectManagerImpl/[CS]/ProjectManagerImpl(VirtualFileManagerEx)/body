{
  Application app=ApplicationManager.getApplication();
  MessageBus messageBus=app.getMessageBus();
  MessageBusConnection connection=messageBus.connect(app);
  connection.subscribe(StateStorage.STORAGE_TOPIC,new StateStorage.Listener(){
    public void storageFileChanged(    final VirtualFileEvent event,    @NotNull final StateStorage storage){
      VirtualFile file=event.getFile();
      LOG.info("[STORAGE] Check if application reload is required for: " + file.getPath());
      if (!file.isDirectory() && !(event.getRequestor() instanceof StateStorage.SaveSession)) {
        LOG.info("[STORAGE] Scheduling application reload triggered by change in: " + file.getPath());
        saveChangedProjectFile(file,null,storage);
      }
    }
  }
);
  addProjectManagerListener(new ProjectManagerListener(){
    public void projectOpened(    final Project project){
      MessageBus messageBus=project.getMessageBus();
      MessageBusConnection connection=messageBus.connect(project);
      connection.subscribe(StateStorage.STORAGE_TOPIC,new StateStorage.Listener(){
        public void storageFileChanged(        final VirtualFileEvent event,        @NotNull final StateStorage storage){
          VirtualFile file=event.getFile();
          LOG.info("[STORAGE] Check if project reload is required for: " + file.getPath());
          if (!file.isDirectory() && !(event.getRequestor() instanceof StateStorage.SaveSession)) {
            LOG.info("[STORAGE] Scheduling project reload triggered by change in: " + file.getPath());
            saveChangedProjectFile(file,project,storage);
          }
        }
      }
);
      ProjectManagerListener[] listeners=getListeners(project);
      for (      ProjectManagerListener listener : listeners) {
        listener.projectOpened(project);
      }
    }
    public void projectClosed(    Project project){
      ProjectManagerListener[] listeners=getListeners(project);
      for (      ProjectManagerListener listener : listeners) {
        listener.projectClosed(project);
      }
    }
    public boolean canCloseProject(    Project project){
      ProjectManagerListener[] listeners=getListeners(project);
      for (      ProjectManagerListener listener : listeners) {
        if (!listener.canCloseProject(project)) {
          return false;
        }
      }
      return true;
    }
    public void projectClosing(    Project project){
      ProjectManagerListener[] listeners=getListeners(project);
      for (      ProjectManagerListener listener : listeners) {
        listener.projectClosing(project);
      }
    }
  }
);
  registerExternalProjectFileListener(virtualFileManagerEx);
}
