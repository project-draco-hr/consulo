{
  final PsiFile fileCopy=createFileCopy(context.file);
  Document oldDoc=fileCopy.getViewProvider().getDocument();
  oldDoc.insertString(context.startOffset,CompletionUtil.DUMMY_IDENTIFIER);
  PsiDocumentManager.getInstance(fileCopy.getProject()).commitDocument(oldDoc);
  context.offset=context.startOffset;
  Editor oldEditor=context.editor;
  Editor injectedEditor=InjectedLanguageUtil.getEditorForInjectedLanguage(oldEditor,fileCopy,context.startOffset);
  if (injectedEditor != oldEditor) {
    final EditorDelegate editorDelegate=(EditorDelegate)injectedEditor;
    int newOffset1=editorDelegate.logicalPositionToOffset(editorDelegate.parentToInjected(oldEditor.offsetToLogicalPosition(context.startOffset)));
    int newOffset2=editorDelegate.logicalPositionToOffset(editorDelegate.parentToInjected(oldEditor.offsetToLogicalPosition(context.selectionEndOffset)));
    PsiFile injectedFile=editorDelegate.getInjectedFile();
    CompletionContext newContext=new CompletionContext(context.project,injectedEditor,injectedFile,newOffset1,newOffset2);
    newContext.offset=newContext.startOffset;
    PsiElement element=injectedFile.findElementAt(newContext.startOffset);
    return Pair.create(newContext,element);
  }
  PsiElement element=fileCopy.findElementAt(context.startOffset);
  return Pair.create(context,element);
}
