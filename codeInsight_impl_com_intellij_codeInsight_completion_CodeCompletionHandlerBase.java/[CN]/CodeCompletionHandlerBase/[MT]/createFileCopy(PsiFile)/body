{
  final PsiElementVisitor originalVisitor=new PsiRecursiveElementVisitor(){
    public void visitElement(    final PsiElement element){
      if (element instanceof LeafElement)       return;
      element.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,element);
      super.visitElement(element);
    }
  }
;
  originalVisitor.visitFile(file);
  final PsiFile fileCopy=(PsiFile)file.copy();
  final PsiElementVisitor copyVisitor=new PsiRecursiveElementVisitor(){
    public void visitElement(    final PsiElement element){
      if (element instanceof LeafElement)       return;
      final PsiElement originalElement=element.getCopyableUserData(CompletionUtil.ORIGINAL_KEY);
      if (originalElement != null) {
        originalElement.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,null);
        element.putCopyableUserData(CompletionUtil.ORIGINAL_KEY,null);
        element.putUserData(CompletionUtil.ORIGINAL_KEY,originalElement);
      }
      super.visitElement(element);
    }
  }
;
  copyVisitor.visitFile(fileCopy);
  return fileCopy;
}
