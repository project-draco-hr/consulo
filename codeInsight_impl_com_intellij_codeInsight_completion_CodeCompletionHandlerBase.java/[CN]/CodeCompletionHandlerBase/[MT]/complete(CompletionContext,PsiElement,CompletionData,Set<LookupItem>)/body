{
  if (lastElement == null)   return;
  final PsiReference ref=lastElement.getContainingFile().findReferenceAt(context.offset);
  if (ref != null) {
    completionData.completeReference(ref,lookupSet,context,lastElement);
    return;
  }
  if (lastElement instanceof PsiIdentifier) {
    final PsiElement parent=lastElement.getParent();
    if (parent instanceof PsiClass) {
      final PsiClass psiClass=(PsiClass)parent;
      if (lastElement.equals(psiClass.getNameIdentifier())) {
        myPreferencePolicy=JavaCompletionUtil.completeClassName(lookupSet,context,psiClass);
        return;
      }
    }
    if (parent instanceof PsiLocalVariable || parent instanceof PsiParameter) {
      final PsiVariable variable=(PsiVariable)parent;
      if (lastElement.equals(variable.getNameIdentifier())) {
        if (!INSIDE_TYPE_PARAMS_PATTERN.accepts(lastElement)) {
          myPreferencePolicy=JavaCompletionUtil.completeLocalVariableName(lookupSet,context,variable);
          return;
        }
      }
    }
    if (parent instanceof PsiField) {
      final PsiVariable variable=(PsiVariable)parent;
      if (lastElement.equals(variable.getNameIdentifier())) {
        myPreferencePolicy=JavaCompletionUtil.completeFieldName(lookupSet,context,variable);
        if (parent.getLastChild() instanceof PsiErrorElement)         return;
        myPreferencePolicy=JavaCompletionUtil.completeMethodName(lookupSet,context,variable);
      }
    }
    if (parent instanceof PsiMethod) {
      final PsiMethod psiMethod=(PsiMethod)parent;
      if (lastElement.equals(psiMethod.getNameIdentifier())) {
        myPreferencePolicy=JavaCompletionUtil.completeMethodName(lookupSet,context,psiMethod);
      }
    }
  }
}
