{
  if (lastElement == null)   return;
  if (context.file instanceof XmlFileImpl) {
    final XmlFileImpl xmlFile=(XmlFileImpl)context.file;
    final XmlDocument document=xmlFile.getDocument();
    if (document != null) {
      final XmlTag tag=document.getRootTag();
      if (tag != null && "project".equals(tag.getName()) && tag.getContext() instanceof XmlDocument && tag.getAttributeValue("default") != null) {
        final PsiReference ref=xmlFile.findReferenceAt(context.offset);
        if (ref != null) {
          completionData.completeReference(ref,lookupSet,context,lastElement);
          return;
        }
      }
    }
  }
  final PsiReference ref=lastElement.getContainingFile().findReferenceAt(context.offset);
  if (ref != null) {
    completionData.completeReference(ref,lookupSet,context,lastElement);
    return;
  }
  if (lastElement instanceof PsiIdentifier) {
    final PsiElement parent=lastElement.getParent();
    if (parent instanceof PsiClass) {
      final PsiClass psiClass=(PsiClass)parent;
      if (lastElement.equals(psiClass.getNameIdentifier())) {
        myPreferencePolicy=completionData.completeClassName(lookupSet,context,psiClass);
        return;
      }
    }
    if (parent instanceof PsiLocalVariable || parent instanceof PsiParameter) {
      final PsiVariable variable=(PsiVariable)parent;
      if (lastElement.equals(variable.getNameIdentifier())) {
        myPreferencePolicy=completionData.completeLocalVariableName(lookupSet,context,variable);
        return;
      }
    }
    if (parent instanceof PsiField) {
      final PsiVariable variable=(PsiVariable)parent;
      if (lastElement.equals(variable.getNameIdentifier())) {
        myPreferencePolicy=completionData.completeFieldName(lookupSet,context,variable);
        if (parent.getLastChild() instanceof PsiErrorElement)         return;
        myPreferencePolicy=completionData.completeMethodName(lookupSet,context,variable);
      }
    }
    if (parent instanceof PsiMethod) {
      final PsiMethod psiMethod=(PsiMethod)parent;
      if (lastElement.equals(psiMethod.getNameIdentifier())) {
        myPreferencePolicy=completionData.completeMethodName(lookupSet,context,psiMethod);
      }
    }
  }
}
