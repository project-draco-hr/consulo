{
  mxGraph graph=graphComponent.getGraph();
  LinkedHashMap<Object,mxCellHandler> oldHandlers=handlers;
  handlers=new LinkedHashMap<Object,mxCellHandler>();
  Object[] tmp=graph.getSelectionCells();
  boolean handlesVisible=tmp.length <= getMaxHandlers();
  Rectangle handleBounds=null;
  for (int i=0; i < tmp.length; i++) {
    mxCellState state=graph.getView().getState(tmp[i]);
    if (state != null && state.getCell() != graph.getView().getCurrentRoot()) {
      mxCellHandler handler=oldHandlers.remove(tmp[i]);
      if (handler != null) {
        handler.refresh(state);
      }
 else {
        handler=graphComponent.createHandler(state);
      }
      if (handler != null) {
        handler.setHandlesVisible(handlesVisible);
        handlers.put(tmp[i],handler);
        Rectangle bounds=handler.getBounds();
        Stroke stroke=handler.getSelectionStroke();
        if (stroke != null) {
          bounds=stroke.createStrokedShape(bounds).getBounds();
        }
        if (handleBounds == null) {
          handleBounds=bounds;
        }
 else {
          handleBounds.add(bounds);
        }
      }
    }
  }
  for (  mxCellHandler handler : oldHandlers.values()) {
    handler.destroy();
  }
  Rectangle dirty=bounds;
  if (handleBounds != null) {
    if (dirty != null) {
      dirty.add(handleBounds);
    }
 else {
      dirty=handleBounds;
    }
  }
  if (dirty != null) {
    graphComponent.getGraphControl().repaint(dirty);
  }
  bounds=handleBounds;
}
