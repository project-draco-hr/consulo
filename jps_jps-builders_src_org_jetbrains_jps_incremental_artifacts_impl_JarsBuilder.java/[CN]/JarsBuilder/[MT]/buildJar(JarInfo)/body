{
  if (jar.getContent().isEmpty()) {
    final String message="Archive '" + jar.getPresentableDestination() + "' has no files so it won't be created";
    myContext.processMessage(new CompilerMessage(IncArtifactBuilder.BUILDER_NAME,BuildMessage.Kind.WARNING,message));
    return;
  }
  myContext.processMessage(new ProgressMessage("Building " + jar.getPresentableDestination() + "..."));
  File jarFile=FileUtil.createTempFile("artifactCompiler","tmp");
  myBuiltJars.put(jar,jarFile);
  FileUtil.createParentDirs(jarFile);
  final String targetJarPath=jar.getDestination().getOutputFilePath();
  Manifest manifest=loadManifest(jar,targetJarPath);
  final JarOutputStream jarOutputStream=createJarOutputStream(jarFile,manifest);
  try {
    final THashSet<String> writtenPaths=new THashSet<String>();
    if (manifest != null) {
      writtenPaths.add(JarFile.MANIFEST_NAME);
    }
    for (    Pair<String,Object> pair : jar.getContent()) {
      final String relativePath=pair.getFirst();
      if (pair.getSecond() instanceof ArtifactSourceRoot) {
        final ArtifactSourceRoot root=(ArtifactSourceRoot)pair.getSecond();
        final int rootIndex=myInstructions.getRootIndex(root);
        LOG.assertTrue(rootIndex != -1,root + " not found in instructions");
        final ArtifactBuilderLogger logger=myContext.getLoggingManager().getArtifactBuilderLogger();
        if (root instanceof FileBasedArtifactSourceRoot) {
          addFileToJar(jarOutputStream,jarFile,root.getRootFile(),root.getFilter(),relativePath,targetJarPath,writtenPaths,rootIndex);
        }
 else {
          final String filePath=FileUtil.toSystemIndependentName(root.getRootFile().getAbsolutePath());
          logger.fileCopied(filePath);
          mySrcOutMapping.appendData(filePath,Collections.singletonList(targetJarPath));
          myOutSrcMapping.appendData(targetJarPath,Collections.singletonList(new ArtifactOutputToSourceMapping.SourcePathAndRootIndex(filePath,rootIndex)));
          extractFileAndAddToJar(jarOutputStream,(JarBasedArtifactSourceRoot)root,relativePath,writtenPaths);
        }
      }
 else {
        JarInfo nestedJar=(JarInfo)pair.getSecond();
        File nestedJarFile=myBuiltJars.get(nestedJar);
        if (nestedJarFile != null) {
          addFileToJar(jarOutputStream,jarFile,nestedJarFile,SourceFileFilter.ALL,relativePath,targetJarPath,writtenPaths,-1);
        }
 else {
          LOG.debug("nested jar file " + relativePath + " for "+ jar.getPresentableDestination()+ " not found");
        }
      }
    }
  }
  finally {
    jarOutputStream.close();
  }
}
