{
  String pathRest=qName;
  VirtualFile cur=root;
  while (true) {
    int dot=pathRest.indexOf('.');
    if (dot < 0)     break;
    String pathComponent=pathRest.substring(0,dot);
    VirtualFile child=cur.findChild(pathComponent);
    if (child == null)     break;
    pathRest=pathRest.substring(dot + 1);
    cur=child;
  }
  String className=pathRest.replace('.','$');
  int bucks=className.indexOf('$');
  String rootClassName;
  if (bucks < 0) {
    rootClassName=className;
  }
 else {
    rootClassName=className.substring(0,bucks);
    className=className.substring(bucks + 1);
  }
  VirtualFile vFile=cur.findChild(rootClassName + ".class");
  if (vFile == null)   vFile=cur.findChild(rootClassName + ".java");
  if (vFile != null) {
    if (!vFile.isValid()) {
      LOG.error("Invalid child of valid parent: " + vFile.getPath() + "; "+ root.isValid()+ " path="+ root.getPath());
      return null;
    }
    final PsiFile file=psiManager.findFile(vFile);
    if (file instanceof PsiClassOwner) {
      final PsiClass[] classes=((PsiClassOwner)file).getClasses();
      if (classes.length == 1) {
        PsiClass curClass=classes[0];
        if (bucks > 0) {
          int newComponentStart=0;
          int lookupStart=0;
          while (true) {
            if (lookupStart > className.length()) {
              return newComponentStart != lookupStart ? null : curClass;
            }
            int b=className.indexOf("$",lookupStart);
            b=b < 0 ? className.length() : b;
            String component=className.substring(newComponentStart,b);
            PsiClass inner=curClass.findInnerClassByName(component,false);
            lookupStart=b + 1;
            if (inner == null) {
              continue;
            }
            newComponentStart=lookupStart;
            curClass=inner;
          }
        }
        return curClass;
      }
    }
  }
  return null;
}
