{
  if (!myDetectionInProgress && detector.getVirtualFileFilter().accept(virtualFile)) {
    try {
      myDetectionInProgress=true;
      if (!ProjectFileVersion.getInstance(myProject).isFacetAdditionEnabled(detector.getFacetType().getId(),false)) {
        return facets;
      }
      FacetInfo2<Module> facet=detector.detectFacet(virtualFile,myPsiManager);
      if (facet != null) {
        if (facets == null) {
          facets=new SmartList<FacetInfo2<Module>>();
        }
        facets.add(facet);
      }
    }
  finally {
      myDetectionInProgress=false;
    }
  }
  return facets;
}
