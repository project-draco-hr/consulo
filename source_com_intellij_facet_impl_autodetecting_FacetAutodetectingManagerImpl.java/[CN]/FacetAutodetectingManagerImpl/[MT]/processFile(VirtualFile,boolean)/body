{
  if (!virtualFile.isValid() || myProject.isDisposed())   return;
  FileType fileType=virtualFile.getFileType();
  Collection<FacetDetectorWrapper> detectors=myDetectors.get(fileType);
  if (detectors == null)   return;
  List<Facet> facets=null;
  for (  FacetDetectorWrapper<?,?,?,?> detector : detectors) {
    facets=process(virtualFile,detector,facets);
  }
  String url=virtualFile.getUrl();
  FacetDetectionIndexEntry indexEntry=myFileIndex.getIndexEntry(url);
  if (indexEntry == null) {
    indexEntry=new FacetDetectionIndexEntry(virtualFile.getTimeStamp());
  }
  Collection<FacetPointer> removed=indexEntry.update(myFacetPointersManager,facets);
  myFileIndex.putIndexEntry(url,indexEntry);
  if (removed != null) {
    removeObsoleteFacets(removed);
  }
  if (notifyIfDetected && facets != null && !facets.isEmpty()) {
    myImplicitFacetManager.onImplicitFacetChanged();
  }
}
