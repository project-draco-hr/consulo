def substitute(self, data, path, ctx, subfunc):
    'Replaces keywords in data with expanded template.'

    def kwsub(mobj):
        kw = mobj.group(1)
        self.ct.use_template(self.templates[kw])
        self.ui.pushbuffer()
        self.ct.show(ctx, root=self.repo.root, file=path)
        ekw = templatefilters.firstline(self.ui.popbuffer())
        return ('$%s: %s $' % (kw, ekw))
    return subfunc(kwsub, data)
