{
  try {
    indicator.checkCanceled();
    final Document document1=getContent1().getDocument();
    final Document document2=getContent2().getDocument();
    DocumentData data=ApplicationManager.getApplication().runReadAction(new Computable<DocumentData>(){
      @Override public DocumentData compute(){
        return new DocumentData(document1.getImmutableCharSequence(),document2.getImmutableCharSequence(),document1.getModificationStamp(),document2.getModificationStamp());
      }
    }
);
    List<LineFragment> lineFragments=null;
    if (getHighlightPolicy().isShouldCompare()) {
      lineFragments=DiffUtil.compareWithCache(myRequest,data,getDiffConfig(),indicator);
    }
    boolean isEqualContents=(lineFragments == null || lineFragments.isEmpty()) && StringUtil.equals(document1.getCharsSequence(),document2.getCharsSequence());
    return apply(new CompareData(lineFragments,isEqualContents));
  }
 catch (  DiffTooBigException e) {
    return applyNotification(DiffNotifications.DIFF_TOO_BIG);
  }
catch (  ProcessCanceledException e) {
    throw e;
  }
catch (  Throwable e) {
    LOG.error(e);
    return applyNotification(DiffNotifications.ERROR);
  }
}
