{
  String existingId=findExistingConfigurationId(settings);
  String newId=settings.getUniqueID();
  RunnerAndConfigurationSettings existingSettings=null;
  if (existingId != null) {
    existingSettings=myConfigurations.remove(existingId);
    mySharedConfigurations.remove(existingId);
  }
  if (mySelectedConfigurationId != null && mySelectedConfigurationId.equals(existingId)) {
    setSelectedConfigurationId(newId);
  }
  myConfigurations.put(newId,settings);
  RunConfiguration configuration=settings.getConfiguration();
  if (existingId == null) {
    refreshUsagesList(configuration);
  }
  checkRecentsLimit();
  mySharedConfigurations.put(newId,shared);
  setBeforeRunTasks(configuration,tasks,addEnabledTemplateTasksIfAbsent);
  if (existingSettings == settings) {
    myDispatcher.getMulticaster().runConfigurationChanged(settings,existingId);
  }
 else {
    myDispatcher.getMulticaster().runConfigurationAdded(settings);
  }
}
