{
  final RunConfiguration configuration=settings.getConfiguration();
  Integer existingId=findConfigurationIdByUniqueName(getUniqueName(settings));
  Integer newId=configuration.getUniqueID();
  RunnerAndConfigurationSettings existingSettings=null;
  if (existingId != null) {
    existingSettings=myConfigurations.remove(existingId);
    mySharedConfigurations.remove(existingId);
  }
  if (mySelectedConfigurationId != null && mySelectedConfigurationId.equals(existingId))   setSelectedConfigurationId(newId);
  myConfigurations.put(newId,settings);
  checkRecentsLimit();
  mySharedConfigurations.put(newId,shared);
  getTemplateBeforeRunTask(configuration);
  setBeforeRunTasks(configuration,tasks,addEnabledTemplateTasksIfAbsent);
  if (existingSettings == settings) {
    myDispatcher.getMulticaster().runConfigurationChanged(settings);
  }
 else {
    myDispatcher.getMulticaster().runConfigurationAdded(settings);
  }
}
