{
  final Element configurationElement=new Element(elementType);
  parentNode.addContent(configurationElement);
  ((RunnerAndConfigurationSettingsImpl)settings).writeExternal(configurationElement);
  if (!(settings.getConfiguration() instanceof UnknownRunConfiguration)) {
    final List<BeforeRunTask> tasks=getBeforeRunTasks(settings.getConfiguration());
    final Element methodsElement=new Element(METHOD);
    Map<Key<BeforeRunTask>,BeforeRunTask> templateTasks=null;
    if (!settings.isTemplate()) {
      List<BeforeRunTask> beforeRunTasks=getBeforeRunTasks(getConfigurationTemplate(settings.getFactory()).getConfiguration());
      templateTasks=new HashMap<Key<BeforeRunTask>,BeforeRunTask>();
      for (      BeforeRunTask templateTask : beforeRunTasks) {
        templateTasks.put(templateTask.getProviderId(),templateTask);
        if (templateTask.isEnabled()) {
          boolean found=false;
          for (          BeforeRunTask realTask : tasks) {
            if (realTask.getProviderId() == templateTask.getProviderId()) {
              found=true;
              break;
            }
          }
          if (!found) {
            BeforeRunTask clone=templateTask.clone();
            clone.setEnabled(false);
            tasks.add(0,clone);
          }
        }
      }
    }
    for (    BeforeRunTask task : tasks) {
      if (templateTasks != null) {
        BeforeRunTask templateTask=templateTasks.get(task.getProviderId());
        if (task.equals(templateTask))         continue;
      }
      final Element child=new Element(OPTION);
      child.setAttribute(NAME_ATTR,task.getProviderId().toString());
      task.writeExternal(child);
      methodsElement.addContent(child);
    }
    configurationElement.addContent(methodsElement);
  }
}
