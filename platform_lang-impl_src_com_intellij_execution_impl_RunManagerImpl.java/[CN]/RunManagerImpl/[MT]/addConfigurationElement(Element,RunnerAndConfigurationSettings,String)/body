{
  final Element configurationElement=new Element(elementType);
  parentNode.addContent(configurationElement);
  ((RunnerAndConfigurationSettingsImpl)settings).writeExternal(configurationElement);
  if (!(settings.getConfiguration() instanceof UnknownRunConfiguration)) {
    final List<BeforeRunTask> tasks=ContainerUtil.createLockFreeCopyOnWriteList(getBeforeRunTasks(settings.getConfiguration()));
    final Element methodsElement=new Element(METHOD);
    Map<Key<BeforeRunTask>,BeforeRunTask> templateTasks=new HashMap<Key<BeforeRunTask>,BeforeRunTask>();
    List<BeforeRunTask> beforeRunTasks=settings.isTemplate() ? getHardcodedBeforeRunTasks(settings.getConfiguration()) : getBeforeRunTasks(getConfigurationTemplate(settings.getFactory()).getConfiguration());
    for (    BeforeRunTask templateTask : beforeRunTasks) {
      templateTasks.put(templateTask.getProviderId(),templateTask);
      if (templateTask.isEnabled()) {
        boolean found=false;
        for (        BeforeRunTask realTask : tasks) {
          if (realTask.getProviderId() == templateTask.getProviderId()) {
            found=true;
            break;
          }
        }
        if (!found) {
          BeforeRunTask clone=templateTask.clone();
          clone.setEnabled(false);
          tasks.add(0,clone);
        }
      }
    }
    for (int i=0, size=tasks.size(); i < size; i++) {
      BeforeRunTask task=tasks.get(i);
      int j=0;
      BeforeRunTask templateTask=null;
      for (      Map.Entry<Key<BeforeRunTask>,BeforeRunTask> entry : templateTasks.entrySet()) {
        if (entry.getKey() == task.getProviderId()) {
          templateTask=entry.getValue();
          break;
        }
        j++;
      }
      if (task.equals(templateTask) && i == j) {
        continue;
      }
      final Element child=new Element(OPTION);
      child.setAttribute(NAME_ATTR,task.getProviderId().toString());
      task.writeExternal(child);
      methodsElement.addContent(child);
    }
    configurationElement.addContent(methodsElement);
  }
}
