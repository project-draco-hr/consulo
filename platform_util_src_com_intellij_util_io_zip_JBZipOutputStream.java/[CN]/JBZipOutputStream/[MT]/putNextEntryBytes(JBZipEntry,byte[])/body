{
  entry.setSize(bytes.length);
  crc.reset();
  crc.update(bytes);
  entry.setCrc(crc.getValue());
  if (entry.getMethod() == -1) {
    entry.setMethod(method);
  }
  if (entry.getTime() == -1) {
    entry.setTime(System.currentTimeMillis());
  }
  final byte[] outputBytes;
  if (entry.getMethod() == ZipEntry.DEFLATED) {
    def.setLevel(level);
    final ByteArrayOutputStream compressedBytesStream=new ByteArrayOutputStream();
    final DeflaterOutputStream stream=new DeflaterOutputStream(compressedBytesStream,def);
    try {
      stream.write(bytes);
    }
  finally {
      stream.close();
    }
    final byte[] compressedBytes=compressedBytesStream.toByteArray();
    entry.setCompressedSize(compressedBytes.length);
    outputBytes=compressedBytes;
  }
 else {
    entry.setCompressedSize(bytes.length);
    outputBytes=bytes;
  }
  writeLocalFileHeader(entry);
  writeOut(outputBytes);
}
