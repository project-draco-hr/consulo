{
  entry.setSize(bytes.length);
  crc.reset();
  crc.update(bytes);
  entry.setCrc(crc.getValue());
  if (entry.getMethod() == -1) {
    entry.setMethod(method);
  }
  if (entry.getTime() == -1) {
    entry.setTime(System.currentTimeMillis());
  }
  if (entry.getMethod() == ZipEntry.DEFLATED) {
    def.setLevel(level);
    final BufferExposingByteArrayOutputStream compressedBytesStream=new BufferExposingByteArrayOutputStream();
    final DeflaterOutputStream stream=new DeflaterOutputStream(compressedBytesStream,def);
    try {
      stream.write(bytes);
    }
  finally {
      stream.close();
    }
    final int length=compressedBytesStream.size();
    entry.setCompressedSize(length);
    writeLocalFileHeader(entry);
    writeOut(compressedBytesStream.getInternalBuffer(),0,length);
  }
 else {
    entry.setCompressedSize(bytes.length);
    writeLocalFileHeader(entry);
    writeOut(bytes);
  }
}
