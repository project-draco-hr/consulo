{
  final Map<File,Set<String>> sourceRootToReferencedPackagesMap=new HashMap<File,Set<String>>();
  final Map<File,Set<String>> sourceRootToPackagesMap=new HashMap<File,Set<String>>();
  final Map<File,ModuleDescriptor> contentRootToModules=new HashMap<File,ModuleDescriptor>();
  try {
    myProgress.pushState();
    for (    Pair<File,String> pair : mySourceRoots) {
      final File sourceRoot=pair.getFirst();
      if (myIgnoredNames.contains(sourceRoot.getName())) {
        continue;
      }
      myProgress.setText("Scanning " + sourceRoot.getPath());
      final HashSet<String> usedPackages=new HashSet<String>();
      sourceRootToReferencedPackagesMap.put(sourceRoot,usedPackages);
      final HashSet<String> selfPackages=new HashSet<String>();
      sourceRootToPackagesMap.put(sourceRoot,selfPackages);
      scanSources(sourceRoot,pair.getSecond(),usedPackages,selfPackages);
      usedPackages.removeAll(selfPackages);
    }
    myProgress.popState();
    myProgress.pushState();
    myProgress.setText("Building modules layout...");
    for (    File srcRoot : sourceRootToPackagesMap.keySet()) {
      final File moduleContentRoot=srcRoot.getParentFile();
      ModuleDescriptor moduleDescriptor=contentRootToModules.get(moduleContentRoot);
      if (moduleDescriptor != null) {
        moduleDescriptor.addSourceRoot(srcRoot);
      }
 else {
        moduleDescriptor=new ModuleDescriptor(moduleContentRoot,srcRoot);
        contentRootToModules.put(moduleContentRoot,moduleDescriptor);
      }
    }
    final Set<File> moduleContentRoots=contentRootToModules.keySet();
    for (    File contentRoot : moduleContentRoots) {
      final ModuleDescriptor checkedModule=contentRootToModules.get(contentRoot);
      myProgress.setText2("Building library dependencies for module " + checkedModule.getName());
      for (      File jarFile : myJarToPackagesMap.keySet()) {
        final Set<String> jarPackages=myJarToPackagesMap.get(jarFile);
        for (        File srcRoot : checkedModule.getSourceRoots()) {
          if (intersects(sourceRootToReferencedPackagesMap.get(srcRoot),jarPackages)) {
            checkedModule.addLibraryFile(jarFile);
            break;
          }
        }
      }
      myProgress.setText2("Building module dependencies for module " + checkedModule.getName());
      for (      File aContentRoot : moduleContentRoots) {
        final ModuleDescriptor aModule=contentRootToModules.get(aContentRoot);
        if (checkedModule.equals(aModule)) {
          continue;
        }
        final Set<File> aModuleRoots=aModule.getSourceRoots();
        checkModules:         for (        File srcRoot : checkedModule.getSourceRoots()) {
          final Set<String> referencedBySourceRoot=sourceRootToReferencedPackagesMap.get(srcRoot);
          for (          File aSourceRoot : aModuleRoots) {
            if (intersects(referencedBySourceRoot,sourceRootToPackagesMap.get(aSourceRoot))) {
              checkedModule.addDependencyOn(aModule);
              break checkModules;
            }
          }
        }
      }
    }
    myProgress.popState();
  }
 catch (  ProcessCanceledException ignored) {
  }
  myModules=new ArrayList<ModuleDescriptor>(contentRootToModules.values());
}
