{
  if (psiElement == null || !psiElement.isValid())   return "";
  String ref=psiElement.getText();
  if (descriptor instanceof ProblemDescriptorImpl) {
    TextRange textRange=((ProblemDescriptorImpl)descriptor).getTextRange();
    final TextRange elementRange=psiElement.getTextRange();
    if (textRange != null && elementRange != null) {
      textRange=textRange.shiftRight(-elementRange.getStartOffset());
      if (textRange.getStartOffset() >= 0 && textRange.getEndOffset() <= ref.length()) {
        ref=textRange.substring(ref);
      }
    }
  }
  ref=ref.replaceAll("\n"," ").trim();
  if (ref.length() > 100) {
    ref=ref.substring(0,100).trim() + "...";
  }
  return ref;
}
