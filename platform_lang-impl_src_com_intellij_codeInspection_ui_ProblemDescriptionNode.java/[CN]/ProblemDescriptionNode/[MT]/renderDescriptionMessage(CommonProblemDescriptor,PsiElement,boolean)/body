{
  String message=descriptor.getDescriptionTemplate();
  if (message == null)   return "";
  if (message.contains("#ref")) {
    String ref=extractHighlightedText(descriptor,element);
    message=StringUtil.replace(message,"#ref",ref);
  }
 else   if (appendLineNumber && descriptor instanceof ProblemDescriptor && message.contains("#loc")) {
    final int lineNumber=((ProblemDescriptor)descriptor).getLineNumber();
    if (lineNumber >= 0) {
      message=StringUtil.replace(message,"#loc","(" + InspectionsBundle.message("inspection.export.results.at.line") + " "+ lineNumber+ ")");
    }
  }
  message=StringUtil.replace(message,"<code>","'");
  message=StringUtil.replace(message,"</code>","'");
  message=StringUtil.replace(message,"#loc ","");
  message=StringUtil.replace(message," #loc","");
  message=StringUtil.replace(message,"#loc","");
  final int endIndex=message.indexOf("#end");
  if (endIndex > 0) {
    message=message.substring(0,endIndex);
  }
  message=StringUtil.unescapeXml(message).trim();
  return message;
}
