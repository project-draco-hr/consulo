{
  PsiDocumentManager.getInstance(myProject).commitAllDocuments();
  prepareTestRun();
  Ref<UsageInfo[]> refUsages=new Ref<UsageInfo[]>(findUsages());
  preprocessUsages(refUsages);
  final UsageInfo[] usages=refUsages.get();
  UsageViewDescriptor descriptor=createUsageViewDescriptor(usages);
  if (!ensureElementsWritable(usages,descriptor))   return;
  RefactoringListenerManagerImpl listenerManager=(RefactoringListenerManagerImpl)RefactoringListenerManager.getInstance(myProject);
  myTransaction=listenerManager.startTransaction();
  Set<PsiJavaFile> touchedJavaFiles=getTouchedJavaFiles(usages);
  performRefactoring(usages);
  removeRedundantImports(touchedJavaFiles);
  myTransaction.commit();
  performPsiSpoilingRefactoring();
}
