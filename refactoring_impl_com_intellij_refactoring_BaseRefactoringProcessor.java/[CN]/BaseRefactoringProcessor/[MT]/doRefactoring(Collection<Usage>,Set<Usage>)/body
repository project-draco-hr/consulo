{
  ApplicationManager.getApplication().assertWriteAccessAllowed();
  final Set<UsageInfo> usageInfoSet=new HashSet<UsageInfo>();
  if (usagesSet != null) {
    usagesSet.removeAll(excludedUsages);
    for (    final Usage usage : usagesSet) {
      if (usage instanceof PsiElementUsage) {
        final PsiElementUsage elementUsage=(PsiElementUsage)usage;
        final PsiElement element=elementUsage.getElement();
        if (element != null && element.isWritable()) {
          usageInfoSet.add(((UsageInfo2UsageAdapter)elementUsage).getUsageInfo());
        }
      }
 else {
        LOG.error("Unknown usage!");
      }
    }
  }
  LocalHistoryAction a=LocalHistory.startAction(myProject,getCommandName());
  final UsageInfo[] usages=usageInfoSet.toArray(new UsageInfo[usageInfoSet.size()]);
  try {
    PsiDocumentManager.getInstance(myProject).commitAllDocuments();
    RefactoringListenerManagerImpl listenerManager=(RefactoringListenerManagerImpl)RefactoringListenerManager.getInstance(myProject);
    myTransaction=listenerManager.startTransaction();
    Set<PsiJavaFile> touchedJavaFiles=getTouchedJavaFiles(usages);
    performRefactoring(usages);
    removeRedundantImports(touchedJavaFiles);
    myTransaction.commit();
    performPsiSpoilingRefactoring();
  }
  finally {
    a.finish();
  }
  if (usages != null) {
    int count=usages.length;
    if (count > 0) {
      WindowManager.getInstance().getStatusBar(myProject).setInfo(RefactoringBundle.message("statusBar.refactoring.result",count));
    }
 else {
      if (!isPreviewUsages(usages)) {
        WindowManager.getInstance().getStatusBar(myProject).setInfo(RefactoringBundle.message("statusBar.noUsages"));
      }
    }
  }
}
