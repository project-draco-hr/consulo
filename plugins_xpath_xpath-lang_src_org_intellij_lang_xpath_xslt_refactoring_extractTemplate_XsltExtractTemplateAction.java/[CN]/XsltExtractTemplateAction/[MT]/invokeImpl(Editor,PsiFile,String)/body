{
  final SelectionModel selectionModel=editor.getSelectionModel();
  if (!selectionModel.hasSelection()) {
    return false;
  }
  int startOffset=selectionModel.getSelectionStart();
  PsiElement start=file.findElementAt(startOffset);
  if (start instanceof PsiWhiteSpace) {
    if ((start=PsiTreeUtil.nextLeaf(start)) != null) {
      startOffset=start.getTextOffset();
    }
  }
  int endOffset=selectionModel.getSelectionEnd();
  PsiElement end=file.findElementAt(endOffset - 1);
  if (end instanceof PsiWhiteSpace) {
    if ((end=PsiTreeUtil.prevLeaf(end)) != null) {
      endOffset=end.getTextRange().getEndOffset();
    }
  }
  if (start == null || end == null) {
    return false;
  }
  if (!(start.getParent() instanceof XmlTag)) {
    return false;
  }
  if (start == end) {
    if (start.getTextRange().getStartOffset() != startOffset) {
      return false;
    }
    if (end.getTextRange().getEndOffset() != endOffset) {
      return false;
    }
    selectionModel.removeSelection();
    return extractFrom(start,end,newName);
  }
 else {
    final XmlTag startTag=PsiTreeUtil.getParentOfType(start,XmlTag.class);
    if (startTag == null) {
      return false;
    }
    if (startTag.getTextRange().getStartOffset() != startOffset) {
      return false;
    }
    final XmlTag endTag=PsiTreeUtil.getParentOfType(end,XmlTag.class);
    if (endTag == null) {
      return false;
    }
    if (endTag.getTextRange().getEndOffset() != endOffset) {
      return false;
    }
    if (startTag != endTag) {
      if (startTag.getParent() != endTag.getParent()) {
        return false;
      }
    }
    selectionModel.removeSelection();
    return extractFrom(startTag,endTag,newName);
  }
}
