{
  myEditor.getDocument().addDocumentListener(new DocumentAdapter(){
    public void documentChanged(    DocumentEvent e){
      if (!myChangeGuard && !myFinishing) {
        hide();
      }
    }
  }
,this);
  final CaretListener caretListener=new CaretListener(){
    public void caretPositionChanged(    CaretEvent e){
      if (!myChangeGuard && !myFinishing) {
        hide();
      }
    }
  }
;
  final SelectionListener selectionListener=new SelectionListener(){
    public void selectionChanged(    final SelectionEvent e){
      if (!myChangeGuard && !myFinishing) {
        hide();
      }
    }
  }
;
  final EditorMouseListener mouseListener=new EditorMouseAdapter(){
    public void mouseClicked(    EditorMouseEvent e){
      e.consume();
      hide();
    }
  }
;
  myEditor.getCaretModel().addCaretListener(caretListener);
  myEditor.getSelectionModel().addSelectionListener(selectionListener);
  myEditor.addEditorMouseListener(mouseListener);
  Disposer.register(this,new Disposable(){
    @Override public void dispose(){
      myEditor.getCaretModel().removeCaretListener(caretListener);
      myEditor.getSelectionModel().removeSelectionListener(selectionListener);
      myEditor.removeEditorMouseListener(mouseListener);
    }
  }
);
  myList.addListSelectionListener(new ListSelectionListener(){
    private LookupElement oldItem=null;
    public void valueChanged(    ListSelectionEvent e){
      myHintAlarm.cancelAllRequests();
      if (tip != null && tip.isVisible()) {
        tip.hide();
      }
      final LookupElement item=getCurrentItem();
      if (oldItem != item) {
        mySelectionInvariant=item == null ? null : myPresentableModel.getItemPresentationInvariant(item);
        fireCurrentItemChanged(item);
        if (myDisposed) {
          return;
        }
      }
      if (item != null) {
        updateHint(item);
        if (myList.getModel().getSize() > 1 && isVisible()) {
          final LookupCellRenderer renderer=new LookupCellRenderer(LookupImpl.this);
          renderer.setFullSize(true);
          final JComponent component=(JComponent)renderer.getListCellRendererComponent(myList,item,myList.getSelectedIndex(),true,false);
          component.setSize(component.getPreferredSize());
          if (component.getWidth() > myList.getWidth()) {
            tip=new HeavyweightHint(component,false);
            final Point p=myList.getLocationOnScreen();
            p.y+=myList.indexToLocation(myList.getSelectedIndex()).y;
            final JComponent editor=UIUtil.getRootPane(myEditor.getContentComponent());
            SwingUtilities.convertPointFromScreen(p,editor);
            tip.show(editor,p.x,p.y,null,new HintHint(editor,p));
          }
        }
      }
      oldItem=item;
    }
  }
);
  myList.addMouseListener(new MouseAdapter(){
    public void mouseClicked(    MouseEvent e){
      setFocused(true);
      markSelectionTouched();
      if (e.getClickCount() == 2) {
        CommandProcessor.getInstance().executeCommand(myProject,new Runnable(){
          public void run(){
            finishLookup(NORMAL_SELECT_CHAR);
          }
        }
,"",null);
      }
    }
  }
);
}
