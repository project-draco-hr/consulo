{
  if (!ApplicationManager.getApplication().isUnitTestMode()) {
    ApplicationManager.getApplication().assertIsDispatchThread();
  }
  final List<LookupElement> items=getSortedItems();
  SortedMap<Comparable,List<LookupElement>> itemsMap=new TreeMap<Comparable,List<LookupElement>>();
  int minPrefixLength=items.isEmpty() ? 0 : Integer.MAX_VALUE;
  for (  final LookupElement item : items) {
    minPrefixLength=Math.min(item.getPrefixMatcher().getPrefix().length(),minPrefixLength);
    final Comparable relevance=myArranger.getRelevance(item);
    List<LookupElement> list=itemsMap.get(relevance);
    if (list == null) {
      itemsMap.put(relevance,list=new ArrayList<LookupElement>());
    }
    list.add(item);
  }
  if (myMinPrefixLength != minPrefixLength) {
    myLookupStartMarker=null;
  }
  myMinPrefixLength=minPrefixLength;
  Object oldSelected=!myDirty ? null : myList.getSelectedValue();
  boolean hasExactPrefixes;
  final boolean hasPreselectedItem;
  final boolean hasItems;
  DefaultListModel model=(DefaultListModel)myList.getModel();
  final LookupElement preselectedItem=myPreselectedItem;
synchronized (myList) {
    model.clear();
    Set<LookupElement> firstItems=new THashSet<LookupElement>();
    hasExactPrefixes=addExactPrefixItems(model,firstItems,items);
    addMostRelevantItems(model,firstItems,itemsMap.values());
    hasPreselectedItem=addPreselectedItem(model,firstItems,preselectedItem);
    myPreferredItemsCount=firstItems.size();
    addRemainingItemsLexicographically(model,firstItems,items);
    hasItems=model.getSize() != 0;
    if (!hasItems) {
      addEmptyItem(model);
    }
  }
  updateListHeight(model);
  myAdComponent.setText(myAdText);
  if (hasItems) {
    myList.setFixedCellWidth(Math.max(myLookupWidth,myAdComponent.getPreferredSize().width));
  }
  if (hasItems) {
    if (oldSelected != null) {
      if (hasExactPrefixes || !ListScrollingUtil.selectItem(myList,oldSelected)) {
        selectMostPreferableItem();
      }
    }
 else {
      if (preselectedItem == EMPTY_LOOKUP_ITEM) {
        selectMostPreferableItem();
        myPreselectedItem=getCurrentItem();
      }
 else       if (hasPreselectedItem && !hasExactPrefixes) {
        ListScrollingUtil.selectItem(myList,preselectedItem);
      }
 else {
        selectMostPreferableItem();
      }
    }
  }
}
