{
  if (!performGuardedChange(new Runnable(){
    public void run(){
      EditorModificationUtil.deleteSelectedText(myEditor);
      int offset=myEditor.getCaretModel().getOffset();
      final int start=offset - presentPrefix.length();
      myEditor.getDocument().replaceString(start,offset,newPrefix);
      Map<LookupElement,PrefixMatcher> newMatchers=new HashMap<LookupElement,PrefixMatcher>();
      for (      LookupElement item : getItems()) {
        if (item.isValid()) {
          PrefixMatcher matcher=itemMatcher(item).cloneWithPrefix(newPrefix);
          if (matcher.prefixMatches(item)) {
            newMatchers.put(item,matcher);
          }
        }
      }
      myMatchers.clear();
      myMatchers.putAll(newMatchers);
      myAdditionalPrefix="";
      myEditor.getCaretModel().moveToOffset(start + newPrefix.length());
    }
  }
)) {
    return;
  }
  refreshUi(true,true);
}
