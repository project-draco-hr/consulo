{
  Dimension dim=getComponent().getPreferredSize();
  int lookupStart=getLookupStart();
  if (lookupStart < 0) {
    LOG.error(lookupStart + "; minprefix=" + myMinPrefixLength+ "; offset="+ myEditor.getCaretModel().getOffset()+ "; element="+ getPsiElement());
  }
  LogicalPosition pos=myEditor.offsetToLogicalPosition(lookupStart);
  Point location=myEditor.logicalPositionToXY(pos);
  location.y+=myEditor.getLineHeight();
  JComponent editorComponent=myEditor.getComponent();
  JComponent internalComponent=myEditor.getContentComponent();
  final JRootPane rootPane=editorComponent.getRootPane();
  if (rootPane == null) {
    LOG.error(myArranger + "; " + myEditor.isDisposed());
  }
  JLayeredPane layeredPane=rootPane.getLayeredPane();
  Point layeredPanePoint=SwingUtilities.convertPoint(internalComponent,location,layeredPane);
  layeredPanePoint.x-=myCellRenderer.getIconIndent();
  layeredPanePoint.x-=getComponent().getInsets().left;
  if (dim.width > layeredPane.getWidth()) {
    dim.width=layeredPane.getWidth();
  }
  int wshift=layeredPane.getWidth() - (layeredPanePoint.x + dim.width);
  if (wshift < 0) {
    layeredPanePoint.x+=wshift;
  }
  int shiftLow=layeredPane.getHeight() - (layeredPanePoint.y + dim.height);
  int shiftHigh=layeredPanePoint.y - dim.height;
  if (!isPositionedAboveCaret()) {
    myPositionedAbove=shiftLow < 0 && shiftLow < shiftHigh ? Boolean.TRUE : Boolean.FALSE;
  }
  if (isPositionedAboveCaret()) {
    layeredPanePoint.y-=dim.height + myEditor.getLineHeight();
    if (pos.line == 0) {
      layeredPanePoint.y+=1;
    }
  }
  return layeredPanePoint;
}
