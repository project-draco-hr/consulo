{
  DocumentWindow document=getInjectedDocument(caretOffset);
  if (document == null)   return insertLookupInDocument(caretOffset,myEditor.getDocument(),prefix,lookupString);
  PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
  int offset=document.hostToInjected(caretOffset);
  int lookupStart=Math.min(offset,Math.max(offset - prefix,0));
  int diff=-1;
  if (file != null) {
    List<TextRange> ranges=InjectedLanguageManager.getInstance(myProject).intersectWithAllEditableFragments(file,TextRange.create(lookupStart,offset));
    if (!ranges.isEmpty()) {
      diff=ranges.get(0).getStartOffset() - lookupStart;
      if (ranges.size() == 1 && diff == 0)       diff=-1;
    }
  }
  if (diff == -1)   return insertLookupInDocument(caretOffset,myEditor.getDocument(),prefix,lookupString);
  return document.injectedToHost(insertLookupInDocument(offset,document,prefix - diff,diff == 0 ? lookupString : lookupString.substring(diff)));
}
