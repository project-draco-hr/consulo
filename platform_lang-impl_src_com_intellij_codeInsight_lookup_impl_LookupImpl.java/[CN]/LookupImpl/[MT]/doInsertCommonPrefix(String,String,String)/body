{
  EditorModificationUtil.deleteSelectedText(myEditor);
  int offset=myEditor.getCaretModel().getOffset();
  if (beforeCaret != null) {
    final int start=offset - presentPrefix.length();
    myAdditionalPrefix="";
    myEditor.getDocument().replaceString(start,offset,beforeCaret);
    presentPrefix=beforeCaret;
  }
  offset=myEditor.getCaretModel().getOffset();
  myEditor.getDocument().insertString(offset,afterCaret);
  final String newPrefix=presentPrefix + afterCaret;
synchronized (myItems) {
    for (Iterator<LookupElement> iterator=myItems.iterator(); iterator.hasNext(); ) {
      LookupElement item=iterator.next();
      if (!item.setPrefixMatcher(item.getPrefixMatcher().cloneWithPrefix(newPrefix))) {
        iterator.remove();
        mySortedItems=null;
      }
    }
  }
  myAdditionalPrefix="";
  myAdditionalPrefix="";
  updateList();
  offset+=afterCaret.length();
  myEditor.getCaretModel().moveToOffset(offset);
}
