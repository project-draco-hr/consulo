{
  if (item == null || item instanceof EmptyLookupItem || item.getObject() instanceof DeferredUserLookupValue && item.as(LookupItem.CLASS_CONDITION_KEY) != null && !((DeferredUserLookupValue)item.getObject()).handleUserSelection(item.as(LookupItem.CLASS_CONDITION_KEY),myProject)) {
    doHide(false,true);
    fireItemSelected(null,completionChar);
    return;
  }
  if (myDisposed) {
    return;
  }
  final PsiFile file=getPsiFile();
  boolean writableOk=file == null || WriteCommandAction.ensureFilesWritable(myProject,Arrays.asList(file));
  if (myDisposed) {
    return;
  }
  if (!writableOk) {
    doHide(false,true);
    fireItemSelected(null,completionChar);
    return;
  }
  final String prefix=itemPattern(item);
  boolean plainMatch=ContainerUtil.or(item.getAllLookupStrings(),new Condition<String>(){
    @Override public boolean value(    String s){
      return StringUtil.containsIgnoreCase(s,prefix);
    }
  }
);
  if (!plainMatch) {
    FeatureUsageTracker.getInstance().triggerFeatureUsed(CodeCompletionFeatures.EDITING_COMPLETION_CAMEL_HUMPS);
  }
  myFinishing=true;
  AccessToken token=WriteAction.start();
  try {
    insertLookupString(item,myOffsets.getPrefixLength(item,this));
  }
  finally {
    token.finish();
  }
  if (myDisposed) {
    return;
  }
  doHide(false,true);
  fireItemSelected(item,completionChar);
}
