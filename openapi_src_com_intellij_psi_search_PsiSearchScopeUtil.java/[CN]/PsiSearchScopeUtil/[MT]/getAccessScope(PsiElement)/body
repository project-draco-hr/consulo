{
  if (element instanceof PsiPackage) {
    return element.getUseScope();
  }
 else   if (element instanceof PsiClass) {
    if (element instanceof PsiAnonymousClass) {
      return new LocalSearchScope(element);
    }
    PsiFile file=element.getContainingFile();
    if (file instanceof JspFile) {
      return new LocalSearchScope(file);
    }
    PsiClass aClass=(PsiClass)element;
    if (aClass.hasModifierProperty(PsiModifier.PUBLIC)) {
      return element.getUseScope();
    }
 else     if (aClass.hasModifierProperty(PsiModifier.PROTECTED)) {
      return element.getUseScope();
    }
 else     if (aClass.hasModifierProperty(PsiModifier.PRIVATE)) {
      PsiClass topClass=getTopLevelClass(aClass);
      return topClass != null ? new LocalSearchScope(topClass) : new LocalSearchScope(aClass.getContainingFile());
    }
 else {
      PsiPackage aPackage=null;
      if (file instanceof PsiJavaFile) {
        aPackage=element.getManager().findPackage(((PsiJavaFile)file).getPackageName());
      }
      if (aPackage == null) {
        PsiDirectory dir=file.getContainingDirectory();
        if (dir != null) {
          aPackage=dir.getPackage();
        }
      }
      if (aPackage != null) {
        GlobalSearchScope scope=GlobalSearchScope.packageScope(aPackage,false);
        scope=scope.intersectWith(element.getUseScope());
        return scope;
      }
      return new LocalSearchScope(file);
    }
  }
 else   if (element instanceof PsiMethod) {
    PsiFile file=element.getContainingFile();
    if (file instanceof JspFile) {
      return new LocalSearchScope(file);
    }
    PsiMethod method=(PsiMethod)element;
    PsiClass aClass=method.getContainingClass();
    if (aClass instanceof PsiAnonymousClass) {
      PsiElement methodCallExpr=PsiTreeUtil.getParentOfType(aClass,PsiMethodCallExpression.class);
      return new LocalSearchScope(methodCallExpr != null ? methodCallExpr : aClass);
    }
    if (method.hasModifierProperty(PsiModifier.PUBLIC)) {
      return element.getUseScope();
    }
 else     if (method.hasModifierProperty(PsiModifier.PROTECTED)) {
      return element.getUseScope();
    }
 else     if (method.hasModifierProperty(PsiModifier.PRIVATE)) {
      PsiClass topClass=getTopLevelClass(method);
      return topClass != null ? new LocalSearchScope(topClass) : new LocalSearchScope(method.getContainingFile());
    }
 else {
      PsiPackage aPackage=file.getContainingDirectory().getPackage();
      if (aPackage != null) {
        GlobalSearchScope scope=GlobalSearchScope.packageScope(aPackage,false);
        scope=scope.intersectWith(element.getUseScope());
        return scope;
      }
 else {
        return new LocalSearchScope(file);
      }
    }
  }
 else   if (element instanceof PsiField) {
    PsiFile file=element.getContainingFile();
    if (file instanceof JspFile) {
      return new LocalSearchScope(file);
    }
    PsiField field=(PsiField)element;
    if (field.hasModifierProperty(PsiModifier.PUBLIC)) {
      return element.getUseScope();
    }
 else     if (field.hasModifierProperty(PsiModifier.PROTECTED)) {
      return element.getUseScope();
    }
 else     if (field.hasModifierProperty(PsiModifier.PRIVATE)) {
      PsiClass topClass=getTopLevelClass(field);
      return topClass != null ? new LocalSearchScope(topClass) : new LocalSearchScope(field.getContainingFile());
    }
 else {
      final PsiDirectory directory=file.getContainingDirectory();
      PsiPackage aPackage=directory == null ? null : directory.getPackage();
      if (aPackage != null) {
        GlobalSearchScope scope=GlobalSearchScope.packageScope(aPackage,false);
        scope=scope.intersectWith(element.getUseScope());
        return scope;
      }
 else {
        return new LocalSearchScope(file);
      }
    }
  }
 else   if (element instanceof ImplicitVariable) {
    return new LocalSearchScope(((ImplicitVariable)element).getDeclarationScope());
  }
 else   if (element instanceof PsiLocalVariable) {
    PsiElement parent=element.getParent();
    if (parent instanceof PsiDeclarationStatement) {
      return new LocalSearchScope(parent.getParent());
    }
 else {
      return element.getUseScope();
    }
  }
 else   if (element instanceof PsiParameter) {
    return new LocalSearchScope(((PsiParameter)element).getDeclarationScope());
  }
 else   if (element instanceof PsiAntElement) {
    return ((PsiAntElement)element).getSearchScope();
  }
 else {
    AccessScopeHandler accessScopeHandler=scopeHandlers.get(element.getContainingFile().getFileType());
    if (accessScopeHandler != null)     return accessScopeHandler.getAccessScope(element);
    return new LocalSearchScope(element.getContainingFile());
  }
}
