{
  final SliceRootNode root=(SliceRootNode)treeStructure.getRootElement();
  final Ref<Collection<PsiElement>> leafExpressions=Ref.create(null);
  final Map<SliceNode,Collection<PsiElement>> map=createMap();
  ProgressManager.getInstance().run(new Task.Backgroundable(root.getProject(),"Expanding all nodes... (may very well take the whole day)",true){
    public void run(    @NotNull final ProgressIndicator indicator){
      Collection<PsiElement> l=calcLeafExpressions(root,treeStructure,map);
      leafExpressions.set(l);
    }
    @Override public void onCancel(){
      finish.run();
    }
    @Override public void onSuccess(){
      try {
        Collection<PsiElement> leaves=leafExpressions.get();
        if (leaves == null)         return;
        if (leaves.isEmpty()) {
          Messages.showErrorDialog("Unable to find leaf expressions to group by","Cannot group");
          return;
        }
        groupByValues(leaves,root,map);
      }
  finally {
        finish.run();
      }
    }
  }
);
}
