{
  if (document instanceof DocumentWindow) {
    DocumentWindow documentWindow=(DocumentWindow)document;
    final int hostOffset=documentWindow.injectedToHost(offset);
    final PsiFile hostFile=InjectedLanguageUtil.getTopLevelFile(file);
    final int correctedOffset=doAdjustLineIndentByOffset(documentWindow.getDelegate(),hostFile,hostOffset);
    return documentWindow.hostToInjected(correctedOffset);
  }
  final PsiFile templateFile=PsiUtilBase.getTemplateLanguageFile(file);
  if (templateFile != null) {
    file=templateFile;
    document=PsiDocumentManager.getInstance(myProject).getDocument(templateFile);
  }
  final PsiElement element=findElementInTreeWithFormatterEnabled(file,offset);
  if (element == null && offset != file.getTextLength()) {
    return offset;
  }
  if (element instanceof PsiComment && insideElement(element,offset) && !containsInjections(element)) {
    return CharArrayUtil.shiftForward(file.getViewProvider().getContents(),offset," \t");
  }
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forContext(file);
  FormattingModelBuilder elementBuilder=builder;
  if (element != null) {
    elementBuilder=LanguageFormatting.INSTANCE.forContext(element);
  }
  if (builder != null && elementBuilder != null) {
    final CodeStyleSettings settings=getSettings();
    final CodeStyleSettings.IndentOptions indentOptions=settings.getIndentOptions(file.getFileType());
    final TextRange significantRange=getSignificantRange(file,offset);
    FormattingModel model=builder.createModel(file,settings);
    if (document != null) {
      model=new DocumentBasedFormattingModel(model.getRootBlock(),document,getProject(),settings,file.getFileType(),file);
    }
    return FormatterEx.getInstanceEx().adjustLineIndent(model,settings,indentOptions,offset,significantRange);
  }
 else {
    return offset;
  }
}
