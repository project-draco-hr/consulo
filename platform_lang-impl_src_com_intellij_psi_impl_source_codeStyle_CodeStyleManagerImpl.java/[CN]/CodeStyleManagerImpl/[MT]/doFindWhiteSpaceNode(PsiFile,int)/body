{
  ASTNode astNode=SourceTreeToPsiMap.psiElementToTree(file);
  if (!(astNode instanceof FileElement)) {
    return new Pair<PsiElement,CharTable>(null,null);
  }
  PsiElement elementAt=InjectedLanguageUtil.findInjectedElementNoCommit(file,offset);
  final CharTable charTable=((FileElement)astNode).getCharTable();
  if (elementAt == null) {
    elementAt=findElementInTreeWithFormatterEnabled(file,offset);
  }
  if (elementAt == null) {
    return new Pair<PsiElement,CharTable>(null,charTable);
  }
  ASTNode node=elementAt.getNode();
  if (node == null || node.getElementType() != TokenType.WHITE_SPACE) {
    return new Pair<PsiElement,CharTable>(null,charTable);
  }
  return new Pair<PsiElement,CharTable>(elementAt,charTable);
}
