{
  if (file instanceof PsiCompiledElement) {
    file=(PsiFile)((PsiCompiledElement)file).getMirror();
  }
  final PsiElement element=findElementInTreeWithFormatterEnabled(file,offset);
  if (element == null) {
    return null;
  }
  if (element instanceof PsiComment && insideElement(element,offset)) {
    return null;
  }
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forContext(file);
  final FormattingModelBuilder elementBuilder=LanguageFormatting.INSTANCE.forContext(element);
  if (builder != null && elementBuilder != null) {
    final CodeStyleSettings settings=getSettings();
    final CodeStyleSettings.IndentOptions indentOptions=settings.getIndentOptions(file.getFileType());
    final TextRange significantRange=getSignificantRange(file,offset);
    final FormattingModel model=builder.createModel(file,settings);
    return FormatterEx.getInstanceEx().getLineIndent(model,settings,indentOptions,offset,significantRange);
  }
 else {
    return null;
  }
}
