{
  LOG.assertTrue(element.isValid());
  CheckUtil.checkWritable(element);
  if (!SourceTreeToPsiMap.hasTreeElement(element)) {
    return element;
  }
  ASTNode treeElement=SourceTreeToPsiMap.psiElementToTree(element);
  FileType fileType=StdFileTypes.JAVA;
  PsiFile file=element.getContainingFile();
  if (file != null) {
    fileType=file.getFileType();
  }
  final CodeFormatterFacade codeFormatter=new CodeFormatterFacade(getSettings(),fileType);
  final PsiElement formatted=SourceTreeToPsiMap.treeElementToPsi(codeFormatter.processRange(treeElement,startOffset,endOffset));
  return canChangeWhiteSpacesOnly ? formatted : postProcessElement(formatted);
}
