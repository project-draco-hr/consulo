{
  LOG.assertTrue(addedElement.getTreeParent() == parent,"addedElement must be added to parent");
  final PsiElement psiElement=parent.getPsi();
  PsiFile containingFile=psiElement.getContainingFile();
  final FileViewProvider fileViewProvider=containingFile.getViewProvider();
  if (fileViewProvider instanceof MultiplePsiFilesPerDocumentFileViewProvider) {
    containingFile=fileViewProvider.getPsi(fileViewProvider.getBaseLanguage());
  }
  TextRange textRange=addedElement.getTextRange();
  final Document document=fileViewProvider.getDocument();
  if (document instanceof DocumentWindow) {
    containingFile=InjectedLanguageUtil.getTopLevelFile(containingFile);
    textRange=((DocumentWindow)document).injectedToHost(textRange);
  }
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forContext(containingFile);
  if (builder != null) {
    final FormattingModel model=builder.createModel(containingFile,getSettings());
    FormatterEx.getInstanceEx().formatAroundRange(model,getSettings(),textRange,containingFile.getFileType());
  }
  adjustLineIndent(containingFile,textRange);
}
