{
  LOG.assertTrue(addedElement.getTreeParent() == parent,"addedElement must be added to parent");
  final PsiElement psiElement=parent.getPsi();
  PsiFile containingFile=psiElement.getContainingFile();
  final FileViewProvider fileViewProvider=containingFile.getViewProvider();
  if (fileViewProvider instanceof MultiplePsiFilesPerDocumentFileViewProvider) {
    containingFile=fileViewProvider.getPsi(fileViewProvider.getBaseLanguage());
  }
  final FormattingModelBuilder builder=LanguageFormatting.INSTANCE.forContext(containingFile);
  if (builder != null) {
    final FormattingModel model=builder.createModel(containingFile,getSettings());
    FormatterEx.getInstanceEx().formatAroundRange(model,getSettings(),addedElement.getTextRange(),containingFile.getFileType());
  }
  adjustLineIndent(containingFile,addedElement.getTextRange());
}
