{
  ApplicationManager.getApplication().assertIsDispatchThread();
  boolean oldDontCollapseCaret=myDoNotCollapseCaret;
  myDoNotCollapseCaret|=dontCollapseCaret;
  boolean oldBatchFlag=myIsBatchFoldingProcessing;
  if (!oldBatchFlag) {
    mySavedCaretShift=myEditor.visibleLineNumberToYPosition(myEditor.getCaretModel().getVisualPosition().line) - myEditor.getScrollingModel().getVerticalScrollOffset();
  }
  myIsBatchFoldingProcessing=true;
  myFoldTree.myCachedLastIndex=-1;
  operation.run();
  myFoldTree.myCachedLastIndex=-1;
  if (!oldBatchFlag) {
    if (myFoldRegionsProcessed) {
      notifyBatchFoldingProcessingDone();
      myFoldRegionsProcessed=false;
    }
    myIsBatchFoldingProcessing=false;
  }
  myDoNotCollapseCaret=oldDontCollapseCaret;
}
