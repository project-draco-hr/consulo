{
  LOG.assertTrue(!editor.isDisposed());
  clear();
  PsiDocumentManager.getInstance(myProject).commitDocument(editor.getDocument());
  EditorFoldingInfo info=EditorFoldingInfo.get(editor);
  FoldRegion[] foldRegions=editor.getFoldingModel().getAllFoldRegions();
  for (  FoldRegion region : foldRegions) {
    PsiElement element=info.getPsiElement(region);
    boolean expanded=region.isExpanded();
    boolean collapseByDefault=element != null && FoldingPolicy.isCollapseByDefault(element) && !FoldingUtil.caretInsideRange(editor,TextRange.create(region));
    if (collapseByDefault == expanded || element == null) {
      if (element != null) {
        myPsiElementsOrRangeMarkers.add(element);
      }
 else       if (region.isValid()) {
        myPsiElementsOrRangeMarkers.add(region);
        String placeholderText=region.getPlaceholderText();
        myPlaceholderTexts.put(region,placeholderText);
      }
      myExpandedStates.add(expanded ? Boolean.TRUE : Boolean.FALSE);
    }
  }
}
