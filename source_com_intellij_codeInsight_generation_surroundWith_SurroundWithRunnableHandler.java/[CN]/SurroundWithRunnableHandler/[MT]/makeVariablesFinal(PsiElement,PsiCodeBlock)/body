{
  PsiElement[] children=scope.getChildren();
  for (int i=0; i < children.length; i++) {
    PsiElement child=children[i];
    makeVariablesFinal(child,body);
    if (child instanceof PsiReferenceExpression) {
      if (child.getParent() instanceof PsiMethodCallExpression)       continue;
      if (child.getChildren().length != 1)       continue;
      PsiElement refElement=((PsiReferenceExpression)child).resolve();
      if (refElement instanceof PsiLocalVariable || refElement instanceof PsiParameter) {
        PsiVariable variable=(PsiVariable)refElement;
        PsiElement parent=variable.getParent();
        while (parent != null) {
          if (parent.equals(body))           break;
          parent=parent.getParent();
        }
        if (parent == null) {
          variable.getModifierList().setModifierProperty(PsiModifier.FINAL,true);
        }
      }
    }
  }
}
