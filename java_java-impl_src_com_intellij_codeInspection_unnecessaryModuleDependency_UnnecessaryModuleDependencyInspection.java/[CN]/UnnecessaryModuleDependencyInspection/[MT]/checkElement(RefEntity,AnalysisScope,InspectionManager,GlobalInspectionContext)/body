{
  if (refEntity instanceof RefModule) {
    final RefModule refModule=(RefModule)refEntity;
    final Module module=refModule.getModule();
    final Module[] declaredDependencies=ModuleRootManager.getInstance(module).getDependencies();
    List<CommonProblemDescriptor> descriptors=new ArrayList<CommonProblemDescriptor>();
    final Set<Module> modules=refModule.getUserData(UnnecessaryModuleDependencyAnnotator.DEPENDENCIES);
    for (    final Module dependency : declaredDependencies) {
      if (modules == null || !modules.contains(dependency)) {
        final CommonProblemDescriptor problemDescriptor;
        if (scope.containsModule(dependency)) {
          problemDescriptor=manager.createProblemDescriptor(InspectionsBundle.message("unnecessary.module.dependency.problem.descriptor",module.getName(),dependency.getName()),new RemoveModuleDependencyFix(module,dependency));
        }
 else {
          problemDescriptor=manager.createProblemDescriptor(InspectionsBundle.message("suspected.module.dependency.problem.descriptor",module.getName(),dependency.getName(),scope.getDisplayName(),dependency.getName()),null);
        }
        descriptors.add(problemDescriptor);
      }
    }
    return descriptors.isEmpty() ? null : descriptors.toArray(new CommonProblemDescriptor[descriptors.size()]);
  }
  return null;
}
