{
  if (!toUpdatePreview) {
    return;
  }
  final String text="/*\n" + " * This is a sample file.\n" + " */\n"+ "package com.intellij.samples;\n"+ "import com.intellij.idea.Main;\n"+ "import javax.swing.*;\n"+ "import java.util.Vector;\n"+ "public class Foo {\n"+ "  private int field1;\n"+ "  private int field2;\n"+ "  public void foo1() {\n\n"+ "  }\n"+ "  public void foo2() {\n"+ "  }\n\n"+ "}";
  final Project project=ProjectManager.getInstance().getDefaultProject();
  final PsiManager manager=PsiManager.getInstance(project);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      PsiElementFactory factory=manager.getElementFactory();
      try {
        PsiFile psiFile=factory.createFileFromText("a.java",text);
        CodeStyleSettings saved=mySettings;
        mySettings=(CodeStyleSettings)mySettings.clone();
        apply();
        CodeStyleSettingsManager.getInstance(project).setTemporarySettings(mySettings);
        CodeStyleManager.getInstance(project).reformat(psiFile);
        CodeStyleSettingsManager.getInstance(project).dropTemporarySettings();
        myEditor.getSettings().setTabSize(mySettings.getTabSize(StdFileTypes.JAVA));
        Document document=myEditor.getDocument();
        document.replaceString(0,document.getTextLength(),psiFile.getText());
        mySettings=saved;
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
      }
    }
  }
);
}
