{
  rootModel.setExcludeOutput(true);
  rootModel.inheritJdk();
  final Set<File> contentRoots=descriptor.getContentRoots();
  for (  File contentRoot : contentRoots) {
    final LocalFileSystem lfs=LocalFileSystem.getInstance();
    VirtualFile moduleContentRoot=lfs.refreshAndFindFileByPath(FileUtil.toSystemIndependentName(contentRoot.getPath()));
    if (moduleContentRoot != null) {
      final ContentEntry contentEntry=rootModel.addContentEntry(moduleContentRoot);
      final Set<File> sourceRoots=descriptor.getSourceRoots(contentRoot);
      for (      File srcRoot : sourceRoots) {
        final String srcpath=FileUtil.toSystemIndependentName(srcRoot.getPath());
        final VirtualFile sourceRoot=lfs.refreshAndFindFileByPath(srcpath);
        if (sourceRoot != null) {
          final String packagePrefix=sourceRootToPrefixMap.get(srcpath);
          if (packagePrefix == null || "".equals(packagePrefix)) {
            contentEntry.addSourceFolder(sourceRoot,false);
          }
 else {
            contentEntry.addSourceFolder(sourceRoot,false,packagePrefix);
          }
        }
      }
    }
  }
  rootModel.inheritCompilerOutputPath(true);
  final LibraryTable moduleLibraryTable=rootModel.getModuleLibraryTable();
  for (  LibraryDescriptor libDescriptor : myModuleInsight.getLibraryDependencies(descriptor)) {
    if (!isLibraryChosen(libDescriptor)) {
      continue;
    }
    final Library projectLib=projectLibs.get(libDescriptor);
    if (projectLib != null) {
      rootModel.addLibraryEntry(projectLib);
    }
 else {
      final Collection<File> jars=libDescriptor.getJars();
      for (      File file : jars) {
        Library library=moduleLibraryTable.createLibrary();
        Library.ModifiableModel modifiableModel=library.getModifiableModel();
        modifiableModel.addRoot(VfsUtil.getUrlForLibraryRoot(file),OrderRootType.CLASSES);
        modifiableModel.commit();
      }
    }
  }
}
