{
  ModifiableModuleModel moduleModel=ModuleManager.getInstance(project).getModifiableModel();
  final String name=descriptor.getName();
  final String moduleFilePath;
  final Set<File> contentRoots=descriptor.getContentRoots();
  if (contentRoots.size() > 0) {
    moduleFilePath=contentRoots.iterator().next().getPath() + File.separator + name+ ".iml";
  }
 else {
    throw new InvalidDataException("Module " + name + " has no content roots and will not be created");
  }
  final Module module=moduleModel.newModule(moduleFilePath,ModuleType.JAVA);
  final ModifiableRootModel modifiableModel=ModuleRootManager.getInstance(module).getModifiableModel();
  setupRootModel(descriptor,modifiableModel,sourceRootToPrefixMap,projectLibs);
  modifiableModel.commit();
  module.setSavePathsRelative(true);
  moduleModel.commit();
  return module;
}
