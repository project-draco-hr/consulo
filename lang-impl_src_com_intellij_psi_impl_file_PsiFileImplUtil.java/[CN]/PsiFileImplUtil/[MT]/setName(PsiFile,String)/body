{
  VirtualFile vFile=file.getViewProvider().getVirtualFile();
  PsiManagerImpl manager=(PsiManagerImpl)file.getManager();
  try {
    final FileDocumentManager fdm=FileDocumentManager.getInstance();
    final Document doc=fdm.getCachedDocument(vFile);
    if (doc != null) {
      EditorSettingsExternalizable editorSettings=EditorSettingsExternalizable.getInstance();
      String trailer=editorSettings.getStripTrailingSpaces();
      editorSettings.setStripTrailingSpaces(EditorSettingsExternalizable.STRIP_TRAILING_SPACES_NONE);
      try {
        fdm.saveDocument(doc);
      }
  finally {
        editorSettings.setStripTrailingSpaces(trailer);
      }
    }
    vFile.rename(manager,newName);
  }
 catch (  IOException e) {
    throw new IncorrectOperationException(e.toString(),e);
  }
  return file.getViewProvider().isPhysical() ? manager.findFile(vFile) : file;
}
