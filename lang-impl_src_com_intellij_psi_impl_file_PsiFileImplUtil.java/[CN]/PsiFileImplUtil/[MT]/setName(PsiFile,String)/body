{
  VirtualFile vFile=file.getViewProvider().getVirtualFile();
  PsiManagerImpl manager=(PsiManagerImpl)file.getManager();
  try {
    final FileDocumentManager fdm=FileDocumentManager.getInstance();
    final Document doc=fdm.getCachedDocument(vFile);
    if (doc != null) {
      fdm.saveDocument(doc);
    }
    vFile.rename(manager,newName);
  }
 catch (  IOException e) {
    throw new IncorrectOperationException(e.toString(),e);
  }
  return file.getViewProvider().isPhysical() ? manager.findFile(vFile) : file;
}
