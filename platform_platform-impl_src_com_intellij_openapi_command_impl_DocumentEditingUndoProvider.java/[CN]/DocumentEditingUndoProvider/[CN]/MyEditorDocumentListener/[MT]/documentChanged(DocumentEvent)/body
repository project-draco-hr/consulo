{
  final Document document=e.getDocument();
  if (UndoManagerImpl.isCopy(document))   return;
  if (allEditorsAreViewersFor(document))   return;
  if (!isToRecordActions(document))   return;
  UndoManagerImpl undoManager=getUndoManager();
  if (externalChanges()) {
    createNonUndoableAction(document);
  }
 else {
    LOG.assertTrue(undoManager.isInsideCommand(),"Undoable actions allowed inside commands only (see com.intellij.openapi.command.CommandProcessor.executeCommand())");
    if (undoManager.isActive()) {
      createUndoableEditorChangeAction(e);
    }
 else {
      createNonUndoableAction(document);
    }
  }
}
