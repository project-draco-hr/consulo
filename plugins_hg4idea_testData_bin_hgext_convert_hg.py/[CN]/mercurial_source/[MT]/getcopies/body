def getcopies(self, ctx, parents, files):
    copies = {}
    for name in files:
        if (name in self.ignored):
            continue
        try:
            (copysource, copynode) = ctx.filectx(name).renamed()
            if ((copysource in self.ignored) or (not self.keep(copynode))):
                continue
            found = False
            for p in parents:
                if (copysource in p):
                    found = True
                    break
            if (not found):
                continue
            copies[name] = copysource
        except TypeError:
            pass
        except error.LookupError as e:
            if (not self.ignoreerrors):
                raise
            self.ignored.add(name)
            self.ui.warn((_('ignoring: %s\n') % e))
    return copies
