{
  final ProjectFacetsConfigurator facetsConfigurator=myContext.getModulesConfigurator().getFacetsConfigurator();
  List<Module> suitableModules=new ArrayList<Module>(Arrays.asList(myContext.getModules()));
  final Iterator<Module> iterator=suitableModules.iterator();
  while (iterator.hasNext()) {
    Module module=iterator.next();
    if (!type.isSuitableModuleType(ModuleType.get(module)) || (type.isOnlyOneFacetAllowed() && facetsConfigurator.hasFacetOfType(module,null,type.getId()))) {
      iterator.remove();
    }
  }
  final Project project=myContext.getProject();
  if (suitableModules.isEmpty()) {
    Messages.showErrorDialog(project,"No suitable modules for " + type.getPresentableName() + " facet found.","Cannot Create Facet");
    return;
  }
  final ChooseModulesDialog dialog=new ChooseModulesDialog(project,suitableModules,"Choose Module",type.getPresentableName() + " facet will be added to selected module");
  dialog.setSingleSelectionMode();
  dialog.show();
  final List<Module> elements=dialog.getChosenElements();
  if (!dialog.isOK() || elements.size() != 1)   return;
  final Module module=elements.get(0);
  final Facet facet=ModuleStructureConfigurable.getInstance(project).getFacetEditorFacade().createAndAddFacet(type,module,null);
  ProjectStructureConfigurable.getInstance(project).select(facet,true);
}
