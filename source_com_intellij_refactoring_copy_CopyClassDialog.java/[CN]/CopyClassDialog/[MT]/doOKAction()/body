{
  final String packageName=getPackageName();
  final String className=getClassName();
  final String[] errorString=new String[1];
  final PsiManager manager=PsiManager.getInstance(myProject);
  if ("".equals(className)) {
    errorString[0]="No class name specified";
  }
 else   if (!manager.getNameHelper().isIdentifier(className)) {
    errorString[0]=RefactoringMessageUtil.getIncorrectIdentifierMessage(className);
  }
 else   if (!myDoClone) {
    try {
      myTargetDirectory=PackageUtil.findOrCreateDirectoryForPackage(myProject,packageName,myDefaultTargetDirectory,true);
      if (myTargetDirectory == null) {
        errorString[0]="";
      }
 else {
        CommandProcessor.getInstance().executeCommand(myProject,new Runnable(){
          public void run(){
            ApplicationManager.getApplication().runWriteAction(new Runnable(){
              public void run(){
                errorString[0]=RefactoringMessageUtil.checkCanCreateClass(myTargetDirectory,className);
              }
            }
);
          }
        }
,"Create directory",null);
      }
    }
 catch (    IncorrectOperationException e) {
      errorString[0]=e.getMessage();
    }
  }
  if (errorString[0] != null) {
    if (errorString[0].length() > 0) {
      Messages.showMessageDialog(myProject,errorString[0],"Error",Messages.getErrorIcon());
    }
    myNameField.requestFocusInWindow();
    return;
  }
  super.doOKAction();
}
