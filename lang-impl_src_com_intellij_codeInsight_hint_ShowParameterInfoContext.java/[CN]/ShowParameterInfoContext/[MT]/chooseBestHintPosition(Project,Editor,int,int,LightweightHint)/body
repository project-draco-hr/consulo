{
  HintManagerImpl hintManager=HintManagerImpl.getInstanceImpl();
  Dimension hintSize=hint.getComponent().getPreferredSize();
  JComponent editorComponent=editor.getComponent();
  JLayeredPane layeredPane=editorComponent.getRootPane().getLayeredPane();
  Point p1;
  Point p2;
  boolean isLookupShown=LookupManager.getInstance(project).getActiveLookup() != null;
  if (isLookupShown) {
    p1=hintManager.getHintPosition(hint,editor,HintManagerImpl.UNDER);
    p2=hintManager.getHintPosition(hint,editor,HintManagerImpl.ABOVE);
  }
 else {
    LogicalPosition pos=new LogicalPosition(line,col);
    p1=hintManager.getHintPosition(hint,editor,pos,HintManagerImpl.UNDER);
    p2=hintManager.getHintPosition(hint,editor,pos,HintManagerImpl.ABOVE);
  }
  p1.x=Math.min(p1.x,layeredPane.getWidth() - hintSize.width);
  p1.x=Math.max(p1.x,0);
  p2.x=Math.min(p2.x,layeredPane.getWidth() - hintSize.width);
  p2.x=Math.max(p2.x,0);
  boolean p1Ok=p1.y + hintSize.height < layeredPane.getHeight();
  boolean p2Ok=p2.y >= 0;
  if (isLookupShown) {
    if (p2Ok)     return p2;
    if (p1Ok)     return p1;
  }
 else {
    if (p1Ok)     return p1;
    if (p2Ok)     return p2;
  }
  int underSpace=layeredPane.getHeight() - p1.y;
  int aboveSpace=p2.y;
  return aboveSpace > underSpace ? new Point(p2.x,0) : p1;
}
