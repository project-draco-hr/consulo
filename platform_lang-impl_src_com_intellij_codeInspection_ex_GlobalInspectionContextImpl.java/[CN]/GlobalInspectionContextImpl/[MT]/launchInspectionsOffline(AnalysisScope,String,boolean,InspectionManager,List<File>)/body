{
  cleanup();
  myCurrentScope=scope;
  InspectionTool.setOutputPath(outputPath);
  final boolean oldToolsSettings=RUN_GLOBAL_TOOLS_ONLY;
  RUN_GLOBAL_TOOLS_ONLY=runGlobalToolsOnly;
  try {
    ApplicationManager.getApplication().runReadAction(new Runnable(){
      public void run(){
        performInspectionsWithProgress(scope,manager);
        @NonNls final String ext=".xml";
        final Map<Element,Tools> globalTools=new HashMap<Element,Tools>();
        for (        Map.Entry<String,Tools> stringSetEntry : myTools.entrySet()) {
          final Tools sameTools=stringSetEntry.getValue();
          boolean hasProblems=false;
          String toolName=stringSetEntry.getKey();
          if (sameTools != null) {
            for (            ScopeToolState toolDescr : sameTools.getTools()) {
              final InspectionTool tool=(InspectionTool)toolDescr.getTool();
              if (tool instanceof LocalInspectionToolWrapper) {
                hasProblems=new File(outputPath,toolName + ext).exists();
              }
 else {
                tool.updateContent();
                if (tool.hasReportedProblems()) {
                  final Element root=new Element(InspectionsBundle.message("inspection.problems"));
                  globalTools.put(root,sameTools);
                  LOG.assertTrue(!hasProblems,toolName);
                  break;
                }
              }
            }
          }
          if (!hasProblems)           continue;
          try {
            new File(outputPath).mkdirs();
            final File file=new File(outputPath,toolName + ext);
            inspectionsResults.add(file);
            FileUtil.writeToFile(file,("</" + InspectionsBundle.message("inspection.problems") + ">").getBytes("UTF-8"),true);
          }
 catch (          IOException e) {
            LOG.error(e);
          }
        }
        getRefManager().iterate(new RefVisitor(){
          @Override public void visitElement(          final RefEntity refEntity){
            for (            Element element : globalTools.keySet()) {
              final Tools tools=globalTools.get(element);
              for (              ScopeToolState state : tools.getTools()) {
                ((InspectionTool)state.getTool()).exportResults(element,refEntity);
              }
            }
          }
        }
);
        for (        Element element : globalTools.keySet()) {
          final String toolName=globalTools.get(element).getShortName();
          element.setAttribute(LOCAL_TOOL_ATTRIBUTE,Boolean.toString(false));
          final Document doc=new Document(element);
          PathMacroManager.getInstance(getProject()).collapsePaths(doc.getRootElement());
          try {
            new File(outputPath).mkdirs();
            final File file=new File(outputPath,toolName + ext);
            inspectionsResults.add(file);
            JDOMUtil.writeDocument(doc,file,"\n");
          }
 catch (          IOException e) {
            LOG.error(e);
          }
        }
      }
    }
);
  }
  finally {
    InspectionTool.setOutputPath(null);
    RUN_GLOBAL_TOOLS_ONLY=oldToolsSettings;
  }
}
