{
  final List<Tools> globalTools=new ArrayList<Tools>();
  final List<Tools> localTools=new ArrayList<Tools>();
  final List<Tools> globalSimpleTools=new ArrayList<Tools>();
  initializeTools(globalTools,localTools,globalSimpleTools);
  final List<InspectionProfileEntry> needRepeatSearchRequest=new ArrayList<InspectionProfileEntry>();
  ((RefManagerImpl)getRefManager()).initializeAnnotators();
  for (  Tools tools : globalTools) {
    for (    ScopeToolState state : tools.getTools()) {
      final InspectionTool tool=(InspectionTool)state.getTool();
      try {
        if (tool.isGraphNeeded()) {
          ((RefManagerImpl)getRefManager()).findAllDeclarations();
        }
        tool.runInspection(scope,manager);
        if (tool.queryExternalUsagesRequests(manager)) {
          needRepeatSearchRequest.add(tool);
        }
      }
 catch (      ProcessCanceledException e) {
        throw e;
      }
catch (      IndexNotReadyException e) {
        throw e;
      }
catch (      Exception e) {
        LOG.error(e);
      }
    }
  }
  for (  GlobalInspectionContextExtension extension : myExtensions.values()) {
    try {
      extension.performPostRunActivities(needRepeatSearchRequest,this);
    }
 catch (    ProcessCanceledException e) {
      throw e;
    }
catch (    IndexNotReadyException e) {
      throw e;
    }
catch (    Exception e) {
      LOG.error(e);
    }
  }
  if (RUN_GLOBAL_TOOLS_ONLY)   return;
  final PsiManager psiManager=PsiManager.getInstance(myProject);
  final Set<VirtualFile> localScopeFiles=scope.toSearchScope() instanceof LocalSearchScope ? new THashSet<VirtualFile>() : null;
  for (  Tools tools : globalSimpleTools) {
    GlobalInspectionToolWrapper toolWrapper=(GlobalInspectionToolWrapper)tools.getTool();
    GlobalSimpleInspectionTool tool=(GlobalSimpleInspectionTool)toolWrapper.getTool();
    tool.inspectionStarted(manager,this,toolWrapper);
  }
  final Map<String,DescriptorProviderInspection> map=getInspectionWrappersMap(localTools);
  scope.accept(new PsiElementVisitor(){
    @Override public void visitFile(    final PsiFile file){
      final VirtualFile virtualFile=file.getVirtualFile();
      if (virtualFile != null) {
        incrementJobDoneAmount(LOCAL_ANALYSIS,ProjectUtil.calcRelativeToProjectPath(virtualFile,myProject));
        if (SingleRootFileViewProvider.isTooLarge(virtualFile))         return;
        if (localScopeFiles != null && !localScopeFiles.add(virtualFile))         return;
      }
      final FileViewProvider viewProvider=psiManager.findViewProvider(virtualFile);
      final com.intellij.openapi.editor.Document document=viewProvider == null ? null : viewProvider.getDocument();
      if (document == null || virtualFile.getFileType().isBinary())       return;
      final LocalInspectionsPass pass=new LocalInspectionsPass(file,document,0,file.getTextLength(),LocalInspectionsPass.EMPTY_PRIORITY_RANGE,true);
      try {
        final List<LocalInspectionToolWrapper> lTools=new ArrayList<LocalInspectionToolWrapper>();
        for (        Tools tool : localTools) {
          final LocalInspectionToolWrapper enabledTool=(LocalInspectionToolWrapper)tool.getEnabledTool(file);
          if (enabledTool != null) {
            lTools.add(enabledTool);
          }
        }
        pass.doInspectInBatch((InspectionManagerEx)manager,lTools);
        JobUtil.invokeConcurrentlyUnderProgress(globalSimpleTools,myProgressIndicator,false,new Processor<Tools>(){
          @Override public boolean process(          Tools tools){
            GlobalInspectionToolWrapper toolWrapper=(GlobalInspectionToolWrapper)tools.getTool();
            GlobalSimpleInspectionTool tool=(GlobalSimpleInspectionTool)toolWrapper.getTool();
            ProblemsHolder problemsHolder=new ProblemsHolder(manager,file,false);
            GlobalInspectionToolWrapper problemDescriptionProcessor=getProblemDescriptionProcessor(toolWrapper,map);
            tool.checkFile(file,manager,problemsHolder,GlobalInspectionContextImpl.this,problemDescriptionProcessor);
            LocalInspectionToolWrapper.addProblemDescriptors(problemsHolder.getResults(),false,GlobalInspectionContextImpl.this,null,CONVERT,toolWrapper);
            return true;
          }
        }
);
      }
 catch (      ProcessCanceledException e) {
        throw e;
      }
catch (      IndexNotReadyException e) {
        throw e;
      }
catch (      Exception e) {
        LOG.error("In file: " + file,e);
      }
catch (      AssertionError e) {
        LOG.error("In file: " + file,e);
      }
 finally {
        InjectedLanguageManager.getInstance(myProject).dropFileCaches(file);
      }
    }
  }
);
  for (  Tools tools : globalSimpleTools) {
    GlobalInspectionToolWrapper toolWrapper=(GlobalInspectionToolWrapper)tools.getTool();
    GlobalSimpleInspectionTool tool=(GlobalSimpleInspectionTool)toolWrapper.getTool();
    GlobalInspectionToolWrapper problemDescriptionProcessor=getProblemDescriptionProcessor(toolWrapper,map);
    tool.inspectionFinished(manager,this,problemDescriptionProcessor);
  }
}
