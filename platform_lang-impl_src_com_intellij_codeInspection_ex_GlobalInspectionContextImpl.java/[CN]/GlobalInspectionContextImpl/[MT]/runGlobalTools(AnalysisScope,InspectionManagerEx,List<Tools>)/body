{
  final List<InspectionToolWrapper> needRepeatSearchRequest=new ArrayList<InspectionToolWrapper>();
  final boolean surelyNoExternalUsages=scope.getScopeType() == AnalysisScope.PROJECT;
  for (  Tools tools : globalTools) {
    for (    ScopeToolState state : tools.getTools()) {
      InspectionToolWrapper toolWrapper=state.getTool();
      GlobalInspectionTool tool=(GlobalInspectionTool)toolWrapper.getTool();
      InspectionToolPresentation toolPresentation=getPresentation(toolWrapper);
      try {
        if (tool.isGraphNeeded()) {
          try {
            ((RefManagerImpl)getRefManager()).findAllDeclarations();
          }
 catch (          Throwable e) {
            getStdJobDescriptors().BUILD_GRAPH.setDoneAmount(0);
            throw e;
          }
        }
        tool.runInspection(scope,inspectionManager,this,toolPresentation);
        if (!surelyNoExternalUsages && tool.queryExternalUsagesRequests(inspectionManager,this,toolPresentation)) {
          needRepeatSearchRequest.add(toolWrapper);
        }
      }
 catch (      ProcessCanceledException e) {
        throw e;
      }
catch (      IndexNotReadyException e) {
        throw e;
      }
catch (      Throwable e) {
        LOG.error(e);
      }
    }
  }
  for (  GlobalInspectionContextExtension extension : myExtensions.values()) {
    try {
      extension.performPostRunActivities(needRepeatSearchRequest,this);
    }
 catch (    ProcessCanceledException e) {
      throw e;
    }
catch (    IndexNotReadyException e) {
      throw e;
    }
catch (    Throwable e) {
      LOG.error(e);
    }
  }
}
