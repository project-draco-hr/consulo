{
  final PsiManager psiManager=PsiManager.getInstance(myProject);
  myProgressIndicator=ApplicationManager.getApplication().isUnitTestMode() ? new EmptyProgressIndicator() : ProgressManager.getInstance().getProgressIndicator();
  RefManagerImpl refManager=(RefManagerImpl)getRefManager();
  try {
    psiManager.startBatchFilesProcessingMode();
    refManager.inspectionReadActionStarted();
    BUILD_GRAPH.setTotalAmount(scope.getFileCount());
    LOCAL_ANALYSIS.setTotalAmount(scope.getFileCount());
    FIND_EXTERNAL_USAGES.setTotalAmount(0);
    ((ProgressManagerImpl)ProgressManager.getInstance()).executeProcessUnderProgress(new Runnable(){
      public void run(){
        runTools(scope,manager);
      }
    }
,ProgressWrapper.wrap(myProgressIndicator));
  }
 catch (  ProcessCanceledException e) {
    cleanup((InspectionManagerEx)manager);
    throw e;
  }
catch (  IndexNotReadyException e) {
    cleanup((InspectionManagerEx)manager);
    DumbService.getInstance(myProject).showDumbModeNotification("Usage search is not available until indices are ready");
    throw new ProcessCanceledException();
  }
catch (  Exception e) {
    LOG.error(e);
  }
 finally {
    refManager.inspectionReadActionFinished();
    psiManager.finishBatchFilesProcessingMode();
  }
}
