{
  final Project project=(Project)dataContext.getData(DataConstants.PROJECT);
  if (project == null)   return null;
  final Editor editor=(Editor)dataContext.getData(DataConstants.EDITOR);
  if (editor != null) {
    final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return null;
    final int offset=editor.getCaretModel().getOffset();
    PsiElement element=file.findElementAt(offset);
    while (element != null) {
      if (element instanceof PsiFile) {
        if (!(element instanceof PsiJavaFile))         return null;
        if (element instanceof PsiAspectFile) {
          final PsiAspect[] aspects=((PsiAspectFile)element).getAspects();
          return aspects.length == 1 ? aspects[0] : null;
        }
        final PsiClass[] classes=((PsiJavaFile)element).getClasses();
        return classes.length == 1 ? classes[0] : null;
      }
      if (element instanceof PsiClass && !(element instanceof PsiAnonymousClass)) {
        return (PsiClass)element;
      }
      element=element.getParent();
    }
    return null;
  }
 else {
    final PsiElement element=(PsiElement)dataContext.getData(DataConstants.PSI_ELEMENT);
    return element instanceof PsiClass ? (PsiClass)element : null;
  }
}
