{
  final Project project=DataKeys.PROJECT.getData(dataContext);
  if (project == null)   return null;
  final Editor editor=DataKeys.EDITOR.getData(dataContext);
  if (editor != null) {
    final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
    if (file == null)     return null;
    final int offset=editor.getCaretModel().getOffset();
    PsiElement element=file.findElementAt(offset);
    while (element != null) {
      if (element instanceof PsiFile) {
        if (!(element instanceof PsiJavaFile))         return null;
        final PsiClass[] classes=((PsiJavaFile)element).getClasses();
        return classes.length == 1 ? classes[0] : null;
      }
      if (element instanceof PsiClass && !(element instanceof PsiAnonymousClass)) {
        return (PsiClass)element;
      }
      element=element.getParent();
    }
    return null;
  }
 else {
    final PsiElement element=DataKeys.PSI_ELEMENT.getData(dataContext);
    return element instanceof PsiClass ? (PsiClass)element : null;
  }
}
