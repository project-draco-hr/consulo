{
  return new PerformAction(){
    @Override public void performAction(    VirtualFile rootDir,    VirtualFile rootAfter) throws Exception {
      final VirtualFile libFile=rootDir.findChild("library.table.xml");
      assertNotNull(rootDir.getPath(),libFile);
      final ExpandMacroToPathMap macros=new ExpandMacroToPathMap();
      macros.addMacroExpand("DIR",rootDir.getPath());
      final Document oldTable=JDOMUtil.loadDocument(VfsUtilCore.loadText(libFile));
      macros.substitute(oldTable.getRootElement(),true);
      Convertor34.convertLibraryTable34(oldTable.getRootElement(),libFile.getPath());
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        @Override public void run(){
          LocalFileSystem.getInstance().refresh(false);
        }
      }
);
      final Document newTable=loadDocument(rootDir,"applicationLibraries.xml");
      final Document goldenNewTable=loadDocument(rootAfter,"applicationLibraries.xml");
      macros.substitute(goldenNewTable.getRootElement(),true);
      assertElementsEqual(goldenNewTable.getRootElement(),newTable.getRootElement());
    }
  }
;
}
