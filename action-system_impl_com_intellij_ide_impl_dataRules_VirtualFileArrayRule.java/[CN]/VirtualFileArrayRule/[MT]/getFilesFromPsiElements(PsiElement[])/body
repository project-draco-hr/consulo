{
  HashSet<VirtualFile> files=new HashSet<VirtualFile>();
  for (int i=0; i < psiElements.length; i++) {
    PsiElement elem=psiElements[i];
    if (elem instanceof PsiDirectory) {
      files.add(((PsiDirectory)elem).getVirtualFile());
    }
 else     if (elem instanceof PsiFile) {
      VirtualFile virtualFile=((PsiFile)elem).getVirtualFile();
      if (virtualFile != null) {
        files.add(virtualFile);
      }
    }
 else     if (elem instanceof PsiPackage) {
      PsiDirectory[] dirs=((PsiPackage)elem).getDirectories();
      for (int j=0; j < dirs.length; j++) {
        files.add(dirs[j].getVirtualFile());
      }
    }
 else {
      PsiFile file=elem.getContainingFile();
      if (file != null) {
        VirtualFile virtualFile=file.getVirtualFile();
        if (virtualFile != null) {
          files.add(virtualFile);
        }
      }
    }
  }
  VirtualFile[] result=files.toArray(new VirtualFile[files.size()]);
  files.clear();
  return result;
}
