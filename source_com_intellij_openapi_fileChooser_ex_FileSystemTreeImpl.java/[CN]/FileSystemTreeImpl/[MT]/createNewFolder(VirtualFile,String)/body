{
  final Exception[] failReason=new Exception[]{null};
  CommandProcessor.getInstance().executeCommand(myProject,new Runnable(){
    public void run(){
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          try {
            VirtualFile parent=parentDirectory;
            for (            String name : StringUtil.tokenize(newFolderName,"\\/")) {
              VirtualFile folder=parent.createChildDirectory(this,name);
              updateTree();
              FileElement folderDesc=new FileElement(folder,folder.getName());
              myTreeBuilder.buildNodeForElement(folderDesc);
              DefaultMutableTreeNode folderNode=myTreeBuilder.getNodeForElement(folderDesc);
              if (folderNode != null) {
                TreePath treePath=new TreePath(folderNode.getPath());
                myTree.setSelectionPath(treePath);
                myTree.scrollPathToVisible(treePath);
                myTree.expandPath(treePath);
              }
              parent=folder;
            }
          }
 catch (          IOException e) {
            failReason[0]=e;
          }
        }
      }
);
    }
  }
,UIBundle.message("file.chooser.create.new.folder.command.name"),null);
  return failReason[0];
}
