{
  final Editor editor=context.getEditor();
  final Document document=editor.getDocument();
  PsiElement element=findNextToken(context);
  final boolean hasParams=placeCaretInsideParentheses(context,item);
  final char completionChar=context.getCompletionChar();
  if (completionChar == '(') {
    context.setAddCompletionChar(false);
  }
  if (isToken(element,"(")) {
    int lparenthOffset=element.getTextRange().getStartOffset();
    if (mySpaceBeforeParentheses && lparenthOffset == context.getTailOffset()) {
      document.insertString(context.getTailOffset()," ");
      lparenthOffset++;
    }
    if (completionChar == '(' || completionChar == '\t') {
      editor.getCaretModel().moveToOffset(lparenthOffset + 1);
    }
 else {
      editor.getCaretModel().moveToOffset(context.getTailOffset());
    }
    context.setTailOffset(lparenthOffset + 1);
    PsiElement list=element.getParent();
    PsiElement last=list.getLastChild();
    if (isToken(last,")")) {
      int rparenthOffset=last.getTextRange().getStartOffset();
      context.setTailOffset(rparenthOffset + 1);
      if (!hasParams) {
        for (int i=lparenthOffset + 1; i < rparenthOffset; i++) {
          if (!Character.isWhitespace(document.getCharsSequence().charAt(i))) {
            return;
          }
        }
        editor.getCaretModel().moveToOffset(context.getTailOffset());
      }
 else       if (mySpaceBetweenParentheses && document.getCharsSequence().charAt(lparenthOffset) == ' ') {
        editor.getCaretModel().moveToOffset(lparenthOffset + 2);
      }
 else {
        editor.getCaretModel().moveToOffset(lparenthOffset + 1);
      }
      return;
    }
  }
 else {
    int tailOffset=context.getTailOffset();
    if (mySpaceBeforeParentheses) {
      tailOffset=TailType.insertChar(editor,tailOffset,' ');
    }
    tailOffset=TailType.insertChar(editor,tailOffset,'(');
    if (mySpaceBetweenParentheses) {
      tailOffset=TailType.insertChar(editor,tailOffset,' ');
    }
  }
  if (!myInsertRightParenthesis)   return;
  int tailOffset=context.getTailOffset();
  int caret=tailOffset;
  if (mySpaceBetweenParentheses) {
    tailOffset=TailType.insertChar(editor,tailOffset,' ');
  }
  document.insertString(tailOffset,")");
  editor.getCaretModel().moveToOffset(hasParams ? caret : context.getTailOffset());
}
