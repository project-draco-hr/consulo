{
  final PsiElement[] elements=getSelectedPSIElements();
  if (elements.length == 1) {
    final PsiElement element=elements[0];
    if (element instanceof PsiDirectory) {
      return new PsiDirectory[]{(PsiDirectory)element};
    }
 else     if (element instanceof PsiDirectoryContainer) {
      return ((PsiDirectoryContainer)element).getDirectories();
    }
 else {
      final PsiFile containingFile=element.getContainingFile();
      if (containingFile != null) {
        final PsiDirectory psiDirectory=containingFile.getContainingDirectory();
        if (psiDirectory != null) {
          return new PsiDirectory[]{psiDirectory};
        }
        final VirtualFile file=containingFile.getVirtualFile();
        if (file instanceof VirtualFileWindow) {
          final VirtualFile delegate=((VirtualFileWindow)file).getDelegate();
          final PsiFile delegatePsiFile=containingFile.getManager().findFile(delegate);
          if (delegatePsiFile != null && delegatePsiFile.getContainingDirectory() != null) {
            return new PsiDirectory[]{delegatePsiFile.getContainingDirectory()};
          }
        }
        return PsiDirectory.EMPTY_ARRAY;
      }
    }
  }
 else {
    final DefaultMutableTreeNode selectedNode=getSelectedNode();
    if (selectedNode != null) {
      return getSelectedDirectoriesInAmbiguousCase(selectedNode);
    }
  }
  return PsiDirectory.EMPTY_ARRAY;
}
