{
  final TemplateImpl template=getTemplate();
  if (template != null) {
    int offset=editor.getCaretModel().getOffset();
    int startOffset=offset;
    if (editor.getSelectionModel().hasSelection()) {
      final int selStart=editor.getSelectionModel().getSelectionStart();
      final int selEnd=editor.getSelectionModel().getSelectionEnd();
      startOffset=(offset == selStart) ? selEnd : selStart;
    }
    PsiElement element=file.findElementAt(startOffset);
    while (element instanceof PsiWhiteSpace) {
      element=element.getPrevSibling();
    }
    PsiStatement psiStatement=PsiTreeUtil.getParentOfType(element,PsiStatement.class,false);
    if (psiStatement != null) {
      startOffset=psiStatement.getTextRange().getStartOffset();
    }
    if (!template.isDeactivated() && (TemplateManagerImpl.isApplicable(file,offset,template) || (TemplateManagerImpl.isApplicable(file,startOffset,template)))) {
      return getIterableExpression(editor,file) != null;
    }
  }
  return false;
}
