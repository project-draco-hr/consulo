{
  if (!editor.getSelectionModel().hasSelection()) {
    editor.getSelectionModel().selectLineAtCaret();
  }
  int startOffset=editor.getSelectionModel().getSelectionStart();
  int endOffset=editor.getSelectionModel().getSelectionEnd();
  PsiDocumentManager.getInstance(project).commitAllDocuments();
  PsiElement element1=file.findElementAt(startOffset);
  PsiElement element2=file.findElementAt(endOffset - 1);
  if (element1 == null || element2 == null)   return;
  Language lang1=getLanguage(element1);
  Language lang2=getLanguage(element2);
  if (element1 instanceof PsiWhiteSpace && isLanguageWithWSSignificant(lang1)) {
    startOffset=element1.getTextRange().getEndOffset();
    element1=file.findElementAt(startOffset);
  }
  if (element2 instanceof PsiWhiteSpace && isLanguageWithWSSignificant(lang2)) {
    endOffset=element2.getTextRange().getStartOffset();
    element2=file.findElementAt(endOffset);
  }
  lang1=getLanguage(element1);
  lang2=getLanguage(element2);
  if (lang1 != lang2)   return;
  final List<SurroundDescriptor> surroundDescriptors=LanguageSurrounders.INSTANCE.allForLanguage(element1.getLanguage());
  if (surroundDescriptors.isEmpty())   return;
  for (  SurroundDescriptor descriptor : surroundDescriptors) {
    final PsiElement[] elements=descriptor.getElementsToSurround(file,startOffset,endOffset);
    if (elements.length > 0) {
      if (surrounder == null) {
        PopupActionChooser popupActionChooser=new PopupActionChooser(CHOOSER_TITLE);
        popupActionChooser.invoke(project,editor,descriptor.getSurrounders(),elements);
        return;
      }
 else {
        doSurround(project,editor,surrounder,elements);
      }
    }
  }
}
