{
  if (myScopeToAverageSeverityMap.isEmpty()) {
    return null;
  }
  final Map<String,HighlightSeverity> result=new HashMap<String,HighlightSeverity>();
  final Map.Entry<String,SeverityAndOccurrences> entry=ContainerUtil.getFirstItem(myScopeToAverageSeverityMap.entrySet());
  result.put(entry.getKey(),entry.getValue().getPrimarySeverity());
  if (myScopeToAverageSeverityMap.size() == 1) {
    return result;
  }
  final SeverityAndOccurrences defaultSeveritiesAndOccurrences=myScopeToAverageSeverityMap.get(myDefaultScopeName);
  if (defaultSeveritiesAndOccurrences == null) {
    for (    Map.Entry<String,SeverityAndOccurrences> e : myScopeToAverageSeverityMap.entrySet()) {
      final HighlightSeverity primarySeverity=e.getValue().getPrimarySeverity();
      if (primarySeverity != null) {
        result.put(e.getKey(),primarySeverity);
      }
    }
    return result;
  }
  final int allInspectionsCount=defaultSeveritiesAndOccurrences.getOccurrencesSize();
  final Map<String,HighlightSeverity> allScopes=defaultSeveritiesAndOccurrences.getOccurrences();
  for (  String currentScope : myScopeToAverageSeverityMap.keySet()) {
    final SeverityAndOccurrences currentSeverityAndOccurrences=myScopeToAverageSeverityMap.get(currentScope);
    if (currentSeverityAndOccurrences == null) {
      continue;
    }
    final HighlightSeverity currentSeverity=currentSeverityAndOccurrences.getPrimarySeverity();
    if (currentSeverity == ScopesAndSeveritiesTable.MIXED_FAKE_SEVERITY || currentSeverityAndOccurrences.getOccurrencesSize() == allInspectionsCount || myDefaultScopeName.equals(currentScope)) {
      result.put(currentScope,currentSeverity);
    }
 else {
      Set<String> toolsToCheck=ContainerUtil.newHashSet(allScopes.keySet());
      toolsToCheck.removeAll(currentSeverityAndOccurrences.getOccurrences().keySet());
      boolean doContinue=false;
      final Map<String,HighlightSeverity> lowerScopeOccurrences=myScopeToAverageSeverityMap.get(myDefaultScopeName).getOccurrences();
      for (      String toolName : toolsToCheck) {
        final HighlightSeverity currentToolSeverity=lowerScopeOccurrences.get(toolName);
        if (currentToolSeverity != null) {
          if (!currentSeverity.equals(currentToolSeverity)) {
            result.put(currentScope,ScopesAndSeveritiesTable.MIXED_FAKE_SEVERITY);
            doContinue=true;
            break;
          }
        }
      }
      if (doContinue) {
        continue;
      }
      result.put(currentScope,currentSeverity);
    }
  }
  return result;
}
