{
  final FilePathImpl filePath=new FilePathImpl(file);
  final GitRepositoryLocation l=(GitRepositoryLocation)getLocationFor(filePath);
  final VirtualFile root=LocalFileSystem.getInstance().findFileByIoFile(l.getRoot());
  if (root == null) {
    throw new VcsException("The repository does not exists anymore: " + l.getRoot());
  }
  final CommittedChangeList[] result=new CommittedChangeList[1];
  GitUtil.getLocalCommittedChanges(myProject,root,new Consumer<GitSimpleHandler>(){
    public void consume(    final GitSimpleHandler h){
      h.addParameters("-n1");
      h.addParameters("-M");
      h.addParameters(number.asString());
    }
  }
,new Consumer<CommittedChangeList>(){
    @Override public void consume(    final CommittedChangeList committedChangeList){
      result[0]=committedChangeList;
    }
  }
,false);
  final Collection<Change> changes=result[0].getChanges();
  if (changes.size() == 1) {
    return new Pair<CommittedChangeList,FilePath>(result[0],changes.iterator().next().getAfterRevision().getFile());
  }
  for (  Change change : changes) {
    if (change.getAfterRevision() != null && filePath.getIOFile().equals(change.getAfterRevision().getFile().getIOFile())) {
      return new Pair<CommittedChangeList,FilePath>(result[0],filePath);
    }
  }
  final List<VcsFileRevision> history=GitHistoryUtils.history(myProject,filePath,root,number.asString() + "^..");
  return new Pair<CommittedChangeList,FilePath>(result[0],((GitFileRevision)history.get(history.size() - 1)).getPath());
}
