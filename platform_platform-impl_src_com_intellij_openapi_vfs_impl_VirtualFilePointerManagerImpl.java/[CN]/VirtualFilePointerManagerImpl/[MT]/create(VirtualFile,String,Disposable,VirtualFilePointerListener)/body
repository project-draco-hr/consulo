{
  if (file != null && file.getFileSystem() != LocalFileSystem.getInstance() && file.getFileSystem() != JarFileSystem.getInstance()) {
    return new IdentityVirtualFilePointer(file);
  }
  String protocol=VirtualFileManager.extractProtocol(url);
  VirtualFileSystem fileSystem=myVirtualFileManager.getFileSystem(protocol);
  if (fileSystem == null) {
    return new NullVirtualFilePointer(url);
  }
  if (fileSystem != LocalFileSystem.getInstance() && fileSystem != JarFileSystem.getInstance()) {
    VirtualFile found=VirtualFileManager.getInstance().findFileByUrl(url);
    return found == null ? new NullVirtualFilePointer(url) : new IdentityVirtualFilePointer(found);
  }
  String path;
  if (file == null) {
    path=VirtualFileManager.extractPath(url);
    path=cleanupPath(path,protocol);
    url=VirtualFileManager.constructUrl(protocol,path);
  }
 else {
    path=file.getPath();
  }
  VirtualFilePointerImpl pointer=getOrCreate(file,url,parentDisposable,listener,path);
  int newCount=pointer.incrementUsageCount();
  if (newCount == 1) {
    Disposer.register(parentDisposable,pointer);
  }
 else {
    register(parentDisposable,pointer);
  }
  return pointer;
}
