{
  incModificationCounter();
  for (  FilePointerPartNode node : myPointersToUpdateUrl) {
synchronized (this) {
      VirtualFilePointerImpl pointer=node.leaf;
      String urlBefore=pointer.getUrlNoUpdate();
      Pair<VirtualFile,String> after=node.update();
      String urlAfter=after.second;
      if (URL_COMPARATOR.compare(urlBefore,urlAfter) != 0) {
        FilePointerPartNode root=myPointers.get(pointer.getListener());
        int useCount=node.useCount;
        node.remove();
        FilePointerPartNode newNode=root.findPointerOrCreate(VfsUtilCore.urlToPath(urlAfter),0,after);
        VirtualFilePointerImpl existingPointer=newNode.leaf;
        if (existingPointer != null) {
          pointer.myNode=newNode;
        }
 else {
          newNode.associate(pointer,after);
        }
        newNode.incrementUsageCount(useCount);
      }
    }
  }
  VirtualFilePointer[] pointersToFireArray=toPointers(myPointersToFire);
  for (  VirtualFilePointer pointer : pointersToFireArray) {
    ((VirtualFilePointerImpl)pointer).myNode.update();
  }
  for (  EventDescriptor event : myEvents) {
    event.fireAfter();
  }
  if (pointersToFireArray.length != 0) {
    myBus.syncPublisher(VirtualFilePointerListener.TOPIC).validityChanged(pointersToFireArray);
  }
  myPointersToUpdateUrl=null;
  myEvents=null;
  myPointersToFire=null;
  for (  FilePointerPartNode root : myPointers.values()) {
    root.checkStructure();
  }
}
