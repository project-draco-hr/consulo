{
  String urlToParse;
  if (url.startsWith("jar:file://")) {
    urlToParse=url.substring("jar:".length());
  }
 else {
    urlToParse=url;
  }
  Matcher matcher=URI_PATTERN.matcher(urlToParse);
  if (!matcher.matches()) {
    LOG.warn("Cannot parse url " + url);
    return null;
  }
  String scheme=matcher.group(1);
  if (urlToParse != url) {
    scheme="jar:" + scheme;
  }
  String authority=StringUtil.nullize(matcher.group(2));
  String path=StringUtil.nullize(matcher.group(3));
  if (path != null) {
    path=FileUtil.toCanonicalUriPath(path);
  }
  String parameters=matcher.group(4);
  if (authority != null && StandardFileSystems.FILE_PROTOCOL.equals(scheme)) {
    path=path == null ? authority : (authority + path);
    authority=null;
  }
  return new UrlImpl(urlAsRaw ? url : null,scheme,authority,path,parameters);
}
