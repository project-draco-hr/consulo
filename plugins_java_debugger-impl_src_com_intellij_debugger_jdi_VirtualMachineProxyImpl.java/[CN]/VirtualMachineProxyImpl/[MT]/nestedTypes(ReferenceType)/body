{
  List<ReferenceType> nestedTypes=myNestedClassesCache.get(refType);
  if (nestedTypes == null) {
    final List<ReferenceType> list=refType.nestedTypes();
    final int size=list.size();
    if (size > 0) {
      final Set<ReferenceType> candidates=new HashSet<ReferenceType>();
      final ClassLoaderReference outerLoader=refType.classLoader();
      for (      ReferenceType nested : list) {
        try {
          if (outerLoader == null ? nested.classLoader() == null : outerLoader.equals(nested.classLoader())) {
            candidates.add(nested);
          }
        }
 catch (        ObjectCollectedException ignored) {
        }
      }
      if (!candidates.isEmpty()) {
        final Set<ReferenceType> nested2=new HashSet<ReferenceType>();
        for (        final ReferenceType candidate : candidates) {
          nested2.addAll(nestedTypes(candidate));
        }
        candidates.removeAll(nested2);
      }
      nestedTypes=candidates.isEmpty() ? Collections.<ReferenceType>emptyList() : new ArrayList<ReferenceType>(candidates);
    }
 else {
      nestedTypes=Collections.emptyList();
    }
    myNestedClassesCache.put(refType,nestedTypes);
  }
  return nestedTypes;
}
