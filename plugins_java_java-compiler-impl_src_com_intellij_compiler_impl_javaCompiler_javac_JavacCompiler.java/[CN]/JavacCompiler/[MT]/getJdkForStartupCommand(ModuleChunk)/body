{
  final Sdk jdk=JavaSdkUtil.getSdkForCompilation(chunk);
  if (ApplicationManager.getApplication().isUnitTestMode() && JavacCompilerConfiguration.getInstance(myProject).isTestsUseExternalCompiler()) {
    final String jdkHomePath=getTestsExternalCompilerHome();
    if (jdkHomePath == null) {
      throw new IllegalArgumentException("[TEST-MODE] Cannot determine home directory for JDK to use javac from");
    }
    return new MockJdkWrapper(jdkHomePath,jdk);
  }
  return jdk;
}
