{
  final BaseListPopupStep<VirtualFile> step=new BaseListPopupStep<VirtualFile>("File Path",files,icons){
    @NotNull @Override public String getTextFor(    final VirtualFile value){
      return value.getPresentableName();
    }
    @Override public PopupStep onChosen(    final VirtualFile selectedValue,    final boolean finalChoice){
      final Ref<File> open=new Ref<File>();
      final Ref<File> toSelect=new Ref<File>();
      final File selectedIoFile=new File(getPresentableUrl(selectedValue));
      if (files.indexOf(selectedValue) == 0 && files.size() > 1) {
        open.set(new File(getPresentableUrl(files.get(1))));
        toSelect.set(selectedIoFile);
      }
 else {
        open.set(selectedIoFile);
      }
      ApplicationManager.getApplication().executeOnPooledThread(new Runnable(){
        public void run(){
          if (!open.get().exists())           return;
          open(open.get(),toSelect.get());
        }
      }
);
      return FINAL_CHOICE;
    }
  }
;
  return JBPopupFactory.getInstance().createListPopup(step);
}
