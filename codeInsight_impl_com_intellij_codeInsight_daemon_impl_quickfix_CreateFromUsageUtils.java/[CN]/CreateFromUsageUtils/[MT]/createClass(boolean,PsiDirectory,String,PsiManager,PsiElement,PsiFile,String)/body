{
  final PsiElementFactory factory=manager.getElementFactory();
  return ApplicationManager.getApplication().runWriteAction(new Computable<PsiClass>(){
    public PsiClass compute(){
      try {
        PsiClass targetClass;
        if (!ApplicationManager.getApplication().isUnitTestMode()) {
          try {
            if (createInterface) {
              targetClass=directory.createInterface(name);
            }
 else {
              targetClass=directory.createClass(name);
            }
          }
 catch (          final IncorrectOperationException e) {
            ApplicationManager.getApplication().invokeLater(new Runnable(){
              public void run(){
                Messages.showErrorDialog(QuickFixBundle.message("cannot.create.java.file.error.text",name,directory.getVirtualFile().getName(),e.getLocalizedMessage()),QuickFixBundle.message("cannot.create.java.file.error.title"));
              }
            }
);
            return null;
          }
          if (!manager.getResolveHelper().isAccessible(targetClass,contextElement,null)) {
            targetClass.getModifierList().setModifierProperty(PsiKeyword.PUBLIC,true);
          }
        }
 else {
          PsiClass aClass;
          if (createInterface) {
            aClass=factory.createInterface(name);
          }
 else {
            aClass=factory.createClass(name);
            aClass=(PsiClass)CodeStyleManager.getInstance(manager).reformat(aClass);
          }
          targetClass=(PsiClass)sourceFile.add(aClass);
        }
        if (superClassName != null) {
          PsiJavaCodeReferenceElement superClass=factory.createReferenceElementByFQClassName(superClassName,targetClass.getResolveScope());
          targetClass.getExtendsList().add(superClass);
        }
        return targetClass;
      }
 catch (      IncorrectOperationException e) {
        LOG.error(e);
        return null;
      }
    }
  }
);
}
