{
  if (myStorageData.myStates == null)   myStorageData.myStates=new HashMap<String,Map<IFile,Element>>();
  try {
    final Element element=DefaultStateSerializer.serializeState(state,storageSpec);
    if (myPathMacroSubstitutor != null) {
      myPathMacroSubstitutor.collapsePaths(element);
    }
    final List<Pair<Element,String>> states=mySplitter.splitState(element);
    Map<IFile,Element> stateMap=myStorageData.myStates.get(componentName);
    if (stateMap == null) {
      stateMap=new HashMap<IFile,Element>();
      myStorageData.myStates.put(componentName,stateMap);
    }
    for (    Pair<Element,String> pair : states) {
      Element e=pair.first;
      String name=pair.second;
      Element statePart=new Element("component");
      statePart.setAttribute("name",componentName);
      e.detach();
      statePart.addContent(e);
      stateMap.put(myDir.getChild(name),statePart);
    }
  }
 catch (  WriteExternalException e) {
    throw new StateStorageException(e);
  }
}
