{
  if (reference instanceof PsiMultiReference) {
    final PsiReference[] references=getReferences((PsiMultiReference)reference);
    if (LegacyCompletionContributor.DEBUG) {
      System.out.println("CompletionData.completeReference");
    }
    for (    PsiReference ref : references) {
      if (LegacyCompletionContributor.DEBUG) {
        System.out.println("ref = " + ref);
      }
      completeReference(ref,position,set,tailType,matcher,file,filter,variant);
    }
  }
 else {
    final Object[] completions=reference.getVariants();
    if (completions == null)     return;
    for (    Object completion : completions) {
      if (completion == null) {
        LOG.assertTrue(false,"Position=" + position + "\n;Reference="+ reference+ "\n;variants="+ Arrays.toString(completions));
      }
      if (completion instanceof PsiElement) {
        final PsiElement psiElement=(PsiElement)completion;
        if (filter.isClassAcceptable(psiElement.getClass()) && filter.isAcceptable(psiElement,position)) {
          addLookupItem(set,tailType,completion,matcher,file,variant);
        }
      }
 else {
        if (completion instanceof LookupItem) {
          final Object o=((LookupItem)completion).getObject();
          if (o instanceof PsiElement) {
            if (!filter.isClassAcceptable(o.getClass()) || !filter.isAcceptable(o,position))             continue;
          }
        }
        addLookupItem(set,tailType,completion,matcher,file,variant);
      }
    }
  }
}
