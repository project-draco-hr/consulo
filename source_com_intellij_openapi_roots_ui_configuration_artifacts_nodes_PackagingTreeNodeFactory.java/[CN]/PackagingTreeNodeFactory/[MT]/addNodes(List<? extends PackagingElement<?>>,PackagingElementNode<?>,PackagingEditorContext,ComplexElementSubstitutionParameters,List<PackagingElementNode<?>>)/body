{
  for (  PackagingElement<?> element : elements) {
    final PackagingElementNode<?> prev=findEqual(nodes,element);
    if (prev != null) {
      prev.addElement(element);
      continue;
    }
    if (element instanceof ArtifactRootElement) {
      throw new AssertionError("artifact root not expected here");
    }
 else     if (element instanceof CompositePackagingElement) {
      nodes.add(new CompositePackagingElementNode((CompositePackagingElement<?>)element,context,parent,substitutionParameters));
    }
 else     if (element instanceof ComplexPackagingElement) {
      final ComplexPackagingElement<?> complexElement=(ComplexPackagingElement<?>)element;
      if (substitutionParameters.shouldSubstitute(complexElement)) {
        final List<? extends PackagingElement<?>> substitution=complexElement.getSubstitution(context);
        if (substitution != null) {
          addNodes(substitution,parent,context,substitutionParameters,nodes);
          continue;
        }
      }
      nodes.add(new ComplexPackagingElementNode(complexElement,context,parent,substitutionParameters));
    }
 else {
      nodes.add(new PackagingElementNode<PackagingElement<?>>(element,context,parent));
    }
  }
}
