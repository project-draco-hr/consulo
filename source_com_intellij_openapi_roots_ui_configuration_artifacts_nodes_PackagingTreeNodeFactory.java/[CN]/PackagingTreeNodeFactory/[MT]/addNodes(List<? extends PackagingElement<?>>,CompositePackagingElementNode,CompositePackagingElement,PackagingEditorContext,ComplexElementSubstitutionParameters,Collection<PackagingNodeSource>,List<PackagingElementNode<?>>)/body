{
  for (  PackagingElement<?> element : elements) {
    final PackagingElementNode<?> prev=findEqual(nodes,element);
    if (prev != null) {
      prev.addElement(element,parentElement,nodeSources);
      continue;
    }
    if (element instanceof ArtifactRootElement) {
      throw new AssertionError("artifact root not expected here");
    }
 else     if (element instanceof CompositePackagingElement) {
      nodes.add(new CompositePackagingElementNode((CompositePackagingElement<?>)element,context,parentNode,parentElement,substitutionParameters,nodeSources));
    }
 else     if (element instanceof ComplexPackagingElement) {
      final ComplexPackagingElement<?> complexElement=(ComplexPackagingElement<?>)element;
      if (substitutionParameters.shouldSubstitute(complexElement)) {
        final List<? extends PackagingElement<?>> substitution=complexElement.getSubstitution(context);
        if (substitution != null) {
          final PackagingNodeSource source=new PackagingNodeSource(complexElement,parentNode,parentElement,nodeSources);
          addNodes(substitution,parentNode,parentElement,context,substitutionParameters,Collections.singletonList(source),nodes);
          continue;
        }
      }
      nodes.add(new ComplexPackagingElementNode(complexElement,context,parentNode,parentElement,substitutionParameters,nodeSources));
    }
 else {
      nodes.add(new PackagingElementNode<PackagingElement<?>>(element,context,parentNode,parentElement,nodeSources));
    }
  }
}
