{
  if (TargetElementUtil.inVirtualSpace(editor,offset)) {
    return false;
  }
  final PsiReference reference=TargetElementUtil.findReference(editor,offset);
  if (elements == null || elements.length == 0) {
    final Collection<PsiElement> candidates=suggestCandidates(reference);
    elements=PsiUtilCore.toPsiElementArray(candidates);
  }
  if (elements.length == 1) {
    PsiElement element=elements[0];
    LOG.assertTrue(element != null);
    processor.execute(element);
    return true;
  }
  if (elements.length > 1) {
    String title;
    if (reference == null) {
      title=titlePattern;
    }
 else {
      final TextRange range=reference.getRangeInElement();
      final String elementText=reference.getElement().getText();
      LOG.assertTrue(range.getStartOffset() >= 0 && range.getEndOffset() <= elementText.length(),Arrays.toString(elements) + ";" + reference);
      final String refText=range.substring(elementText);
      title=MessageFormat.format(titlePattern,refText);
    }
    if (renderer == null) {
      renderer=new DefaultPsiElementCellRenderer();
    }
    NavigationUtil.getPsiElementPopup(elements,renderer,title,processor).showInBestPositionFor(editor);
    return true;
  }
  return false;
}
