{
  if (TargetElementUtilBase.inVirtualSpace(editor,offset)) {
    return false;
  }
  final PsiReference reference=TargetElementUtilBase.findReference(editor,offset);
  if (elements == null || elements.length == 0) {
    final Collection<PsiElement> candidates=suggestCandidates(reference);
    elements=PsiUtilCore.toPsiElementArray(candidates);
  }
  if (elements.length == 1) {
    PsiElement element=elements[0];
    LOG.assertTrue(element != null);
    processor.execute(element);
    return true;
  }
  if (elements.length > 1) {
    final TextRange range=reference.getRangeInElement();
    final String elementText=reference.getElement().getText();
    LOG.assertTrue(range.getStartOffset() >= 0 && range.getEndOffset() <= elementText.length(),reference);
    final String refText=range.substring(elementText);
    String title=MessageFormat.format(titlePattern,refText);
    NavigationUtil.getPsiElementPopup(elements,new DefaultPsiElementCellRenderer(),title,processor).showInBestPositionFor(editor);
    return true;
  }
  return false;
}
