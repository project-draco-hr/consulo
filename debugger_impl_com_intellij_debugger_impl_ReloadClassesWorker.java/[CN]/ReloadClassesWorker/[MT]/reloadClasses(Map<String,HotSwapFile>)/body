{
  if (modifiedClasses == null || modifiedClasses.size() == 0) {
    myProgress.addMessage(myDebuggerSession,MessageCategory.INFORMATION,DebuggerBundle.message("status.hotswap.loaded.classes.up.to.date"));
    return;
  }
  final VirtualMachineProxyImpl virtualMachineProxy=getDebugProcess().getVirtualMachineProxy();
  if (virtualMachineProxy == null) {
    return;
  }
  virtualMachineProxy.suspend();
  final Project project=getDebugProcess().getProject();
  try {
    final Map<ReferenceType,byte[]> redefineMap=new java.util.HashMap<ReferenceType,byte[]>();
    int processedClassesCount=0;
    final IOException[] _ex=new IOException[]{null};
    for (    final String qualifiedName : modifiedClasses.keySet()) {
      processedClassesCount++;
      if (qualifiedName != null) {
        myProgress.setText(qualifiedName);
        myProgress.setFraction(processedClassesCount / (double)modifiedClasses.size());
      }
      _ex[0]=null;
      final HotSwapFile fileDescr=modifiedClasses.get(qualifiedName);
      final byte[] buffer=ApplicationManager.getApplication().runReadAction(new Computable<byte[]>(){
        public byte[] compute(){
          try {
            return fileDescr.file.contentsToByteArray();
          }
 catch (          IOException e) {
            _ex[0]=e;
            return null;
          }
        }
      }
);
      if (buffer != null) {
        final List<ReferenceType> classes=virtualMachineProxy.classesByName(qualifiedName);
        for (        final ReferenceType reference : classes) {
          redefineMap.put(reference,buffer);
        }
      }
 else {
        reportProblem(qualifiedName,_ex[0]);
      }
      if (redefineMap.size() >= CLASSES_CHUNK_SIZE) {
        try {
          virtualMachineProxy.redefineClasses(redefineMap);
        }
  finally {
          redefineMap.clear();
        }
      }
    }
    if (redefineMap.size() > 0) {
      virtualMachineProxy.redefineClasses(redefineMap);
    }
    myProgress.setFraction(1);
    myProgress.addMessage(myDebuggerSession,MessageCategory.INFORMATION,DebuggerBundle.message("status.classes.reloaded",modifiedClasses.size()));
    if (LOG.isDebugEnabled()) {
      LOG.debug("classes reloaded");
    }
  }
 catch (  Throwable e) {
    processException(e);
  }
  SwingUtilities.invokeLater(new Runnable(){
    public void run(){
      if (project.isDisposed()) {
        return;
      }
      final BreakpointManager breakpointManager=(DebuggerManagerEx.getInstanceEx(project)).getBreakpointManager();
      breakpointManager.reloadBreakpoints();
      breakpointManager.updateAllRequests();
      if (LOG.isDebugEnabled()) {
        LOG.debug("requests updated");
        LOG.debug("time stamp set");
      }
      myDebuggerSession.refresh(false);
      getDebugProcess().getManagerThread().invokeLater(new DebuggerCommandImpl(){
        protected void action() throws Exception {
          try {
            virtualMachineProxy.resume();
          }
 catch (          Exception e) {
            processException(e);
          }
        }
      }
);
    }
  }
);
}
