{
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      BitSet calcedSegments=new BitSet();
      do {
        calcedSegments.clear();
        for (int i=myCurrentVariableNumber + 1; i < myTemplate.getVariableCount(); i++) {
          String variableName=myTemplate.getVariableNameAt(i);
          int segmentNumber=myTemplate.getVariableSegmentNumber(variableName);
          if (segmentNumber < 0)           continue;
          Expression expression=myTemplate.getExpressionAt(i);
          Expression defaultValue=myTemplate.getDefaultValueAt(i);
          String oldValue=getVariableValue(variableName).getText();
          recalcSegment(segmentNumber,isQuick,expression,defaultValue);
          String newValue=getVariableValue(variableName).getText();
          if (!newValue.equals(oldValue)) {
            calcedSegments.set(segmentNumber);
          }
        }
        for (int i=0; i < myTemplate.getSegmentsCount(); i++) {
          if (!calcedSegments.get(i)) {
            String variableName=myTemplate.getSegmentName(i);
            String newValue=getVariableValue(variableName).getText();
            int start=mySegments.getSegmentStart(i);
            int end=mySegments.getSegmentEnd(i);
            toProcessChangedUpdate=false;
            replaceString(newValue,start,end,i);
            toProcessChangedUpdate=true;
          }
        }
      }
 while (!calcedSegments.isEmpty());
    }
  }
);
}
