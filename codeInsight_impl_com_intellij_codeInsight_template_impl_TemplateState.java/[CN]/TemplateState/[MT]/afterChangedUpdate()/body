{
  if (isFinished())   return;
  LOG.assertTrue(myTemplate != null);
  UndoManager undoManager=UndoManager.getInstance(myProject);
  if (undoManager.isUndoInProgress() || undoManager.isRedoInProgress())   return;
  if (myDocumentChanged) {
    if (myDocumentChangesTerminateTemplate || mySegments.isInvalid()) {
      setCurrentVariableNumber(-1);
      fireTemplateCancelled();
    }
 else {
      calcResults(true);
    }
  }
}
