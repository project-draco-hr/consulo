{
  if (isFinished() || !toProcessChangedUpdate)   return;
  LOG.assertTrue(myTemplate != null);
  UndoManager undoManager=UndoManager.getInstance(myProject);
  if (undoManager.isUndoInProgress() || undoManager.isRedoInProgress())   return;
  if (myChangesFlag) {
    setCurrentVariableNumber(-1);
    fireTemplateCancelled();
  }
 else {
    if (!mySegments.isInvalid()) {
      toProcessChangedUpdate=false;
      calcResults(true);
      toProcessChangedUpdate=true;
    }
  }
}
