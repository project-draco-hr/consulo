{
  final int eol=pattern.indexOf('\n');
  if (eol != -1) {
    pattern=pattern.substring(0,eol);
  }
  if (pattern.length() >= 80) {
    pattern=pattern.substring(0,80);
  }
  @NonNls final StringBuilder buffer=new StringBuilder();
  boolean allowToLower=true;
  if (containsOnlyUppercaseLetters(pattern)) {
    allowToLower=false;
  }
  if (allowToLower) {
    buffer.append(".*");
  }
  boolean firstIdentifierLetter=true;
  for (int i=0; i < pattern.length(); i++) {
    final char c=pattern.charAt(i);
    if (Character.isLetterOrDigit(c)) {
      if (Character.isUpperCase(c) || Character.isDigit(c)) {
        if (!firstIdentifierLetter) {
          buffer.append("[^A-Z]*");
        }
        buffer.append("[");
        buffer.append(c);
        if (allowToLower || i == 0) {
          buffer.append('|');
          buffer.append(Character.toLowerCase(c));
        }
        buffer.append("]");
      }
 else       if (Character.isLowerCase(c)) {
        buffer.append('[');
        buffer.append(c);
        buffer.append('|');
        buffer.append(Character.toUpperCase(c));
        buffer.append(']');
      }
 else {
        buffer.append(c);
      }
      firstIdentifierLetter=false;
    }
 else     if (c == '*') {
      buffer.append(".*");
      firstIdentifierLetter=true;
    }
 else     if (c == '.') {
      buffer.append("\\.");
      firstIdentifierLetter=true;
    }
 else     if (c == ' ') {
      buffer.append(".*\\ ");
      firstIdentifierLetter=true;
    }
 else {
      firstIdentifierLetter=true;
      buffer.append("\\x");
      buffer.append(Integer.toHexString(c + 0x20000).substring(3));
    }
  }
  buffer.append(".*");
  return buffer.toString();
}
