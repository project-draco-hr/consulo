{
  final JpsModule module=myProject.addModule("m",JpsJavaModuleType.INSTANCE);
  final JpsModule dep=myProject.addModule("dep",JpsJavaModuleType.INSTANCE);
  final JpsLibrary library=myProject.addLibrary("l",JpsJavaLibraryType.INSTANCE);
  module.getDependenciesList().addLibraryDependency(library);
  myDispatcher.clear();
  final JpsModel modifiableModel=myModel.createModifiableModel(new TestJpsEventDispatcher());
  final JpsModule m=modifiableModel.getProject().getModules().get(0);
  assertEquals("m",m.getName());
  m.getDependenciesList().getDependencies().get(1).remove();
  m.getDependenciesList().addModuleDependency(dep);
  modifiableModel.commit();
  assertOneElement(myDispatcher.retrieveRemoved(JpsLibraryDependency.class));
  assertSame(dep,assertOneElement(myDispatcher.retrieveAdded(JpsModuleDependency.class)).getModuleReference().resolve());
  List<JpsDependencyElement> dependencies=module.getDependenciesList().getDependencies();
  assertEquals(2,dependencies.size());
  assertSame(dep,assertInstanceOf(dependencies.get(1),JpsModuleDependency.class).getModuleReference().resolve());
}
