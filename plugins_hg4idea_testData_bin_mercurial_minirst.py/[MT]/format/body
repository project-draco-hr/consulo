def format(text, width, indent=0, keep=None):
    'Parse and format the text according to width.'
    blocks = findblocks(text)
    for b in blocks:
        b['indent'] += indent
    blocks = findliteralblocks(blocks)
    (blocks, pruned) = prunecontainers(blocks, (keep or []))
    blocks = inlineliterals(blocks)
    blocks = splitparagraphs(blocks)
    blocks = updatefieldlists(blocks)
    blocks = findsections(blocks)
    blocks = addmargins(blocks)
    text = '\n'.join((formatblock(b, width) for b in blocks))
    if (keep is None):
        return text
    else:
        return (text, pruned)
