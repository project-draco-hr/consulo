{
  if (!myField.isValid())   return;
  PsiManager manager=PsiManager.getInstance(project);
  PsiSearchHelper helper=manager.getSearchHelper();
  Set<PsiMethod> methodSet=new HashSet<PsiMethod>();
  final PsiReference[] allRefs=helper.findReferences(myField,GlobalSearchScope.allScope(project),false);
  for (  PsiReference ref : allRefs) {
    if (ref instanceof PsiReferenceExpression) {
      final PsiMethod method=PsiTreeUtil.getParentOfType((PsiReferenceExpression)ref,PsiMethod.class);
      LOG.assertTrue(method != null);
      methodSet.add(method);
    }
  }
  PsiElement newCaretPosition=null;
  for (  PsiMethod method : methodSet) {
    final PsiReference[] refs=helper.findReferences(myField,new LocalSearchScope(method),true);
    LOG.assertTrue(refs.length > 0);
    Set<PsiReference> refsSet=new HashSet<PsiReference>(Arrays.asList(refs));
    PsiCodeBlock anchorBlock=findAnchorBlock(refs);
    LOG.assertTrue(anchorBlock != null);
    final PsiElementFactory elementFactory=manager.getElementFactory();
    final CodeStyleManager styleManager=manager.getCodeStyleManager();
    final String propertyName=styleManager.variableNameToPropertyName(myField.getName(),VariableKind.FIELD);
    String localName=styleManager.propertyNameToVariableName(propertyName,VariableKind.LOCAL_VARIABLE);
    localName=RefactoringUtil.suggestUniqueVariableName(localName,anchorBlock,myField);
    try {
      final PsiElement anchor=getAnchorElement(anchorBlock,refs);
      final PsiElement newDeclaration;
      if (anchor instanceof PsiExpressionStatement && ((PsiExpressionStatement)anchor).getExpression() instanceof PsiAssignmentExpression) {
        final PsiAssignmentExpression expression=(PsiAssignmentExpression)((PsiExpressionStatement)anchor).getExpression();
        if (expression.getLExpression() instanceof PsiReferenceExpression && ((PsiReferenceExpression)expression.getLExpression()).isReferenceTo(myField)) {
          final PsiExpression initializer=expression.getRExpression();
          final PsiDeclarationStatement decl=elementFactory.createVariableDeclarationStatement(localName,myField.getType(),initializer);
          newDeclaration=anchor.replace(decl);
          refsSet.remove(expression.getLExpression());
          retargetReferences(elementFactory,localName,refsSet);
        }
 else {
          newDeclaration=addDeclarationWithoutInitializerAndRetargetReferences(elementFactory,localName,anchorBlock,anchor,refsSet);
        }
      }
 else {
        newDeclaration=addDeclarationWithoutInitializerAndRetargetReferences(elementFactory,localName,anchorBlock,anchor,refsSet);
      }
      if (newCaretPosition == null) {
        newCaretPosition=newDeclaration;
      }
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
  }
  if (newCaretPosition != null) {
    final PsiFile psiFile=myField.getContainingFile();
    final Editor editor=FileEditorManager.getInstance(project).getSelectedTextEditor();
    if (editor != null && IJSwingUtilities.hasFocus(editor.getComponent())) {
      final PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(editor.getDocument());
      if (file == psiFile) {
        editor.getCaretModel().moveToOffset(newCaretPosition.getTextOffset());
        editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
      }
    }
  }
  try {
    myField.normalizeDeclaration();
    myField.delete();
  }
 catch (  IncorrectOperationException e) {
    LOG.error(e);
  }
}
