{
  PsiManager manager=PsiManager.getInstance(project);
  PsiSearchHelper helper=manager.getSearchHelper();
  Set<PsiMethod> methodSet=new HashSet<PsiMethod>();
  final PsiReference[] allRefs=helper.findReferences(myField,GlobalSearchScope.allScope(project),false);
  for (int i=0; i < allRefs.length; i++) {
    PsiReference ref=allRefs[i];
    if (ref instanceof PsiReferenceExpression) {
      final PsiMethod method=PsiTreeUtil.getParentOfType(((PsiReferenceExpression)ref),PsiMethod.class);
      LOG.assertTrue(method != null);
      methodSet.add(method);
    }
  }
  for (Iterator<PsiMethod> iterator=methodSet.iterator(); iterator.hasNext(); ) {
    PsiMethod method=iterator.next();
    final PsiReference[] refs=helper.findReferences(myField,new LocalSearchScope(method),true);
    LOG.assertTrue(refs.length > 0);
    PsiCodeBlock anchorBlock=findAnchorBlock(refs);
    LOG.assertTrue(anchorBlock != null);
    final PsiElementFactory elementFactory=manager.getElementFactory();
    final CodeStyleManager styleManager=manager.getCodeStyleManager();
    final String propertyName=styleManager.variableNameToPropertyName(myField.getName(),VariableKind.FIELD);
    final String localName=styleManager.propertyNameToVariableName(propertyName,VariableKind.LOCAL_VARIABLE);
    try {
      final PsiDeclarationStatement decl=elementFactory.createVariableDeclarationStatement(localName,myField.getType(),null);
      anchorBlock.addAfter(decl,anchorBlock.getLBrace());
      final PsiReferenceExpression refExpr=(PsiReferenceExpression)elementFactory.createExpressionFromText(localName,null);
      for (int j=0; j < refs.length; j++) {
        PsiReference ref=refs[j];
        if (ref instanceof PsiReferenceExpression) {
          ((PsiReferenceExpression)ref).replace(refExpr);
        }
      }
      myField.delete();
    }
 catch (    IncorrectOperationException e) {
      LOG.error(e);
    }
  }
}
