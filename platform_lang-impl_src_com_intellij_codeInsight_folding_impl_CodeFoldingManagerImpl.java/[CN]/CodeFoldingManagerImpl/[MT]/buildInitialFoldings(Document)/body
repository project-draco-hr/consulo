{
  if (myProject.isDisposed()) {
    return null;
  }
  ApplicationManager.getApplication().assertReadAccessAllowed();
  PsiDocumentManager psiDocumentManager=PsiDocumentManager.getInstance(myProject);
  if (psiDocumentManager.isUncommited(document)) {
    return null;
  }
  final PsiFile file=psiDocumentManager.getPsiFile(document);
  if (file == null || !file.isValid() || !file.getViewProvider().isPhysical() && !ApplicationManager.getApplication().isUnitTestMode()) {
    return null;
  }
  final FoldingUpdate.FoldingMap foldingMap=FoldingUpdate.getFoldingsFor(file,document,true);
  return new CodeFoldingState(){
    @Override public void setToEditor(    @NotNull final Editor editor){
      ApplicationManagerEx.getApplicationEx().assertIsDispatchThread();
      if (myProject.isDisposed() || editor.isDisposed())       return;
      final FoldingModelEx foldingModel=(FoldingModelEx)editor.getFoldingModel();
      if (!foldingModel.isFoldingEnabled())       return;
      if (isFoldingsInitializedInEditor(editor))       return;
      if (DumbService.isDumb(myProject) && !FoldingUpdate.supportsDumbModeFolding(editor))       return;
      foldingModel.runBatchFoldingOperationDoNotCollapseCaret(new UpdateFoldRegionsOperation(myProject,editor,file,foldingMap,YES,false));
      initFolding(editor);
    }
  }
;
}
