{
  final Project project=editor.getProject();
  if (project == null || !project.equals(myProject))   return;
  final Document document=editor.getDocument();
  final PsiFile file=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
  if (file == null || !file.getViewProvider().isPhysical() && !ApplicationManager.getApplication().isUnitTestMode())   return;
  if (!((FoldingModelEx)editor.getFoldingModel()).isFoldingEnabled())   return;
  if (project.isDisposed() || editor.isDisposed() || !file.isValid())   return;
  PsiDocumentManager.getInstance(myProject).commitDocument(document);
  Runnable operation=new Runnable(){
    public void run(){
      Runnable runnable=updateFoldRegions(editor,true,true);
      if (runnable != null) {
        runnable.run();
      }
      DocumentFoldingInfo documentFoldingInfo=getDocumentFoldingInfo(document);
      Editor[] editors=EditorFactory.getInstance().getEditors(document,myProject);
      for (      Editor otherEditor : editors) {
        if (otherEditor == editor)         continue;
        documentFoldingInfo.loadFromEditor(otherEditor);
        break;
      }
      documentFoldingInfo.setToEditor(editor);
      documentFoldingInfo.clear();
    }
  }
;
  editor.getFoldingModel().runBatchFoldingOperationDoNotCollapseCaret(operation);
}
