{
  PsiDocumentManager.getInstance(myProject).commitDocument(editor.getDocument());
  Runnable runnable=updateFoldRegions(editor,true,false);
  if (runnable != null) {
    runnable.run();
  }
  final FoldRegion[] regions=editor.getFoldingModel().getAllFoldRegions();
  editor.getFoldingModel().runBatchFoldingOperation(new Runnable(){
    public void run(){
      for (      FoldRegion region : regions) {
        PsiElement element=EditorFoldingInfo.get(editor).getPsiElement(region);
        if (element != null) {
          region.setExpanded(!FoldingPolicy.isCollapseByDefault(element));
        }
      }
    }
  }
);
}
