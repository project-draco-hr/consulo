{
  Document document=editor.getDocument();
  PsiFile file=PsiDocumentManager.getInstance(project).getPsiFile(document);
  int selectionStart=editor.getSelectionModel().getLeadSelectionOffset();
  if (file == null)   return;
  IdeDocumentHistory.getInstance(project).includeCurrentCommandAsNavigation();
  final CodeBlockProvider provider=CodeBlockProviders.INSTANCE.forLanguage(file.getLanguage());
  if (provider != null) {
    final TextRange range=provider.getCodeBlockRange(editor,file);
    if (range != null) {
      editor.getCaretModel().moveToOffset(range.getStartOffset());
    }
  }
 else {
    final IndentGuideDescriptor guide=editor.getIndentsModel().getCaretIndentGuide();
    if (guide != null && guide.startLine != editor.getCaretModel().getLogicalPosition().line) {
      editor.getCaretModel().moveToLogicalPosition(new LogicalPosition(guide.startLine,guide.indentLevel));
    }
 else {
      int start=calcBlockStartOffset(editor,file);
      if (start < 0)       return;
      editor.getCaretModel().moveToOffset(start);
    }
  }
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  if (isWithSelection) {
    editor.getSelectionModel().setSelection(selectionStart,editor.getCaretModel().getOffset());
  }
 else {
    editor.getSelectionModel().removeSelection();
  }
}
