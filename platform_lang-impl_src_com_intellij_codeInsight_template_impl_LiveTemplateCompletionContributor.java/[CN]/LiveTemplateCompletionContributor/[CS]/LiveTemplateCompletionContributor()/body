{
  extend(CompletionType.BASIC,PlatformPatterns.psiElement(),new CompletionProvider<CompletionParameters>(){
    @Override protected void addCompletions(    @NotNull CompletionParameters parameters,    ProcessingContext context,    @NotNull final CompletionResultSet result){
      final PsiFile file=parameters.getPosition().getContainingFile();
      final int offset=parameters.getOffset();
      final List<TemplateImpl> templates=listApplicableTemplates(file,offset);
      if (showAllTemplates()) {
        final Ref<Boolean> templatesShown=Ref.create(false);
        result.runRemainingContributors(parameters,new Consumer<CompletionResult>(){
          @Override public void consume(          CompletionResult completionResult){
            result.passResult(completionResult);
            ensureTemplatesShown(templatesShown,templates,result);
          }
        }
);
        ensureTemplatesShown(templatesShown,templates,result);
        return;
      }
      if (parameters.getInvocationCount() > 0)       return;
      final String prefix=result.getPrefixMatcher().getPrefix();
      final TemplateImpl template=findApplicableTemplate(file,offset,prefix);
      if (template != null) {
        result.addElement(new LiveTemplateLookupElement(template,true));
      }
      for (      final TemplateImpl possible : templates) {
        result.restartCompletionOnPrefixChange(possible.getKey());
      }
    }
  }
);
}
