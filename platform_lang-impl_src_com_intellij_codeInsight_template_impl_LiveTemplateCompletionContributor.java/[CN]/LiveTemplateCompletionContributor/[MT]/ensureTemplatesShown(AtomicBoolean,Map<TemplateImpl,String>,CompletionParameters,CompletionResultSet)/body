{
  if (!templatesShown.getAndSet(true)) {
    for (    final Map.Entry<TemplateImpl,String> entry : templates.entrySet()) {
      result.withPrefixMatcher(result.getPrefixMatcher().cloneWithPrefix(StringUtil.notNullize(entry.getValue()))).addElement(new LiveTemplateLookupElementImpl(entry.getKey(),false));
    }
    PsiFile file=parameters.getPosition().getContainingFile();
    Editor editor=parameters.getEditor();
    for (    CustomLiveTemplate customLiveTemplate : TemplateManagerImpl.listApplicableCustomTemplates(editor,file,false)) {
      if (customLiveTemplate instanceof CustomLiveTemplateBase) {
        ((CustomLiveTemplateBase)customLiveTemplate).addCompletions(parameters,result);
      }
    }
  }
}
