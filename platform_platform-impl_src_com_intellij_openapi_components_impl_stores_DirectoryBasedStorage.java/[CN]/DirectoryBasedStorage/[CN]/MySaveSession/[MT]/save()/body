{
  VirtualFile dir=storage.getVirtualFile();
  if (copiedStorageData.isEmpty()) {
    if (dir != null && dir.exists()) {
      try {
        StorageUtil.deleteFile(this,dir);
      }
 catch (      IOException e) {
        throw new StateStorageException(e);
      }
    }
    storage.myStorageData=copiedStorageData;
    return;
  }
  if (dir == null || !dir.isValid()) {
    storage.myDir.mkdirs();
    String parentFile=storage.myDir.getParent();
    VirtualFile parentVirtualFile=parentFile == null ? null : LocalFileSystem.getInstance().refreshAndFindFileByPath(parentFile.replace(File.separatorChar,'/'));
    if (parentVirtualFile == null) {
      throw new StateStorageException(ProjectBundle.message("project.configuration.save.file.not.found",parentFile));
    }
    dir=getFile(storage.myDir.getName(),parentVirtualFile);
  }
  if (!dirtyFileNames.isEmpty()) {
    saveStates(dir);
  }
  if (dir.exists() && !removedFileNames.isEmpty()) {
    deleteFiles(dir);
  }
  storage.myVirtualFile=dir;
  storage.myStorageData=copiedStorageData;
}
