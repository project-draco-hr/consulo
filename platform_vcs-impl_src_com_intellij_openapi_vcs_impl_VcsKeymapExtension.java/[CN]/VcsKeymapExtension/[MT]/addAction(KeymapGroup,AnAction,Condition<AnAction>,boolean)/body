{
  if (action instanceof ActionGroup) {
    if (forceNonPopup) {
      AnAction[] actions=getActions((ActionGroup)action);
      for (      AnAction childAction : actions) {
        addAction(result,childAction,filtered,true);
      }
    }
 else {
      Group subGroup=ActionsTreeUtil.createGroup((ActionGroup)action,false,filtered);
      if (subGroup.getSize() > 0) {
        result.addGroup(subGroup);
      }
    }
  }
 else   if (action instanceof AnSeparator) {
    if (result instanceof Group) {
      ((Group)result).addSeparator();
    }
  }
 else {
    if (filtered == null || filtered.value(action)) {
      String id=action instanceof ActionStub ? ((ActionStub)action).getId() : ActionManager.getInstance().getId(action);
      result.addActionId(id);
    }
  }
}
