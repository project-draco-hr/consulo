def rename(src, dst):
    'atomically rename file src to dst, replacing dst if it exists'
    try:
        os.rename(src, dst)
    except OSError as err:

        def tempname(prefix):
            for tries in xrange(10):
                temp = ('%s-%08x' % (prefix, random.randint(0, 4294967295)))
                if (not os.path.exists(temp)):
                    return temp
            raise IOError, (errno.EEXIST, 'No usable temporary filename found')
        temp = tempname(dst)
        os.rename(dst, temp)
        try:
            os.unlink(temp)
        except:
            pass
        os.rename(src, dst)
