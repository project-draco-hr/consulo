def statfiles(files):
    'Stat each file in files and yield stat or None if file does not exist.\n    Cluster and cache stat per directory to minimize number of OS stat calls.'
    ncase = os.path.normcase
    dircache = {}
    for nf in files:
        nf = ncase(nf)
        (dir, base) = os.path.split(nf)
        if (not dir):
            dir = '.'
        cache = dircache.get(dir, None)
        if (cache is None):
            try:
                dmap = dict([(ncase(n), s) for (n, k, s) in osutil.listdir(dir, True)])
            except OSError as err:
                if (err.errno not in (3, errno.ENOENT, errno.EINVAL, errno.ENOTDIR)):
                    raise
                dmap = {}
            cache = dircache.setdefault(dir, dmap)
        yield cache.get(base, None)
