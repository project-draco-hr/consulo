def flush(self):
    try:
        return self.fp.flush()
    except IOError as inst:
        if (inst.errno != errno.EINVAL):
            raise
        self.close()
        raise IOError(errno.EPIPE, 'Broken pipe')
