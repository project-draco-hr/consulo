{
  final ModuleRootManager manager=ModuleRootManager.getInstance(module);
  final File rootFile=new File(path);
  final boolean created;
  if (!rootFile.exists()) {
    if (!rootFile.mkdirs())     return;
    created=true;
  }
 else {
    created=false;
  }
  final Project project=module.getProject();
  ApplicationManager.getApplication().invokeLater(new Runnable(){
    public void run(){
      if (project.isDisposed() || module.isDisposed()) {
        return;
      }
      final VirtualFile root;
      if (created) {
        root=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(rootFile);
      }
 else {
        root=LocalFileSystem.getInstance().findFileByIoFile(rootFile);
      }
      if (root != null) {
        unexcludeRootIfNeccessary(root,manager);
        for (        VirtualFile existingRoot : manager.getSourceRoots()) {
          if (existingRoot == root)           return;
        }
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          public void run(){
            addSourceRoot(manager,root);
          }
        }
);
      }
    }
  }
,project.getDisposed());
}
