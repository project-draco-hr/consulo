{
  ApplicationManager.getApplication().assertIsDispatchThread();
  final File rootFile=new File(path);
  final boolean created;
  if (!rootFile.exists()) {
    if (!rootFile.mkdirs())     return null;
    created=true;
  }
 else {
    created=false;
  }
  final Project project=module.getProject();
  if (project.isDisposed() || module.isDisposed()) {
    return null;
  }
  final VirtualFile root;
  if (created) {
    root=LocalFileSystem.getInstance().refreshAndFindFileByIoFile(rootFile);
  }
 else {
    root=LocalFileSystem.getInstance().findFileByIoFile(rootFile);
  }
  if (root != null) {
    final ModuleRootManager manager=ModuleRootManager.getInstance(module);
    unexcludeRootIfNeccessary(root,manager);
    boolean markedAsSource=false;
    for (    VirtualFile existingRoot : manager.getSourceRoots()) {
      if (existingRoot == root) {
        markedAsSource=true;
      }
    }
    if (!markedAsSource) {
      ApplicationManager.getApplication().runWriteAction(new Runnable(){
        public void run(){
          addSourceRoot(manager,root);
        }
      }
);
    }
  }
  return root;
}
