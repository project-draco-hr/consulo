{
  final ModuleRootManager libRootManager=ModuleRootManager.getInstance(libModule);
  final Sdk sdk=libRootManager.getSdk();
  if (sdk == null || !(sdk.getSdkType() instanceof AndroidSdkType)) {
    LOG.error("Android SDK is not specified for module " + libModule.getName());
    return null;
  }
  final AndroidSdkAdditionalData data=(AndroidSdkAdditionalData)sdk.getSdkAdditionalData();
  final Sdk jdk=data != null ? data.getJavaSdk() : null;
  if (jdk == null) {
    LOG.error("Internal Java SDK is not specified for module " + libModule.getName());
    return null;
  }
  final Module genModule=findOrCreateGenModule(libModule);
  final ModifiableRootModel genModel=ModuleRootManager.getInstance(genModule).getModifiableModel();
  genModel.setSdk(jdk);
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      genModel.commit();
    }
  }
);
  if (ArrayUtil.find(libRootManager.getDependencies(),genModule) < 0) {
    final ModifiableRootModel libModel=libRootManager.getModifiableModel();
    libModel.addModuleOrderEntry(genModule);
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        libModel.commit();
      }
    }
);
  }
  return genModule;
}
