{
  final ModuleRootManager libRootManager=ModuleRootManager.getInstance(libModule);
  final Sdk sdk=libRootManager.getSdk();
  if (sdk == null || !(sdk.getSdkType() instanceof AndroidSdkType)) {
    LOG.info("Android SDK is not specified for module " + libModule.getName());
    return null;
  }
  final Module genModule=findOrCreateGenModule(libModule);
  final ModifiableRootModel genModel=ModuleRootManager.getInstance(genModule).getModifiableModel();
  genModel.setSdk(sdk);
  if (ArrayUtil.find(genModel.getModuleDependencies(),libModule) < 0) {
    genModel.addModuleOrderEntry(libModule);
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    @Override public void run(){
      genModel.commit();
    }
  }
);
  if (ArrayUtil.find(libRootManager.getDependencies(),genModule) < 0) {
    final ModifiableRootModel libModel=libRootManager.getModifiableModel();
    libModel.addModuleOrderEntry(genModule);
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      @Override public void run(){
        libModel.commit();
      }
    }
);
  }
  return genModule;
}
