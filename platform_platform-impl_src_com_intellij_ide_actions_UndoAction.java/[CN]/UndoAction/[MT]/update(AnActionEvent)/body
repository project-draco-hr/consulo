{
  Presentation presentation=event.getPresentation();
  DataContext dataContext=event.getDataContext();
  FileEditor editor=PlatformDataKeys.FILE_EDITOR.getData(dataContext);
  if (editor == null && dataContext.getData(DataConstants.IS_MODAL_CONTEXT) == Boolean.TRUE) {
    presentation.setEnabled(false);
    return;
  }
  final Project project=getProject(editor,dataContext);
  UndoManager undoManager=project != null ? UndoManager.getInstance(project) : UndoManager.getGlobalInstance();
  boolean available=undoManager.isUndoAvailable(editor);
  presentation.setEnabled(available);
  String actionName=available ? undoManager.formatAvailableUndoAction(editor) : "";
  presentation.setText(ActionsBundle.message("action.$Undo.text",actionName).trim());
}
