{
  final PsiType castType=expression.getType();
  if (castType == null) {
    return true;
  }
  final PsiExpression operand=expression.getOperand();
  if (operand == null) {
    return true;
  }
  final PsiType operandType=operand.getType();
  PsiElement parent=expression.getParent();
  while (parent instanceof PsiParenthesizedExpression) {
    parent=parent.getParent();
  }
  if (parent instanceof PsiPolyadicExpression) {
    final PsiPolyadicExpression polyadicExpression=(PsiPolyadicExpression)parent;
    final IElementType tokenType=polyadicExpression.getOperationTokenType();
    if (binaryPromotionOperators.contains(tokenType)) {
      if (PsiType.INT.equals(castType)) {
        return PsiType.LONG.equals(operandType) || PsiType.FLOAT.equals(operandType) || PsiType.DOUBLE.equals(operandType);
      }
      if (PsiType.LONG.equals(castType) || PsiType.FLOAT.equals(castType) || PsiType.DOUBLE.equals(castType)) {
        final PsiExpression[] operands=polyadicExpression.getOperands();
        for (        PsiExpression operand1 : operands) {
          if (!PsiTreeUtil.isAncestor(operand1,expression,false)) {
            final PsiType type=operand1.getType();
            if (castType.equals(type)) {
              return false;
            }
          }
        }
      }
    }
 else     if (JavaTokenType.GTGT.equals(tokenType) || JavaTokenType.GTGTGT.equals(tokenType) || JavaTokenType.LTLT.equals(tokenType)) {
      final PsiExpression firstOperand=polyadicExpression.getOperands()[0];
      if (!PsiTreeUtil.isAncestor(firstOperand,expression,false)) {
        return false;
      }
      return PsiType.LONG.equals(castType) || !isLegalWideningConversion(operand,PsiType.INT);
    }
    return true;
  }
 else   if (parent instanceof PsiAssignmentExpression) {
    final PsiAssignmentExpression assignmentExpression=(PsiAssignmentExpression)parent;
    final PsiType lhsType=assignmentExpression.getType();
    if (!castType.equals(lhsType)) {
      return true;
    }
    return !isLegalAssignmentConversion(operand,lhsType);
  }
 else   if (parent instanceof PsiVariable) {
    final PsiVariable variable=(PsiVariable)parent;
    final PsiType lhsType=variable.getType();
    return !castType.equals(lhsType) || !isLegalAssignmentConversion(operand,lhsType);
  }
 else {
    final PsiType expectedType=ExpectedTypeUtils.findExpectedType(expression,false);
    return !castType.equals(expectedType) || !isLegalWideningConversion(operand,castType);
  }
}
