{
  LOG.assertTrue(elementToFold.isValid());
  TextRange range=getRangeToFold(elementToFold);
  if (range == null)   return false;
  final TextRange fileRange=elementToFold.getContainingFile().getTextRange();
  if (range.equals(fileRange))   return false;
  LOG.assertTrue(range.getStartOffset() >= 0 && range.getEndOffset() <= fileRange.getEndOffset());
  if (range.getStartOffset() < 0 || range.getEndOffset() > fileRange.getEndOffset()) {
    return false;
  }
  if (!allowOneLiners) {
    int startLine=document.getLineNumber(range.getStartOffset());
    int endLine=document.getLineNumber(range.getEndOffset() - 1);
    if (startLine < endLine) {
      map.put(elementToFold,range);
      return true;
    }
 else {
      return false;
    }
  }
 else {
    if (range.getEndOffset() - range.getStartOffset() > getFoldingText(elementToFold).length()) {
      map.put(elementToFold,range);
      return true;
    }
 else {
      return false;
    }
  }
}
