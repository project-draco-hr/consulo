{
  GrExpression selectedExpr=GroovyRefactoringUtil.findElementInRange(file,startOffset,endOffset,GrExpression.class);
  if (selectedExpr == null)   return null;
  if (selectedExpr instanceof GrClosableBlock && selectedExpr.getParent() instanceof GrStringInjection) {
    throw new GrIntroduceRefactoringError(GroovyRefactoringBundle.message("selected.block.should.represent.an.expression"));
  }
  if (selectedExpr instanceof GrReferenceExpression && selectedExpr.getParent() instanceof GrMethodCall && (((GrMethodCall)selectedExpr.getParent()).isCommandExpression() || selectedExpr.getParent() instanceof GrApplicationStatement) || selectedExpr instanceof GrApplicationStatement) {
    throw new GrIntroduceRefactoringError(GroovyRefactoringBundle.message("selected.expression.in.command.expression"));
  }
  PsiType type=selectedExpr.getType();
  if (type != null)   type=TypeConversionUtil.erasure(type);
  if (PsiType.VOID.equals(type)) {
    throw new GrIntroduceRefactoringError(GroovyRefactoringBundle.message("selected.expression.has.void.type"));
  }
  return selectedExpr;
}
