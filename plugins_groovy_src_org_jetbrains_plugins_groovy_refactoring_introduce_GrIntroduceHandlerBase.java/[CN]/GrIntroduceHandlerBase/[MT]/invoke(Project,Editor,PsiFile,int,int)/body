{
  try {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    if (!(file instanceof GroovyFileBase)) {
      throw new GrIntroduceRefactoringError(GroovyRefactoringBundle.message("only.in.groovy.files"));
    }
    if (!CommonRefactoringUtil.checkReadOnlyStatus(project,file)) {
      throw new GrIntroduceRefactoringError(RefactoringBundle.message("readonly.occurences.found"));
    }
    GrExpression selectedExpr=findExpression((GroovyFileBase)file,startOffset,endOffset);
    checkExpression(selectedExpr);
    final GrIntroduceContext context=getContext(project,editor,selectedExpr);
    final Settings settings=showDialog(context);
    if (settings == null)     return false;
    CommandProcessor.getInstance().executeCommand(context.project,new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new Runnable(){
          @Override public void run(){
            runRefactoring(context,settings);
          }
        }
);
      }
    }
,getRefactoringName(),null);
    return true;
  }
 catch (  GrIntroduceRefactoringError e) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactoringBundle.getCannotRefactorMessage(e.getMessage()),getRefactoringName(),getHelpID());
    return false;
  }
}
