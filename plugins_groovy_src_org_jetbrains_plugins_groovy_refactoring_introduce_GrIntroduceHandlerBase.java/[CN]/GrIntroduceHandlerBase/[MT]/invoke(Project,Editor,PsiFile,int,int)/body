{
  try {
    PsiDocumentManager.getInstance(project).commitAllDocuments();
    if (!(file instanceof GroovyFileBase)) {
      throw new GrIntroduceRefactoringError(GroovyRefactoringBundle.message("only.in.groovy.files"));
    }
    if (!CommonRefactoringUtil.checkReadOnlyStatus(project,file)) {
      throw new GrIntroduceRefactoringError(RefactoringBundle.message("readonly.occurences.found"));
    }
    GrExpression selectedExpr=findExpression((GroovyFileBase)file,startOffset,endOffset);
    final GrVariable variable=findVariable((GroovyFile)file,startOffset,endOffset);
    if (variable != null) {
      checkVariable(variable);
    }
 else     if (selectedExpr != null) {
      checkExpression(selectedExpr);
    }
 else {
      throw new GrIntroduceRefactoringError(null);
    }
    final GrIntroduceContext context=getContext(project,editor,selectedExpr,variable);
    checkOccurrences(context.occurrences);
    final Settings settings=showDialog(context);
    if (settings == null)     return false;
    CommandProcessor.getInstance().executeCommand(context.project,new Runnable(){
      public void run(){
        final GrVariable created=ApplicationManager.getApplication().runWriteAction(new Computable<GrVariable>(){
          public GrVariable compute(){
            return runRefactoring(context,settings);
          }
        }
);
        if (editor != null && created != null) {
          PsiDocumentManager.getInstance(project).commitDocument(editor.getDocument());
          editor.getCaretModel().moveToOffset(created.getNameIdentifierGroovy().getTextOffset());
        }
      }
    }
,getRefactoringName(),null);
    return true;
  }
 catch (  GrIntroduceRefactoringError e) {
    CommonRefactoringUtil.showErrorHint(project,editor,RefactoringBundle.getCannotRefactorMessage(e.getMessage()),getRefactoringName(),getHelpID());
    return false;
  }
}
