{
  final ArrayList<VcsException> exceptions=new ArrayList<VcsException>();
  ISVNEventHandler eventHandler=new UpdateEventHandler(myVcs,progressIndicator,updatedFiles);
  boolean totalUpdate=true;
  AbstractUpdateIntegrateCrawler crawler=createCrawler(eventHandler,totalUpdate,exceptions,updatedFiles);
  Collection<File> updatedRoots=new HashSet<File>();
  for (  FilePath contentRoot : contentRoots) {
    if (progressIndicator != null && progressIndicator.isCanceled()) {
      throw new ProcessCanceledException();
    }
    Collection<File> roots=SvnUtil.crawlWCRoots(contentRoot.getIOFile(),crawler,progressIndicator);
    updatedRoots.addAll(roots);
  }
  if (updatedRoots.isEmpty()) {
    Messages.showErrorDialog(myVcs.getProject(),SvnBundle.message("message.text.update.no.directories.found"),SvnBundle.message("messate.text.update.error"));
  }
  final Collection<String> conflictedFiles=updatedFiles.getGroupById(FileGroup.MERGED_WITH_CONFLICT_ID).getFiles();
  return new UpdateSessionAdapter(exceptions,false){
    public void onRefreshFilesCompleted(){
      if (conflictedFiles != null && !conflictedFiles.isEmpty() && !isDryRun()) {
        List<VirtualFile> vfFiles=new ArrayList<VirtualFile>();
        for (        final String conflictedFile : conflictedFiles) {
          @NonNls final String path="file://" + conflictedFile.replace(File.separatorChar,'/');
          VirtualFile vf=ApplicationManager.getApplication().runReadAction(new Computable<VirtualFile>(){
            @Nullable public VirtualFile compute(){
              return VirtualFileManager.getInstance().findFileByUrl(path);
            }
          }
);
          if (vf != null) {
            vf.getParent().refresh(true,false);
            VcsDirtyScopeManager.getInstance(myVcs.getProject()).fileDirty(vf);
            if (ProjectLevelVcsManager.getInstance(myVcs.getProject()).getVcsFor(vf).equals(myVcs)) {
              vfFiles.add(vf);
            }
          }
        }
        if (!vfFiles.isEmpty()) {
          AbstractVcsHelper.getInstance(myVcs.getProject()).showMergeDialog(vfFiles,new SvnMergeProvider(myVcs.getProject()),null);
        }
      }
    }
  }
;
}
