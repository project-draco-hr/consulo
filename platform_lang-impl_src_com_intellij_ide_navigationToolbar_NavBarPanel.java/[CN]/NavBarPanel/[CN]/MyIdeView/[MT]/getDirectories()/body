{
  final PsiDirectory dir=getSelectedElement(PsiDirectory.class);
  if (dir != null && dir.isValid()) {
    return new PsiDirectory[]{dir};
  }
  final PsiElement element=getSelectedElement(PsiElement.class);
  if (element != null && element.isValid()) {
    final PsiFile file=element.getContainingFile();
    if (file != null) {
      final PsiDirectory psiDirectory=file.getContainingDirectory();
      return psiDirectory != null ? new PsiDirectory[]{psiDirectory} : PsiDirectory.EMPTY_ARRAY;
    }
  }
  final PsiDirectoryContainer directoryContainer=getSelectedElement(PsiDirectoryContainer.class);
  if (directoryContainer != null) {
    return directoryContainer.getDirectories();
  }
  final Module module=getSelectedElement(Module.class);
  if (module != null && !module.isDisposed()) {
    ArrayList<PsiDirectory> dirs=new ArrayList<PsiDirectory>();
    final VirtualFile[] sourceRoots=ModuleRootManager.getInstance(module).getSourceRoots();
    final PsiManager psiManager=PsiManager.getInstance(myProject);
    for (    VirtualFile virtualFile : sourceRoots) {
      final PsiDirectory directory=psiManager.findDirectory(virtualFile);
      if (directory != null && directory.isValid()) {
        dirs.add(directory);
      }
    }
    return dirs.toArray(new PsiDirectory[dirs.size()]);
  }
  return PsiDirectory.EMPTY_ARRAY;
}
