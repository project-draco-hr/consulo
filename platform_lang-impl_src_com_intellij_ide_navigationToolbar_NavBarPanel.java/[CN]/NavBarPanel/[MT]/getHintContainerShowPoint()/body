{
  final AsyncResult<RelativePoint> result=new AsyncResult<RelativePoint>();
  if (myLocationCache == null) {
    if (myHintContainer != null) {
      final Point p=AbstractPopup.getCenterOf(myHintContainer,this);
      p.y-=myHintContainer.getVisibleRect().height / 4;
      myLocationCache=RelativePoint.fromScreen(p);
    }
 else {
      if (myContextComponent != null) {
        myLocationCache=JBPopupFactory.getInstance().guessBestPopupLocation(DataManager.getInstance().getDataContext(myContextComponent));
      }
 else {
        DataManager.getInstance().getDataContextFromFocus().doWhenDone(new AsyncResult.Handler<DataContext>(){
          @Override public void run(          DataContext dataContext){
            myContextComponent=PlatformDataKeys.CONTEXT_COMPONENT.getData(dataContext);
            myLocationCache=JBPopupFactory.getInstance().guessBestPopupLocation(DataManager.getInstance().getDataContext(myContextComponent));
          }
        }
);
      }
    }
  }
  final Component c=myLocationCache.getComponent();
  if (!(c instanceof JComponent && c.isShowing())) {
    final JComponent ideFrame=WindowManager.getInstance().getIdeFrame(getProject()).getComponent();
    final JRootPane rootPane=UIUtil.getRootPane(ideFrame);
    myLocationCache=JBPopupFactory.getInstance().guessBestPopupLocation(rootPane);
  }
  result.setDone(myLocationCache);
  return result;
}
