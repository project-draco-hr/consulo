{
  assertIsDispatchThread();
  myPendingFoldRegions.addAll(toAdd);
  myFoldingAlarm.cancelAllRequests();
  final Runnable runnable=new Runnable(){
    @Override public void run(){
      if (myEditor == null || myEditor.isDisposed()) {
        return;
      }
      assertIsDispatchThread();
      final FoldingModel model=myEditor.getFoldingModel();
      final Runnable operation=new Runnable(){
        @Override public void run(){
          assertIsDispatchThread();
          for (          FoldRegion region : myPendingFoldRegions) {
            region.setExpanded(false);
            model.addFoldRegion(region);
          }
          myPendingFoldRegions.clear();
        }
      }
;
      if (immediately) {
        model.runBatchFoldingOperation(operation);
      }
 else {
        model.runBatchFoldingOperationDoNotCollapseCaret(operation);
      }
    }
  }
;
  if (immediately || myPendingFoldRegions.size() > 100) {
    runnable.run();
  }
 else {
    myFoldingAlarm.addRequest(runnable,50);
  }
}
