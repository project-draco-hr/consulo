{
  final EditorFactoryImpl document=(EditorFactoryImpl)EditorFactory.getInstance();
  final Document editorDocument=document.createDocument(true);
  editorDocument.addDocumentListener(new DocumentListener(){
    public void beforeDocumentChange(    DocumentEvent event){
    }
    public void documentChanged(    DocumentEvent event){
      if (myFileType != null) {
        highlightUserTokens();
      }
    }
  }
);
  final EditorEx editor=(EditorEx)document.createViewer(editorDocument,myProject);
  editor.getSettings().setAllowSingleLogicalLineFolding(true);
  editor.setSoftWrapAppliancePlace(SoftWrapAppliancePlaces.CONSOLE);
  final EditorHighlighter highlighter=createHighlighter();
  editor.setHighlighter(highlighter);
  final EditorSettings editorSettings=editor.getSettings();
  editorSettings.setLineMarkerAreaShown(false);
  editorSettings.setIndentGuidesShown(false);
  editorSettings.setLineNumbersShown(false);
  editorSettings.setFoldingOutlineShown(true);
  editorSettings.setAdditionalPageAtBottom(false);
  editorSettings.setAdditionalColumnsCount(0);
  editorSettings.setAdditionalLinesCount(0);
  final DelegateColorScheme scheme=new DelegateColorScheme(editor.getColorsScheme()){
    @Override public Color getDefaultBackground(){
      final Color color=getColor(ConsoleViewContentType.CONSOLE_BACKGROUND_KEY);
      return color == null ? super.getDefaultBackground() : color;
    }
  }
;
  editor.setColorsScheme(scheme);
  scheme.setColor(EditorColors.CARET_ROW_COLOR,null);
  scheme.setColor(EditorColors.RIGHT_MARGIN_COLOR,null);
  final ConsoleViewImpl consoleView=this;
  editor.getContentComponent().addKeyListener(new KeyListener(){
    private int historyPosition=myHistory.size();
    public void keyTyped(    KeyEvent e){
    }
    public void keyPressed(    KeyEvent e){
    }
    public void keyReleased(    KeyEvent e){
      if (e.isAltDown() && !e.isControlDown() && !e.isMetaDown()&& !e.isShiftDown()) {
        if (e.getKeyCode() == KeyEvent.VK_UP) {
          historyPosition--;
          if (historyPosition < 0)           historyPosition=0;
          replaceString();
          e.consume();
        }
 else         if (e.getKeyCode() == KeyEvent.VK_DOWN) {
          historyPosition++;
          if (historyPosition > myHistory.size())           historyPosition=myHistory.size();
          replaceString();
          e.consume();
        }
      }
 else {
        historyPosition=myHistory.size();
      }
    }
    private void replaceString(){
      final String str;
      if (myHistory.size() == historyPosition) {
        str="";
      }
 else {
        str=myHistory.get(historyPosition);
      }
synchronized (LOCK) {
        if (myTokens.isEmpty())         return;
        final TokenInfo info=myTokens.get(myTokens.size() - 1);
        if (info.contentType != ConsoleViewContentType.USER_INPUT) {
          consoleView.insertUserText(str,0);
        }
 else {
          consoleView.replaceUserText(str,info.startOffset,info.endOffset);
        }
      }
    }
  }
);
  if (!isViewer) {
    setEditorUpActions(editor);
  }
  return editor;
}
