{
  if (start == end) {
    insertUserText(s,start);
    return;
  }
  final ConsoleViewImpl consoleView=this;
  final ConsoleBuffer buffer=consoleView.myBuffer;
  final Editor editor=consoleView.myEditor;
  final Document document=editor.getDocument();
  final int startOffset;
  final int endOffset;
synchronized (consoleView.LOCK) {
    if (consoleView.myTokens.isEmpty())     return;
    final TokenInfo info=consoleView.myTokens.get(consoleView.myTokens.size() - 1);
    if (info.contentType != ConsoleViewContentType.USER_INPUT) {
      consoleView.print(s,ConsoleViewContentType.USER_INPUT);
      consoleView.flushDeferredText();
      editor.getCaretModel().moveToOffset(document.getTextLength());
      editor.getSelectionModel().removeSelection();
      return;
    }
    if (buffer.getUserInputLength() <= 0)     return;
    final int deferredOffset=myContentSize - buffer.getLength() - buffer.getUserInputLength();
    startOffset=getStartOffset(start,info,deferredOffset);
    endOffset=getEndOffset(end,info);
    if (startOffset == -1 || endOffset == -1 || endOffset <= startOffset) {
      editor.getSelectionModel().removeSelection();
      editor.getCaretModel().moveToOffset(start);
      return;
    }
    int charCountToReplace=s.length() - endOffset + startOffset;
    buffer.replaceUserText(startOffset - deferredOffset,endOffset - deferredOffset,s);
    info.endOffset+=charCountToReplace;
    if (info.startOffset == info.endOffset) {
      consoleView.myTokens.remove(consoleView.myTokens.size() - 1);
    }
    consoleView.myContentSize+=charCountToReplace;
  }
  try {
    myInDocumentUpdate=true;
    document.replaceString(startOffset,endOffset,s);
  }
  finally {
    myInDocumentUpdate=false;
  }
  editor.getCaretModel().moveToOffset(startOffset + s.length());
  editor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
  editor.getSelectionModel().removeSelection();
}
