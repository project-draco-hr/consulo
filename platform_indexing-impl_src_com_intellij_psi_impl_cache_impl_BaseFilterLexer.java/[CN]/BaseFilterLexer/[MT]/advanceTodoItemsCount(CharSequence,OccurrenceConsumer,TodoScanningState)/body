{
  if (todoScanningState == null) {
    IndexPattern[] patterns=IndexPatternUtil.getIndexPatterns();
    Matcher[] matchers=new Matcher[patterns.length];
    todoScanningState=new TodoScanningState(patterns,matchers);
    for (int i=0; i < patterns.length; ++i) {
      Pattern pattern=patterns[i].getPattern();
      if (pattern != null) {
        matchers[i]=pattern.matcher("");
      }
    }
  }
 else {
    todoScanningState.myOccurences.resetQuick();
  }
  for (int i=todoScanningState.myMatchers.length - 1; i >= 0; --i) {
    Matcher matcher=todoScanningState.myMatchers[i];
    if (matcher == null)     continue;
    matcher.reset(input);
    while (matcher.find()) {
      int start=matcher.start();
      if (start != matcher.end() && todoScanningState.myOccurences.indexOf(start) == -1) {
        consumer.incTodoOccurrence(todoScanningState.myPatterns[i]);
        todoScanningState.myOccurences.add(start);
      }
    }
  }
  return todoScanningState;
}
