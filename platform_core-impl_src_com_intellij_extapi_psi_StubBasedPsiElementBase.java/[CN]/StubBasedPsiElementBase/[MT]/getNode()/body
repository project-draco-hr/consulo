{
  ASTNode node=myNode;
  if (node == null) {
    ApplicationManager.getApplication().assertReadAccessAllowed();
    PsiFileImpl file=(PsiFileImpl)getContainingFile();
synchronized (file.getStubLock()) {
      node=myNode;
      if (node == null) {
        NonCancelableSection criticalSection=ProgressIndicatorProvider.getInstance().startNonCancelableSection();
        try {
          if (!file.isValid())           throw new PsiInvalidElementAccessException(this);
          FileElement treeElement=file.getTreeElement();
          StubTree stubTree=file.getStubTree();
          if (treeElement != null) {
            return notBoundInExistingAst(file,treeElement,stubTree);
          }
          final FileElement fileElement=file.loadTreeElement();
          node=myNode;
          if (node == null) {
            String message="Failed to bind stub to AST for element " + getClass() + " in "+ (file.getVirtualFile() == null ? "<unknown file>" : file.getVirtualFile().getPath())+ "\nFile stub tree:\n"+ (stubTree != null ? StringUtil.trimLog(((PsiFileStubImpl)stubTree.getRoot()).printTree(),1024) : " is null")+ "\nLoaded file AST:\n"+ StringUtil.trimLog(DebugUtil.treeToString(fileElement,true),1024);
            throw new IllegalArgumentException(message);
          }
        }
  finally {
          criticalSection.done();
        }
      }
    }
  }
  return node;
}
