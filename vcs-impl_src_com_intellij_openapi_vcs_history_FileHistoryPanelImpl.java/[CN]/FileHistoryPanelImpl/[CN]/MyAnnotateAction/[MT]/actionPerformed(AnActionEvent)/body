{
  final VcsFileRevision revision=e.getData(VcsDataKeys.VCS_FILE_REVISION);
  final VirtualFile revisionVirtualFile=e.getData(VcsDataKeys.VCS_VIRTUAL_FILE);
  if ((revision == null) || (revisionVirtualFile == null))   return;
  final BackgroundableActionEnabledHandler handler=((ProjectLevelVcsManagerImpl)ProjectLevelVcsManager.getInstance(myProject)).getBackgroundableActionHandler(ProjectLevelVcsManagerImpl.MyBackgroundableActions.ANNOTATE);
  handler.register(key(revisionVirtualFile,revision));
  final Ref<FileAnnotation> fileAnnotationRef=new Ref<FileAnnotation>();
  final Ref<VcsException> exceptionRef=new Ref<VcsException>();
  ProgressManager.getInstance().run(new Task.Backgroundable(myProject,VcsBundle.message("retrieving.annotations"),true,BackgroundFromStartOption.getInstance()){
    public void run(    @NotNull ProgressIndicator indicator){
      try {
        fileAnnotationRef.set(myAnnotationProvider.annotate(revisionVirtualFile,revision));
      }
 catch (      VcsException e) {
        exceptionRef.set(e);
      }
    }
    @Override public void onCancel(){
      onSuccess();
    }
    @Override public void onSuccess(){
      handler.completed(key(revisionVirtualFile,revision));
      if (!exceptionRef.isNull()) {
        AbstractVcsHelper.getInstance(myProject).showError(exceptionRef.get(),VcsBundle.message("operation.name.annotate"));
      }
      if (fileAnnotationRef.isNull())       return;
      AbstractVcsHelper.getInstance(myProject).showAnnotation(fileAnnotationRef.get(),revisionVirtualFile);
    }
  }
);
}
