{
  ZipInputStream zis=new ZipInputStream(in);
  ZipOutputStream zos=new ZipOutputStream(out);
  ZipEntry e;
  try {
    while ((e=zis.getNextEntry()) != null) {
      String name=e.getName();
      if (!relpathToFile.containsKey(name)) {
        ZipEntry e2=new ZipEntry(name);
        e2.setMethod(e.getMethod());
        e2.setTime(e.getTime());
        e2.setComment(e.getComment());
        e2.setExtra(e.getExtra());
        if (e.getMethod() == ZipEntry.STORED) {
          e2.setSize(e.getSize());
          e2.setCrc(e.getCrc());
        }
        zos.putNextEntry(e2);
        FileUtil.copy(zis,zos);
      }
 else {
        final File file=relpathToFile.get(name);
        relpathToFile.remove(name);
        addFileToZip(zos,file,name,null,null);
      }
    }
    for (    final String path : relpathToFile.keySet()) {
      File file=relpathToFile.get(path);
      addFileToZip(zos,file,path,null,null);
    }
  }
  finally {
    zis.close();
    zos.close();
  }
}
