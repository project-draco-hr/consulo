{
  ZipInputStream zis=new ZipInputStream(in);
  ZipOutputStream zos=new ZipOutputStream(out);
  ZipEntry e;
  byte[] buf=new byte[1024];
  int n;
  while ((e=zis.getNextEntry()) != null) {
    String name=e.getName();
    if (!relpathToFile.containsKey(name)) {
      ZipEntry e2=new ZipEntry(name);
      e2.setMethod(e.getMethod());
      e2.setTime(e.getTime());
      e2.setComment(e.getComment());
      e2.setExtra(e.getExtra());
      if (e.getMethod() == ZipEntry.STORED) {
        e2.setSize(e.getSize());
        e2.setCrc(e.getCrc());
      }
      zos.putNextEntry(e2);
      while ((n=zis.read(buf,0,buf.length)) != -1) {
        zos.write(buf,0,n);
      }
    }
 else {
      final File file=relpathToFile.get(name);
      relpathToFile.remove(name);
      addFileToZip(zos,file,name,null,null);
    }
  }
  for (Iterator iterator=relpathToFile.keySet().iterator(); iterator.hasNext(); ) {
    String path=(String)iterator.next();
    File file=relpathToFile.get(path);
    addFileToZip(zos,file,path,null,null);
  }
  zis.close();
  zos.close();
}
