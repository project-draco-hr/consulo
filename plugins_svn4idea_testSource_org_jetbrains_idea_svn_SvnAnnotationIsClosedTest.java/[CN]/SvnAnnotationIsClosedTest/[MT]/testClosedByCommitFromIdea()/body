{
  final SubTree tree=new SubTree(myWorkingCopyDir);
  checkin();
  editFileInCommand(myProject,tree.myS1File,"1\n2\n3\n4\n");
  checkin();
  editFileInCommand(myProject,tree.myS1File,"1\n2\n3**\n4\n");
  checkin();
  final VcsAnnotationLocalChangesListener listener=ProjectLevelVcsManager.getInstance(myProject).getAnnotationLocalChangesListener();
  final FileAnnotation annotation=myVcs.getAnnotationProvider().annotate(tree.myS1File);
  annotation.setCloser(new Runnable(){
    @Override public void run(){
      myIsClosed=true;
      listener.unregisterAnnotation(tree.myS1File,annotation);
    }
  }
);
  listener.registerAnnotation(tree.myS1File,annotation);
  editFileInCommand(myProject,tree.myS1File,"1\n2\n3**\n4++\n");
  Assert.assertFalse(myIsClosed);
  myDirtyScopeManager.markEverythingDirty();
  myChangeListManager.ensureUpToDate(false);
  final Change change=myChangeListManager.getChange(tree.myS1File);
  Assert.assertNotNull(change);
  final List<VcsException> exceptions=myVcs.getCheckinEnvironment().commit(Collections.singletonList(change),"commit");
  Assert.assertTrue(exceptions == null || exceptions.isEmpty());
  myDirtyScopeManager.fileDirty(tree.myS1File);
  myChangeListManager.ensureUpToDate(false);
  myChangeListManager.ensureUpToDate(false);
  sleep(100);
  Assert.assertTrue(myIsClosed);
}
