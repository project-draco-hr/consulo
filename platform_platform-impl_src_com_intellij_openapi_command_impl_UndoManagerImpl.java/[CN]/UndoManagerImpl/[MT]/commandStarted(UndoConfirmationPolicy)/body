{
  if (myCommandLevel == 0) {
    myCurrentMerger=new CommandMerger(this,CommandProcessor.getInstance().isUndoTransparentActionInProgress());
  }
  LOG.assertTrue(myCurrentMerger != null,String.valueOf(myCommandLevel));
  myCurrentMerger.setBeforeState(getCurrentState());
  myCurrentMerger.mergeUndoConfirmationPolicy(undoConfirmationPolicy);
  if (myProject != null) {
    if (ApplicationManager.getApplication().isUnitTestMode()) {
      myOriginalEditor=PlatformDataKeys.EDITOR.getData(DataManager.getInstance().getDataContext());
    }
 else {
      Component component=WindowManagerEx.getInstanceEx().getFocusedComponent(myProject);
      if (component != null) {
        myOriginalEditor=PlatformDataKeys.EDITOR.getData(DataManager.getInstance().getDataContext(component));
      }
    }
  }
  myCommandLevel++;
}
