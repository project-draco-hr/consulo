{
  myCurrentEditorProvider=new FocusBasedCurrentEditorProvider();
  myCommandListener=new CommandAdapter(){
    private boolean myFakeCommandStarted=false;
    public void commandStarted(    CommandEvent event){
      onCommandStarted(event.getProject(),event.getUndoConfirmationPolicy());
    }
    public void commandFinished(    CommandEvent event){
      onCommandFinished(event.getProject(),event.getCommandName(),event.getCommandGroupId());
    }
    public void undoTransparentActionStarted(){
      if (!isInsideCommand()) {
        myFakeCommandStarted=true;
        onCommandStarted(myProject,UndoConfirmationPolicy.DEFAULT);
      }
    }
    public void undoTransparentActionFinished(){
      if (myFakeCommandStarted) {
        myFakeCommandStarted=false;
        onCommandFinished(myProject,"",null);
      }
    }
  }
;
  myCommandProcessor.addCommandListener(myCommandListener);
  myDocumentEditingUndoProvider=new DocumentEditingUndoProvider(myProject,myEditorFactory);
  myMerger=new CommandMerger(this,myEditorFactory);
  if (myProject != null) {
    myUndoProviders=Extensions.getExtensions(UndoProvider.PROJECT_EP_NAME,myProject);
  }
 else {
    myUndoProviders=Extensions.getExtensions(UndoProvider.EP_NAME);
  }
  myBeforeFileDeletionListener=new MyBeforeDeletionListener();
  myVirtualFileManager.addVirtualFileListener(myBeforeFileDeletionListener);
}
