{
  myCurrentOperationState=isUndo ? UNDO : REDO;
  final RuntimeException[] exception=new RuntimeException[1];
  Runnable executeUndoOrRedoAction=new Runnable(){
    public void run(){
      try {
        if (myProject != null) {
          PsiDocumentManager.getInstance(myProject).commitAllDocuments();
        }
        CopyPasteManager.getInstance().stopKillRings();
        myMerger.undoOrRedo(editor,isUndo);
      }
 catch (      RuntimeException ex) {
        exception[0]=ex;
      }
 finally {
        myCurrentOperationState=NONE;
      }
    }
  }
;
  String name=getUndoOrRedoActionNameAndDescription(editor,isUndoInProgress()).second;
  CommandProcessor.getInstance().executeCommand(myProject,executeUndoOrRedoAction,name,null,myMerger.getUndoConfirmationPolicy());
  if (exception[0] != null)   throw exception[0];
}
