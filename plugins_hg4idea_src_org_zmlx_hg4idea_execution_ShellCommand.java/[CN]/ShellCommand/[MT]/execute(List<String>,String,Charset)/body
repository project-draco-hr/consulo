{
  if (commandLine == null || commandLine.isEmpty()) {
    throw new IllegalArgumentException("commandLine is empty");
  }
  if (myRunViaBash) {
    StringBuilder hgCommandBuilder=new StringBuilder();
    for (    String command : commandLine) {
      hgCommandBuilder.append(escapeSpacesIfNeeded(command));
      hgCommandBuilder.append(" ");
    }
    String hgCommand=escapeBashControlCharacters(hgCommandBuilder.toString());
    commandLine=new ArrayList<String>(3);
    commandLine.add("bash");
    commandLine.add("-cl");
    commandLine.add(hgCommand);
  }
  StringWriter out=new StringWriter();
  StringWriter err=new StringWriter();
  try {
    ProcessBuilder processBuilder=new ProcessBuilder(commandLine);
    if (dir != null) {
      processBuilder=processBuilder.directory(new File(dir));
    }
    Process process=processBuilder.start();
    CapturingProcessHandler processHandler=new CapturingProcessHandler(process,charset);
    final ProcessOutput processOutput=processHandler.runProcess();
    int exitValue=processOutput.getExitCode();
    out.write(processOutput.getStdout());
    err.write(processOutput.getStderr());
    return new HgCommandResult(out,err,exitValue);
  }
 catch (  IOException e) {
    throw new ShellCommandException(e);
  }
}
