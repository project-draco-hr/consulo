{
  if (elem != null && (elem instanceof PsiDirectory || belongsToScope(elem))) {
    if (!elem.isValid())     return null;
    RefElement ref=getFromRefTable(elem);
    if (ref == null) {
      if (!isValidPointForReference()) {
        return null;
      }
      final RefElementImpl refElement=ApplicationManager.getApplication().runReadAction(new Computable<RefElementImpl>(){
        @Nullable public RefElementImpl compute(){
          final RefManagerExtension extension=getExtension(elem.getLanguage());
          if (extension != null) {
            final RefElement refElement=extension.createRefElement(elem);
            if (refElement != null)             return (RefElementImpl)refElement;
          }
          if (elem instanceof PsiFile) {
            return new RefFileImpl((PsiFile)elem,RefManagerImpl.this);
          }
 else           if (elem instanceof PsiDirectory) {
            return new RefDirectoryImpl((PsiDirectory)elem,RefManagerImpl.this);
          }
 else {
            return null;
          }
        }
      }
);
      if (refElement == null)       return null;
      putToRefTable(elem,refElement);
      ApplicationManager.getApplication().runReadAction(new Runnable(){
        public void run(){
          refElement.initialize();
        }
      }
);
      return refElement;
    }
    return ref;
  }
  return null;
}
