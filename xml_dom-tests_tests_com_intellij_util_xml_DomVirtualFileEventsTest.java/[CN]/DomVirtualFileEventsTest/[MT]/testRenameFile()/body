{
  new WriteCommandAction.Simple(getProject()){
    @Override protected void run() throws Throwable {
      final VirtualFile dir=getVirtualFile(createTempDirectory());
      PsiTestUtil.addSourceContentToRoots(getModule(),dir);
      final VirtualFile data=dir.createChildData(this,"abc.xml");
      VfsUtil.saveText(data,"<a/>");
      final DomFileElementImpl<DomElement> fileElement=getFileElement(data);
      assertEventCount(0);
      assertResultsAndClear();
      data.rename(this,"deaf.xml");
      assertEventCount(1);
      putExpected(new DomEvent(fileElement,false));
      assertResultsAndClear();
      assertEquals(fileElement,getFileElement(data));
      assertTrue(fileElement.isValid());
      data.rename(this,"fff.xml");
      assertEventCount(1);
      putExpected(new DomEvent(fileElement,false));
      assertResultsAndClear();
      assertNull(getFileElement(data));
      assertFalse(fileElement.isValid());
    }
  }
.execute().throwException();
}
