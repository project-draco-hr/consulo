{
  TextRange dirtyTextRange=FileStatusMap.getDirtyTextRange(editor,Pass.UPDATE_ALL);
  if (dirtyTextRange == null)   return null;
  int startOffset=dirtyTextRange.getStartOffset();
  int endOffset=dirtyTextRange.getEndOffset();
  Rectangle rect=editor.getScrollingModel().getVisibleArea();
  LogicalPosition startPosition=editor.xyToLogicalPosition(new Point(rect.x,rect.y));
  int visibleStart=editor.logicalPositionToOffset(startPosition);
  if (visibleStart > startOffset) {
    startOffset=visibleStart;
  }
  LogicalPosition endPosition=editor.xyToLogicalPosition(new Point(rect.x + rect.width,rect.y + rect.height));
  int visibleEnd=editor.logicalPositionToOffset(new LogicalPosition(endPosition.line + 1,0));
  if (visibleEnd < endOffset) {
    endOffset=visibleEnd;
  }
  if (startOffset >= endOffset) {
    return null;
  }
  TextRange textRange=new TextRange(startOffset,endOffset);
  if (textRange.equals(dirtyTextRange)) {
    return null;
  }
  return textRange;
}
