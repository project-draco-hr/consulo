{
  final Project project=getProject(e);
  if (project == null) {
    return;
  }
  final AddModuleWizard wizard=new AddModuleWizard(project,new ModulesProvider(){
    public Module[] getModules(){
      return ModuleManager.getInstance(project).getModules();
    }
    public Module getModule(    String name){
      return ModuleManager.getInstance(project).findModuleByName(name);
    }
    public ModuleRootModel getRootModel(    Module module){
      return ModuleRootManager.getInstance(module);
    }
  }
);
  wizard.show();
  if (wizard.isOK()) {
    final ModuleBuilder moduleBuilder=wizard.getModuleBuilder();
    Exception ex=ApplicationManager.getApplication().runWriteAction(new Computable<Exception>(){
      public Exception compute(){
        try {
          final ModifiableModuleModel moduleModel=ModuleManager.getInstance(project).getModifiableModel();
          final Module module=moduleBuilder.createModule(moduleModel);
          if (module != null) {
            moduleModel.commitAssertingNoCircularDependency();
          }
          return null;
        }
 catch (        Exception e) {
          return e;
        }
      }
    }
);
    if (ex != null) {
      if (ex instanceof LoadCancelledException) {
        LoadCancelledException cancelled=(LoadCancelledException)ex;
        Messages.showInfoMessage("Creation of module was cancelled by component: " + cancelled.getIssuer().getComponentName() + "\n"+ "Reason is: "+ cancelled.getMessage(),"Module Was Not Created");
      }
 else {
        Messages.showErrorDialog("Error adding module to project: " + ex.getMessage(),"New Module");
      }
    }
  }
}
