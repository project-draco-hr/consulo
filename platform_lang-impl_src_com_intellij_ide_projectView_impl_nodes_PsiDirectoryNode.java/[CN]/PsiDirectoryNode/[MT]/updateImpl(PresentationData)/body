{
  final Project project=getProject();
  final PsiDirectory psiDirectory=getValue();
  final VirtualFile directoryFile=psiDirectory.getVirtualFile();
  if (ProjectRootsUtil.isModuleContentRoot(directoryFile,project)) {
    ProjectFileIndex fi=ProjectRootManager.getInstance(project).getFileIndex();
    Module module=fi.getModuleForFile(directoryFile);
    data.setPresentableText(directoryFile.getName());
    if (module != null) {
      StringBuilder location=new StringBuilder();
      if (getParentValue() instanceof Project) {
        location.append(directoryFile.getPresentableUrl());
      }
      if (!Comparing.equal(module.getName(),directoryFile.getName())) {
        if (location.length() > 0) {
          location.append(", ");
        }
        location.append("Module '").append(module.getName()).append("'");
      }
      if (location.length() > 0) {
        data.setLocationString(location.toString());
      }
      setupIcon(data,psiDirectory);
      return;
    }
  }
  final String name=getParentValue() instanceof Project ? psiDirectory.getVirtualFile().getPresentableUrl() : ProjectViewDirectoryHelper.getInstance(psiDirectory.getProject()).getNodeName(getSettings(),getParentValue(),psiDirectory);
  if (name == null) {
    setValue(null);
    return;
  }
  data.setPresentableText(name);
  if (ProjectRootsUtil.isModuleContentRoot(directoryFile,project) || ProjectRootsUtil.isLibraryRoot(directoryFile,project)) {
    final String locationString=directoryFile.getPresentableUrl();
    if (!locationString.equals(name)) {
      data.setLocationString(locationString);
    }
  }
 else {
    data.setLocationString(ProjectViewDirectoryHelper.getInstance(project).getLocationString(psiDirectory));
  }
  setupIcon(data,psiDirectory);
}
