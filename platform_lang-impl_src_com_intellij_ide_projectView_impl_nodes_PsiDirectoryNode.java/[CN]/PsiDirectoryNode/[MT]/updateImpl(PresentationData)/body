{
  final Project project=getProject();
  final PsiDirectory psiDirectory=getValue();
  final VirtualFile directoryFile=psiDirectory.getVirtualFile();
  final Object parentValue=getParentValue();
  if (ProjectRootsUtil.isModuleContentRoot(directoryFile,project)) {
    ProjectFileIndex fi=ProjectRootManager.getInstance(project).getFileIndex();
    Module module=fi.getModuleForFile(directoryFile);
    data.setPresentableText(directoryFile.getName());
    if (module != null) {
      if (!(parentValue instanceof Module)) {
        if (!shouldShowModuleName()) {
          data.addText(directoryFile.getName() + " ",SimpleTextAttributes.REGULAR_ATTRIBUTES);
        }
 else         if (Comparing.equal(module.getName(),directoryFile.getName())) {
          data.addText(directoryFile.getName(),SimpleTextAttributes.REGULAR_BOLD_ATTRIBUTES);
        }
 else {
          data.addText(directoryFile.getName() + " ",SimpleTextAttributes.REGULAR_ATTRIBUTES);
          data.addText("[" + module.getName() + "]",SimpleTextAttributes.REGULAR_BOLD_ATTRIBUTES);
        }
      }
 else {
        data.addText(directoryFile.getName(),SimpleTextAttributes.REGULAR_ATTRIBUTES);
      }
      final boolean canAttach=ProjectAttachProcessor.canAttachToProject();
      if (parentValue instanceof Project && !canAttach) {
        final String location=FileUtil.getLocationRelativeToUserHome(((Project)parentValue).getPresentableUrl());
        data.addText(" (" + location + ")",SimpleTextAttributes.GRAYED_ATTRIBUTES);
      }
 else       if (parentValue instanceof Module || (parentValue instanceof Project && canAttach)) {
        data.addText(" (" + directoryFile.getPresentableUrl() + ")",SimpleTextAttributes.GRAYED_ATTRIBUTES);
      }
 else       if (ProjectRootsUtil.isSourceOrTestRoot(directoryFile,project)) {
        if (ProjectRootsUtil.isInTestSource(directoryFile,project)) {
          data.addText(" (test source root)",SimpleTextAttributes.GRAY_ATTRIBUTES);
        }
 else {
          data.addText(" (source root)",SimpleTextAttributes.GRAY_ATTRIBUTES);
        }
      }
      setupIcon(data,psiDirectory);
      return;
    }
  }
  final String name=parentValue instanceof Project ? psiDirectory.getVirtualFile().getPresentableUrl() : ProjectViewDirectoryHelper.getInstance(psiDirectory.getProject()).getNodeName(getSettings(),parentValue,psiDirectory);
  if (name == null) {
    setValue(null);
    return;
  }
  data.setPresentableText(name);
  if (ProjectRootsUtil.isLibraryRoot(directoryFile,project)) {
    data.setLocationString("library home");
  }
 else {
    data.setLocationString(ProjectViewDirectoryHelper.getInstance(project).getLocationString(psiDirectory));
  }
  setupIcon(data,psiDirectory);
}
