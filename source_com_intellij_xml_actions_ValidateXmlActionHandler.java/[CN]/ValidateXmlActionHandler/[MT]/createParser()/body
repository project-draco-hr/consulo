{
  try {
    if (!needsDtdChecking() && !needsSchemaChecking() && !forceChecking) {
      return null;
    }
    SAXParserFactory factory=new SAXParserFactoryImpl();
    boolean schemaChecking=false;
    if (hasDtdDeclaration()) {
      factory.setValidating(true);
    }
 else     if (needsSchemaChecking()) {
      factory.setValidating(true);
      factory.setNamespaceAware(true);
      schemaChecking=true;
    }
    SAXParser parser=factory.newSAXParser();
    parser.setProperty("http://apache.org/xml/properties/internal/entity-resolver",myXmlResourceResolver);
    XMLGrammarPoolImpl myGrammarPool=myFile.getUserData(GRAMMARS_KEY);
    if (myGrammarPool == null) {
      myGrammarPool=new XMLGrammarPoolImpl();
      myFile.putUserData(GRAMMARS_KEY,myGrammarPool);
    }
    parser.getXMLReader().setProperty(GRAMMAR_FEATURE_ID,myGrammarPool);
    if (schemaChecking) {
      parser.setProperty(JAXPConstants.JAXP_SCHEMA_LANGUAGE,JAXPConstants.W3C_XML_SCHEMA);
      parser.getXMLReader().setFeature(SCHEMA_FULL_CHECKING_FEATURE_ID,true);
    }
    return parser;
  }
 catch (  Exception e) {
    filterAppException(e);
  }
  return null;
}
