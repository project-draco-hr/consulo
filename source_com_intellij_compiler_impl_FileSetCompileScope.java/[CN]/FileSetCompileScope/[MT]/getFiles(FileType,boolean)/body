{
  final Set<VirtualFile> files=new HashSet<VirtualFile>();
  final FileTypeManager typeManager=FileTypeManager.getInstance();
  for (Iterator<VirtualFile> it=myRootFiles.iterator(); it.hasNext(); ) {
    VirtualFile file=it.next();
    if (!file.isValid()) {
      it.remove();
      continue;
    }
    if (file.isDirectory()) {
      addRecursively(files,file,fileType);
    }
 else {
      if (fileType == null || fileType.equals(typeManager.getFileTypeByFile(file))) {
        files.add(file);
      }
    }
  }
  return files.toArray(new VirtualFile[files.size()]);
}
