{
  final Project project=e.getData(DataKeys.PROJECT);
  final ShelvedChangeList[] changeLists=e.getData(ShelvedChangesViewManager.SHELVED_CHANGELIST_KEY);
  List<ShelvedChange> changes=e.getData(ShelvedChangesViewManager.SHELVED_CHANGE_KEY);
  List<ShelvedBinaryFile> binaryFiles=e.getData(ShelvedChangesViewManager.SHELVED_BINARY_FILE_KEY);
  if (changes != null && binaryFiles != null && changes.size() == 0 && binaryFiles.size() == 0) {
    changes=null;
    binaryFiles=null;
  }
  LOG.assertTrue(changeLists != null);
  final ChangeListManager changeListManager=ChangeListManager.getInstance(project);
  final List<LocalChangeList> allChangeLists=changeListManager.getChangeLists();
  final LocalChangeList defaultChangeList=changeListManager.getDefaultChangeList();
  String defaultName=changeLists.length == 1 ? changeLists[0].DESCRIPTION : null;
  ChangeListChooser chooser=new ChangeListChooser(project,allChangeLists,defaultChangeList,VcsBundle.message("unshelve.changelist.chooser.title"),defaultName);
  chooser.show();
  if (!chooser.isOK()) {
    return;
  }
  FileDocumentManager.getInstance().saveAllDocuments();
  List<FilePath> unshelvedFiles=new ArrayList<FilePath>();
  for (  ShelvedChangeList changeList : changeLists) {
    final List<FilePath> result=ShelveChangesManager.getInstance(project).unshelveChangeList(changeList,changes,binaryFiles);
    if (result == null) {
      break;
    }
    unshelvedFiles.addAll(result);
  }
  if (chooser.getSelectedList() != changeListManager.getDefaultChangeList()) {
    changeListManager.ensureUpToDate(false);
    List<Change> unshelvedChanges=new ArrayList<Change>();
    for (    FilePath file : unshelvedFiles) {
      final Change change=changeListManager.getChange(file);
      if (change != null) {
        unshelvedChanges.add(change);
      }
    }
    changeListManager.moveChangesTo(chooser.getSelectedList(),unshelvedChanges.toArray(new Change[unshelvedChanges.size()]));
  }
}
