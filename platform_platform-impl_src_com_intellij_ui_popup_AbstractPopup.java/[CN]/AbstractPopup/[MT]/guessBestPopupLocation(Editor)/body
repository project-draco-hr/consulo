{
  RelativePoint preferredLocation=JBPopupFactory.getInstance().guessBestPopupLocation(editor);
  if (myDimensionServiceKey == null) {
    return preferredLocation;
  }
  Dimension preferredSize=DimensionService.getInstance().getSize(myDimensionServiceKey,myProject);
  if (preferredSize == null) {
    return preferredLocation;
  }
  Rectangle preferredBounds=new Rectangle(preferredLocation.getScreenPoint(),preferredSize);
  Rectangle adjustedBounds=new Rectangle(preferredBounds);
  ScreenUtil.moveRectangleToFitTheScreen(adjustedBounds);
  if (preferredBounds.y - adjustedBounds.y <= 0) {
    return preferredLocation;
  }
  int adjustedY=preferredBounds.y - editor.getLineHeight() - preferredSize.height;
  if (adjustedY < 0) {
    return preferredLocation;
  }
  Point point=new Point(preferredBounds.x,adjustedY);
  Component component=preferredLocation.getComponent();
  if (component == null) {
    return RelativePoint.fromScreen(point);
  }
  SwingUtilities.convertPointFromScreen(point,component);
  return new RelativePoint(component,point);
}
