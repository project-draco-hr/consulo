{
  RelativePoint preferredLocation=JBPopupFactory.getInstance().guessBestPopupLocation(editor);
  if (myDimensionServiceKey == null) {
    return preferredLocation;
  }
  Dimension preferredSize=DimensionService.getInstance().getSize(myDimensionServiceKey,myProject);
  if (preferredSize == null) {
    return preferredLocation;
  }
  Rectangle preferredBounds=new Rectangle(preferredLocation.getScreenPoint(),preferredSize);
  Rectangle adjustedBounds=new Rectangle(preferredBounds);
  ScreenUtil.moveRectangleToFitTheScreen(adjustedBounds);
  if (preferredBounds.y - adjustedBounds.y <= 0) {
    return preferredLocation;
  }
  int adjustedY=preferredBounds.y - editor.getLineHeight() * 3 / 2 - preferredSize.height;
  return adjustedY >= 0 ? RelativePoint.fromScreen(new Point(preferredBounds.x,adjustedY)) : preferredLocation;
}
