{
  if (isDisposed())   return;
  final Runnable finalRunnable=myFinalRunnable;
  final IdeFocusManager focusManager=IdeFocusManager.findInstanceByComponent(myOwner);
  if (myPopup != null) {
    if (!canClose()) {
      return;
    }
    storeDimensionSize(myContent.getSize());
    if (myUseDimServiceForXYLocation) {
      final JRootPane root=myComponent.getRootPane();
      if (root != null) {
        final Container popupWindow=root.getParent();
        if (popupWindow != null && popupWindow.isShowing()) {
          storeLocation(popupWindow.getLocationOnScreen());
        }
      }
    }
    if (e instanceof MouseEvent) {
      JBAwtEventQueue.getInstance().blockNextEvents(((MouseEvent)e));
    }
    myPopup.hide(false);
    if (ApplicationManagerEx.getApplicationEx() != null) {
      StackingPopupDispatcher.getInstance().onPopupHidden(this);
    }
    if (myInStack) {
      myFocusTrackback.restoreFocus();
    }
    disposePopup();
    if (myListeners != null) {
      for (      JBPopupListener each : myListeners) {
        each.onClosed(new LightweightWindowEvent(this));
      }
    }
  }
  Disposer.dispose(this,false);
  if (finalRunnable != null) {
    SwingUtilities.invokeLater(new Runnable(){
      public void run(){
        focusManager.doWhenFocusSettlesDown(finalRunnable);
      }
    }
);
  }
}
