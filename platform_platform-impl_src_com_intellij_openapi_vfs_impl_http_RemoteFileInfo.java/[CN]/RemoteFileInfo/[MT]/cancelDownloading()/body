{
  FileDownloadingListener[] listeners;
synchronized (myLock) {
    myCancelled.set(true);
    if (myPrevLocalFile != null) {
      myLocalVirtualFile=myPrevLocalFile;
      myLocalFile=VfsUtil.virtualToIoFile(myLocalVirtualFile);
      myState=RemoteFileState.DOWNLOADED;
      myErrorMessage=null;
    }
 else {
      myState=RemoteFileState.ERROR_OCCURRED;
    }
    listeners=myListeners.toArray(new FileDownloadingListener[myListeners.size()]);
  }
  for (  FileDownloadingListener listener : listeners) {
    listener.downloadingCancelled();
  }
}
