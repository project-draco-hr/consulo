{
  Map<File,Set<ExportableComponent>> fileToComponents=new HashMap<File,Set<ExportableComponent>>();
  final List<ExportableComponent> components=new ArrayList<ExportableComponent>(Arrays.asList(ApplicationManager.getApplication().getComponents(ExportableApplicationComponent.class)));
  final ExportableBean[] exportableBeans=Extensions.getExtensions(ExportableComponent.EXTENSION_POINT);
  for (  ExportableBean exportableBean : exportableBeans) {
    final String serviceClass=exportableBean.serviceInterface;
    if (serviceClass == null) {
      LOG.error("Service interface not specified in " + ExportableComponent.EXTENSION_POINT);
      continue;
    }
    try {
      final Class<?> aClass=Class.forName(serviceClass,true,exportableBean.getPluginDescriptor().getPluginClassLoader());
      final Object service=ServiceManager.getService(aClass);
      if (service == null) {
        LOG.error("Can't find service: " + serviceClass);
        continue;
      }
      if (!(service instanceof ExportableComponent)) {
        LOG.error("Service " + serviceClass + " is registered in exportable EP, but doesn't implement ExportableApplicationComponent");
        continue;
      }
      components.add((ExportableComponent)service);
    }
 catch (    ClassNotFoundException e) {
      LOG.error(e);
    }
  }
  for (  ExportableComponent component : components) {
    exportableComponents.add(component);
    final File[] exportFiles=component.getExportFiles();
    for (    File exportFile : exportFiles) {
      Set<ExportableComponent> componentsTied=fileToComponents.get(exportFile);
      if (componentsTied == null) {
        componentsTied=new HashSet<ExportableComponent>();
        fileToComponents.put(exportFile,componentsTied);
      }
      componentsTied.add(component);
    }
  }
  return fileToComponents;
}
