{
  long started=System.currentTimeMillis();
  final BitSet idSet=new BitSet();
  ContentIterator iterator=new ContentIterator(){
    @Override public boolean processFile(    VirtualFile fileOrDir){
      idSet.set(((VirtualFileWithId)fileOrDir).getId());
      ProgressManager.checkCanceled();
      return true;
    }
  }
;
  if (!includeNonProjectItems) {
    ProjectRootManager.getInstance(project).getFileIndex().iterateContent(iterator);
  }
 else {
    FileBasedIndex.getInstance().iterateIndexableFiles(iterator,project,null);
  }
  if (LOGGER.isDebugEnabled()) {
    LOGGER.debug("Done filter " + (System.currentTimeMillis() - started) + ":"+ idSet.size());
  }
  return new IdFilter(){
    @Override public boolean contains(    int id){
      return idSet.get(id);
    }
  }
;
}
