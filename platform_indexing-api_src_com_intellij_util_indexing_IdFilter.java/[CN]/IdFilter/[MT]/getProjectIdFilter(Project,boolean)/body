{
  long started=System.currentTimeMillis();
  final BitSet idSet=new BitSet();
  ContentIterator iterator=new ContentIterator(){
    @Override public boolean processFile(    VirtualFile fileOrDir){
      int id=((VirtualFileWithId)fileOrDir).getId();
      if (id < 0)       id=-id;
      idSet.set(id);
      ProgressManager.checkCanceled();
      return true;
    }
  }
;
  if (!includeNonProjectItems) {
    ProjectRootManager.getInstance(project).getFileIndex().iterateContent(iterator);
  }
 else {
    FileBasedIndex.getInstance().iterateIndexableFiles(iterator,project,null);
  }
  if (LOGGER.isDebugEnabled()) {
    LOGGER.debug("Done filter " + (System.currentTimeMillis() - started) + ":"+ idSet.size());
  }
  return new IdFilter(){
    @Override public boolean containsFileId(    int id){
      return id >= 0 && idSet.get(id);
    }
  }
;
}
