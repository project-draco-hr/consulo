{
  XmlTag[] myCachedScriptTags=element.getUserData(CachedScriptTagsKey);
  if (myCachedScriptTags == null) {
    final List<XmlTag> scriptTags=new ArrayList<XmlTag>();
    XmlUtil.processXmlElements(HtmlUtil.getRealXmlDocument(element.getDocument()),new PsiElementProcessor(){
      public boolean execute(      final PsiElement element){
        if (element instanceof XmlTag) {
          final XmlElementDescriptor descriptor=((XmlTag)element).getDescriptor();
          if (descriptor != null && SCRIPT_TAG.equals(descriptor.getName())) {
            scriptTags.add((XmlTag)element);
          }
        }
        return true;
      }
    }
,true);
    myCachedScriptTags=scriptTags.toArray(new XmlTag[scriptTags.size()]);
    element.putUserData(CachedScriptTagsKey,myCachedScriptTags);
  }
  if (element.getUserData(ProcessingDeclarationsKey) != null)   return true;
  try {
    element.putUserData(ProcessingDeclarationsKey,"");
    for (    XmlTag tag : myCachedScriptTags) {
      final XmlTagChild[] children=tag.getValue().getChildren();
      for (      XmlTagChild child : children) {
        if (!child.processDeclarations(processor,substitutor,null,place))         return false;
      }
      if (tag.getAttributeValue("src") != null) {
        final XmlAttribute attribute=tag.getAttribute("src",null);
        if (attribute != null) {
          final XmlAttributeValue valueElement=attribute.getValueElement();
          if (valueElement != null) {
            final PsiReference[] references=valueElement.getReferences();
            if (references.length > 0) {
              final PsiElement psiElement=references[references.length - 1].resolve();
              if (psiElement instanceof PsiFile) {
                if (!psiElement.processDeclarations(processor,substitutor,null,place))                 return false;
              }
            }
          }
        }
      }
    }
  }
  finally {
    element.putUserData(ProcessingDeclarationsKey,null);
  }
  return true;
}
