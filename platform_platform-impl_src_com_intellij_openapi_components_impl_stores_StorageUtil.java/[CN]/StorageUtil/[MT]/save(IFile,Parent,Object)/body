{
  final VirtualFile[] result=new VirtualFile[1];
  final String filePath=file.getCanonicalPath();
  try {
    final Ref<IOException> refIOException=Ref.create(null);
    final Pair<String,String> pair=loadFile(file);
    final byte[] text=JDOMUtil.writeParent(element,pair.second).getBytes(CharsetToolkit.UTF8);
    if (file.exists()) {
      if (new String(text).equals(pair.first))       return null;
      IFile backupFile=deleteBackup(filePath);
      file.renameTo(backupFile);
    }
    ApplicationManager.getApplication().runWriteAction(new DocumentRunnable.IgnoreDocumentRunnable(){
      public void run(){
        if (!file.exists()) {
          file.createParentDirs();
        }
        try {
          final VirtualFile virtualFile=getOrCreateVirtualFile(requestor,file);
          virtualFile.setBinaryContent(text,-1,-1,requestor);
          result[0]=virtualFile;
        }
 catch (        IOException e) {
          refIOException.set(e);
        }
        deleteBackup(filePath);
      }
    }
);
    if (refIOException.get() != null) {
      throw new StateStorageException(refIOException.get());
    }
  }
 catch (  IOException e) {
    throw new StateStorageException(e);
  }
  return result[0];
}
