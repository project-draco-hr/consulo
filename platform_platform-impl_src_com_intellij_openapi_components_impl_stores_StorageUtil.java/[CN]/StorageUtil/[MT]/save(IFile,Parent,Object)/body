{
  final String filePath=file.getCanonicalPath();
  try {
    final Ref<IOException> refIOException=Ref.create(null);
    final Pair<String,String> pair=loadFile(file);
    final byte[] text=JDOMUtil.writeParent(element,pair.second).getBytes(CharsetToolkit.UTF8);
    if (file.exists()) {
      if (new String(text).equals(pair.first))       return;
      IFile backupFile=deleteBackup(filePath);
      file.renameTo(backupFile);
    }
    ApplicationManager.getApplication().runWriteAction(new Runnable(){
      public void run(){
        if (!file.exists()) {
          file.createParentDirs();
        }
        try {
          final VirtualFile virtualFile=getOrCreateVirtualFile(requestor,file);
          OutputStream outputStream=null;
          try {
            outputStream=virtualFile.getOutputStream(requestor);
            outputStream.write(text);
            outputStream.flush();
          }
  finally {
            if (outputStream != null)             outputStream.close();
          }
        }
 catch (        IOException e) {
          refIOException.set(e);
        }
        deleteBackup(filePath);
      }
    }
);
    if (refIOException.get() != null) {
      throw new StateStorage.StateStorageException(refIOException.get());
    }
  }
 catch (  IOException e) {
    throw new StateStorage.StateStorageException(e);
  }
}
