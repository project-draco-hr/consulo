{
  final Set<JpsModule> result=new HashSet<JpsModule>();
  new Object(){
    final Set<JpsModule> processed=new HashSet<JpsModule>();
    void traverse(    JpsModule module,    JpsJavaClasspathKind kind,    Collection<JpsModule> result,    boolean exportedOnly){
      if (processed.add(module)) {
        for (        JpsDependencyElement item : JpsJavaExtensionService.getInstance().getDependencies(module,kind,exportedOnly)) {
          if (item instanceof JpsModuleSourceDependency) {
            result.add(module);
          }
 else           if (item instanceof JpsModuleDependency) {
            traverse(((JpsModuleDependency)item).getModule(),kind,result,true);
          }
        }
      }
    }
  }
.traverse(module,kind,result,false);
  return result;
}
