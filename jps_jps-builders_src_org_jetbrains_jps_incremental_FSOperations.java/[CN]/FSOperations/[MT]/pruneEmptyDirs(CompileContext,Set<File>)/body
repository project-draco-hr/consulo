{
  Set<File> doNotDelete=ALL_OUTPUTS_KEY.get(context);
  if (doNotDelete == null) {
    doNotDelete=new THashSet<File>(FileUtil.FILE_HASHING_STRATEGY);
    for (    BuildTarget<?> target : context.getProjectDescriptor().getBuildTargetIndex().getAllTargets()) {
      doNotDelete.addAll(target.getOutputRoots(context));
    }
    ALL_OUTPUTS_KEY.set(context,doNotDelete);
  }
  Set<File> additionalDirs=null;
  Set<File> toDelete=dirsToDelete;
  while (toDelete != null) {
    for (    File file : toDelete) {
      final boolean deleted=file.delete();
      if (deleted) {
        final File parentFile=file.getParentFile();
        if (parentFile != null && !doNotDelete.contains(parentFile)) {
          if (additionalDirs == null) {
            additionalDirs=new THashSet<File>(FileUtil.FILE_HASHING_STRATEGY);
          }
          additionalDirs.add(parentFile);
        }
      }
    }
    toDelete=additionalDirs;
    additionalDirs=null;
  }
}
