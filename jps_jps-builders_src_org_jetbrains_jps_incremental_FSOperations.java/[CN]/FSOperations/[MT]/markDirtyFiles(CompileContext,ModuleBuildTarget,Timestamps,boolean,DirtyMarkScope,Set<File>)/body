{
  final ModuleRootsIndex rootsIndex=context.getProjectDescriptor().rootsIndex;
  final Set<File> excludes=new HashSet<File>(rootsIndex.getModuleExcludes(target.getModule()));
  final Collection<RootDescriptor> roots=new ArrayList<RootDescriptor>();
  for (  RootDescriptor rd : rootsIndex.getModuleRoots(context,target.getModule())) {
    roots.add(rd);
  }
  for (  RootDescriptor rd : roots) {
    if (scope == DirtyMarkScope.TESTS) {
      if (!rd.isTestRoot) {
        continue;
      }
    }
 else     if (scope == DirtyMarkScope.PRODUCTION) {
      if (rd.isTestRoot) {
        continue;
      }
    }
    if (!rd.root.exists()) {
      continue;
    }
    context.getProjectDescriptor().fsState.clearRecompile(rd);
    traverseRecursively(context,rd,rd.root,excludes,tsStorage,forceMarkDirty,currentFiles);
  }
}
