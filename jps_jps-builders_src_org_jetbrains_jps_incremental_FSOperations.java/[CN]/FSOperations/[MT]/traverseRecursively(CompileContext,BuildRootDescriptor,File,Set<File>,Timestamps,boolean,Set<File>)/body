{
  final File[] children=file.listFiles();
  if (children != null) {
    if (children.length > 0 && !JpsPathUtil.isUnder(excludes,file)) {
      for (      File child : children) {
        traverseRecursively(context,rd,child,excludes,tsStorage,forceDirty,currentFiles);
      }
    }
  }
 else {
    boolean markDirty=forceDirty;
    if (!markDirty) {
      markDirty=tsStorage.getStamp(file,rd.getTarget()) != FileSystemUtil.lastModified(file);
    }
    if (markDirty) {
      final Timestamps marker=context.isProjectRebuild() ? null : tsStorage;
      context.getProjectDescriptor().fsState.markDirty(context,file,rd,marker,false);
    }
    if (currentFiles != null) {
      currentFiles.add(file);
    }
  }
}
