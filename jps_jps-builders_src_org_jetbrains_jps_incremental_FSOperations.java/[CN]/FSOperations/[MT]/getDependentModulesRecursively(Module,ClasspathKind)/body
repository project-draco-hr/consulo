{
  final Set<Module> result=new HashSet<Module>();
  new Object(){
    final Set<Module> processed=new HashSet<Module>();
    void traverse(    Module module,    ClasspathKind kind,    Collection<Module> result,    boolean exportedOnly){
      if (processed.add(module)) {
        for (        ClasspathItem item : module.getClasspath(kind,exportedOnly)) {
          if (item instanceof ModuleSourceEntry) {
            result.add(((ModuleSourceEntry)item).getModule());
          }
 else           if (item instanceof Module) {
            traverse((Module)item,kind,result,true);
          }
        }
      }
    }
  }
.traverse(module,kind,result,false);
  return result;
}
