{
  final LookupItem item=(LookupItem)myList.getSelectedValue();
  if (item == null || item.getAttribute(EMPTY_ITEM_ATTRIBUTE) != null || item.getObject() instanceof DeferredUserLookupValue && !((DeferredUserLookupValue)item.getObject()).handleUserSelection(item,myProject)) {
    fireItemSelected(null,completionChar);
    hide();
    return;
  }
  myCanceled=false;
  hide();
  final CompletionProgressIndicator indicator=CompletionProgressIndicator.getCurrentCompletion();
  if (indicator != null) {
    indicator.cancel();
  }
  ApplicationManager.getApplication().runWriteAction(new Runnable(){
    public void run(){
      final int caretOffset=myEditor.getSelectionModel().hasSelection() ? myEditor.getSelectionModel().getSelectionStart() : myEditor.getCaretModel().getOffset();
      final String prefix=item.getPrefixMatcher().getPrefix();
      int lookupStart=caretOffset - prefix.length() - myAdditionalPrefix.length();
      LogicalPosition lookupPosition=myEditor.offsetToLogicalPosition(lookupStart);
      myEditor.getCaretModel().moveToLogicalPosition(lookupPosition);
      if (myEditor.getSelectionModel().hasSelection()) {
        myEditor.getDocument().deleteString(myEditor.getSelectionModel().getSelectionStart(),myEditor.getSelectionModel().getSelectionEnd());
      }
      final String s=item.getLookupString();
      if (!s.startsWith(prefix + myAdditionalPrefix)) {
        FeatureUsageTracker.getInstance().triggerFeatureUsed("editing.completion.camelHumps");
      }
      myEditor.getDocument().replaceString(lookupStart,caretOffset,s);
      int offset=lookupStart + s.length();
      myEditor.getCaretModel().moveToOffset(offset);
      myEditor.getScrollingModel().scrollToCaret(ScrollType.RELATIVE);
      myEditor.getSelectionModel().removeSelection();
      fireItemSelected(item,completionChar);
    }
  }
);
}
