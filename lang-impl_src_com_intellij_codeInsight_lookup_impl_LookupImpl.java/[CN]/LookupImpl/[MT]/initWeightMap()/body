{
  final SortedMap<LookupItemWeightComparable,List<LookupItem>> map=new TreeMap<LookupItemWeightComparable,List<LookupItem>>();
  final Document document=myEditor.getDocument();
  final PsiFile psiFile=PsiDocumentManager.getInstance(myProject).getPsiFile(document);
  final PsiElement element=psiFile == null ? null : psiFile.findElementAt(myEditor.getCaretModel().getOffset());
  for (  final LookupItem item : myItems) {
    final Comparable[] weight=getWeight(myItemPreferencePolicy,element,item);
    final LookupItemWeightComparable key=new LookupItemWeightComparable(item.getPriority(),weight);
    List<LookupItem> list=map.get(key);
    if (list == null)     map.put(key,list=new ArrayList<LookupItem>());
    list.add(item);
  }
  return map;
}
