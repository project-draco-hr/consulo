{
  TextRange result=range;
  int startLine=document.getLineNumber(Math.min(document.getTextLength(),range.getStartOffset()));
  int endLine=document.getLineNumber(Math.max(0,Math.min(document.getTextLength(),range.getEndOffset()) - 1));
  DocumentHelper helper=new DocumentHelper(document,startLine);
  for (int line=startLine; line <= endLine; line++) {
    helper.setLine(line);
    if (useTabs) {
      if (useSmartTabs) {
        result=processSmartTabs(helper,result,tabWidth);
      }
 else {
        result=processTabs(helper,result,tabWidth);
      }
    }
 else {
      result=processSpaces(helper,result,tabWidth);
    }
  }
  return result;
}
