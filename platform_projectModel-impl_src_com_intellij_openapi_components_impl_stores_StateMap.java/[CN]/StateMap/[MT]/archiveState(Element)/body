{
  BufferExposingByteArrayOutputStream byteOut=new BufferExposingByteArrayOutputStream();
  try {
    OutputStreamWriter writer=new OutputStreamWriter(new SnappyOutputStream(byteOut),CharsetToolkit.UTF8_CHARSET);
    try {
      XMLOutputter xmlOutputter=new JDOMUtil.MyXMLOutputter();
      xmlOutputter.setFormat(XML_FORMAT);
      xmlOutputter.output(state,writer);
    }
  finally {
      writer.close();
    }
  }
 catch (  IOException e) {
    throw new StateStorageException(e);
  }
  return ArrayUtil.realloc(byteOut.getInternalBuffer(),byteOut.size());
}
