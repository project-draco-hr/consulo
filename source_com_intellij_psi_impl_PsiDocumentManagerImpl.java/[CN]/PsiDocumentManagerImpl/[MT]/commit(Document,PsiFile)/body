{
  document.putUserData(TEMP_TREE_IN_DOCUMENT_KEY,null);
  TextBlock textBlock=getTextBlock(document);
  if (textBlock.isEmpty())   return;
  myIsCommitInProgress=true;
  try {
    if (file.getModificationStamp() != document.getModificationStamp()) {
      if (mySmartPointerManager != null) {
        mySmartPointerManager.synchronizePointers(file);
      }
      CompositeElement treeElement=((PsiFileImpl)file).calcTreeElement();
      textBlock=getTextBlock(document);
      if (textBlock.isEmpty())       return;
      char[] chars=CharArrayUtil.fromSequence(document.getCharsSequence());
      int startOffset=textBlock.getStartOffset();
      int endOffset=textBlock.getTextEndOffset();
      final int psiEndOffset=textBlock.getPsiEndOffset();
      myBlockSupport.reparseRange(file,startOffset,psiEndOffset,endOffset - psiEndOffset,chars);
      file.setModificationStamp(document.getModificationStamp());
    }
    textBlock.clear();
  }
  finally {
    myIsCommitInProgress=false;
  }
}
