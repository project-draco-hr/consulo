{
  final Document document=event.getDocument();
  final FileViewProvider provider=getCachedViewProvider(document);
  if (provider == null)   return;
  final List<PsiFile> files=provider.getAllFiles();
  for (  PsiFile file : files) {
    final TextBlock textBlock=getTextBlock(document,file);
    if (textBlock.isLocked())     continue;
    if (file instanceof PsiFileImpl) {
      myIsCommitInProgress=true;
      try {
        PsiFileImpl psiFile=(PsiFileImpl)file;
        document.putUserData(TEMP_TREE_IN_DOCUMENT_KEY,psiFile.calcTreeElement());
      }
  finally {
        myIsCommitInProgress=false;
      }
    }
    if (file.isPhysical()) {
      if (mySmartPointerManager != null) {
        SmartPointerManagerImpl.fastenBelts(file);
      }
    }
  }
}
