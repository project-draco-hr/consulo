{
  final Document document=doc instanceof DocumentRange ? ((DocumentRange)doc).getDelegate() : doc;
  doPostponedOperationsAndUnblockDocument(document);
  if (!isUncommited(document))   return;
  ApplicationManager.getApplication().runWriteAction(new CommitToPsiFileAction(){
    public void run(){
      if (!isUncommited(document))       return;
      boolean hasCommits=false;
      final FileViewProvider viewProvider=getCachedViewProvider(document);
      if (viewProvider != null) {
        final List<PsiFile> psiFiles=viewProvider.getAllFiles();
        for (        PsiFile file : psiFiles) {
          if (file.isValid()) {
            hasCommits|=commit(document,file);
          }
        }
      }
      myUncommittedDocuments.remove(document);
      if (hasCommits) {
        InjectedLanguageUtil.commitAllInjectedDocuments(document,myProject);
        viewProvider.contentsSynchronized();
      }
    }
  }
);
}
