{
  if (file instanceof PsiBinaryFile)   return null;
  Document document=getCachedDocument(file);
  if (document != null)   return document;
  final VirtualFile virtualFile=file.getVirtualFile();
  if (virtualFile != null) {
    document=FileDocumentManager.getInstance().getDocument(virtualFile);
  }
 else {
    if (!file.isPhysical())     return null;
    document=createDocument(file.getText());
    ((DocumentEx)document).setModificationStamp(file.getModificationStamp());
    file.putUserData(KEY_DOCUMENT,new WeakReference<Document>(document));
    document.putUserData(KEY_PSI_FILE,file);
  }
  fireDocumentCreated(document,file);
  return document;
}
