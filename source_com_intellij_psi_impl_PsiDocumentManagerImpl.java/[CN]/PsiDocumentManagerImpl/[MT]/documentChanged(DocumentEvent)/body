{
  final Document document=event.getDocument();
  final FileViewProvider viewProvider=getCachedViewProvider(document);
  if (viewProvider != null) {
    final List<PsiFile> files=viewProvider.getAllFiles();
    boolean commitNecessary=false;
    for (    PsiFile file : files) {
      if (file == null || (file instanceof SrcRepositoryPsiElement && ((SrcRepositoryPsiElement)file).getTreeElement() == null))       continue;
      final TextBlock textBlock=getTextBlock(document,file);
      if (textBlock.isLocked())       continue;
      if (mySmartPointerManager != null) {
        SmartPointerManagerImpl.unfastenBelts(file);
      }
      textBlock.documentChanged(event);
      myUncommittedDocuments.add(document);
      commitNecessary=true;
    }
    if (commitNecessary && ApplicationManager.getApplication().getCurrentWriteAction(PsiExternalChangeAction.class) != null) {
      commitDocument(document);
    }
  }
}
