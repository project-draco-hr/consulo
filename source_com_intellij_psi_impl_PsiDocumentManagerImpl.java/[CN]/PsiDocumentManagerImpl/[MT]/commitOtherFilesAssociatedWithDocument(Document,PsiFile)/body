{
  final FileViewProvider viewProvider=getCachedViewProvider(document);
  if (viewProvider != null && viewProvider.getAllFiles().size() > 1) {
    PostprocessReformattingAspect.getInstance(myProject).disablePostprocessFormattingInside(new Runnable(){
      public void run(){
        ApplicationManager.getApplication().runWriteAction(new CommitToPsiFileAction(){
          public void run(){
            boolean hasCommits=false;
            final FileViewProvider viewProvider=getCachedViewProvider(document);
            if (viewProvider != null) {
              final List<PsiFile> psiFiles=viewProvider.getAllFiles();
              for (              PsiFile file : psiFiles) {
                if (file.isValid() && file != psiFile) {
                  hasCommits|=commit(document,file);
                }
              }
            }
            myUncommittedDocuments.remove(document);
            if (hasCommits) {
              viewProvider.contentsSynchronized();
              InjectedLanguageUtil.commitAllInjectedDocuments(document,myProject);
            }
          }
        }
);
      }
    }
);
  }
}
