{
  File modulesFile=new File(ideaDir,"modules.xml");
  if (!modulesFile.exists()) {
    return Collections.emptyList();
  }
  final Document document=JDOMUtil.loadDocument(modulesFile);
  PathMacroManager.getInstance(project).expandPaths(document.getRootElement());
  XPath xpathExpression=XPath.newInstance("/project[@version='4']/component[@name='ProjectModuleManager']/modules/*");
  final List list=xpathExpression.selectNodes(document);
  List<Module> modules=new ArrayList<Module>(list.size());
  for (  Object o : list) {
    Element element=(Element)o;
    String filepath=element.getAttributeValue("filepath");
    if (filepath == null) {
      continue;
    }
    final Module module=loadModule(filepath,modifiableModuleModel,project);
    if (module == null) {
      continue;
    }
    modules.add(module);
  }
  return modules;
}
